name: Auto Deploy to Aliyun Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # 切换到项目目录
          cd /home/qatoolbox/QAToolBox
          
          # 停止服务
          sudo systemctl stop qatoolbox
          
          # 拉取最新代码
          git pull origin main
          
          # 激活虚拟环境并更新依赖
          source .venv/bin/activate
          pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn
          
          # 数据库迁移
          python manage.py migrate
          
          # 收集静态文件
          python manage.py collectstatic --noinput
          
          # 重启服务
          sudo systemctl start qatoolbox
          
          # 等待服务启动
          sleep 10
          
          # 检查服务状态
          if sudo systemctl is-active --quiet qatoolbox; then
            echo "✅ 部署成功！服务已启动"
            echo "🌐 访问地址: https://shenyiqing.xin"
          else
            echo "❌ 部署失败，服务启动异常"
            sudo journalctl -u qatoolbox -n 20 --no-pager
            exit 1
          fi
