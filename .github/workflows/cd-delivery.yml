name: CD - æŒç»­äº¤ä»˜

# CDæµç¨‹ï¼šæ‰‹åŠ¨è§¦å‘ï¼Œä¸“æ³¨äºéƒ¨ç½²åˆ°ä¸åŒç¯å¢ƒ
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      image_tag:
        description: 'éƒ¨ç½²çš„é•œåƒæ ‡ç­¾ (ç•™ç©ºä½¿ç”¨æœ€æ–°)'
        required: false
        type: string
      skip_tests:
        description: 'è·³è¿‡éƒ¨ç½²å‰æµ‹è¯• (ç´§æ€¥æƒ…å†µ)'
        required: false
        default: false
        type: boolean

env:
  NOTIFICATION_EMAIL: "1009383129@qq.com"

jobs:
  # 1. éƒ¨ç½²å‰éªŒè¯
  pre-deployment-checks:
    name: éƒ¨ç½²å‰æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    outputs:
      checks-passed: ${{ steps.validation.outputs.passed }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: éªŒè¯é•œåƒå­˜åœ¨
      id: image-check
      run: |
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        if [ -z "$IMAGE_TAG" ]; then
          # è·å–æœ€æ–°çš„CIæ„å»ºé•œåƒ
          IMAGE_TAG="ci-${{ github.ref_name }}-$(date +%Y%m%d)"
        fi
        
        echo "ä½¿ç”¨é•œåƒæ ‡ç­¾: $IMAGE_TAG"
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ é•œåƒå­˜åœ¨æ€§æ£€æŸ¥
        echo "âœ… é•œåƒéªŒè¯é€šè¿‡"
    
    - name: ç¯å¢ƒé…ç½®éªŒè¯
      run: |
        ENV="${{ github.event.inputs.environment }}"
        echo "ç›®æ ‡ç¯å¢ƒ: $ENV"
        
        case $ENV in
          staging)
            echo "âœ… æš‚å­˜ç¯å¢ƒé…ç½®éªŒè¯"
            ;;
          production)
            echo "âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®éªŒè¯"
            echo "âš ï¸  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦é¢å¤–å®¡æ‰¹"
            ;;
          *)
            echo "âŒ æœªçŸ¥ç¯å¢ƒ: $ENV"
            exit 1
            ;;
        esac
    
    - name: å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ”’ æ‰§è¡Œéƒ¨ç½²å‰å®‰å…¨æ£€æŸ¥..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ å®‰å…¨ç­–ç•¥æ£€æŸ¥
        # ä¾‹å¦‚ï¼šæ£€æŸ¥æ•æ„Ÿä¿¡æ¯ã€è®¿é—®æƒé™ç­‰
        echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"
    
    - name: éªŒè¯ç»“æœæ±‡æ€»
      id: validation
      run: |
        echo "passed=true" >> $GITHUB_OUTPUT
        echo "âœ… æ‰€æœ‰éƒ¨ç½²å‰æ£€æŸ¥é€šè¿‡"

  # 2. æš‚å­˜ç¯å¢ƒéƒ¨ç½²
  deploy-staging:
    name: éƒ¨ç½²åˆ°æš‚å­˜ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]
    if: |
      always() && 
      (needs.pre-deployment-checks.result == 'success' || github.event.inputs.skip_tests == 'true') &&
      github.event.inputs.environment == 'staging'
    environment: 
      name: staging
      url: http://staging.shenyiqing.xin
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: éƒ¨ç½²åˆ°æš‚å­˜æœåŠ¡å™¨
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: ${{ secrets.STAGING_PORT || 22 }}
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°æš‚å­˜ç¯å¢ƒ..."
          
          # åˆ‡æ¢åˆ°æš‚å­˜é¡¹ç›®ç›®å½•
          cd ~/QAToolBox-staging || {
            echo "æš‚å­˜ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸­..."
            git clone https://github.com/shinytsing/QAToolBox.git QAToolBox-staging
            cd QAToolBox-staging
          }
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git fetch origin
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }}
          
          # æ›´æ–°ç¯å¢ƒé…ç½®
          cp .env.staging .env 2>/dev/null || cp .env.production .env
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          docker-compose -f docker-compose.staging.yml down || true
          
          # å¯åŠ¨æ–°æœåŠ¡
          docker-compose -f docker-compose.staging.yml up -d --build
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          if curl -f http://localhost:8001/health/ > /dev/null 2>&1; then
            echo "âœ… æš‚å­˜ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ æš‚å­˜ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥"
            docker-compose -f docker-compose.staging.yml logs web
            exit 1
          fi
    
    - name: æš‚å­˜ç¯å¢ƒæµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œæš‚å­˜ç¯å¢ƒéªŒè¯æµ‹è¯•..."
        sleep 10
        
        # åŸºç¡€å¥åº·æ£€æŸ¥
        curl -f http://staging.shenyiqing.xin/health/ || {
          echo "âŒ æš‚å­˜ç¯å¢ƒä¸å¯è®¿é—®"
          exit 1
        }
        
        echo "âœ… æš‚å­˜ç¯å¢ƒéªŒè¯é€šè¿‡"

  # 3. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆéœ€è¦äººå·¥å®¡æ‰¹ï¼‰
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]
    if: |
      always() && 
      (needs.pre-deployment-checks.result == 'success' || github.event.inputs.skip_tests == 'true') &&
      github.event.inputs.environment == 'production'
    environment: 
      name: production
      url: http://shenyiqing.xin
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é€šçŸ¥
      run: |
        echo "ğŸ”” å³å°†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
        echo "  - ç¯å¢ƒ: ç”Ÿäº§ç¯å¢ƒ"
        echo "  - åˆ†æ”¯: ${{ github.ref_name }}"
        echo "  - æäº¤: ${{ github.sha }}"
        echo "  - æ“ä½œè€…: ${{ github.actor }}"
        echo "  - é•œåƒ: ${{ github.event.inputs.image_tag || 'æœ€æ–°CIæ„å»º' }}"
    
    - name: åˆ›å»ºéƒ¨ç½²å¤‡ä»½
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²å‰å¤‡ä»½..."
          
          cd ~/QAToolBox || exit 1
          
          # åˆ›å»ºæ•°æ®åº“å¤‡ä»½
          BACKUP_DIR="./backups/pre-deployment-$(date +%Y%m%d-%H%M%S)"
          mkdir -p $BACKUP_DIR
          
          # å¤‡ä»½æ•°æ®åº“
          docker-compose exec -T db pg_dump -U qatoolbox qatoolbox_production > $BACKUP_DIR/database.sql
          
          # å¤‡ä»½åª’ä½“æ–‡ä»¶
          tar -czf $BACKUP_DIR/media.tar.gz media/
          
          # è®°å½•å½“å‰ç‰ˆæœ¬
          git rev-parse HEAD > $BACKUP_DIR/current_commit.txt
          
          echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
    
    - name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
          
          cd ~/QAToolBox || exit 1
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git fetch origin
          git checkout main
          git pull origin main
          
          # æ‰§è¡Œéƒ¨ç½²
          chmod +x quick-fix-deploy.sh
          ./quick-fix-deploy.sh
          
          echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
    
    - name: ç”Ÿäº§ç¯å¢ƒéªŒè¯
      run: |
        echo "ğŸ” ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éªŒè¯..."
        sleep 60
        
        # å¥åº·æ£€æŸ¥
        if ! curl -f http://47.103.143.152/health/ > /dev/null 2>&1; then
          echo "âŒ ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
        
        if ! curl -f http://shenyiqing.xin/health/ > /dev/null 2>&1; then
          echo "âŒ åŸŸåè®¿é—®æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
        
        echo "âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯é€šè¿‡"

  # 4. éƒ¨ç½²åæµ‹è¯•
  post-deployment-tests:
    name: éƒ¨ç½²åéªŒè¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: |
      always() && 
      (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: å®‰è£…éªŒè¯ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: è¿è¡Œéƒ¨ç½²éªŒè¯è„šæœ¬
      run: |
        TARGET_ENV="${{ github.event.inputs.environment }}"
        
        if [ "$TARGET_ENV" = "staging" ]; then
          python scripts/post_deployment_verification.py --url http://staging.shenyiqing.xin
        else
          python scripts/post_deployment_verification.py --url http://shenyiqing.xin
        fi
    
    - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        echo "ğŸ“Š è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        TARGET_ENV="${{ github.event.inputs.environment }}"
        
        if [ "$TARGET_ENV" = "staging" ]; then
          URL="http://staging.shenyiqing.xin"
        else
          URL="http://shenyiqing.xin"
        fi
        
        # ç®€å•çš„å“åº”æ—¶é—´æµ‹è¯•
        for i in {1..5}; do
          echo "æµ‹è¯• $i/5:"
          curl -w "å“åº”æ—¶é—´: %{time_total}s\n" -o /dev/null -s "$URL"
          sleep 2
        done

  # 5. CDç»“æœé€šçŸ¥
  cd-notification:
    name: CDç»“æœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production, post-deployment-tests]
    if: always()
    steps:
    - name: å‡†å¤‡é€šçŸ¥æ•°æ®
      id: prepare
      run: |
        TARGET_ENV="${{ github.event.inputs.environment }}"
        DEPLOY_STATUS="unknown"
        ACCESS_URL=""
        
        if [ "$TARGET_ENV" = "staging" ]; then
          DEPLOY_STATUS="${{ needs.deploy-staging.result }}"
          ACCESS_URL="http://staging.shenyiqing.xin"
        else
          DEPLOY_STATUS="${{ needs.deploy-production.result }}"
          ACCESS_URL="http://shenyiqing.xin"
        fi
        
        TESTS_STATUS="${{ needs.post-deployment-tests.result }}"
        
        if [[ "$DEPLOY_STATUS" == "success" && "$TESTS_STATUS" == "success" ]]; then
          OVERALL_STATUS="SUCCESS"
          STATUS_ICON="âœ…"
          STATUS_MESSAGE="CDæµç¨‹æˆåŠŸå®Œæˆ"
        else
          OVERALL_STATUS="FAILURE"
          STATUS_ICON="âŒ"
          STATUS_MESSAGE="CDæµç¨‹å­˜åœ¨é—®é¢˜"
        fi
        
        echo "target_env=$TARGET_ENV" >> $GITHUB_OUTPUT
        echo "deploy_status=$DEPLOY_STATUS" >> $GITHUB_OUTPUT
        echo "access_url=$ACCESS_URL" >> $GITHUB_OUTPUT
        echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
        echo "status_icon=$STATUS_ICON" >> $GITHUB_OUTPUT
        echo "status_message=$STATUS_MESSAGE" >> $GITHUB_OUTPUT
    
    - name: å‘é€CDç»“æœé‚®ä»¶
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "${{ steps.prepare.outputs.status_icon }} CDæŠ¥å‘Š - ${{ steps.prepare.outputs.target_env }}ç¯å¢ƒéƒ¨ç½²"
        to: ${{ env.NOTIFICATION_EMAIL }}
        from: QAToolBox CD <${{ secrets.EMAIL_USERNAME }}>
        html_body: |
          <html>
          <head>
            <style>
              body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; }
              .header { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 20px; border-radius: 8px; }
              .success { color: #28a745; font-weight: bold; }
              .failure { color: #dc3545; font-weight: bold; }
              .warning { color: #ffc107; font-weight: bold; }
              .env-info { background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0; }
              .stage { margin: 15px 0; padding: 15px; border-left: 4px solid #ddd; background: #f8f9fa; }
              .stage-success { border-left-color: #28a745; }
              .stage-failure { border-left-color: #dc3545; }
              .access-links { background: #f1f8e9; padding: 15px; border-radius: 5px; margin: 15px 0; }
              .footer { margin-top: 30px; padding: 15px; background: #f1f3f5; border-radius: 5px; font-size: 12px; color: #666; }
            </style>
          </head>
          <body>
            <div class="header">
              <h2>ğŸš€ CD - æŒç»­äº¤ä»˜æŠ¥å‘Š</h2>
              <p><strong>éƒ¨ç½²ç¯å¢ƒ:</strong> ${{ steps.prepare.outputs.target_env }}</p>
              <p><strong>ä»“åº“:</strong> ${{ github.repository }}</p>
              <p><strong>åˆ†æ”¯:</strong> ${{ github.ref_name }}</p>
              <p><strong>æ“ä½œè€…:</strong> ${{ github.actor }}</p>
            </div>
            
            <div class="env-info">
              <h3>ğŸ¯ éƒ¨ç½²ä¿¡æ¯</h3>
              <p><strong>ç›®æ ‡ç¯å¢ƒ:</strong> ${{ steps.prepare.outputs.target_env }}</p>
              <p><strong>é•œåƒæ ‡ç­¾:</strong> ${{ github.event.inputs.image_tag || 'æœ€æ–°CIæ„å»º' }}</p>
              <p><strong>è·³è¿‡æµ‹è¯•:</strong> ${{ github.event.inputs.skip_tests }}</p>
              <p><strong>éƒ¨ç½²æ—¶é—´:</strong> $(date -u +%Y-%m-%dT%H:%M:%SZ)</p>
            </div>
            
            <div>
              <h3>ğŸ“‹ éƒ¨ç½²æµç¨‹</h3>
              
              <div class="stage stage-${{ needs.deploy-staging.result || needs.deploy-production.result }}">
                <strong>ç¯å¢ƒéƒ¨ç½²:</strong> ${{ steps.prepare.outputs.deploy_status }}
                <br><small>éƒ¨ç½²åº”ç”¨åˆ°${{ steps.prepare.outputs.target_env }}ç¯å¢ƒ</small>
              </div>
              
              <div class="stage stage-${{ needs.post-deployment-tests.result }}">
                <strong>éƒ¨ç½²åéªŒè¯:</strong> ${{ needs.post-deployment-tests.result }}
                <br><small>å¥åº·æ£€æŸ¥ã€åŠŸèƒ½éªŒè¯ã€æ€§èƒ½æµ‹è¯•</small>
              </div>
            </div>
            
            <div class="access-links">
              <h3>ğŸŒ è®¿é—®é“¾æ¥</h3>
              <p><strong>åº”ç”¨åœ°å€:</strong> <a href="${{ steps.prepare.outputs.access_url }}">${{ steps.prepare.outputs.access_url }}</a></p>
              {% if steps.prepare.outputs.target_env == 'production' %}
              <p><strong>IPè®¿é—®:</strong> <a href="http://47.103.143.152">http://47.103.143.152</a></p>
              <p><strong>ç®¡ç†åå°:</strong> <a href="http://shenyiqing.xin/admin/">http://shenyiqing.xin/admin/</a></p>
              {% endif %}
            </div>
            
            <div style="margin: 20px 0; padding: 15px; background: #${{ steps.prepare.outputs.overall_status == 'SUCCESS' && 'f8fff9' || 'fff8f8' }}; border-radius: 5px;">
              <h3>ğŸ“Š éƒ¨ç½²ç»“æœ</h3>
              <p class="${{ steps.prepare.outputs.overall_status == 'SUCCESS' && 'success' || 'failure' }}">
                ${{ steps.prepare.outputs.status_message }}
              </p>
            </div>
            
            <div class="footer">
              <p><strong>CDç±»å‹:</strong> æŒç»­äº¤ä»˜ (æ‰‹åŠ¨è§¦å‘)</p>
              <p><strong>ä¸‹æ¬¡éƒ¨ç½²:</strong> éœ€è¦æ‰‹åŠ¨è§¦å‘CDå·¥ä½œæµ</p>
              <p><strong>æŸ¥çœ‹è¯¦æƒ…:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions</a></p>
            </div>
          </body>
          </html>
