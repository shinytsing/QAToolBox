name: CD - æŒç»­éƒ¨ç½²

# CDæµç¨‹ï¼šè‡ªåŠ¨è§¦å‘ï¼Œå®Œå…¨è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½² (è·³è¿‡è´¨é‡æ£€æŸ¥)'
        required: false
        default: false
        type: boolean

env:
  NOTIFICATION_EMAIL: "1009383129@qq.com"

jobs:
  # 1. æ£€æŸ¥CIçŠ¶æ€
  check-ci-status:
    name: æ£€æŸ¥CIçŠ¶æ€
    runs-on: ubuntu-latest
    outputs:
      ci-passed: ${{ steps.ci-check.outputs.passed }}
      latest-commit: ${{ steps.commit-info.outputs.sha }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è·å–æäº¤ä¿¡æ¯
      id: commit-info
      run: |
        echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
        echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
    
    - name: ç­‰å¾…CIå®Œæˆ
      uses: lewagon/wait-on-check-action@v1.3.1
      with:
        ref: ${{ github.sha }}
        check-name: 'CI - æŒç»­é›†æˆ'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 10
        allowed-conclusions: success,failure,cancelled
    
    - name: æ£€æŸ¥CIç»“æœ
      id: ci-check
      run: |
        # å¦‚æœå¼ºåˆ¶éƒ¨ç½²ï¼Œè·³è¿‡CIæ£€æŸ¥
        if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
          echo "âš ï¸  å¼ºåˆ¶éƒ¨ç½²æ¨¡å¼ï¼Œè·³è¿‡CIæ£€æŸ¥"
          echo "passed=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ£€æŸ¥CIå·¥ä½œæµçŠ¶æ€
        CI_STATUS=$(gh run list --workflow=ci.yml --commit=${{ github.sha }} --json conclusion --jq '.[0].conclusion' 2>/dev/null || echo "null")
        
        if [ "$CI_STATUS" = "success" ]; then
          echo "âœ… CIæ£€æŸ¥é€šè¿‡"
          echo "passed=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ CIæ£€æŸ¥å¤±è´¥æˆ–æœªå®Œæˆ: $CI_STATUS"
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  auto-deploy-production:
    name: è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: check-ci-status
    if: needs.check-ci-status.outputs.ci-passed == 'true'
    environment: 
      name: production
      url: http://shenyiqing.xin
    outputs:
      deployment-id: ${{ steps.deploy-info.outputs.id }}
      deployment-time: ${{ steps.deploy-info.outputs.time }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: éƒ¨ç½²ä¿¡æ¯è®°å½•
      id: deploy-info
      run: |
        DEPLOY_ID="deploy-$(date +%Y%m%d-%H%M%S)-${{ github.run_number }}"
        DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        
        echo "id=$DEPLOY_ID" >> $GITHUB_OUTPUT
        echo "time=$DEPLOY_TIME" >> $GITHUB_OUTPUT
        
        echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
        echo "  - éƒ¨ç½²ID: $DEPLOY_ID"
        echo "  - æäº¤SHA: ${{ github.sha }}"
        echo "  - æäº¤ä½œè€…: ${{ needs.check-ci-status.outputs.author }}"
        echo "  - éƒ¨ç½²æ—¶é—´: $DEPLOY_TIME"
    
    - name: é¢„éƒ¨ç½²å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ”’ æ‰§è¡Œé¢„éƒ¨ç½²å®‰å…¨æ£€æŸ¥..."
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯
        if grep -r "password\|secret\|key" .env.production 2>/dev/null; then
          echo "âš ï¸  æ£€æµ‹åˆ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·ç¡®è®¤"
        fi
        
        # æ£€æŸ¥ä¸»è¦é…ç½®æ–‡ä»¶
        if [ ! -f "docker-compose.yml" ]; then
          echo "âŒ ç¼ºå°‘Docker Composeé…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        if [ ! -f "nginx.production.conf" ]; then
          echo "âŒ ç¼ºå°‘Nginxç”Ÿäº§é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"
    
    - name: åˆ›å»ºéƒ¨ç½²å¤‡ä»½
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "ğŸ“¦ åˆ›å»ºè‡ªåŠ¨éƒ¨ç½²å‰å¤‡ä»½..."
          
          cd ~/QAToolBox || exit 1
          
          # åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½ç›®å½•
          BACKUP_DIR="./backups/auto-deploy-$(date +%Y%m%d-%H%M%S)"
          mkdir -p $BACKUP_DIR
          
          # å¤‡ä»½æ•°æ®åº“
          if docker-compose ps db | grep -q "Up"; then
            docker-compose exec -T db pg_dump -U qatoolbox qatoolbox_production > $BACKUP_DIR/database.sql
            echo "âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆ"
          fi
          
          # å¤‡ä»½åª’ä½“æ–‡ä»¶
          if [ -d "media" ]; then
            tar -czf $BACKUP_DIR/media.tar.gz media/
            echo "âœ… åª’ä½“æ–‡ä»¶å¤‡ä»½å®Œæˆ"
          fi
          
          # è®°å½•å½“å‰ç‰ˆæœ¬ä¿¡æ¯
          git rev-parse HEAD > $BACKUP_DIR/previous_commit.txt
          echo "${{ github.sha }}" > $BACKUP_DIR/new_commit.txt
          
          # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
          ls -t ./backups/auto-deploy-* | tail -n +6 | xargs rm -rf 2>/dev/null || true
          
          echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
    
    - name: æ‰§è¡Œé›¶åœæœºéƒ¨ç½²
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "ğŸš€ æ‰§è¡Œé›¶åœæœºè‡ªåŠ¨éƒ¨ç½²..."
          
          cd ~/QAToolBox || exit 1
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git fetch origin
          echo "å½“å‰ç‰ˆæœ¬: $(git rev-parse HEAD)"
          git checkout main
          git reset --hard origin/main
          echo "æ–°ç‰ˆæœ¬: $(git rev-parse HEAD)"
          
          # æ›´æ–°é…ç½®æ–‡ä»¶
          if [ -f ".env.production" ] && [ ! -f ".env" ]; then
            cp .env.production .env
            echo "âœ… ç¯å¢ƒé…ç½®å·²æ›´æ–°"
          fi
          
          # æ»šåŠ¨æ›´æ–°éƒ¨ç½²
          echo "ğŸ”„ å¼€å§‹æ»šåŠ¨æ›´æ–°..."
          
          # æ„å»ºæ–°é•œåƒ
          docker-compose build --no-cache web
          
          # é€ä¸ªé‡å¯æœåŠ¡ä»¥å®ç°é›¶åœæœº
          docker-compose up -d --no-deps web
          
          # ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          for i in {1..10}; do
            if curl -f http://localhost:8000/health/ > /dev/null 2>&1; then
              echo "âœ… æ–°å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ æ–°å®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi
            echo "ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨... ($i/10)"
            sleep 10
          done
          
          # æ›´æ–°å…¶ä»–æœåŠ¡
          docker-compose up -d
          
          # è¿è¡Œæ•°æ®åº“è¿ç§»
          docker-compose exec -T web python manage.py migrate --noinput
          
          # æ”¶é›†é™æ€æ–‡ä»¶
          docker-compose exec -T web python manage.py collectstatic --noinput
          
          echo "âœ… é›¶åœæœºéƒ¨ç½²å®Œæˆ"
    
    - name: éƒ¨ç½²åç«‹å³éªŒè¯
      run: |
        echo "ğŸ” éƒ¨ç½²åç«‹å³éªŒè¯..."
        sleep 30
        
        # å¥åº·æ£€æŸ¥
        for endpoint in "http://47.103.143.152/health/" "http://shenyiqing.xin/health/"; do
          if curl -f "$endpoint" > /dev/null 2>&1; then
            echo "âœ… $endpoint å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ $endpoint å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
        done
        
        echo "âœ… åŸºç¡€éªŒè¯é€šè¿‡"

  # 3. å…¨é¢éƒ¨ç½²åæµ‹è¯•
  comprehensive-tests:
    name: å…¨é¢éƒ¨ç½²åæµ‹è¯•
    runs-on: ubuntu-latest
    needs: auto-deploy-production
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: å®‰è£…æµ‹è¯•ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests selenium pytest
    
    - name: è¿è¡Œå…¨é¢éªŒè¯æµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œå…¨é¢éƒ¨ç½²åéªŒè¯..."
        python scripts/post_deployment_verification.py --url http://shenyiqing.xin
    
    - name: æ€§èƒ½å›å½’æµ‹è¯•
      run: |
        echo "ğŸ“Š æ€§èƒ½å›å½’æµ‹è¯•..."
        
        # æµ‹è¯•å…³é”®é¡µé¢å“åº”æ—¶é—´
        urls=("http://shenyiqing.xin" "http://shenyiqing.xin/health/" "http://47.103.143.152")
        
        for url in "${urls[@]}"; do
          echo "æµ‹è¯•: $url"
          response_time=$(curl -w "%{time_total}" -o /dev/null -s "$url")
          echo "å“åº”æ—¶é—´: ${response_time}s"
          
          # å“åº”æ—¶é—´ä¸åº”è¶…è¿‡3ç§’
          if (( $(echo "$response_time > 3.0" | bc -l) )); then
            echo "âš ï¸  å“åº”æ—¶é—´è¿‡é•¿: ${response_time}s"
          else
            echo "âœ… å“åº”æ—¶é—´æ­£å¸¸"
          fi
        done
    
    - name: åŠŸèƒ½å†’çƒŸæµ‹è¯•
      run: |
        echo "ğŸ”¥ åŠŸèƒ½å†’çƒŸæµ‹è¯•..."
        
        # æµ‹è¯•ä¸»è¦åŠŸèƒ½ç«¯ç‚¹
        BASE_URL="http://shenyiqing.xin"
        
        # æµ‹è¯•é™æ€èµ„æº
        if curl -f "$BASE_URL/static/css/" > /dev/null 2>&1; then
          echo "âœ… é™æ€èµ„æºå¯è®¿é—®"
        else
          echo "âš ï¸  é™æ€èµ„æºå¯èƒ½æœ‰é—®é¢˜"
        fi
        
        # æµ‹è¯•APIç«¯ç‚¹
        if curl -f "$BASE_URL/users/api/session-status/" > /dev/null 2>&1; then
          echo "âœ… APIç«¯ç‚¹å¯è®¿é—®"
        else
          echo "âš ï¸  APIç«¯ç‚¹å¯èƒ½æœ‰é—®é¢˜"
        fi
        
        echo "âœ… å†’çƒŸæµ‹è¯•å®Œæˆ"

  # 4. éƒ¨ç½²æˆåŠŸåçš„ç›‘æ§è®¾ç½®
  post-deployment-monitoring:
    name: éƒ¨ç½²åç›‘æ§è®¾ç½®
    runs-on: ubuntu-latest
    needs: [auto-deploy-production, comprehensive-tests]
    if: needs.auto-deploy-production.result == 'success' && needs.comprehensive-tests.result == 'success'
    steps:
    - name: è®¾ç½®éƒ¨ç½²ç›‘æ§
      run: |
        echo "ğŸ“Š è®¾ç½®éƒ¨ç½²åç›‘æ§..."
        
        # è¿™é‡Œå¯ä»¥é›†æˆç›‘æ§ç³»ç»Ÿ
        # ä¾‹å¦‚ï¼šPrometheusã€Grafanaã€New Relicç­‰
        
        echo "âœ… ç›‘æ§è®¾ç½®å®Œæˆ"
    
    - name: æ›´æ–°éƒ¨ç½²çŠ¶æ€
      run: |
        echo "ğŸ“ æ›´æ–°éƒ¨ç½²çŠ¶æ€..."
        
        # è®°å½•æˆåŠŸéƒ¨ç½²ä¿¡æ¯
        DEPLOY_INFO=$(cat << EOF
        {
          "deployment_id": "${{ needs.auto-deploy-production.outputs.deployment-id }}",
          "commit_sha": "${{ github.sha }}",
          "deployment_time": "${{ needs.auto-deploy-production.outputs.deployment-time }}",
          "status": "success",
          "environment": "production"
        }
        EOF
        )
        
        echo "éƒ¨ç½²ä¿¡æ¯: $DEPLOY_INFO"

  # 5. è‡ªåŠ¨å›æ»šæœºåˆ¶
  auto-rollback:
    name: è‡ªåŠ¨å›æ»š
    runs-on: ubuntu-latest
    needs: [auto-deploy-production, comprehensive-tests]
    if: failure() && (needs.auto-deploy-production.result == 'failure' || needs.comprehensive-tests.result == 'failure')
    steps:
    - name: æ‰§è¡Œè‡ªåŠ¨å›æ»š
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "ğŸ”„ æ£€æµ‹åˆ°éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œè‡ªåŠ¨å›æ»š..."
          
          cd ~/QAToolBox || exit 1
          
          # æŸ¥æ‰¾æœ€æ–°çš„å¤‡ä»½
          LATEST_BACKUP=$(ls -t ./backups/auto-deploy-* | head -1)
          
          if [ -z "$LATEST_BACKUP" ]; then
            echo "âŒ æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶ï¼Œæ— æ³•è‡ªåŠ¨å›æ»š"
            exit 1
          fi
          
          echo "ä½¿ç”¨å¤‡ä»½: $LATEST_BACKUP"
          
          # è¯»å–ä¹‹å‰çš„æäº¤
          if [ -f "$LATEST_BACKUP/previous_commit.txt" ]; then
            PREVIOUS_COMMIT=$(cat "$LATEST_BACKUP/previous_commit.txt")
            echo "å›æ»šåˆ°æäº¤: $PREVIOUS_COMMIT"
            
            # å›æ»šä»£ç 
            git checkout $PREVIOUS_COMMIT
            
            # é‡æ–°éƒ¨ç½²
            docker-compose down
            docker-compose up -d --build
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 30
            
            # éªŒè¯å›æ»š
            if curl -f http://localhost:8000/health/ > /dev/null 2>&1; then
              echo "âœ… è‡ªåŠ¨å›æ»šæˆåŠŸ"
            else
              echo "âŒ è‡ªåŠ¨å›æ»šå¤±è´¥"
              exit 1
            fi
          else
            echo "âŒ å¤‡ä»½ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è‡ªåŠ¨å›æ»š"
            exit 1
          fi

  # 6. CDç»“æœé€šçŸ¥
  cd-notification:
    name: CDç»“æœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [check-ci-status, auto-deploy-production, comprehensive-tests, post-deployment-monitoring, auto-rollback]
    if: always()
    steps:
    - name: å‡†å¤‡é€šçŸ¥æ•°æ®
      id: prepare
      run: |
        CI_STATUS="${{ needs.check-ci-status.result }}"
        DEPLOY_STATUS="${{ needs.auto-deploy-production.result }}"
        TESTS_STATUS="${{ needs.comprehensive-tests.result }}"
        MONITOR_STATUS="${{ needs.post-deployment-monitoring.result }}"
        ROLLBACK_STATUS="${{ needs.auto-rollback.result }}"
        
        # ç¡®å®šæ•´ä½“CDçŠ¶æ€
        if [[ "$DEPLOY_STATUS" == "success" && "$TESTS_STATUS" == "success" ]]; then
          OVERALL_STATUS="SUCCESS"
          STATUS_ICON="âœ…"
          STATUS_MESSAGE="æŒç»­éƒ¨ç½²æˆåŠŸå®Œæˆ"
        elif [[ "$ROLLBACK_STATUS" == "success" ]]; then
          OVERALL_STATUS="ROLLBACK"
          STATUS_ICON="ğŸ”„"
          STATUS_MESSAGE="éƒ¨ç½²å¤±è´¥ä½†å›æ»šæˆåŠŸ"
        else
          OVERALL_STATUS="FAILURE"
          STATUS_ICON="âŒ"
          STATUS_MESSAGE="æŒç»­éƒ¨ç½²å¤±è´¥"
        fi
        
        echo "ci_status=$CI_STATUS" >> $GITHUB_OUTPUT
        echo "deploy_status=$DEPLOY_STATUS" >> $GITHUB_OUTPUT
        echo "tests_status=$TESTS_STATUS" >> $GITHUB_OUTPUT
        echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
        echo "status_icon=$STATUS_ICON" >> $GITHUB_OUTPUT
        echo "status_message=$STATUS_MESSAGE" >> $GITHUB_OUTPUT
    
    - name: å‘é€CDç»“æœé‚®ä»¶
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "${{ steps.prepare.outputs.status_icon }} CDæŠ¥å‘Š - æŒç»­éƒ¨ç½² (${{ steps.prepare.outputs.overall_status }})"
        to: ${{ env.NOTIFICATION_EMAIL }}
        from: QAToolBox CD <${{ secrets.EMAIL_USERNAME }}>
        html_body: |
          <html>
          <head>
            <style>
              body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; }
              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; }
              .success { color: #28a745; font-weight: bold; }
              .failure { color: #dc3545; font-weight: bold; }
              .rollback { color: #ffc107; font-weight: bold; }
              .auto-deploy { background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #28a745; }
              .stage { margin: 15px 0; padding: 15px; border-left: 4px solid #ddd; background: #f8f9fa; }
              .stage-success { border-left-color: #28a745; }
              .stage-failure { border-left-color: #dc3545; }
              .stage-skipped { border-left-color: #6c757d; }
              .access-info { background: #f1f8e9; padding: 15px; border-radius: 5px; margin: 15px 0; }
              .footer { margin-top: 30px; padding: 15px; background: #f1f3f5; border-radius: 5px; font-size: 12px; color: #666; }
            </style>
          </head>
          <body>
            <div class="header">
              <h2>âš¡ CD - æŒç»­éƒ¨ç½²æŠ¥å‘Š</h2>
              <p><strong>éƒ¨ç½²ç±»å‹:</strong> è‡ªåŠ¨éƒ¨ç½²</p>
              <p><strong>ä»“åº“:</strong> ${{ github.repository }}</p>
              <p><strong>åˆ†æ”¯:</strong> ${{ github.ref_name }}</p>
              <p><strong>æäº¤:</strong> ${{ github.sha }}</p>
              <p><strong>è§¦å‘è€…:</strong> ${{ github.actor }}</p>
            </div>
            
            <div class="auto-deploy">
              <h3>ğŸ¤– è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹</h3>
              <p><strong>éƒ¨ç½²ID:</strong> ${{ needs.auto-deploy-production.outputs.deployment-id || 'æœªçŸ¥' }}</p>
              <p><strong>éƒ¨ç½²æ—¶é—´:</strong> ${{ needs.auto-deploy-production.outputs.deployment-time || 'æœªçŸ¥' }}</p>
              <p><strong>å¼ºåˆ¶éƒ¨ç½²:</strong> ${{ github.event.inputs.force_deploy || 'false' }}</p>
            </div>
            
            <div>
              <h3>ğŸ”„ éƒ¨ç½²æµç¨‹çŠ¶æ€</h3>
              
              <div class="stage stage-${{ needs.check-ci-status.result }}">
                <strong>CIçŠ¶æ€æ£€æŸ¥:</strong> ${{ steps.prepare.outputs.ci_status }}
                <br><small>éªŒè¯æŒç»­é›†æˆæ˜¯å¦é€šè¿‡</small>
              </div>
              
              <div class="stage stage-${{ needs.auto-deploy-production.result }}">
                <strong>è‡ªåŠ¨éƒ¨ç½²:</strong> ${{ steps.prepare.outputs.deploy_status }}
                <br><small>é›¶åœæœºéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ</small>
              </div>
              
              <div class="stage stage-${{ needs.comprehensive-tests.result }}">
                <strong>éƒ¨ç½²åæµ‹è¯•:</strong> ${{ steps.prepare.outputs.tests_status }}
                <br><small>åŠŸèƒ½éªŒè¯ã€æ€§èƒ½æµ‹è¯•ã€å†’çƒŸæµ‹è¯•</small>
              </div>
              
              {% if needs.auto-rollback.result %}
              <div class="stage stage-${{ needs.auto-rollback.result }}">
                <strong>è‡ªåŠ¨å›æ»š:</strong> ${{ needs.auto-rollback.result }}
                <br><small>æ£€æµ‹åˆ°é—®é¢˜è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬</small>
              </div>
              {% endif %}
            </div>
            
            <div class="access-info">
              <h3>ğŸŒ ç”Ÿäº§ç¯å¢ƒè®¿é—®</h3>
              <p><strong>ä¸»åŸŸå:</strong> <a href="http://shenyiqing.xin">http://shenyiqing.xin</a></p>
              <p><strong>IPè®¿é—®:</strong> <a href="http://47.103.143.152">http://47.103.143.152</a></p>
              <p><strong>ç®¡ç†åå°:</strong> <a href="http://shenyiqing.xin/admin/">http://shenyiqing.xin/admin/</a></p>
              <p><strong>å¥åº·æ£€æŸ¥:</strong> <a href="http://shenyiqing.xin/health/">http://shenyiqing.xin/health/</a></p>
            </div>
            
            <div style="margin: 20px 0; padding: 15px; background: #${{ steps.prepare.outputs.overall_status == 'SUCCESS' && 'f8fff9' || (steps.prepare.outputs.overall_status == 'ROLLBACK' && 'fffef0' || 'fff8f8') }}; border-radius: 5px;">
              <h3>ğŸ“Š éƒ¨ç½²ç»“æœ</h3>
              <p class="${{ steps.prepare.outputs.overall_status == 'SUCCESS' && 'success' || (steps.prepare.outputs.overall_status == 'ROLLBACK' && 'rollback' || 'failure') }}">
                ${{ steps.prepare.outputs.status_message }}
              </p>
            </div>
            
            <div class="footer">
              <p><strong>CDç±»å‹:</strong> æŒç»­éƒ¨ç½² (å®Œå…¨è‡ªåŠ¨åŒ–)</p>
              <p><strong>ä¸‹æ¬¡éƒ¨ç½²:</strong> æ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘</p>
              <p><strong>ç›‘æ§:</strong> éƒ¨ç½²åè‡ªåŠ¨å¯åŠ¨ç›‘æ§</p>
              <p><strong>å›æ»š:</strong> å‘ç°é—®é¢˜æ—¶è‡ªåŠ¨å›æ»š</p>
              <p><strong>æŸ¥çœ‹è¯¦æƒ…:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions</a></p>
            </div>
          </body>
          </html>
