name: CI - æŒç»­é›†æˆ

# CIæµç¨‹ï¼šæ¯æ¬¡ä»£ç æäº¤éƒ½è§¦å‘ï¼Œä¸“æ³¨äºä»£ç è´¨é‡å’Œæµ‹è¯•
on:
  push:
    branches: [ develop, feature/*, hotfix/* ]
  pull_request:
    branches: [ develop, main ]
  workflow_dispatch:

env:
  NOTIFICATION_EMAIL: "1009383129@qq.com"

jobs:
  # 1. ä»£ç è´¨é‡æ£€æŸ¥ - CIçš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      quality-score: ${{ steps.quality-gate.outputs.score }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºåˆ†æ
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black isort mypy bandit safety pylint
    
    - name: ä»£ç æ ¼å¼åŒ–æ£€æŸ¥
      id: formatting
      run: |
        echo "::group::Blackä»£ç æ ¼å¼æ£€æŸ¥"
        BLACK_RESULT=0
        black --check --diff . || BLACK_RESULT=$?
        echo "black_score=$BLACK_RESULT" >> $GITHUB_OUTPUT
        echo "::endgroup::"
        
        echo "::group::å¯¼å…¥æ’åºæ£€æŸ¥"
        ISORT_RESULT=0
        isort --check-only --diff . || ISORT_RESULT=$?
        echo "isort_score=$ISORT_RESULT" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: é™æ€ä»£ç åˆ†æ
      id: linting
      run: |
        echo "::group::Flake8ä»£ç æ£€æŸ¥"
        FLAKE8_ERRORS=$(flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics | tail -1)
        echo "flake8_errors=$FLAKE8_ERRORS" >> $GITHUB_OUTPUT
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics --format=json --output-file=flake8-report.json
        echo "::endgroup::"
        
        echo "::group::MyPyç±»å‹æ£€æŸ¥"
        MYPY_RESULT=0
        mypy apps/ --ignore-missing-imports --junit-xml=mypy-report.xml || MYPY_RESULT=$?
        echo "mypy_score=$MYPY_RESULT" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: å®‰å…¨æ¼æ´æ‰«æ
      id: security
      run: |
        echo "::group::Banditå®‰å…¨æ‰«æ"
        bandit -r apps/ -f json -o bandit-report.json || true
        SECURITY_ISSUES=$(jq '.results | length' bandit-report.json 2>/dev/null || echo "0")
        echo "security_issues=$SECURITY_ISSUES" >> $GITHUB_OUTPUT
        echo "::endgroup::"
        
        echo "::group::ä¾èµ–æ¼æ´æ‰«æ"
        safety check --json --output safety-report.json || true
        VULNERABILITY_COUNT=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo "0")
        echo "vulnerabilities=$VULNERABILITY_COUNT" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: ä»£ç å¤æ‚åº¦åˆ†æ
      id: complexity
      run: |
        echo "::group::ä»£ç å¤æ‚åº¦åˆ†æ"
        pylint apps/ --output-format=json --reports=yes > pylint-report.json || true
        # æå–ä»£ç è´¨é‡è¯„åˆ†
        PYLINT_SCORE=$(jq '.score // 0' pylint-report.json 2>/dev/null || echo "0")
        echo "pylint_score=$PYLINT_SCORE" >> $GITHUB_OUTPUT
        echo "::endgroup::"
    
    - name: è´¨é‡é—¨ç¦è¯„ä¼°
      id: quality-gate
      run: |
        # è®¡ç®—ç»¼åˆè´¨é‡è¯„åˆ†
        BLACK_SCORE=${{ steps.formatting.outputs.black_score }}
        ISORT_SCORE=${{ steps.formatting.outputs.isort_score }}
        FLAKE8_ERRORS=${{ steps.linting.outputs.flake8_errors }}
        MYPY_SCORE=${{ steps.linting.outputs.mypy_score }}
        SECURITY_ISSUES=${{ steps.security.outputs.security_issues }}
        VULNERABILITIES=${{ steps.security.outputs.vulnerabilities }}
        
        QUALITY_SCORE=100
        
        # æ ¼å¼åŒ–é—®é¢˜æ‰£åˆ†
        if [ "$BLACK_SCORE" != "0" ]; then
          QUALITY_SCORE=$((QUALITY_SCORE - 20))
          echo "::error::ä»£ç æ ¼å¼ä¸ç¬¦åˆæ ‡å‡†"
        fi
        
        if [ "$ISORT_SCORE" != "0" ]; then
          QUALITY_SCORE=$((QUALITY_SCORE - 10))
          echo "::error::å¯¼å…¥æ’åºä¸ç¬¦åˆæ ‡å‡†"
        fi
        
        # ä»£ç é”™è¯¯æ‰£åˆ†
        if [ "$FLAKE8_ERRORS" -gt "0" ]; then
          QUALITY_SCORE=$((QUALITY_SCORE - FLAKE8_ERRORS * 5))
          echo "::error::å‘ç° $FLAKE8_ERRORS ä¸ªä»£ç é—®é¢˜"
        fi
        
        # å®‰å…¨é—®é¢˜æ‰£åˆ†
        if [ "$SECURITY_ISSUES" -gt "0" ]; then
          QUALITY_SCORE=$((QUALITY_SCORE - SECURITY_ISSUES * 10))
          echo "::error::å‘ç° $SECURITY_ISSUES ä¸ªå®‰å…¨é—®é¢˜"
        fi
        
        if [ "$VULNERABILITIES" -gt "0" ]; then
          QUALITY_SCORE=$((QUALITY_SCORE - VULNERABILITIES * 15))
          echo "::error::å‘ç° $VULNERABILITIES ä¸ªä¾èµ–æ¼æ´"
        fi
        
        # ç¡®ä¿è¯„åˆ†ä¸ä½äº0
        if [ "$QUALITY_SCORE" -lt "0" ]; then
          QUALITY_SCORE=0
        fi
        
        echo "score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
        echo "ä»£ç è´¨é‡è¯„åˆ†: $QUALITY_SCORE/100"
        
        # è´¨é‡é—¨ç¦ï¼šè¯„åˆ†ä½äº70åˆ†ä¸å…è®¸é€šè¿‡
        if [ "$QUALITY_SCORE" -lt "70" ]; then
          echo "::error::ä»£ç è´¨é‡ä¸è¾¾æ ‡ï¼Œè¯„åˆ†: $QUALITY_SCORE/100 (è¦æ±‚: â‰¥70)"
          exit 1
        else
          echo "::notice::ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡ï¼Œè¯„åˆ†: $QUALITY_SCORE/100"
        fi
    
    - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports-${{ github.run_id }}
        path: |
          flake8-report.json
          mypy-report.xml
          bandit-report.json
          safety-report.json
          pylint-report.json
        retention-days: 30

  # 2. å•å…ƒæµ‹è¯• - CIçš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_qatoolbox
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    outputs:
      test-result: ${{ steps.tests.outputs.result }}
      coverage: ${{ steps.coverage.outputs.percentage }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-django pytest-cov pytest-xdist pytest-html coverage
    
    - name: æ•°æ®åº“è¿ç§»
      run: |
        python manage.py migrate --settings=config.settings.testing
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_qatoolbox
        REDIS_URL: redis://localhost:6379/0
    
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      id: tests
      run: |
        pytest tests/ \
          --cov=apps \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term \
          --junit-xml=test-results.xml \
          --html=test-report.html \
          --self-contained-html \
          -v \
          --maxfail=10 \
          --tb=short \
          --durations=10
        
        TEST_RESULT=$?
        echo "result=$TEST_RESULT" >> $GITHUB_OUTPUT
        
        if [ $TEST_RESULT -eq 0 ]; then
          echo "::notice::æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡"
        else
          echo "::error::å•å…ƒæµ‹è¯•å¤±è´¥"
        fi
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_qatoolbox
        REDIS_URL: redis://localhost:6379/0
    
    - name: æå–è¦†ç›–ç‡
      id: coverage
      run: |
        # æå–è¦†ç›–ç‡ç™¾åˆ†æ¯”
        COVERAGE=$(python -c "
        import xml.etree.ElementTree as ET
        try:
            root = ET.parse('coverage.xml').getroot()
            coverage = float(root.attrib['line-rate']) * 100
            print(f'{coverage:.1f}')
        except:
            print('0.0')
        ")
        echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "æµ‹è¯•è¦†ç›–ç‡: $COVERAGE%"
        
        # è¦†ç›–ç‡é—¨ç¦ï¼šä½äº80%ä¸å…è®¸é€šè¿‡
        COVERAGE_INT=$(echo $COVERAGE | cut -d. -f1)
        if [ "$COVERAGE_INT" -lt "80" ]; then
          echo "::error::æµ‹è¯•è¦†ç›–ç‡ä¸è¾¾æ ‡: $COVERAGE% (è¦æ±‚: â‰¥80%)"
          exit 1
        else
          echo "::notice::æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡: $COVERAGE%"
        fi
    
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ github.run_id }}
        path: |
          test-results.xml
          test-report.html
          coverage.xml
          htmlcov/
        retention-days: 30
    
    - name: PRè¯„è®ºæµ‹è¯•ç»“æœ
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const testResult = '${{ steps.tests.outputs.result }}';
          const coverage = '${{ steps.coverage.outputs.percentage }}';
          const qualityScore = '${{ needs.code-quality.outputs.quality-score }}';
          
          const testStatus = testResult == '0' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
          const coverageStatus = parseFloat(coverage) >= 80 ? 'âœ…' : 'âŒ';
          const qualityStatus = parseInt(qualityScore) >= 70 ? 'âœ…' : 'âŒ';
          
          const comment = `
          ## ğŸ” CI - æŒç»­é›†æˆæŠ¥å‘Š
          
          | æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | ç»“æœ |
          |---------|------|------|
          | ä»£ç è´¨é‡ | ${qualityStatus} | ${qualityScore}/100 |
          | å•å…ƒæµ‹è¯• | ${testStatus} | ${testResult == '0' ? 'æ‰€æœ‰æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥'} |
          | æµ‹è¯•è¦†ç›–ç‡ | ${coverageStatus} | ${coverage}% |
          
          ### ğŸ“Š è¯¦ç»†ä¿¡æ¯
          - **ä»£ç è´¨é‡è¦æ±‚**: â‰¥70åˆ†
          - **æµ‹è¯•è¦†ç›–ç‡è¦æ±‚**: â‰¥80%
          - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          
          [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # 3. é›†æˆæµ‹è¯•
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: unit-tests
    if: needs.unit-tests.outputs.test-result == '0'
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests selenium pytest
    
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        echo "è¿è¡ŒAPIé›†æˆæµ‹è¯•..."
        pytest tests/integration/ -v --tb=short || true
        echo "é›†æˆæµ‹è¯•å®Œæˆ"

  # 4. æ„å»ºåˆ¶å“ - CIçš„æœ€ç»ˆäº§ç‰©
  build-artifacts:
    name: æ„å»ºéƒ¨ç½²åˆ¶å“
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, integration-tests]
    if: |
      always() && 
      needs.code-quality.result == 'success' && 
      needs.unit-tests.result == 'success' &&
      (needs.integration-tests.result == 'success' || needs.integration-tests.result == 'skipped')
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      build-time: ${{ steps.build-info.outputs.time }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=ci-{{branch}}-{{date 'YYYYMMDD-HHmmss'}}
    
    - name: æ„å»ºDockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
    
    - name: è®°å½•æ„å»ºä¿¡æ¯
      id: build-info
      run: |
        echo "time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
        echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"
        echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.tags }}"

  # 5. CIç»“æœé€šçŸ¥
  ci-notification:
    name: CIç»“æœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, integration-tests, build-artifacts]
    if: always()
    steps:
    - name: å‡†å¤‡é€šçŸ¥æ•°æ®
      id: prepare
      run: |
        QUALITY_STATUS="${{ needs.code-quality.result }}"
        TESTS_STATUS="${{ needs.unit-tests.result }}"
        INTEGRATION_STATUS="${{ needs.integration-tests.result }}"
        BUILD_STATUS="${{ needs.build-artifacts.result }}"
        
        QUALITY_SCORE="${{ needs.code-quality.outputs.quality-score || '0' }}"
        COVERAGE="${{ needs.unit-tests.outputs.coverage || '0' }}"
        
        # ç¡®å®šæ•´ä½“CIçŠ¶æ€
        if [[ "$QUALITY_STATUS" == "success" && "$TESTS_STATUS" == "success" && "$BUILD_STATUS" == "success" ]]; then
          OVERALL_STATUS="SUCCESS"
          STATUS_ICON="âœ…"
          STATUS_MESSAGE="CIæµç¨‹æˆåŠŸå®Œæˆ"
        else
          OVERALL_STATUS="FAILURE"
          STATUS_ICON="âŒ"
          STATUS_MESSAGE="CIæµç¨‹å­˜åœ¨é—®é¢˜"
        fi
        
        echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
        echo "status_icon=$STATUS_ICON" >> $GITHUB_OUTPUT
        echo "status_message=$STATUS_MESSAGE" >> $GITHUB_OUTPUT
        echo "quality_score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
    
    - name: å‘é€CIç»“æœé‚®ä»¶
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "${{ steps.prepare.outputs.status_icon }} CIæŠ¥å‘Š - ${{ github.repository }} (${{ github.ref_name }})"
        to: ${{ env.NOTIFICATION_EMAIL }}
        from: QAToolBox CI <${{ secrets.EMAIL_USERNAME }}>
        html_body: |
          <html>
          <head>
            <style>
              body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; }
              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; }
              .status-success { color: #28a745; font-weight: bold; }
              .status-failure { color: #dc3545; font-weight: bold; }
              .metric { display: inline-block; margin: 10px 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
              .stage { margin: 15px 0; padding: 15px; border-left: 4px solid #ddd; background: #f8f9fa; }
              .stage-success { border-left-color: #28a745; }
              .stage-failure { border-left-color: #dc3545; }
              .footer { margin-top: 30px; padding: 15px; background: #f1f3f5; border-radius: 5px; font-size: 12px; color: #666; }
            </style>
          </head>
          <body>
            <div class="header">
              <h2>ğŸ”„ CI - æŒç»­é›†æˆæŠ¥å‘Š</h2>
              <p><strong>ä»“åº“:</strong> ${{ github.repository }}</p>
              <p><strong>åˆ†æ”¯:</strong> ${{ github.ref_name }}</p>
              <p><strong>æäº¤:</strong> ${{ github.sha }}</p>
              <p><strong>è§¦å‘è€…:</strong> ${{ github.actor }}</p>
            </div>
            
            <div style="margin: 20px 0;">
              <h3>ğŸ“Š CIæŒ‡æ ‡æ¦‚è§ˆ</h3>
              <div class="metric">
                <strong>ä»£ç è´¨é‡:</strong> ${{ steps.prepare.outputs.quality_score }}/100
              </div>
              <div class="metric">
                <strong>æµ‹è¯•è¦†ç›–ç‡:</strong> ${{ steps.prepare.outputs.coverage }}%
              </div>
              <div class="metric">
                <strong>æ•´ä½“çŠ¶æ€:</strong> 
                <span class="status-${{ needs.code-quality.result == 'success' && needs.unit-tests.result == 'success' && needs.build-artifacts.result == 'success' && 'success' || 'failure' }}">
                  ${{ steps.prepare.outputs.status_message }}
                </span>
              </div>
            </div>
            
            <div>
              <h3>ğŸ” å„é˜¶æ®µè¯¦æƒ…</h3>
              
              <div class="stage stage-${{ needs.code-quality.result }}">
                <strong>ä»£ç è´¨é‡æ£€æŸ¥:</strong> ${{ needs.code-quality.result }}
                <br><small>é™æ€åˆ†æã€æ ¼å¼åŒ–æ£€æŸ¥ã€å®‰å…¨æ‰«æ</small>
              </div>
              
              <div class="stage stage-${{ needs.unit-tests.result }}">
                <strong>å•å…ƒæµ‹è¯•:</strong> ${{ needs.unit-tests.result }}
                <br><small>æµ‹è¯•è¦†ç›–ç‡: ${{ steps.prepare.outputs.coverage }}%</small>
              </div>
              
              <div class="stage stage-${{ needs.integration-tests.result }}">
                <strong>é›†æˆæµ‹è¯•:</strong> ${{ needs.integration-tests.result }}
                <br><small>APIé›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•</small>
              </div>
              
              <div class="stage stage-${{ needs.build-artifacts.result }}">
                <strong>æ„å»ºåˆ¶å“:</strong> ${{ needs.build-artifacts.result }}
                <br><small>Dockeré•œåƒæ„å»ºå’Œæ¨é€</small>
              </div>
            </div>
            
            <div class="footer">
              <p><strong>CIå®Œæˆæ—¶é—´:</strong> ${{ needs.build-artifacts.outputs.build-time || 'æœªçŸ¥' }}</p>
              <p><strong>ä¸‹ä¸€æ­¥:</strong> ä»£ç åˆå¹¶åå¯è§¦å‘CDæµç¨‹è¿›è¡Œéƒ¨ç½²</p>
              <p><strong>æŸ¥çœ‹è¯¦æƒ…:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions</a></p>
            </div>
          </body>
          </html>
