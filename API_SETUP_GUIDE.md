# DeepSeek API 配置指南

## 问题诊断

根据测试结果，当前遇到的问题是：
- **错误类型**: 401 Authentication Fails
- **错误原因**: API密钥无效
- **当前状态**: 使用的是示例API密钥 `sk-your-actual-api-key-here`

## 解决步骤

### 1. 获取DeepSeek API密钥

1. 访问 [DeepSeek Platform](https://platform.deepseek.com/)
2. 注册或登录您的账户
3. 进入API管理页面
4. 创建新的API密钥
5. 复制生成的API密钥（格式：`sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`）

### 2. 配置API密钥

编辑项目根目录下的 `.env` 文件：

```bash
# 将示例密钥替换为您的真实API密钥
DEEPSEEK_API_KEY=sk-your-real-api-key-here
```

**重要提示**：
- 确保API密钥以 `sk-` 开头
- 不要包含多余的空格或引号
- 保持密钥的完整性和准确性

### 3. 验证配置

运行测试脚本验证配置：

```bash
python test_deepseek_api.py
```

成功时应该看到：
```
✅ API调用成功！
AI回复: 测试成功
🎉 所有测试通过！API配置正确。
```

### 4. 常见问题解决

#### 问题1: 401 Authentication Fails
- **原因**: API密钥无效或格式错误
- **解决**: 检查API密钥是否正确复制，确保以 `sk-` 开头

#### 问题2: 400 Bad Request
- **原因**: 请求参数格式错误
- **解决**: 已通过代码改进解决，添加了详细的参数验证

#### 问题3: 网络连接问题
- **原因**: 网络不稳定或防火墙阻止
- **解决**: 检查网络连接，确保可以访问 `api.deepseek.com`

#### 问题4: 速率限制
- **原因**: API调用频率过高
- **解决**: 已实现速率限制机制，默认每分钟10次调用

## 代码改进说明

### 已完成的改进

1. **增强错误处理**
   - 添加了详细的HTTP错误信息解析
   - 提供了具体的错误原因和建议

2. **参数验证**
   - 验证API密钥格式
   - 验证请求消息格式
   - 验证输入参数完整性

3. **调试信息**
   - 添加了详细的请求和响应日志
   - 便于问题诊断和调试

4. **超时优化**
   - 增加了请求超时时间到60秒
   - 提高了API调用的稳定性

### 改进的文件

- `apps/tools/views.py` - 改进了API视图函数
- `apps/tools/utils/__init__.py` - 改进了DeepSeekClient类
- `test_deepseek_api.py` - 新增测试脚本

## 使用建议

1. **开发环境**: 使用测试API密钥进行开发
2. **生产环境**: 使用正式API密钥，注意保护密钥安全
3. **监控**: 定期检查API使用情况和错误日志
4. **备份**: 保存API密钥的备份，避免丢失

## 下一步

配置正确的API密钥后，您的AI功能应该可以正常工作了。如果仍有问题，请检查：

1. API密钥是否有效且未过期
2. 账户余额是否充足
3. 网络连接是否正常
4. 防火墙设置是否允许API调用

## 联系支持

如果问题仍然存在，请：
1. 查看DeepSeek官方文档
2. 联系DeepSeek技术支持
3. 检查项目日志获取更多错误信息 