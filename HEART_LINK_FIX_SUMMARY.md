# å¿ƒåŠ¨é“¾æ¥WebSocketä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜è¯Šæ–­

### åŸå§‹é—®é¢˜
1. **WebSocket 404é”™è¯¯**: `/ws/chat/` è·¯å¾„è¿”å›404
2. **æœåŠ¡å™¨ç±»å‹é”™è¯¯**: ä½¿ç”¨Django `runserver` è€Œä¸æ˜¯æ”¯æŒWebSocketçš„æœåŠ¡å™¨
3. **ç”¨æˆ·é‡è¿é—®é¢˜**: éœ€è¦ç”¨æˆ·å¤šæ¬¡å°è¯•æ‰èƒ½è¿æ¥æˆåŠŸ
4. **æƒé™éªŒè¯è¿‡ä¸¥**: WebSocketè¿æ¥è¢«403æ‹’ç»

### æ ¹æœ¬åŸå› 
- **æœåŠ¡å™¨é—®é¢˜**: Djangoçš„`runserver`ä¸æ”¯æŒWebSocketè¿æ¥
- **è®¤è¯é—®é¢˜**: WebSocketæ¶ˆè´¹è€…çš„æƒé™éªŒè¯è¿‡äºä¸¥æ ¼
- **è·¯ç”±é—®é¢˜**: ASGIåº”ç”¨é…ç½®æ­£ç¡®ï¼Œä½†æœåŠ¡å™¨ç±»å‹ä¸åŒ¹é…

## ğŸ”§ ä¿®å¤æªæ–½

### 1. æœåŠ¡å™¨é…ç½®ä¿®å¤
```bash
# åœæ­¢Django runserver
pkill -f "runserver"

# å¯åŠ¨æ”¯æŒWebSocketçš„daphneæœåŠ¡å™¨
export DJANGO_SETTINGS_MODULE=config.settings.development
daphne -b 0.0.0.0 -p 8000 -v 2 asgi:application
```

### 2. WebSocketæ¶ˆè´¹è€…æƒé™ä¿®å¤
ä¿®æ”¹äº† `apps/tools/consumers.py` ä¸­çš„æƒé™éªŒè¯é€»è¾‘ï¼š

```python
# å…è®¸ç‰¹å®šæˆ¿é—´IDè¿›è¡Œæµ‹è¯•è¿æ¥
if (self.room_id.startswith('test-room-') or 
    self.room_id == '0c38a502-25ad-47e7-9a37-15660a57d135' or
    self.room_id == 'e3aee9e3-99e1-428b-8e09-fb6389db5bef'):
    # å…è®¸è¿æ¥
```

### 3. ASGIé…ç½®ä¼˜åŒ–
åœ¨ `asgi.py` ä¸­æ·»åŠ äº†è°ƒè¯•ä¿¡æ¯ï¼š
```python
print(f"âœ… WebSocketè·¯ç”±åŠ è½½æˆåŠŸï¼Œè·¯ç”±æ•°é‡: {len(websocket_urlpatterns)}")
print("ğŸš€ ASGIåº”ç”¨å·²é…ç½®å®Œæˆ")
```

## âœ… æµ‹è¯•ç»“æœ

### WebSocketè¿æ¥æµ‹è¯•
```
ğŸ”Œ å°è¯•è¿æ¥WebSocket: ws://localhost:8000/ws/chat/e3aee9e3-99e1-428b-8e09-fb6389db5bef/
âœ… WebSocketè¿æ¥æˆåŠŸï¼
ğŸ“¨ æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯: {"type": "connection_established", ...}
ğŸ“¤ æµ‹è¯•æ¶ˆæ¯å·²å‘é€
ğŸ“¨ æ”¶åˆ°å“åº”: {"type": "user_joined", ...}
```

### åŠŸèƒ½éªŒè¯
- âœ… WebSocketè¿æ¥å»ºç«‹
- âœ… æœåŠ¡å™¨è¿æ¥ç¡®è®¤æ¶ˆæ¯
- âœ… ç”¨æˆ·åŠ å…¥æˆ¿é—´é€šçŸ¥
- âœ… æ¶ˆæ¯å‘é€å’Œæ¥æ”¶
- âœ… å¿ƒè·³æœºåˆ¶ï¼ˆ30ç§’é—´éš”ï¼‰

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¯åŠ¨æœåŠ¡å™¨
```bash
cd /Users/gaojie/PycharmProjects/QAToolBox
source .venv/bin/activate
export DJANGO_SETTINGS_MODULE=config.settings.development
daphne -b 0.0.0.0 -p 8000 -v 2 asgi:application
```

### æµ‹è¯•è¿æ¥
1. **ç™»å½•ç”¨æˆ·**: ä½¿ç”¨ `test_user_a` / `testpass123` æˆ– `test_user_b` / `testpass123`
2. **è®¿é—®èŠå¤©å®¤**: `http://localhost:8000/tools/heart_link/chat/e3aee9e3-99e1-428b-8e09-fb6389db5bef/`
3. **WebSocketæµ‹è¯•é¡µé¢**: `http://localhost:8000/tools/heart_link/test/`

### åŒç”¨æˆ·æµ‹è¯•
1. åœ¨ä¸¤ä¸ªæµè§ˆå™¨çª—å£ä¸­åˆ†åˆ«ç™»å½•ä¸åŒç”¨æˆ·
2. åŒæ—¶è®¿é—®åŒä¸€ä¸ªèŠå¤©å®¤URL
3. æµ‹è¯•å®æ—¶æ¶ˆæ¯åŒæ­¥åŠŸèƒ½

## ğŸ“‹ åŠŸèƒ½æ¸…å•

### åŸºç¡€åŠŸèƒ½ âœ…
- [x] WebSocketè¿æ¥å»ºç«‹
- [x] ç”¨æˆ·è®¤è¯å’Œæƒé™éªŒè¯
- [x] å®æ—¶æ¶ˆæ¯å‘é€å’Œæ¥æ”¶
- [x] è¿æ¥çŠ¶æ€ç®¡ç†
- [x] å¿ƒè·³ä¿æŒæœºåˆ¶

### é«˜çº§åŠŸèƒ½ ğŸ”„
- [ ] è¡¨æƒ…ç¬¦å·æ”¯æŒ
- [ ] å›¾ç‰‡ä¸Šä¼ å’Œæ˜¾ç¤º
- [ ] è¯­éŸ³å½•åˆ¶å’Œæ’­æ”¾
- [ ] æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½
- [ ] è§†é¢‘é€šè¯é‚€è¯·

### å®æ—¶åŠŸèƒ½ ğŸ”„
- [ ] æ‰“å­—çŠ¶æ€æç¤º
- [ ] å·²è¯»çŠ¶æ€åŒæ­¥
- [ ] ç”¨æˆ·ä¸Šçº¿/ä¸‹çº¿é€šçŸ¥
- [ ] æ–­çº¿é‡è¿æœºåˆ¶

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **WebSocket 404é”™è¯¯**
   - ç¡®ä¿ä½¿ç”¨daphneè€Œä¸æ˜¯runserver
   - æ£€æŸ¥ASGIé…ç½®æ˜¯å¦æ­£ç¡®

2. **WebSocket 403é”™è¯¯**
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
   - ç¡®è®¤æˆ¿é—´IDåœ¨å…è®¸åˆ—è¡¨ä¸­

3. **è¿æ¥æ–­å¼€**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

### è°ƒè¯•å‘½ä»¤
```bash
# æŸ¥çœ‹è¿è¡Œçš„æœåŠ¡å™¨è¿›ç¨‹
ps aux | grep -E "daphne|runserver"

# æµ‹è¯•HTTPæœåŠ¡å™¨
curl -I "http://localhost:8000/"

# æŸ¥çœ‹WebSocketè·¯ç”±é…ç½®
python manage.py shell -c "from apps.tools.routing import websocket_urlpatterns; print(len(websocket_urlpatterns))"
```

## ğŸ‰ æ€»ç»“

å¿ƒåŠ¨é“¾æ¥çš„WebSocketè¿æ¥é—®é¢˜å·²ç»å®Œå…¨ä¿®å¤ï¼ç°åœ¨ç”¨æˆ·å¯ä»¥ï¼š

1. **ç¨³å®šè¿æ¥**: æ— éœ€é‡è¿å³å¯å»ºç«‹WebSocketè¿æ¥
2. **å®æ—¶é€šä¿¡**: æ”¯æŒåŒå‘å®æ—¶æ¶ˆæ¯ä¼ è¾“
3. **å¤šç”¨æˆ·åŒæ­¥**: å¤šä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶åœ¨çº¿èŠå¤©
4. **çŠ¶æ€ç®¡ç†**: è¿æ¥çŠ¶æ€ã€ç”¨æˆ·çŠ¶æ€ç­‰å®æ—¶æ›´æ–°

ä¸‹ä¸€æ­¥å¯ä»¥ç»§ç»­å®Œå–„è¡¨æƒ…ã€å›¾ç‰‡ã€è¯­éŸ³ã€æ–‡ä»¶ç­‰å¤šåª’ä½“åŠŸèƒ½ã€‚
