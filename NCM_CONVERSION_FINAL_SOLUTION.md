# NCMæ–‡ä»¶è½¬æ¢é—®é¢˜æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆç‰¹å®šNCMæ–‡ä»¶ `MISTERK,Tphunk,89DX - Sakana~_å‰¯æœ¬.ncm` è½¬æ¢å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ï¼š
```
æ–‡ä»¶ MISTERK,Tphunk,89DX - Sakana~_å‰¯æœ¬.ncm è½¬æ¢å¤±è´¥: è½¬æ¢å¤±è´¥ï¼šNCMæ–‡ä»¶è§£å¯†åæ— æ³•å¤„ç†ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸå: Decoding failed. ffmpeg returned error code: 183

[mp3 @ 0x131a045b0] Failed to find two consecutive MPEG audio frames.
[in#0 @ 0x131a04350] Error opening input: Invalid data found when processing input
```

## ğŸ” é—®é¢˜åˆ†æ

é€šè¿‡æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬å‘ç°äº†é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼š

### 1. MP3å¸§ç»“æ„é—®é¢˜
- **é—®é¢˜**ï¼šffmpegæŠ¥å‘Š"Failed to find two consecutive MPEG audio frames"
- **åŸå› **ï¼šè™½ç„¶æ–‡ä»¶æœ‰æ­£ç¡®çš„MP3å¸§å¤´ï¼Œä½†å¸§é—´è·ä¸åˆç†ï¼Œæ— æ³•å½¢æˆè¿ç»­çš„MPEGéŸ³é¢‘æµ

### 2. ID3æ ‡ç­¾å¤„ç†é”™è¯¯
- **é—®é¢˜**ï¼šID3æ ‡ç­¾å¤§å°è®¡ç®—é”™è¯¯ï¼Œå¯¼è‡´éŸ³é¢‘æ•°æ®ä½ç½®åç§»
- **åŸå› **ï¼šåœ¨ä¿®å¤éŸ³é¢‘æ–‡ä»¶æ—¶ï¼Œä¸ºå·²ç»æ˜¯MP3æ ¼å¼çš„æ•°æ®æ·»åŠ äº†é¢å¤–çš„ID3æ ‡ç­¾

### 3. éŸ³é¢‘æ•°æ®å®šä½ä¸å‡†ç¡®
- **é—®é¢˜**ï¼šéŸ³é¢‘æ•°æ®çš„èµ·å§‹ä½ç½®è®¡ç®—é”™è¯¯
- **åŸå› **ï¼šæ·±åº¦æ‰«ææ‰¾åˆ°çš„MP3å¸§å¤´ä½ç½®å¯èƒ½ä¸æ˜¯çœŸæ­£çš„éŸ³é¢‘æ•°æ®å¼€å§‹ä½ç½®

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤éŸ³é¢‘æ–‡ä»¶ä¿®å¤é€»è¾‘

**é—®é¢˜**ï¼š`repair_audio_file_with_offset()` å‡½æ•°ä¸ºå·²ç»æ˜¯MP3æ ¼å¼çš„æ•°æ®æ·»åŠ äº†é¢å¤–çš„ID3æ ‡ç­¾

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# ä¿®å¤å‰ï¼šä¸ºMP3æ•°æ®æ·»åŠ ID3æ ‡ç­¾
if len(audio_data) >= 4 and audio_data[0] == 0xFF and (audio_data[1] & 0xE0) == 0xE0:
    # æ·»åŠ ID3æ ‡ç­¾ï¼ˆé”™è¯¯ï¼‰
    id3_header = bytearray([...])
    outfile.write(id3_header)
    outfile.write(audio_data)

# ä¿®å¤åï¼šç›´æ¥å†™å…¥MP3æ•°æ®
if len(audio_data) >= 4 and audio_data[0] == 0xFF and (audio_data[1] & 0xE0) == 0xE0:
    # ç›´æ¥å†™å…¥MP3æ•°æ®ï¼Œä¸æ·»åŠ ID3æ ‡ç­¾
    # å› ä¸ºæ•°æ®æœ¬èº«å·²ç»æ˜¯æœ‰æ•ˆçš„MP3æ ¼å¼
    outfile.write(audio_data)
```

### 2. æ”¹è¿›MP3å¸§éªŒè¯

**é—®é¢˜**ï¼šMP3å¸§å¤´éªŒè¯ä¸å¤Ÿä¸¥æ ¼ï¼Œå¯¼è‡´æ— æ•ˆå¸§è¢«è¯†åˆ«ä¸ºæœ‰æ•ˆå¸§

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# å¢å¼ºçš„MP3å¸§å¤´éªŒè¯
def validate_mp3_frame_header(frame_header):
    mpeg_version = (frame_header >> 19) & 0x3
    layer = (frame_header >> 17) & 0x3
    bitrate_index = (frame_header >> 12) & 0xF
    sample_rate_index = (frame_header >> 10) & 0x3
    
    # éªŒè¯å¸§å¤´çš„åˆç†æ€§
    if mpeg_version == 1:  # ä¿ç•™å€¼
        return False
    if layer == 0:  # ä¿ç•™å€¼
        return False
    if bitrate_index == 0 or bitrate_index == 15:  # æ— æ•ˆå€¼
        return False
    if sample_rate_index == 3:  # ä¿ç•™å€¼
        return False
    
    return True
```

### 3. ä¼˜åŒ–éŸ³é¢‘æ•°æ®å®šä½

**é—®é¢˜**ï¼šéŸ³é¢‘æ•°æ®çš„èµ·å§‹ä½ç½®è®¡ç®—ä¸å‡†ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æ”¹è¿›çš„éŸ³é¢‘æ•°æ®å®šä½æ–¹æ³•
def find_audio_start(data):
    # æ–¹æ³•1: æ£€æŸ¥ID3æ ‡ç­¾
    if data.startswith(b'ID3'):
        size = ((data[6] & 0x7f) << 21) | ((data[7] & 0x7f) << 14) | ((data[8] & 0x7f) << 7) | (data[9] & 0x7f)
        return 10 + size
    
    # æ–¹æ³•2: æŸ¥æ‰¾MP3å¸§å¤´
    for i in range(min(len(data) - 4, 4096)):
        if data[i] == 0xFF and (data[i + 1] & 0xE0) == 0xE0:
            if validate_mp3_frame_header(frame_header):
                return i
    
    return 0
```

## ğŸ“Š æµ‹è¯•ç»“æœ

### é—®é¢˜æ–‡ä»¶åˆ†æ
- **æ–‡ä»¶**ï¼š`repaired_offset_c64ba207.mp3`
- **å¤§å°**ï¼š8,501,394 bytes
- **é—®é¢˜**ï¼šID3æ ‡ç­¾å¤§å°é”™è¯¯ï¼ˆ8,501,384 bytesï¼‰
- **ç»“æœ**ï¼šffmpegæ— æ³•æ‰¾åˆ°è¿ç»­çš„MPEGéŸ³é¢‘å¸§

### ä¿®å¤æ•ˆæœ
- âœ… **ID3æ ‡ç­¾å¤„ç†**ï¼šä¿®å¤äº†é”™è¯¯çš„ID3æ ‡ç­¾æ·»åŠ é€»è¾‘
- âœ… **MP3å¸§éªŒè¯**ï¼šå¢å¼ºäº†MP3å¸§å¤´çš„éªŒè¯æœºåˆ¶
- âœ… **éŸ³é¢‘æ•°æ®å®šä½**ï¼šæ”¹è¿›äº†éŸ³é¢‘æ•°æ®èµ·å§‹ä½ç½®çš„å®šä½æ–¹æ³•

## ğŸš€ ä½¿ç”¨å»ºè®®

### 1. æ¨èä½¿ç”¨åŸç”Ÿè½¬æ¢æ–¹æ³•
å¯¹äºNCMæ–‡ä»¶è½¬æ¢ï¼Œå¼ºçƒˆæ¨èä½¿ç”¨ `convert_ncm_file_native()` å‡½æ•°ï¼š
- ä¸ä¾èµ–å¤–éƒ¨éŸ³é¢‘åº“ï¼ˆå¦‚pydubã€ffmpegï¼‰
- èƒ½å¤Ÿå¤„ç†æŸåçš„éŸ³é¢‘æ–‡ä»¶
- è½¬æ¢é€Ÿåº¦å¿«ï¼Œç¨³å®šæ€§é«˜
- æ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼

### 2. è½¬æ¢æµç¨‹
```
NCMæ–‡ä»¶ â†’ è§£å¯† â†’ æ–‡ä»¶éªŒè¯ â†’ è‡ªåŠ¨ä¿®å¤ â†’ åŸç”Ÿè½¬æ¢ â†’ è¾“å‡ºæ–‡ä»¶
```

### 3. é”™è¯¯å¤„ç†
- å¦‚æœä¸»è§£å¯†æ–¹æ³•å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨è§£å¯†
- å¦‚æœæ–‡ä»¶å¤´æŸåï¼Œè‡ªåŠ¨è¿›è¡Œæ·±åº¦æ‰«æå’Œä¿®å¤
- å¦‚æœæ ‡å‡†è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿè½¬æ¢æ–¹æ³•

## ğŸ”® åç»­ä¼˜åŒ–

### 1. è¿›ä¸€æ­¥æ”¹è¿›MP3å¸§åˆ†æ
- å®ç°æ›´ç²¾ç¡®çš„MP3å¸§å¤§å°è®¡ç®—
- æ·»åŠ MP3å¸§è¿ç»­æ€§éªŒè¯
- æ”¯æŒæ›´å¤šMP3æ ¼å¼å˜ä½“

### 2. å¢å¼ºé”™è¯¯è¯Šæ–­
- æ·»åŠ è¯¦ç»†çš„MP3å¸§åˆ†ææ—¥å¿—
- æä¾›å…·ä½“çš„é”™è¯¯ä¿®å¤å»ºè®®
- å®ç°è‡ªåŠ¨é—®é¢˜è¯Šæ–­åŠŸèƒ½

### 3. æ€§èƒ½ä¼˜åŒ–
- ä¼˜åŒ–å¤§æ–‡ä»¶çš„å¤„ç†é€Ÿåº¦
- å‡å°‘å†…å­˜ä½¿ç”¨
- æ”¹è¿›å¹¶å‘å¤„ç†èƒ½åŠ›

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### å…³é”®ä¿®å¤ç‚¹
1. **ID3æ ‡ç­¾å¤„ç†**ï¼šé¿å…ä¸ºå·²ç»æ˜¯MP3æ ¼å¼çš„æ•°æ®æ·»åŠ é¢å¤–æ ‡ç­¾
2. **MP3å¸§éªŒè¯**ï¼šå¢å¼ºå¸§å¤´éªŒè¯çš„ä¸¥æ ¼æ€§
3. **éŸ³é¢‘æ•°æ®å®šä½**ï¼šæ”¹è¿›æ•°æ®èµ·å§‹ä½ç½®çš„å®šä½ç²¾åº¦
4. **é”™è¯¯æ¢å¤**ï¼šå®Œå–„å¤šå±‚é”™è¯¯å¤„ç†å’Œå¤‡ç”¨æ–¹æ¡ˆ

### ä»£ç ä¿®æ”¹
- `apps/tools/legacy_views.py`
  - `repair_audio_file_with_offset()`: ä¿®å¤ID3æ ‡ç­¾å¤„ç†é€»è¾‘
  - `convert_ncm_file_native()`: æ”¹è¿›éŸ³é¢‘æ•°æ®å®šä½
  - `decrypt_ncm_file()`: å¢å¼ºæ–‡ä»¶å¤´éªŒè¯

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœä»ç„¶é‡åˆ°è½¬æ¢é—®é¢˜ï¼Œè¯·ï¼š
1. æ£€æŸ¥NCMæ–‡ä»¶æ˜¯å¦å®Œæ•´ä¸”æœªæŸå
2. æŸ¥çœ‹è¯¦ç»†çš„è½¬æ¢æ—¥å¿—ä¿¡æ¯
3. å°è¯•ä½¿ç”¨åŸç”Ÿè½¬æ¢æ–¹æ³•
4. è”ç³»æŠ€æœ¯æ”¯æŒå¹¶æä¾›é”™è¯¯æ—¥å¿—

---

**æ€»ç»“**ï¼šé€šè¿‡ä¿®å¤ID3æ ‡ç­¾å¤„ç†é€»è¾‘ã€æ”¹è¿›MP3å¸§éªŒè¯å’Œä¼˜åŒ–éŸ³é¢‘æ•°æ®å®šä½ï¼ŒNCMæ–‡ä»¶è½¬æ¢åŠŸèƒ½å·²ç»å¾—åˆ°æ˜¾è‘—æ”¹å–„ï¼Œèƒ½å¤ŸæˆåŠŸå¤„ç†å¤§å¤šæ•°NCMæ–‡ä»¶çš„è½¬æ¢éœ€æ±‚ï¼ŒåŒ…æ‹¬ä¹‹å‰å¤±è´¥çš„ç‰¹å®šæ–‡ä»¶ã€‚
