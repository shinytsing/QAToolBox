# 路由器端口转发配置指南

## 🔍 问题诊断结果

### 当前状态
- **内网IP**: 192.168.0.118 ✅ 正常
- **公网IP**: 89.213.150.126 ✅ 正常
- **本地访问**: http://localhost:8000 ✅ 正常
- **内网访问**: http://192.168.0.118:8000 ✅ 正常
- **外网访问**: http://89.213.150.126:8000 ❌ 502错误

### 根本原因
**路由器端口转发未配置** - 外网请求无法到达内网服务器

## 🛠️ 解决方案：配置路由器端口转发

### 步骤1：登录路由器管理界面

1. **打开浏览器**，访问路由器管理地址：
   - 常见地址：`192.168.0.1` 或 `192.168.1.1`
   - 您的路由器：`192.168.0.1`（根据网关地址）

2. **输入管理员账号密码**
   - 通常在路由器背面标签上
   - 或查看路由器说明书

### 步骤2：找到端口转发设置

不同品牌路由器的设置位置：
- **TP-Link**: 高级功能 → NAT转发 → 虚拟服务器
- **华为**: 高级功能 → NAT → 虚拟服务器
- **小米**: 高级设置 → 端口转发
- **华硕**: 高级设置 → 端口转发
- **网件**: 高级 → 端口映射/端口转发

### 步骤3：添加端口转发规则

**配置参数**：
```
服务名称: QAToolBox
协议类型: TCP
外部端口: 8000
内部IP地址: 192.168.0.118
内部端口: 8000
状态: 启用
```

**详细配置**：
- **外部端口**: 8000（外网访问的端口）
- **内部IP**: 192.168.0.118（您的Mac内网IP）
- **内部端口**: 8000（Django服务端口）
- **协议**: TCP
- **状态**: 启用

### 步骤4：保存并重启

1. **保存配置**
2. **重启路由器**（可选，但推荐）
3. **等待2-3分钟**让配置生效

## 🔧 替代方案

### 方案1：使用标准端口（推荐）

如果8000端口被ISP阻止，可以配置80端口：

1. **修改Django配置**：
   ```bash
   # 停止当前服务
   pkill -f gunicorn
   
   # 使用80端口启动（需要sudo）
   sudo python3 -m gunicorn --bind 0.0.0.0:80 --workers 1 wsgi:application
   ```

2. **配置路由器端口转发**：
   ```
   外部端口: 80
   内部IP: 192.168.0.118
   内部端口: 80
   ```

3. **访问地址**：
   - http://89.213.150.126/
   - http://shenyiqing.xin/（配置DNS后）

### 方案2：使用其他端口

尝试其他常用端口：
- **8080**: 常用Web端口
- **3000**: 开发常用端口
- **9000**: 较少被阻止

## 📋 验证步骤

### 1. 检查端口转发是否生效

```bash
# 从外网测试
curl -s http://89.213.150.126:8000/health/

# 应该返回JSON响应
```

### 2. 检查路由器配置

登录路由器管理界面，确认：
- 端口转发规则已保存
- 状态为"启用"
- 内部IP地址正确

### 3. 检查防火墙

确保路由器防火墙允许8000端口：
- 检查防火墙规则
- 确保8000端口未被阻止

## ⚠️ 常见问题

### 问题1：端口转发配置后仍然502
**解决方案**：
- 检查内部IP地址是否正确
- 确认Django服务正在运行
- 重启路由器

### 问题2：ISP阻止8000端口
**解决方案**：
- 使用标准端口80或443
- 联系ISP申请开放端口
- 使用其他端口（8080、3000等）

### 问题3：动态IP地址变化
**解决方案**：
- 配置DDNS（动态DNS）
- 使用固定IP服务
- 定期更新端口转发规则

## 🎯 预期结果

配置完成后，以下地址应该都能正常访问：
- http://89.213.150.126:8000/
- http://89.213.150.126:8000/health/
- http://shenyiqing.xin:8000/（配置DNS后）

## 📞 技术支持

如果仍有问题，请检查：
1. 路由器型号和固件版本
2. ISP是否阻止了8000端口
3. 防火墙配置是否正确
4. 服务是否正常运行
