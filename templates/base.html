{% load static %}

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    {% if request.META.HTTP_X_LOGOUT_SUCCESS %}
    <meta name="clear-storage" content="true">
    {% endif %}
    <title>{% block title %}ModeShift{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
    <link rel="shortcut icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- ä¿®å¤æ‚¬æµ®å‡½æ•°æœªå®šä¹‰çš„é—®é¢˜ -->
    <script>
        // è®¾ç½®ä¸‹æ‹‰èœå•çš„æ‚¬æµ®åŠŸèƒ½
        let globalSettingsDropdownTimer = null;
        let globalMenuDropdownTimer = null;
        
        function showSettingsDropdown() {
            console.log('ğŸ”§ showSettingsDropdown è¢«è°ƒç”¨');
            
            // æ¸…é™¤éšè—å®šæ—¶å™¨
            if (globalSettingsDropdownTimer) {
                clearTimeout(globalSettingsDropdownTimer);
                globalSettingsDropdownTimer = null;
            }
            
            const dropdownContent = document.getElementById('settingsDropdownContent');
            if (!dropdownContent) {
                console.error('âŒ è®¾ç½®ä¸‹æ‹‰èœå•å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // æ˜¾ç¤ºèœå•
            dropdownContent.style.display = 'block';
            dropdownContent.style.opacity = '1';
            dropdownContent.style.transform = 'scale(1) translateY(0)';
            
            console.log('âœ… è®¾ç½®èœå•å·²æ˜¾ç¤º');
        }
        
        function hideSettingsDropdownDelayed() {
            console.log('ğŸ”§ hideSettingsDropdownDelayed è¢«è°ƒç”¨');
            
            // è®¾ç½®å»¶è¿Ÿéšè—å®šæ—¶å™¨
            globalSettingsDropdownTimer = setTimeout(() => {
                hideSettingsDropdown();
            }, 300);
        }
        
        function hideSettingsDropdown() {
            console.log('ğŸ”§ hideSettingsDropdown è¢«è°ƒç”¨');
            
            const dropdownContent = document.getElementById('settingsDropdownContent');
            if (!dropdownContent) return;
            
            // éšè—èœå•
            dropdownContent.style.display = 'none';
            dropdownContent.style.opacity = '0';
            dropdownContent.style.transform = 'scale(0.95) translateY(-10px)';
            
            console.log('âœ… è®¾ç½®èœå•å·²éšè—');
        }
        
        function showMenuDropdown() {
            console.log('ğŸ”§ showMenuDropdown è¢«è°ƒç”¨');
            
            // æ¸…é™¤éšè—å®šæ—¶å™¨
            if (globalMenuDropdownTimer) {
                clearTimeout(globalMenuDropdownTimer);
                globalMenuDropdownTimer = null;
            }
            
            const dropdownContent = document.getElementById('menuDropdownContent');
            if (!dropdownContent) {
                console.error('âŒ èœå•ä¸‹æ‹‰èœå•å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // æ˜¾ç¤ºèœå•
            dropdownContent.style.display = 'block';
            dropdownContent.style.opacity = '1';
            dropdownContent.style.transform = 'translateX(-50%) scale(1) translateY(0)';
            
            console.log('âœ… èœå•å·²æ˜¾ç¤º');
        }
        
        function hideMenuDropdownDelayed() {
            console.log('ğŸ”§ hideMenuDropdownDelayed è¢«è°ƒç”¨');
            
            // è®¾ç½®å»¶è¿Ÿéšè—å®šæ—¶å™¨
            globalMenuDropdownTimer = setTimeout(() => {
                hideMenuDropdown();
            }, 300);
        }
        
        function hideMenuDropdown() {
            console.log('ğŸ”§ hideMenuDropdown è¢«è°ƒç”¨');
            
            const dropdownContent = document.getElementById('menuDropdownContent');
            if (!dropdownContent) return;
            
            // éšè—èœå•
            dropdownContent.style.display = 'none';
            dropdownContent.style.opacity = '0';
            dropdownContent.style.transform = 'translateX(-50%) scale(0.95) translateY(-10px)';
            
            console.log('âœ… èœå•å·²éšè—');
        }
        
        // æ·»åŠ ç¼ºå¤±çš„æ¨¡æ€æ¡†å…³é—­å‡½æ•°
        function closeSettingsModal() {
            console.log('âŒ å…³é—­è®¾ç½®æ¨¡æ€æ¡†');
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.style.display = 'none';
                if (settingsModal.parentNode) {
                    settingsModal.parentNode.removeChild(settingsModal);
                }
            }
        }
        
        function closeMenuModal() {
            console.log('âŒ å…³é—­èœå•æ¨¡æ€æ¡†');
            const menuModal = document.getElementById('menuModal');
            if (menuModal) {
                menuModal.style.display = 'none';
                if (menuModal.parentNode) {
                    menuModal.parentNode.removeChild(menuModal);
                }
            }
        }
        
        // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å¯ç”¨
        window.showSettingsDropdown = showSettingsDropdown;
        window.hideSettingsDropdownDelayed = hideSettingsDropdownDelayed;
        window.hideSettingsDropdown = hideSettingsDropdown;
        window.showMenuDropdown = showMenuDropdown;
        window.hideMenuDropdownDelayed = hideMenuDropdownDelayed;
        window.hideMenuDropdown = hideMenuDropdown;
        window.closeSettingsModal = closeSettingsModal;
        window.closeMenuModal = closeMenuModal;
    </script>
    
    <!-- æœ¬åœ°å­—ä½“å›é€€æ–¹æ¡ˆï¼Œé¿å…Google FontsåŠ è½½å¤±è´¥ -->
    <style>
        /* å­—ä½“å›é€€æ–¹æ¡ˆ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        code, pre {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }
        /* ç¡®ä¿å­—ä½“åŠ è½½å¤±è´¥æ—¶é¡µé¢ä»èƒ½æ­£å¸¸æ˜¾ç¤º */
        .font-fallback {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
        }
    </style>
    <link id="dynamic-theme-css" rel="stylesheet" href="{% static 'geek.css' %}">
    <link rel="stylesheet" href="{% static 'responsive.css' %}">
    <link rel="stylesheet" href="{% static 'css/feature-recommendation.css' %}">
    {% block extra_css %}{% endblock %}

    <style>
        /* å…¨å±€container-fluidéšè—å’Œæ‚¬åœæ˜¾ç¤º */
        .container-fluid {
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .container-fluid:hover,
        .container-fluid.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        /* éšè—å¯¼èˆªæ  */
        .navbar.navbar-expand-lg.navbar-dark.unified-navbar,
        .navbar.unified-navbar,
        .geek-navbar,
        .life-navbar,
        .emo-navbar,
        .cyber-navbar,
        .rage-navbar,
        .punk-navbar {
            display: none !important;
        }
        
        /* é¡¶éƒ¨æ åŠ¨ç”»æ•ˆæœ */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        /* é¡¶éƒ¨å›ºå®šUI - ä¸ä¸»é¡µä¿æŒä¸€è‡´çš„é¢œè‰² */
        .top-ui-bar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 9999 !important;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%) !important;
            backdrop-filter: blur(20px) !important;
            border-bottom: 2px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(102, 126, 234, 0.2) !important;
            padding: 15px 20px !important;
            display: flex !important;
            justify-content: space-around !important;
            align-items: center !important;
            opacity: 1 !important;
            transform: translateY(0) !important;
            transition: all 0.3s ease !important;
            border-radius: 0 0 15px 15px !important;
            min-height: 70px !important;
        }
        
        /* ç”¨æˆ·ä¸‹æ‹‰èœå•æ ·å¼ */
        .top-ui-user-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .top-ui-user-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(26, 26, 26, 0.95) 50%, rgba(45, 45, 45, 0.95) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid #00ff41;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 255, 65, 0.3), 0 0 20px rgba(0, 255, 65, 0.1);
            min-width: 200px;
            z-index: 10000;
            margin-top: 10px;
            padding: 10px 0;
        }
        
        .top-ui-user-dropdown-content.show {
            display: block;
            animation: dropdownFadeIn 0.3s ease;
        }
        
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .top-ui-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: #ffffff;
            text-decoration: none;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }
        
        .top-ui-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .top-ui-dropdown-item:hover {
            background: rgba(0, 255, 65, 0.1);
            color: #00ff41;
            text-shadow: 0 0 8px #00ff41;
        }
        
        .top-ui-dropdown-item i {
            width: 16px;
            text-align: center;
        }
        
        .top-ui-brand {
            color: #ffffff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .top-ui-user {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffffff;
        }
        
        /* æŒ‰é’®åŠ¨ç”»æ•ˆæœ */
        @keyframes buttonPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes buttonShine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        @keyframes buttonGlow {
            0% { box-shadow: 0 2px 10px rgba(255, 255, 255, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(255, 255, 255, 0.5); }
            100% { box-shadow: 0 2px 10px rgba(255, 255, 255, 0.3); }
        }
        
        @keyframes iconSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes iconBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }
        
        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        .top-ui-item:hover {
            animation: buttonPulse 0.3s ease-in-out;
            transform: translateY(-2px);
        }
        
        .top-ui-item:hover .button-shine {
            animation: buttonShine 0.6s ease-in-out;
            opacity: 1;
        }
        
        .top-ui-item:hover .fas {
            animation: iconBounce 0.6s ease-in-out;
        }
        
        /* è®¾ç½®æŒ‰é’®ç‰¹æ®Šæ•ˆæœ */
        .top-ui-item[onclick*="showSettings"]:hover .fas {
            animation: iconSpin 1s linear infinite;
        }
        
        /* éšè—æŒ‰é’®ç‰¹æ®Šæ•ˆæœ */
        .top-ui-item[onclick*="hideTopUI"]:hover {
            animation: buttonGlow 1s ease-in-out infinite;
        }
        
        /* ä¸‹æ‹‰èœå•åŠ¨ç”» */
        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* ç”¨æˆ·å¤´åƒæ‚¬åœæ•ˆæœ */
        .top-ui-user:hover .top-ui-avatar {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
        }
        
        /* ç”¨æˆ·åæ‚¬åœæ•ˆæœ */
        .top-ui-user:hover .top-ui-username {
            background: linear-gradient(45deg, #00ff88, #4ecdc4, #00ff88) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.8) !important;
        }
        
        /* ä¸‹æ‹‰ç®­å¤´æ—‹è½¬æ•ˆæœ */
        .top-ui-user:hover .fa-chevron-down {
            transform: rotate(180deg);
        }
        
        /* ä¸‹æ‹‰èœå•é¡¹æ‚¬åœæ•ˆæœ */
        .top-ui-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .top-ui-dropdown-item:hover .item-hover-effect {
            opacity: 1;
            left: 100%;
        }
        
        /* ç”¨æˆ·åŒºåŸŸæ‚¬åœæ•ˆæœ */
        .top-ui-user:hover .user-hover-effect {
            opacity: 1;
            left: 100%;
        }
        }
        
        .top-ui-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .top-ui-username {
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .top-ui-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #ffffff;
            text-decoration: none;
            min-width: 70px;
            border: 1px solid transparent;
        }
        
        .top-ui-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .top-ui-item i {
            font-size: 1.1rem;
            margin-bottom: 2px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .top-ui-item span {
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .top-ui-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ffffff;
            font-weight: bold;
            font-size: 1.1rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .top-ui-brand i {
            font-size: 1.3rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .top-ui-badge {
            padding: 2px 8px;
            font-size: 0.7em;
            font-weight: 600;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            color: #fff;
        }
        
        /* è°ƒæ•´é¡µé¢å†…å®¹ï¼Œç§»é™¤é¡¶éƒ¨ç©ºé—´ */
        body {
            padding-top: 0;
        }
        
        /* èœå•æŒ‰é’®æ‚¬æµ®æ˜¾ç¤º */
        .mobile-menu-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(102, 126, 234, 0.2);
            opacity: 0;
            transform: translateY(-20px);
        }
        
        .mobile-menu-btn:hover,
        .mobile-menu-btn.show {
            opacity: 1;
            transform: translateY(0);
            background: linear-gradient(135deg, #16213e 0%, #0f3460 50%, #1a1a2e 100%);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(102, 126, 234, 0.3);
        }
        
        .mobile-menu-btn i {
            font-size: 1.2rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        /* å½©è›‹ç›¸å…³æ ·å¼ */
        .easter-egg-particle {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            animation: particleFloat 5s ease-in-out infinite;
        }
        
        @keyframes particleFloat {
            0% {
                opacity: 0;
                transform: translateY(0) rotate(0deg) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translateY(-20px) rotate(180deg) scale(1);
            }
            80% {
                opacity: 1;
                transform: translateY(-100px) rotate(360deg) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-150px) rotate(720deg) scale(0.8);
            }
        }
        
        @keyframes celebrationPulse {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        @keyframes messageSlideIn {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* æ°¸ä¹…æ˜¾ç¤ºèœå•æŒ‰é’®æ ·å¼ */
        .mobile-menu-btn.permanent {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
        
        /* ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨ */
        .pull-refresh-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            z-index: 9998;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .pull-refresh-indicator.show {
            transform: translateY(0);
        }
        
        /* å…¨å±€åŠ¨ç”»å’Œç‰¹æ•ˆ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* ä¸»é¢˜å¾½ç« æ ·å¼ */
        .theme-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            padding: 2px 8px;
            font-size: 0.65em;
            font-weight: 600;
            text-transform: uppercase;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            color: #fff;
            letter-spacing: 0.2px;
            animation: themePulse 3s ease-in-out infinite;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .theme-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .theme-badge:hover::before {
            left: 100%;
        }
        
        .theme-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 15px rgba(102, 126, 234, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        @keyframes themePulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        .theme-badge.punk {
            background: linear-gradient(45deg, #ff0080, #00ff80);
            animation: punkFlash 1s ease-in-out infinite;
        }
        
        .theme-badge.rage {
            background: linear-gradient(45deg, #ff0000, #ff4500);
            animation: rageShake 0.5s ease-in-out infinite;
        }
        
        .theme-badge.emo {
            background: linear-gradient(45deg, #667eea, #764ba2);
            animation: emoGlow 3s ease-in-out infinite;
        }
        
        @keyframes punkFlash {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; text-shadow: 0 0 10px #ff0080; }
        }
        
        @keyframes rageShake {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(1deg); }
            75% { transform: scale(1.05) rotate(-1deg); }
        }
        
        @keyframes emoGlow {
            0%, 100% { opacity: 0.8; box-shadow: 0 0 10px rgba(102, 126, 234, 0.5); }
            50% { opacity: 1; box-shadow: 0 0 20px rgba(102, 126, 234, 0.8); }
        }
        
        /* é‡Œä¸–ç•Œå…¥å£åŠ¨ç”» */
        @keyframes glitch {
            0%, 90%, 100% { 
                transform: translate(0); 
                filter: hue-rotate(0deg) brightness(1);
            }
            5% { 
                transform: translate(-2px, 2px); 
                filter: hue-rotate(180deg) brightness(1.5);
            }
            10% { 
                transform: translate(-2px, -2px); 
                filter: hue-rotate(90deg) brightness(1.3);
            }
            15% { 
                transform: translate(2px, 2px); 
                filter: hue-rotate(270deg) brightness(1.4);
            }
            20% { 
                transform: translate(2px, -2px); 
                filter: hue-rotate(45deg) brightness(1.6);
            }
        }
        
        /* ä¸»é¢˜åˆ‡æ¢æ‚¬åœæ•ˆæœ */
        .theme-switch:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            transform: translateX(5px);
        }
        
        /* ä¸‹æ‹‰èœå•é¡¹æ‚¬åœæ•ˆæœ */
        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            transform: translateX(3px) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* ç™»å‡ºæŒ‰é’®ç‰¹æ®Šæ‚¬åœæ•ˆæœ */
        .dropdown-item[href*="logout"]:hover {
            background: rgba(255, 107, 107, 0.2) !important;
            color: #ff8e8e !important;
        }
        
        /* è®¾ç½®æŒ‰é’®æ‚¬åœæ•ˆæœ */
        #settingsDropdown:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* è®¾ç½®æŒ‰é’®å›¾æ ‡æ—‹è½¬åŠ¨ç”» */
        #settingsDropdown:hover i {
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .theme-switch.active {
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important;
            border-left: 3px solid #667eea;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* éšè—æ»šåŠ¨æ¡æ ·å¼ */
        /* Webkitæµè§ˆå™¨ (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: transparent;
        }
        
        /* Firefoxæµè§ˆå™¨ */
        html {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* IEå’ŒEdge */
        body {
            -ms-overflow-style: none;
        }
        
        /* ç¡®ä¿æ‰€æœ‰å¯æ»šåŠ¨å…ƒç´ éƒ½éšè—æ»šåŠ¨æ¡ */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        *::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        .emo-bg .floating-element:nth-child(2) { top: 15%; right: 20%; }
        .emo-bg .floating-element:nth-child(3) { bottom: 25%; left: 25%; }
        .emo-bg .floating-element:nth-child(4) { bottom: 15%; right: 10%; }

        /* ç²’å­æ•ˆæœ */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(0, 255, 231, 0.6);
            border-radius: 50%;
            animation: particleFloat 8s linear infinite;
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px);
                opacity: 0;
            }
        }

        /* åŠ¨æ€é¼ æ ‡å…‰æ ‡æ•ˆæœ */
        .custom-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: difference;
        }

        .cursor-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: linear-gradient(45deg, #00ffe7, #ff0080);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: cursorPulse 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(0, 255, 231, 0.5);
        }

        .cursor-trail {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 255, 231, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: cursorTrail 1.5s ease-in-out infinite;
        }

        .custom-cursor.active .cursor-dot {
            transform: translate(-50%, -50%) scale(1.5);
            background: linear-gradient(45deg, #ff0080, #00ffe7);
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.8);
        }

        .custom-cursor.active .cursor-trail {
            transform: translate(-50%, -50%) scale(2);
            border-color: rgba(255, 0, 128, 0.6);
        }

        .custom-cursor.hover .cursor-dot {
            transform: translate(-50%, -50%) scale(1.3);
            background: linear-gradient(45deg, #ff0080, #00ffe7);
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.8);
        }

        .custom-cursor.hover .cursor-trail {
            transform: translate(-50%, -50%) scale(1.5);
            border-color: rgba(255, 0, 128, 0.6);
        }

        @keyframes cursorPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.8;
            }
        }

        @keyframes cursorTrail {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.3;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 0.6;
            }
        }

        /* ä¸»é¢˜ç›¸å…³çš„é¼ æ ‡å…‰æ ‡æ ·å¼ */
        body.life-theme .cursor-dot {
            background: linear-gradient(45deg, #ff0080, #00ff80);
            box-shadow: 0 0 10px rgba(255, 0, 128, 0.5);
        }

        body.life-theme .cursor-trail {
            border-color: rgba(255, 0, 128, 0.3);
        }

        body.work-theme .cursor-dot {
            background: linear-gradient(45deg, #00ffe7, #0099ff);
            box-shadow: 0 0 10px rgba(0, 255, 231, 0.5);
        }

        body.work-theme .cursor-trail {
            border-color: rgba(0, 255, 231, 0.3);
        }

        body.training-theme .cursor-dot {
            background: linear-gradient(45deg, #ff4444, #ff8844);
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        body.training-theme .cursor-trail {
            border-color: rgba(255, 68, 68, 0.3);
        }

        body.emo-theme .cursor-dot {
            background: linear-gradient(45deg, #667eea, #764ba2);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        body.emo-theme .cursor-trail {
            border-color: rgba(102, 126, 234, 0.3);
        }

        /* å“åº”å¼è®¾è®¡ - ç§»åŠ¨è®¾å¤‡ä¸Šéšè—è‡ªå®šä¹‰å…‰æ ‡ */
        @media (max-width: 768px) {
            .custom-cursor {
                display: none !important;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¸Šéšè—è‡ªå®šä¹‰å…‰æ ‡ */
        @media (hover: none) and (pointer: coarse) {
            .custom-cursor {
                display: none !important;
            }
        }

        /* å‡å°‘åŠ¨ç”» - ä¸ºåå¥½å‡å°‘åŠ¨ç”»çš„ç”¨æˆ· */
        @media (prefers-reduced-motion: reduce) {
            .custom-cursor {
                display: none !important;
            }
        }

        /* é“¾æ¥å’ŒæŒ‰é’®æ‚¬åœæ—¶çš„å…‰æ ‡æ•ˆæœ */
        a:hover ~ .custom-cursor .cursor-dot,
        button:hover ~ .custom-cursor .cursor-dot,
        .nav-link:hover ~ .custom-cursor .cursor-dot {
            transform: translate(-50%, -50%) scale(1.3);
            background: linear-gradient(45deg, #ff0080, #00ffe7);
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.8);
        }

        a:hover ~ .custom-cursor .cursor-trail,
        button:hover ~ .custom-cursor .cursor-trail,
        .nav-link:hover ~ .custom-cursor .cursor-trail {
            transform: translate(-50%, -50%) scale(1.5);
            border-color: rgba(255, 0, 128, 0.6);
        }

        /* é¡µé¢åŠ è½½åŠ¨ç”» */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--geek-bg, #0a0e17);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loader-content {
            text-align: center;
            color: var(--geek-primary, #00ffe7);
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 255, 231, 0.3);
            border-top: 3px solid #00ffe7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            letter-spacing: 2px;
            animation: textGlow 2s ease-in-out infinite alternate;
        }

        @keyframes textGlow {
            0% { text-shadow: 0 0 10px rgba(0, 255, 231, 0.5); }
            100% { text-shadow: 0 0 20px rgba(0, 255, 231, 0.8); }
        }



        /* é€‰æ‹©æ–‡æœ¬æ ·å¼ */
        ::selection {
            background: rgba(0, 255, 231, 0.3);
            color: #fff;
        }

        ::-moz-selection {
            background: rgba(0, 255, 231, 0.3);
            color: #fff;
        }

        /* å“åº”å¼è®¾è®¡ - å…¨é¢ä¼˜åŒ– */

        /* å¤§å±å¹• (1200px+) */
        @media (min-width: 1200px) {
            .navbar-brand {
                font-size: 1.8rem;
            }
            
            .theme-subtitle {
                font-size: 1.1rem;
            }
            
            .nav-link {
                font-size: 1.1rem;
                padding: 0.8rem 1.2rem !important;
            }
            
            .floating-element {
                font-size: 2.5rem;
            }
            
            .particle {
                width: 6px;
                height: 6px;
            }
            
            .cursor-follower {
                width: 25px;
                height: 25px;
            }
        }

        /* ä¸­ç­‰å±å¹• (768px - 1199px) */
        @media (max-width: 1199px) and (min-width: 768px) {
            .navbar-brand {
                font-size: 1.5rem;
            }
            
            .theme-subtitle {
                font-size: 1rem;
            }
            
            .nav-link {
                font-size: 1rem;
                padding: 0.6rem 1rem !important;
            }
            
            .floating-element {
                font-size: 2rem;
            }
            
            .particle {
                width: 4px;
                height: 4px;
            }
        }

        /* å¹³æ¿ç«¯ (768pxä»¥ä¸‹) */
        @media (max-width: 767px) {
            .navbar-brand {
                font-size: 1.3rem;
            }
            
            .theme-subtitle {
                font-size: 0.9rem;
                display: none;
            }
            
            .navbar-nav {
                margin-top: 1rem;
            }
            
            .nav-link {
                font-size: 0.95rem;
                padding: 0.5rem 0.8rem !important;
                text-align: center;
            }
            
            .dropdown-menu {
                background: rgba(0,0,0,0.95) !important;
                border: 1px solid rgba(255,255,255,0.2) !important;
                margin-top: 0.5rem;
            }
            
            .dropdown-item {
                color: #fff !important;
                padding: 0.5rem 1rem !important;
                font-size: 0.9rem;
            }
            
            .floating-element {
                font-size: 1.5rem;
            }
            
            .particle {
                width: 3px;
                height: 3px;
            }
            
            .cursor-follower {
                width: 15px;
                height: 15px;
            }
            
            /* ç§»åŠ¨ç«¯éšè—éƒ¨åˆ†æµ®åŠ¨å…ƒç´  */
            .floating-element:nth-child(3),
            .floating-element:nth-child(4) {
                display: none;
            }
        }

        /* æ‰‹æœºç«¯ (480pxä»¥ä¸‹) */
        @media (max-width: 480px) {
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .navbar-toggler {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
            }
            
            .nav-link {
                font-size: 0.9rem;
                padding: 0.4rem 0.6rem !important;
            }
            
            .dropdown-menu {
                min-width: 200px;
            }
            
            .dropdown-item {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem !important;
            }
            
            .floating-element {
                font-size: 1.2rem;
            }
            
            .particle {
                width: 2px;
                height: 2px;
            }
            
            .cursor-follower {
                width: 12px;
                height: 12px;
            }
            
            /* å°å±å¹•éšè—æ›´å¤šæµ®åŠ¨å…ƒç´  */
            .floating-element:nth-child(2) {
                display: none;
            }
        }

        /* è¶…å°å±å¹• (320pxä»¥ä¸‹) */
        @media (max-width: 320px) {
            .navbar-brand {
                font-size: 1rem;
            }
            
            .nav-link {
                font-size: 0.8rem;
                padding: 0.3rem 0.5rem !important;
            }
            
            .dropdown-item {
                font-size: 0.8rem;
                padding: 0.3rem 0.6rem !important;
            }
            
            .floating-element {
                font-size: 1rem;
            }
            
            .particle {
                width: 1px;
                height: 1px;
            }
            
            .cursor-follower {
                width: 10px;
                height: 10px;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (orientation: landscape) and (max-height: 500px) {
            .navbar {
                padding: 0.5rem 1rem;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .nav-link {
                font-size: 0.9rem;
                padding: 0.3rem 0.6rem !important;
            }
            
            .floating-element {
                font-size: 1rem;
            }
            
            .particle {
                width: 2px;
                height: 2px;
            }
        }

        /* é«˜åˆ†è¾¨ç‡å±å¹•ä¼˜åŒ– */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .navbar-brand {
                font-weight: 600;
            }
            
            .nav-link {
                font-weight: 500;
            }
            
            .particle {
                box-shadow: 0 0 2px rgba(0, 255, 231, 0.8);
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .nav-link {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .dropdown-item {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .navbar-toggler {
                min-width: 44px;
                min-height: 44px;
            }
            
            /* å¢åŠ è§¦æ‘¸åé¦ˆ */
            .nav-link:active {
                background-color: rgba(255, 255, 255, 0.1) !important;
            }
            
            .dropdown-item:active {
                background-color: rgba(255, 255, 255, 0.1) !important;
            }
        }

        /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            .navbar {
                background-color: rgba(10, 14, 23, 0.95) !important;
            }
            
            .dropdown-menu {
                background-color: rgba(10, 14, 23, 0.95) !important;
            }
        }

        /* æ‰“å°æ ·å¼ */
        @media print {
            .navbar,
            .floating-elements,
            .particles,
            .cursor-follower,
            .page-loader {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }
        
        /* çŸ©é˜µé›¨æ•ˆæœ */
        #matrix-rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        /* Emoç²’å­æ•ˆæœ */
        #emo-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        @keyframes emoParticleFloat {
            0%, 100% { 
                transform: translateY(0px) translateX(0px); 
                opacity: 0.6; 
            }
            50% { 
                transform: translateY(-30px) translateX(20px); 
                opacity: 1; 
            }
        }
        header {
            background: rgba(0, 0, 0, 0.95);
            transition: background 0.3s;
            z-index: 2;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ç»Ÿä¸€å¯¼èˆªæ æ ·å¼ - ç°ä»£åŒ–è®¾è®¡ */
        html body .navbar.unified-navbar,
        html body .unified-navbar,
        .navbar.unified-navbar,
        .unified-navbar {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%) !important;
            backdrop-filter: blur(15px) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1000 !important;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            padding: 0.75rem 2rem !important;
            max-width: none !important;
            margin: 0 !important;
            left: 0 !important;
            transform: none !important;
            min-height: 70px !important;
            max-height: 70px !important;
            height: 70px !important;
            display: flex !important;
            align-items: center !important;
            overflow: visible !important;
            width: 100% !important;
            position: relative !important;
        }
        
        /* å¯¼èˆªæ æ‚¬æµ®æ•ˆæœ */
        .unified-navbar:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2), 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-1px) !important;
        }
        
        /* å¯¼èˆªæ èƒŒæ™¯åŠ¨ç”» */
        .unified-navbar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s ease;
            pointer-events: none;
        }
        
        .unified-navbar:hover::before {
            left: 100%;
        }
        
        /* ç»Ÿä¸€å¯¼èˆªæ æ–‡å­—æ ·å¼ - æœ€é«˜ä¼˜å…ˆçº§ */
        html body .unified-navbar .nav-link,
        html body .unified-navbar .navbar-brand,
        html body .unified-navbar .nav-link i,
        html body .unified-navbar .nav-link span,
        html body .unified-navbar .user-nav-link,
        .unified-navbar .nav-link,
        .unified-navbar .navbar-brand,
        .unified-navbar .nav-link i,
        .unified-navbar .nav-link span,
        .unified-navbar .user-nav-link {
            color: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;
        }
        
        /* ç»Ÿä¸€å¯¼èˆªæ å“ç‰Œæ ·å¼ */
        .unified-navbar .navbar-brand {
            font-size: 1.3rem !important;
            font-weight: 700 !important;
            text-decoration: none !important;
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            padding: 0.5rem 1rem !important;
            border-radius: 8px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            min-height: 45px !important;
            position: relative !important;
            overflow: hidden !important;
        }
        .unified-navbar .navbar-brand::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .unified-navbar .navbar-brand:hover {
            color: #ffffff !important;
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            transform: translateY(-2px) scale(1.02) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2), 0 0 20px rgba(255, 255, 255, 0.2) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9), 0 0 10px rgba(255, 255, 255, 0.5) !important;
        }
        
        .unified-navbar .navbar-brand:hover::before {
            left: 100%;
        }
        
        /* ç»Ÿä¸€å¯¼èˆªæ é“¾æ¥æ ·å¼ */
        .unified-navbar .nav-link {
            color: #ffffff !important;
            font-weight: 600 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
            line-height: 1 !important;
            padding: 0.5rem 1rem !important;
            border-radius: 8px !important;
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            position: relative !important;
            overflow: hidden !important;
            margin: 0 0.25rem !important;
        }
        
        .unified-navbar .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.4s ease;
        }
        
        .unified-navbar .nav-link:hover {
            color: #ffffff !important;
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            transform: translateY(-2px) scale(1.05) !important;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25), 0 0 15px rgba(255, 255, 255, 0.2) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9), 0 0 10px rgba(255, 255, 255, 0.5) !important;
        }
        
        .unified-navbar .nav-link:hover::before {
            left: 100%;
        }
        
        /* ç»Ÿä¸€ä¸»é¢˜å¾½ç« æ ·å¼ */
        .unified-navbar .theme-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: #ffffff !important;
            padding: 4px 12px !important;
            border-radius: 20px !important;
            font-size: 0.8rem !important;
            font-weight: 600 !important;
            margin-left: 8px !important;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3) !important;
        }
        
        /* ç¡®ä¿æ‰€æœ‰ä¸»é¢˜å¯¼èˆªæ éƒ½ä½¿ç”¨ç»Ÿä¸€çš„åŸºç¡€æ ·å¼ */
        .geek-navbar,
        .life-navbar,
        .emo-navbar,
        .cyber-navbar,
        .punk-nav {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1000 !important;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            padding: 0 !important;
            max-width: none !important;
            margin: 0 !important;
            transform: none !important;
            min-height: 64px !important;
            max-height: 64px !important;
            height: 64px !important;
            display: flex !important;
            align-items: center !important;
            overflow: visible !important;
            width: 100% !important;
        }

        /* é»˜è®¤æ‰€æœ‰é¡µé¢æ‚¬æµ®èœå• */
        .navbar .navbar-nav {
            opacity: 0 !important;
            visibility: hidden !important;
            transform: translateY(-15px) !important;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            pointer-events: none !important;
        }

        .navbar:hover .navbar-nav {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
        }

        /* å½“navbar-navæ˜¾ç¤ºæ—¶ï¼Œå…¶å†…éƒ¨çš„ä¸‹æ‹‰èœå•ä¹Ÿè¦å¯ç‚¹å‡» */
        .navbar:hover .navbar-nav .dropdown,
        .navbar:hover .navbar-nav .dropdown-menu {
            pointer-events: auto !important;
        }

        /* ç¡®ä¿ä¸‹æ‹‰èœå•å®¹å™¨å§‹ç»ˆå¯ç‚¹å‡» */
        .navbar .dropdown,
        .navbar .user-dropdown-container,
        .navbar .nav-buttons {
            pointer-events: auto !important;
            z-index: 1050 !important;
        }

        /* ç¡®ä¿ä¸‹æ‹‰èœå•å…ƒç´ å¯ç‚¹å‡» */
        .navbar .dropdown-toggle,
        .navbar .user-nav-link,
        .navbar .btn {
            pointer-events: auto !important;
        }

        /* ä¸‹æ‹‰èœå•æ˜¾ç¤ºæ—¶çš„æ ·å¼ */
        .dropdown.show .dropdown-menu {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
        }

        /* é»˜è®¤æ‚¬æµ®æç¤º - èå…¥ç°æœ‰è®¾è®¡é£æ ¼ */
        .navbar::after {
            content: "â–²";
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 8px;
            opacity: 0.6;
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 0.3;
                transform: translateY(-50%) scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: translateY(-50%) scale(1.1);
            }
        }

        .navbar:hover::after {
            opacity: 0;
        }

        /* é¦–é¡µæ ·å¼é€šè¿‡JavaScriptåŠ¨æ€æ§åˆ¶ */

        /* èœå•é¡¹æ¸è¿›æ˜¾ç¤º */
        .navbar .navbar-nav .nav-item:nth-child(1) { transition-delay: 0.05s; }
        .navbar .navbar-nav .nav-item:nth-child(2) { transition-delay: 0.1s; }
        .navbar .navbar-nav .nav-item:nth-child(3) { transition-delay: 0.15s; }
        .navbar .navbar-nav .nav-item:nth-child(4) { transition-delay: 0.2s; }
        .navbar .navbar-nav .nav-item:nth-child(5) { transition-delay: 0.25s; }

        /* ç§»åŠ¨ç«¯æ”¯æŒ - æ‰€æœ‰é¡µé¢éƒ½æ­£å¸¸æ˜¾ç¤ºèœå• */
        @media (max-width: 991.98px) {
            .navbar .navbar-nav {
                opacity: 1 !important;
                visibility: visible !important;
                transform: none !important;
                pointer-events: auto !important;
                transition: none !important;
            }
            
            .navbar::after {
                display: none !important;
            }
        }

        /* é”®ç›˜å¯¼èˆªæ”¯æŒ - æ‰€æœ‰é¡µé¢ */
        .navbar:focus-within .navbar-nav {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            pointer-events: auto !important;
        }

        /* å¯¼èˆªæ æ•´ä½“ä¼˜åŒ– - ä¸ç°æœ‰ä¸»é¢˜é£æ ¼ä¿æŒä¸€è‡´ */
        .navbar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .navbar:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
        }

        /* ä¸åŒä¸»é¢˜æ¨¡å¼çš„æ‚¬æµ®æç¤ºé€‚é… */
        .life-navbar::after {
            color: rgba(40, 167, 69, 0.6) !important;
        }

        .geek-navbar::after {
            color: rgba(0, 255, 231, 0.6) !important;
        }

        .emo-navbar::after {
            color: rgba(156, 39, 176, 0.6) !important;
        }

        .cyber-navbar::after {
            color: rgba(255, 0, 110, 0.6) !important;
        }

        .rage-navbar::after {
            color: rgba(255, 68, 68, 0.6) !important;
        }

        .punk-nav::after {
            color: rgba(255, 0, 128, 0.6) !important;
        }
        
        /* ç¡®ä¿æ‰€æœ‰ä¸»é¢˜å¯¼èˆªæ æ–‡å­—éƒ½æ˜¯ç™½è‰² */
        .geek-navbar .nav-link,
        .geek-navbar .navbar-brand,
        .geek-navbar .nav-link i,
        .geek-navbar .nav-link span,
        .geek-navbar .user-nav-link,
        .life-navbar .nav-link,
        .life-navbar .navbar-brand,
        .life-navbar .nav-link i,
        .life-navbar .nav-link span,
        .life-navbar .user-nav-link,
        .emo-navbar .nav-link,
        .emo-navbar .navbar-brand,
        .emo-navbar .nav-link i,
        .emo-navbar .nav-link span,
        .emo-navbar .user-nav-link,
        .cyber-navbar .nav-link,
        .cyber-navbar .navbar-brand,
        .cyber-navbar .nav-link i,
        .cyber-navbar .nav-link span,
        .cyber-navbar .user-nav-link,
        .punk-nav .nav-link,
        .punk-nav .navbar-brand,
        .punk-nav .nav-link i,
        .punk-nav .nav-link span,
        .punk-nav .user-nav-link {
            color: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;
        }
        .navbar a {
            transition: color 0.3s;
        }
        .navbar a:hover {
            transform: translateY(-1px);
            transition: all 0.3s ease;
        }
        .nav-buttons {
            margin-left: auto;
            display: flex;
            align-items: center;
        }
        .container {
            padding: 0;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 120px);
            width: 100%;
            max-width: 100%;
        }
        footer {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 20px 0;
            text-align: center;
            width: 100%;
        }
        .content-block {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            backdrop-filter: none;
            width: 100%;
            position: relative;
            z-index: 1;
        }
        .announcement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .announcement-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .announcement-content {
            background: #fff;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideInDown 0.4s ease;
        }
        
        .announcement-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .announcement-header h5 {
            margin: 0;
            font-size: 16px;
        }
        
        .announcement-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .announcement-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .announcement-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .announcement-item {
            margin-bottom: 15px;
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .announcement-item.priority-high {
            border-left-color: #dc3545;
        }
        
        .announcement-item.priority-medium {
            border-left-color: #ffc107;
        }
        
        .announcement-item.priority-low {
            border-left-color: #6c757d;
        }
        
        .announcement-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .announcement-text {
            color: #666;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .announcement-time {
            font-size: 12px;
            color: #999;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .btn-custom {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-primary.btn-custom {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border-color: #007bff;
        }
        .btn-primary.btn-custom:hover {
            background: linear-gradient(45deg, #0056b3, #004085);
        }
        .btn-secondary.btn-custom {
            background: linear-gradient(45deg, #6c757d, #545b62);
            border-color: #6c757d;
        }
        .btn-secondary.btn-custom:hover {
            background: linear-gradient(45deg, #545b62, #3d4449);
        }
        .btn-outline-light {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .btn-outline-light:hover {
            transform: rotate(90deg);
            background: rgba(255,255,255,0.1);
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            position: relative;
        }
        .navbar-brand:hover {
            transform: scale(1.05);
            transition: all 0.3s ease;
        }
        
        .theme-subtitle {
            font-size: 0.7rem;
            font-weight: normal;
            color: rgba(255, 255, 255, 0.8);
            margin-top: -5px;
            text-shadow: none;
            transition: all 0.3s ease;
            opacity: 0.8;
        }
        
        .theme-subtitle:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        .nav-link {
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-nav-link {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: left 0.3s ease;
        }
        .nav-link:hover::after {
            left: 0;
        }
        .dropdown-menu {
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .dropdown-item:hover {
            background: rgba(255,255,255,0.1) !important;
            transform: translateX(5px);
            transition: all 0.3s ease;
        }
        .social-icons a:hover {
            color: #FFD700 !important;
        }
        
        /* éŸ³ä¹ä¿¡æ¯æ ·å¼ */
        .music-info {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 280px;
            max-width: 320px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .music-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .music-info-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .music-cover {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .music-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .music-details {
            flex: 1;
            min-width: 0;
        }
        
        .music-title {
            color: white;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .music-artist {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .music-controls {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .music-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .music-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .music-btn:active {
            transform: scale(0.95);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .music-info {
                top: 70px;
                right: 10px;
                left: 10px;
                max-width: none;
                min-width: auto;
            }
        }
    </style>
</head>
<body data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}" class="{% if request.resolver_match.url_name == 'home' %}home-page{% endif %}">
    <!-- é¡µé¢åŠ è½½åŠ¨ç”» -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text">ModeShift</div>
        </div>
    </div>

    <!-- åŠ¨æ€é¼ æ ‡å…‰æ ‡æ•ˆæœ -->
    <div class="custom-cursor" id="customCursor">
        <div class="cursor-dot"></div>
        <div class="cursor-trail"></div>
    </div>

    <!-- ç²’å­æ•ˆæœ -->
    <div class="particles" id="particles"></div>

    <!-- ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨ -->
    <audio id="theme-music" loop volume="0.3">
        <source id="music-source" src="" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ ‡ç­¾ã€‚
    </audio>
    
    <!-- éŸ³ä¹ä¿¡æ¯æ˜¾ç¤º -->
    <div id="music-info" class="music-info" style="display: none;">
        <div class="music-info-content">
            <div class="music-cover">
                <img id="music-cover-img" src="" alt="å°é¢">
            </div>
            <div class="music-details">
                <div class="music-title" id="music-title">åŠ è½½ä¸­...</div>
                <div class="music-artist" id="music-artist">æœªçŸ¥æ­Œæ‰‹</div>
            </div>
            <div class="music-controls">
                <button class="music-btn" onclick="nextSong()" title="ä¸‹ä¸€é¦–">
                    <i class="fas fa-forward"></i>
                </button>
                <button class="music-btn" onclick="toggleMusic()" title="æ’­æ”¾/æš‚åœ">
                    <i class="fas fa-play" id="music-play-icon"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ä»…åœ¨ home é¡µæ˜¾ç¤ºå…¬å‘Šå¼¹çª— -->
    {% if request.path == '/' %}
    <div class="announcement-overlay" id="announcement-overlay">
        <div class="announcement-content">
            <div class="announcement-header">
                <h5><i class="fas fa-bullhorn"></i> ç³»ç»Ÿå…¬å‘Š</h5>
                <button class="announcement-close" onclick="closeAnnouncement()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="announcement-body" id="announcement-body">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨ -->
    <div class="pull-refresh-indicator" id="pullRefreshIndicator">
        <i class="fas fa-sync-alt fa-spin"></i> æ­£åœ¨åˆ·æ–°...
    </div>
    
    <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
    <button class="mobile-menu-btn d-lg-none" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- ä¾§è¾¹æ èƒŒæ™¯ -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    
    <!-- é¡¶éƒ¨å›ºå®šUI -->
    <div class="top-ui-bar" id="topUiBar" style="position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; z-index: 9999 !important; background: rgba(0, 0, 0, 0.05) !important; backdrop-filter: blur(10px) !important; border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important; padding: 15px 20px !important; display: flex !important; justify-content: space-around !important; align-items: center !important; opacity: 1 !important; transform: translateY(0) !important; transition: all 0.3s ease !important; border-radius: 0 0 15px 15px !important; min-height: 70px !important; visibility: visible !important;">
        <script>
            // ç«‹å³ç¡®ä¿é¡¶éƒ¨èœå•æ˜¾ç¤º
            document.getElementById('topUiBar').style.display = 'flex';
            document.getElementById('topUiBar').style.opacity = '1';
            document.getElementById('topUiBar').style.visibility = 'visible';
            console.log('ğŸš€ é¡¶éƒ¨èœå•ç«‹å³æ˜¾ç¤º');
        </script>
        <!-- å“ç‰Œæ ‡è¯† -->
        <div class="top-ui-brand" onclick="window.location.href='{% url 'home' %}'" style="display: flex !important; align-items: center !important; color: white !important; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5) !important; font-weight: bold !important; font-size: 1.2rem !important; cursor: pointer !important; transition: all 0.3s ease !important; padding: 8px 15px !important; border-radius: 20px !important; background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; position: relative !important; overflow: hidden !important;">
            <i class="fas fa-cube" style="margin-right: 8px !important; color: #00ff41 !important; animation: rotate 3s linear infinite !important;"></i>
            <span style="background: linear-gradient(45deg, #00ff41, #ff69b4, #4ecdc4, #45b7d1) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; animation: gradientShift 4s ease-in-out infinite !important;">MODESHIFT</span>
            <div class="brand-hover-effect" style="position: absolute !important; top: 0 !important; left: -100% !important; width: 100% !important; height: 100% !important; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent) !important; transition: left 0.5s ease !important;"></div>
        </div>
        
        <!-- å…³äºæŒ‰é’® -->
        <div class="top-ui-item" id="aboutButton" onclick="showAboutModal()" style="color: white !important; cursor: pointer !important; padding: 15px !important; border-radius: 50% !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; background: transparent !important; border: none !important; box-shadow: none !important; position: relative !important; overflow: hidden !important;">
            <i class="fas fa-user-circle" style="font-size: 1.8rem !important; position: relative; z-index: 2; text-shadow: 0 0 20px rgba(52, 152, 219, 0.8), 0 0 40px rgba(52, 152, 219, 0.6) !important; filter: drop-shadow(0 0 10px rgba(52, 152, 219, 0.8)) !important;"></i>
            <div class="button-shine" style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(52, 152, 219, 0.6), transparent); transform: rotate(45deg); transition: all 0.6s ease; opacity: 0;"></div>
        </div>
        

        
        <!-- èœå•æŒ‰é’® -->
        <div class="top-ui-menu-dropdown">
            <div class="top-ui-item" onmouseenter="showMenuDropdown()" onmouseleave="hideMenuDropdownDelayed()" style="color: white !important; cursor: pointer !important; padding: 15px !important; border-radius: 50% !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; background: transparent !important; border: none !important; box-shadow: none !important; position: relative !important; overflow: hidden !important;">
                <i class="fas fa-bars" style="font-size: 1.8rem !important; position: relative; z-index: 2; text-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.6) !important; filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)) !important;"></i>
                <div class="button-shine" style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.6), transparent); transform: rotate(45deg); transition: all 0.6s ease; opacity: 0;"></div>
            </div>
            <div class="top-ui-menu-dropdown-content" id="menuDropdownContent" onmouseenter="showMenuDropdown()" onmouseleave="hideMenuDropdownDelayed()" style="display: none; position: absolute; left: 50%; top: 100%; transform: translateX(-50%) scale(0.95) translateY(-10px); background: linear-gradient(135deg, rgba(52, 152, 219, 0.95) 0%, rgba(155, 89, 182, 0.95) 50%, rgba(74, 144, 226, 0.95) 100%); backdrop-filter: blur(20px); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(52, 152, 219, 0.3); min-width: 200px; z-index: 10000; margin-top: 10px; padding: 15px 0; transform-origin: top center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0;">
                <div style="padding: 0 20px 15px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 10px;">
                    <div style="font-size: 1.1rem; font-weight: 600; color: white; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);">ğŸ§­ å¯¼èˆªèœå•</div>
                </div>
                <a href="{% url 'home' %}" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-home" style="width: 16px; text-align: center; color: #2ecc71;"></i>
                    <span>é¦–é¡µ</span>
                </a>
                <a href="/tools/" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-tools" style="width: 16px; text-align: center; color: #f39c12;"></i>
                    <span>å·¥å…·é›†</span>
                </a>
                <a href="/users/profile/" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-user" style="width: 16px; text-align: center; color: #3498db;"></i>
                    <span>ä¸ªäººä¸­å¿ƒ</span>
                </a>
                <a href="/tools/chat/" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-comments" style="width: 16px; text-align: center; color: #e74c3c;"></i>
                    <span>èŠå¤©å®¤</span>
                </a>
            </div>
        </div>
        
        <!-- éšè—æŒ‰é’® -->
        <div class="top-ui-item" onclick="hideTopUI()" style="color: white !important; cursor: pointer !important; padding: 15px !important; border-radius: 50% !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; background: transparent !important; border: none !important; box-shadow: none !important; position: relative !important; overflow: hidden !important;">
            <i class="fas fa-eye-slash" style="font-size: 1.8rem !important; position: relative; z-index: 2; text-shadow: 0 0 20px rgba(231, 76, 60, 0.8), 0 0 40px rgba(231, 76, 60, 0.6) !important; filter: drop-shadow(0 0 10px rgba(231, 76, 60, 0.8)) !important;"></i>
            <div class="button-shine" style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(231, 76, 60, 0.6), transparent); transform: rotate(45deg); transition: all 0.6s ease; opacity: 0;"></div>
        </div>
        {% if user.is_authenticated %}
        <div class="top-ui-user-dropdown">
            <div class="top-ui-user" onmouseenter="showUserDropdown()" onmouseleave="hideUserDropdownDelayed()" style="display: flex !important; align-items: center !important; gap: 12px !important; color: white !important; cursor: pointer !important; padding: 10px 15px !important; border-radius: 25px !important; background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; backdrop-filter: blur(10px) !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; position: relative !important; overflow: hidden !important;">
                <img class="top-ui-avatar" src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}{% static 'img/default-avatar.svg' %}{% endif %}" alt="ç”¨æˆ·å¤´åƒ" style="width: 35px !important; height: 35px !important; border-radius: 50% !important; border: 2px solid rgba(255, 255, 255, 0.3) !important; box-shadow: 0 0 15px rgba(255, 255, 255, 0.3) !important; transition: all 0.3s ease !important;">
                <span class="top-ui-username" style="font-weight: 600 !important; font-size: 0.95rem !important; text-shadow: 0 0 10px rgba(78, 205, 196, 0.8) !important; color: #4ecdc4 !important; background: linear-gradient(45deg, #4ecdc4, #45b7d1, #4ecdc4) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important;">{{ user.username }}</span>
                <i class="fas fa-chevron-down" style="margin-left: 5px; font-size: 14px; transition: transform 0.3s ease; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);"></i>
                <div class="user-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: left 0.5s ease; opacity: 0;"></div>
            </div>
            <div class="top-ui-user-dropdown-content" id="userDropdownContent" onmouseenter="showUserDropdown()" onmouseleave="hideUserDropdownDelayed()" style="display: none; position: absolute; right: 0; top: 100%; background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(26, 26, 26, 0.95) 50%, rgba(45, 45, 45, 0.95) 100%); backdrop-filter: blur(20px); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 15px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.1); min-width: 280px; max-height: 80vh; overflow-y: auto; z-index: 10000; margin-top: 10px; padding: 15px 0; transform-origin: top right; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; transform: scale(0.95) translateY(-10px);">
                <div style="padding: 0 20px 15px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 10px;">
                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 5px;">æ¬¢è¿å›æ¥</div>
                    <div style="font-size: 1.1rem; font-weight: 600; color: white; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);">{{ user.username }}</div>
                </div>
                <a href="{% url 'users:profile' %}" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-user" style="width: 16px; text-align: center; color: #4ecdc4;"></i>
                    <span>ä¸ªäººèµ„æ–™</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(78, 205, 196, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="{% url 'users:profile_edit' %}" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-edit" style="width: 16px; text-align: center; color: #45b7d1;"></i>
                    <span>ç¼–è¾‘èµ„æ–™</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(69, 183, 209, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <!-- ğŸ§­ å¿«é€Ÿå¯¼èˆªåŒº -->
                <div style="padding: 0 20px 10px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 10px;">
                    <div style="font-size: 0.8rem; color: #4ecdc4; margin-bottom: 8px; text-align: center; font-weight: 600;">
                        <i class="fas fa-compass" style="margin-right: 6px;"></i>å¿«é€Ÿå¯¼èˆª
                    </div>
                </div>
                <a href="{% url 'home' %}" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-home" style="width: 16px; text-align: center; color: #2ecc71;"></i>
                    <span>é¦–é¡µ</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(46, 204, 113, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="#" onclick="goToCurrentModeTools(); return false;" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-tools" style="width: 16px; text-align: center; color: #f39c12;"></i>
                    <span>å·¥å…·é›†</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(243, 156, 18, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="/tools/chat/" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-comments" style="width: 16px; text-align: center; color: #e74c3c;"></i>
                    <span>èŠå¤©å®¤</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(231, 76, 60, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="/tools/heart_link/" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-heart" style="width: 16px; text-align: center; color: #e91e63;"></i>
                    <span>å¿ƒé“¾åŒ¹é…</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(233, 30, 99, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="#" onclick="showSuggestions(); return false;" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-lightbulb" style="width: 16px; text-align: center; color: #ffc107;"></i>
                    <span>æˆ‘çš„å»ºè®®</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 193, 7, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                
                <!-- ğŸ¨ ä¸»é¢˜æ¨¡å¼åŒº -->
                <div style="padding: 10px 20px 10px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 10px;">
                    <div style="font-size: 0.8rem; color: #ff6b6b; margin-bottom: 8px; text-align: center; font-weight: 600;">
                        <i class="fas fa-palette" style="margin-right: 6px;"></i>ä¸»é¢˜æ¨¡å¼
                    </div>
                </div>
                <a href="#" onclick="switchTheme('life'); return false;" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-seedling" style="width: 16px; text-align: center; color: #27ae60;"></i>
                    <span>ç”Ÿæ´»æ¨¡å¼</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(39, 174, 96, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="#" onclick="switchTheme('work'); return false;" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-laptop-code" style="width: 16px; text-align: center; color: #3498db;"></i>
                    <span>æå®¢æ¨¡å¼</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="#" onclick="switchTheme('training'); return false;" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-dumbbell" style="width: 16px; text-align: center; color: #e74c3c;"></i>
                    <span>ç‹‚æš´æ¨¡å¼</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(231, 76, 60, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="#" onclick="switchTheme('emo'); return false;" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-heart-broken" style="width: 16px; text-align: center; color: #9b59b6;"></i>
                    <span>Emoæ¨¡å¼</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(155, 89, 182, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                
                <!-- ğŸ“š å¸®åŠ©ä¸ä¿¡æ¯åŒº -->
                <div style="padding: 10px 20px 10px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 10px;">
                    <div style="font-size: 0.8rem; color: #20c997; margin-bottom: 8px; text-align: center; font-weight: 600;">
                        <i class="fas fa-info-circle" style="margin-right: 6px;"></i>å¸®åŠ©ä¸ä¿¡æ¯
                    </div>
                </div>
                <a href="{% url 'help_page' %}" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-question-circle" style="width: 16px; text-align: center; color: #17a2b8;"></i>
                    <span>å¸®åŠ©ä¸­å¿ƒ</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(23, 162, 184, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="{% url 'version_history' %}" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-history" style="width: 16px; text-align: center; color: #6c757d;"></i>
                    <span>ç‰ˆæœ¬è®°å½•</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(108, 117, 125, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="#" onclick="showHiddenInfo(); return false;" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-eye" style="width: 16px; text-align: center; color: #fd7e14;"></i>
                    <span>å…³äºç³»ç»Ÿ</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(253, 126, 20, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                {% if user.is_staff or user.is_superuser %}
                <div style="padding: 0 20px; margin: 10px 0;">
                    <div style="height: 1px; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);"></div>
                </div>
                <div style="padding: 0 20px 5px 20px;">
                    <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.5); font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">ç®¡ç†å‘˜</div>
                </div>
                <a href="/admin/" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-shield-alt" style="width: 16px; text-align: center; color: #f39c12;"></i>
                    <span>ç®¡ç†åå°</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(243, 156, 18, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="{% url 'users:admin_user_management' %}" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-users-cog" style="width: 16px; text-align: center; color: #9b59b6;"></i>
                    <span>ç”¨æˆ·ç®¡ç†</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(155, 89, 182, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="{% url 'content:admin_feature_management' %}" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-cogs" style="width: 16px; text-align: center; color: #3498db;"></i>
                    <span>åŠŸèƒ½ç®¡ç†</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                <a href="{% url 'tools:monitoring_dashboard' %}" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-chart-line" style="width: 16px; text-align: center; color: #2ecc71;"></i>
                    <span>ç³»ç»Ÿç›‘æ§</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(46, 204, 113, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
                {% endif %}
                <div style="padding: 0 20px; margin: 10px 0;">
                    <div style="height: 1px; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);"></div>
                </div>
                <a href="{% url 'users:logout' %}" class="top-ui-dropdown-item" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #ffffff; text-decoration: none; transition: all 0.3s ease; border-radius: 8px; margin: 0 10px 5px 10px; position: relative; overflow: hidden;">
                    <i class="fas fa-sign-out-alt" style="width: 16px; text-align: center; color: #e67e22;"></i>
                    <span>é€€å‡ºç™»å½•</span>
                    <div class="item-hover-effect" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(230, 126, 34, 0.1), transparent); transition: left 0.3s ease; opacity: 0;"></div>
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark unified-navbar" aria-label="ä¸»å¯¼èˆª" style="--navbar-text-color: rgba(255, 255, 255, 0.9) !important; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%) !important; backdrop-filter: blur(20px) !important; border-bottom: 2px solid rgba(255, 255, 255, 0.15) !important; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(102, 126, 234, 0.2) !important;">
            <div class="container-fluid">
                <!-- å“ç‰ŒLogoåŒºåŸŸ -->
                <a class="navbar-brand" href="{% url 'home' %}" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">
                    <i class="fas fa-cogs"></i> ModeShift
                    <div id="theme-subtitle" class="theme-subtitle" data-translate="ä¸“æ³¨æŠ€æœ¯ï¼Œè¿½æ±‚å“è¶Š">ä¸“æ³¨æŠ€æœ¯ï¼Œè¿½æ±‚å“è¶Š</div>
                </a>
            
            <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- å¯¼èˆªèœå•åŒºåŸŸ -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- ä¸»å¯¼èˆªèœå• -->
                <ul class="navbar-nav mr-auto">
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="goToCurrentModeTools(); return false;" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">
                            <i class="fas fa-tools" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;"></i> <span data-translate="å·¥å…·é›†" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">å·¥å…·é›†</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSuggestions(); return false;" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">
                            <i class="fas fa-lightbulb" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;"></i> <span data-translate="æˆ‘çš„å»ºè®®" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">æˆ‘çš„å»ºè®®</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showHiddenInfo()" title="åŒå‡»æ˜¾ç¤ºéšè—ä¿¡æ¯" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">
                            <i class="fas fa-info-circle" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;"></i> <span data-translate="å…³äº" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">å…³äº</span>
                        </a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showHiddenInfo()" title="åŒå‡»æ˜¾ç¤ºéšè—ä¿¡æ¯" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">
                            <i class="fas fa-info-circle" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;"></i> <span data-translate="å…³äº" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">å…³äº</span>
                        </a>
                    </li>
                    {% endif %}
                </ul>

                <!-- å³ä¾§ç”¨æˆ·åŒºåŸŸ -->
                <div class="nav-buttons">
                    {% if user.is_authenticated %}
                        <!-- ç”¨æˆ·å¤´åƒå’Œä¸‹æ‹‰èœå• -->
                        <div class="dropdown user-dropdown-container">
                            <button class="nav-link user-nav-link dropdown-toggle" style="cursor: pointer; background: none; border: none;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="userDropdown">
                                <img id="user-avatar" src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}{% static 'img/default-avatar.svg' %}{% endif %}" alt="ç”¨æˆ·å¤´åƒ" class="user-avatar">
                                <span id="username-display" style="color: #ffffff !important; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">{{ user.username }}</span>
                                <span id="theme-badge" class="theme-badge">æå®¢</span>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 50%, rgba(240, 147, 251, 0.95) 100%); border: 1px solid rgba(255,255,255,0.2); min-width: 280px; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 20px rgba(102, 126, 234, 0.3); border-radius: 12px; backdrop-filter: blur(15px); margin-top: 8px;">
                                
                                <!-- ğŸ§­ å¿«é€Ÿå¯¼èˆªåŒº -->
                                <h6 class="dropdown-header" style="color: #4ecdc4; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; padding: 10px 16px; font-size: 0.85rem;">
                                    <i class="fas fa-compass" style="margin-right: 8px;"></i>å¿«é€Ÿå¯¼èˆª
                                </h6>
                                <a class="dropdown-item" href="{% url 'home' %}" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-home" style="color: #2ecc71; margin-right: 8px; width: 16px; text-align: center;"></i> é¦–é¡µ
                                </a>
                                <a class="dropdown-item" href="#" onclick="goToCurrentModeTools(); return false;" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-tools" style="color: #f39c12; margin-right: 8px; width: 16px; text-align: center;"></i> å·¥å…·é›†
                                </a>
                                <a class="dropdown-item" href="/tools/chat/" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-comments" style="color: #e74c3c; margin-right: 8px; width: 16px; text-align: center;"></i> èŠå¤©å®¤
                                </a>
                                <a class="dropdown-item" href="/tools/heart_link/" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-heart" style="color: #e91e63; margin-right: 8px; width: 16px; text-align: center;"></i> å¿ƒé“¾åŒ¹é…
                                </a>
                                <a class="dropdown-item" href="#" onclick="showSuggestions(); return false;" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-lightbulb" style="color: #ffc107; margin-right: 8px; width: 16px; text-align: center;"></i> æˆ‘çš„å»ºè®®
                                </a>
                                
                                <div class="dropdown-divider" style="border-color: rgba(255,255,255,0.1); margin: 8px 12px;"></div>
                                
                                <!-- ğŸ‘¤ è´¦æˆ·è®¾ç½®åŒº -->
                                <h6 class="dropdown-header" style="color: #667eea; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; padding: 10px 16px; font-size: 0.85rem;">
                                    <i class="fas fa-user-cog" style="margin-right: 8px;"></i>è´¦æˆ·è®¾ç½®
                                </h6>
                                <a class="dropdown-item" href="{% url 'users:profile' %}" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-user-edit" style="color: #4ecdc4; margin-right: 8px; width: 16px; text-align: center;"></i> ä¸ªäººèµ„æ–™
                                </a>
                                <a class="dropdown-item" href="#" id="edit-avatar-btn" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-user-circle" style="color: #45b7d1; margin-right: 8px; width: 16px; text-align: center;"></i> ç¼–è¾‘å¤´åƒ
                                </a>
                                <a class="dropdown-item" href="#" onclick="openShareFromMenu(); return false;" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-share-alt" style="color: #17a2b8; margin-right: 8px; width: 16px; text-align: center;"></i> åˆ†äº«å½“å‰é¡µ
                                </a>
                                
                                <div class="dropdown-divider" style="border-color: rgba(255,255,255,0.1); margin: 8px 12px;"></div>
                                
                                <!-- ğŸ¨ ç•Œé¢æ¨¡å¼åŒº -->
                                <h6 class="dropdown-header" style="color: #ff6b6b; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; padding: 10px 16px; font-size: 0.85rem;">
                                    <i class="fas fa-palette" style="margin-right: 8px;"></i>ç•Œé¢æ¨¡å¼
                                </h6>
                                <a class="dropdown-item theme-switch" href="#" data-mode="life" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-seedling" style="color: #27ae60; margin-right: 8px; width: 16px; text-align: center;"></i> ç”Ÿæ´»æ¨¡å¼
                                </a>
                                <a class="dropdown-item theme-switch" href="#" data-mode="work" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-laptop-code" style="color: #3498db; margin-right: 8px; width: 16px; text-align: center;"></i> æå®¢æ¨¡å¼
                                </a>
                                <a class="dropdown-item theme-switch" href="#" data-mode="training" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-dumbbell" style="color: #e74c3c; margin-right: 8px; width: 16px; text-align: center;"></i> ç‹‚æš´æ¨¡å¼
                                </a>
                                <a class="dropdown-item theme-switch" href="#" data-mode="emo" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-heart-broken" style="color: #9b59b6; margin-right: 8px; width: 16px; text-align: center;"></i> Emoæ¨¡å¼
                                </a>
                                
                                <div class="dropdown-divider" style="border-color: rgba(255,255,255,0.1); margin: 8px 12px;"></div>
                                
                                <!-- ğŸ“š å¸®åŠ©ä¸ä¿¡æ¯åŒº -->
                                <h6 class="dropdown-header" style="color: #20c997; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; padding: 10px 16px; font-size: 0.85rem;">
                                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>å¸®åŠ©ä¸ä¿¡æ¯
                                </h6>
                                <a class="dropdown-item" href="{% url 'help_page' %}" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-question-circle" style="color: #17a2b8; margin-right: 8px; width: 16px; text-align: center;"></i> å¸®åŠ©ä¸­å¿ƒ
                                </a>
                                <a class="dropdown-item" href="{% url 'version_history' %}" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-history" style="color: #6c757d; margin-right: 8px; width: 16px; text-align: center;"></i> ç‰ˆæœ¬è¿­ä»£è®°å½•
                                </a>
                                <a class="dropdown-item" href="#" onclick="showHiddenInfo(); return false;" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                    <i class="fas fa-eye" style="color: #fd7e14; margin-right: 8px; width: 16px; text-align: center;"></i> å…³äºç³»ç»Ÿ
                                </a>

                                {% if user.role.is_admin %}
                                    <div class="dropdown-divider" style="border-color: rgba(255,255,255,0.1); margin: 8px 12px;"></div>
                                    <!-- ğŸ”‘ ç®¡ç†å‘˜åŠŸèƒ½åŒº -->
                                    <h6 class="dropdown-header" style="color: #FFD700; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; padding: 10px 16px; font-size: 0.85rem;">
                                        <i class="fas fa-crown" style="margin-right: 8px;"></i>ç®¡ç†å‘˜åŠŸèƒ½
                                    </h6>
                                    <a class="dropdown-item" href="{% url 'content:admin_dashboard' %}" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                        <i class="fas fa-tachometer-alt" style="color: #28a745; margin-right: 8px; width: 16px; text-align: center;"></i> ä»ªè¡¨æ¿
                                    </a>
                                    <a class="dropdown-item" href="{% url 'content:admin_announcements' %}" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                        <i class="fas fa-bullhorn" style="color: #ffc107; margin-right: 8px; width: 16px; text-align: center;"></i> å…¬å‘Šç®¡ç†
                                    </a>
                                    <a class="dropdown-item" href="{% url 'content:admin_suggestions' %}" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                        <i class="fas fa-lightbulb" style="color: #fd7e14; margin-right: 8px; width: 16px; text-align: center;"></i> å»ºè®®ç®¡ç†
                                    </a>
                                    <a class="dropdown-item" href="/tools/food_photo_binding/" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                        <i class="fas fa-link" style="color: #6f42c1; margin-right: 8px; width: 16px; text-align: center;"></i> é£Ÿç‰©ç…§ç‰‡ç»‘å®š
                                    </a>
                                    <a class="dropdown-item" href="/tools/food_image_correction/" style="color: #fff; padding: 10px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 2px 8px;">
                                        <i class="fas fa-camera-retro" style="color: #e83e8c; margin-right: 8px; width: 16px; text-align: center;"></i> é£Ÿç‰©å›¾ç‰‡çŸ«æ­£
                                    </a>
                                {% endif %}
                                
                                <div class="dropdown-divider" style="border-color: rgba(255,255,255,0.1); margin: 8px 12px;"></div>
                                
                                <!-- ğŸ’¡ è®¾ç½®æç¤º -->
                                <div class="dropdown-item" style="color: rgba(255,255,255,0.8); font-size: 0.75rem; padding: 8px 16px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); font-style: italic; background: rgba(255,255,255,0.05);">
                                    <i class="fas fa-cog" style="margin-right: 6px; color: #ffc107;"></i> æ›´å¤šè®¾ç½®è¯·è®¿é—®å³ä¸Šè§’é½¿è½®æŒ‰é’®
                                </div>
                                
                                <!-- ğŸšª ç™»å‡º -->
                                <a class="dropdown-item logout-btn" href="{% url 'users:logout' %}" onclick="stopMedia();" style="color: #ff6b6b; padding: 12px 16px; transition: all 0.3s ease; border-radius: 6px; margin: 8px 8px 4px 8px; border-top: 2px solid rgba(255,255,255,0.1); background: rgba(255, 107, 107, 0.1);">
                                    <i class="fas fa-sign-out-alt" style="color: #ff6b6b; margin-right: 8px; width: 16px; text-align: center;"></i> <span data-translate="ç™»å‡º">ç™»å‡º</span>
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <a href="{% url 'users:login' %}" class="btn btn-primary btn-custom" onclick="stopMedia()">
                            <i class="fas fa-sign-in-alt"></i> <span data-translate="ç™»å½•">ç™»å½•</span>
                        </a>
                        <a href="{% url 'users:register' %}" class="btn btn-secondary btn-custom" onclick="stopMedia()">
                            <i class="fas fa-user-plus"></i> <span data-translate="æ³¨å†Œ">æ³¨å†Œ</span>
                        </a>
                    {% endif %}
                    
                    <!-- è®¾ç½®æŒ‰é’®ç§»åˆ°å³ä¸Šè§’ -->
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="settingsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="border-radius: 8px; padding: 0.4rem 0.6rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); transition: all 0.3s ease;">
                            <i class="fas fa-cog" style="font-size: 0.8rem;"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="settingsDropdown" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 50%, rgba(240, 147, 251, 0.95) 100%); border: 1px solid rgba(255,255,255,0.2); min-width: 200px; box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 20px rgba(102, 126, 234, 0.3); border-radius: 12px; backdrop-filter: blur(15px); margin-top: 8px;">
                            <h6 class="dropdown-header" style="color: #fff; border-bottom: 1px solid #333;" data-translate="éŸ³ä¹æ§åˆ¶">éŸ³ä¹æ§åˆ¶</h6>
                            <a class="dropdown-item" href="#" onclick="toggleMusic(); return false;" style="color: white;">
                                <i class="fas fa-music"></i> <span data-translate="æ’­æ”¾/æš‚åœéŸ³ä¹">æ’­æ”¾/æš‚åœéŸ³ä¹</span>
                            </a>
                            <a class="dropdown-item" href="#" onclick="nextSong(); return false;" style="color: white;">
                                <i class="fas fa-forward"></i> <span data-translate="ä¸‹ä¸€é¦–æ­Œæ›²">ä¸‹ä¸€é¦–æ­Œæ›²</span>
                            </a>
                            <a class="dropdown-item" href="#" onclick="toggleMusicInfo(); return false;" style="color: white;">
                                <i class="fas fa-info-circle"></i> <span data-translate="æ˜¾ç¤º/éšè—éŸ³ä¹ä¿¡æ¯">æ˜¾ç¤º/éšè—éŸ³ä¹ä¿¡æ¯</span>
                            </a>
                            <div class="dropdown-divider" style="border-color: #333;"></div>
                            <h6 class="dropdown-header" style="color: #fff; border-bottom: 1px solid #333;" data-translate="ç³»ç»Ÿè®¾ç½®">ç³»ç»Ÿè®¾ç½®</h6>
                            {% if user.is_authenticated %}
                            <a class="dropdown-item" href="#" onclick="showSuggestions(); return false;" style="color: white;">
                                <i class="fas fa-lightbulb"></i> <span data-translate="æˆ‘çš„å»ºè®®">æˆ‘çš„å»ºè®®</span>
                            </a>
                            <a class="dropdown-item" href="#" onclick="showFeedback(); return false;" style="color: white;">
                                <i class="fas fa-comment"></i> <span data-translate="æ„è§åé¦ˆ">æ„è§åé¦ˆ</span>
                            </a>
                            {% else %}
                            <a class="dropdown-item" href="{% url 'users:login' %}" style="color: white;">
                                <i class="fas fa-sign-in-alt"></i> <span data-translate="ç™»å½•ååé¦ˆ">ç™»å½•ååé¦ˆ</span>
                            </a>
                            {% endif %}
                            <div class="dropdown-divider" style="border-color: #333;"></div>
                            <h6 class="dropdown-header" style="color: #fff; border-bottom: 1px solid #333;" data-translate="è¯­è¨€è®¾ç½®">è¯­è¨€è®¾ç½®</h6>
                            <a class="dropdown-item language-switch" href="#" data-lang="zh" style="color: white;">
                                <i class="fas fa-language" style="color: #4CAF50;"></i> <span data-translate="ä¸­æ–‡">ä¸­æ–‡</span>
                                <span class="language-indicator" id="zh-indicator" style="float: right; color: #4CAF50; display: inline;">âœ“</span>
                            </a>
                            <a class="dropdown-item language-switch" href="#" data-lang="en" style="color: white;">
                                <i class="fas fa-language" style="color: #2196F3;"></i> <span data-translate="English">English</span>
                                <span class="language-indicator" id="en-indicator" style="float: right; color: #2196F3; display: none;">âœ“</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </nav>
    </header>



    <div class="container">
        <div class="content-block">
            {% block content %}
            <!-- å®¹å™¨å†…å®¹åŒº -->
            {% endblock %}
        </div>
    </div>


    


    <style>
        /* å¾®ä¿¡äºŒç»´ç å¼¹çª—æ ·å¼ */
        .wechat-modal {
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .wechat-modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            position: relative;
            max-width: 300px;
            width: 90%;
        }
        
        .wechat-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .wechat-close:hover {
            color: #333;
        }
        
        .qr-code-placeholder {
            margin-top: 20px;
        }
        
        .qr-code-placeholder p {
            margin-top: 10px;
            color: #666;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        

        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* æ”¹è¿›çš„æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        .geek-file-upload {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .geek-file-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 231, 0.3);
        }
        
        .geek-file-upload .upload-text {
            color: #ffffff !important;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            font-weight: 600;
        }
        
        .geek-file-upload .upload-hint {
            color: #cccccc !important;
            text-shadow: 0 0 3px rgba(204, 204, 204, 0.3);
        }
        
        .geek-file-upload .upload-icon {
            color: #00ffe7 !important;
            text-shadow: 0 0 10px rgba(0, 255, 231, 0.5);
        }
        
        /* å¤§æŒ‰é’®æ ·å¼ */
        .large-upload-btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 12px 30px rgba(0, 255, 231, 0.4) !important;
            border-color: rgba(0, 255, 231, 0.8) !important;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(0, 255, 231, 0.2) 100%) !important;
        }
        
        .large-upload-btn:hover .upload-icon {
            transform: scale(1.1);
            transition: transform 0.3s ease;
        }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸåŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #filePreviewArea {
            animation: fadeIn 0.3s ease;
        }
        
        /* æ–‡ä»¶é¢„è§ˆé¡¹åŠ¨ç”» */
        #imagePreviewContainer > div,
        #videoPreviewContainer > div {
            animation: fadeIn 0.3s ease;
        }
        
        /* Tabåˆ‡æ¢åŠ¨ç”» */
        #tab-content-existing,
        #tab-content-new {
            animation: fadeIn 0.3s ease;
        }
        
        /* TabæŒ‰é’®æ‚¬åœæ•ˆæœ */
        #tab-existing:hover,
        #tab-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 231, 0.3);
        }
        
        /* æ–‡ä»¶é¢„è§ˆåŒºåŸŸæ ·å¼ */
        #filePreviewArea {
            background: linear-gradient(135deg, rgba(26,31,46,0.8) 0%, rgba(0,255,231,0.05) 100%);
            border: 1px solid rgba(0, 255, 231, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        /* å›¾ç‰‡é¢„è§ˆæ ·å¼ */
        #imagePreviewContainer img {
            transition: all 0.3s ease;
        }
        
        #imagePreviewContainer img:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 255, 231, 0.4);
        }
        
        /* è§†é¢‘é¢„è§ˆæ ·å¼ */
        #videoPreviewContainer video {
            transition: all 0.3s ease;
        }
        
        #videoPreviewContainer video:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
        }
        
        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .file-remove-btn {
            transition: all 0.3s ease;
        }
        
        .file-remove-btn:hover {
            background: rgba(255, 0, 0, 1) !important;
            transform: scale(1.1);
        }
        
        /* æ–‡ä»¶åˆ—è¡¨é¡¹æ ·å¼ */
        #fileListContainer > div {
            transition: all 0.3s ease;
        }
        
        #fileListContainer > div:hover {
            background: rgba(0, 255, 231, 0.1) !important;
            border-color: rgba(0, 255, 231, 0.5) !important;
        }

    </style>
    <!-- CDNå›é€€å¤„ç† -->
    <script>
        // ===============================
        // æ ¸å¿ƒå·¥å…·å‡½æ•°åŒºåŸŸ - ç”¨äºç®€åŒ–å‰ç«¯è°ƒæ•´
        // ===============================
        
        // å¯¼èˆªæ æ ·å¼ä¼˜åŒ–å‡½æ•° - è½»é‡çº§ç¾åŒ–
        window.enhanceNavbar = function() {
            const navbar = document.querySelector('.navbar');
            if (navbar) {
                // æ·»åŠ å¿…è¦çš„ç±»ï¼Œä½†ä¸å¼ºåˆ¶è¦†ç›–æ ·å¼
                if (!navbar.classList.contains('unified-navbar')) {
                    navbar.classList.add('unified-navbar');
                }
                console.log('âœ… å¯¼èˆªæ å·²ä¼˜åŒ–');
            }
        };
        
        // æ§åˆ¶é¦–é¡µå¯¼èˆªæ æ˜¾ç¤ºå‡½æ•°
        window.controlHomePageNavbar = function() {
            const currentPath = window.location.pathname;
            const navbar = document.querySelector('.navbar');
            const navbarNav = document.querySelector('.navbar-nav');
            
            if (currentPath === '/' || currentPath === '') {
                // é¦–é¡µï¼šæ­£å¸¸æ˜¾ç¤ºèœå•ï¼Œéšè—æç¤º
                if (navbarNav) {
                    navbarNav.style.setProperty('opacity', '1', 'important');
                    navbarNav.style.setProperty('visibility', 'visible', 'important');
                    navbarNav.style.setProperty('transform', 'none', 'important');
                    navbarNav.style.setProperty('pointer-events', 'auto', 'important');
                    navbarNav.style.setProperty('transition', 'none', 'important');
                }
                if (navbar) {
                    // éšè—æç¤ºç¬¦
                    const style = document.createElement('style');
                    style.textContent = '.navbar::after { display: none !important; }';
                    document.head.appendChild(style);
                }
            }
        };
        
        // å®‰å…¨çš„å‡½æ•°è°ƒç”¨åŒ…è£…å™¨
        window.safeCall = function(funcName, ...args) {
            if (typeof window[funcName] === 'function') {
                return window[funcName](...args);
            } else {
                console.warn(`å‡½æ•° ${funcName} æœªå®šä¹‰ï¼Œè·³è¿‡è°ƒç”¨`);
                return null;
            }
        };
        
        // ===============================
        // ç®€åŒ–ä¸»é¢˜ç®¡ç†å™¨ - æ˜“äºè°ƒæ•´
        // ===============================
        window.themeManager = {
            themes: {
                'geek': { name: 'æå®¢', navbar: 'geek-navbar' },
                'life': { name: 'ç”Ÿæ´»', navbar: 'life-navbar' },
                'emo': { name: 'EMO', navbar: 'emo-navbar' }, 
                'cyberpunk': { name: 'èµ›åšæœ‹å…‹', navbar: 'cyber-navbar' },
                'punk': { name: 'æœ‹å…‹', navbar: 'punk-nav' }
            },
            
            // åº”ç”¨ä¸»é¢˜æ ·å¼
            applyTheme: function(themeName) {
                const body = document.body;
                const navbar = document.querySelector('.navbar');
                
                // æ¸…é™¤æ‰€æœ‰ä¸»é¢˜ç±»
                Object.values(this.themes).forEach(theme => {
                    body.classList.remove(`${themeName}-theme`);
                    if (navbar) navbar.classList.remove(theme.navbar);
                });
                
                // åº”ç”¨æ–°ä¸»é¢˜
                if (this.themes[themeName]) {
                    body.classList.add(`${themeName}-theme`);
                    if (navbar) navbar.classList.add(this.themes[themeName].navbar);
                    
                    // è½»é‡çº§å¯¼èˆªæ ä¼˜åŒ–
                    setTimeout(() => window.safeCall('enhanceNavbar'), 50);
                    
                    console.log(`âœ… ä¸»é¢˜å·²åˆ‡æ¢åˆ°: ${this.themes[themeName].name}`);
                    return true;
                }
                return false;
            },
            
            // è·å–å½“å‰ä¸»é¢˜
            getCurrentTheme: function() {
                for (let theme in this.themes) {
                    if (document.body.classList.contains(`${theme}-theme`)) {
                        return theme;
                    }
                }
                return 'geek'; // é»˜è®¤ä¸»é¢˜
            }
        };
        
        // ===============================
        // ç®€åŒ–UIè°ƒæ•´å·¥å…·
        // ===============================
        window.uiUtils = {
            // æ˜¾ç¤ºé€šçŸ¥
            notify: function(message, type = 'info') {
                if (typeof showNotification === 'function') {
                    showNotification(message, type);
                } else {
                    console.log(`[${type.toUpperCase()}] ${message}`);
                }
            },
            
            // åˆ‡æ¢å…ƒç´ æ˜¾ç¤º
            toggle: function(selector) {
                const element = document.querySelector(selector);
                if (element) {
                    element.style.display = element.style.display === 'none' ? '' : 'none';
                }
            },
            
            // å®‰å…¨è®¾ç½®æ ·å¼
            setStyle: function(selector, property, value, important = true) {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    el.style.setProperty(property, value, important ? 'important' : '');
                });
            }
        };
        
        // ç®€å•çš„CDNå›é€€å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥Bootstrap CSSæ˜¯å¦åŠ è½½å¤±è´¥
            const bootstrapLinks = document.querySelectorAll('link[href*="bootstrap"]');
            if (bootstrapLinks.length === 0) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css';
                link.onerror = function() {
                    this.href = 'https://unpkg.com/bootstrap@4.5.2/dist/css/bootstrap.min.css';
                };
                document.head.appendChild(link);
            }
            
            // æ£€æŸ¥Font Awesomeæ˜¯å¦åŠ è½½å¤±è´¥
            const faLinks = document.querySelectorAll('link[href*="font-awesome"]');
            if (faLinks.length === 0) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css';
                link.onerror = function() {
                    this.href = 'https://unpkg.com/@fortawesome/fontawesome-free@5.15.4/css/all.min.css';
                };
                document.head.appendChild(link);
            }
            
            // æ£€æŸ¥JavaScriptä¾èµ– - ç¡®ä¿æ­£ç¡®çš„åŠ è½½é¡ºåº
            function loadScript(src, fallbackSrc, callback) {
                const script = document.createElement('script');
                script.src = src;
                script.onerror = function() {
                    this.src = fallbackSrc;
                };
                script.onload = callback;
                document.head.appendChild(script);
            }
            
            // æŒ‰é¡ºåºåŠ è½½ä¾èµ–
            if (!window.jQuery) {
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.slim.min.js',
                    'https://unpkg.com/jquery@3.5.1/dist/jquery.slim.min.js',
                    function() {
                        // jQueryåŠ è½½å®ŒæˆååŠ è½½Popper
                        if (!window.Popper) {
                            loadScript(
                                'https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js',
                                'https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js',
                                function() {
                                    // PopperåŠ è½½å®ŒæˆååŠ è½½Bootstrap
                                    if (!window.bootstrap) {
                                        loadScript(
                                            'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                                            'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                                        );
                                    }
                                }
                            );
                        } else if (!window.bootstrap) {
                            // å¦‚æœPopperå·²å­˜åœ¨ï¼Œç›´æ¥åŠ è½½Bootstrap
                            loadScript(
                                'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                                'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                            );
                        }
                    }
                );
            } else if (!window.Popper) {
                // å¦‚æœjQueryå·²å­˜åœ¨ï¼ŒåŠ è½½Popper
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js',
                    'https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js',
                    function() {
                        if (!window.bootstrap) {
                            loadScript(
                                'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                                'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                            );
                        }
                    }
                );
            } else if (!window.bootstrap) {
                // å¦‚æœjQueryå’ŒPopperéƒ½å·²å­˜åœ¨ï¼ŒåªåŠ è½½Bootstrap
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                    'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                );
            }
            
            // åˆå§‹åŒ–æ™ºèƒ½è‰²è°ƒè°ƒæ•´
            setTimeout(() => {
                // detectAndAdjustTopBarTone(); // å·²ç¦ç”¨ï¼Œä½¿ç”¨é€æ˜èƒŒæ™¯
            }, 1000);
            
            // æ¢å¤ä¿å­˜çš„ä¸»é¢˜
            const savedTheme = localStorage.getItem('currentTheme');
            if (savedTheme) {
                switchTheme(savedTheme);
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„ä¸»é¢˜ï¼Œåº”ç”¨é»˜è®¤ä¸»é¢˜çš„æŒ‰é’®é¢œè‰²
                const defaultThemeColors = {
                    about: 'linear-gradient(135deg, rgba(52, 152, 219, 0.9), rgba(41, 128, 185, 0.9))',
                    settings: 'linear-gradient(135deg, rgba(155, 89, 182, 0.9), rgba(142, 68, 173, 0.9))',
                    menu: 'rgba(255, 255, 255, 0.9)',
                    hide: 'linear-gradient(135deg, rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.9))'
                };
                updateButtonColors(defaultThemeColors);
            }
        });
    </script>

    <script>
        // ç½‘æ˜“äº‘éŸ³ä¹é…ç½®
        let currentSong = null;
        let isMusicPlaying = false;
        let musicInfoVisible = false;
        
        // ä¸»é¢˜éŸ³ä¹é…ç½®
        const themeMusic = {
            'life': '/static/audio/friday.mp3',
            'work': '/static/audio/keshi - 2 soon.flac',
            'training': '/static/audio/Eternxlkz - SLAY!.flac',
            'emo': '/static/audio/keshi - 2 soon.flac'
        };
        
        // ä¸åŒæ¨¡å¼å¯¹åº”çš„æ­Œå•
        const modePlaylists = {
            'life': '14069178141',      // ç”Ÿæ´»æ¨¡å¼æ­Œå•
            'work': '13437758534',      // Geekæ¨¡å¼æ­Œå•
            'training': '9357916462',   // ç‹‚æš´æ¨¡å¼æ­Œå•
            'emo': '12632193394'        // Emoæ¨¡å¼æ­Œå•
        };

        window.onload = function () {
            // ä»…åœ¨ç”¨æˆ·ç™»å½•ä¸”æ˜¯ home é¡µæ—¶æ˜¾ç¤ºå…¬å‘Šå¼¹çª—
            {% if request.path == '/' %}
                {% if user.is_authenticated %}
                loadAnnouncements();
                {% endif %}
            {% endif %}
            
            // åˆå§‹åŒ–ä¸»é¢˜éŸ³ä¹
            loadUserTheme();
            
            // æ»šåŠ¨æ€§èƒ½ä¼˜åŒ–
            initScrollOptimization();
        };
    
    // éšè—ä¿¡æ¯è®¡æ•°å™¨
    let hiddenInfoClickCount = 0;
    let hiddenInfoTimeout;
    
    // æ˜¾ç¤ºéšè—ä¿¡æ¯
    function showHiddenInfo() {
        hiddenInfoClickCount++;
        
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (hiddenInfoTimeout) {
            clearTimeout(hiddenInfoTimeout);
        }
        
        // è®¾ç½®å®šæ—¶å™¨ï¼Œ3ç§’åé‡ç½®è®¡æ•°å™¨
        hiddenInfoTimeout = setTimeout(() => {
            hiddenInfoClickCount = 0;
        }, 3000);
        
        // å¦‚æœç‚¹å‡»äº†ä¸¤æ¬¡ï¼Œæ˜¾ç¤ºéšè—ä¿¡æ¯
        if (hiddenInfoClickCount >= 2) {
            hiddenInfoClickCount = 0;
            showHiddenInfoModal();
        }
    }
    
    // æ˜¾ç¤ºå…³äºå¼¹çª—ï¼ˆç›´æ¥è°ƒç”¨ï¼‰
    function showAboutModal() {
        showHiddenInfoModal();
    }
    
    // åŠ¨æ€è‰²è°ƒæ£€æµ‹å’Œè°ƒæ•´åŠŸèƒ½
    function detectAndAdjustTopBarTone() {
        const body = document.body;
        const computedStyle = window.getComputedStyle(body);
        const backgroundColor = computedStyle.backgroundColor;
        
        // è§£æèƒŒæ™¯è‰²
        const rgb = backgroundColor.match(/\d+/g);
        if (!rgb || rgb.length < 3) return;
        
        const [r, g, b] = rgb.map(Number);
        
        // è®¡ç®—äº®åº¦
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        
        // æ£€æµ‹ä¸»è‰²è°ƒ
        const maxColor = Math.max(r, g, b);
        let dominantColor = 'neutral';
        let colorIntensity = 0;
        
        if (maxColor === r && r > g + 50 && r > b + 50) {
            dominantColor = 'red';
            colorIntensity = r / 255;
        } else if (maxColor === g && g > r + 50 && g > b + 50) {
            dominantColor = 'green';
            colorIntensity = g / 255;
        } else if (maxColor === b && b > r + 50 && b > g + 50) {
            dominantColor = 'blue';
            colorIntensity = b / 255;
        }
        
        // æ ¹æ®èƒŒæ™¯è‰²è°ƒæ•´é¡¶éƒ¨æ ï¼ˆå·²ç¦ç”¨ï¼Œä½¿ç”¨é€æ˜èƒŒæ™¯ï¼‰
        // adjustTopBarColors(brightness, dominantColor, colorIntensity, r, g, b);
    }
    
    // è°ƒæ•´é¡¶éƒ¨æ é¢œè‰²
    function adjustTopBarColors(brightness, dominantColor, colorIntensity, r, g, b) {
        const topUiBar = document.querySelector('.top-ui-bar');
        if (!topUiBar) return;
        
        // æ ¹æ®äº®åº¦å†³å®šæ˜¯æ·±è‰²è¿˜æ˜¯æµ…è‰²ä¸»é¢˜
        const isDark = brightness < 128;
        
        if (isDark) {
            // æ·±è‰²èƒŒæ™¯ - ä½¿ç”¨è¾ƒäº®çš„é¡¶éƒ¨æ 
            const lightR = Math.min(255, r + 100);
            const lightG = Math.min(255, g + 100);
            const lightB = Math.min(255, b + 100);
            
            const topBarBg = `linear-gradient(135deg, rgba(${lightR}, ${lightG}, ${lightB}, 0.9) 0%, rgba(${Math.min(255, lightR + 30)}, ${Math.min(255, lightG + 30)}, ${Math.min(255, lightB + 30)}, 0.9) 100%)`;
            
            topUiBar.style.background = topBarBg;
            topUiBar.style.borderBottom = '2px solid rgba(255, 255, 255, 0.3)';
            topUiBar.style.boxShadow = `0 8px 32px rgba(${lightR}, ${lightG}, ${lightB}, 0.4), 0 0 20px rgba(${lightR}, ${lightG}, ${lightB}, 0.3)`;
            
        } else {
            // æµ…è‰²èƒŒæ™¯ - ä½¿ç”¨è¾ƒæš—çš„é¡¶éƒ¨æ 
            const darkR = Math.max(0, r - 100);
            const darkG = Math.max(0, g - 100);
            const darkB = Math.max(0, b - 100);
            
            const topBarBg = `linear-gradient(135deg, rgba(${darkR}, ${darkG}, ${darkB}, 0.9) 0%, rgba(${Math.max(0, darkR - 30)}, ${Math.max(0, darkG - 30)}, ${Math.max(0, darkB - 30)}, 0.9) 100%)`;
            
            topUiBar.style.background = topBarBg;
            topUiBar.style.borderBottom = '2px solid rgba(0, 0, 0, 0.2)';
            topUiBar.style.boxShadow = `0 8px 32px rgba(${darkR}, ${darkG}, ${darkB}, 0.4), 0 0 20px rgba(${darkR}, ${darkG}, ${darkB}, 0.3)`;
        }
        
        console.log(`ğŸ¨ é¡¶éƒ¨æ è‰²è°ƒå·²è°ƒæ•´ä¸º: ${isDark ? 'æ·±è‰²èƒŒæ™¯' : 'æµ…è‰²èƒŒæ™¯'}, ä¸»è‰²è°ƒ: ${dominantColor}`);
    }
    
    // åˆ‡æ¢ä¸»é¢˜æ¨¡å¼
    function switchTheme(theme) {
        // å…³é—­è®¾ç½®å¼¹çª—
        closeSettingsModal();
        
        // ä¸»é¢˜åç§°æ˜ å°„
        const themeNames = {
            'work': 'æå®¢æ¨¡å¼',
            'life': 'ç”Ÿæ´»æ¨¡å¼',
            'training': 'ç‹‚æš´æ¨¡å¼',
            'emo': 'Emoæ¨¡å¼'
        };
        
        // ä¸»é¢˜é¡µé¢æ˜ å°„
        const themePages = {
            'work': '/tools/work_mode/',
            'life': '/tools/life_mode/',
            'training': '/tools/training_mode/',
            'emo': '/tools/emo_mode/'
        };
        
        // æ›´æ–°é¡¶éƒ¨æ çš„ä¸»é¢˜æ ‡è¯†
        const aboutButton = document.getElementById('aboutButton');
        if (aboutButton) {
            aboutButton.querySelector('span').textContent = themeNames[theme] || 'å…³äº';
        }
        
        // æ ¹æ®ä¸»é¢˜è®¾ç½®é¡µé¢æ ·å¼
        const body = document.body;
        const topUiBar = document.querySelector('.top-ui-bar');
        
        // ç§»é™¤ä¹‹å‰çš„ä¸»é¢˜ç±»
        body.classList.remove('theme-work', 'theme-life', 'theme-training', 'theme-emo');
        
        // æ·»åŠ æ–°ä¸»é¢˜ç±»
        body.classList.add(`theme-${theme}`);
        
        // è®¾ç½®ä¸»é¢˜ç‰¹å®šçš„æ ·å¼
        const themeStyles = {
            'work': {
                background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)',
                topBarBg: 'linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(22, 33, 62, 0.9) 50%, rgba(15, 52, 96, 0.9) 100%)',
                color: '#e8e8e8',
                buttonColors: {
                    about: 'linear-gradient(135deg, rgba(52, 152, 219, 0.9), rgba(41, 128, 185, 0.9))',
                    settings: 'linear-gradient(135deg, rgba(155, 89, 182, 0.9), rgba(142, 68, 173, 0.9))',
                    menu: 'rgba(255, 255, 255, 0.9)',
                    hide: 'linear-gradient(135deg, rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.9))'
                }
            },
            'life': {
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                topBarBg: 'linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%)',
                color: '#ffffff',
                buttonColors: {
                    about: 'linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9))',
                    settings: 'linear-gradient(135deg, rgba(155, 89, 182, 0.9), rgba(142, 68, 173, 0.9))',
                    menu: 'rgba(255, 255, 255, 0.9)',
                    hide: 'linear-gradient(135deg, rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.9))'
                }
            },
            'training': {
                background: 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff3838 100%)',
                topBarBg: 'linear-gradient(135deg, rgba(255, 107, 107, 0.9) 0%, rgba(238, 90, 36, 0.9) 50%, rgba(255, 56, 56, 0.9) 100%)',
                color: '#ffffff',
                buttonColors: {
                    about: 'linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(238, 90, 36, 0.9))',
                    settings: 'linear-gradient(135deg, rgba(255, 56, 56, 0.9), rgba(192, 57, 43, 0.9))',
                    menu: 'rgba(255, 255, 255, 0.9)',
                    hide: 'linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(128, 0, 0, 0.9))'
                }
            },
            'emo': {
                background: 'linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #7f8c8d 100%)',
                topBarBg: 'linear-gradient(135deg, rgba(44, 62, 80, 0.9) 0%, rgba(52, 73, 94, 0.9) 50%, rgba(127, 140, 141, 0.9) 100%)',
                color: '#ecf0f1',
                buttonColors: {
                    about: 'linear-gradient(135deg, rgba(44, 62, 80, 0.9), rgba(52, 73, 94, 0.9))',
                    settings: 'linear-gradient(135deg, rgba(127, 140, 141, 0.9), rgba(149, 165, 166, 0.9))',
                    menu: 'rgba(255, 255, 255, 0.9)',
                    hide: 'linear-gradient(135deg, rgba(149, 165, 166, 0.9), rgba(127, 140, 141, 0.9))'
                }
            }
        };
        
        const style = themeStyles[theme];
        if (style) {
            // åº”ç”¨ä¸»é¢˜æ ·å¼
            body.style.background = style.background;
            body.style.color = style.color;
            
            if (topUiBar) {
                // ä¿æŒé€æ˜èƒŒæ™¯ï¼Œä¸è¦†ç›–
                // topUiBar.style.background = style.topBarBg;
            }
            
            // æ›´æ–°æŒ‰é’®é¢œè‰²
            updateButtonColors(style.buttonColors);
            
            // ä¿å­˜ä¸»é¢˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('currentTheme', theme);
            
            // æ˜¾ç¤ºä¸»é¢˜åˆ‡æ¢é€šçŸ¥
            showThemeNotification(themeNames[theme] || theme);
            
            console.log(`ğŸ¨ å·²åˆ‡æ¢åˆ°${themeNames[theme] || theme}ä¸»é¢˜`);
            
            // è·³è½¬åˆ°å¯¹åº”çš„ä¸»é¢˜é¡µé¢
            const targetPage = themePages[theme];
            if (targetPage) {
                console.log(`å‡†å¤‡è·³è½¬åˆ°: ${targetPage}`);
                // æ·»åŠ å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°åˆ‡æ¢æ•ˆæœ
                setTimeout(() => {
                    window.location.href = targetPage;
                }, 500);
            } else {
                console.log(`æœªæ‰¾åˆ°ä¸»é¢˜é¡µé¢: ${theme}`);
            }
        }
    }
    
    // å­˜å‚¨éšè—å®šæ—¶å™¨
    let hideDropdownTimer = null;
    
    // æ˜¾ç¤ºç”¨æˆ·ä¸‹æ‹‰èœå•
    function showUserDropdown() {
        console.log('ğŸ”§ showUserDropdown è¢«è°ƒç”¨');
        
        // æ¸…é™¤éšè—å®šæ—¶å™¨
        if (hideDropdownTimer) {
            clearTimeout(hideDropdownTimer);
            hideDropdownTimer = null;
            console.log('âœ… å·²æ¸…é™¤éšè—å®šæ—¶å™¨');
        }
        
        const dropdownContent = document.getElementById('userDropdownContent');
        const chevronIcon = document.querySelector('.top-ui-user .fa-chevron-down');
        
        if (!dropdownContent) {
            console.error('âŒ ç”¨æˆ·ä¸‹æ‹‰èœå•å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        
        console.log('ğŸ’¡ æ­£åœ¨æ˜¾ç¤ºèœå•');
        
        // æ˜¾ç¤ºèœå•
        dropdownContent.style.display = 'block';
        dropdownContent.style.opacity = '1';
        dropdownContent.style.transform = 'scale(1) translateY(0)';
        dropdownContent.classList.add('show');
        
        if (chevronIcon) {
            chevronIcon.style.transform = 'rotate(180deg)';
        }
        
        console.log('âœ… èœå•å·²æ˜¾ç¤º');
    }
    
    // å»¶è¿Ÿéšè—ç”¨æˆ·ä¸‹æ‹‰èœå•
    function hideUserDropdownDelayed() {
        console.log('ğŸ”§ hideUserDropdownDelayed è¢«è°ƒç”¨');
        
        // è®¾ç½®å»¶è¿Ÿéšè—å®šæ—¶å™¨
        hideDropdownTimer = setTimeout(() => {
            hideUserDropdown();
        }, 300); // 300mså»¶è¿Ÿï¼Œç»™ç”¨æˆ·æ—¶é—´ç§»åŠ¨é¼ æ ‡
        
        console.log('â° å·²è®¾ç½®300mså»¶è¿Ÿéšè—å®šæ—¶å™¨');
    }
    
    // ç«‹å³éšè—ç”¨æˆ·ä¸‹æ‹‰èœå•
    function hideUserDropdown() {
        console.log('ğŸ”§ hideUserDropdown è¢«è°ƒç”¨');
        
        const dropdownContent = document.getElementById('userDropdownContent');
        const chevronIcon = document.querySelector('.top-ui-user .fa-chevron-down');
        
        if (!dropdownContent) {
            console.error('âŒ ç”¨æˆ·ä¸‹æ‹‰èœå•å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        
        console.log('ğŸ’¡ æ­£åœ¨éšè—èœå•');
        
        // éšè—èœå•
        dropdownContent.style.display = 'none';
        dropdownContent.style.opacity = '0';
        dropdownContent.style.transform = 'scale(0.95) translateY(-10px)';
        dropdownContent.classList.remove('show');
        
        if (chevronIcon) {
            chevronIcon.style.transform = 'rotate(0deg)';
        }
        
        console.log('âœ… èœå•å·²éšè—');
    }
    
    // ä¿ç•™åŸæ¥çš„åˆ‡æ¢å‡½æ•°ç”¨äºè°ƒè¯•
    function toggleUserDropdown() {
        const dropdownContent = document.getElementById('userDropdownContent');
        
        if (!dropdownContent) {
            console.error('ç”¨æˆ·ä¸‹æ‹‰èœå•å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        
        const isVisible = dropdownContent.style.display === 'block' && 
                         dropdownContent.style.opacity !== '0' &&
                         !dropdownContent.classList.contains('hidden');
        
        if (isVisible) {
            hideUserDropdown();
        } else {
            showUserDropdown();
        }
    }
    
    // ç”±äºç°åœ¨ä½¿ç”¨æ‚¬æµ®è§¦å‘ï¼Œä¸å†éœ€è¦ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•çš„åŠŸèƒ½å·²è¢«æ‚¬æµ®è§¦å‘æœºåˆ¶å–ä»£
    
    // æ›´æ–°æŒ‰é’®é¢œè‰²
    function updateButtonColors(colors) {
        const aboutButton = document.getElementById('aboutButton');
        const settingsButton = document.querySelector('[onclick="showSettings()"]');
        const menuButton = document.querySelector('[onclick="toggleMobileMenu()"]');
        const hideButton = document.querySelector('[onclick="hideTopUI()"]');
        
        if (aboutButton && colors.about) {
            aboutButton.style.background = 'transparent !important';
            aboutButton.style.border = 'none !important';
            aboutButton.style.boxShadow = 'none !important';
            const aboutIcon = aboutButton.querySelector('.fas');
            if (aboutIcon) {
                aboutIcon.style.textShadow = '0 0 20px rgba(52, 152, 219, 0.8), 0 0 40px rgba(52, 152, 219, 0.6) !important';
                aboutIcon.style.filter = 'drop-shadow(0 0 10px rgba(52, 152, 219, 0.8)) !important';
            }
        }
        
        if (settingsButton && colors.settings) {
            settingsButton.style.background = 'transparent !important';
            settingsButton.style.border = 'none !important';
            settingsButton.style.boxShadow = 'none !important';
            const settingsIcon = settingsButton.querySelector('.fas');
            if (settingsIcon) {
                settingsIcon.style.textShadow = '0 0 20px rgba(155, 89, 182, 0.8), 0 0 40px rgba(155, 89, 182, 0.6) !important';
                settingsIcon.style.filter = 'drop-shadow(0 0 10px rgba(155, 89, 182, 0.8)) !important';
            }
        }
        
        if (menuButton && colors.menu) {
            menuButton.style.background = 'transparent !important';
            menuButton.style.border = 'none !important';
            menuButton.style.boxShadow = 'none !important';
            const menuIcon = menuButton.querySelector('.fas');
            if (menuIcon) {
                menuIcon.style.textShadow = '0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.6) !important';
                menuIcon.style.filter = 'drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)) !important';
            }
        }
        
        if (hideButton && colors.hide) {
            hideButton.style.background = 'transparent !important';
            hideButton.style.border = 'none !important';
            hideButton.style.boxShadow = 'none !important';
            const hideIcon = hideButton.querySelector('.fas');
            if (hideIcon) {
                hideIcon.style.textShadow = '0 0 20px rgba(231, 76, 60, 0.8), 0 0 40px rgba(231, 76, 60, 0.6) !important';
                hideIcon.style.filter = 'drop-shadow(0 0 10px rgba(231, 76, 60, 0.8)) !important';
            }
        }
    }
    
    // æ˜¾ç¤ºä¸»é¢˜åˆ‡æ¢é€šçŸ¥
    function showThemeNotification(themeName) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        `;
        notification.textContent = `ğŸ¨ å·²åˆ‡æ¢åˆ°${themeName}`;
        
        document.body.appendChild(notification);
        
        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        // è‡ªåŠ¨éšè—
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    // æ˜¾ç¤ºéšè—ä¿¡æ¯å¼¹çª—
    function showHiddenInfoModal() {
        const modalHtml = `
            <div id="hiddenInfoModal" class="wechat-modal" style="display: flex;">
                <div class="wechat-modal-content" style="max-width: 600px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <span class="wechat-close" onclick="closeHiddenInfoModal()" style="color: white; font-size: 28px;">&times;</span>
                    
                    <!-- åŠ¨æ€æ ‡é¢˜ -->
                    <div style="text-align: center; margin-bottom: 25px; position: relative;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            <i class="fas fa-rocket" style="margin-right: 10px; animation: bounce 2s infinite;"></i>
                            å…³äºæˆ‘
                            <i class="fas fa-rocket" style="margin-left: 10px; animation: bounce 2s infinite 1s;"></i>
                        </h2>
                        <div style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 60px; height: 3px; background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1); border-radius: 2px;"></div>
                    </div>
                    
                    <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
                    <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; margin-bottom: 25px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">
                        <h3 style="margin: 0 0 8px 0; font-size: 22px; font-weight: bold;">é«˜æ°</h3>
                        <p style="margin: 0; opacity: 0.9; font-size: 16px;">AIä½¿ç”¨è€…</p>
                    </div>
                    
                    <!-- è”ç³»ä¿¡æ¯ç½‘æ ¼ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <!-- å¾®ä¿¡äºŒç»´ç  -->
                        <div style="text-align: center; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <h4 style="color: #00C800; margin-bottom: 15px; font-size: 18px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                <i class="fab fa-weixin" style="margin-right: 8px;"></i> å¾®ä¿¡è”ç³»
                            </h4>
                            <div style="width: 130px; height: 130px; border: 3px solid #00C800; border-radius: 12px; background: white; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 20px rgba(0,0,0,0.2); overflow: hidden;">
                                <img src="/media/vx.jpg" alt="å¾®ä¿¡äºŒç»´ç " style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                            </div>
                            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 10px;">æ‰«ä¸€æ‰«åŠ æˆ‘ä¸ºæœ‹å‹</p>
                        </div>
                        
                        <!-- ç®€å†ä¸‹è½½ -->
                        <div style="text-align: center; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <h4 style="color: #4ecdc4; margin-bottom: 15px; font-size: 18px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                <i class="fas fa-file-pdf" style="margin-right: 8px;"></i> ä¸ªäººç®€å†
                            </h4>
                            <div style="width: 130px; height: 130px; border: 3px solid #4ecdc4; border-radius: 12px; background: linear-gradient(135deg, #4ecdc4, #44a08d); display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 20px rgba(0,0,0,0.2); position: relative; overflow: hidden;">
                                <i class="fas fa-download" style="color: white; font-size: 40px; z-index: 2;"></i>
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%); animation: shine 2s infinite;"></div>
                            </div>
                            <a href="/media/é«˜æ°-æµ‹è¯•å·¥ç¨‹å¸ˆ.pdf" target="_blank" 
                               style="display: inline-block; margin-top: 12px; padding: 10px 20px; background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; text-decoration: none; border-radius: 25px; font-size: 14px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-download" style="margin-right: 8px;"></i> ä¸‹è½½ç®€å†
                            </a>
                        </div>
                    </div>
                    
                    <!-- æ›´å¤šé“¾æ¥ -->
                    <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.2);">
                        <h4 style="color: white; margin-bottom: 20px; font-size: 18px; text-align: center; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                            <i class="fas fa-link" style="margin-right: 8px;"></i> æ›´å¤šé“¾æ¥
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <a href="https://github.com/shinytsing/QAToolbox" target="_blank" 
                               style="display: flex; align-items: center; padding: 15px; background: linear-gradient(135deg, #333, #555); color: white; text-decoration: none; border-radius: 12px; transition: all 0.3s ease; font-size: 14px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fab fa-github" style="margin-right: 10px; font-size: 20px;"></i>
                                GitHub æºç 
                            </a>
                            <a href="https://music.163.com/#/user/home?id=555356040" target="_blank" 
                               style="display: flex; align-items: center; padding: 15px; background: linear-gradient(135deg, #ff2442, #ff6b6b); color: white; text-decoration: none; border-radius: 12px; transition: all 0.3s ease; font-size: 14px; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 36, 66, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fab fa-music" style="margin-right: 10px; font-size: 20px;"></i>
                                ç½‘æ˜“äº‘éŸ³ä¹
                            </a>
                            <a href="https://humanbenchmark.com/dashboard" target="_blank" 
                               style="display: flex; align-items: center; padding: 15px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; text-decoration: none; border-radius: 12px; transition: all 0.3s ease; font-size: 14px; font-weight: bold; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-brain" style="margin-right: 10px; font-size: 20px;"></i>
                                Human Benchmark
                            </a>
                        </div>
                    </div>
                    

                    <!-- AI Link -->
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 15px; border: 1px solid rgba(255,255,255,0.2);">
                        <h4 style="color: white; margin-bottom: 15px; font-size: 16px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                            <i class="fas fa-link" style="margin-right: 8px;"></i> AI Link
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #ff6b6b; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">AI</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">æ™ºèƒ½åŠ©æ‰‹</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #4ecdc4; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Link</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">å‹æƒ…é“¾æ¥</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #45b7d1; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">âˆ</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">æ— é™å¯èƒ½</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <a href="{% url 'content:ai_links' %}" style="display: inline-block; padding: 8px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 20px; font-size: 14px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                <i class="fas fa-external-link-alt" style="margin-right: 5px;"></i> æŸ¥çœ‹AI Link
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        const modal = document.getElementById('hiddenInfoModal');
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeHiddenInfoModal();
            }
        });
    }
    
    // å…³é—­éšè—ä¿¡æ¯å¼¹çª—
    function closeHiddenInfoModal() {
        const modal = document.getElementById('hiddenInfoModal');
        if (modal) {
            modal.remove();
        }
    }
    
    // æ»šåŠ¨æ€§èƒ½ä¼˜åŒ–å‡½æ•°
    function initScrollOptimization() {
        let isScrolling = false;
        let scrollTimeout;
        
        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        window.addEventListener('scroll', function() {
            if (!isScrolling) {
                // å¼€å§‹æ»šåŠ¨æ—¶æš‚åœåŠ¨ç”»
                pauseAnimations();
                isScrolling = true;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            clearTimeout(scrollTimeout);
            
            // æ»šåŠ¨åœæ­¢åæ¢å¤åŠ¨ç”»
            scrollTimeout = setTimeout(function() {
                resumeAnimations();
                isScrolling = false;
            }, 150); // 150msåæ¢å¤
        }, { passive: true }); // ä½¿ç”¨passiveç›‘å¬å™¨æé«˜æ€§èƒ½
    }
    
    // æš‚åœæ‰€æœ‰åŠ¨ç”»
    function pauseAnimations() {
        const animatedElements = document.querySelectorAll('*');
        animatedElements.forEach(element => {
            const computedStyle = window.getComputedStyle(element);
            if (computedStyle.animationName !== 'none') {
                element.style.animationPlayState = 'paused';
            }
        });
    }
    
    // æ¢å¤æ‰€æœ‰åŠ¨ç”»
    function resumeAnimations() {
        const animatedElements = document.querySelectorAll('*');
        animatedElements.forEach(element => {
            const computedStyle = window.getComputedStyle(element);
            if (computedStyle.animationName !== 'none') {
                element.style.animationPlayState = 'running';
            }
        });
    }
    
    // å…¬å‘Šç›¸å…³å‡½æ•°
    function loadAnnouncements() {
        fetch('/content/api/announcements/')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.announcements.length > 0) {
                    // è¿‡æ»¤å‡ºéœ€è¦å¼¹çª—æ˜¾ç¤ºçš„å…¬å‘Š
                    const popupAnnouncements = data.announcements.filter(a => a.is_popup);
                    if (popupAnnouncements.length > 0) {
                        showAnnouncementPopup(popupAnnouncements);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading announcements:', error);
            });
    }
    
    function showAnnouncementPopup(announcements) {
        const overlay = document.getElementById('announcement-overlay');
        const body = document.getElementById('announcement-body');
        
        if (!overlay || !body) return;
        
        // æ¸²æŸ“å…¬å‘Šå†…å®¹
        let html = '';
        announcements.forEach(announcement => {
            html += `
                <div class="announcement-item priority-${announcement.priority}">
                    <div class="announcement-title">${announcement.title}</div>
                    <div class="announcement-text">${announcement.content}</div>
                    <div class="announcement-time">${announcement.created_at}</div>
                </div>
            `;
        });
        
        body.innerHTML = html;
        
        // æ˜¾ç¤ºå¼¹çª—
        overlay.classList.add('active');
        
        // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(function() {
            closeAnnouncement();
        }, 5000);
    }
    
    function closeAnnouncement() {
        const overlay = document.getElementById('announcement-overlay');
        if (overlay) {
            overlay.classList.remove('active');
        }
    }
        
        // æ·»åŠ ç‚¹å‡»é»‘å¹•å…³é—­å…¬å‘Šçš„åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('announcement-overlay');
            if (overlay) {
                // ç‚¹å‡»é»‘å¹•å…³é—­å…¬å‘Š
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        closeAnnouncement();
                    }
                });
                
                // æ”¯æŒESCé”®å…³é—­
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && overlay.classList.contains('active')) {
                        closeAnnouncement();
                    }
                });
            }
        });
    
    // ç®€åŒ–çš„éŸ³ä¹æ§åˆ¶å‡½æ•°
    function toggleMusic() {
        var audio = document.getElementById('theme-music');
        
        if (audio.paused) {
            audio.play();
            showNotification('éŸ³ä¹å·²å¼€å¯', 'success');
        } else {
            audio.pause();
            showNotification('éŸ³ä¹å·²æš‚åœ', 'info');
        }
    }
    
    // ä¼˜åŒ–çš„ä¸»é¢˜éŸ³ä¹è®¾ç½®å‡½æ•°
    function setThemeMusic(theme) {
        var audio = document.getElementById('theme-music');
        var source = document.getElementById('music-source');
        
        if (themeMusic[theme] && source.src !== themeMusic[theme]) {
            // åªæœ‰åœ¨éŸ³ä¹æ–‡ä»¶ä¸åŒæ—¶æ‰åˆ‡æ¢ï¼Œé¿å…é‡å¤åŠ è½½
            source.src = themeMusic[theme];
            audio.load();
            // å¼‚æ­¥æ’­æ”¾ï¼Œä¸é˜»å¡UI
            setTimeout(() => {
                audio.play().catch(function(error) {
                    console.log('éŸ³ä¹è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', error);
                });
            }, 0);
        }
    }
    
    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            var notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#17a2b8'};
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤é€šçŸ¥
            setTimeout(function() {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
    // æ˜¾ç¤ºä¸Šä¼ è¯¦ç»†ä¿¡æ¯
    function showUploadDetails(uploadInfo) {
            // ç§»é™¤ä¹‹å‰çš„è¯¦ç»†æç¤º
            const existingDetails = document.querySelector('.upload-details-toast');
            if (existingDetails) {
                existingDetails.remove();
            }
            
            // åˆ›å»ºè¯¦ç»†æç¤º
            const detailsToast = document.createElement('div');
            detailsToast.className = 'upload-details-toast';
            detailsToast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #00ffe7 0%, #00b8a9 100%);
                color: #0a0e17;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 255, 231, 0.3);
                z-index: 10001;
                max-width: 350px;
                font-family: 'JetBrains Mono', monospace;
                border: 1px solid rgba(0, 255, 231, 0.3);
            `;
            
            let fileDetailsHtml = '';
            uploadInfo.file_details.forEach(file => {
                const icon = file.type === 'image' ? 'ğŸ–¼ï¸' : 'ğŸ¥';
                fileDetailsHtml += `
                    <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                        <div style="font-weight: 600;">${icon} ${file.name}</div>
                        <div style="font-size: 12px; opacity: 0.8;">å¤§å°: ${file.size}</div>
                    </div>
                `;
            });
            
            detailsToast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: 700; font-size: 14px;">
                        ğŸ“ ä¸Šä¼ è¯¦æƒ…
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 16px; cursor: pointer; color: #0a0e17; opacity: 0.7;">&times;</button>
                </div>
                <div style="font-size: 12px; margin-bottom: 10px;">
                    å…±ä¸Šä¼  ${uploadInfo.total_files} ä¸ªæ–‡ä»¶ | æ—¶é—´: ${uploadInfo.upload_time}
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${fileDetailsHtml}
                </div>
            `;
            
            document.body.appendChild(detailsToast);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (detailsToast.parentElement) {
                    detailsToast.remove();
                }
            }, 5000);
        }
        
        // éŸ³ä¹åˆå§‹åŒ–
        window.addEventListener('load', function() {
            var audio = document.getElementById('theme-music');
            
            // æ·»åŠ éŸ³ä¹çŠ¶æ€ç›‘å¬
            audio.addEventListener('play', function() {
                console.log('ä¸»é¢˜éŸ³ä¹å¼€å§‹æ’­æ”¾');
            });
            
            audio.addEventListener('pause', function() {
                console.log('ä¸»é¢˜éŸ³ä¹å·²æš‚åœ');
            });
        });

    // æ˜¾ç¤ºå»ºè®®ç•Œé¢ - æå®¢é£æ ¼
    function showSuggestions() {
            // å…ˆè·å–ç°æœ‰å»ºè®®
            fetch('/content/api/suggestions/')
                .then(response => response.json())
                .then(data => {
                    let suggestionsHtml = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 14, 23, 0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                            <div style="background: linear-gradient(135deg, rgba(26,31,46,0.95) 0%, rgba(0,255,231,0.1) 100%); border: 1px solid rgba(0, 255, 231, 0.2); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); backdrop-filter: blur(10px); padding: 30px; max-width: 900px; max-height: 85vh; overflow-y: auto; width: 95%; position: relative;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid rgba(0, 255, 231, 0.2); padding-bottom: 15px;">
                                    <h3 style="color: #00ffe7; margin: 0; font-family: 'JetBrains Mono', monospace; font-weight: 700; text-shadow: 0 0 10px rgba(0, 255, 231, 0.5);">
                                        <i class="fas fa-lightbulb" style="color: #00ffe7; margin-right: 10px;"></i> æˆ‘çš„å»ºè®®
                                    </h3>
                                    <button onclick="closeSuggestions()" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #ffffff; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 12px; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px;">
                                        <i class="fas fa-times"></i> å…³é—­
                                    </button>
                                </div>
                                
                                <!-- Tabå¯¼èˆª -->
                                <div style="display: flex; margin-bottom: 25px; border-bottom: 1px solid rgba(0, 255, 231, 0.2);">
                                    <button id="tab-existing" onclick="switchTab('existing')" style="flex: 1; background: linear-gradient(135deg, #00ffe7 0%, #667eea 100%); color: #000; border: none; padding: 15px; font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; border-radius: 8px 8px 0 0; margin-right: 2px;">
                                        <i class="fas fa-list" style="margin-right: 8px;"></i> ç°æœ‰å»ºè®®
                                    </button>
                                    <button id="tab-new" onclick="switchTab('new')" style="flex: 1; background: rgba(26,31,46,0.8); color: #00ffe7; border: 1px solid rgba(0, 255, 231, 0.3); padding: 15px; font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; border-radius: 8px 8px 0 0; margin-left: 2px;">
                                        <i class="fas fa-plus-circle" style="margin-right: 8px;"></i> æ·»åŠ æ–°å»ºè®®
                                    </button>
                                </div>
                                
                                <!-- ç°æœ‰å»ºè®®Tab -->
                                <div id="tab-content-existing" style="display: block;">
                                    <div id="existingSuggestions">`;
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(suggestion => {
                            // æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²
                            let statusColor = '#28a745'; // é»˜è®¤ç»¿è‰²
                            let borderColor = '#28a745';
                            let statusIcon = 'ğŸ“‹';
                            
                            switch(suggestion.status_code) {
                                case 'pending':
                                    statusColor = '#ffc107';
                                    borderColor = '#ffc107';
                                    statusIcon = 'â³';
                                    break;
                                case 'reviewing':
                                    statusColor = '#17a2b8';
                                    borderColor = '#17a2b8';
                                    statusIcon = 'ğŸ‘€';
                                    break;
                                case 'implemented':
                                    statusColor = '#28a745';
                                    borderColor = '#28a745';
                                    statusIcon = 'âœ…';
                                    break;
                                case 'rejected':
                                    statusColor = '#dc3545';
                                    borderColor = '#dc3545';
                                    statusIcon = 'âŒ';
                                    break;
                            }
                            
                            suggestionsHtml += `
                                <div style="background: linear-gradient(135deg, rgba(26,31,46,0.8) 0%, rgba(0,255,231,0.05) 100%); border: 1px solid rgba(0, 255, 231, 0.2); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(5px);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <h6 style="margin: 0; color: #00ffe7; font-family: 'JetBrains Mono', monospace; font-weight: 600; text-shadow: 0 0 5px rgba(0, 255, 231, 0.3);">${suggestion.title}</h6>
                                        <div style="text-align: right;">
                                            <span style="font-size: 12px; color: #667eea; font-family: 'JetBrains Mono', monospace;">${suggestion.created_at}</span>
                                            <br>
                                            <span style="font-size: 11px; color: #764ba2; font-family: 'JetBrains Mono', monospace;">æ›´æ–°: ${suggestion.updated_at}</span>
                                        </div>
                                    </div>
                                    <p style="margin: 0; color: #e6e6e6; margin-bottom: 12px; line-height: 1.6; font-family: 'JetBrains Mono', monospace;">${suggestion.content}</p>
                                    
                                    ${(suggestion.images && suggestion.images.length > 0) || (suggestion.videos && suggestion.videos.length > 0) ? `
                                    <div style="margin-bottom: 10px;">
                                        <small style="color: #00ffe7; font-family: 'JetBrains Mono', monospace;">
                                            <i class="fas fa-paperclip" style="margin-right: 5px;"></i>
                                            ${suggestion.images ? suggestion.images.length : 0} å›¾ç‰‡, 
                                            ${suggestion.videos ? suggestion.videos.length : 0} è§†é¢‘
                                        </small>
                                    </div>
                                    ` : ''}
                                    <div style="display: flex; gap: 12px; font-size: 12px; margin-bottom: 10px; flex-wrap: wrap;">
                                        <span style="color: #667eea; font-family: 'JetBrains Mono', monospace; background: rgba(102, 126, 234, 0.1); padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(102, 126, 234, 0.3);">
                                            <i class="fas fa-code" style="margin-right: 4px;"></i> ç±»å‹: ${suggestion.suggestion_type}
                                        </span>
                                        <span style="color: ${statusColor}; font-weight: bold; font-family: 'JetBrains Mono', monospace; background: rgba(0, 255, 231, 0.1); padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(0, 255, 231, 0.3);">
                                            ${statusIcon} çŠ¶æ€: ${suggestion.status}
                                        </span>
                                        <span style="color: #764ba2; font-family: 'JetBrains Mono', monospace; background: rgba(118, 75, 162, 0.1); padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(118, 75, 162, 0.3);">
                                            <i class="fas fa-user" style="margin-right: 4px;"></i> æäº¤è€…: ${suggestion.user_name}
                                        </span>
                                    </div>
                                    ${suggestion.has_response ? 
                                        '<div style="margin-top: 12px; padding: 15px; background: linear-gradient(135deg, rgba(0, 255, 231, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%); border-radius: 8px; border-left: 4px solid #00ffe7; border: 1px solid rgba(0, 255, 231, 0.3);"><strong style="color: #00ffe7; font-family: \'JetBrains Mono\', monospace;">ç®¡ç†å‘˜å›å¤:</strong><br><span style="color: #e6e6e6; font-family: \'JetBrains Mono\', monospace; line-height: 1.5;">' + suggestion.admin_response + '</span></div>' : 
                                        '<div style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, rgba(118, 75, 162, 0.1) 0%, rgba(0, 255, 231, 0.05) 100%); border-radius: 8px; border: 1px solid rgba(118, 75, 162, 0.3); font-size: 12px; color: #764ba2; text-align: center; font-family: \'JetBrains Mono\', monospace;"><i class="fas fa-clock" style="margin-right: 5px;"></i>ç­‰å¾…ç®¡ç†å‘˜å¤„ç†ä¸­...</div>'
                                    }
                                </div>`;
                        });
                    } else {
                        suggestionsHtml += `<p style="color: #764ba2; text-align: center; font-family: 'JetBrains Mono', monospace; font-size: 14px; padding: 20px; background: linear-gradient(135deg, rgba(118, 75, 162, 0.1) 0%, rgba(0, 255, 231, 0.05) 100%); border-radius: 8px; border: 1px solid rgba(118, 75, 162, 0.3);"><i class="fas fa-inbox" style="margin-right: 8px;"></i>æš‚æ— å»ºè®®</p>`;
                    }
                    
                    suggestionsHtml += `
                                    </div>
                                </div>
                                
                                <!-- æ·»åŠ æ–°å»ºè®®Tab -->
                                <div id="tab-content-new" style="display: none;">
                                    <div style="margin-bottom: 15px;">
                                        <input type="text" id="suggestionTitle" placeholder="å»ºè®®æ ‡é¢˜..." style="width: 100%; padding: 12px; background: rgba(26,31,46,0.8); border: 1px solid rgba(0, 255, 231, 0.3); border-radius: 8px; margin-bottom: 12px; color: #e6e6e6; font-family: 'JetBrains Mono', monospace; transition: all 0.3s ease;">
                                        <select id="suggestionType" style="width: 100%; padding: 12px; background: rgba(26,31,46,0.8); border: 1px solid rgba(0, 255, 231, 0.3); border-radius: 8px; margin-bottom: 12px; color: #e6e6e6; font-family: 'JetBrains Mono', monospace; transition: all 0.3s ease;">
                                            <option value="feature">åŠŸèƒ½å»ºè®®</option>
                                            <option value="ui">ç•Œé¢æ”¹è¿›</option>
                                            <option value="bug">BugæŠ¥å‘Š</option>
                                            <option value="other">å…¶ä»–</option>
                                        </select>
                                        <textarea id="newSuggestion" placeholder="è¯·è¾“å…¥æ‚¨çš„å»ºè®®å†…å®¹..." style="width: 100%; height: 120px; padding: 12px; background: rgba(26,31,46,0.8); border: 1px solid rgba(0, 255, 231, 0.3); border-radius: 8px; resize: vertical; color: #e6e6e6; font-family: 'JetBrains Mono', monospace; transition: all 0.3s ease;"></textarea>
                                        
                                        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                                        <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, rgba(26,31,46,0.6) 0%, rgba(0,255,231,0.05) 100%); border: 1px solid rgba(0, 255, 231, 0.2); border-radius: 10px;">
                                            <h6 style="color: #ffffff; margin-bottom: 12px; font-family: 'JetBrains Mono', monospace; font-weight: 600; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);">
                                                <i class="fas fa-paperclip" style="margin-right: 8px; color: #00ffe7;"></i> æ·»åŠ é™„ä»¶ï¼ˆå¯é€‰ï¼‰
                                            </h6>
                                            <div style="margin-bottom: 20px;">
                                                <div class="geek-file-upload large-upload-btn" onclick="document.getElementById('suggestionImages').click()" style="height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(0, 255, 231, 0.1) 100%); border: 2px dashed rgba(102, 126, 234, 0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                                                    <i class="fas fa-image upload-icon" style="font-size: 1.5rem; color: #667eea; margin-bottom: 5px;"></i>
                                                    <div style="text-align: center;">
                                                        <div style="font-size: 11px; color: #667eea; font-family: 'JetBrains Mono', monospace; margin-bottom: 2px;">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                                                        <div style="font-size: 9px; color: #667eea; font-family: 'JetBrains Mono', monospace;">æœ€å¤š3å¼ å›¾ç‰‡</div>
                                                    </div>
                                                    <input type="file" id="suggestionImages" multiple accept=".jpg,.jpeg,.png,.gif,.webp" style="display: none;">
                                                </div>
                                                <div id="imageStatus" style="text-align: center; margin-top: 5px; font-size: 11px; color: #667eea; font-family: 'JetBrains Mono', monospace;"></div>
                                            </div>
                                            <div style="margin-bottom: 20px;">
                                                <div class="geek-file-upload large-upload-btn" onclick="document.getElementById('suggestionVideos').click()" style="height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(118, 75, 162, 0.2) 0%, rgba(0, 255, 231, 0.1) 100%); border: 2px dashed rgba(118, 75, 162, 0.5); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                                                    <i class="fas fa-video upload-icon" style="font-size: 1.5rem; color: #764ba2; margin-bottom: 5px;"></i>
                                                    <div style="text-align: center;">
                                                        <div style="font-size: 11px; color: #764ba2; font-family: 'JetBrains Mono', monospace; margin-bottom: 2px;">ç‚¹å‡»ä¸Šä¼ è§†é¢‘</div>
                                                        <div style="font-size: 9px; color: #764ba2; font-family: 'JetBrains Mono', monospace;">æœ€å¤š1ä¸ªè§†é¢‘</div>
                                                    </div>
                                                    <input type="file" id="suggestionVideos" multiple accept=".mp4,.avi,.mov,.wmv,.flv,.webm" style="display: none;">
                                                </div>
                                                <div id="videoStatus" style="text-align: center; margin-top: 5px; font-size: 11px; color: #764ba2; font-family: 'JetBrains Mono', monospace;"></div>
                                            </div>
                                            <div id="uploadProgress" style="display: none; margin-top: 12px;">
                                                <div style="background: rgba(26,31,46,0.8); border-radius: 8px; height: 24px; overflow: hidden; border: 1px solid rgba(0, 255, 231, 0.3);">
                                                    <div id="progressBar" style="background: linear-gradient(90deg, #00ffe7 0%, #667eea 100%); height: 100%; width: 0%; transition: width 0.3s; box-shadow: 0 0 10px rgba(0, 255, 231, 0.5);"></div>
                                                </div>
                                                <small style="color: #00ffe7; font-family: 'JetBrains Mono', monospace; margin-top: 5px; display: block;">ä¸Šä¼ ä¸­... <span id="progressText">0%</span></small>
                                            </div>
                                            
                                            <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
                                            <div id="filePreviewArea" style="margin-top: 12px; display: none;">
                                                <h6 style="color: #ffffff; margin-bottom: 8px; font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 13px;">
                                                    <i class="fas fa-eye" style="margin-right: 5px; color: #00ffe7;"></i> æ–‡ä»¶é¢„è§ˆ
                                                    <span id="fileCount" style="color: #00ffe7; font-size: 11px; margin-left: 10px;"></span>
                                                </h6>
                                                <div id="imagePreviewContainer" style="margin-bottom: 10px;"></div>
                                                <div id="videoPreviewContainer" style="margin-bottom: 10px;"></div>
                                                <div id="fileListContainer" style="margin-bottom: 10px;"></div>
                                            </div>
                                            
                                            <div id="uploadedFiles" style="margin-top: 12px;"></div>
                                        </div>
                                        
                                        <div style="text-align: center; margin-top: 20px;">
                                            <button onclick="submitSuggestion()" style="background: linear-gradient(135deg, #00ffe7 0%, #667eea 100%); color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-right: 15px; font-family: 'JetBrains Mono', monospace; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 255, 231, 0.3);">
                                                <i class="fas fa-paper-plane" style="margin-right: 8px;"></i> æäº¤å»ºè®®
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                

                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', suggestionsHtml);
                    
                    // é‡æ–°ç»‘å®šæ–‡ä»¶ä¸Šä¼ äº‹ä»¶
                    bindFileUploadEvents();
                })
                .catch(error => {
                    console.error('è·å–å»ºè®®å¤±è´¥:', error);
                    showNotification('è·å–å»ºè®®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
        }
        
    // å…³é—­å»ºè®®ç•Œé¢
    function closeSuggestions() {
            console.log('å…³é—­å»ºè®®ç•Œé¢è¢«è°ƒç”¨');
            const suggestions = document.querySelector('div[style*="z-index: 10000"]');
            if (suggestions) {
                console.log('æ‰¾åˆ°å»ºè®®ç•Œé¢ï¼Œæ­£åœ¨å…³é—­');
                suggestions.remove();
            } else {
                console.log('æœªæ‰¾åˆ°å»ºè®®ç•Œé¢');
            }
        }
        
        // æ·»åŠ ESCé”®å…³é—­åŠŸèƒ½
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const suggestions = document.querySelector('div[style*="z-index: 10000"]');
                if (suggestions) {
                    suggestions.remove();
                }
            }
        });
        
    // Tabåˆ‡æ¢åŠŸèƒ½
    function switchTab(tabName) {
            // éšè—æ‰€æœ‰tabå†…å®¹
            document.getElementById('tab-content-existing').style.display = 'none';
            document.getElementById('tab-content-new').style.display = 'none';
            
            // é‡ç½®æ‰€æœ‰tabæŒ‰é’®æ ·å¼
            document.getElementById('tab-existing').style.background = 'rgba(26,31,46,0.8)';
            document.getElementById('tab-existing').style.color = '#00ffe7';
            document.getElementById('tab-existing').style.border = '1px solid rgba(0, 255, 231, 0.3)';
            document.getElementById('tab-new').style.background = 'rgba(26,31,46,0.8)';
            document.getElementById('tab-new').style.color = '#00ffe7';
            document.getElementById('tab-new').style.border = '1px solid rgba(0, 255, 231, 0.3)';
            
            // æ˜¾ç¤ºé€‰ä¸­çš„tabå†…å®¹
            if (tabName === 'existing') {
                document.getElementById('tab-content-existing').style.display = 'block';
                document.getElementById('tab-existing').style.background = 'linear-gradient(135deg, #00ffe7 0%, #667eea 100%)';
                document.getElementById('tab-existing').style.color = '#000';
                document.getElementById('tab-existing').style.border = 'none';
            } else if (tabName === 'new') {
                document.getElementById('tab-content-new').style.display = 'block';
                document.getElementById('tab-new').style.background = 'linear-gradient(135deg, #00ffe7 0%, #667eea 100%)';
                document.getElementById('tab-new').style.color = '#000';
                document.getElementById('tab-new').style.border = 'none';
            }
        }
        
        // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç»‘å®šå‡½æ•°
        function bindFileUploadEvents() {
            // ä¸ºå»ºè®®ç•Œé¢çš„è¾“å…¥æ¡†æ·»åŠ ç„¦ç‚¹æ•ˆæœ
            document.addEventListener('focusin', function(e) {
                if (e.target.matches('#suggestionTitle, #suggestionType, #newSuggestion, #suggestionImages, #suggestionVideos')) {
                    e.target.style.borderColor = '#00ffe7';
                    e.target.style.boxShadow = '0 0 10px rgba(0, 255, 231, 0.3)';
                }
            });
            
            document.addEventListener('focusout', function(e) {
                if (e.target.matches('#suggestionTitle, #suggestionType, #newSuggestion, #suggestionImages, #suggestionVideos')) {
                    if (e.target.id === 'suggestionImages') {
                        e.target.style.borderColor = 'rgba(102, 126, 234, 0.3)';
                    } else if (e.target.id === 'suggestionVideos') {
                        e.target.style.borderColor = 'rgba(118, 75, 162, 0.3)';
                    } else {
                        e.target.style.borderColor = 'rgba(0, 255, 231, 0.3)';
                    }
                    e.target.style.boxShadow = 'none';
                }
            });
            
            // æå®¢é£æ ¼æ–‡ä»¶ä¸Šä¼ å¢å¼ºåŠŸèƒ½
            const uploadAreas = document.querySelectorAll('.geek-upload-area, .geek-file-upload');
            
            uploadAreas.forEach(area => {
                const fileInput = area.querySelector('input[type="file"]');
                if (!fileInput) return;
                
                // æ‹–æ‹½äº‹ä»¶
                area.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });
                
                area.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });
                
                area.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        // æ–‡ä»¶æ•°é‡é™åˆ¶æ£€æŸ¥
                        let maxFiles = 3; // é»˜è®¤å›¾ç‰‡é™åˆ¶
                        if (fileInput.id === 'suggestionVideos') {
                            maxFiles = 1; // è§†é¢‘é™åˆ¶ä¸º1ä¸ª
                        }
                        
                        if (files.length > maxFiles) {
                            showNotification(`æœ€å¤šåªèƒ½é€‰æ‹©${maxFiles}ä¸ªæ–‡ä»¶`, 'error');
                            return;
                        }
                        
                        fileInput.files = files;
                        fileInput.dispatchEvent(new Event('change'));
                    }
                });
                
                // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
                fileInput.addEventListener('change', function() {
                    const area = this.closest('.geek-upload-area, .geek-file-upload');
                    
                    // æ–‡ä»¶æ•°é‡é™åˆ¶æ£€æŸ¥
                    let maxFiles = 3; // é»˜è®¤å›¾ç‰‡é™åˆ¶
                    if (this.id === 'suggestionVideos') {
                        maxFiles = 1; // è§†é¢‘é™åˆ¶ä¸º1ä¸ª
                    }
                    
                    if (this.files.length > maxFiles) {
                        showNotification(`æœ€å¤šåªèƒ½é€‰æ‹©${maxFiles}ä¸ªæ–‡ä»¶`, 'error');
                        this.value = ''; // æ¸…ç©ºé€‰æ‹©
                        return;
                    }
                    
                    if (this.files.length > 0) {
                        area.classList.add('has-file');
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        const fileType = this.id === 'suggestionImages' ? 'å›¾ç‰‡' : 'è§†é¢‘';
                        const statusElement = document.getElementById(this.id === 'suggestionImages' ? 'imageStatus' : 'videoStatus');
                        if (statusElement) {
                            statusElement.textContent = `å·²é€‰æ‹© ${this.files.length} ä¸ª${fileType}æ–‡ä»¶`;
                            statusElement.style.color = '#00ffe7';
                        }
                        
                        // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸæç¤º
                        showNotification(`æˆåŠŸé€‰æ‹©${this.files.length}ä¸ª${fileType}æ–‡ä»¶`, 'success');
                        
                        // æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶çš„é¢„è§ˆ
                        showAllFilesPreview();
                    } else {
                        area.classList.remove('has-file');
                        
                        // æ¸…ç©ºçŠ¶æ€æ˜¾ç¤º
                        const statusElement = document.getElementById(this.id === 'suggestionImages' ? 'imageStatus' : 'videoStatus');
                        if (statusElement) {
                            statusElement.textContent = '';
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰åˆ™éšè—é¢„è§ˆ
                        const imageFiles = document.getElementById('suggestionImages').files;
                        const videoFiles = document.getElementById('suggestionVideos').files;
                        if (imageFiles.length === 0 && videoFiles.length === 0) {
                            hideFilePreview();
                        } else {
                            // é‡æ–°æ˜¾ç¤ºé¢„è§ˆ
                            showAllFilesPreview();
                        }
                    }
                });
                
                // ä¿å­˜åŸå§‹æ–‡æœ¬
                const uploadText = area.querySelector('.upload-text');
                if (uploadText) {
                    uploadText.setAttribute('data-original-text', uploadText.textContent);
                }
            });
            
            // ä¸ºæ–‡ä»¶åˆ—è¡¨æ·»åŠ åˆ é™¤åŠŸèƒ½
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('file-remove')) {
                    const fileItem = e.target.closest('.geek-file-item');
                    if (fileItem) {
                        fileItem.style.animation = 'fadeOut 0.3s ease';
                        setTimeout(() => {
                            fileItem.remove();
                        }, 300);
                    }
                }
            });
        }
        
        // æ·»åŠ æå®¢é£æ ¼çš„è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ—¶ç»‘å®šäº‹ä»¶
            bindFileUploadEvents();
        });
        
        // æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶çš„é¢„è§ˆ
        function showAllFilesPreview() {
            const imageFiles = document.getElementById('suggestionImages').files;
            const videoFiles = document.getElementById('suggestionVideos').files;
            showFilePreview([], 'all');
        }
        // æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
        function showFilePreview(files, inputId) {
            console.log('å¼€å§‹é¢„è§ˆæ–‡ä»¶:', files.length, 'ä¸ªæ–‡ä»¶');
            
            const previewArea = document.getElementById('filePreviewArea');
            const imageContainer = document.getElementById('imagePreviewContainer');
            const videoContainer = document.getElementById('videoPreviewContainer');
            const fileListContainer = document.getElementById('fileListContainer');
            
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!previewArea || !imageContainer || !videoContainer || !fileListContainer) {
                console.error('é¢„è§ˆåŒºåŸŸå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            previewArea.style.display = 'block';
            
            // è·å–æ‰€æœ‰å·²é€‰æ‹©çš„æ–‡ä»¶
            const imageFiles = document.getElementById('suggestionImages').files;
            const videoFiles = document.getElementById('suggestionVideos').files;
            
            // æ¸…ç©ºä¹‹å‰çš„é¢„è§ˆ
            imageContainer.innerHTML = '';
            videoContainer.innerHTML = '';
            fileListContainer.innerHTML = '';
            
            let hasImages = false;
            let hasVideos = false;
            let hasOtherFiles = false;
            
            // å¤„ç†å›¾ç‰‡æ–‡ä»¶
            if (imageFiles.length > 0) {
                hasImages = true;
                Array.from(imageFiles).forEach((file, index) => {
                    const fileType = file.type;
                    console.log('å¤„ç†å›¾ç‰‡æ–‡ä»¶:', file.name, 'ç±»å‹:', fileType, 'å¤§å°:', file.size);
                    
                    if (fileType.startsWith('image/')) {
                        console.log('æ£€æµ‹åˆ°å›¾ç‰‡æ–‡ä»¶:', file.name);
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', file.name);
                            const imgDiv = document.createElement('div');
                            imgDiv.style.cssText = `
                                display: inline-block;
                                margin: 5px;
                                position: relative;
                                border-radius: 8px;
                                overflow: hidden;
                                border: 2px solid rgba(0, 255, 231, 0.3);
                                background: rgba(26,31,46,0.8);
                            `;
                            
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.cssText = `
                                width: 120px;
                                height: 120px;
                                object-fit: cover;
                                display: block;
                            `;
                            
                            // æ·»åŠ å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
                            img.onerror = function() {
                                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', file.name);
                                imgDiv.style.borderColor = 'rgba(255, 0, 0, 0.5)';
                            };
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.innerHTML = 'Ã—';
                            removeBtn.className = 'file-remove-btn';
                            removeBtn.style.cssText = `
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                background: rgba(255, 0, 0, 0.8);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 20px;
                                height: 20px;
                                cursor: pointer;
                                font-size: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            `;
                            removeBtn.onclick = function() {
                                imgDiv.remove();
                                removeFileFromInput('suggestionImages', index);
                            };
                            
                            const fileName = document.createElement('div');
                            fileName.textContent = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
                            fileName.style.cssText = `
                                position: absolute;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                background: rgba(0, 0, 0, 0.7);
                                color: white;
                                padding: 2px 5px;
                                font-size: 10px;
                                text-align: center;
                            `;
                            
                            imgDiv.appendChild(img);
                            imgDiv.appendChild(removeBtn);
                            imgDiv.appendChild(fileName);
                            imageContainer.appendChild(imgDiv);
                            console.log('å›¾ç‰‡é¢„è§ˆå·²æ·»åŠ åˆ°å®¹å™¨');
                        };
                        
                        reader.onerror = function() {
                            console.error('å›¾ç‰‡è¯»å–å¤±è´¥:', file.name);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // å¤„ç†è§†é¢‘æ–‡ä»¶
            if (videoFiles.length > 0) {
                hasVideos = true;
                Array.from(videoFiles).forEach((file, index) => {
                    const fileType = file.type;
                    console.log('å¤„ç†è§†é¢‘æ–‡ä»¶:', file.name, 'ç±»å‹:', fileType, 'å¤§å°:', file.size);
                    
                    if (fileType.startsWith('video/')) {
                        console.log('æ£€æµ‹åˆ°è§†é¢‘æ–‡ä»¶:', file.name);
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            console.log('è§†é¢‘åŠ è½½æˆåŠŸ:', file.name);
                            const videoDiv = document.createElement('div');
                            videoDiv.style.cssText = `
                                display: inline-block;
                                margin: 5px;
                                position: relative;
                                border-radius: 8px;
                                overflow: hidden;
                                border: 2px solid rgba(118, 75, 162, 0.3);
                                background: rgba(26,31,46,0.8);
                            `;
                            
                            const video = document.createElement('video');
                            video.src = e.target.result;
                            video.style.cssText = `
                                width: 200px;
                                height: 120px;
                                object-fit: cover;
                                display: block;
                            `;
                            video.controls = true;
                            
                            // æ·»åŠ è§†é¢‘åŠ è½½é”™è¯¯å¤„ç†
                            video.onerror = function() {
                                console.error('è§†é¢‘åŠ è½½å¤±è´¥:', file.name);
                                videoDiv.style.borderColor = 'rgba(255, 0, 0, 0.5)';
                            };
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.innerHTML = 'Ã—';
                            removeBtn.className = 'file-remove-btn';
                            removeBtn.style.cssText = `
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                background: rgba(255, 0, 0, 0.8);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 20px;
                                height: 20px;
                                cursor: pointer;
                                font-size: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            `;
                            removeBtn.onclick = function() {
                                videoDiv.remove();
                                removeFileFromInput('suggestionVideos', index);
                            };
                            
                            const fileName = document.createElement('div');
                            fileName.textContent = file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name;
                            fileName.style.cssText = `
                                position: absolute;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                background: rgba(0, 0, 0, 0.7);
                                color: white;
                                padding: 2px 5px;
                                font-size: 10px;
                                text-align: center;
                            `;
                            
                            videoDiv.appendChild(video);
                            videoDiv.appendChild(removeBtn);
                            videoDiv.appendChild(fileName);
                            videoContainer.appendChild(videoDiv);
                            console.log('è§†é¢‘é¢„è§ˆå·²æ·»åŠ åˆ°å®¹å™¨');
                        };
                        
                        reader.onerror = function() {
                            console.error('è§†é¢‘è¯»å–å¤±è´¥:', file.name);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            

            
            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            console.log('é¢„è§ˆç»Ÿè®¡ - å›¾ç‰‡:', hasImages, 'è§†é¢‘:', hasVideos, 'å…¶ä»–:', hasOtherFiles);
            
            if (hasImages || hasVideos || hasOtherFiles) {
                previewArea.style.display = 'block';
                
                // æ›´æ–°æ–‡ä»¶è®¡æ•°æ˜¾ç¤º
                const fileCountElement = document.getElementById('fileCount');
                if (fileCountElement) {
                    const totalFiles = imageFiles.length + videoFiles.length;
                    fileCountElement.textContent = `(å…±${totalFiles}ä¸ªæ–‡ä»¶)`;
                }
                
                // æ·»åŠ æ ‡é¢˜
                if (hasImages) {
                    const imageTitle = document.createElement('div');
                    imageTitle.textContent = `å›¾ç‰‡é¢„è§ˆ (${imageContainer.children.length}å¼ )`;
                    imageTitle.style.cssText = `
                        color: #00ffe7;
                        font-weight: 600;
                        margin-bottom: 8px;
                        font-size: 12px;
                        font-family: 'JetBrains Mono', monospace;
                    `;
                    imageContainer.insertBefore(imageTitle, imageContainer.firstChild);
                }
                
                if (hasVideos) {
                    const videoTitle = document.createElement('div');
                    videoTitle.textContent = `è§†é¢‘é¢„è§ˆ (${videoContainer.children.length}ä¸ª)`;
                    videoTitle.style.cssText = `
                        color: #764ba2;
                        font-weight: 600;
                        margin-bottom: 8px;
                        font-size: 12px;
                        font-family: 'JetBrains Mono', monospace;
                    `;
                    videoContainer.insertBefore(videoTitle, videoContainer.firstChild);
                }
                
                if (hasOtherFiles) {
                    const fileTitle = document.createElement('div');
                    fileTitle.textContent = 'å…¶ä»–æ–‡ä»¶';
                    fileTitle.style.cssText = `
                        color: #667eea;
                        font-weight: 600;
                        margin-bottom: 8px;
                        font-size: 12px;
                        font-family: 'JetBrains Mono', monospace;
                    `;
                    fileListContainer.insertBefore(fileTitle, fileListContainer.firstChild);
                }
            }
        }
        
        function hideFilePreview() {
            const previewArea = document.getElementById('filePreviewArea');
            if (previewArea) {
                previewArea.style.display = 'none';
            }
        }
        
        function removeFileFromInput(inputId, removeIndex) {
            const fileInput = document.getElementById(inputId);
            const dt = new DataTransfer();
            const currentFiles = Array.from(fileInput.files);
            
            // é‡æ–°åˆ›å»ºæ–‡ä»¶åˆ—è¡¨ï¼Œæ’é™¤è¦åˆ é™¤çš„æ–‡ä»¶
            currentFiles.forEach((file, index) => {
                if (index !== removeIndex) {
                    dt.items.add(file);
                }
            });
            
            fileInput.files = dt.files;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const fileType = inputId === 'suggestionImages' ? 'å›¾ç‰‡' : 'è§†é¢‘';
            const statusElement = document.getElementById(inputId === 'suggestionImages' ? 'imageStatus' : 'videoStatus');
            if (statusElement) {
                if (dt.files.length === 0) {
                    statusElement.textContent = '';
                } else {
                    statusElement.textContent = `å·²é€‰æ‹© ${dt.files.length} ä¸ª${fileType}æ–‡ä»¶`;
                    statusElement.style.color = '#00ffe7';
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ–‡ä»¶äº†ï¼Œéšè—é¢„è§ˆåŒºåŸŸ
            if (dt.files.length === 0) {
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æ–‡ä»¶
                const imageFiles = document.getElementById('suggestionImages').files;
                const videoFiles = document.getElementById('suggestionVideos').files;
                if (imageFiles.length === 0 && videoFiles.length === 0) {
                    hideFilePreview();
                } else {
                    // é‡æ–°æ˜¾ç¤ºé¢„è§ˆ
                    showAllFilesPreview();
                }
            } else {
                // é‡æ–°æ˜¾ç¤ºé¢„è§ˆ
                showAllFilesPreview();
            }
        }
        
        function updateFileInput(inputId, removeIndex) {
            const fileInput = document.getElementById(inputId);
            const dt = new DataTransfer();
            const currentFiles = Array.from(fileInput.files);
            
            // é‡æ–°åˆ›å»ºæ–‡ä»¶åˆ—è¡¨ï¼Œæ’é™¤è¦åˆ é™¤çš„æ–‡ä»¶
            currentFiles.forEach((file, index) => {
                if (index !== removeIndex) {
                    dt.items.add(file);
                }
            });
            
            fileInput.files = dt.files;
            
            // å¦‚æœæ²¡æœ‰æ–‡ä»¶äº†ï¼Œéšè—é¢„è§ˆåŒºåŸŸ
            if (dt.files.length === 0) {
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æ–‡ä»¶
                const imageFiles = document.getElementById('suggestionImages').files;
                const videoFiles = document.getElementById('suggestionVideos').files;
                if (imageFiles.length === 0 && videoFiles.length === 0) {
                    hideFilePreview();
                } else {
                    // é‡æ–°æ˜¾ç¤ºé¢„è§ˆ
                    showAllFilesPreview();
                }
            } else {
                // é‡æ–°æ˜¾ç¤ºé¢„è§ˆ
                showAllFilesPreview();
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æäº¤å»ºè®®
        async function submitSuggestion() {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            {% if not user.is_authenticated %}
            showNotification('è¯·å…ˆç™»å½•åå†æäº¤å»ºè®®', 'warning');
            closeSuggestions();
            // è·³è½¬åˆ°ç™»å½•é¡µé¢
            setTimeout(() => {
                window.location.href = '{% url "users:login" %}';
            }, 1500);
            return;
            {% endif %}
            
            const title = document.getElementById('suggestionTitle').value;
            const content = document.getElementById('newSuggestion').value;
            const suggestionType = document.getElementById('suggestionType').value;
            const imageFiles = document.getElementById('suggestionImages').files;
            const videoFiles = document.getElementById('suggestionVideos').files;
            
            if (!title.trim() || !content.trim()) {
                showNotification('è¯·å¡«å†™å»ºè®®æ ‡é¢˜å’Œå†…å®¹', 'warning');
                return;
            }
            
            try {
                // å…ˆä¸Šä¼ æ–‡ä»¶
                let uploadedImages = [];
                let uploadedVideos = [];
                
                if (imageFiles.length > 0 || videoFiles.length > 0) {
                    const formData = new FormData();
                    
                    // æ·»åŠ å›¾ç‰‡æ–‡ä»¶
                    for (let i = 0; i < imageFiles.length; i++) {
                        formData.append('images', imageFiles[i]);
                    }
                    
                    // æ·»åŠ è§†é¢‘æ–‡ä»¶
                    for (let i = 0; i < videoFiles.length; i++) {
                        formData.append('videos', videoFiles[i]);
                    }
                    
                    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                    document.getElementById('uploadProgress').style.display = 'block';
                    document.getElementById('progressBar').style.width = '0%';
                    document.getElementById('progressText').textContent = '0%';
                    
                    const uploadResponse = await fetch('/content/api/upload-media/', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadResponse.json();
                    
                    if (uploadData.success) {
                        uploadedImages = uploadData.files.filter(f => f.type === 'image');
                        uploadedVideos = uploadData.files.filter(f => f.type === 'video');
                        showNotification(uploadData.message, 'success');
                        
                        // æ˜¾ç¤ºè¯¦ç»†çš„ä¸Šä¼ ä¿¡æ¯
                        if (uploadData.upload_info) {
                            showUploadDetails(uploadData.upload_info);
                        }
                    } else {
                        showNotification('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + uploadData.error, 'error');
                        return;
                    }
                    
                    // éšè—ä¸Šä¼ è¿›åº¦
                    document.getElementById('uploadProgress').style.display = 'none';
                }
                
                // æäº¤å»ºè®®
                const suggestionData = {
                    title: title,
                    content: content,
                    suggestion_type: suggestionType,
                    images: uploadedImages,
                    videos: uploadedVideos
                };
                
                const response = await fetch('/content/api/suggestions/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(suggestionData)
                });
                
                if (response.status === 401) {
                    // æœªç™»å½•çŠ¶æ€
                    showNotification('è¯·å…ˆç™»å½•åå†æäº¤å»ºè®®', 'warning');
                    closeSuggestions();
                    setTimeout(() => {
                        window.location.href = '{% url "users:login" %}';
                    }, 1500);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    closeSuggestions();
                    // åˆ·æ–°å»ºè®®åˆ—è¡¨
                    setTimeout(() => {
                        showSuggestions();
                    }, 1000);
                } else {
                    showNotification(data.error || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('æäº¤å»ºè®®å¤±è´¥:', error);
                showNotification('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                document.getElementById('uploadProgress').style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºåé¦ˆç•Œé¢
        function showFeedback() {
            const feedbackHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; max-height: 80vh; overflow-y: auto; width: 90%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #333; margin: 0;">
                                <i class="fas fa-comment" style="color: #17a2b8;"></i> æ„è§åé¦ˆ
                            </h3>
                            <button onclick="closeFeedback()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #333;">åé¦ˆç±»å‹ï¼š</label>
                            <select id="feedbackType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                                <option value="bug">BugæŠ¥å‘Š</option>
                                <option value="feature">åŠŸèƒ½å»ºè®®</option>
                                <option value="ui">ç•Œé¢æ”¹è¿›</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #333;">åé¦ˆå†…å®¹ï¼š</label>
                            <textarea id="feedbackContent" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„åé¦ˆ..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="submitFeedback()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                <i class="fas fa-paper-plane"></i> æäº¤åé¦ˆ
                            </button>
                            <button onclick="closeFeedback()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', feedbackHtml);
        }
        
        // å…³é—­åé¦ˆç•Œé¢
        function closeFeedback() {
            const feedback = document.querySelector('div[style*="z-index: 10000"]');
            if (feedback) {
                feedback.remove();
            }
        }
        
        // æäº¤åé¦ˆ
        function submitFeedback() {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            {% if not user.is_authenticated %}
            showNotification('è¯·å…ˆç™»å½•åå†æäº¤åé¦ˆ', 'warning');
            closeFeedback();
            // è·³è½¬åˆ°ç™»å½•é¡µé¢
            setTimeout(() => {
                window.location.href = '{% url "users:login" %}';
            }, 1500);
            return;
            {% endif %}
            
            const type = document.getElementById('feedbackType').value;
            const content = document.getElementById('feedbackContent').value;
            
            if (!content.trim()) {
                showNotification('è¯·è¾“å…¥åé¦ˆå†…å®¹', 'warning');
                return;
            }
            
            const feedbackData = {
                feedback_type: type,
                content: content
            };
            
            fetch('/content/api/feedback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(feedbackData)
            })
            .then(response => {
                if (response.status === 401) {
                    // æœªç™»å½•çŠ¶æ€
                    showNotification('è¯·å…ˆç™»å½•åå†æäº¤åé¦ˆ', 'warning');
                    closeFeedback();
                    setTimeout(() => {
                        window.location.href = '{% url "users:login" %}';
                    }, 1500);
                    return response.json();
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    closeFeedback();
                } else {
                    showNotification(data.error || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            })
            .catch(error => {
                console.error('æäº¤åé¦ˆå¤±è´¥:', error);
                showNotification('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            });
        }
        
        // è·å–CSRF Token
        function getCSRFToken() {
            // é¦–å…ˆå°è¯•ä»metaæ ‡ç­¾è·å–
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
                return metaToken.getAttribute('content');
            }
            
            // ç„¶åå°è¯•ä»cookieè·å–
            return getCookie('csrftoken');
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        // ä¸»é¢˜ç®¡ç†ç³»ç»Ÿ
        let currentTheme = 'work';
        
        // ä¸»é¢˜é…ç½®
        const themeConfig = {
            'life': {
                name: 'ç”Ÿæ´»',
                css: 'life.css',
                badgeClass: 'punk',
                subtitle: 'äº«å—ç”Ÿæ´»çš„ç¾å¥½æ—¶å…‰'
            },
            'work': {
                name: 'æå®¢',
                css: 'geek.css',
                badgeClass: '',
                subtitle: 'ä¸“æ³¨æŠ€æœ¯ï¼Œè¿½æ±‚å“è¶Š'
            },
            'cyberpunk': {
                name: 'èµ›åšå“¥ç‰¹',
                css: 'cyberpunk.css',
                badgeClass: 'cyberpunk',
                subtitle: 'èµ›åšæœ‹å…‹ï¼Œæ•…éšœè‰ºæœ¯'
            },
            'training': {
                name: 'ç‹‚æš´',
                css: 'rage.css',
                badgeClass: 'rage',
                subtitle: 'çªç ´æé™ï¼ŒæŒ‘æˆ˜è‡ªæˆ‘'
            },
            'emo': {
                name: 'Emo',
                css: 'emo.css',
                badgeClass: 'emo',
                subtitle: 'æ„Ÿå—å†…å¿ƒçš„æƒ…æ„Ÿæ³¢åŠ¨'
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserTheme();
            
                            // æ£€æŸ¥å½“å‰é¡µé¢è·¯å¾„ï¼Œç¡®ä¿ä¸»é¢˜ä¸é¡µé¢åŒ¹é…
                setTimeout(function() {
                    var currentPath = window.location.pathname;
                    var pathToTheme = {
                        '/tools/life_mode/': 'life',
                        '/tools/work/': 'work',
                        '/tools/cyberpunk/': 'cyberpunk',
                        '/tools/training/': 'training',
                        '/tools/emo/': 'emo',
                        '/tools/emo_diary/': 'emo'
                    };
                    
                    var expectedTheme = pathToTheme[currentPath];
                    if (expectedTheme && expectedTheme !== currentTheme && themeConfig[expectedTheme]) {
                        // å¦‚æœå½“å‰é¡µé¢è·¯å¾„ä¸ä¸»é¢˜ä¸åŒ¹é…ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¯¹åº”ä¸»é¢˜
                        console.log('é¡µé¢è·¯å¾„ ' + currentPath + ' ä¸å½“å‰ä¸»é¢˜ ' + currentTheme + ' ä¸åŒ¹é…ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ° ' + expectedTheme + ' ä¸»é¢˜');
                        switchGlobalTheme(expectedTheme);
                    }
                }, 100);
        });
        
        // åŠ è½½ç”¨æˆ·ä¸»é¢˜
        async function loadUserTheme() {
            try {
                const response = await fetch('/users/theme/', {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                
                if (response.ok) {
                    // æ£€æŸ¥å“åº”ç±»å‹
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        // å¦‚æœè¿”å›çš„ä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯é‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼Œä½¿ç”¨é»˜è®¤ä¸»é¢˜
                        console.log('ç”¨æˆ·æœªç™»å½•ï¼Œä½¿ç”¨é»˜è®¤ä¸»é¢˜');
                        currentTheme = 'work';
                        applyGlobalTheme(currentTheme);
                        updateThemeBadge(currentTheme);
                        updateActiveThemeItem(currentTheme);
                        return;
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        currentTheme = data.data.mode || 'work';
                        applyGlobalTheme(currentTheme);
                        updateThemeBadge(currentTheme);
                        updateActiveThemeItem(currentTheme);
                        
                        // æ›´æ–°å‰¯æ ‡é¢˜
                        const subtitle = document.getElementById('theme-subtitle');
                        if (subtitle && data.data.subtitle) {
                            subtitle.textContent = data.data.subtitle;
                        }
                    }
                }
            } catch (error) {
                console.log('Failed to load theme:', error);
                // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤ä¸»é¢˜
                currentTheme = 'work';
                applyGlobalTheme(currentTheme);
                updateThemeBadge(currentTheme);
                updateActiveThemeItem(currentTheme);
            }
        }
        
        // åº”ç”¨å…¨å±€ä¸»é¢˜
        function applyGlobalTheme(theme) {
            const themeCSS = document.getElementById('dynamic-theme-css');
            if (themeCSS) {
                themeCSS.href = '/static/' + themeConfig[theme].css;
            }
            
            // æ›´æ–°bodyç±»å
            document.body.className = theme + '-theme';
            
            // æ›´æ–°å¯¼èˆªæ ç±»å
            updateNavbarTheme(theme);
            
            // æ›´æ–°å‰¯æ ‡é¢˜
            updateThemeSubtitle(theme);
            
            // æ›´æ–°èƒŒæ™¯
            updateThemeBackground(theme);
            
            // æ›´æ–°é¡µé¢æ¨¡æ¿å†…å®¹
            updatePageTemplate(theme);
        }
        
        // æ›´æ–°å¯¼èˆªæ ä¸»é¢˜
        function updateNavbarTheme(theme) {
            const navbar = document.querySelector('.navbar');
            if (navbar) {
                // ç¡®ä¿ä¿ç•™unified-navbarç±»
                if (!navbar.classList.contains('unified-navbar')) {
                    navbar.classList.add('unified-navbar');
                }
                
                // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç›¸å…³çš„å¯¼èˆªæ ç±»å
                navbar.className = navbar.className.replace(/(geek|life|training|emo|cyberpunk|punk|rage)-navbar/g, '');
                navbar.className = navbar.className.replace(/\s+/g, ' ').trim();
                
                // é‡æ–°æ·»åŠ unified-navbarç±»
                navbar.classList.add('unified-navbar');
                
                // æ·»åŠ æ–°ä¸»é¢˜çš„å¯¼èˆªæ ç±»å
                const themeNavbarMap = {
                    'work': 'geek-navbar',
                    'life': 'life-navbar',
                    'training': 'rage-navbar',
                    'emo': 'emo-navbar',
                    'cyberpunk': 'cyber-navbar',
                    'punk': 'punk-navbar'
                };
                
                if (themeNavbarMap[theme]) {
                    navbar.classList.add(themeNavbarMap[theme]);
                }
                
                // è½»é‡çº§å¯¼èˆªæ ä¼˜åŒ–
                setTimeout(() => {
                    window.safeCall('enhanceNavbar');
                }, 50);
            }
        }
        
        // æ›´æ–°é¡µé¢æ¨¡æ¿å†…å®¹
        function updatePageTemplate(theme) {
            // è·å–å½“å‰é¡µé¢è·¯å¾„
            const currentPath = window.location.pathname;
            
            // æ ¹æ®å½“å‰é¡µé¢å’Œä¸»é¢˜æ›´æ–°æ¨¡æ¿å†…å®¹
            if (currentPath.includes('/tools/')) {
                updateToolPageTemplate(theme);
            } else if (currentPath === '/' || currentPath === '/home/') {
                updateHomePageTemplate(theme);
            } else {
                updateGenericPageTemplate(theme);
            }
        }
        
        // æ›´æ–°å·¥å…·é¡µé¢æ¨¡æ¿
        function updateToolPageTemplate(theme) {
            const toolContainer = document.getElementById('tool-container');
            if (!toolContainer) return;
            
            // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç›¸å…³çš„ç±»å
            toolContainer.className = toolContainer.className.replace(/(geek|life|training|emo)-card/g, '');
            
            // æ·»åŠ æ–°ä¸»é¢˜çš„ç±»å
            const themeClassMap = {
                'work': 'geek-card',
                'life': 'life-card', 
                'training': 'training-card',
                'emo': 'emo-card'
            };
            
            if (themeClassMap[theme]) {
                toolContainer.classList.add(themeClassMap[theme]);
            }
            
            // æ›´æ–°æ ‡é¢˜
            const toolTitle = document.getElementById('tool-title');
            if (toolTitle) {
                toolTitle.className = toolTitle.className.replace(/(geek|life|training|emo)-title/g, '');
                if (themeClassMap[theme]) {
                    toolTitle.classList.add(themeClassMap[theme].replace('-card', '-title'));
                }
            }
            
            // æ›´æ–°ç»ˆç«¯æ ·å¼
            const terminals = ['tool-terminal', 'life-terminal', 'training-terminal', 'emo-terminal'];
            terminals.forEach(terminalId => {
                const terminal = document.getElementById(terminalId);
                if (terminal) {
                    terminal.className = terminal.className.replace(/(geek|life|training|emo)-terminal/g, '');
                }
            });
            
            // æ ¹æ®ä¸»é¢˜æ˜¾ç¤ºå¯¹åº”çš„ç»ˆç«¯
            const themeTerminalMap = {
                'work': 'tool-terminal',
                'life': 'life-terminal',
                'training': 'training-terminal', 
                'emo': 'emo-terminal'
            };
            
            // éšè—æ‰€æœ‰ç»ˆç«¯
            terminals.forEach(terminalId => {
                const terminal = document.getElementById(terminalId);
                if (terminal) {
                    terminal.style.display = 'none';
                }
            });
            
            // æ˜¾ç¤ºå½“å‰ä¸»é¢˜çš„ç»ˆç«¯
            const currentTerminal = document.getElementById(themeTerminalMap[theme]);
            if (currentTerminal) {
                currentTerminal.style.display = 'block';
                currentTerminal.className = currentTerminal.className.replace(/(geek|life|training|emo)-terminal/g, '');
                currentTerminal.classList.add(themeClassMap[theme].replace('-card', '-terminal'));
            }
            
            // æ›´æ–°å·¥å…·ç½‘æ ¼
            const toolGrid = document.getElementById('tool-grid');
            if (toolGrid) {
                toolGrid.className = toolGrid.className.replace(/(geek|life|training|emo)-tool-grid/g, '');
                if (themeClassMap[theme]) {
                    toolGrid.classList.add(themeClassMap[theme].replace('-card', '-tool-grid'));
                }
            }
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            updatePageTitle(theme);
        }
        
        // æ›´æ–°ä¸»é¡µæ¨¡æ¿
        function updateHomePageTemplate(theme) {
            const mainContainer = document.querySelector('.main-container');
            if (!mainContainer) return;
            
            // æ›´æ–°å®¹å™¨ç±»å
            mainContainer.className = mainContainer.className.replace(/(geek|life|training|emo)-container/g, '');
            const themeClassMap = {
                'work': 'geek-container',
                'life': 'life-container',
                'training': 'training-container',
                'emo': 'emo-container'
            };
            
            if (themeClassMap[theme]) {
                mainContainer.classList.add(themeClassMap[theme]);
            }
            
            // æ›´æ–°å¡ç‰‡æ ·å¼
            const cards = document.querySelectorAll('.geek-card, .life-card, .training-card, .emo-card');
            cards.forEach(card => {
                card.className = card.className.replace(/(geek|life|training|emo)-card/g, '');
                if (themeClassMap[theme]) {
                    card.classList.add(themeClassMap[theme].replace('-container', '-card'));
                }
            });
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            updatePageTitle(theme);
        }
        
        // æ›´æ–°é€šç”¨é¡µé¢æ¨¡æ¿
        function updateGenericPageTemplate(theme) {
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            updatePageTitle(theme);
            
            // æ›´æ–°é€šç”¨å®¹å™¨æ ·å¼
            const containers = document.querySelectorAll('.geek-container, .life-container, .training-container, .emo-container');
            containers.forEach(container => {
                container.className = container.className.replace(/(geek|life|training|emo)-container/g, '');
                const themeClassMap = {
                    'work': 'geek-container',
                    'life': 'life-container',
                    'training': 'training-container',
                    'emo': 'emo-container'
                };
                
                if (themeClassMap[theme]) {
                    container.classList.add(themeClassMap[theme]);
                }
            });
        }
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜
        function updatePageTitle(theme) {
            const themeNames = {
                'work': 'æå®¢æ¨¡å¼',
                'life': 'ç”Ÿæ´»æ¨¡å¼', 
                'training': 'ç‹‚æš´æ¨¡å¼',
                'emo': 'Emoæ¨¡å¼'
            };
            
            const currentTitle = document.title;
            const baseTitle = currentTitle.replace(/ - (æå®¢|ç”Ÿæ´»|ç‹‚æš´|Emo)æ¨¡å¼$/, '');
            document.title = `${baseTitle} - ${themeNames[theme]}`;
        }
        
        // æ›´æ–°ä¸»é¢˜èƒŒæ™¯
        function updateThemeBackground(theme) {
            const backgroundLayers = document.querySelectorAll('.background-layer');
            
            // éšè—æ‰€æœ‰èƒŒæ™¯å±‚
            backgroundLayers.forEach(layer => {
                layer.style.display = 'none';
            });
            
            // æ˜¾ç¤ºå¯¹åº”ä¸»é¢˜çš„èƒŒæ™¯
            const targetLayer = document.querySelector(`.${theme}-bg`);
            if (targetLayer) {
                targetLayer.style.display = 'block';
                
                // åˆå§‹åŒ–ç‰¹æ®ŠèƒŒæ™¯æ•ˆæœ
                if (theme === 'geek') {
                    initMatrixRain();
                } else if (theme === 'emo') {
                    initEmoParticles();
                }
            }
        }
        
        // çŸ©é˜µé›¨æ•ˆæœï¼ˆæå®¢æ¨¡å¼ï¼‰
        function initMatrixRain() {
            const canvas = document.getElementById('matrix-rain');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const matrix = "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%+-/~{[|`]}";
            const matrixArray = matrix.split("");
            
            const fontSize = 10;
            const columns = canvas.width / fontSize;
            const drops = [];
            
            for (let x = 0; x < columns; x++) {
                drops[x] = 1;
            }
            
            function draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#0F0';
                ctx.font = fontSize + 'px monospace';
                
                for (let i = 0; i < drops.length; i++) {
                    const text = matrixArray[Math.floor(Math.random() * matrixArray.length)];
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    
                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }
            
            setInterval(draw, 35);
        }
        
        // Emoç²’å­æ•ˆæœ
        function initEmoParticles() {
            const container = document.getElementById('emo-particles');
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'emo-particle';
                particle.style.cssText = `
                    position: absolute;
                    width: 4px;
                    height: 4px;
                    background: rgba(156, 39, 176, 0.6);
                    border-radius: 50%;
                    animation: emoParticleFloat ${3 + Math.random() * 4}s ease-in-out infinite;
                    animation-delay: ${Math.random() * 2}s;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                `;
                container.appendChild(particle);
            }
        }
        
        // æ›´æ–°ä¸»é¢˜å¾½ç« 
        function updateThemeBadge(theme) {
            const badge = document.getElementById('theme-badge');
            if (badge) {
                const config = themeConfig[theme];
                badge.textContent = config.name;
                badge.className = 'theme-badge ' + config.badgeClass;
            }
        }
        
        // æ›´æ–°å‰¯æ ‡é¢˜
        function updateThemeSubtitle(theme) {
            const subtitle = document.getElementById('theme-subtitle');
            if (subtitle) {
                const config = themeConfig[theme];
                subtitle.textContent = config.subtitle;
                subtitle.style.opacity = '0';
                setTimeout(() => {
                    subtitle.style.opacity = '0.8';
                }, 200);
            }
        }
        
        // æ›´æ–°æ¿€æ´»çš„ä¸»é¢˜é¡¹
        function updateActiveThemeItem(theme) {
            document.querySelectorAll('.theme-switch').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-mode="${theme}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        
        // ä¸»é¢˜ä¸é¡µé¢å¯¹åº”å…³ç³»
        const themePageMapping = {
            'life': '/tools/life_mode/',
'work': '/tools/work_mode/',
'cyberpunk': '/tools/cyberpunk_mode/',
'training': '/tools/training_mode/',
            'emo': '/tools/emo_mode/'
        };
        
        // è·å–å½“å‰é¡µé¢è·¯å¾„
        function getCurrentPagePath() {
            return window.location.pathname;
        }
        
        // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦åŒ¹é…ä¸»é¢˜
        function isCurrentPageMatchingTheme(theme) {
            const currentPath = getCurrentPagePath();
            const expectedPath = themePageMapping[theme];
            return currentPath === expectedPath;
        }
        
        // ä¸»é¢˜åˆ‡æ¢äº‹ä»¶
        document.addEventListener('click', function(e) {
            if (e.target.closest('.theme-switch')) {
                e.preventDefault();
                const element = e.target.closest('.theme-switch');
                const newTheme = element.dataset.mode;
                
                // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦å·²ç»åŒ¹é…è¯¥ä¸»é¢˜
                if (isCurrentPageMatchingTheme(newTheme)) {
                    // å¦‚æœå½“å‰é¡µé¢å·²ç»åŒ¹é…è¯¥ä¸»é¢˜ï¼Œåªåˆ‡æ¢ä¸»é¢˜æ ·å¼ï¼Œä¸è·³è½¬é¡µé¢
                    if (newTheme !== currentTheme && themeConfig[newTheme]) {
                        switchGlobalTheme(newTheme);
                    } else {
                        showNotification('å½“å‰é¡µé¢å·²ç»æ˜¯è¯¥ä¸»é¢˜æ¨¡å¼', 'info');
                    }
                } else {
                    // å¦‚æœå½“å‰é¡µé¢ä¸åŒ¹é…è¯¥ä¸»é¢˜ï¼Œå…ˆåˆ‡æ¢ä¸»é¢˜ï¼Œç„¶åè·³è½¬åˆ°å¯¹åº”é¡µé¢
                    if (themeConfig[newTheme]) {
                        switchGlobalThemeAndNavigate(newTheme);
                    } else {
                        showNotification('æ— æ•ˆçš„ä¸»é¢˜å‚æ•°', 'error');
                    }
                }
            }
        });
        
        // åˆ‡æ¢ä¸»é¢˜å¹¶è·³è½¬åˆ°å¯¹åº”é¡µé¢
        async function switchGlobalThemeAndNavigate(theme) {
            try {
                // éªŒè¯themeå‚æ•°
                if (!theme || !themeConfig[theme]) {
                    console.error('Invalid theme:', theme);
                    showNotification('æ— æ•ˆçš„ä¸»é¢˜å‚æ•°', 'error');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const themeName = themeConfig[theme].name;
                showNotification(`æ­£åœ¨åˆ‡æ¢åˆ°${themeName}æ¨¡å¼å¹¶è·³è½¬é¡µé¢...`, 'info');
                
                // æ·»åŠ åŠ è½½åŠ¨ç”»
                const badge = document.getElementById('theme-badge');
                if (badge) {
                    badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                
                // æ›´æ–°åç«¯
                const response = await fetch('/users/theme/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ mode: theme })
                });
                
                if (!response.ok) {
                    throw new Error('ä¸»é¢˜åˆ‡æ¢è¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'ä¸»é¢˜åˆ‡æ¢å¤±è´¥');
                }
                
                currentTheme = theme;
                
                // åº”ç”¨ä¸»é¢˜
                applyGlobalTheme(theme);
                updateThemeBadge(theme);
                updateActiveThemeItem(theme);
                
                // åˆ‡æ¢å¯¹åº”çš„ä¸»é¢˜éŸ³ä¹
                loadThemeMusic(theme);
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showNotification(`å·²æˆåŠŸåˆ‡æ¢åˆ°${themeName}æ¨¡å¼`, 'success');
                
                // å»¶è¿Ÿè·³è½¬åˆ°å¯¹åº”é¡µé¢
                setTimeout(() => {
                    const targetPage = themePageMapping[theme];
                    if (targetPage) {
                        window.location.href = targetPage;
                    }
                }, 1000); // 1ç§’åè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åˆ‡æ¢æ•ˆæœ
                
            } catch (error) {
                console.error('Failed to switch theme and navigate:', error);
                showNotification('ä¸»é¢˜åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
                
                // æ¢å¤å¾½ç« æ˜¾ç¤º
                updateThemeBadge(currentTheme);
            }
        }
        
        // åˆ‡æ¢å…¨å±€ä¸»é¢˜
        async function switchGlobalTheme(theme) {
            try {
                // éªŒè¯themeå‚æ•°
                if (!theme || !themeConfig[theme]) {
                    console.error('Invalid theme:', theme);
                    showNotification('æ— æ•ˆçš„ä¸»é¢˜å‚æ•°', 'error');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const themeName = themeConfig[theme].name;
                showNotification(`æ­£åœ¨åˆ‡æ¢åˆ°${themeName}æ¨¡å¼...`, 'info');
                
                // æ·»åŠ åŠ è½½åŠ¨ç”»
                const badge = document.getElementById('theme-badge');
                if (badge) {
                    badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                
                // æ›´æ–°åç«¯
                const response = await fetch('/users/theme/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ mode: theme })
                });
                
                if (!response.ok) {
                    throw new Error('ä¸»é¢˜åˆ‡æ¢è¯·æ±‚å¤±è´¥');
                }
                
                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // å¦‚æœè¿”å›çš„ä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯é‡å®šå‘åˆ°ç™»å½•é¡µé¢
                    throw new Error('è¯·å…ˆç™»å½•åå†åˆ‡æ¢ä¸»é¢˜');
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'ä¸»é¢˜åˆ‡æ¢å¤±è´¥');
                }
                
                currentTheme = theme;
                
                // åº”ç”¨ä¸»é¢˜
                applyGlobalTheme(theme);
                updateThemeBadge(theme);
                updateActiveThemeItem(theme);
                
                // åˆ‡æ¢å¯¹åº”çš„ä¸»é¢˜éŸ³ä¹
                loadThemeMusic(theme);
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showNotification(`å·²æˆåŠŸåˆ‡æ¢åˆ°${themeName}æ¨¡å¼`, 'success');
                
                // æ·»åŠ åˆ‡æ¢åŠ¨ç”»æ•ˆæœ
                document.body.style.transition = 'all 0.5s ease';
                document.body.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    document.body.style.transform = 'scale(1)';
                }, 200);
                
                // ä¸»é¢˜åˆ‡æ¢å®Œæˆï¼Œæ— éœ€åˆ·æ–°é¡µé¢
                
            } catch (error) {
                console.error('Failed to switch theme:', error);
                showNotification('ä¸»é¢˜åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
                
                // æ¢å¤å¾½ç« æ˜¾ç¤º
                updateThemeBadge(currentTheme);
            }
        }
        
        // å¸¦é¡µé¢è·³è½¬çš„ä¸»é¢˜åˆ‡æ¢å‡½æ•°
        async function switchGlobalThemeWithRefresh(theme) {
            try {
                // éªŒè¯themeå‚æ•°
                if (!theme || !themeConfig[theme]) {
                    console.error('Invalid theme:', theme);
                    showNotification('æ— æ•ˆçš„ä¸»é¢˜å‚æ•°', 'error');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const themeName = themeConfig[theme].name;
                showNotification(`æ­£åœ¨åˆ‡æ¢åˆ°${themeName}æ¨¡å¼ï¼Œå³å°†è·³è½¬åˆ°å¯¹åº”é¡µé¢...`, 'info');
                
                // æ·»åŠ åŠ è½½åŠ¨ç”»
                const badge = document.getElementById('theme-badge');
                if (badge) {
                    badge.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                
                // æ›´æ–°åç«¯
                const response = await fetch('/users/theme/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ mode: theme })
                });
                
                if (!response.ok) {
                    throw new Error('ä¸»é¢˜åˆ‡æ¢è¯·æ±‚å¤±è´¥');
                }
                
                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // å¦‚æœè¿”å›çš„ä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯é‡å®šå‘åˆ°ç™»å½•é¡µé¢
                    throw new Error('è¯·å…ˆç™»å½•åå†åˆ‡æ¢ä¸»é¢˜');
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'ä¸»é¢˜åˆ‡æ¢å¤±è´¥');
                }
                
                // ä¸»é¢˜åˆ‡æ¢æˆåŠŸï¼Œè·³è½¬åˆ°å¯¹åº”modeçš„ä¸»é¡µé¢
                setTimeout(() => {
                        const themePages = {
      'life': '/tools/life_mode/',
      'work': '/tools/work_mode/',
      'training': '/tools/training_mode/',
      'emo': '/tools/emo_mode/'
    };
                    const targetPage = themePages[theme] || '/';
                    window.location.href = targetPage;
                }, 800); // å»¶è¿Ÿ800msè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
                
            } catch (error) {
                console.error('Failed to switch theme:', error);
                showNotification('ä¸»é¢˜åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
                
                // æ¢å¤å¾½ç« æ˜¾ç¤º
                updateThemeBadge(currentTheme);
            }
        }
        
        // è·³è½¬åˆ°å½“å‰modeçš„å·¥å…·é¡µé¢
        function goToCurrentModeTools() {
            {% if user.is_authenticated %}
                const currentTheme = localStorage.getItem('currentTheme') || 'work';
                const themePages = {
                    'life': '/tools/life_mode/',
                    'work': '/tools/work_mode/',
                    'training': '/tools/training_mode/',
                    'emo': '/tools/emo_mode/'
                };
                const targetPage = themePages[currentTheme] || '/tools/work_mode/';
                window.location.href = targetPage;
            {% else %}
                // ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = '/users/login/';
            {% endif %}
        }
        
        // éŸ³ä¹ç›¸å…³å‡½æ•°
        async function loadThemeMusic(theme) {
            try {
                const response = await fetch(`/tools/api/music/?mode=${theme}&action=random`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.play_url) {
                    currentSong = data.data;
                    const audio = document.getElementById('theme-music');
                    const source = document.getElementById('music-source');
                    
                    if (audio && source) {
                        source.src = currentSong.play_url;
                        audio.load();
                        
                        // æ›´æ–°éŸ³ä¹ä¿¡æ¯æ˜¾ç¤º
                        if (typeof updateMusicInfo === 'function') {
                            updateMusicInfo();
                        }
                        
                        // å¦‚æœä¹‹å‰æ­£åœ¨æ’­æ”¾ï¼Œç»§ç»­æ’­æ”¾
                        if (isMusicPlaying) {
                            audio.play();
                        }
                    }
                } else {
                    console.log('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¸»é¢˜éŸ³ä¹æˆ–ç¼ºå°‘æ’­æ”¾URL');
                }
            } catch (error) {
                console.error('åŠ è½½ä¸»é¢˜éŸ³ä¹å¤±è´¥:', error);
            }
        }
        
        function toggleMusic() {
            const audio = document.getElementById('theme-music');
            
            if (audio.paused) {
                audio.play();
                isMusicPlaying = true;
                document.getElementById('music-play-icon').className = 'fas fa-pause';
            } else {
                audio.pause();
                isMusicPlaying = false;
                document.getElementById('music-play-icon').className = 'fas fa-play';
            }
        }
        
        async function nextSong() {
            try {
                const response = await fetch('/tools/api/next_song/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ mode: currentTheme })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentSong = data.next_song;
                    const audio = document.getElementById('theme-music');
                    const source = document.getElementById('music-source');
                    
                    source.src = currentSong.url;
                    audio.load();
                    
                    // æ›´æ–°éŸ³ä¹ä¿¡æ¯æ˜¾ç¤º
                    updateMusicInfo();
                    
                    // å¦‚æœä¹‹å‰æ­£åœ¨æ’­æ”¾ï¼Œç»§ç»­æ’­æ”¾
                    if (isMusicPlaying) {
                        audio.play();
                    }
                    
                    showNotification('å·²åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–æ­Œæ›²', 'success');
                }
            } catch (error) {
                console.error('åˆ‡æ¢æ­Œæ›²å¤±è´¥:', error);
                showNotification('åˆ‡æ¢æ­Œæ›²å¤±è´¥', 'error');
            }
        }
        
        function updateMusicInfo() {
            if (currentSong) {
                document.getElementById('music-title').textContent = currentSong.title || currentSong.name;
                document.getElementById('music-artist').textContent = currentSong.artist;
                
                const coverImg = document.getElementById('music-cover-img');
                if (currentSong.pic_url) {
                    coverImg.src = currentSong.pic_url;
                    coverImg.style.display = 'block';
                } else {
                    coverImg.style.display = 'none';
                }
            }
        }
        
        function toggleMusicInfo() {
            const musicInfo = document.getElementById('music-info');
            musicInfoVisible = !musicInfoVisible;
            
            if (musicInfoVisible) {
                musicInfo.style.display = 'block';
                updateMusicInfo();
            } else {
                musicInfo.style.display = 'none';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–éŸ³ä¹
        document.addEventListener('DOMContentLoaded', function() {
            // éšè—é¡µé¢åŠ è½½åŠ¨ç”»
            setTimeout(() => {
                const loader = document.getElementById('pageLoader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 500);
                }
            }, 1000);

            // åˆå§‹åŒ–ç²’å­æ•ˆæœ
            initParticles();

            // åˆå§‹åŒ–é¼ æ ‡è·Ÿéšæ•ˆæœ
            initCursorFollower();

            // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
            const audio = document.getElementById('theme-music');
            
            audio.addEventListener('play', function() {
                isMusicPlaying = true;
                document.getElementById('music-play-icon').className = 'fas fa-pause';
            });
            
            audio.addEventListener('pause', function() {
                isMusicPlaying = false;
                document.getElementById('music-play-icon').className = 'fas fa-play';
            });
            
            audio.addEventListener('ended', function() {
                // æ­Œæ›²æ’­æ”¾ç»“æŸåè‡ªåŠ¨ä¸‹ä¸€é¦–
                nextSong();
            });
            
            // åŠ è½½å½“å‰ä¸»é¢˜çš„éŸ³ä¹
            loadThemeMusic(currentTheme);
            
                    // åˆå§‹åŒ–ä¸»é¢˜åˆ‡æ¢å¿«æ·é”®
        initThemeShortcuts();
        
        // åˆå§‹åŒ–å¤´åƒç¼–è¾‘åŠŸèƒ½
        initAvatarEdit();
        
        // åˆå§‹åŒ–è¯­è¨€åˆ‡æ¢åŠŸèƒ½
        initLanguageSwitch();
    });
        // åˆå§‹åŒ–ç²’å­æ•ˆæœ
        function initParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;

            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // åˆå§‹åŒ–åŠ¨æ€é¼ æ ‡å…‰æ ‡æ•ˆæœ
        function initCursorFollower() {
            const cursor = document.getElementById('customCursor');
            if (!cursor) return;

            let mouseX = 0;
            let mouseY = 0;
            let cursorX = 0;
            let cursorY = 0;
            let isVisible = false;

            // é¼ æ ‡è¿›å…¥é¡µé¢æ—¶æ˜¾ç¤ºå…‰æ ‡
            document.addEventListener('mouseenter', () => {
                isVisible = true;
                cursor.style.opacity = '1';
            });

            // é¼ æ ‡ç¦»å¼€é¡µé¢æ—¶éšè—å…‰æ ‡
            document.addEventListener('mouseleave', () => {
                isVisible = false;
                cursor.style.opacity = '0';
            });

            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                
                if (!isVisible) {
                    isVisible = true;
                    cursor.style.opacity = '1';
                }
            });

            document.addEventListener('mousedown', () => {
                cursor.classList.add('active');
            });

            document.addEventListener('mouseup', () => {
                cursor.classList.remove('active');
            });

            // ä¸ºé“¾æ¥å’ŒæŒ‰é’®æ·»åŠ æ‚¬åœæ•ˆæœ
            const interactiveElements = document.querySelectorAll('a, button, .nav-link, .btn, .dropdown-item');
            interactiveElements.forEach(element => {
                element.addEventListener('mouseenter', () => {
                    cursor.classList.add('hover');
                });
                
                element.addEventListener('mouseleave', () => {
                    cursor.classList.remove('hover');
                });
            });

            // å¹³æ»‘è·ŸéšåŠ¨ç”»
            function animateCursor() {
                if (isVisible) {
                    cursorX += (mouseX - cursorX) * 0.15;
                    cursorY += (mouseY - cursorY) * 0.15;
                    
                    cursor.style.left = cursorX + 'px';
                    cursor.style.top = cursorY + 'px';
                }
                
                requestAnimationFrame(animateCursor);
            }
            
            animateCursor();
        }
        
        // ä¸»é¢˜åˆ‡æ¢å¿«æ·é”®
        function initThemeShortcuts() {
            document.addEventListener('keydown', function(e) {
                // åªåœ¨éè¾“å…¥æ¡†ä¸­å“åº”å¿«æ·é”®
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                // Ctrl/Cmd + æ•°å­—é”®åˆ‡æ¢ä¸»é¢˜
                if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            {% if user.is_authenticated %}
                                switchGlobalThemeWithRefresh('life');
                            {% else %}
                                showNotification('è¯·å…ˆç™»å½•åå†ä½¿ç”¨å¿«æ·é”®åˆ‡æ¢ä¸»é¢˜', 'warning');
                            {% endif %}
                            break;
                        case '2':
                            e.preventDefault();
                            {% if user.is_authenticated %}
                                switchGlobalThemeWithRefresh('work');
                            {% else %}
                                showNotification('è¯·å…ˆç™»å½•åå†ä½¿ç”¨å¿«æ·é”®åˆ‡æ¢ä¸»é¢˜', 'warning');
                            {% endif %}
                            break;
                        case '3':
                            e.preventDefault();
                            {% if user.is_authenticated %}
                                switchGlobalThemeWithRefresh('training');
                            {% else %}
                                showNotification('è¯·å…ˆç™»å½•åå†ä½¿ç”¨å¿«æ·é”®åˆ‡æ¢ä¸»é¢˜', 'warning');
                            {% endif %}
                            break;
                        case '4':
                            e.preventDefault();
                            {% if user.is_authenticated %}
                                switchGlobalThemeWithRefresh('emo');
                            {% else %}
                                showNotification('è¯·å…ˆç™»å½•åå†ä½¿ç”¨å¿«æ·é”®åˆ‡æ¢ä¸»é¢˜', 'warning');
                            {% endif %}
                            break;
                    }
                }
            });
        }
        
        // å¤´åƒç¼–è¾‘åŠŸèƒ½
        function editAvatar() {
            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadAvatar(file);
                }
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // ä¸Šä¼ å¤´åƒ
        function uploadAvatar(file) {
            const formData = new FormData();
            formData.append('avatar', file);
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            showUploadProgress();
            
            fetch('/users/upload_avatar/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideUploadProgress();
                if (data.success) {
                    // æ›´æ–°é¡µé¢ä¸Šçš„å¤´åƒæ˜¾ç¤º
                    updateAvatarDisplay(data.avatar_url);
                    showMessage('å¤´åƒä¸Šä¼ æˆåŠŸï¼', 'success');
                } else {
                    showMessage(data.message || 'å¤´åƒä¸Šä¼ å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                hideUploadProgress();
                console.error('Upload error:', error);
                showMessage('å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            });
        }
        
        // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
        function showUploadProgress() {
            const progress = document.createElement('div');
            progress.id = 'upload-progress';
            progress.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: rgba(0,0,0,0.9); color: white; padding: 20px; border-radius: 10px; 
                     z-index: 9999; text-align: center;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div style="margin-top: 10px;">æ­£åœ¨ä¸Šä¼ å¤´åƒ...</div>
                </div>
            `;
            document.body.appendChild(progress);
        }
        
        // éšè—ä¸Šä¼ è¿›åº¦
        function hideUploadProgress() {
            const progress = document.getElementById('upload-progress');
            if (progress) {
                document.body.removeChild(progress);
            }
        }
        
        // æ›´æ–°å¤´åƒæ˜¾ç¤º
        function updateAvatarDisplay(avatarUrl) {
            // æ›´æ–°å¯¼èˆªæ ä¸­çš„å¤´åƒ
            const navAvatar = document.getElementById('user-avatar');
            if (navAvatar) {
                navAvatar.src = avatarUrl;
            }
            
            // æ›´æ–°æ‰€æœ‰å¸¦æœ‰user-avatarç±»çš„å¤´åƒ
            const avatarElements = document.querySelectorAll('.user-avatar');
            avatarElements.forEach(element => {
                element.src = avatarUrl;
            });
            
            // æ›´æ–°ä¸ªäººèµ„æ–™é¡µé¢çš„å¤´åƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const profileAvatar = document.getElementById('profile-avatar');
            if (profileAvatar) {
                profileAvatar.src = avatarUrl;
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: ${type === 'success' ? '#28a745' : '#dc3545'}; 
                color: white; padding: 15px 20px; border-radius: 5px; 
                z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    document.body.removeChild(messageDiv);
                }
            }, 3000);
        }
        
        // åˆå§‹åŒ–å¤´åƒç¼–è¾‘åŠŸèƒ½
        function initAvatarEdit() {
            const editAvatarBtn = document.getElementById('edit-avatar-btn');
            if (editAvatarBtn) {
                editAvatarBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    editAvatar();
                });
            }
        }
        
        // åˆå§‹åŒ–è¯­è¨€åˆ‡æ¢åŠŸèƒ½
        function initLanguageSwitch() {
            const languageSwitches = document.querySelectorAll('.language-switch');
            
            languageSwitches.forEach(switch_ => {
                switch_.addEventListener('click', function(e) {
                    e.preventDefault();
                    const lang = this.getAttribute('data-lang');
                    switchLanguage(lang);
                });
            });
            
            // ä»localStorageåŠ è½½ä¿å­˜çš„è¯­è¨€è®¾ç½®
            const savedLang = localStorage.getItem('preferred-language') || 'zh';
            switchLanguage(savedLang, false); // falseè¡¨ç¤ºä¸ä¿å­˜åˆ°localStorage
        }
        
        // è¯­è¨€åˆ‡æ¢å‡½æ•°
        function switchLanguage(lang, saveToStorage = true) {
            // æ›´æ–°æŒ‡ç¤ºå™¨æ˜¾ç¤º
            document.querySelectorAll('.language-indicator').forEach(indicator => {
                indicator.style.display = 'none';
            });
            
            if (lang === 'zh') {
                document.getElementById('zh-indicator').style.display = 'inline';
                translateToChinese();
            } else if (lang === 'en') {
                document.getElementById('en-indicator').style.display = 'inline';
                translateToEnglish();
            }
            
            // ä¿å­˜è¯­è¨€è®¾ç½®åˆ°localStorage
            if (saveToStorage) {
                localStorage.setItem('preferred-language', lang);
            }
        }
        
        // ç¿»è¯‘ä¸ºä¸­æ–‡
        function translateToChinese() {
            const translations = {
                // å¯¼èˆªæ 
                'QATOOLBOX': 'ModeShift',
                'ä¸“æ³¨æŠ€æœ¯ï¼Œè¿½æ±‚å“è¶Š': 'ä¸“æ³¨æŠ€æœ¯ï¼Œè¿½æ±‚å“è¶Š',
                'å·¥å…·é›†': 'å·¥å…·é›†',
                'æˆ‘çš„å»ºè®®': 'æˆ‘çš„å»ºè®®',
                'å…³äº': 'å…³äº',
                'ç®¡ç†æ§åˆ¶å°': 'ç®¡ç†æ§åˆ¶å°',
                'ä»ªè¡¨æ¿': 'ä»ªè¡¨æ¿',
                'å…¬å‘Šç®¡ç†': 'å…¬å‘Šç®¡ç†',
                'å»ºè®®ç®¡ç†': 'å»ºè®®ç®¡ç†',
                'åé¦ˆç®¡ç†': 'åé¦ˆç®¡ç†',
                'ç”¨æˆ·ç®¡ç†': 'ç”¨æˆ·ç®¡ç†',
                'ç”¨æˆ·ç›‘æ§': 'ç”¨æˆ·ç›‘æ§',
                'æ“ä½œæ—¥å¿—': 'æ“ä½œæ—¥å¿—',
                'ç¼–è¾‘å¤´åƒ': 'ç¼–è¾‘å¤´åƒ',
                'ä¸ªäººèµ„æ–™': 'ä¸ªäººèµ„æ–™',
                'ç•Œé¢æ¨¡å¼': 'ç•Œé¢æ¨¡å¼',

                'ç”Ÿæ´»æ¨¡å¼': 'ç”Ÿæ´»æ¨¡å¼',
                'æå®¢æ¨¡å¼': 'æå®¢æ¨¡å¼',
                'ç‹‚æš´æ¨¡å¼': 'ç‹‚æš´æ¨¡å¼',
                'Emoæ¨¡å¼': 'Emoæ¨¡å¼',
                'å¿«é€Ÿç®¡ç†': 'å¿«é€Ÿç®¡ç†',
                'ç™»å‡º': 'ç™»å‡º',
                'ç™»å½•': 'ç™»å½•',
                'æ³¨å†Œ': 'æ³¨å†Œ',
                
                // è®¾ç½®èœå•
                'éŸ³ä¹æ§åˆ¶': 'éŸ³ä¹æ§åˆ¶',
                'æ’­æ”¾/æš‚åœéŸ³ä¹': 'æ’­æ”¾/æš‚åœéŸ³ä¹',
                'ä¸‹ä¸€é¦–æ­Œæ›²': 'ä¸‹ä¸€é¦–æ­Œæ›²',
                'æ˜¾ç¤º/éšè—éŸ³ä¹ä¿¡æ¯': 'æ˜¾ç¤º/éšè—éŸ³ä¹ä¿¡æ¯',
                'ç³»ç»Ÿè®¾ç½®': 'ç³»ç»Ÿè®¾ç½®',
                'æ„è§åé¦ˆ': 'æ„è§åé¦ˆ',
                'è¯­è¨€è®¾ç½®': 'è¯­è¨€è®¾ç½®',
                
                // ä¸»é¡µå†…å®¹
                'å·¥å…·ç®±': 'å·¥å…·ç®±',
                'å›å­ç”Ÿéå¼‚ä¹Ÿï¼Œå–„å‡äºç‰©ä¹Ÿã€‚': 'å›å­ç”Ÿéå¼‚ä¹Ÿï¼Œå–„å‡äºç‰©ä¹Ÿã€‚',
                'å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚': 'å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚',
                'å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹ã€‚': 'å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹ã€‚',
                'çŸ¥ä¹‹è€…ä¸å¦‚å¥½ä¹‹è€…ï¼Œå¥½ä¹‹è€…ä¸å¦‚ä¹ä¹‹è€…ã€‚': 'çŸ¥ä¹‹è€…ä¸å¦‚å¥½ä¹‹è€…ï¼Œå¥½ä¹‹è€…ä¸å¦‚ä¹ä¹‹è€…ã€‚',
                'è¿›å…¥å¤–ä¸–ç•Œ': 'è¿›å…¥å¤–ä¸–ç•Œ'
            };
            
            applyTranslations(translations);
        }
        
        // ç¿»è¯‘ä¸ºè‹±æ–‡
        function translateToEnglish() {
            const translations = {
                // å¯¼èˆªæ 
                'QATOOLBOX': 'ModeShift',
                'ä¸“æ³¨æŠ€æœ¯ï¼Œè¿½æ±‚å“è¶Š': 'Focus on Technology, Pursue Excellence',
                'å·¥å…·é›†': 'Tools',
                'æˆ‘çš„å»ºè®®': 'My Suggestions',
                'å…³äº': 'About',
                'ç®¡ç†æ§åˆ¶å°': 'Admin Console',
                'ä»ªè¡¨æ¿': 'Dashboard',
                'å…¬å‘Šç®¡ç†': 'Announcements',
                'å»ºè®®ç®¡ç†': 'Suggestions',
                'åé¦ˆç®¡ç†': 'Feedback',
                'ç”¨æˆ·ç®¡ç†': 'User Management',
                'ç”¨æˆ·ç›‘æ§': 'User Monitoring',
                'æ“ä½œæ—¥å¿—': 'Operation Logs',
                'ç¼–è¾‘å¤´åƒ': 'Edit Avatar',
                'ä¸ªäººèµ„æ–™': 'Profile',
                'ç•Œé¢æ¨¡å¼': 'Interface Mode',

                'ç”Ÿæ´»æ¨¡å¼': 'Life Mode',
                'æå®¢æ¨¡å¼': 'Geek Mode',
                'ç‹‚æš´æ¨¡å¼': 'Rage Mode',
                'Emoæ¨¡å¼': 'Emo Mode',
                'å¿«é€Ÿç®¡ç†': 'Quick Admin',
                'ç™»å‡º': 'Logout',
                'ç™»å½•': 'Login',
                'æ³¨å†Œ': 'Register',
                
                // è®¾ç½®èœå•
                'éŸ³ä¹æ§åˆ¶': 'Music Control',
                'æ’­æ”¾/æš‚åœéŸ³ä¹': 'Play/Pause Music',
                'ä¸‹ä¸€é¦–æ­Œæ›²': 'Next Song',
                'æ˜¾ç¤º/éšè—éŸ³ä¹ä¿¡æ¯': 'Show/Hide Music Info',
                'ç³»ç»Ÿè®¾ç½®': 'System Settings',
                'æ„è§åé¦ˆ': 'Feedback',
                'è¯­è¨€è®¾ç½®': 'Language Settings',
                
                // ä¸»é¡µå†…å®¹
                'å·¥å…·ç®±': 'Toolbox',
                'å›å­ç”Ÿéå¼‚ä¹Ÿï¼Œå–„å‡äºç‰©ä¹Ÿã€‚': 'A gentleman is not different by nature, but good at using tools.',
                'å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚': 'To do a good job, one must first sharpen one\'s tools.',
                'å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹ã€‚': 'Is it not pleasant to learn and practice what you have learned?',
                'çŸ¥ä¹‹è€…ä¸å¦‚å¥½ä¹‹è€…ï¼Œå¥½ä¹‹è€…ä¸å¦‚ä¹ä¹‹è€…ã€‚': 'Those who know are not as good as those who love, and those who love are not as good as those who enjoy.',
                'è¿›å…¥å¤–ä¸–ç•Œ': 'Enter Outer World'
            };
            
            applyTranslations(translations);
        }
        
        // åº”ç”¨ç¿»è¯‘
        function applyTranslations(translations) {
            // éå†æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
            function walkTextNodes(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent.trim();
                    if (translations[text]) {
                        node.textContent = translations[text];
                    }
                } else {
                    for (let child of node.childNodes) {
                        walkTextNodes(child);
                    }
                }
            }
            
            // ä»bodyå¼€å§‹éå†
            walkTextNodes(document.body);
            
            // ç‰¹æ®Šå¤„ç†ä¸€äº›å…ƒç´ 
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[key]) {
                    element.textContent = translations[key];
                }
            });
        }
        
        // è·å–CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // å¤´åƒç‚¹å‡»åŠŸèƒ½ - æŸ¥çœ‹å¤´åƒå’Œé‡Œä¸–ç•Œå…¥å£
        document.addEventListener('DOMContentLoaded', function() {
            const userAvatar = document.getElementById('user-avatar');
            if (userAvatar) {
                let clickCount = 0;
                let clickTimer = null;
                let avatarPopup = null;
                
                userAvatar.addEventListener('click', function(e) {
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘ä¸‹æ‹‰èœå•
                    e.stopPropagation();
                    
                    clickCount++;
                    
                    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                    if (clickTimer) {
                        clearTimeout(clickTimer);
                    }
                    
                    // è®¾ç½®3ç§’åé‡ç½®ç‚¹å‡»è®¡æ•°
                    clickTimer = setTimeout(() => {
                        clickCount = 0;
                    }, 3000);
                    
                    // ç‚¹å‡»åé¦ˆæ•ˆæœ
                    this.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 200);
                    
                    // ç¬¬ä¸€æ¬¡ç‚¹å‡»æ˜¾ç¤ºå¤´åƒå¼¹çª—
                    if (clickCount === 1) {
                        showAvatarPopup(this.src, e);
                    }
                    // ç¬¬äºŒåæ¬¡ç‚¹å‡»è¿›å…¥é‡Œä¸–ç•Œ
                    else if (clickCount === 20) {
                        // é‡ç½®è®¡æ•°
                        clickCount = 0;
                        clearTimeout(clickTimer);
                        
                        // æ˜¾ç¤ºè¿›å…¥é‡Œä¸–ç•Œçš„åŠ¨ç”»æ•ˆæœ
                        this.style.animation = 'glitch 0.5s infinite';
                        this.style.filter = 'hue-rotate(180deg) brightness(1.5)';
                        
                        setTimeout(() => {
                            // è·³è½¬åˆ°é‡Œä¸–ç•Œé¡µé¢
                            window.location.href = '{% url "tools:vanity_os_dashboard" %}';
                        }, 1000);
                    }
                });
                
                // æ˜¾ç¤ºå¤´åƒå¼¹çª—
                function showAvatarPopup(avatarSrc, event) {
                    // ç§»é™¤ä¹‹å‰çš„å¼¹çª—
                    if (avatarPopup) {
                        document.body.removeChild(avatarPopup);
                    }
                    
                    // åˆ›å»ºå¼¹çª—
                    avatarPopup = document.createElement('div');
                    avatarPopup.className = 'avatar-popup';
                    avatarPopup.innerHTML = `<img src="${avatarSrc}" alt="å¤´åƒ">`;
                    
                    // è®¾ç½®å¼¹çª—ä½ç½®ï¼ˆåœ¨ç‚¹å‡»ä½ç½®é™„è¿‘ï¼‰
                    const rect = event.target.getBoundingClientRect();
                    avatarPopup.style.left = (rect.left + rect.width + 10) + 'px';
                    avatarPopup.style.top = (rect.top - 50) + 'px';
                    
                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(avatarPopup);
                    
                    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        if (avatarPopup && avatarPopup.parentNode) {
                            avatarPopup.parentNode.removeChild(avatarPopup);
                            avatarPopup = null;
                        }
                    }, 3000);
                }
                
                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å¼¹çª—
                document.addEventListener('click', function(e) {
                    if (avatarPopup && !avatarPopup.contains(e.target) && e.target !== userAvatar) {
                        avatarPopup.parentNode.removeChild(avatarPopup);
                        avatarPopup = null;
                    }
                });
            }
        });
        
        // æ”¹è¿›çš„æ–‡ä»¶ä¸Šä¼ æ ·å¼
        
        // èµ›åšå“¥ç‰¹æ•…éšœè‰ºæœ¯åˆ‡æ¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            let glitchLevel = 0;
            let glitchTimer = null;
            
            // ç›‘å¬é¡µé¢ç‚¹å‡»äº‹ä»¶
            document.addEventListener('click', function(e) {
                // å¦‚æœå½“å‰æ˜¯èµ›åšå“¥ç‰¹ä¸»é¢˜ï¼Œæ‰å¯ç”¨æ•…éšœè‰ºæœ¯åˆ‡æ¢
                if (document.body.classList.contains('cyberpunk-theme')) {
                    // æ’é™¤ä¸€äº›ä¸éœ€è¦è§¦å‘æ•…éšœè‰ºæœ¯åˆ‡æ¢çš„å…ƒç´ 
                    if (e.target.closest('.nav-link') || 
                        e.target.closest('.dropdown-menu') || 
                        e.target.closest('.btn') ||
                        e.target.closest('.form-control') ||
                        e.target.closest('.theme-switch')) {
                        return;
                    }
                    
                    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                    if (glitchTimer) {
                        clearTimeout(glitchTimer);
                    }
                    
                    // å¢åŠ æ•…éšœç­‰çº§
                    glitchLevel = (glitchLevel + 1) % 4; // 0, 1, 2, 3
                    
                    // ç§»é™¤æ‰€æœ‰æ•…éšœç­‰çº§ç±»
                    document.body.classList.remove('glitch-level-1', 'glitch-level-2', 'glitch-level-3');
                    
                    // æ·»åŠ æ–°çš„æ•…éšœç­‰çº§ç±»
                    if (glitchLevel > 0) {
                        document.body.classList.add('glitch-level-' + glitchLevel);
                        
                        // æ·»åŠ æ•…éšœéŸ³æ•ˆï¼ˆå¯é€‰ï¼‰
                        playGlitchSound(glitchLevel);
                    }
                    
                    // è®¾ç½®5ç§’åè‡ªåŠ¨é‡ç½®æ•…éšœç­‰çº§
                    glitchTimer = setTimeout(() => {
                        glitchLevel = 0;
                        document.body.classList.remove('glitch-level-1', 'glitch-level-2', 'glitch-level-3');
                    }, 5000);
                }
            });
            
            // æ•…éšœéŸ³æ•ˆå‡½æ•°ï¼ˆå¯é€‰ï¼‰
            function playGlitchSound(level) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ•…éšœéŸ³æ•ˆ
                // ç”±äºæµè§ˆå™¨é™åˆ¶ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³é¢‘
                console.log('æ•…éšœç­‰çº§:', level);
            }
            
            // ä¸»é¢˜åˆ‡æ¢æ—¶é‡ç½®æ•…éšœç­‰çº§
            const originalApplyGlobalTheme = window.applyGlobalTheme;
            window.applyGlobalTheme = function(theme) {
                if (originalApplyGlobalTheme) {
                    originalApplyGlobalTheme(theme);
                }
                
                // å¦‚æœåˆ‡æ¢åˆ°éèµ›åšå“¥ç‰¹ä¸»é¢˜ï¼Œé‡ç½®æ•…éšœç­‰çº§
                if (!document.body.classList.contains('cyberpunk-theme')) {
                    glitchLevel = 0;
                    document.body.classList.remove('glitch-level-1', 'glitch-level-2', 'glitch-level-3');
                }
            };
        });
        // å¯¼èˆªæ ä¼˜åŒ–åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebarBackdrop = document.getElementById('sidebarBackdrop');
            const navbar = document.querySelector('.navbar-collapse');
            const navbarElement = document.querySelector('.navbar');
            
            // å¯¼èˆªæ æ»šåŠ¨æ•ˆæœ
            function handleNavbarScroll() {
                if (window.scrollY > 50) {
                    navbarElement.classList.add('scrolled');
                } else {
                    navbarElement.classList.remove('scrolled');
                }
            }
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            window.addEventListener('scroll', handleNavbarScroll);
            
            // å¯¼èˆªé“¾æ¥æ¿€æ´»çŠ¶æ€
            function setActiveNavLink() {
                const currentPath = window.location.pathname;
                const navLinks = document.querySelectorAll('.nav-link');
                
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === currentPath || 
                        (currentPath === '/' && link.getAttribute('href') === '{% url "home" %}')) {
                        link.classList.add('active');
                    }
                });
            }
            
            // è®¾ç½®å½“å‰é¡µé¢æ¿€æ´»çŠ¶æ€
            setActiveNavLink();
            
            // åˆå§‹åŒ–Bootstrapä¸‹æ‹‰èœå•
            function initBootstrapDropdowns() {
                if (typeof window.$ !== 'undefined') {
                    // è®©Bootstrapå¤„ç†ä¸‹æ‹‰èœå•
                    $('.dropdown-toggle').dropdown();
                    
                    // ç¡®ä¿dropdownäº‹ä»¶æ­£å¸¸å·¥ä½œ
                    $('.dropdown-toggle').on('click', function(e) {
                        e.stopPropagation();
                        const $dropdown = $(this).closest('.dropdown');
                        
                        // å…³é—­å…¶ä»–ä¸‹æ‹‰èœå•
                        $('.dropdown').not($dropdown).removeClass('show').find('.dropdown-menu').removeClass('show');
                        
                        // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
                        $dropdown.toggleClass('show');
                        $dropdown.find('.dropdown-menu').toggleClass('show');
                    });
                } else {
                    console.log('jQueryæœªåŠ è½½ï¼Œä½¿ç”¨å¤‡ç”¨ä¸‹æ‹‰èœå•æ–¹æ¡ˆ');
                }
            }
            
            // DOMå†…å®¹åŠ è½½å®Œæˆååˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initBootstrapDropdowns);
            } else {
                initBootstrapDropdowns();
            }
            
            // å¦‚æœBootstrapä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            if (typeof window.bootstrap === 'undefined' && typeof window.$ === 'undefined') {
                const dropdowns = document.querySelectorAll('.dropdown');
                dropdowns.forEach(dropdown => {
                    const toggle = dropdown.querySelector('.dropdown-toggle');
                    const menu = dropdown.querySelector('.dropdown-menu');
                    
                    if (toggle && menu) {
                        toggle.addEventListener('click', (e) => {
                            e.stopPropagation();
                            
                            // å…³é—­å…¶ä»–ä¸‹æ‹‰èœå•
                            dropdowns.forEach(otherDropdown => {
                                if (otherDropdown !== dropdown) {
                                    otherDropdown.classList.remove('show');
                                    const otherMenu = otherDropdown.querySelector('.dropdown-menu');
                                    if (otherMenu) otherMenu.classList.remove('show');
                                }
                            });
                            
                            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
                            dropdown.classList.toggle('show');
                            menu.classList.toggle('show');
                        });
                    }
                });
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', () => {
                    dropdowns.forEach(dropdown => {
                        dropdown.classList.remove('show');
                        const menu = dropdown.querySelector('.dropdown-menu');
                        if (menu) menu.classList.remove('show');
                    });
                });
            }
            
            if (mobileMenuBtn && navbar) {
                // ç§»åŠ¨ç«¯èœå•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                mobileMenuBtn.addEventListener('click', function() {
                    navbar.classList.toggle('show');
                    sidebarBackdrop.classList.toggle('show');
                    document.body.style.overflow = navbar.classList.contains('show') ? 'hidden' : '';
                    
                    // æ·»åŠ æŒ‰é’®åŠ¨ç”»
                    const icon = mobileMenuBtn.querySelector('i');
                    if (icon) {
                        icon.style.transform = navbar.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
                    }
                });
                
                // èƒŒæ™¯ç‚¹å‡»å…³é—­èœå•
                sidebarBackdrop.addEventListener('click', function() {
                    navbar.classList.remove('show');
                    sidebarBackdrop.classList.remove('show');
                    document.body.style.overflow = '';
                    
                    // é‡ç½®æŒ‰é’®åŠ¨ç”»
                    const icon = mobileMenuBtn.querySelector('i');
                    if (icon) {
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
                
                // èœå•é¡¹ç‚¹å‡»åå…³é—­èœå•
                const navLinks = navbar.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        if (window.innerWidth <= 768) {
                            navbar.classList.remove('show');
                            sidebarBackdrop.classList.remove('show');
                            document.body.style.overflow = '';
                            
                            // é‡ç½®æŒ‰é’®åŠ¨ç”»
                            const icon = mobileMenuBtn.querySelector('i');
                            if (icon) {
                                icon.style.transform = 'rotate(0deg)';
                            }
                        }
                    });
                });
                
                // çª—å£å¤§å°æ”¹å˜æ—¶å¤„ç†èœå•çŠ¶æ€
                window.addEventListener('resize', function() {
                    if (window.innerWidth > 768) {
                        navbar.classList.remove('show');
                        sidebarBackdrop.classList.remove('show');
                        document.body.style.overflow = '';
                        
                        // é‡ç½®æŒ‰é’®åŠ¨ç”»
                        const icon = mobileMenuBtn.querySelector('i');
                        if (icon) {
                            icon.style.transform = 'rotate(0deg)';
                        }
                    }
                });
            }
            
            // é”®ç›˜å¿«æ·é”®æ”¯æŒ
            document.addEventListener('keydown', function(e) {
                // ESCé”®å…³é—­ç§»åŠ¨ç«¯èœå•
                if (e.key === 'Escape' && navbar && navbar.classList.contains('show')) {
                    navbar.classList.remove('show');
                    sidebarBackdrop.classList.remove('show');
                    document.body.style.overflow = '';
                }
                
                // Ctrl+M åˆ‡æ¢ç§»åŠ¨ç«¯èœå•
                if (e.ctrlKey && e.key === 'm' && mobileMenuBtn) {
                    e.preventDefault();
                    mobileMenuBtn.click();
                }
            });
        });
    </script>
    
    <!-- WebSocketè¿æ¥ä¿®å¤è„šæœ¬ -->
    <script>
    // WebSocketè¿æ¥ä¿®å¤è„šæœ¬
    // è§£å†³WebSocketè¿æ¥åˆ°é”™è¯¯ç«¯å£çš„é—®é¢˜
    (function() {
        'use strict';
        
        console.log('ğŸ”§ WebSocketè¿æ¥ä¿®å¤è„šæœ¬å·²åŠ è½½');
        
        // åˆ›å»ºURLä¿®å¤å‡½æ•°
        function fixWebSocketUrl(url) {
            if (url && typeof url === 'string') {
                // å¦‚æœURLåŒ…å«8001ç«¯å£ï¼Œæ›¿æ¢ä¸º8000ç«¯å£
                if (url.includes('localhost:8001') || url.includes('127.0.0.1:8001')) {
                    const fixedUrl = url.replace(/localhost:8001|127\.0\.0\.1:8001/g, 'localhost:8000');
                    console.log('ğŸ”§ ä¿®å¤WebSocket URL:', url, '->', fixedUrl);
                    return fixedUrl;
                }
                
                // å¦‚æœURLåŒ…å«8001ç«¯å£ä½†æ²¡æœ‰localhostï¼Œä¹Ÿè¿›è¡Œä¿®å¤
                if (url.includes(':8001/')) {
                    const fixedUrl = url.replace(/:8001\//g, ':8000/');
                    console.log('ğŸ”§ ä¿®å¤WebSocket URL:', url, '->', fixedUrl);
                    return fixedUrl;
                }
            }
            return url;
        }
        
        // ä¿å­˜åŸå§‹çš„WebSocketæ„é€ å‡½æ•°
        const OriginalWebSocket = window.WebSocket;
        
        // åˆ›å»ºæ–°çš„WebSocketæ„é€ å‡½æ•°
        function FixedWebSocket(url, protocols) {
            console.log('ğŸ”§ æ‹¦æˆªWebSocketè¿æ¥:', url);
            
            // ä¿®å¤URL
            const fixedUrl = fixWebSocketUrl(url);
            
            // åˆ›å»ºWebSocketè¿æ¥
            const ws = new OriginalWebSocket(fixedUrl, protocols);
            
            // æ·»åŠ è¿æ¥çŠ¶æ€æ—¥å¿—
            ws.addEventListener('open', function(event) {
                console.log('âœ… WebSocketè¿æ¥æˆåŠŸ:', fixedUrl);
            });
            
            ws.addEventListener('error', function(error) {
                console.error('âŒ WebSocketè¿æ¥é”™è¯¯:', fixedUrl, error);
            });
            
            ws.addEventListener('close', function(event) {
                console.log('ğŸ”Œ WebSocketè¿æ¥å…³é—­:', fixedUrl, event.code, event.reason);
            });
            
            return ws;
        }
        
        // è®¾ç½®åŸå‹é“¾
        FixedWebSocket.prototype = OriginalWebSocket.prototype;
        
        // å¤åˆ¶é™æ€å±æ€§ï¼ˆåªè¯»å±æ€§ï¼Œä½¿ç”¨Object.definePropertyï¼‰
        Object.defineProperty(FixedWebSocket, 'CONNECTING', {
            value: OriginalWebSocket.CONNECTING,
            writable: false,
            enumerable: true,
            configurable: false
        });
        
        Object.defineProperty(FixedWebSocket, 'OPEN', {
            value: OriginalWebSocket.OPEN,
            writable: false,
            enumerable: true,
            configurable: false
        });
        
        Object.defineProperty(FixedWebSocket, 'CLOSING', {
            value: OriginalWebSocket.CLOSING,
            writable: false,
            enumerable: true,
            configurable: false
        });
        
        Object.defineProperty(FixedWebSocket, 'CLOSED', {
            value: OriginalWebSocket.CLOSED,
            writable: false,
            enumerable: true,
            configurable: false
        });
        
        // æ›¿æ¢å…¨å±€WebSocket
        window.WebSocket = FixedWebSocket;
        
        console.log('âœ… WebSocketè¿æ¥ä¿®å¤è„šæœ¬å·²æ¿€æ´»');
        
        // forceApplyNavbarStyles å‡½æ•°å·²åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰ï¼Œè¿™é‡Œåˆ é™¤é‡å¤å®šä¹‰
        
        // é¡µé¢åŠ è½½å®Œæˆåä¼˜åŒ–å¯¼èˆªæ 
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => window.safeCall('enhanceNavbar'), 100);
            setTimeout(() => window.safeCall('enhanceNavbar'), 500);
            
            // æ§åˆ¶é¦–é¡µèœå•æ˜¾ç¤º
            window.safeCall('controlHomePageNavbar');
        });

        // controlHomePageNavbar å‡½æ•°å·²åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰ï¼Œåˆ é™¤é‡å¤å®šä¹‰
        
        // ç›‘å¬ä¸»é¢˜åˆ‡æ¢äº‹ä»¶ï¼Œä¼˜åŒ–å¯¼èˆªæ 
        document.addEventListener('themeChanged', function() {
            setTimeout(() => window.safeCall('enhanceNavbar'), 100);
            setTimeout(() => window.safeCall('enhanceNavbar'), 500);
            setTimeout(() => window.safeCall('controlHomePageNavbar'), 100);
        });
        
        // ç›‘å¬çª—å£åŠ è½½å®Œæˆäº‹ä»¶
        window.addEventListener('load', function() {
            setTimeout(() => window.safeCall('enhanceNavbar'), 100);
            setTimeout(() => window.safeCall('enhanceNavbar'), 500);
            setTimeout(() => window.safeCall('controlHomePageNavbar'), 100);
        });
        
        // å®šæœŸæ£€æŸ¥å¹¶ä¼˜åŒ–å¯¼èˆªæ ï¼ˆè½»é‡çº§ï¼‰
        setInterval(function() {
            const navbar = document.querySelector('.navbar');
            if (navbar && !navbar.classList.contains('unified-navbar')) {
                window.safeCall('enhanceNavbar');
            }
        }, 5000);
        
        // é¡¶éƒ¨UIå’Œcontainer-fluidæ§åˆ¶
        function initTopUIControl() {
            const topUiBar = document.getElementById('topUiBar');
            const containers = document.querySelectorAll('.container-fluid');
            
            // é¡¶éƒ¨UIå§‹ç»ˆæ˜¾ç¤ºï¼Œä¸éœ€è¦è‡ªåŠ¨éšè—
            if (topUiBar) {
                topUiBar.style.opacity = '1';
                topUiBar.style.transform = 'translateY(0)';
            }
            
            // container-fluidæ‚¬åœæ˜¾ç¤º
            containers.forEach(container => {
                container.addEventListener('mouseenter', function() {
                    this.classList.add('show');
                });
                
                container.addEventListener('mouseleave', function() {
                    this.classList.remove('show');
                });
            });
            
            // èœå•æŒ‰é’®æ‚¬æµ®æ˜¾ç¤ºæ§åˆ¶
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            let menuBtnTimeout;
            
            // é¼ æ ‡è¿›å…¥é¡µé¢é¡¶éƒ¨åŒºåŸŸæ—¶æ˜¾ç¤ºèœå•æŒ‰é’®
            document.addEventListener('mouseenter', function(e) {
                if (e.clientY <= 80) {
                    mobileMenuBtn.classList.add('show');
                    clearTimeout(menuBtnTimeout);
                }
            });
            
            // é¼ æ ‡ç¦»å¼€é¡µé¢é¡¶éƒ¨åŒºåŸŸæ—¶éšè—èœå•æŒ‰é’®
            document.addEventListener('mouseleave', function(e) {
                if (e.clientY <= 0) {
                    menuBtnTimeout = setTimeout(() => {
                        mobileMenuBtn.classList.remove('show');
                    }, 1500);
                }
            });
            
            // é¼ æ ‡åœ¨èœå•æŒ‰é’®ä¸Šæ—¶ä¿æŒæ˜¾ç¤º
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('mouseenter', function() {
                    this.classList.add('show');
                    clearTimeout(menuBtnTimeout);
                });
                
                mobileMenuBtn.addEventListener('mouseleave', function() {
                    menuBtnTimeout = setTimeout(() => {
                        this.classList.remove('show');
                    }, 1000);
                });
            }
            
            // æ›´æ–°é¡¶éƒ¨UIå¾½ç« 
            function updateTopUIBadge() {
                const badge = document.getElementById('topUiBadge');
                const currentMode = localStorage.getItem('currentMode') || 'work';
                const modeNames = {
                    'work': 'æå®¢',
                    'life': 'ç”Ÿæ´»',
                    'training': 'ç‹‚æš´',
                    'emo': 'Emo'
                };
                if (badge) {
                    badge.textContent = modeNames[currentMode] || 'æå®¢';
                }
            }
            
            // åˆå§‹åŒ–å¾½ç« 
            updateTopUIBadge();
            
            // ç›‘å¬ä¸»é¢˜åˆ‡æ¢äº‹ä»¶
            document.addEventListener('themeChanged', updateTopUIBadge);
            
            // å½©è›‹å’Œä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½
            function initEasterEggsAndPullRefresh() {
                let startY = 0;
                let currentY = 0;
                let isPulling = false;
                let pullDistance = 0;
                let userInput = '';
                let inputTimeout;
                const pullRefreshIndicator = document.getElementById('pullRefreshIndicator');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                
                // ä¸‹æ‹‰/ä¸Šæ‹‰å½©è›‹
                function createEasterEggParticles(type = 'down') {
                    const particles = type === 'down' 
                        ? ['ğŸš€', 'â­', 'ğŸ’«', 'âœ¨', 'ğŸŒŸ', 'ğŸ‰', 'ğŸŠ', 'ğŸ’', 'ğŸ”¥', 'âš¡']
                        : ['ğŸŒ™', 'â˜ï¸', 'ğŸŒˆ', 'ğŸŒ¸', 'ğŸ€', 'ğŸˆ', 'ğŸª', 'ğŸ­', 'ğŸ¨', 'ğŸµ'];
                    
                    for (let i = 0; i < 15; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'easter-egg-particle';
                        particle.innerHTML = particles[Math.floor(Math.random() * particles.length)];
                        particle.style.left = Math.random() * window.innerWidth + 'px';
                        particle.style.top = type === 'down' ? '0px' : window.innerHeight + 'px';
                        particle.style.fontSize = (Math.random() * 1.5 + 1) + 'rem';
                        particle.style.animationDelay = Math.random() * 2 + 's';
                        
                        document.body.appendChild(particle);
                        
                        setTimeout(() => {
                            if (particle.parentNode) {
                                particle.parentNode.removeChild(particle);
                            }
                        }, 5000);
                    }
                    
                    // æ˜¾ç¤ºå½©è›‹æ¶ˆæ¯
                    const messages = type === 'down' 
                        ? ['ğŸ‰ å‘ç°å½©è›‹ï¼', 'ğŸš€ å‘ä¸‹æ¢ç´¢ï¼', 'âœ¨ æƒŠå–œä¸æ–­ï¼', 'ğŸŒŸ ç»§ç»­å‘ç°ï¼']
                        : ['ğŸŒ™ å‘ä¸Šé£ç¿”ï¼', 'â˜ï¸ äº‘ç«¯æ¼«æ­¥ï¼', 'ğŸŒˆ å½©è™¹ä¹‹è·¯ï¼', 'ğŸŒ¸ ç¾å¥½æ—¶å…‰ï¼'];
                    
                    showEasterEggMessage(messages[Math.floor(Math.random() * messages.length)]);
                }
                
                // æ˜¾ç¤ºå½©è›‹æ¶ˆæ¯
                function showEasterEggMessage(message) {
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
                        color: white;
                        padding: 20px 30px;
                        border-radius: 15px;
                        font-size: 1.2rem;
                        font-weight: bold;
                        z-index: 10001;
                        backdrop-filter: blur(10px);
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                        animation: messageSlideIn 0.5s ease-out;
                    `;
                    messageDiv.textContent = message;
                    
                    document.body.appendChild(messageDiv);
                    
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 2000);
                }
                
                // ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½
                function handlePullRefresh() {
                    pullRefreshIndicator.classList.add('show');
                    
                    setTimeout(() => {
                        pullRefreshIndicator.classList.remove('show');
                        location.reload();
                    }, 1500);
                }
                
                // è§¦æ‘¸äº‹ä»¶å¤„ç†
                document.addEventListener('touchstart', function(e) {
                    startY = e.touches[0].clientY;
                    isPulling = false;
                });
                
                document.addEventListener('touchmove', function(e) {
                    currentY = e.touches[0].clientY;
                    pullDistance = currentY - startY;
                    
                    // ä¸‹æ‹‰æ£€æµ‹
                    if (pullDistance > 100 && window.scrollY === 0 && !isPulling) {
                        isPulling = true;
                        createEasterEggParticles('down');
                        
                        // å¦‚æœä¸‹æ‹‰è·ç¦»è¶³å¤Ÿå¤§ï¼Œè§¦å‘åˆ·æ–°
                        if (pullDistance > 200) {
                            handlePullRefresh();
                        }
                    }
                    
                    // ä¸Šæ‹‰æ£€æµ‹ï¼ˆåœ¨é¡µé¢åº•éƒ¨ï¼‰
                    if (pullDistance < -100 && 
                        window.scrollY + window.innerHeight >= document.body.scrollHeight - 10 && 
                        !isPulling) {
                        isPulling = true;
                        createEasterEggParticles('up');
                    }
                });
                
                // é”®ç›˜è¾“å…¥æ£€æµ‹
                document.addEventListener('keydown', function(e) {
                    userInput += e.key.toLowerCase();
                    
                    // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
                    clearTimeout(inputTimeout);
                    
                    // æ£€æŸ¥æ˜¯å¦è¾“å…¥äº†"menu"
                    if (userInput.includes('menu')) {
                        if (mobileMenuBtn) {
                            mobileMenuBtn.classList.add('permanent');
                            showEasterEggMessage('ğŸ¯ èœå•å·²æ°¸ä¹…æ˜¾ç¤ºï¼');
                        }
                        userInput = '';
                    }
                    
                    // 3ç§’åæ¸…é™¤è¾“å…¥
                    inputTimeout = setTimeout(() => {
                        userInput = '';
                    }, 3000);
                });
                
                // é¼ æ ‡æ»šè½®äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯å½©è›‹ï¼‰
                let wheelCount = 0;
                let wheelTimeout;
                
                document.addEventListener('wheel', function(e) {
                    wheelCount++;
                    
                    clearTimeout(wheelTimeout);
                    wheelTimeout = setTimeout(() => {
                        if (wheelCount >= 10) {
                            createEasterEggParticles(e.deltaY > 0 ? 'down' : 'up');
                            wheelCount = 0;
                        }
                    }, 1000);
                });
                
                console.log('âœ… å½©è›‹å’Œä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½å·²åˆå§‹åŒ–');
            }
        
        // åˆå§‹åŒ–å½©è›‹å’Œä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½
        initEasterEggsAndPullRefresh();
        
        // åº•éƒ¨UIåŠŸèƒ½å‡½æ•° - å·²ç§»è‡³å…¨å±€å‡½æ•°å®šä¹‰
    }
    
    // å…¨å±€å‡½æ•°å®šä¹‰
        function toggleMobileMenu() {
        // æ˜¾ç¤ºèœå•é¢æ¿
        const menuModal = document.getElementById('menuModal');
        if (menuModal) {
            menuModal.style.display = 'block';
        } else {
            // å¦‚æœèœå•æ¨¡æ€æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
            createMenuModal();
            }
        }
        
        function showSettings() {
            console.log('âš™ï¸ showSettings è¢«è°ƒç”¨');
            // æ˜¾ç¤ºè®¾ç½®é¢æ¿
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.style.display = 'block';
                console.log('âœ… è®¾ç½®é¢æ¿å·²æ˜¾ç¤º');
            } else {
                // å¦‚æœæ¨¡æ€æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
                console.log('ğŸ”„ åˆ›å»ºè®¾ç½®é¢æ¿...');
                createSettingsModal();
            }
        }
        
        // åˆ‡æ¢ç§»åŠ¨èœå•
        function toggleMobileMenu() {
            console.log('ğŸ“± toggleMobileMenu è¢«è°ƒç”¨');
            const menuModal = document.getElementById('menuModal');
            if (menuModal) {
                menuModal.style.display = 'block';
                console.log('âœ… èœå•å·²æ˜¾ç¤º');
            } else {
                // å¦‚æœèœå•æ¨¡æ€æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
                console.log('ğŸ”„ åˆ›å»ºèœå•é¢æ¿...');
                createMenuModal();
            }
        }
        
        // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
        function closeSettingsModal() {
            console.log('âŒ å…³é—­è®¾ç½®é¢æ¿');
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.style.display = 'none';
            }
        }
        
        // å…³é—­èœå•æ¨¡æ€æ¡†
        function closeMenuModal() {
            console.log('âŒ å…³é—­èœå•é¢æ¿');
            const menuModal = document.getElementById('menuModal');
            if (menuModal) {
                menuModal.style.display = 'none';
            }
        }
        
                    // æ‚¬æµ®ä¸‹æ‹‰èœå•å‡½æ•°å·²åœ¨é¡µé¢å¤´éƒ¨å®šä¹‰
        
        // è¿™äº›å‡½æ•°ç°åœ¨åœ¨ top_ui_functions.js ä¸­å®šä¹‰
    
    // åˆ›å»ºè®¾ç½®æ¨¡æ€æ¡†
    function createSettingsModal() {
        const modal = document.createElement('div');
        modal.id = 'settingsModal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        `;
        
        modal.innerHTML = `
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); 
                        border-radius: 15px; 
                        padding: 30px; 
                        max-width: 500px; 
                        width: 90%; 
                        color: white;
                        border: 2px solid rgba(255, 255, 255, 0.15);
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="margin: 0; font-size: 1.5rem;">âš™ï¸ è®¾ç½®</h3>
                    <button onclick="closeSettingsModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">Ã—</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ğŸ¨ ä¸»é¢˜æ¨¡å¼</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="switchTheme('work')" class="theme-btn" data-theme="work" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-weight: 600;">æå®¢æ¨¡å¼</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">ä¸“æ³¨æŠ€æœ¯</div>
                        </button>
                        <button onclick="switchTheme('life')" class="theme-btn" data-theme="life" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-weight: 600;">ç”Ÿæ´»æ¨¡å¼</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">è½»æ¾æ„‰æ‚¦</div>
                        </button>
                        <button onclick="switchTheme('training')" class="theme-btn" data-theme="training" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-weight: 600;">ç‹‚æš´æ¨¡å¼</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">æ¿€æƒ…å››å°„</div>
                        </button>
                        <button onclick="switchTheme('emo')" class="theme-btn" data-theme="emo" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <div style="font-weight: 600;">Emoæ¨¡å¼</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">æƒ…æ„Ÿè¡¨è¾¾</div>
                        </button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ğŸµ éŸ³ä¹æ§åˆ¶</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="toggleMusic()" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-play" style="margin-right: 8px;"></i>æ’­æ”¾/æš‚åœ
                        </button>
                        <button onclick="nextSong()" style="padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-forward" style="margin-right: 8px;"></i>ä¸‹ä¸€é¦–
                        </button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="closeSettingsModal()" style="padding: 12px 30px; border-radius: 8px; background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease; font-weight: 600;">å®Œæˆ</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    // åˆ›å»ºèœå•æ¨¡æ€æ¡†
    function createMenuModal() {
        const modal = document.createElement('div');
        modal.id = 'menuModal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        `;
        
        modal.innerHTML = `
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); 
                        border-radius: 15px; 
                        padding: 30px; 
                        max-width: 600px; 
                        width: 90%; 
                        color: white;
                        border: 2px solid rgba(255, 255, 255, 0.15);
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="margin: 0; font-size: 1.5rem;">ğŸ§­ å¯¼èˆªèœå•</h3>
                    <button onclick="closeMenuModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">Ã—</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <button onclick="window.location.href='{% url 'home' %}'" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-home" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">é¦–é¡µ</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">è¿”å›ä¸»é¡µ</div>
                    </button>
                    <button onclick="goToCurrentModeTools()" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-tools" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">å·¥å…·é›†</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">å®ç”¨å·¥å…·</div>
                    </button>
                    <button onclick="showSuggestions()" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-lightbulb" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">æˆ‘çš„å»ºè®®</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">åŠŸèƒ½å»ºè®®</div>
                    </button>
                    <button onclick="showHiddenInfo()" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-info-circle" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">å…³äº</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">ç³»ç»Ÿä¿¡æ¯</div>
                    </button>
                    <button onclick="window.location.href='/tools/chat/'" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-comments" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">èŠå¤©å®¤</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">å®æ—¶äº¤æµ</div>
                    </button>
                    <button onclick="window.location.href='/tools/heart_link/'" class="menu-item" style="padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <i class="fas fa-heart" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 600;">å¿ƒé“¾åŒ¹é…</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">å¯»æ‰¾ä¼™ä¼´</div>
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="closeMenuModal()" style="padding: 12px 30px; border-radius: 8px; background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease; font-weight: 600;">å…³é—­</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
    function closeSettingsModal() {
        const modal = document.getElementById('settingsModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // å…³é—­èœå•æ¨¡æ€æ¡†
    function closeMenuModal() {
        const modal = document.getElementById('menuModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // è·å–CSRF Token
    function getCSRFToken() {
        const token = document.querySelector('meta[name="csrf-token"]');
        return token ? token.getAttribute('content') : '';
    }
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•å’Œæ¨¡æ€æ¡†
    document.addEventListener('click', function(event) {
        // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
        const settingsModal = document.getElementById('settingsModal');
        if (settingsModal && event.target === settingsModal) {
            settingsModal.style.display = 'none';
        }
        
        // å…³é—­èœå•æ¨¡æ€æ¡†
        const menuModal = document.getElementById('menuModal');
        if (menuModal && event.target === menuModal) {
            menuModal.style.display = 'none';
        }
    });
        
            // æ·»åŠ æ¨¡æ€æ¡†æŒ‰é’®æ‚¬åœæ•ˆæœ
    document.addEventListener('mouseover', function(e) {
        if (e.target.classList.contains('menu-item') || e.target.classList.contains('theme-btn')) {
            e.target.style.transform = 'translateY(-2px)';
            e.target.style.boxShadow = '0 8px 25px rgba(255, 255, 255, 0.2)';
            e.target.style.background = 'rgba(255, 255, 255, 0.15)';
        }
    });
    
    document.addEventListener('mouseout', function(e) {
        if (e.target.classList.contains('menu-item') || e.target.classList.contains('theme-btn')) {
            e.target.style.transform = 'translateY(0)';
            e.target.style.boxShadow = 'none';
            e.target.style.background = 'rgba(255, 255, 255, 0.1)';
        }
    });
        
            // é¡¶éƒ¨æ æ‚¬åœæ•ˆæœ
    document.addEventListener('DOMContentLoaded', function() {
        // å“ç‰Œæ ‡è¯†æ‚¬åœæ•ˆæœ
        const brandElement = document.querySelector('.top-ui-brand');
        if (brandElement) {
            brandElement.addEventListener('mouseenter', function() {
                const hoverEffect = this.querySelector('.brand-hover-effect');
                if (hoverEffect) {
                    hoverEffect.style.left = '100%';
                }
                this.style.transform = 'scale(1.05)';
            });
            
            brandElement.addEventListener('mouseleave', function() {
                const hoverEffect = this.querySelector('.brand-hover-effect');
                if (hoverEffect) {
                    hoverEffect.style.left = '-100%';
                }
                this.style.transform = 'scale(1)';
            });
        }
        
        // ä¸»é¢˜æ ‡è¯†æ‚¬åœæ•ˆæœ
        const themeBadge = document.getElementById('topUiBadge');
        if (themeBadge) {
            themeBadge.addEventListener('mouseenter', function() {
                const hoverEffect = this.querySelector('.theme-hover-effect');
                if (hoverEffect) {
                    hoverEffect.style.opacity = '0.3';
                }
                this.style.transform = 'scale(1.1)';
            });
            
            themeBadge.addEventListener('mouseleave', function() {
                const hoverEffect = this.querySelector('.theme-hover-effect');
                if (hoverEffect) {
                    hoverEffect.style.opacity = '0';
                }
                this.style.transform = 'scale(1)';
            });
        }
        
        // è®¾ç½®æŒ‰é’®æ‚¬åœæ•ˆæœ
        const settingsButton = document.querySelector('.top-ui-item[onclick*="showSettings"]');
        if (settingsButton) {
            settingsButton.addEventListener('mouseenter', function() {
                const icon = this.querySelector('i');
                const hoverEffect = this.querySelector('.button-hover-effect');
                if (icon) {
                    icon.style.animationPlayState = 'running';
                }
                if (hoverEffect) {
                    hoverEffect.style.opacity = '1';
                }
                this.style.transform = 'scale(1.1)';
            });
            
            settingsButton.addEventListener('mouseleave', function() {
                const icon = this.querySelector('i');
                const hoverEffect = this.querySelector('.button-hover-effect');
                if (icon) {
                    icon.style.animationPlayState = 'paused';
                }
                if (hoverEffect) {
                    hoverEffect.style.opacity = '0';
                }
                this.style.transform = 'scale(1)';
            });
        }
        
        // èœå•æŒ‰é’®æ‚¬åœæ•ˆæœ
        const menuButton = document.querySelector('.top-ui-item[onclick*="toggleMobileMenu"]');
        if (menuButton) {
            menuButton.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.1) rotate(5deg)';
                this.style.background = 'rgba(255, 255, 255, 0.2)';
            });
            
            menuButton.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1) rotate(0deg)';
                this.style.background = 'rgba(255, 255, 255, 0.1)';
            });
        }
        
        // éšè—æŒ‰é’®æ‚¬åœæ•ˆæœ
        const hideButton = document.querySelector('.top-ui-item[onclick*="hideTopUI"]');
        if (hideButton) {
            hideButton.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.1)';
                this.style.background = 'rgba(255, 255, 255, 0.2)';
                const icon = this.querySelector('i');
                if (icon) {
                    icon.style.animation = 'pulse 1s ease-in-out infinite';
                }
            });
            
            hideButton.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
                this.style.background = 'rgba(255, 255, 255, 0.1)';
                const icon = this.querySelector('i');
                if (icon) {
                    icon.style.animation = 'none';
                }
            });
        }
    });
        
            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ”§ é¡µé¢åˆå§‹åŒ–å¼€å§‹');
        
        // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•çš„åŠŸèƒ½
        // ç”±äºç°åœ¨ä½¿ç”¨æ‚¬æµ®è§¦å‘ï¼Œä¸å†éœ€è¦è¿™ä¸ªç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        // åŸæ¥çš„ç‚¹å‡»å…³é—­åŠŸèƒ½å·²è¢«æ‚¬æµ®æœºåˆ¶å–ä»£
        });
        setTimeout(initTopUIControl, 100);
        
        // æ£€æŸ¥å…¨å±€éšè—çŠ¶æ€
        const isTopUIBarHidden = localStorage.getItem('topUIBarHidden') === 'true';
        const topUiBar = document.getElementById('topUiBar');
        if (topUiBar) {
            if (isTopUIBarHidden) {
                // å¦‚æœå…¨å±€è®¾ç½®ä¸ºéšè—ï¼Œåˆ™éšè—é¡¶éƒ¨æ 
                topUiBar.style.display = 'none';
                topUiBar.style.visibility = 'hidden';
                topUiBar.style.opacity = '0';
                topUiBar.style.transform = 'translateY(-100%)';
                topUiBar.style.pointerEvents = 'none';
                console.log('âœ… æ ¹æ®å…¨å±€è®¾ç½®éšè—é¡¶éƒ¨æ ');
                
                // æ˜¾ç¤ºæ¢å¤æŒ‰é’®
                showRestoreButton();
            } else {
                // å¦åˆ™æ˜¾ç¤ºé¡¶éƒ¨æ 
                topUiBar.style.display = 'flex';
                topUiBar.style.visibility = 'visible';
                topUiBar.style.opacity = '1';
                topUiBar.style.transform = 'translateY(0)';
                topUiBar.style.pointerEvents = 'auto';
                console.log('âœ… é¡¶éƒ¨èœå•å·²æ˜¾ç¤º');
            }
        } else {
            console.error('âŒ æ‰¾ä¸åˆ°é¡¶éƒ¨èœå•å…ƒç´ ');
        }
    });
    
    // é¡µé¢å®Œå…¨åŠ è½½åæ£€æŸ¥çŠ¶æ€
    window.addEventListener('load', function() {
        const topUiBar = document.getElementById('topUiBar');
        if (topUiBar) {
            // ä¸è¦å¼ºåˆ¶æ˜¾ç¤ºï¼Œè®©éšè—åŠŸèƒ½æ­£å¸¸å·¥ä½œ
            console.log('âœ… é¡µé¢åŠ è½½å®Œæˆï¼Œé¡¶éƒ¨èœå•çŠ¶æ€æ­£å¸¸');
        }
    });
        


        
    })();
    </script>
    
    <!-- é¡¶éƒ¨æ åŠŸèƒ½JavaScript -->
    <script src="{% static 'js/top_ui_functions.js' %}"></script>
    
    <!-- ä¸»é¢˜ç®¡ç†å™¨ -->
    <script src="{% static 'js/theme_manager.js' %}"></script>
    
    <!-- å¼ºåˆ¶ä¿®å¤ç”¨æˆ·èœå•è„šæœ¬ -->
    <script>
    // å¼ºåˆ¶ä¿®å¤ç”¨æˆ·èœå•é—®é¢˜
    console.log('ğŸ”§ åŠ è½½å¼ºåˆ¶ä¿®å¤è„šæœ¬');
    
    // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
    window.addEventListener('load', function() {
        console.log('ğŸ”§ é¡µé¢å®Œå…¨åŠ è½½ï¼Œå¼€å§‹å¼ºåˆ¶ä¿®å¤');
        
        // å¼ºåˆ¶ä¿®å¤ç”¨æˆ·èœå•
        forceFixUserMenu();
        

    });
    
    // å¼ºåˆ¶ä¿®å¤ç”¨æˆ·èœå•
    function forceFixUserMenu() {
        console.log('ğŸ”§ å¼€å§‹å¼ºåˆ¶ä¿®å¤ç”¨æˆ·èœå•');
        
        const dropdownContent = document.getElementById('userDropdownContent');
        const userButton = document.querySelector('.top-ui-user');
        
        if (!dropdownContent) {
            console.error('âŒ ç”¨æˆ·ä¸‹æ‹‰èœå•å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        
        if (!userButton) {
            console.error('âŒ ç”¨æˆ·å¤´åƒæŒ‰é’®æœªæ‰¾åˆ°');
            return;
        }
        
        console.log('âœ… æ‰¾åˆ°èœå•å…ƒç´ å’ŒæŒ‰é’®');
        
        // å¼ºåˆ¶è®¾ç½®åˆå§‹çŠ¶æ€
        dropdownContent.style.display = 'none';
        dropdownContent.style.opacity = '0';
        dropdownContent.style.transform = 'scale(0.95) translateY(-10px)';
        dropdownContent.classList.remove('show');
        
        // ç§»é™¤å¯èƒ½å†²çªçš„äº‹ä»¶ç›‘å¬å™¨
        const newUserButton = userButton.cloneNode(true);
        userButton.parentNode.replaceChild(newUserButton, userButton);
        
        // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
        newUserButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ğŸ”§ ç”¨æˆ·å¤´åƒè¢«ç‚¹å‡»');
            forceToggleUserDropdown();
        });
        
        console.log('âœ… ç”¨æˆ·èœå•å¼ºåˆ¶ä¿®å¤å®Œæˆ');
    }
    
    // å¼ºåˆ¶åˆ‡æ¢ç”¨æˆ·èœå•
    function forceToggleUserDropdown() {
        console.log('ğŸ”§ forceToggleUserDropdown è¢«è°ƒç”¨');
        
        const dropdownContent = document.getElementById('userDropdownContent');
        const chevronIcon = document.querySelector('.top-ui-user .fa-chevron-down');
        
        if (!dropdownContent) {
            console.error('âŒ ç”¨æˆ·ä¸‹æ‹‰èœå•å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        
        // æ£€æŸ¥å½“å‰æ˜¾ç¤ºçŠ¶æ€
        const isVisible = dropdownContent.style.display === 'block' && 
                         dropdownContent.style.opacity !== '0' &&
                         !dropdownContent.classList.contains('hidden');
        
        console.log('å½“å‰èœå•çŠ¶æ€:', {
            display: dropdownContent.style.display,
            opacity: dropdownContent.style.opacity,
            isVisible: isVisible
        });
        
        if (isVisible) {
            // éšè—èœå•
            dropdownContent.style.display = 'none';
            dropdownContent.style.opacity = '0';
            dropdownContent.style.transform = 'scale(0.95) translateY(-10px)';
            dropdownContent.classList.remove('show');
            
            if (chevronIcon) {
                chevronIcon.style.transform = 'rotate(0deg)';
            }
            
            console.log('âœ… èœå•å·²éšè—');
        } else {
            // æ˜¾ç¤ºèœå•
            dropdownContent.style.display = 'block';
            dropdownContent.style.opacity = '1';
            dropdownContent.style.transform = 'scale(1) translateY(0)';
            dropdownContent.classList.add('show');
            
            if (chevronIcon) {
                chevronIcon.style.transform = 'rotate(180deg)';
            }
            
            console.log('âœ… èœå•å·²æ˜¾ç¤º');
        }
    }
    
    // æ·»åŠ è°ƒè¯•æŒ‰é’®

    
    // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.forceToggleUserDropdown = forceToggleUserDropdown;
    
    console.log('âœ… å¼ºåˆ¶ä¿®å¤è„šæœ¬åŠ è½½å®Œæˆ');
    

    </script>
    
    <!-- ç”¨æˆ·è®¤è¯ç›¸å…³JavaScript -->
    <script src="{% static 'js/auth.js' %}"></script>
    <script src="{% static 'js/feature-recommendation.js' %}"></script>
    <script src="{% static 'js/session_manager.js' %}"></script>
    
    {% block extra_js %}{% endblock %}
    
    <!-- å…¨å±€åˆ†äº«æŒ‰é’® -->
    {% include 'tools/share_button.html' %}
    <script>
    // å…¨å±€éšè—é¡¶éƒ¨æ åŠŸèƒ½
    function hideTopUI() {
        // ä¿å­˜éšè—çŠ¶æ€åˆ°localStorageï¼Œå®ç°å…¨å±€éšè—
        localStorage.setItem('topUIBarHidden', 'true');
        
        const topUiBar = document.getElementById('topUiBar');
        if (topUiBar) {
            // å®Œå…¨éšè—é¡¶éƒ¨æ 
            topUiBar.style.display = 'none';
            topUiBar.style.visibility = 'hidden';
            topUiBar.style.opacity = '0';
            topUiBar.style.transform = 'translateY(-100%)';
            topUiBar.style.pointerEvents = 'none';
            
            // æ˜¾ç¤ºæ¢å¤æŒ‰é’®
            showRestoreButton();
            
            console.log('âœ… å…¨å±€é¡¶éƒ¨æ å·²å®Œå…¨éšè—');
        }
    }
    
    // æ˜¾ç¤ºæ¢å¤æŒ‰é’®
    function showRestoreButton() {
        // ç§»é™¤å·²å­˜åœ¨çš„æ¢å¤æŒ‰é’®
        const existingRestore = document.getElementById('restoreTopUIButton');
        if (existingRestore) {
            existingRestore.remove();
        }
        
        // åˆ›å»ºæ¢å¤æŒ‰é’®
        const restoreButton = document.createElement('div');
        restoreButton.id = 'restoreTopUIButton';
        restoreButton.innerHTML = '<i class="fas fa-eye"></i>';
        restoreButton.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            transition: all 0.3s ease;
            opacity: 0;
            transform: scale(0.8);
        `;
        
        restoreButton.onclick = function() {
            restoreTopUI();
        };
        
        restoreButton.onmouseenter = function() {
            this.style.transform = 'scale(1.1)';
            this.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.4)';
        };
        
        restoreButton.onmouseleave = function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.3)';
        };
        
        document.body.appendChild(restoreButton);
        
        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            restoreButton.style.opacity = '1';
            restoreButton.style.transform = 'scale(1)';
        }, 100);
    }
    
    // æ¢å¤é¡¶éƒ¨æ 
    function restoreTopUI() {
        // æ¸…é™¤localStorageä¸­çš„éšè—çŠ¶æ€
        localStorage.removeItem('topUIBarHidden');
        
        const topUiBar = document.getElementById('topUiBar');
        const restoreButton = document.getElementById('restoreTopUIButton');
        
        if (topUiBar) {
            // å®Œå…¨æ¢å¤é¡¶éƒ¨æ 
            topUiBar.style.display = 'flex';
            topUiBar.style.visibility = 'visible';
            topUiBar.style.opacity = '1';
            topUiBar.style.transform = 'translateY(0)';
            topUiBar.style.pointerEvents = 'auto';
            
            console.log('âœ… å…¨å±€é¡¶éƒ¨æ å·²å®Œå…¨æ¢å¤');
        }
        
        if (restoreButton) {
            restoreButton.style.opacity = '0';
            restoreButton.style.transform = 'scale(0.8)';
            setTimeout(() => {
                if (document.body.contains(restoreButton)) {
                    restoreButton.remove();
                }
            }, 300);
        }
    }
    
    // ä»èœå•è°ƒèµ·åˆ†äº«åŠŸèƒ½
    function openShareFromMenu() {
        // å…³é—­ç”¨æˆ·èœå•
        const userDropdown = document.querySelector('.user-dropdown');
        if (userDropdown) {
            userDropdown.classList.remove('show');
        }
        
        // ç›´æ¥æ˜¾ç¤ºåˆ†äº«èœå•
        if (typeof toggleShareMenu === 'function') {
            toggleShareMenu();
        } else {
            // å¦‚æœåˆ†äº«åŠŸèƒ½æœªåŠ è½½ï¼Œæ˜¾ç¤ºå¤‡ç”¨åˆ†äº«é€‰é¡¹
            showFallbackShareOptions();
        }
    }
    
    // å¤‡ç”¨åˆ†äº«é€‰é¡¹
    function showFallbackShareOptions() {
        const currentUrl = window.location.href;
        const title = document.title;
        
        const shareModal = document.createElement('div');
        shareModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        `;
        
        const shareContent = document.createElement('div');
        shareContent.style.cssText = `
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        `;
        
        shareContent.innerHTML = `
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">åˆ†äº«å½“å‰é¡µé¢</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                <button onclick="shareToPlatform('wechat')" style="
                    background: #07C160;
                    color: white;
                    border: none;
                    padding: 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
                    <i class="fab fa-weixin"></i>
                    å¾®ä¿¡
                </button>
                <button onclick="shareToPlatform('weibo')" style="
                    background: #E6162D;
                    color: white;
                    border: none;
                    padding: 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
                    <i class="fab fa-weibo"></i>
                    å¾®åš
                </button>
                <button onclick="shareToPlatform('qq')" style="
                    background: #12B7F5;
                    color: white;
                    border: none;
                    padding: 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
                    <i class="fab fa-qq"></i>
                    QQ
                </button>
                <button onclick="shareToPlatform('copy')" style="
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
                    <i class="fas fa-link"></i>
                    å¤åˆ¶é“¾æ¥
                </button>
            </div>
            <button onclick="closeShareModal()" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            ">å…³é—­</button>
        `;
        
        shareModal.appendChild(shareContent);
        document.body.appendChild(shareModal);
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        shareModal.onclick = function(e) {
            if (e.target === shareModal) {
                closeShareModal();
            }
        };
    }
    
    // åˆ†äº«åˆ°æŒ‡å®šå¹³å°
    function shareToPlatform(platform) {
        const currentUrl = window.location.href;
        const title = document.title;
        const encodedUrl = encodeURIComponent(currentUrl);
        const encodedTitle = encodeURIComponent(title);
        
        switch (platform) {
            case 'wechat':
                // æ˜¾ç¤ºäºŒç»´ç 
                showQRCodeForShare(currentUrl);
                break;
            case 'weibo':
                window.open(`https://service.weibo.com/share/share.php?url=${encodedUrl}&title=${encodedTitle}`, '_blank');
                closeShareModal();
                break;
            case 'qq':
                window.open(`https://connect.qq.com/widget/shareqq/index.html?url=${encodedUrl}&title=${encodedTitle}`, '_blank');
                closeShareModal();
                break;
            case 'copy':
                copyToClipboard(currentUrl);
                closeShareModal();
                break;
        }
    }
    
    // æ˜¾ç¤ºåˆ†äº«äºŒç»´ç 
    function showQRCodeForShare(url) {
        const qrModal = document.createElement('div');
        qrModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        `;
        
        const qrContent = document.createElement('div');
        qrContent.style.cssText = `
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        `;
        
        qrContent.innerHTML = `
            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">æ‰«ç åˆ†äº«</h3>
            <div style="
                width: 200px;
                height: 200px;
                margin: 0 auto 20px;
                background: #f8f9fa;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                color: #666;
            ">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(url)}" alt="QR Code" style="max-width: 100%; height: auto;">
            </div>
            <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">ä½¿ç”¨å¾®ä¿¡æˆ–æ”¯ä»˜å®æ‰«æäºŒç»´ç </p>
            <button onclick="closeQRModal()" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            ">å…³é—­</button>
        `;
        
        qrModal.appendChild(qrContent);
        document.body.appendChild(qrModal);
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        qrModal.onclick = function(e) {
            if (e.target === qrModal) {
                closeQRModal();
            }
        };
    }
    
    // å…³é—­åˆ†äº«æ¨¡æ€æ¡†
    function closeShareModal() {
        const shareModal = document.querySelector('div[style*="z-index: 2000"]');
        if (shareModal) {
            shareModal.remove();
        }
    }
    
    // å…³é—­äºŒç»´ç æ¨¡æ€æ¡†
    function closeQRModal() {
        const qrModal = document.querySelector('div[style*="z-index: 3000"]');
        if (qrModal) {
            qrModal.remove();
        }
    }
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showShareToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                fallbackCopyToClipboard(text);
            });
        } else {
            fallbackCopyToClipboard(text);
        }
    }
    
    // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            showShareToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        } catch (err) {
            showShareToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        }
        
        document.body.removeChild(textArea);
    }
    
    // æ˜¾ç¤ºåˆ†äº«æç¤ºæ¶ˆæ¯
    function showShareToast(message, duration = 2000) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 4000;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '1';
        }, 100);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, duration);
    }
    
    // èŠå¤©é€šçŸ¥ç³»ç»Ÿåˆå§‹åŒ–
    function initChatNotificationSystem() {
        // åªåœ¨ç”¨æˆ·å·²ç™»å½•æ—¶åˆå§‹åŒ–
        {% if user.is_authenticated %}
        if (typeof ChatNotificationManager === 'undefined') {
            // åŠ¨æ€åŠ è½½èŠå¤©é€šçŸ¥è„šæœ¬
            const script = document.createElement('script');
            script.src = '{% static "js/chat_notifications.js" %}';
            script.onload = function() {
                // åˆå§‹åŒ–èŠå¤©é€šçŸ¥ç®¡ç†å™¨
                window.chatNotificationManager = new ChatNotificationManager();
            };
            script.onerror = function() {
                console.error('åŠ è½½èŠå¤©é€šçŸ¥è„šæœ¬å¤±è´¥');
            };
            document.head.appendChild(script);
        } else {
            // å¦‚æœå·²ç»åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–
            window.chatNotificationManager = new ChatNotificationManager();
        }
        {% else %}
        // ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡èŠå¤©é€šçŸ¥åˆå§‹åŒ–
        console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡èŠå¤©é€šçŸ¥ç³»ç»Ÿåˆå§‹åŒ–');
        {% endif %}
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–èŠå¤©é€šçŸ¥
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChatNotificationSystem);
    } else {
        initChatNotificationSystem();
    }
    </script>
</body>
</html>