{% load static %}

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}QATOOLBOX{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'geek.css' %}">

    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover;
        }
        header {
            background: rgba(0, 0, 0, 0.8);
            transition: background 0.3s;
            z-index: 2;
        }
        .navbar a {
            color: #fff !important;
            transition: color 0.3s;
        }
        .navbar a:hover {
            color: #FFD700 !important;
        }
        .nav-buttons {
            margin-left: auto;
            display: flex;
            align-items: center;
        }
        .container {
            padding: 0;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 120px);
        }
        footer {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 20px 0;
            text-align: center;
            width: 100%;
        }
        .content-block {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            backdrop-filter: none;
            width: 100%;
            position: relative;
            z-index: 1;
        }
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(24, 28, 32, 0.85);
            backdrop-filter: blur(10px) saturate(1.2);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
        }
        .welcome-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .welcome-content {
            text-align: center;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
            background: rgba(35, 39, 46, 0.92);
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(0,255,231,0.10), 0 2px 8px rgba(0,0,0,0.25);
            padding: 3rem 2.5rem;
            max-width: 420px;
            border: 1.5px solid rgba(0,255,231,0.08);
        }
        .welcome-content h1 {
            font-size: 2.5rem;
            margin-bottom: 1.2rem;
            color: var(--primary);
            letter-spacing: 2px;
        }
        .welcome-content p {
            font-size: 1.3rem;
            color: #b0eaff;
            margin-bottom: 0;
        }
        .btn-custom {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-primary.btn-custom {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border-color: #007bff;
        }
        .btn-primary.btn-custom:hover {
            background: linear-gradient(45deg, #0056b3, #004085);
        }
        .btn-secondary.btn-custom {
            background: linear-gradient(45deg, #6c757d, #545b62);
            border-color: #6c757d;
        }
        .btn-secondary.btn-custom:hover {
            background: linear-gradient(45deg, #545b62, #3d4449);
        }
        .btn-outline-light {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .btn-outline-light:hover {
            transform: rotate(90deg);
            background: rgba(255,255,255,0.1);
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: #FFD700 !important;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .navbar-brand:hover {
            color: #FFA500 !important;
            text-shadow: 0 0 15px rgba(255,165,0,0.7);
        }
        .nav-link {
            position: relative;
            overflow: hidden;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: left 0.3s ease;
        }
        .nav-link:hover::after {
            left: 0;
        }
        .dropdown-menu {
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .dropdown-item:hover {
            background: rgba(255,255,255,0.1) !important;
            transform: translateX(5px);
            transition: all 0.3s ease;
        }
        .social-icons a:hover {
            color: #FFD700 !important;
        }
    </style>
</head>

<body>
    <div class="video-background">
        <video id="background-video" autoplay muted loop preload="metadata">
            <source id="video-source" src="" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
        </video>
        <audio id="background-audio" autoplay loop>
            <source id="audio-source" src="" type="audio/mpeg">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ ‡ç­¾ã€‚
        </audio>
    </div>

    <!-- ä»…åœ¨ home é¡µæ˜¾ç¤ºæ¬¢è¿ç•Œé¢ -->
    {% if request.path == '/' %}
    <div class="welcome-overlay" id="welcome-overlay">
        <div class="welcome-content">
            <h1>æ¬¢è¿æ¥åˆ°</h1>
            <p>QATOOLBOX</p>
        </div>
    </div>
    {% endif %}

    <header>
        <nav class="navbar navbar-expand-lg navbar-light">
            <a class="navbar-brand" href="{% url 'home' %}">
                <i class="fas fa-toolbox"></i> QATOOLBOX
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse">
                <ul class="navbar-nav mr-auto">
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'tools' %}">
                            <i class="fas fa-tools"></i> å·¥å…·é›†
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSuggestions(); return false;">
                            <i class="fas fa-lightbulb"></i> æˆ‘çš„å»ºè®®
                        </a>
                    </li>
                </ul>

                <div class="nav-buttons">
                    {% if user.is_authenticated %}
                        <div class="dropdown" style="margin-right: 15px;">
                            <span class="nav-link text-white" style="cursor: pointer;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                {{ user.username }}
                            </span>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown" style="background: rgba(0,0,0,0.9); border: 1px solid #333; min-width: 200px;">
                                <h6 class="dropdown-header" style="color: #fff; border-bottom: 1px solid #333;">è´¦æˆ·è®¾ç½®</h6>
                                <a class="dropdown-item" href="{% url 'profile_view' %}" style="color: white;">
                                    <i class="fas fa-user-edit"></i> ä¸ªäººèµ„æ–™
                                </a>
                                {% if user.role.is_admin %}
                                    <div class="dropdown-divider" style="border-color: #333;"></div>
                                    <h6 class="dropdown-header" style="color: #fff; border-bottom: 1px solid #333;">ç®¡ç†åŠŸèƒ½</h6>
                                    <a class="dropdown-item" href="{% url 'admin_user_management' %}" style="color: white;">
                                        <i class="fas fa-users-cog"></i> ç”¨æˆ·ç®¡ç†
                                    </a>
                                    <a class="dropdown-item" href="{% url 'admin_suggestions' %}" style="color: white;">
                                        <i class="fas fa-lightbulb"></i> å»ºè®®ç®¡ç†
                                    </a>
                                    <a class="dropdown-item" href="{% url 'admin_feedback' %}" style="color: white;">
                                        <i class="fas fa-comments"></i> åé¦ˆç®¡ç†
                                    </a>
                                    <a class="dropdown-item" href="{% url 'admin_user_logs' %}" style="color: white;">
                                        <i class="fas fa-history"></i> æ“ä½œæ—¥å¿—
                                    </a>
                                {% endif %}
                                <a class="dropdown-item" href="{% url 'logout' %}" onclick="stopMedia()" style="color: white;">
                                    <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <a href="{% url 'login' %}" class="btn btn-primary btn-custom" onclick="stopMedia()">
                            <i class="fas fa-sign-in-alt"></i> ç™»å½•
                        </a>
                        <a href="{% url 'register' %}" class="btn btn-secondary btn-custom" onclick="stopMedia()">
                            <i class="fas fa-user-plus"></i> æ³¨å†Œ
                        </a>
                    {% endif %}
                    
                    <!-- è®¾ç½®æŒ‰é’®ç§»åˆ°å³ä¸Šè§’ -->
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="settingsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-cog"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="settingsDropdown" style="background: rgba(0,0,0,0.9); border: 1px solid #333; min-width: 200px;">
                            <h6 class="dropdown-header" style="color: #fff; border-bottom: 1px solid #333;">åª’ä½“æ§åˆ¶</h6>
                            <a class="dropdown-item" href="#" onclick="toggleVideo(); return false;" style="color: white;">
                                <i class="fas fa-video"></i> è§†é¢‘æ§åˆ¶
                            </a>
                            <a class="dropdown-item" href="#" onclick="toggleAudio(); return false;" style="color: white;">
                                <i class="fas fa-music"></i> éŸ³ä¹æ§åˆ¶
                            </a>
                            <a class="dropdown-item" href="#" onclick="stopAllMedia(); return false;" style="color: white;">
                                <i class="fas fa-stop"></i> åœæ­¢æ‰€æœ‰
                            </a>
                            <div class="dropdown-divider" style="border-color: #333;"></div>
                            <h6 class="dropdown-header" style="color: #fff; border-bottom: 1px solid #333;">ç³»ç»Ÿè®¾ç½®</h6>
                            <a class="dropdown-item" href="#" onclick="showSuggestions(); return false;" style="color: white;">
                                <i class="fas fa-lightbulb"></i> æˆ‘çš„å»ºè®®
                            </a>
                            <a class="dropdown-item" href="#" onclick="showFeedback(); return false;" style="color: white;">
                                <i class="fas fa-comment"></i> æ„è§åé¦ˆ
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <div class="content-block">
            {% block content %}
            <!-- å®¹å™¨å†…å®¹åŒº -->
            {% endblock %}
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <footer style="background: #1A1A1A; color: #fff; padding: 20px 0 10px; text-align: center; width: 100%; margin-top: auto;">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h6 style="color: #fff; margin-bottom: 8px; font-size: 14px;">
                        <i class="fas fa-user"></i> å…³äºæˆ‘
                    </h6>
                    <p style="color: #f0f0f0; font-size: 12px; line-height: 1.4; margin: 0;">
                        QAå·¥å…·ç®±å¼€å‘è€… | è‡ªåŠ¨åŒ–æµ‹è¯• | å·¥å…·å¼€å‘
                    </p>
                </div>
                <div class="col-md-4">
                    <h6 style="color: #fff; margin-bottom: 8px; font-size: 14px;">
                        <i class="fas fa-envelope"></i> è”ç³»æˆ‘
                    </h6>
                    <p style="color: #f0f0f0; font-size: 12px; line-height: 1.4; margin: 0;">
                        Email: gaojie@example.com | WeChat: gaojie_dev
                    </p>
                </div>
                <div class="col-md-4">
                    <h6 style="color: #fff; margin-bottom: 8px; font-size: 14px;">
                        <i class="fas fa-share-alt"></i> å…³æ³¨æˆ‘
                    </h6>
                    <div class="social-icons" style="display: flex; justify-content: center; gap: 10px;">
                        <a href="https://github.com/gaojie" target="_blank" style="color: #fff; font-size: 18px; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fab fa-github" title="GitHub"></i>
                        </a>
                        <a href="https://weibo.com/gaojie" target="_blank" style="color: #fff; font-size: 18px; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fab fa-weibo" title="å¾®åš"></i>
                        </a>
                        <a href="https://www.zhihu.com/people/gaojie" target="_blank" style="color: #fff; font-size: 18px; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fab fa-zhihu" title="çŸ¥ä¹"></i>
                        </a>
                        <a href="https://space.bilibili.com/gaojie" target="_blank" style="color: #fff; font-size: 18px; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fab fa-bilibili" title="Bç«™"></i>
                        </a>
                        <a href="https://www.xiaohongshu.com/user/gaojie" target="_blank" style="color: #fff; font-size: 18px; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-heart" title="å°çº¢ä¹¦"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <hr style="border-color: rgba(255,255,255,0.3); margin: 10px 0;">
                    <p style="color: #f0f0f0; font-size: 11px; margin: 0;">
                        Â© 2025 QAToolBox. ä¸“æ³¨äºæå‡å¼€å‘æ•ˆç‡çš„å·¥å…·ç®± | 
                        <a href="#" style="color: #fff; text-decoration: none;">éšç§æ”¿ç­–</a> | 
                        <a href="#" style="color: #fff; text-decoration: none;">ä½¿ç”¨æ¡æ¬¾</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

    <script>
        window.onload = function () {
            var today = new Date();
            var day = today.getDay();
            var videoSources = [
                '{% static "video/sunday.mp4" %}',
                '{% static "video/monday.mp4" %}',
                '{% static "video/tuesday.mp4" %}',
                '{% static "video/wednesday.mp4" %}',
                '{% static "video/thursday.mp4" %}',
                '{% static "video/friday.mp4" %}',
                '{% static "video/saturday.mp4" %}'
            ];
            var audioSources = [
                '{% static "audio/sunday.mp3" %}',
                '{% static "audio/monday.mp3" %}',
                '{% static "audio/tuesday.mp3" %}',
                '{% static "audio/wednesday.mp3" %}',
                '{% static "audio/thursday.mp3" %}',
                '{% static "audio/friday.mp3" %}',
                '{% static "audio/saturday.mp3" %}'
            ];
            document.getElementById('video-source').src = videoSources[day];
            document.getElementById('audio-source').src = audioSources[day];
            document.getElementById('background-video').load();
            document.getElementById('background-audio').load();
            // ä»…åœ¨ home é¡µæ˜¾ç¤ºæ¬¢è¿ç•Œé¢
            {% if request.path == '/' %}
            setTimeout(function () {
                var welcomeOverlay = document.getElementById('welcome-overlay');
                welcomeOverlay.classList.add('active');
                setTimeout(function () {
                    welcomeOverlay.classList.remove('active');
                }, 2000);
            }, 5000);
            {% endif %}
            // ç›‘å¬è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°çˆ¬å–éŸ³ä¹
            document.getElementById('background-video').addEventListener('error', function() {
                fetch('/tools/api/get-music/')
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.music_url) {
                            var audio = document.getElementById('background-audio');
                            var audioSource = document.getElementById('audio-source');
                            audioSource.src = data.music_url;
                            audio.load();
                            audio.play();
                        }
                    });
            });
        };
        function stopMedia() {
            document.getElementById('background-video').pause();
            document.getElementById('background-audio').pause();
        }
        
        // è§†é¢‘æ§åˆ¶å‡½æ•°
        function toggleVideo() {
            var video = document.getElementById('background-video');
            
            if (video.paused) {
                video.play();
                showNotification('è§†é¢‘å·²æ’­æ”¾', 'success');
            } else {
                video.pause();
                showNotification('è§†é¢‘å·²æš‚åœ', 'info');
            }
        }
        
        // éŸ³é¢‘æ§åˆ¶å‡½æ•°
        function toggleAudio() {
            var audio = document.getElementById('background-audio');
            
            if (audio.paused) {
                audio.play();
                showNotification('éŸ³ä¹å·²æ’­æ”¾', 'success');
            } else {
                audio.pause();
                showNotification('éŸ³ä¹å·²æš‚åœ', 'info');
            }
        }
        
        // åœæ­¢æ‰€æœ‰åª’ä½“
        function stopAllMedia() {
            var video = document.getElementById('background-video');
            var audio = document.getElementById('background-audio');
            video.pause();
            audio.pause();
            showNotification('æ‰€æœ‰åª’ä½“å·²åœæ­¢', 'warning');
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            var notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#17a2b8'};
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤é€šçŸ¥
            setTimeout(function() {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // åˆå§‹åŒ–åª’ä½“çŠ¶æ€
        window.addEventListener('load', function() {
            // é»˜è®¤æ’­æ”¾è§†é¢‘ï¼Œæš‚åœéŸ³é¢‘
            var video = document.getElementById('background-video');
            var audio = document.getElementById('background-audio');
            
            // ç¡®ä¿è§†é¢‘æ’­æ”¾
            video.play().catch(function(error) {
                console.log('è§†é¢‘æ’­æ”¾å¤±è´¥:', error);
            });
            
            // é»˜è®¤æš‚åœéŸ³é¢‘
            audio.pause();
            
            // æ·»åŠ åª’ä½“çŠ¶æ€ç›‘å¬
            video.addEventListener('play', function() {
                console.log('è§†é¢‘å¼€å§‹æ’­æ”¾');
            });
            
            video.addEventListener('pause', function() {
                console.log('è§†é¢‘å·²æš‚åœ');
            });
            
            audio.addEventListener('play', function() {
                console.log('éŸ³é¢‘å¼€å§‹æ’­æ”¾');
            });
            
            audio.addEventListener('pause', function() {
                console.log('éŸ³é¢‘å·²æš‚åœ');
            });
        });

        // æ˜¾ç¤ºå»ºè®®ç•Œé¢
        function showSuggestions() {
            // å…ˆè·å–ç°æœ‰å»ºè®®
            fetch('/content/api/suggestions/')
                .then(response => response.json())
                .then(data => {
                    let suggestionsHtml = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 90%;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h3 style="color: #333; margin: 0;">
                                        <i class="fas fa-lightbulb" style="color: #ffc107;"></i> æˆ‘çš„å»ºè®®
                                    </h3>
                                    <button onclick="closeSuggestions()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h5 style="color: #333;">ğŸ’¡ ç°æœ‰å»ºè®®</h5>
                                    <div id="existingSuggestions">`;
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(suggestion => {
                            // æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²
                            let statusColor = '#28a745'; // é»˜è®¤ç»¿è‰²
                            let borderColor = '#28a745';
                            let statusIcon = 'ğŸ“‹';
                            
                            switch(suggestion.status_code) {
                                case 'pending':
                                    statusColor = '#ffc107';
                                    borderColor = '#ffc107';
                                    statusIcon = 'â³';
                                    break;
                                case 'reviewing':
                                    statusColor = '#17a2b8';
                                    borderColor = '#17a2b8';
                                    statusIcon = 'ğŸ‘€';
                                    break;
                                case 'implemented':
                                    statusColor = '#28a745';
                                    borderColor = '#28a745';
                                    statusIcon = 'âœ…';
                                    break;
                                case 'rejected':
                                    statusColor = '#dc3545';
                                    borderColor = '#dc3545';
                                    statusIcon = 'âŒ';
                                    break;
                            }
                            
                            suggestionsHtml += `
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${borderColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <h6 style="margin: 0; color: #333;">${suggestion.title}</h6>
                                        <div style="text-align: right;">
                                            <span style="font-size: 12px; color: #666;">${suggestion.created_at}</span>
                                            <br>
                                            <span style="font-size: 11px; color: #999;">æ›´æ–°: ${suggestion.updated_at}</span>
                                        </div>
                                    </div>
                                    <p style="margin: 0; color: #666; margin-bottom: 8px;">${suggestion.content}</p>
                                    <div style="display: flex; gap: 10px; font-size: 12px; margin-bottom: 8px;">
                                        <span style="color: #007bff;">ğŸ“ ç±»å‹: ${suggestion.suggestion_type}</span>
                                        <span style="color: ${statusColor}; font-weight: bold;">${statusIcon} çŠ¶æ€: ${suggestion.status}</span>
                                        <span style="color: #666;">ğŸ‘¤ æäº¤è€…: ${suggestion.user_name}</span>
                                    </div>
                                    ${suggestion.has_response ? 
                                        '<div style="margin-top: 8px; padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;"><strong style="color: #1976d2;">ç®¡ç†å‘˜å›å¤:</strong><br>' + suggestion.admin_response + '</div>' : 
                                        '<div style="margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 12px; color: #666; text-align: center;">ç­‰å¾…ç®¡ç†å‘˜å¤„ç†ä¸­...</div>'
                                    }
                                </div>`;
                        });
                    } else {
                        suggestionsHtml += `<p style="color: #666; text-align: center;">æš‚æ— å»ºè®®</p>`;
                    }
                    
                    suggestionsHtml += `
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h5 style="color: #333;">ğŸ“ æ·»åŠ æ–°å»ºè®®</h5>
                                    <div style="margin-bottom: 10px;">
                                        <input type="text" id="suggestionTitle" placeholder="å»ºè®®æ ‡é¢˜..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;">
                                        <select id="suggestionType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;">
                                            <option value="feature">åŠŸèƒ½å»ºè®®</option>
                                            <option value="ui">ç•Œé¢æ”¹è¿›</option>
                                            <option value="bug">BugæŠ¥å‘Š</option>
                                            <option value="other">å…¶ä»–</option>
                                        </select>
                                        <textarea id="newSuggestion" placeholder="è¯·è¾“å…¥æ‚¨çš„å»ºè®®å†…å®¹..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                                    </div>
                                </div>
                                
                                <div style="text-align: center;">
                                    <button onclick="submitSuggestion()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                        <i class="fas fa-paper-plane"></i> æäº¤å»ºè®®
                                    </button>
                                    <button onclick="closeSuggestions()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                        å…³é—­
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', suggestionsHtml);
                })
                .catch(error => {
                    console.error('è·å–å»ºè®®å¤±è´¥:', error);
                    showNotification('è·å–å»ºè®®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
        }
        
        // å…³é—­å»ºè®®ç•Œé¢
        function closeSuggestions() {
            const suggestions = document.querySelector('div[style*="z-index: 10000"]');
            if (suggestions) {
                suggestions.remove();
            }
        }
        
        // æäº¤å»ºè®®
        function submitSuggestion() {
            const title = document.getElementById('suggestionTitle').value;
            const content = document.getElementById('newSuggestion').value;
            const suggestionType = document.getElementById('suggestionType').value;
            
            if (!title.trim() || !content.trim()) {
                showNotification('è¯·å¡«å†™å»ºè®®æ ‡é¢˜å’Œå†…å®¹', 'warning');
                return;
            }
            
            const suggestionData = {
                title: title,
                content: content,
                suggestion_type: suggestionType,
                user_name: '{{ user.username }}' || 'åŒ¿åç”¨æˆ·',
                user_email: '{{ user.email }}' || ''
            };
            
            fetch('/content/api/suggestions/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(suggestionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    closeSuggestions();
                    // åˆ·æ–°å»ºè®®åˆ—è¡¨
                    setTimeout(() => {
                        showSuggestions();
                    }, 1000);
                } else {
                    showNotification(data.error || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            })
            .catch(error => {
                console.error('æäº¤å»ºè®®å¤±è´¥:', error);
                showNotification('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            });
        }
        
        // æ˜¾ç¤ºåé¦ˆç•Œé¢
        function showFeedback() {
            const feedbackHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; max-height: 80vh; overflow-y: auto; width: 90%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #333; margin: 0;">
                                <i class="fas fa-comment" style="color: #17a2b8;"></i> æ„è§åé¦ˆ
                            </h3>
                            <button onclick="closeFeedback()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #333;">åé¦ˆç±»å‹ï¼š</label>
                            <select id="feedbackType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                                <option value="bug">BugæŠ¥å‘Š</option>
                                <option value="feature">åŠŸèƒ½å»ºè®®</option>
                                <option value="ui">ç•Œé¢æ”¹è¿›</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #333;">åé¦ˆå†…å®¹ï¼š</label>
                            <textarea id="feedbackContent" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„åé¦ˆ..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="submitFeedback()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                <i class="fas fa-paper-plane"></i> æäº¤åé¦ˆ
                            </button>
                            <button onclick="closeFeedback()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', feedbackHtml);
        }
        
        // å…³é—­åé¦ˆç•Œé¢
        function closeFeedback() {
            const feedback = document.querySelector('div[style*="z-index: 10000"]');
            if (feedback) {
                feedback.remove();
            }
        }
        
        // æäº¤åé¦ˆ
        function submitFeedback() {
            const type = document.getElementById('feedbackType').value;
            const content = document.getElementById('feedbackContent').value;
            
            if (!content.trim()) {
                showNotification('è¯·è¾“å…¥åé¦ˆå†…å®¹', 'warning');
                return;
            }
            
            const feedbackData = {
                feedback_type: type,
                content: content,
                user_name: '{{ user.username }}' || 'åŒ¿åç”¨æˆ·',
                user_email: '{{ user.email }}' || ''
            };
            
            fetch('/content/api/feedback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(feedbackData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    closeFeedback();
                } else {
                    showNotification(data.error || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            })
            .catch(error => {
                console.error('æäº¤åé¦ˆå¤±è´¥:', error);
                showNotification('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            });
        }
        
        // è·å–CSRF Token
        function getCSRFToken() {
            // é¦–å…ˆå°è¯•ä»metaæ ‡ç­¾è·å–
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
                return metaToken.getAttribute('content');
            }
            
            // ç„¶åå°è¯•ä»cookieè·å–
            return getCookie('csrftoken');
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
