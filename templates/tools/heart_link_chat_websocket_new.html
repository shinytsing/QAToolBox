{% extends 'base.html' %}
{% load static %}

{% block title %}ËÅäÂ§©ÂÆ§ - {{ room_id }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        max-width: 800px;
        margin: 0 auto;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-header h3 {
        margin: 0;
        font-size: 18px;
    }

    .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ff4757;
        animation: pulse 2s infinite;
    }

    .status-indicator.connected {
        background: #2ed573;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }

    .message.own {
        align-items: flex-end;
    }

    .message.other {
        align-items: flex-start;
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
    }

    .message.own .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.other .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 4px;
    }

    .message-content {
        margin-bottom: 5px;
    }

    .message-image {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .message-image:hover {
        transform: scale(1.05);
    }

    .message-audio {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .audio-player {
        height: 40px;
        border-radius: 20px;
    }

    .message-file {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
    }

    .message-file a {
        color: inherit;
        text-decoration: none;
        font-weight: 500;
    }

    .message-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #6c757d;
        margin-top: 4px;
    }

    .message.own .message-meta {
        justify-content: flex-end;
    }

    .message-time {
        font-size: 12px;
        font-weight: 600;
        color: #495057;
        background: rgba(255, 255, 255, 0.8);
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 4px;
    }

    .message-status {
        font-size: 11px;
        font-weight: 500;
    }

    .message-status.unread {
        color: #ff4757;
    }

    .message-status.read {
        color: #2ed573;
    }

    .chat-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #e9ecef;
    }

    .chat-toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .toolbar-btn {
        background: none;
        border: none;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.2s;
        color: #6c757d;
    }

    .toolbar-btn:hover {
        background: #f8f9fa;
        color: #495057;
    }

    .toolbar-btn.active {
        background: #e9ecef;
        color: #495057;
    }

    .emoji-picker {
        position: absolute;
        bottom: 100%;
        left: 0;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        z-index: 9999;
        display: none;
        min-width: 200px;
        max-width: 300px;
        margin-bottom: 10px;
    }
    
    .emoji-picker.show {
        display: block !important;
    }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 5px;
    }

    .emoji-btn {
        background: none;
        border: none;
        padding: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 20px;
        transition: background-color 0.2s;
    }

    .emoji-btn:hover {
        background: #f8f9fa;
    }

    .chat-input-wrapper {
        position: relative;
        display: flex;
        align-items: flex-end;
        gap: 10px;
    }

    .chat-input {
        flex: 1;
        border: 1px solid #e9ecef;
        border-radius: 20px;
        padding: 12px 16px;
        resize: none;
        outline: none;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.4;
        max-height: 120px;
        transition: all 0.2s;
        background: #f8f9fa;
        color: #495057;
    }

    .chat-input:focus {
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .chat-input::placeholder {
        color: #adb5bd;
    }

    .chat-send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-send-btn:hover {
        transform: scale(1.05);
    }

    .chat-send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .typing-indicator {
        padding: 10px 20px;
        color: #6c757d;
        font-style: italic;
        font-size: 14px;
    }

    .system-message {
        text-align: center;
        margin: 20px 0;
        padding: 10px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        color: #6c757d;
    }

    .room-ended-message {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .welcome-message {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .welcome-message h4 {
        margin-bottom: 10px;
        color: #495057;
    }

    .no-messages {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .cooldown-message {
        font-size: 12px;
        color: #6c757d;
        text-align: center;
        margin-top: 5px;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .file-input {
        display: none;
    }

    .upload-progress {
        margin-top: 10px;
        padding: 10px;
        background: #e9ecef;
        border-radius: 8px;
        display: none;
    }

    .progress-bar {
        width: 100%;
        height: 4px;
        background: #dee2e6;
        border-radius: 2px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s;
    }

    @media (max-width: 768px) {
        .chat-container {
            height: 100vh;
            border-radius: 0;
        }
        
        .message-bubble {
            max-width: 85%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- ËÅäÂ§©Â§¥ÈÉ® -->
    <div class="chat-header">
        <h3>ËÅäÂ§©ÂÆ§ {{ room_id|truncatechars:8 }}</h3>
        <div class="connection-status">
            <div class="status-indicator" id="status-indicator"></div>
            <span id="status-text">ËøûÊé•‰∏≠...</span>
        </div>
    </div>

    <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
    <div class="chat-messages" id="chat-messages">
        <div class="welcome-message">
            <h4>Ê¨¢ËøéÊù•Âà∞ËÅäÂ§©ÂÆ§</h4>
            <p>ÂºÄÂßãÊÇ®ÁöÑÂØπËØùÂêßÔºÅ</p>
        </div>
    </div>

    <!-- ËÅäÂ§©ËæìÂÖ•Âå∫Âüü -->
    <div class="chat-input-container">
        <!-- Â∑•ÂÖ∑Ê†è -->
        <div class="chat-toolbar">
            <button class="toolbar-btn" title="Ë°®ÊÉÖ" id="emoji-btn">
                <i class="fas fa-smile"></i>
            </button>
            <button class="toolbar-btn" title="ÂõæÁâá" onclick="document.getElementById('image-input').click()">
                <i class="fas fa-image"></i>
            </button>
            <button class="toolbar-btn" title="ÂΩïÈü≥" id="record-btn">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="toolbar-btn" title="Êñá‰ª∂" onclick="document.getElementById('file-input').click()">
                <i class="fas fa-paperclip"></i>
            </button>
        </div>

        <!-- Ë°®ÊÉÖÈÄâÊã©Âô® -->
        <div class="emoji-picker" id="emoji-picker" style="display: none;">
            <div class="emoji-grid">
                <button class="emoji-btn" onclick="insertEmoji('üòä')">üòä</button>
                <button class="emoji-btn" onclick="insertEmoji('üòÇ')">üòÇ</button>
                <button class="emoji-btn" onclick="insertEmoji('üòç')">üòç</button>
                <button class="emoji-btn" onclick="insertEmoji('ü§î')">ü§î</button>
                <button class="emoji-btn" onclick="insertEmoji('üëç')">üëç</button>
                <button class="emoji-btn" onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button class="emoji-btn" onclick="insertEmoji('üò≠')">üò≠</button>
                <button class="emoji-btn" onclick="insertEmoji('üéâ')">üéâ</button>
                <button class="emoji-btn" onclick="insertEmoji('üî•')">üî•</button>
                <button class="emoji-btn" onclick="insertEmoji('üíØ')">üíØ</button>
                <button class="emoji-btn" onclick="insertEmoji('üòé')">üòé</button>
                <button class="emoji-btn" onclick="insertEmoji('ü§ó')">ü§ó</button>
                <button class="emoji-btn" onclick="insertEmoji('üò¥')">üò¥</button>
                <button class="emoji-btn" onclick="insertEmoji('ü§Ø')">ü§Ø</button>
                <button class="emoji-btn" onclick="insertEmoji('ü•≥')">ü•≥</button>
                <button class="emoji-btn" onclick="insertEmoji('üòá')">üòá</button>
            </div>
        </div>

        <!-- ËæìÂÖ•Âå∫Âüü -->
        <div class="chat-input-wrapper">
            <textarea 
                class="chat-input" 
                id="chat-input" 
                placeholder="ËæìÂÖ•Ê∂àÊÅØ..." 
                rows="1"
                onkeydown="handleKeyDown(event)"
                oninput="autoResize(this)"
            ></textarea>
            <button class="chat-send-btn" id="send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

        <!-- ÂÜ∑Âç¥ÊèêÁ§∫ -->
        <div class="cooldown-message" id="send-cooldown"></div>

        <!-- ‰∏ä‰º†ËøõÂ∫¶ -->
        <div class="upload-progress" id="upload-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
    <input type="file" id="image-input" class="file-input" accept="image/*" onchange="handleImageUpload(event)">
    <input type="file" id="file-input" class="file-input" onchange="handleFileUpload(event)">
</div>

<!-- ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">ÂõæÁâáÈ¢ÑËßà</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeImageModal()"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modal-image" src="" alt="È¢ÑËßàÂõæÁâá" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImageModal()">ÂÖ≥Èó≠</button>
                <button type="button" class="btn btn-primary" onclick="downloadImage()">‰∏ãËΩΩÂõæÁâá</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// WebSocketËøûÊé•
let socket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;

// ËÅäÂ§©Áä∂ÊÄÅ
let lastMessageId = 0;
let typingTimeout = null;
let sendCooldown = false;
let sendCooldownTimer = null;
let isRecording = false;
let recordingTimer = null;
let recordingStartTime = null;
let mediaRecorder = null;
let audioChunks = [];

// Ëé∑ÂèñÊàøÈó¥ID
const roomId = '{{ room_id }}';

// È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    console.log('È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÂàùÂßãÂåñ...');
    
    // Âª∂Ëøü‰∏ÄÁÇπÂàùÂßãÂåñÔºåÁ°Æ‰øùDOMÂÆåÂÖ®ÂáÜÂ§áÂ•Ω
    setTimeout(() => {
        initializeEventListeners();
        connectWebSocket();
        loadInitialMessages();
    }, 100);
});

// ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
function initializeEventListeners() {
    console.log('ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®...');
    
    // Ë°®ÊÉÖÊåâÈíÆ
    const emojiBtn = document.getElementById('emoji-btn');
    if (emojiBtn) {
        console.log('ÁªëÂÆöË°®ÊÉÖÊåâÈíÆ‰∫ã‰ª∂');
        emojiBtn.addEventListener('click', function(e) {
            console.log('Ë°®ÊÉÖÊåâÈíÆË¢´ÁÇπÂáª');
            e.preventDefault();
            e.stopPropagation();
            toggleEmojiPicker();
        });
    } else {
        console.error('Ë°®ÊÉÖÊåâÈíÆÊú™ÊâæÂà∞');
    }

    // ÂèëÈÄÅÊåâÈíÆ
    const sendBtn = document.getElementById('send-btn');
    if (sendBtn) {
        console.log('ÁªëÂÆöÂèëÈÄÅÊåâÈíÆ‰∫ã‰ª∂');
        sendBtn.addEventListener('click', function(e) {
            console.log('ÂèëÈÄÅÊåâÈíÆË¢´ÁÇπÂáª');
            e.preventDefault();
            e.stopPropagation();
            
            if (sendCooldown) {
                console.log('Send button blocked by cooldown');
                return;
            }
            
            if (sendBtn.disabled) {
                console.log('Send button blocked by disabled state');
                return;
            }
            
            console.log('Sending message via button click');
            sendMessage();
        });
    } else {
        console.error('ÂèëÈÄÅÊåâÈíÆÊú™ÊâæÂà∞');
    }

    // ÂΩïÈü≥ÊåâÈíÆ
    const recordBtn = document.getElementById('record-btn');
    if (recordBtn) {
        console.log('ÁªëÂÆöÂΩïÈü≥ÊåâÈíÆ‰∫ã‰ª∂');
        recordBtn.addEventListener('click', function(e) {
            console.log('ÂΩïÈü≥ÊåâÈíÆË¢´ÁÇπÂáª');
            e.preventDefault();
            e.stopPropagation();
            
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });
    } else {
        console.error('ÂΩïÈü≥ÊåâÈíÆÊú™ÊâæÂà∞');
    }
    
    console.log('‰∫ã‰ª∂ÁõëÂê¨Âô®ÂàùÂßãÂåñÂÆåÊàê');
}

// ËøûÊé•WebSocket
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/${roomId}/`;
    
    socket = new WebSocket(wsUrl);
    
    socket.onopen = function(event) {
        console.log('WebSocketËøûÊé•Â∑≤Âª∫Á´ã');
        updateConnectionStatus(true);
        reconnectAttempts = 0;
    };
    
    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
    };
    
    socket.onclose = function(event) {
        console.log('WebSocketËøûÊé•Â∑≤ÂÖ≥Èó≠Ôºå‰ª£Á†Å:', event.code, 'ÂéüÂõ†:', event.reason);
        updateConnectionStatus(false);
        
        // Â¶ÇÊûú‰∏çÊòØÊ≠£Â∏∏ÂÖ≥Èó≠ÔºåÂ∞ùËØïÈáçËøû
        if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
            setTimeout(() => {
                reconnectAttempts++;
                console.log(`Â∞ùËØïÈáçÊñ∞ËøûÊé•... (${reconnectAttempts}/${maxReconnectAttempts})`);
                connectWebSocket();
            }, reconnectDelay);
        } else if (reconnectAttempts >= maxReconnectAttempts) {
            console.error('ÈáçËøûÊ¨°Êï∞Â∑≤Ëææ‰∏äÈôêÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
            alert('ËøûÊé•Â∑≤Êñ≠ÂºÄÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        }
    };
    
    socket.onerror = function(error) {
        console.error('WebSocketÈîôËØØ:', error);
        updateConnectionStatus(false);
    };
}

// Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
function updateConnectionStatus(connected) {
    const indicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    
    if (connected) {
        indicator.classList.add('connected');
        statusText.textContent = 'Â∑≤ËøûÊé•';
    } else {
        indicator.classList.remove('connected');
        statusText.textContent = 'ËøûÊé•‰∏≠...';
    }
}

// Â§ÑÁêÜWebSocketÊ∂àÊÅØ
function handleWebSocketMessage(data) {
    console.log('Êî∂Âà∞WebSocketÊ∂àÊÅØ:', data);
    
    switch (data.type) {
        case 'connection_established':
            console.log('WebSocketËøûÊé•ÊàêÂäü');
            break;
            
        case 'chat_message':
            addMessageToChat(data.message);
            break;
            
        case 'user_typing':
            handleUserTyping(data.username, data.is_typing);
            break;
            
        case 'read_status_update':
            updateMessageReadStatus(data.message_ids, data.username);
            break;
            
        default:
            console.log('Êú™Áü•Ê∂àÊÅØÁ±ªÂûã:', data.type);
    }
}

// Âä†ËΩΩÂàùÂßãÊ∂àÊÅØ
function loadInitialMessages() {
    fetch(`/tools/api/chat/${roomId}/messages/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.messages) {
                displayMessages(data.messages);
                // Ê†áËÆ∞Ê∂àÊÅØ‰∏∫Â∑≤ËØª
                markMessagesAsRead();
            } else if (data.room_ended) {
                showRoomEndedMessage();
                disableChatInput();
            }
        })
        .catch(error => console.error('Error loading messages:', error));
}

// ÊòæÁ§∫Ê∂àÊÅØ
function displayMessages(messages) {
    const messagesContainer = document.getElementById('chat-messages');
    const welcomeMessage = messagesContainer.querySelector('.welcome-message');
    if (welcomeMessage) {
        welcomeMessage.remove();
    }
    
    messages.forEach(message => {
        if (message.id > lastMessageId) {
            addMessageToChat(message);
            lastMessageId = Math.max(lastMessageId, message.id);
        }
    });
}

// Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©ÁïåÈù¢
function addMessageToChat(message) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.is_own ? 'own' : 'other'}`;
    messageDiv.setAttribute('data-message-id', message.id);
    
    const time = new Date(message.created_at).toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    let contentHtml = '';
    if (message.message_type === 'image') {
        contentHtml = `<img src="${message.file_url}" alt="ÂõæÁâá" class="message-image" onclick="openImageModal('${message.file_url}')">`;
    } else if (message.message_type === 'audio') {
        contentHtml = `
            <div class="message-audio">
                <audio controls class="audio-player">
                    <source src="${message.file_url}" type="audio/wav">
                    ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ
                </audio>
            </div>
        `;
    } else if (message.message_type === 'file') {
        // Á°Æ‰øùÊñá‰ª∂URLÊòØÂÆåÊï¥ÁöÑ
        const fileUrl = message.file_url.startsWith('http') ? message.file_url : window.location.origin + message.file_url;
        contentHtml = `
            <div class="message-file">
                <i class="fas fa-file"></i>
                <a href="${fileUrl}" target="_blank" download="${message.content}" onclick="downloadFile('${fileUrl}', '${message.content}')">${message.content}</a>
            </div>
        `;
    } else {
        contentHtml = `<div class="message-content">${escapeHtml(message.content)}</div>`;
    }
    
    let statusHtml = '';
    if (message.is_own) {
        // ÂèëÈÄÅÊñπÊòæÁ§∫Â∑≤ËØªÁä∂ÊÄÅÔºàÁü•ÈÅìÂØπÊñπÊòØÂê¶Â∑≤ËØªÔºâ
        statusHtml = `<span class="message-status ${message.is_read ? 'read' : 'unread'}">${message.is_read ? 'Â∑≤ËØª' : 'Êú™ËØª'}</span>`;
    } else {
        // Êé•Êî∂Êñπ‰∏çÊòæÁ§∫Â∑≤ËØªÁä∂ÊÄÅ
        statusHtml = '';
    }
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            ${contentHtml}
            <div class="message-meta">
                <span class="message-time">${time}</span>
                ${statusHtml}
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
}

// ÂèëÈÄÅÊ∂àÊÅØ
function sendMessage() {
    if (sendCooldown) {
        console.log('Message blocked by cooldown');
        return;
    }
    
    const input = document.getElementById('chat-input');
    const content = input.value.trim();
    
    if (!content) {
        console.log('Message blocked: empty content');
        return;
    }
    
    // ËÆæÁΩÆÂÜ∑Âç¥
    setSendCooldown(1000);
    
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    
    console.log('Sending message:', content);
    
    // ÈÄöËøáWebSocketÂèëÈÄÅÊ∂àÊÅØ
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'message',
            content: content,
            message_type: 'text'
        }));
        
        // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
        input.value = '';
        autoResize(input);
        
        // ÈáçÊñ∞ÂêØÁî®ÂèëÈÄÅÊåâÈíÆ
        setTimeout(() => {
            sendBtn.disabled = false;
        }, 1000);
    } else {
        console.error('WebSocketÊú™ËøûÊé•');
        alert('ËøûÊé•Â∑≤Êñ≠ÂºÄÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
    }
}

// Â§ÑÁêÜÂõûËΩ¶ÈîÆ
function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        event.stopPropagation();
        
        if (sendCooldown) {
            console.log('Enter blocked by cooldown');
            return false;
        }
        
        const sendBtn = document.getElementById('send-btn');
        if (sendBtn.disabled) {
            console.log('Enter blocked by disabled button');
            return false;
        }
        
        const input = document.getElementById('chat-input');
        const content = input.value.trim();
        if (!content) {
            console.log('Enter blocked: empty content');
            return false;
        }
        
        console.log('Sending message via Enter key');
        sendMessage();
        
        return false;
    }
}

// Â§ÑÁêÜÂèëÈÄÅÊåâÈíÆÁÇπÂáªÔºàÂ∑≤ÂÜÖËÅîÂà∞‰∫ã‰ª∂ÁõëÂê¨Âô®‰∏≠Ôºâ

// ËÆæÁΩÆÂèëÈÄÅÂÜ∑Âç¥
function setSendCooldown(duration) {
    console.log('Setting send cooldown for', duration, 'ms');
    sendCooldown = true;
    const cooldownElement = document.getElementById('send-cooldown');
    cooldownElement.textContent = 'ÂèëÈÄÅÂÜ∑Âç¥‰∏≠...';
    
    if (sendCooldownTimer) {
        clearTimeout(sendCooldownTimer);
    }
    
    sendCooldownTimer = setTimeout(() => {
        sendCooldown = false;
        cooldownElement.textContent = '';
        console.log('Send cooldown expired');
    }, duration);
}

// Â§ÑÁêÜË°®ÊÉÖÊåâÈíÆÁÇπÂáªÔºàÂ∑≤ÂÜÖËÅîÂà∞‰∫ã‰ª∂ÁõëÂê¨Âô®‰∏≠Ôºâ

// ÂàáÊç¢Ë°®ÊÉÖÈÄâÊã©Âô®
function toggleEmojiPicker() {
    console.log('ÂàáÊç¢Ë°®ÊÉÖÈÄâÊã©Âô®...');
    const picker = document.getElementById('emoji-picker');
    if (!picker) {
        console.error('Ë°®ÊÉÖÈÄâÊã©Âô®Êú™ÊâæÂà∞');
        return;
    }
    
    const isVisible = picker.classList.contains('show');
    
    if (isVisible) {
        // ÈöêËóèË°®ÊÉÖÈÄâÊã©Âô®
        picker.classList.remove('show');
        picker.style.display = 'none';
        console.log('Ë°®ÊÉÖÈÄâÊã©Âô®Â∑≤ÈöêËóè');
    } else {
        // ÊòæÁ§∫Ë°®ÊÉÖÈÄâÊã©Âô®
        picker.classList.add('show');
        picker.style.display = 'block';
        picker.style.position = 'absolute';
        picker.style.zIndex = '9999';
        console.log('Ë°®ÊÉÖÈÄâÊã©Âô®Â∑≤ÊòæÁ§∫');
        
        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Ë°®ÊÉÖÈÄâÊã©Âô®
        setTimeout(() => {
            document.addEventListener('click', function closeEmojiPicker(e) {
                if (!picker.contains(e.target) && !e.target.closest('#emoji-btn')) {
                    picker.classList.remove('show');
                    picker.style.display = 'none';
                    document.removeEventListener('click', closeEmojiPicker);
                }
            });
        }, 100);
    }
}

// Ëé∑ÂèñCookieÂáΩÊï∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ÊèíÂÖ•Ë°®ÊÉÖ
function insertEmoji(emoji) {
    const input = document.getElementById('chat-input');
    if (!input) {
        console.error('ËÅäÂ§©ËæìÂÖ•Ê°ÜÊú™ÊâæÂà∞');
        return;
    }
    
    const start = input.selectionStart;
    const end = input.selectionEnd;
    const text = input.value;
    
    input.value = text.substring(0, start) + emoji + text.substring(end);
    input.selectionStart = input.selectionEnd = start + emoji.length;
    input.focus();
    
    // Ëá™Âä®Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
    autoResize(input);
    
    const picker = document.getElementById('emoji-picker');
    if (picker) {
        picker.style.display = 'none';
    }
}

// Â§ÑÁêÜÂõæÁâá‰∏ä‰º†
function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
    if (!file.type.startsWith('image/')) {
        alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
        return;
    }
    
    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºà5MBÔºâ
    if (file.size > 5 * 1024 * 1024) {
        alert('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB');
        return;
    }
    
    const formData = new FormData();
    formData.append('image', file);
    formData.append('room_id', roomId);
    
    // Ëé∑ÂèñCSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
    if (!csrfToken) {
        alert('CSRF tokenÊú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        return;
    }
    
    // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
    const progressDiv = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    if (progressDiv) progressDiv.style.display = 'block';
    
    fetch(`/tools/api/chat/${roomId}/send-image/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (progressDiv) progressDiv.style.display = 'none';
        if (data.success) {
            // ÈÄöËøáWebSocketÂèëÈÄÅÂõæÁâáÊ∂àÊÅØ
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'message',
                    content: 'ÂõæÁâá',
                    message_type: 'image',
                    file_url: data.file_url
                }));
            }
        } else {
            alert('ÂèëÈÄÅÂõæÁâáÂ§±Ë¥•: ' + data.error);
        }
    })
    .catch(error => {
        if (progressDiv) progressDiv.style.display = 'none';
        console.error('Error:', error);
        alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
    });
    
    event.target.value = '';
}

// Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºà10MBÔºâ
    if (file.size > 10 * 1024 * 1024) {
        alert('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá10MB');
        return;
    }
    
    // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûãÔºàÊéíÈô§ÂèØÊâßË°åÊñá‰ª∂Ôºâ
    const dangerousExtensions = ['.exe', '.bat', '.cmd', '.com', '.scr', '.pif', '.vbs', '.js', '.jar'];
    const fileName = file.name.toLowerCase();
    const hasDangerousExtension = dangerousExtensions.some(ext => fileName.endsWith(ext));
    
    if (hasDangerousExtension) {
        alert('‰∏çÂÖÅËÆ∏‰∏ä‰º†ÂèØÊâßË°åÊñá‰ª∂');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('room_id', roomId);
    
    // Ëé∑ÂèñCSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
    if (!csrfToken) {
        alert('CSRF tokenÊú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        return;
    }
    
    fetch(`/tools/api/chat/${roomId}/send-file/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ÈÄöËøáWebSocketÂèëÈÄÅÊñá‰ª∂Ê∂àÊÅØ
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'message',
                    content: file.name,
                    message_type: 'file',
                    file_url: data.file_url
                }));
            }
        } else {
            alert('ÂèëÈÄÅÊñá‰ª∂Â§±Ë¥•: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
    });
    
    event.target.value = '';
}

// Â§ÑÁêÜÂΩïÈü≥ÔºàÂ∑≤ÂÜÖËÅîÂà∞‰∫ã‰ª∂ÁõëÂê¨Âô®‰∏≠Ôºâ

// ÂºÄÂßãÂΩïÈü≥
function startRecording() {
    // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÂΩïÈü≥ÂäüËÉΩ');
        return;
    }
    
    navigator.mediaDevices.getUserMedia({ 
        audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
        } 
    })
    .then(stream => {
        mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'audio/webm;codecs=opus'
        });
        audioChunks = [];
        
        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            
            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÈôêÂà∂Ôºà10MBÔºâ
            if (audioBlob.size > 10 * 1024 * 1024) {
                alert('ÂΩïÈü≥Êñá‰ª∂ËøáÂ§ßÔºåËØ∑ÂΩïÂà∂Êõ¥Áü≠ÁöÑÈü≥È¢ë');
                stream.getTracks().forEach(track => track.stop());
                return;
            }
            
            // Áõ¥Êé•ÂèëÈÄÅWebMÊ†ºÂºèÔºåËÆ©ÊúçÂä°Âô®Â§ÑÁêÜËΩ¨Êç¢
            sendAudioMessage(audioBlob);
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.onerror = (event) => {
            console.error('ÂΩïÈü≥ÈîôËØØ:', event.error);
            alert('ÂΩïÈü≥ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ');
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start(1000); // ÊØèÁßíÊî∂ÈõÜ‰∏ÄÊ¨°Êï∞ÊçÆ
        isRecording = true;
        recordingStartTime = Date.now();
        
        const recordBtn = document.getElementById('record-btn');
        if (recordBtn) {
            recordBtn.classList.add('active');
            recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
            recordBtn.style.color = '#ff4757';
        }
        
        // ÂºÄÂßãÂΩïÈü≥ËÆ°Êó∂
        recordingTimer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            if (recordBtn) {
                recordBtn.title = `ÂΩïÈü≥‰∏≠... ${elapsed}s`;
            }
        }, 1000);
        
        console.log('ÂΩïÈü≥Â∑≤ÂºÄÂßã');
    })
    .catch(error => {
        console.error('ÂΩïÈü≥Â§±Ë¥•:', error);
        if (error.name === 'NotAllowedError') {
            alert('ËØ∑ÂÖÅËÆ∏ËÆøÈóÆÈ∫¶ÂÖãÈ£éÊùÉÈôê');
        } else if (error.name === 'NotFoundError') {
            alert('Êú™ÊâæÂà∞È∫¶ÂÖãÈ£éËÆæÂ§á');
        } else {
            alert('ÂΩïÈü≥Â§±Ë¥•: ' + error.message);
        }
    });
}

// Â∞ÜWebMÈü≥È¢ëËΩ¨Êç¢‰∏∫WAVÊ†ºÂºè
function convertWebmToWav(webmBlob) {
    return new Promise((resolve, reject) => {
        try {
            // ÂàõÂª∫Èü≥È¢ë‰∏ä‰∏ãÊñá
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const fileReader = new FileReader();
            
            fileReader.onload = function(e) {
                audioContext.decodeAudioData(e.target.result, function(buffer) {
                    // ÂàõÂª∫WAVÊñá‰ª∂
                    const wavBuffer = audioBufferToWav(buffer);
                    const wavBlob = new Blob([wavBuffer], { type: 'audio/wav' });
                    resolve(wavBlob);
                }, function(error) {
                    reject(error);
                });
            };
            
            fileReader.onerror = function(error) {
                reject(error);
            };
            
            fileReader.readAsArrayBuffer(webmBlob);
        } catch (error) {
            reject(error);
        }
    });
}

// Â∞ÜAudioBufferËΩ¨Êç¢‰∏∫WAVÊ†ºÂºè
function audioBufferToWav(buffer) {
    const length = buffer.length;
    const numberOfChannels = buffer.numberOfChannels;
    const sampleRate = buffer.sampleRate;
    const arrayBuffer = new ArrayBuffer(44 + length * numberOfChannels * 2);
    const view = new DataView(arrayBuffer);
    
    // WAVÊñá‰ª∂Â§¥
    const writeString = (offset, string) => {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    };
    
    writeString(0, 'RIFF');
    view.setUint32(4, 36 + length * numberOfChannels * 2, true);
    writeString(8, 'WAVE');
    writeString(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, numberOfChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * numberOfChannels * 2, true);
    view.setUint16(32, numberOfChannels * 2, true);
    view.setUint16(34, 16, true);
    writeString(36, 'data');
    view.setUint32(40, length * numberOfChannels * 2, true);
    
    // ÂÜôÂÖ•Èü≥È¢ëÊï∞ÊçÆ
    let offset = 44;
    for (let i = 0; i < length; i++) {
        for (let channel = 0; channel < numberOfChannels; channel++) {
            const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
            view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
            offset += 2;
        }
    }
    
    return arrayBuffer;
}

// ÂÅúÊ≠¢ÂΩïÈü≥
function stopRecording() {
    if (mediaRecorder && isRecording) {
        try {
            mediaRecorder.stop();
            isRecording = false;
            
            const recordBtn = document.getElementById('record-btn');
            if (recordBtn) {
                recordBtn.classList.remove('active');
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                recordBtn.title = 'ÂΩïÈü≥';
                recordBtn.style.color = '';
            }
            
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            console.log('ÂΩïÈü≥Â∑≤ÂÅúÊ≠¢');
        } catch (error) {
            console.error('ÂÅúÊ≠¢ÂΩïÈü≥Â§±Ë¥•:', error);
        }
    }
}

// ÂèëÈÄÅÈü≥È¢ëÊ∂àÊÅØ
function sendAudioMessage(audioBlob) {
    const formData = new FormData();
    formData.append('audio', audioBlob, 'recording.wav');
    formData.append('room_id', roomId);
    
    // Ëé∑ÂèñCSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
    if (!csrfToken) {
        alert('CSRF tokenÊú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        return;
    }
    
    fetch(`/tools/api/chat/${roomId}/send-audio/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ÈÄöËøáWebSocketÂèëÈÄÅÈü≥È¢ëÊ∂àÊÅØ
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'message',
                    content: 'ËØ≠Èü≥Ê∂àÊÅØ',
                    message_type: 'audio',
                    file_url: data.file_url
                }));
            }
        } else {
            alert('ÂèëÈÄÅÈü≥È¢ëÂ§±Ë¥•: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
    });
}

// Ê†áËÆ∞Ê∂àÊÅØ‰∏∫Â∑≤ËØª
function markMessagesAsRead() {
    const unreadMessages = document.querySelectorAll('.message.other .message-status.unread');
    if (unreadMessages.length > 0) {
        const messageIds = Array.from(unreadMessages).map(el => {
            const messageDiv = el.closest('.message');
            return messageDiv.getAttribute('data-message-id');
        });
        
        console.log('Ê†áËÆ∞Ê∂àÊÅØ‰∏∫Â∑≤ËØª:', messageIds);
        
        // ÈÄöËøáWebSocketÂèëÈÄÅÂ∑≤ËØªÁä∂ÊÄÅ
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                type: 'read_status',
                message_ids: messageIds
            }));
        }
        
        // ÂêåÊó∂ÈÄöËøáAPIÊ†áËÆ∞Â∑≤ËØª
        fetch(`/tools/api/chat/${roomId}/mark-read/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken')
            },
            body: JSON.stringify({ message_ids: messageIds })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('APIÊ†áËÆ∞Â∑≤ËØªÊàêÂäü');
            }
        })
        .catch(error => {
            console.error('APIÊ†áËÆ∞Â∑≤ËØªÂ§±Ë¥•:', error);
        });
    }
}

// Êõ¥Êñ∞Ê∂àÊÅØÂ∑≤ËØªÁä∂ÊÄÅ
function updateMessageReadStatus(messageIds, username) {
    messageIds.forEach(messageId => {
        const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageDiv) {
            const statusElement = messageDiv.querySelector('.message-status');
            if (statusElement) {
                statusElement.textContent = 'Â∑≤ËØª';
                statusElement.className = 'message-status read';
            }
        }
    });
}

// Â§ÑÁêÜÁî®Êà∑ÊâìÂ≠óÁä∂ÊÄÅ
function handleUserTyping(username, isTyping) {
    // ÂèØ‰ª•Âú®ËøôÈáåÊòæÁ§∫"ÂØπÊñπÊ≠£Âú®ËæìÂÖ•..."ÁöÑÊèêÁ§∫
    console.log(`${username} ${isTyping ? 'Ê≠£Âú®ËæìÂÖ•' : 'ÂÅúÊ≠¢ËæìÂÖ•'}`);
}

// Ëá™Âä®Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// ÊªöÂä®Âà∞Â∫ïÈÉ®
function scrollToBottom() {
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ÊâìÂºÄÂõæÁâáÊ®°ÊÄÅÊ°Ü
function openImageModal(imageUrl) {
    console.log('ÊâìÂºÄÂõæÁâáÈ¢ÑËßà:', imageUrl);
    const modalElement = document.getElementById('imageModal');
    const modalImage = document.getElementById('modal-image');
    
    if (!modalElement || !modalImage) {
        console.error('Ê®°ÊÄÅÊ°ÜÂÖÉÁ¥†Êú™ÊâæÂà∞');
        window.open(imageUrl, '_blank');
        return;
    }
    
    // Á°Æ‰øùÂõæÁâáURLÊòØÂÆåÊï¥ÁöÑ
    const fullImageUrl = imageUrl.startsWith('http') ? imageUrl : window.location.origin + imageUrl;
    console.log('ÂÆåÊï¥ÂõæÁâáURL:', fullImageUrl);
    
    // ÂÖàËÆæÁΩÆÂõæÁâáÊ∫ê
    modalImage.src = fullImageUrl;
    window.currentImageUrl = fullImageUrl; // ‰øùÂ≠òÂõæÁâáURLÁî®‰∫é‰∏ãËΩΩ
    
    // Á°Æ‰øùÂõæÁâáÂä†ËΩΩÂÆåÊàêÂêéÂÜçÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modalImage.onload = function() {
        console.log('ÂõæÁâáÂä†ËΩΩÂÆåÊàêÔºåÊòæÁ§∫Ê®°ÊÄÅÊ°Ü');
        try {
            // Ê£ÄÊü•BootstrapÊòØÂê¶ÂèØÁî®
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                console.error('BootstrapÊú™Âä†ËΩΩ');
                modalElement.style.display = 'block';
                modalElement.classList.add('show');
            }
        } catch (error) {
            console.error('BootstrapÊ®°ÊÄÅÊ°ÜÈîôËØØ:', error);
            // Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
        }
    };
    
    modalImage.onerror = function() {
        console.error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•:', fullImageUrl);
        alert('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÂõæÁâáÈìæÊé•');
        window.open(fullImageUrl, '_blank');
    };
}

// ÂÖ≥Èó≠ÂõæÁâáÊ®°ÊÄÅÊ°Ü
function closeImageModal() {
    const modalElement = document.getElementById('imageModal');
    if (modalElement) {
        try {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                } else {
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                }
            } else {
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
            }
        } catch (error) {
            console.error('ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂ§±Ë¥•:', error);
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
        }
    }
}

// ‰∏ãËΩΩÂõæÁâá
function downloadImage() {
    const imageUrl = window.currentImageUrl;
    if (!imageUrl) {
        console.error('Ê≤°ÊúâÂõæÁâáURL');
        return;
    }
    
    try {
        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = 'image_' + Date.now() + '.jpg';
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log('ÂõæÁâá‰∏ãËΩΩÂ∑≤ÂºÄÂßã');
    } catch (error) {
        console.error('‰∏ãËΩΩÂõæÁâáÂ§±Ë¥•:', error);
        // Â§áÁî®ÊñπÊ°àÔºöÂú®Êñ∞Á™óÂè£ÊâìÂºÄ
        window.open(imageUrl, '_blank');
    }
}

// ‰∏ãËΩΩÊñá‰ª∂
function downloadFile(fileUrl, fileName) {
    console.log('ÂºÄÂßã‰∏ãËΩΩÊñá‰ª∂:', fileName, 'URL:', fileUrl);
    
    // Á°Æ‰øùÊñá‰ª∂URLÊòØÂÆåÊï¥ÁöÑ
    const fullFileUrl = fileUrl.startsWith('http') ? fileUrl : window.location.origin + fileUrl;
    
    try {
        // ‰ΩøÁî®fetch‰∏ãËΩΩÊñá‰ª∂
        fetch(fullFileUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.blob();
            })
            .then(blob => {
                // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                console.log('Êñá‰ª∂‰∏ãËΩΩÂ∑≤ÂºÄÂßã:', fileName);
            })
            .catch(error => {
                console.error('‰∏ãËΩΩÊñá‰ª∂Â§±Ë¥•:', error);
                // Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•ÊâìÂºÄÈìæÊé•
                window.open(fullFileUrl, '_blank');
            });
    } catch (error) {
        console.error('ÂàõÂª∫‰∏ãËΩΩÈìæÊé•Â§±Ë¥•:', error);
        // Â§áÁî®ÊñπÊ°àÔºöÂú®Êñ∞Á™óÂè£ÊâìÂºÄ
        window.open(fullFileUrl, '_blank');
    }
}

// ÊòæÁ§∫ËÅäÂ§©ÂÆ§ÁªìÊùüÊ∂àÊÅØ
function showRoomEndedMessage() {
    const messagesContainer = document.getElementById('chat-messages');
    const endedMessage = document.createElement('div');
    endedMessage.className = 'system-message room-ended-message';
    endedMessage.innerHTML = `
        <div class="system-message-content">
            <i class="fas fa-exclamation-triangle"></i>
            <span>ËÅäÂ§©ÂÆ§Â∑≤ÁªìÊùüÔºåÊó†Ê≥ïÁªßÁª≠ÂèëÈÄÅÊ∂àÊÅØ</span>
        </div>
    `;
    messagesContainer.appendChild(endedMessage);
    scrollToBottom();
}

// Á¶ÅÁî®ËÅäÂ§©ËæìÂÖ•
function disableChatInput() {
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const toolbarBtns = document.querySelectorAll('.toolbar-btn');
    
    input.disabled = true;
    sendBtn.disabled = true;
    toolbarBtns.forEach(btn => btn.disabled = true);
    
    input.classList.add('disabled');
    sendBtn.classList.add('disabled');
}

// HTMLËΩ¨‰πâ
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ÂÆöÊúüÊ†áËÆ∞Ê∂àÊÅØ‰∏∫Â∑≤ËØª
setInterval(markMessagesAsRead, 2000);

// ÂÆöÊúüÊ£ÄÊü•WebSocketËøûÊé•Áä∂ÊÄÅ
setInterval(() => {
    if (socket && socket.readyState === WebSocket.OPEN) {
        // ÂèëÈÄÅÂøÉË∑≥ÂåÖ
        socket.send(JSON.stringify({ type: 'ping' }));
    } else if (socket && socket.readyState === WebSocket.CLOSED) {
        console.log('Ê£ÄÊµãÂà∞WebSocketËøûÊé•Â∑≤Êñ≠ÂºÄÔºåÂ∞ùËØïÈáçËøû...');
        connectWebSocket();
    }
}, 30000); // ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°

// È°µÈù¢Âç∏ËΩΩÊó∂ÂÖ≥Èó≠WebSocketËøûÊé•
window.addEventListener('beforeunload', function() {
    if (socket) {
        socket.close();
    }
});

// Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
document.addEventListener('keydown', function(event) {
    // ESCÈîÆÂÖ≥Èó≠ÂõæÁâáÊ®°ÊÄÅÊ°Ü
    if (event.key === 'Escape') {
        const modalElement = document.getElementById('imageModal');
        if (modalElement && modalElement.style.display === 'block') {
            closeImageModal();
        }
        
        // ESCÈîÆÂÖ≥Èó≠Ë°®ÊÉÖÈÄâÊã©Âô®
        const emojiPicker = document.getElementById('emoji-picker');
        if (emojiPicker && emojiPicker.classList.contains('show')) {
            emojiPicker.classList.remove('show');
            emojiPicker.style.display = 'none';
        }
    }
});
</script>
{% endblock %}
