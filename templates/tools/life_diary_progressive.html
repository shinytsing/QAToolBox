{% extends 'base.html' %}
{% load static %}

{% block tool_title_inner %}ç”Ÿæ´»æ—¥è®° - å±‚å±‚é€’è¿›{% endblock %}
{% block tool_title_display %}ç”Ÿæ´»æ—¥è®° - å±‚å±‚é€’è¿›{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'progressive_diary.css' %}">
<style>
/* æ€è€ƒé—®é¢˜è¾“å…¥æ¡†æ ·å¼ */
.question-input-group {
  margin-bottom: 20px;
  padding: 15px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  background: #fafafa;
  transition: all 0.3s ease;
}

.question-input-group:hover {
  border-color: #007bff;
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
}

.question-label {
  margin-bottom: 10px;
  font-weight: 600;
  color: #333;
}

.question-number {
  color: #007bff;
  font-weight: bold;
  margin-right: 8px;
}

.question-text {
  color: #555;
  line-height: 1.4;
}

.question-answer {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  font-size: 14px;
  line-height: 1.5;
  resize: vertical;
  transition: border-color 0.3s ease;
}

.question-answer:focus {
  border-color: #007bff;
  outline: none;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

/* è¡¥å……è¾“å…¥æ¡†æ ·å¼ */
.additional-input-section {
  margin-top: 10px;
}

.additional-input {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 14px;
  line-height: 1.5;
  transition: border-color 0.3s ease;
  background-color: #f8f9fa;
}

.additional-input:focus {
  border-color: #28a745;
  outline: none;
  box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
  background-color: #fff;
}

.additional-input::placeholder {
  color: #6c757d;
  font-style: italic;
}

/* å¯ç¼–è¾‘é—®é¢˜æ ·å¼ */
.question-item {
  margin-bottom: 15px;
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.question-display {
  padding: 15px;
  background: #f8f9fa;
  border: 2px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  transition: all 0.3s ease;
  position: relative;
}

.question-display:hover {
  background: #e9ecef;
  border-color: #007bff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.question-number {
  color: #ff8c00;
  font-weight: bold;
  font-size: 16px;
  min-width: 25px;
}

.question-text {
  color: #333;
  line-height: 1.6;
  flex: 1;
  font-size: 14px;
}

.edit-icon {
  color: #6c757d;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.question-display:hover .edit-icon {
  opacity: 1;
}

.question-edit {
  padding: 15px;
  background: #fff;
  border: 2px solid #007bff;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.question-edit-input {
  width: 100%;
  min-height: 80px;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.5;
  resize: vertical;
  margin-bottom: 10px;
  font-family: inherit;
}

.question-edit-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.question-edit-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.save-question-btn, .cancel-question-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.save-question-btn {
  background: #28a745;
  color: white;
}

.save-question-btn:hover {
  background: #218838;
  transform: translateY(-1px);
}

.cancel-question-btn {
  background: #6c757d;
  color: white;
}

.cancel-question-btn:hover {
  background: #5a6268;
  transform: translateY(-1px);
}

/* éŸ³ä¹æ¨èåŒºåŸŸæ ·å¼ */
.music-recommendation {
  margin: 20px 0;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  color: white;
}

.music-header {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}

.music-header i {
  font-size: 20px;
  margin-right: 10px;
}

.music-header h4 {
  margin: 0;
  font-size: 18px;
}

.music-recommendation-content {
  margin-bottom: 15px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.music-recommendation-text {
  margin: 0;
}

.music-recommendation-text p {
  margin: 0;
  font-size: 14px;
  line-height: 1.5;
}

.music-search-section {
  background: rgba(255, 255, 255, 0.1);
  padding: 15px;
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.music-search-section h4 {
  margin: 0 0 10px 0;
  font-size: 16px;
}

.search-box {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.search-box input {
  flex: 1;
  border: none;
  border-radius: 6px;
  padding: 10px;
  background: rgba(255, 255, 255, 0.9);
  color: #333;
}

.search-box button {
  border: none;
  border-radius: 6px;
  padding: 10px 15px;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  cursor: pointer;
  transition: background 0.3s ease;
}

.search-box button:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* æœç´¢ç»“æœæ ·å¼ */
.search-results {
  margin-top: 15px;
  max-height: 300px;
  overflow-y: auto;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.songs-list {
  padding: 10px;
}

.song-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  margin-bottom: 8px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.song-item:hover {
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.song-info {
  flex: 1;
}

.song-title {
  font-weight: 600;
  color: #333;
  margin-bottom: 4px;
}

.song-artist {
  font-size: 12px;
  color: #666;
}

.song-duration {
  font-size: 11px;
  color: #999;
}

.song-play-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.song-play-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.no-results {
  padding: 20px;
  text-align: center;
  color: #666;
  font-style: italic;
}

/* ç¡®ä¿éŸ³ä¹æ¨èåŒºåŸŸåœ¨ä¿å­˜åä¹Ÿèƒ½æ˜¾ç¤º */
.music-recommendation[style*="display: none"] {
  display: block !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .question-input-group {
    padding: 12px;
  }
  
  .music-recommendation {
    padding: 15px;
  }
  
  .search-box {
    flex-direction: column;
  }
  
  .search-box button {
    width: 100%;
  }
}

@keyframes slideInUp {
  from { 
    opacity: 0; 
    transform: translateY(30px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

/* é—®é¢˜é€‰æ‹©å™¨æ ·å¼ */
.question-selector {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid #4CAF50;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 1000;
  max-height: 400px;
  overflow-y: auto;
}

/* é—®é¢˜é€‰æ‹©ç•Œé¢æ ·å¼ */
.question-selection-container {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin: 20px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  border: 1px solid #e9ecef;
}

.selection-header {
  text-align: center;
  margin-bottom: 24px;
}

.selection-header h3 {
  color: #333;
  margin-bottom: 8px;
  font-size: 20px;
}

.selection-header p {
  color: #666;
  font-size: 14px;
  margin: 0;
}

.questions-selection-list {
  max-height: 400px;
  overflow-y: auto;
  margin-bottom: 20px;
}

.question-selection-item {
  display: flex;
  align-items: center;
  padding: 16px;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  margin-bottom: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  position: relative;
  overflow: hidden;
}

.question-selection-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
  transition: left 0.5s ease;
}

.question-selection-item:hover::before {
  left: 100%;
}

.question-selection-item:hover {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(76, 175, 80, 0.15);
}

.question-selection-item.selected {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  box-shadow: 0 4px 20px rgba(76, 175, 80, 0.25);
  transform: translateY(-1px);
}

.question-selection-item.selected::after {
  content: 'âœ“';
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  animation: checkmarkAppear 0.3s ease;
}

.question-checkbox {
  margin-right: 16px;
  position: relative;
}

.question-select-checkbox {
  width: 20px;
  height: 20px;
  accent-color: #4CAF50;
  cursor: pointer;
  border-radius: 4px;
  border: 2px solid #ddd;
  transition: all 0.3s ease;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background: white;
  position: relative;
}

.question-select-checkbox:checked {
  border-color: #4CAF50;
  background-color: #4CAF50;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='white' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 9 4 4L15 3'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: center;
  background-size: 12px;
}

.question-content {
  flex: 1;
  display: flex;
  align-items: center;
}

.question-number {
  color: #4CAF50;
  font-weight: 600;
  margin-right: 12px;
  min-width: 24px;
  font-size: 15px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.question-text {
  color: #2c3e50;
  font-size: 15px;
  line-height: 1.6;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-weight: 400;
  letter-spacing: 0.2px;
}

.selection-actions {
  display: flex;
  justify-content: center;
  gap: 12px;
  padding-top: 16px;
  border-top: 1px solid #e9ecef;
}

.selection-actions .btn {
  padding: 10px 20px;
  font-size: 14px;
}

.selection-actions .btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.question-custom {
  padding: 12px 16px;
  border-top: 1px solid #e9ecef;
  background: #f8f9fa;
}

.question-custom label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-size: 13px;
  font-weight: 500;
}

.custom-question-input {
  width: 100%;
  min-height: 60px;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
  resize: vertical;
  margin-bottom: 8px;
}

.use-custom-btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.use-custom-btn:hover {
  background: #45a049;
}

/* é—®é¢˜é¡¹ç›¸å¯¹å®šä½ */
.question-item {
  position: relative;
}

/* ç¼–è¾‘å›¾æ ‡æ ·å¼ */
.edit-icon {
  color: #4CAF50;
  font-size: 14px;
  margin-left: 8px;
}

.question-display:hover .edit-icon {
  color: #45a049;
}

/* é—®é¢˜é€‰æ‹©å™¨æ ·å¼ï¼ˆç”¨äºç¼–è¾‘é—®é¢˜ï¼‰ */
.question-selector-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
  border-radius: 6px 6px 0 0;
}

.question-selector-header h4 {
  margin: 0;
  color: #333;
  font-size: 14px;
}

.close-selector-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: #666;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-selector-btn:hover {
  color: #333;
}

.question-options {
  padding: 8px 0;
}

.question-option {
  display: flex;
  align-items: flex-start;
  padding: 8px 16px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.question-option:hover {
  background-color: #f0f8ff;
}

.option-number {
  color: #4CAF50;
  font-weight: bold;
  margin-right: 8px;
  min-width: 20px;
}

.option-text {
  color: #333;
  font-size: 13px;
  line-height: 1.4;
}

.question-custom {
  padding: 12px 16px;
  border-top: 1px solid #e9ecef;
  background: #f8f9fa;
}

.question-custom label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-size: 13px;
  font-weight: 500;
}

.custom-question-input {
  width: 100%;
  min-height: 60px;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
  resize: vertical;
  margin-bottom: 8px;
}

.use-custom-btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.use-custom-btn:hover {
  background: #45a049;
}

/* AIé¢„è§ˆä¸­çš„é—®é¢˜é€‰æ‹©æ ·å¼ */
#aiContentPreview .question-selection-item {
  display: flex;
  align-items: center;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

#aiContentPreview .question-selection-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
  transition: left 0.5s ease;
}

#aiContentPreview .question-selection-item:hover::before {
  left: 100%;
}

#aiContentPreview .question-selection-item:hover {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(76, 175, 80, 0.15);
}

#aiContentPreview .question-selection-item.selected {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  box-shadow: 0 4px 20px rgba(76, 175, 80, 0.25);
  transform: translateY(-1px);
}

#aiContentPreview .question-selection-item.selected::after {
  content: 'âœ“';
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  animation: checkmarkAppear 0.3s ease;
}

@keyframes checkmarkAppear {
  from {
    opacity: 0;
    transform: scale(0);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

#aiContentPreview .question-checkbox {
  margin-right: 16px;
  position: relative;
}

#aiContentPreview .question-select-checkbox {
  width: 20px;
  height: 20px;
  accent-color: #4CAF50;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background: white;
  border: 2px solid #ddd;
  border-radius: 4px;
  transition: all 0.3s ease;
  position: relative;
}

#aiContentPreview .question-select-checkbox:checked {
  border-color: #4CAF50;
  background-color: #4CAF50;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='white' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 9 4 4L15 3'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: center;
  background-size: 12px;
}

#aiContentPreview .question-select-checkbox:checked + label {
  color: #4CAF50;
}

#aiContentPreview .question-select-checkbox:checked ~ .question-content .question-number {
  color: #45a049;
  font-weight: bold;
}

#aiContentPreview .question-select-checkbox:checked ~ .question-content .question-text {
  color: #2e7d32;
  font-weight: 600;
}

#aiContentPreview .question-content {
  flex: 1;
  display: flex;
  align-items: center;
}

#aiContentPreview .question-number {
  color: #4CAF50;
  font-weight: 600;
  margin-right: 12px;
  min-width: 24px;
  font-size: 15px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#aiContentPreview .question-text {
  color: #2c3e50;
  font-size: 15px;
  line-height: 1.6;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-weight: 400;
  letter-spacing: 0.2px;
}

/* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
.statistics-section {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin: 20px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border: 1px solid #e9ecef;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #e9ecef;
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
  transition: left 0.5s ease;
}

.stat-card:hover::before {
  left: 100%;
}

.stat-card:hover {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
}

.stat-card.clicked {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.25);
  transform: translateY(-2px);
}

.stat-icon {
  font-size: 32px;
  margin-bottom: 12px;
  display: block;
}

.stat-number {
  font-size: 28px;
  font-weight: 700;
  color: #2c3e50;
  margin-bottom: 8px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-label {
  font-size: 14px;
  color: #666;
  font-weight: 500;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* è¯¦ç»†æ•°æ®å¼¹çª—æ ·å¼ */
.stat-detail-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
}

.stat-detail-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  position: relative;
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.stat-detail-header {
  display: flex;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid #f0f0f0;
}

.stat-detail-icon {
  font-size: 40px;
  margin-right: 16px;
}

.stat-detail-title {
  font-size: 24px;
  font-weight: 700;
  color: #2c3e50;
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: none;
  border: none;
  font-size: 24px;
  color: #666;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.stat-detail-close:hover {
  background: #f0f0f0;
  color: #333;
}

.stat-detail-summary {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  text-align: center;
}

.stat-detail-summary-number {
  font-size: 36px;
  font-weight: 700;
  color: #4CAF50;
  margin-bottom: 8px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-summary-label {
  font-size: 16px;
  color: #666;
  font-weight: 500;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-list {
  max-height: 300px;
  overflow-y: auto;
}

.stat-detail-item {
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.stat-detail-item:hover {
  border-color: #4CAF50;
  background: #f8fff8;
  transform: translateX(4px);
}

.stat-detail-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.stat-detail-item-date {
  font-size: 14px;
  color: #4CAF50;
  font-weight: 600;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-item-mood {
  font-size: 20px;
}

.stat-detail-item-title {
  font-size: 16px;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 8px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-item-content {
  font-size: 14px;
  color: #666;
  line-height: 1.5;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.stat-detail-empty {
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.stat-detail-empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.stat-detail-empty-text {
  font-size: 16px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
</style>
{% endblock %}

{% block content %}
  <!-- èƒŒæ™¯éŸ³ä¹æ§åˆ¶ -->
  <div class="background-music-control" id="backgroundMusicControl" style="display: none;">
    <button class="bg-music-btn" id="bgMusicToggle" title="èƒŒæ™¯éŸ³ä¹æ§åˆ¶">
      <i class="fas fa-music"></i>
    </button>
    <div class="bg-music-info" id="bgMusicInfo">
      <span id="bgMusicTitle">èƒŒæ™¯éŸ³ä¹</span>
    </div>
  </div>

  <!-- ç»Ÿè®¡è¯¦ç»†æ•°æ®å¼¹çª— -->
  <div class="stat-detail-modal" id="statDetailModal">
    <div class="stat-detail-content">
      <button class="stat-detail-close" onclick="closeStatDetail()">
        <i class="fas fa-times"></i>
      </button>
      <div class="stat-detail-header">
        <div class="stat-detail-icon" id="statDetailIcon">ğŸ“Š</div>
        <h3 class="stat-detail-title" id="statDetailTitle">è¯¦ç»†æ•°æ®</h3>
      </div>
      <div class="stat-detail-summary">
        <div class="stat-detail-summary-number" id="statDetailSummaryNumber">0</div>
        <div class="stat-detail-summary-label" id="statDetailSummaryLabel">æ€»è®¡</div>
      </div>
      <div class="stat-detail-list" id="statDetailList">
        <!-- è¯¦ç»†æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <div class="progressive-diary-container">
    <div class="progressive-main">
      <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
      <div class="progress-indicator">
      <div class="progress-steps">
        <div class="progress-step active" data-step="1">
          <div class="progress-circle">
            <i class="fas fa-heart"></i>
          </div>
          <div class="progress-label">ä»Šæ—¥å¿ƒæƒ…</div>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" data-step="2">
          <div class="progress-circle">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="progress-label">ä»Šæ—¥å®Œæˆ</div>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" data-step="3">
          <div class="progress-circle">
            <i class="fas fa-pen-fancy"></i>
          </div>
          <div class="progress-label">ç”Ÿæ´»è®°å½•</div>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" data-step="4">
          <div class="progress-circle">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="progress-label">ç”Ÿæ´»ç»Ÿè®¡</div>
        </div>
      </div>
    </div>

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="progressive-content">
      <!-- æ­¥éª¤1: é€‰æ‹©å¿ƒæƒ… -->
      <div class="step-page active" id="step1">
        <div class="step-title">
          <h2>é€‰æ‹©ä»Šæ—¥å¿ƒæƒ…</h2>
          <p>é€‰æ‹©ä»Šå¤©çš„å¿ƒæƒ…çŠ¶æ€ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬ä¸ºæ‚¨ç”Ÿæˆæ›´è´´å¿ƒçš„å†…å®¹</p>
        </div>
        
        <!-- å¿ƒæƒ…é€‰æ‹© -->
        <div class="mood-selector">
          <div class="mood-options">
            <div class="mood-option" data-mood="happy">
              <i class="fas fa-laugh"></i>
              <span>å¼€å¿ƒ</span>
            </div>
            <div class="mood-option" data-mood="calm">
              <i class="fas fa-smile"></i>
              <span>å¹³é™</span>
            </div>
            <div class="mood-option" data-mood="excited">
              <i class="fas fa-star"></i>
              <span>å…´å¥‹</span>
            </div>
            <div class="mood-option" data-mood="sad">
              <i class="fas fa-frown"></i>
              <span>éš¾è¿‡</span>
            </div>
            <div class="mood-option" data-mood="angry">
              <i class="fas fa-angry"></i>
              <span>ç”Ÿæ°”</span>
            </div>
            <div class="mood-option" data-mood="neutral">
              <i class="fas fa-meh"></i>
              <span>ä¸€èˆ¬</span>
            </div>
          </div>
        </div>
        
        <div class="progressive-buttons">
          <div></div>
          <button class="btn btn-primary" id="nextToStep2" disabled>
            <span>ä»Šæ—¥å®Œæˆ</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- æ­¥éª¤2: ä»Šæ—¥å®Œæˆ -->
      <div class="step-page" id="step2">
        <div class="step-title">
          <h2>ä»Šæ—¥å®Œæˆ</h2>
          <p>ä»Šå¤©åšäº†ç‚¹å•¥ï¼Œæˆ‘æ¥å¸®ä½ æ€»ç»“</p>
        </div>
        
        <!-- ä»Šæ—¥å®Œæˆé€‰æ‹© -->
        <div class="goal-selector">
          <div class="goal-icons-grid">
            <div class="goal-icon-option" data-category="health">
              <i class="fas fa-dumbbell"></i>
              <span>å¥èº«</span>
            </div>
            <div class="goal-icon-option" data-category="learning">
              <i class="fas fa-book"></i>
              <span>å­¦ä¹ </span>
            </div>
            <div class="goal-icon-option" data-category="career">
              <i class="fas fa-briefcase"></i>
              <span>å·¥ä½œ</span>
            </div>
            <div class="goal-icon-option" data-category="relationship">
              <i class="fas fa-heart"></i>
              <span>æ„Ÿæƒ…</span>
            </div>
            <div class="goal-icon-option" data-category="finance">
              <i class="fas fa-coins"></i>
              <span>ç†è´¢</span>
            </div>
            <div class="goal-icon-option" data-category="hobby">
              <i class="fas fa-palette"></i>
              <span>å…´è¶£</span>
            </div>
            <div class="goal-icon-option" data-category="spiritual">
              <i class="fas fa-pray"></i>
              <span>å†¥æƒ³</span>
            </div>
            <div class="goal-icon-option" data-category="travel">
              <i class="fas fa-plane"></i>
              <span>æ—…è¡Œ</span>
            </div>
            <div class="goal-icon-option" data-category="social">
              <i class="fas fa-users"></i>
              <span>ç¤¾äº¤</span>
            </div>
            <div class="goal-icon-option" data-category="creativity">
              <i class="fas fa-lightbulb"></i>
              <span>åˆ›æ„</span>
            </div>
            <div class="goal-icon-option" data-category="organization">
              <i class="fas fa-tasks"></i>
              <span>æ•´ç†</span>
            </div>
            <div class="goal-icon-option" data-category="gratitude">
              <i class="fas fa-hands-helping"></i>
              <span>æ„Ÿæ©</span>
            </div>
          </div>
        </div>
        
        <div class="progressive-buttons">
          <button class="btn btn-secondary" id="backToStep1">
            <i class="fas fa-arrow-left"></i>
            <span>ä¸Šä¸€æ­¥</span>
          </button>
          <button class="btn btn-primary" id="nextToStep3" disabled>
            <span>ç”ŸæˆAIå†…å®¹</span>
            <i class="fas fa-magic"></i>
          </button>
        </div>
      </div>

      <!-- æ­¥éª¤3: ç”Ÿæ´»è®°å½• -->
      <div class="step-page" id="step3">
        <div class="step-title">
          <h2>ç”Ÿæ´»è®°å½•</h2>
          <p>å†™ä¸‹å½“ä¸‹æœ€çœŸå®çš„æ„Ÿå—</p>
        </div>
        
        <div class="ai-generation-container">
          <div class="ai-loading" id="aiLoading">
            <div class="loading-spinner">
              <i class="fas fa-magic"></i>
            </div>
            <div class="loading-text">
              <h3>AIæ­£åœ¨ä¸ºæ‚¨åˆ›ä½œ...</h3>
              <p>è®°ä¸‹å½“å‰çš„å¿ƒæƒ…ï¼ŒAIæ­£åœ¨ä¸ºæ‚¨å‡†å¤‡æœ‰è¶£çš„æ€è€ƒé—®é¢˜</p>
            </div>
          </div>
          
          <div class="ai-content-preview" id="aiContentPreview" style="display: none;">
            <div class="preview-header">
              <i class="fas fa-magic"></i>
              <span>AIä¸ºæ‚¨ç”Ÿæˆçš„å†…å®¹</span>
            </div>
            <div class="preview-content" id="previewContent">
              <!-- AIç”Ÿæˆçš„å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            
            <!-- éŸ³ä¹æ¨èåŒºåŸŸ -->
            <div class="music-recommendation" id="musicRecommendation" style="display: none;">
              <div class="music-header">
                <i class="fas fa-music"></i>
                <h4>ğŸµ éŸ³ä¹æ¨è</h4>
              </div>
              <div class="music-recommendation-content" id="musicRecommendationContent">
                <!-- éŸ³ä¹æ¨èå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
              </div>
              <!-- ç½‘æ˜“äº‘éŸ³ä¹æœç´¢åŒºåŸŸ -->
              <div class="music-search-section">
                <h4>ğŸ” æœç´¢ç½‘æ˜“äº‘éŸ³ä¹</h4>
                <div class="search-box">
                  <input 
                    type="text" 
                    id="musicSearchInput" 
                    class="form-control" 
                    placeholder="è¾“å…¥æ­Œæ›²åæˆ–æ­Œæ‰‹..."
                  >
                  <button id="searchMusicBtn" class="btn" onclick="searchNeteaseMusic()">
                    <i class="fas fa-search"></i> æœç´¢
                  </button>
                </div>
                <div id="searchResults" class="search-results" style="display: none;">
                  <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
              </div>
            </div>
            
            <div class="preview-actions">
              <button class="btn btn-secondary" id="regenerateContent">
                <i class="fas fa-sync-alt"></i>
                <span>é‡æ–°ç”Ÿæˆ</span>
              </button>
              <button class="btn btn-primary" id="useGeneratedContent">
                <i class="fas fa-check"></i>
                <span>ä½¿ç”¨æ­¤å†…å®¹</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- æ—¥è®°ç¼–è¾‘è¡¨å• -->
        <div class="diary-form-container" id="diaryFormContainer" style="display: none;">
          
          <div class="form-group">
            <label for="diaryTitle">æ—¥è®°æ ‡é¢˜</label>
            <input type="text" id="diaryTitle" class="form-control" placeholder="ä¸ºä»Šå¤©çš„ç”Ÿæ´»è®°å½•èµ·ä¸ªæ ‡é¢˜...">
          </div>
          
          <div class="form-group">
            <label>ç”Ÿæ´»è®°å½•å†…å®¹</label>
            <div class="questions-container" id="questionsContainer">
              <!-- 10ä¸ªé—®é¢˜è¾“å…¥æ¡†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          

        </div>
        
        <div class="progressive-buttons">
          <button class="btn btn-secondary" id="backToStep2">
            <i class="fas fa-arrow-left"></i>
            <span>ä¸Šä¸€æ­¥</span>
          </button>
          <button class="btn btn-primary" id="completeDiary" disabled style="display: none;">
            <i class="fas fa-check"></i>
            <span>ä¿å­˜è®°å½•</span>
          </button>
        </div>
      </div>

      <!-- æ­¥éª¤4: ç”Ÿæ´»ç»Ÿè®¡ -->
      <div class="step-page" id="step4">
        <div class="step-title">
          <h2>ç”Ÿæ´»ç»Ÿè®¡</h2>
          <p>æŸ¥çœ‹æ‚¨çš„ç”Ÿæ´»è®°å½•ç»Ÿè®¡å’Œæˆå°±</p>
        </div>
        
        <!-- ç”Ÿæ´»ç»Ÿè®¡ -->
        <div class="statistics-section" id="statisticsSection" style="display: none;">
            <h3>ğŸ“Š ç”Ÿæ´»ç»Ÿè®¡</h3>
            <div class="stats-grid">
                <div class="stat-card" id="totalDiaryDaysCard">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalDiaryDays">0</div>
                        <div class="stat-label">æ—¥è®°å¤©æ•°</div>
                    </div>
                </div>
                <div class="stat-card" id="totalDiaryCountCard">
                    <div class="stat-icon">ğŸ“</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalDiaryCount">0</div>
                        <div class="stat-label">æ—¥è®°æ¬¡æ•°</div>
                    </div>
                </div>
                <div class="stat-card" id="happyDaysCard">
                    <div class="stat-icon">ğŸ˜Š</div>
                    <div class="stat-content">
                        <div class="stat-number" id="happyDays">0</div>
                        <div class="stat-label">å¼€å¿ƒå¤©æ•°</div>
                    </div>
                </div>
                <div class="stat-card" id="totalWordsCard">
                    <div class="stat-icon">ğŸ“–</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalWords">0</div>
                        <div class="stat-label">æ€»å­—æ•°</div>
                    </div>
                </div>
            </div>
            
            <!-- å¿ƒæƒ…è¶‹åŠ¿å›¾ -->
            <div class="mood-trend-section">
                <h4>ğŸ“ˆ å¿ƒæƒ…è¶‹åŠ¿</h4>
                <div class="mood-chart-container">
                    <canvas id="moodChart"></canvas>
                </div>
                <div class="mood-stats-summary" id="moodStatsSummary">
                    <!-- å¿ƒæƒ…ç»Ÿè®¡æ‘˜è¦å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
        
        <div class="progressive-buttons">
          <button class="btn btn-secondary" id="backToStep3">
            <i class="fas fa-arrow-left"></i>
            <span>ä¸Šä¸€æ­¥</span>
          </button>
          <button class="btn btn-primary" id="finishDiary">
            <i class="fas fa-home"></i>
            <span>å®Œæˆ</span>
          </button>
        </div>
      </div>

      <!-- å®Œæˆé¡µé¢ -->
      <div class="step-page" id="completion">
        <div class="completion-page">
          <div class="completion-icon">
            <i class="fas fa-star"></i>
          </div>
          <div class="completion-title">ğŸ‰ å¤ªæ£’äº†ï¼</div>
          <div class="completion-message">
            æ‚¨çš„ç”Ÿæ´»è®°å½•å·²å®Œç¾ä¿å­˜ï¼<br>
            æ¯ä¸€å¤©çš„è®°å½•éƒ½æ˜¯æ‚¨æˆé•¿çš„è§è¯ï¼Œ<br>
            ç»§ç»­ä¿æŒè¿™ä»½ç¾å¥½ï¼Œæ‚¨çš„äººç”Ÿå°†æ›´åŠ ç²¾å½©ï¼
          </div>
          
          <div class="completion-stats">
            <div class="completion-stat-item">
              <i class="fas fa-heart"></i>
              <span>å¿ƒæƒ…è®°å½•</span>
            </div>
            <div class="completion-stat-item">
              <i class="fas fa-pen"></i>
              <span>ç”Ÿæ´»æ„Ÿæ‚Ÿ</span>
            </div>
            <div class="completion-stat-item">
              <i class="fas fa-bullseye"></i>
              <span>ç›®æ ‡è®¾å®š</span>
            </div>
          </div>
          
          <div class="completion-quote">
            "ç”Ÿæ´»ä¸æ˜¯ç­‰å¾…æš´é£é›¨è¿‡å»ï¼Œè€Œæ˜¯å­¦ä¼šåœ¨é›¨ä¸­è·³èˆã€‚"
          </div>
          

          
          <div class="progressive-buttons">
            <button class="btn btn-primary" id="startNewDiary">
              <i class="fas fa-plus"></i>
              <span>ç»§ç»­è®°å½•ç¾å¥½</span>
            </button>
            <a href="/tools/life-mode/" class="btn btn-secondary">
              <i class="fas fa-home"></i>
              <span>è¿”å›ä¸»é¡µ</span>
            </a>
          </div>
        </div>
              </div>
      </div>
    </div>
  </div>

  <!-- æ—¥è®°è¯¦æƒ…å¼¹çª— -->
  <div class="diary-modal" id="diaryModal">
    <div class="diary-modal-content">
      <div class="diary-modal-header">
        <button class="diary-modal-close" id="closeDiaryModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="diary-modal-body" id="diaryModalBody">
        <!-- å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
      </div>
    </div>
  </div>

  <script>
// å…¨å±€å˜é‡
let currentStep = 1;
let selectedMood = null;
let selectedGoalCategories = [];
let diaryData = {
  title: '',
  content: '',
  mood: '',
  goal_category: ''
};

// åˆå§‹åŒ–é¡µé¢
document.addEventListener('DOMContentLoaded', function() {
  initGoalSelector();
  initMoodSelector();
  initNavigation();
  loadTodayData();
  
  // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
  document.getElementById('bgMusicToggle').addEventListener('click', toggleBackgroundMusic);
  
  // éŸ³ä¹æœç´¢åŠŸèƒ½å·²æ¢å¤
  
  // ä¸´æ—¶è°ƒè¯•ï¼šå¼ºåˆ¶å¯ç”¨ä¿å­˜æŒ‰é’®
  setTimeout(() => {
    const saveButton = document.getElementById('completeDiary');
    if (saveButton) {
      console.log('å¼ºåˆ¶å¯ç”¨ä¿å­˜æŒ‰é’®');
      saveButton.disabled = false;
    }
  }, 2000);
  
  // åˆå§‹åŒ–å¿ƒæƒ…å›¾è¡¨
  setTimeout(() => {
    const canvas = document.getElementById('moodChart');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width = canvas.offsetWidth;
      const height = canvas.height = 300;
      ctx.clearRect(0, 0, width, height);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„å¿ƒæƒ…
      const currentMood = getCurrentPageMood();
      if (currentMood) {
        renderTemporaryMoodChart(ctx, width, height, currentMood);
      } else {
        // æ˜¾ç¤ºå¼•å¯¼ä¿¡æ¯
        ctx.fillStyle = '#666';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('è¯·å…ˆé€‰æ‹©ä»Šæ—¥å¿ƒæƒ…', width / 2, height / 2);
        ctx.fillStyle = '#999';
        ctx.font = '14px Arial';
        ctx.fillText('é€‰æ‹©å¿ƒæƒ…åå°†æ˜¾ç¤ºé¢„è§ˆå›¾è¡¨', width / 2, height / 2 + 30);
      }
    }
  }, 1000);

});

// ç›®æ ‡é€‰æ‹©å™¨
function initGoalSelector() {
  const goalOptions = document.querySelectorAll('.goal-icon-option');
  const nextButton = document.getElementById('nextToStep3');
  
  goalOptions.forEach(option => {
    option.addEventListener('click', function() {
      const category = this.dataset.category;
      
      // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
      if (this.classList.contains('selected')) {
        this.classList.remove('selected');
        selectedGoalCategories = selectedGoalCategories.filter(cat => cat !== category);
      } else {
        this.classList.add('selected');
        selectedGoalCategories.push(category);
      }
      
      diaryData.goal_categories = selectedGoalCategories;
      
      // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ç›®æ ‡
      checkStep2Completion();
      if (selectedGoalCategories.length > 0) {
        showGoalFeedback(selectedGoalCategories);
      } else {
        hideGoalFeedback();
      }
    });
  });
}

// æ£€æŸ¥æ­¥éª¤2æ˜¯å¦å®Œæˆ
function checkStep2Completion() {
  const nextButton = document.getElementById('nextToStep3');
  nextButton.disabled = selectedGoalCategories.length === 0;
}

// æ£€æŸ¥æ­¥éª¤1æ˜¯å¦å®Œæˆ
function checkStep1Completion() {
  const nextButton = document.getElementById('nextToStep2');
  nextButton.disabled = !selectedMood;
}

// æ˜¾ç¤ºå¿ƒæƒ…é€‰æ‹©åé¦ˆ
function showMoodFeedback(mood) {
  const moodTexts = {
    'happy': 'ğŸ˜Š å¤ªæ£’äº†ï¼ä»Šå¤©å¿ƒæƒ…ä¸é”™ï¼Œç»§ç»­ä¿æŒè¿™ä»½å¿«ä¹ï¼',
    'calm': 'ğŸ˜Œ å†…å¿ƒå¹³é™æ˜¯æœ€å¤§çš„æ™ºæ…§ï¼Œæ‚¨åšå¾—å¾ˆå¥½ï¼',
    'excited': 'â­ å……æ»¡æœŸå¾…çš„ä¸€å¤©ï¼æ‚¨çš„çƒ­æƒ…æ„ŸæŸ“ç€å‘¨å›´çš„äººï¼',
    'sad': 'ğŸ˜¢ æ²¡å…³ç³»ï¼Œæ¯ä¸ªé›¨å¤©éƒ½ä¼šè¿‡å»ï¼Œé˜³å…‰æ€»åœ¨é£é›¨åï¼',
    'angry': 'ğŸ˜  æ·±å‘¼å¸ï¼Œä¿æŒå†·é™ï¼Œæ‚¨æ¯”ä»»ä½•å›°éš¾éƒ½å¼ºå¤§ï¼',
    'neutral': 'ğŸ˜ å¹³æ·¡ä¹Ÿæ˜¯ä¸€ç§ç¾å¥½ï¼Œäº«å—è¿™ä»½å®é™å§ï¼'
  };
  
  showNotification(moodTexts[mood] || moodTexts.neutral, 'success');
}

// æ˜¾ç¤ºç›®æ ‡é€‰æ‹©åé¦ˆ
function showGoalFeedback(categories) {
  const goalTexts = {
    'health': 'å¥èº«',
    'learning': 'å­¦ä¹ ',
    'career': 'å·¥ä½œ',
    'relationship': 'æ„Ÿæƒ…',
    'finance': 'ç†è´¢',
    'hobby': 'å…´è¶£',
    'spiritual': 'å†¥æƒ³',
    'travel': 'æ—…è¡Œ',
    'social': 'ç¤¾äº¤',
    'creativity': 'åˆ›æ„',
    'organization': 'æ•´ç†',
    'gratitude': 'æ„Ÿæ©'
  };
  
  const selectedGoals = categories.map(cat => goalTexts[cat]).join('ã€');
  const message = `ğŸ¯ ä»Šå¤©å®Œæˆäº†ï¼š${selectedGoals}ï¼æ‚¨çœŸæ˜¯å¤šæ‰å¤šè‰ºï¼Œç”Ÿæ´»ä¸°å¯Œå¤šå½©ï¼`;
  
  showNotification(message, 'success');
}

// éšè—ç›®æ ‡åé¦ˆ
function hideGoalFeedback() {
  // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ éšè—åé¦ˆçš„é€»è¾‘
}

// å¿ƒæƒ…é€‰æ‹©å™¨
function initMoodSelector() {
  const moodOptions = document.querySelectorAll('.mood-option');
  
  moodOptions.forEach(option => {
    option.addEventListener('click', function() {
      moodOptions.forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      
      selectedMood = this.dataset.mood;
      diaryData.mood = selectedMood;
      
      // æ£€æŸ¥æ˜¯å¦åŒæ—¶é€‰æ‹©äº†å¿ƒæƒ…å’Œç›®æ ‡
      checkStep1Completion();
      showMoodFeedback(selectedMood);
    });
  });
}

// å¯¼èˆªæ§åˆ¶
function initNavigation() {
  // å®‰å…¨åœ°æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  const nextToStep2 = document.getElementById('nextToStep2');
  const nextToStep3 = document.getElementById('nextToStep3');
  const backToStep1 = document.getElementById('backToStep1');
  const backToStep2 = document.getElementById('backToStep2');
  const backToStep3 = document.getElementById('backToStep3');
  const completeDiaryBtn = document.getElementById('completeDiary');
  const startNewDiaryBtn = document.getElementById('startNewDiary');
  const finishDiaryBtn = document.getElementById('finishDiary');
  const regenerateContentBtn = document.getElementById('regenerateContent');
  const useGeneratedContentBtn = document.getElementById('useGeneratedContent');
  const diaryDaysCard = document.getElementById('totalDiaryCard');
  const closeDiaryModalBtn = document.getElementById('closeDiaryModal');
  const diaryModal = document.getElementById('diaryModal');
  const diaryTitle = document.getElementById('diaryTitle');
  const diaryContent = document.getElementById('diaryContent');
  
  if (nextToStep2) nextToStep2.addEventListener('click', () => goToStep(2));
  if (nextToStep3) nextToStep3.addEventListener('click', () => goToStep(3));
  if (backToStep1) backToStep1.addEventListener('click', () => goToStep(1));
  if (backToStep2) backToStep2.addEventListener('click', () => goToStep(2));
  if (backToStep3) backToStep3.addEventListener('click', () => goToStep(3));
  if (completeDiaryBtn) completeDiaryBtn.addEventListener('click', completeDiary);
  if (startNewDiaryBtn) startNewDiaryBtn.addEventListener('click', resetDiary);
  if (finishDiaryBtn) finishDiaryBtn.addEventListener('click', finishDiary);
  
  // AIå†…å®¹ç”Ÿæˆç›¸å…³
  if (regenerateContentBtn) regenerateContentBtn.addEventListener('click', generateAIContent);
  if (useGeneratedContentBtn) useGeneratedContentBtn.addEventListener('click', useGeneratedContent);
  
  // ç›‘å¬æ—¥è®°å¤©æ•°å¡ç‰‡ç‚¹å‡»äº‹ä»¶
  if (diaryDaysCard) diaryDaysCard.addEventListener('click', showDiaryDetails);
  
  // ç›‘å¬å¼¹çª—å…³é—­äº‹ä»¶
  if (closeDiaryModalBtn) closeDiaryModalBtn.addEventListener('click', closeDiaryModal);
  if (diaryModal) {
    diaryModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeDiaryModal();
      }
    });
  }
  
  // è¡¨å•éªŒè¯
  if (diaryTitle) diaryTitle.addEventListener('input', validateStep3);
  if (diaryContent) diaryContent.addEventListener('input', validateStep3);
}

// æ­¥éª¤å¯¼èˆª
function goToStep(step) {
  if (step < 1 || step > 5) return;
  
  currentStep = step;
  
  document.querySelectorAll('.step-page').forEach(page => {
    page.classList.remove('active');
  });
  
  if (step === 5) {
    document.getElementById('completion').classList.add('active');
  } else {
    document.getElementById(`step${step}`).classList.add('active');
  }
  
  updateProgressIndicator(step);
  
  if (step === 3) {
    // ç¡®ä¿å¿ƒæƒ…æ•°æ®å­˜åœ¨
    if (!selectedMood) {
      selectedMood = 'neutral';
      diaryData.mood = selectedMood;
    }
    generateAIContent();
  }
  
  if (step === 4) {
    loadStatistics();
  }
}

// æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
function updateProgressIndicator(step) {
  const steps = document.querySelectorAll('.progress-step');
  
  steps.forEach((stepElement, index) => {
    const stepNumber = index + 1;
    stepElement.classList.remove('active', 'completed');
    
    if (stepNumber < step) {
      stepElement.classList.add('completed');
    } else if (stepNumber === step) {
      stepElement.classList.add('active');
    }
  });
}

// éªŒè¯æ­¥éª¤3
function validateStep3() {
  const diaryTitle = document.getElementById('diaryTitle');
  const nextButton = document.getElementById('completeDiary');
  
  // å®‰å…¨åœ°è·å–æ ‡é¢˜
  const title = diaryTitle ? diaryTitle.value.trim() : '';
  
  console.log('validateStep3 è¢«è°ƒç”¨ã€‚');
  console.log('æ ‡é¢˜:', title);

  // ç¡®ä¿å¿ƒæƒ…æ•°æ®å­˜åœ¨ï¼ˆä»ç¬¬ä¸€æ­¥è·å–ï¼‰
  if (!selectedMood) {
    // å¦‚æœç¬¬ä¸€æ­¥æ²¡æœ‰é€‰æ‹©å¿ƒæƒ…ï¼Œé»˜è®¤è®¾ç½®ä¸ºä¸€èˆ¬
    selectedMood = 'neutral';
    diaryData.mood = selectedMood;
  }
  
  // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•é—®é¢˜å›ç­”å’Œè¡¥å……è¯´æ˜
  const questionAnswers = document.querySelectorAll('.question-answer');
  let totalContent = '';
  
  questionAnswers.forEach((textarea, index) => {
    if (textarea) {
      const answer = textarea.value.trim();
      const question = textarea.dataset.question;
      const additionalInput = document.getElementById(`additionalInput${index + 1}`);
      const additionalAnswer = additionalInput ? additionalInput.value.trim() : '';
      
      if (answer) {
        totalContent += `${question}\nå›ç­”: ${answer}`;
        if (additionalAnswer) {
          totalContent += `\nè¡¥å……: ${additionalAnswer}`;
        }
        totalContent += '\n\n';
      }
    }
  });
  
  // æ–°çš„éªŒè¯é€»è¾‘ï¼šåªè¦æœ‰æ ‡é¢˜å°±å¯ä»¥ä¿å­˜
  const hasAnyContent = title.length > 0;
  
  // å®‰å…¨åœ°è®¾ç½®æŒ‰é’®çŠ¶æ€
  if (nextButton) {
    nextButton.disabled = !hasAnyContent;
    console.log('æŒ‰é’®åº”è¯¥å¯ç”¨:', hasAnyContent);
    console.log('æŒ‰é’®å½“å‰ disabled çŠ¶æ€:', nextButton.disabled);
    
    // å¼ºåˆ¶ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®
    if (hasAnyContent) {
      nextButton.disabled = false;
      console.log('å¼ºåˆ¶å¯ç”¨æŒ‰é’®');
    }
  }
  
  diaryData.title = title;
  diaryData.content = totalContent;
  
  // æ·»åŠ é—®é¢˜è¾“å…¥æ¡†å’Œè¡¥å……è¾“å…¥æ¡†çš„å®æ—¶éªŒè¯ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ·»åŠ ï¼‰
  if (!questionAnswers[0] || !questionAnswers[0].hasEventListener) {
    questionAnswers.forEach((textarea, index) => {
      if (textarea && !textarea.hasEventListener) {
        textarea.addEventListener('input', validateStep3);
        textarea.hasEventListener = true;
      }
      
      // ä¸ºè¡¥å……è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      const additionalInput = document.getElementById(`additionalInput${index + 1}`);
      if (additionalInput && !additionalInput.hasEventListener) {
        additionalInput.addEventListener('input', validateStep3);
        additionalInput.hasEventListener = true;
      }
    });
  }
}

// ç”ŸæˆAIå†…å®¹å’ŒéŸ³ä¹æ¨è
async function generateAIContent() {
  // ç¡®ä¿å¿ƒæƒ…æ•°æ®å­˜åœ¨
  if (!selectedMood) {
    selectedMood = 'neutral';
    diaryData.mood = selectedMood;
  }
  
  if (selectedGoalCategories.length === 0) {
    showNotification('è¯·å…ˆé€‰æ‹©ä»Šæ—¥å®Œæˆçš„å†…å®¹ï¼', 'error');
    return;
  }
  
  const loadingDiv = document.getElementById('aiLoading');
  const previewDiv = document.getElementById('aiContentPreview');
  const musicDiv = document.getElementById('musicRecommendation');
  
  loadingDiv.style.display = 'block';
  previewDiv.style.display = 'none';
  musicDiv.style.display = 'none';
  
  try {
    // æ„å»ºæç¤ºè¯
    const goalTexts = {
      'health': 'å¥èº«',
      'learning': 'å­¦ä¹ ',
      'career': 'å·¥ä½œ',
      'relationship': 'æ„Ÿæƒ…',
      'finance': 'ç†è´¢',
      'hobby': 'å…´è¶£',
      'spiritual': 'å†¥æƒ³',
      'travel': 'æ—…è¡Œ',
      'social': 'ç¤¾äº¤',
      'creativity': 'åˆ›æ„',
      'organization': 'æ•´ç†',
      'gratitude': 'æ„Ÿæ©'
    };
    
    const moodTexts = {
      'happy': 'å¼€å¿ƒ',
      'calm': 'å¹³é™',
      'excited': 'å…´å¥‹',
      'sad': 'éš¾è¿‡',
      'angry': 'ç”Ÿæ°”',
      'neutral': 'ä¸€èˆ¬'
    };
    
    const selectedGoals = selectedGoalCategories.map(cat => goalTexts[cat]).join('ã€');
    
         const prompt = `è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ä¸ºæˆ‘ç”Ÿæˆ10ä¸ªæœ‰è¶£ä¸”å¼•äººæ·±æ€çš„é—®é¢˜å’Œ1é¦–æ¨èçš„éŸ³ä¹ï¼š
     
     å¿ƒæƒ…çŠ¶æ€ï¼š${moodTexts[selectedMood]}
     ä»Šæ—¥å®Œæˆï¼š${selectedGoals}
     
     è¦æ±‚ï¼š
     1. ç”Ÿæˆ10ä¸ªé—®é¢˜ï¼Œæ¶µç›–ä»¥ä¸‹æ–¹é¢ï¼š
        - ä»Šå¤©æœ€è®©ä½ ç¬‘å‡ºå£°çš„ç¬é—´æ˜¯ä»€ä¹ˆï¼Ÿ
        - å¦‚æœä»Šå¤©æ˜¯ä¸€éƒ¨ç”µå½±ï¼Œä½ ä¼šç»™å®ƒèµ·ä»€ä¹ˆåå­—ï¼Ÿ
        - ä»Šå¤©é‡åˆ°çš„äººä¸­ï¼Œè°è®©ä½ å°è±¡æœ€æ·±åˆ»ï¼Ÿ
        - å¦‚æœå¯ä»¥å’Œä»Šå¤©çš„è‡ªå·±å¯¹è¯ï¼Œä½ ä¼šè¯´ä»€ä¹ˆï¼Ÿ
        - ä»Šå¤©æœ‰ä»€ä¹ˆäº‹æƒ…è®©ä½ æ„Ÿåˆ°æ„å¤–æƒŠå–œï¼Ÿ
        - å¦‚æœä»Šå¤©å¯ä»¥é‡æ¥ä¸€æ¬¡ï¼Œä½ ä¼šæ”¹å˜ä»€ä¹ˆï¼Ÿ
        - ä»Šå¤©æœ€æƒ³å’Œè°åˆ†äº«ä½ çš„å¿ƒæƒ…ï¼Ÿ
        - ä»Šå¤©å­¦åˆ°äº†ä»€ä¹ˆæ–°ä¸œè¥¿ï¼Ÿ
        - æ˜å¤©æœ€æœŸå¾…çš„äº‹æƒ…æ˜¯ä»€ä¹ˆï¼Ÿ
        - ä»Šå¤©æœ‰ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°ç‰¹åˆ«æ„Ÿæ©çš„ï¼Ÿ
     
     2. é—®é¢˜è¦ï¼š
        - æœ‰è¶£ä¸”å¯Œæœ‰æƒ³è±¡åŠ›
        - è¯­è¨€ç”ŸåŠ¨æ´»æ³¼ï¼Œæœ‰æ•…äº‹æ„Ÿ
        - ç»“åˆå…·ä½“çš„å¿ƒæƒ…å’Œå®Œæˆçš„äº‹æƒ…
        - è®©äººæƒ³è¦æ·±å…¥æ€è€ƒå’Œå›ç­”
        - ç”¨ä¸­æ–‡å†™ä½œï¼Œè¯­æ°”è½»æ¾æ„‰å¿«
     
     3. æ¨è1é¦–éŸ³ä¹ï¼š
        - æ ¹æ®å¿ƒæƒ…çŠ¶æ€æ¨è
        - éŸ³ä¹é£æ ¼è¦å¤šæ ·åŒ–ï¼Œä¸è¦å¤ªå›ºå®š
        - å¯ä»¥æ˜¯æµè¡Œã€å¤å…¸ã€è½»éŸ³ä¹ã€æ°‘è°£ç­‰ä¸åŒé£æ ¼
        - éŸ³ä¹è¦èƒ½é…åˆå½“å‰çš„å¿ƒæƒ…å’ŒçŠ¶æ€
     
     è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œæ¯ä¸ªé—®é¢˜åç•™ç©ºè¡Œï¼ŒéŸ³ä¹ä¿¡æ¯å•ç‹¬åˆ—å‡ºï¼š
     ã€10ä¸ªç–‘é—®å¥ã€‘
     1. [ç¬¬ä¸€ä¸ªé—®é¢˜]\n\n
     2. [ç¬¬äºŒä¸ªé—®é¢˜]\n\n
     3. [ç¬¬ä¸‰ä¸ªé—®é¢˜]\n\n
     4. [ç¬¬å››ä¸ªé—®é¢˜]\n\n
     5. [ç¬¬äº”ä¸ªé—®é¢˜]\n\n
     6. [ç¬¬å…­ä¸ªé—®é¢˜]\n\n
     7. [ç¬¬ä¸ƒä¸ªé—®é¢˜]\n\n
     8. [ç¬¬å…«ä¸ªé—®é¢˜]\n\n
     9. [ç¬¬ä¹ä¸ªé—®é¢˜]\n\n
     10. [ç¬¬åä¸ªé—®é¢˜]\n\n
     ã€æ¨èéŸ³ä¹ã€‘\n
     [éŸ³ä¹åç§°] - [è‰ºæœ¯å®¶]`;
    
    const response = await fetch('/tools/api/deepseek/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        prompt: prompt,
        max_tokens: 500,
        temperature: 0.8
      })
    });
    
    const data = await response.json();
    
        if (data.success) {
      // æ˜¾ç¤ºAIç”Ÿæˆçš„å†…å®¹ï¼Œæ ¼å¼åŒ–æ˜¾ç¤º
      const formattedContent = formatContentForDisplay(data.content);
      document.getElementById('previewContent').innerHTML = formattedContent;
      showNotification('AIå†…å®¹ç”ŸæˆæˆåŠŸï¼', 'success');
    } else {
      // DeepSeek APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å†…å®¹
      console.warn('DeepSeek APIè°ƒç”¨å¤±è´¥:', data.error);
      const fallbackContent = generateFallbackContent(selectedMood, selectedGoalCategories);
      const formattedContent = formatContentForDisplay(fallbackContent);
      document.getElementById('previewContent').innerHTML = formattedContent;
      showNotification('AIç”Ÿæˆå†…å®¹æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²ä¸ºä½ ç”Ÿæˆæ¸©æš–çš„å¤‡ç”¨å†…å®¹ï¼', 'warning');
    }
    
    loadingDiv.style.display = 'none';
    previewDiv.style.display = 'block';
    document.getElementById('nextToStep3').style.display = 'inline-flex';
    
    // æ·»åŠ é—®é¢˜é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
    addQuestionSelectionListeners();
    
    // è·å–éŸ³ä¹æ¨è
    await getMusicRecommendation();
  } catch (error) {
    console.error('ç”ŸæˆAIå†…å®¹å¤±è´¥:', error);
    // ä½¿ç”¨å¤‡ç”¨å†…å®¹
    const fallbackContent = generateFallbackContent(selectedMood, selectedGoalCategories);
    const formattedContent = formatContentForDisplay(fallbackContent);
    document.getElementById('previewContent').innerHTML = formattedContent;
    showNotification('AIç”Ÿæˆå†…å®¹æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²ä¸ºä½ ç”Ÿæˆæ¸©æš–çš„å¤‡ç”¨å†…å®¹ï¼', 'warning');
    
    loadingDiv.style.display = 'none';
    previewDiv.style.display = 'block';
    document.getElementById('nextToStep3').style.display = 'inline-flex';
    
    // æ·»åŠ é—®é¢˜é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
    addQuestionSelectionListeners();
    
    // è·å–éŸ³ä¹æ¨è
    await getMusicRecommendation();
  }
}

// ç”Ÿæˆå¤‡ç”¨å†…å®¹
function generateFallbackContent(mood, goalCategories) {
  const moodTexts = {
    'happy': 'å¼€å¿ƒ',
    'calm': 'å¹³é™',
    'excited': 'å…´å¥‹',
    'sad': 'éš¾è¿‡',
    'angry': 'ç”Ÿæ°”',
    'neutral': 'ä¸€èˆ¬'
  };
  
  const goalTexts = {
    'health': 'å¥èº«',
    'learning': 'å­¦ä¹ ',
    'career': 'å·¥ä½œ',
    'relationship': 'æ„Ÿæƒ…',
    'finance': 'ç†è´¢',
    'hobby': 'å…´è¶£',
    'spiritual': 'å†¥æƒ³',
    'travel': 'æ—…è¡Œ',
    'social': 'ç¤¾äº¤',
    'creativity': 'åˆ›æ„',
    'organization': 'æ•´ç†',
    'gratitude': 'æ„Ÿæ©'
  };
  
  const selectedGoals = goalCategories.map(cat => goalTexts[cat]).join('ã€');
  const moodText = moodTexts[mood] || 'ä¸€èˆ¬';
  
  const musicRecommendations = {
    'happy': ['æ™´å¤© - å‘¨æ°ä¼¦', 'ç¨»é¦™ - å‘¨æ°ä¼¦', 'å°å¹¸è¿ - ç”°é¦¥ç”„', 'å‘Šç™½æ°”çƒ - å‘¨æ°ä¼¦', 'å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ - é€ƒè·‘è®¡åˆ’'],
    'calm': ['æœˆå…‰ - ç‹å¿ƒå‡Œ', 'å®‰é™ - å‘¨æ°ä¼¦', 'å¤©ç©ºä¹‹åŸ - ä¹…çŸ³è®©', 'River Flows In You - Yiruma', 'Kiss The Rain - Yiruma'],
    'excited': ['è¿½æ¢¦èµ¤å­å¿ƒ - GALA', 'æµ·é˜”å¤©ç©º - Beyond', 'å…‰è¾‰å²æœˆ - Beyond', 'çœŸå¿ƒè‹±é›„ - æˆé¾™', 'å¥”è·‘ - ç¾½æ³‰'],
    'sad': ['åæ¥ - åˆ˜è‹¥è‹±', 'ç«¥è¯ - å…‰è‰¯', 'å¯æƒœæ²¡å¦‚æœ - æ—ä¿Šæ°', 'æ¼”å‘˜ - è–›ä¹‹è°¦', 'æ³¡æ²« - é‚“ç´«æ£‹'],
    'angry': ['æ€’æ”¾çš„ç”Ÿå‘½ - æ±ªå³°', 'å­˜åœ¨ - æ±ªå³°', 'å‹‡æ•¢çš„å¿ƒ - æ±ªå³°', 'é£å¾—æ›´é«˜ - æ±ªå³°', 'æ˜¥å¤©é‡Œ - æ±ªå³°'],
    'neutral': ['å¹³å‡¡ä¹‹è·¯ - æœ´æ ‘', 'é‚£äº›èŠ±å„¿ - æœ´æ ‘', 'ç™½æ¡¦æ— - æœ´æ ‘', 'ç”Ÿå¦‚å¤èŠ± - æœ´æ ‘', 'ä¸”å¬é£åŸ - æœ´æ ‘']
  };
  
  const questions = [
    `ä»Šå¤©å®Œæˆäº†${selectedGoals}ï¼Œæœ€è®©ä½ ç¬‘å‡ºå£°çš„ç¬é—´æ˜¯ä»€ä¹ˆï¼Ÿ`,
    `å¦‚æœä»Šå¤©æ˜¯ä¸€éƒ¨ç”µå½±ï¼Œä½ ä¼šç»™å®ƒèµ·ä»€ä¹ˆåå­—ï¼Ÿ`,
    `ä»Šå¤©é‡åˆ°çš„äººä¸­ï¼Œè°è®©ä½ å°è±¡æœ€æ·±åˆ»ï¼Ÿ`,
    `å¦‚æœå¯ä»¥å’Œä»Šå¤©çš„è‡ªå·±å¯¹è¯ï¼Œä½ ä¼šè¯´ä»€ä¹ˆï¼Ÿ`,
    `ä»Šå¤©æœ‰ä»€ä¹ˆäº‹æƒ…è®©ä½ æ„Ÿåˆ°æ„å¤–æƒŠå–œï¼Ÿ`,
    `å¦‚æœä»Šå¤©å¯ä»¥é‡æ¥ä¸€æ¬¡ï¼Œä½ ä¼šæ”¹å˜ä»€ä¹ˆï¼Ÿ`,
    `ä»Šå¤©æœ€æƒ³å’Œè°åˆ†äº«ä½ çš„${moodText}å¿ƒæƒ…ï¼Ÿ`,
    `ä»Šå¤©å­¦åˆ°äº†ä»€ä¹ˆæ–°ä¸œè¥¿ï¼Ÿ`,
    `æ˜å¤©æœ€æœŸå¾…çš„äº‹æƒ…æ˜¯ä»€ä¹ˆï¼Ÿ`,
    `ä»Šå¤©æœ‰ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°ç‰¹åˆ«æ„Ÿæ©çš„ï¼Ÿ`
  ];
  
  const selectedMusic = musicRecommendations[mood][Math.floor(Math.random() * musicRecommendations[mood].length)];
  
  let content = 'ã€10ä¸ªç–‘é—®å¥ã€‘\n';
  questions.forEach((question, index) => {
    content += `${index + 1}. ${question}\n\n`;
  });
  content += 'ã€æ¨èéŸ³ä¹ã€‘\n';
  content += selectedMusic;
  
  return content;
}



// æ˜¾ç¤ºæ—¥è®°è¯¦æƒ…
async function showDiaryDetails() {
  try {
    const response = await fetch('/tools/api/life-diary/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'get_diary_list'
      })
    });
    
    const data = await response.json();
    
    if (data.success && data.diaries) {
      const modalBody = document.getElementById('diaryModalBody');
      let html = '';
      
      if (data.diaries.length === 0) {
        html = `
          <div class="no-diary-message">
            <i class="fas fa-book-open"></i>
            <h3>è¿˜æ²¡æœ‰æ—¥è®°è®°å½•</h3>
            <p>å¼€å§‹è®°å½•æ‚¨çš„ç”Ÿæ´»ç‚¹æ»´å§ï¼</p>
          </div>
        `;
      } else {
        data.diaries.forEach(diary => {
          const moodEmojis = {
            'happy': 'ğŸ˜Š',
            'calm': 'ğŸ˜Œ',
            'excited': 'â­',
            'sad': 'ğŸ˜¢',
            'angry': 'ğŸ˜ ',
            'neutral': 'ğŸ˜'
          };
          
          const moodTexts = {
            'happy': 'å¼€å¿ƒ',
            'calm': 'å¹³é™',
            'excited': 'å…´å¥‹',
            'sad': 'éš¾è¿‡',
            'angry': 'ç”Ÿæ°”',
            'neutral': 'ä¸€èˆ¬'
          };
          
          const date = new Date(diary.created_at).toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
          });
          
          // å¤„ç†é—®é¢˜å›ç­”
          let questionAnswersHtml = '';
          if (diary.question_answers && diary.question_answers.length > 0) {
            questionAnswersHtml = `
              <div class="diary-questions">
                <h4><i class="fas fa-question-circle"></i> æ€è€ƒé—®é¢˜</h4>
                ${diary.question_answers.map(qa => `
                  <div class="question-item">
                    <div class="question-text">${qa.question}</div>
                    <div class="answer-text">${qa.answer}</div>
                    ${qa.additional_answer ? `<div class="additional-answer">è¡¥å……ï¼š${qa.additional_answer}</div>` : ''}
                  </div>
                `).join('')}
              </div>
            `;
          }
          
          // å¤„ç†éŸ³ä¹æ¨è
          let musicRecommendationHtml = '';
          if (diary.music_recommendation) {
            musicRecommendationHtml = `
              <div class="diary-music">
                <h4><i class="fas fa-music"></i> éŸ³ä¹æ¨è</h4>
                <div class="music-text">${diary.music_recommendation}</div>
              </div>
            `;
          }
          
          // å¤„ç†æ ‡ç­¾
          let tagsHtml = '';
          if (diary.tags && diary.tags.length > 0) {
            tagsHtml = `
              <div class="diary-tags">
                ${diary.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            `;
          }
          
          html += `
            <div class="diary-item">
              <div class="diary-header">
                <div class="diary-date">
                  <i class="fas fa-calendar"></i>
                  <span>${date}</span>
                </div>
                <div class="diary-mood ${diary.mood}">
                  <i class="fas fa-heart"></i>
                  <span>${moodEmojis[diary.mood]} ${moodTexts[diary.mood]}</span>
                </div>
              </div>
              <div class="diary-title">${diary.title}</div>
              <div class="diary-content">${diary.content}</div>
              ${diary.mood_note ? `<div class="diary-mood-note">${diary.mood_note}</div>` : ''}
              ${tagsHtml}
              ${questionAnswersHtml}
              ${musicRecommendationHtml}
            </div>
          `;
        });
      }
      
      modalBody.innerHTML = html;
      document.getElementById('diaryModal').style.display = 'block';
    } else {
      showNotification('è·å–æ—¥è®°åˆ—è¡¨å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('è·å–æ—¥è®°è¯¦æƒ…å¤±è´¥:', error);
    showNotification('è·å–æ—¥è®°è¯¦æƒ…å¤±è´¥', 'error');
  }
}



// å…³é—­æ—¥è®°è¯¦æƒ…å¼¹çª—
function closeDiaryModal() {
  document.getElementById('diaryModal').style.display = 'none';
}



// è·å–éŸ³ä¹æ¨è
async function getMusicRecommendation() {
  try {
    // æ ¹æ®å¿ƒæƒ…é€‰æ‹©éŸ³ä¹æ¨¡å¼
    const moodToMode = {
      'happy': 'life',
      'calm': 'life',
      'excited': 'training',
      'sad': 'emo',
      'angry': 'training',
      'neutral': 'work'
    };
    
    const musicMode = moodToMode[selectedMood] || 'life';
    
    const response = await fetch('/tools/api/music/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'get_random_song',
        mode: musicMode
      })
    });
    
    const data = await response.json();
    
    if (data.success && data.song) {
      // æ˜¾ç¤ºéŸ³ä¹æ¨èåŒºåŸŸ
      document.getElementById('musicRecommendation').style.display = 'block';
      showNotification('éŸ³ä¹æ¨èåŠ è½½æˆåŠŸï¼', 'success');
    } else {
      console.log('éŸ³ä¹æ¨èåŠ è½½å¤±è´¥');
      // æ˜¾ç¤ºéŸ³ä¹æ¨èåŒºåŸŸ
      document.getElementById('musicRecommendation').style.display = 'block';
    }
  } catch (error) {
    console.error('è·å–éŸ³ä¹æ¨èå¤±è´¥:', error);
    // æ˜¾ç¤ºéŸ³ä¹æ¨èåŒºåŸŸ
    document.getElementById('musicRecommendation').style.display = 'block';
  }
}

// æœç´¢ç½‘æ˜“äº‘éŸ³ä¹
async function searchNeteaseMusic() {
  // ç¡®å®šå½“å‰æ¿€æ´»çš„æœç´¢æ¡†
  let searchInput, searchBtn, searchResults;
  
  // æ£€æŸ¥å“ªä¸ªæœç´¢æ¡†æœ‰å†…å®¹
  const input1 = document.getElementById('musicSearchInput');
  const input2 = document.getElementById('musicSearchInputForm');
  
  if (input1 && input1.value.trim()) {
    searchInput = input1;
    searchBtn = document.getElementById('searchMusicBtn');
    searchResults = document.getElementById('searchResults');
  } else if (input2 && input2.value.trim()) {
    searchInput = input2;
    searchBtn = document.getElementById('searchMusicBtnForm');
    searchResults = document.getElementById('searchResultsForm');
  } else {
    // å¦‚æœéƒ½æ²¡æœ‰å†…å®¹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª
    searchInput = input1 || input2;
    searchBtn = document.getElementById('searchMusicBtn') || document.getElementById('searchMusicBtnForm');
    searchResults = document.getElementById('searchResults') || document.getElementById('searchResultsForm');
  }
  
  const keyword = searchInput.value.trim();
  if (!keyword) {
    showNotification('è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼', 'error');
    return;
  }
  
  const originalText = searchBtn.innerHTML;
  searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  searchBtn.disabled = true;
  
  try {
    const response = await fetch(`/tools/api/music/?action=netease_search&keyword=${encodeURIComponent(keyword)}`, {
      method: 'GET',
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    const data = await response.json();
    
    if (data.success && data.data && data.data.length > 0) {
      displaySearchResults(data.data, searchResults);
      showNotification(`æ‰¾åˆ° ${data.data.length} é¦–ç›¸å…³æ­Œæ›²ï¼`, 'success');
    } else {
      searchResults.innerHTML = '<div class="no-results">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</div>';
      searchResults.style.display = 'block';
      showNotification('æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²', 'warning');
    }
  } catch (error) {
    console.error('æœç´¢éŸ³ä¹å¤±è´¥:', error);
    showNotification('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  } finally {
    searchBtn.innerHTML = originalText;
    searchBtn.disabled = false;
  }
}

// æ˜¾ç¤ºæœç´¢ç»“æœ
function displaySearchResults(songs, resultsContainer) {
  if (!resultsContainer) {
    resultsContainer = document.getElementById('searchResults') || document.getElementById('searchResultsForm');
  }
  
  let html = '<div class="songs-list">';
  
  songs.forEach((song, index) => {
           html += `
         <div class="song-item" onclick="playSelectedSong('${song.play_url}', '${song.name}', '${song.artist}')">
           <div class="song-info">
             <div class="song-title">${song.name}</div>
             <div class="song-artist">${song.artist}</div>
             <div class="song-duration">${song.duration}</div>
           </div>
           <div class="song-play-btn" title="è®¾ä¸ºèƒŒæ™¯éŸ³ä¹">
             <i class="fas fa-music"></i>
           </div>
         </div>
       `;
  });
  
  html += '</div>';
  resultsContainer.innerHTML = html;
  resultsContainer.style.display = 'block';
}

// æ’­æ”¾é€‰ä¸­çš„æ­Œæ›²ï¼ˆèƒŒæ™¯éŸ³ä¹ï¼‰
function playSelectedSong(playUrl, songName, artistName) {
  // åˆ›å»ºæˆ–è·å–å…¨å±€èƒŒæ™¯éŸ³ä¹æ’­æ”¾å™¨
  let backgroundAudio = window.backgroundAudio;
  if (!backgroundAudio) {
    backgroundAudio = new Audio();
    backgroundAudio.loop = true; // å¾ªç¯æ’­æ”¾
    window.backgroundAudio = backgroundAudio;
  }
  
  backgroundAudio.src = playUrl;
  backgroundAudio.play().then(() => {
    // æ˜¾ç¤ºèƒŒæ™¯éŸ³ä¹æ§åˆ¶
    document.getElementById('backgroundMusicControl').style.display = 'flex';
    document.getElementById('bgMusicTitle').textContent = `${songName} - ${artistName}`;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const bgMusicBtn = document.getElementById('bgMusicToggle');
    bgMusicBtn.innerHTML = '<i class="fas fa-pause"></i>';
    bgMusicBtn.title = 'æš‚åœèƒŒæ™¯éŸ³ä¹';
    
    showNotification(`ğŸµ èƒŒæ™¯éŸ³ä¹å·²è®¾ç½®: ${songName} - ${artistName}`, 'success');
  }).catch(error => {
    console.error('æ’­æ”¾å¤±è´¥:', error);
    // æä¾›ç½‘æ˜“äº‘é“¾æ¥ï¼Œè®©ç”¨æˆ·å»ç½‘æ˜“äº‘æ’­æ”¾
    const neteaseUrl = `https://music.163.com/#/search/m/?s=${encodeURIComponent(songName + ' ' + artistName)}&type=1`;
    showNotification(`ğŸµ æ— æ³•ç›´æ¥æ’­æ”¾ï¼Œè¯·å‰å¾€ç½‘æ˜“äº‘éŸ³ä¹æœç´¢æ’­æ”¾: ${songName} - ${artistName}`, 'info');
    
    // å¯é€‰ï¼šè‡ªåŠ¨æ‰“å¼€ç½‘æ˜“äº‘æœç´¢é¡µé¢
    setTimeout(() => {
      if (confirm('æ˜¯å¦è¦æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹æœç´¢é¡µé¢ï¼Ÿ')) {
        window.open(neteaseUrl, '_blank');
      }
    }, 1000);
  });
  
  // éšè—æœç´¢ç»“æœ
  document.getElementById('searchResults').style.display = 'none';
}

// åˆ‡æ¢èƒŒæ™¯éŸ³ä¹æ’­æ”¾/æš‚åœ
function toggleBackgroundMusic() {
  const backgroundAudio = window.backgroundAudio;
  if (!backgroundAudio) return;
  
  const bgMusicBtn = document.getElementById('bgMusicToggle');
  
  if (backgroundAudio.paused) {
    backgroundAudio.play();
    bgMusicBtn.innerHTML = '<i class="fas fa-pause"></i>';
    bgMusicBtn.title = 'æš‚åœèƒŒæ™¯éŸ³ä¹';
  } else {
    backgroundAudio.pause();
    bgMusicBtn.innerHTML = '<i class="fas fa-play"></i>';
    bgMusicBtn.title = 'æ’­æ”¾èƒŒæ™¯éŸ³ä¹';
  }
}





// ä½¿ç”¨AIç”Ÿæˆçš„å†…å®¹
function useGeneratedContent() {
  // è·å–é€‰ä¸­çš„é—®é¢˜
  const selectedQuestions = getSelectedQuestionsFromPreview();
  
  if (selectedQuestions.length === 0) {
    showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé—®é¢˜ï¼', 'error');
    return;
  }
  
  // ä¿å­˜é€‰ä¸­çš„é—®é¢˜åˆ°å…¨å±€å˜é‡
  window.selectedQuestions = selectedQuestions;
  
  // éšè—AIé¢„è§ˆï¼Œæ˜¾ç¤ºæ—¥è®°ç¼–è¾‘è¡¨å•
  document.getElementById('aiContentPreview').style.display = 'none';
  document.getElementById('diaryFormContainer').style.display = 'block';
  
  // æ˜¾ç¤º"ä¿å­˜è®°å½•"æŒ‰é’®
  document.getElementById('completeDiary').style.display = 'inline-flex';
  
  // ç”Ÿæˆé€‰ä¸­é—®é¢˜çš„è¾“å…¥æ¡†
  generateSelectedQuestionInputs(selectedQuestions);
  
  // è®¾ç½®å¿ƒæƒ…é€‰æ‹©
  document.querySelectorAll('#diaryFormContainer .mood-option').forEach(option => {
    option.classList.remove('selected');
    if (option.dataset.mood === selectedMood) {
      option.classList.add('selected');
    }
  });
  
  // è§¦å‘éªŒè¯
  validateStep3();
  
  showNotification(`å·²é€‰æ‹© ${selectedQuestions.length} ä¸ªé—®é¢˜ï¼Œè¯·å¡«å†™æ‚¨çš„ç­”æ¡ˆï¼`, 'success');
}

// ä»AIé¢„è§ˆä¸­è·å–é€‰ä¸­çš„é—®é¢˜
function getSelectedQuestionsFromPreview() {
  const selectedQuestions = [];
  const checkboxes = document.querySelectorAll('#aiContentPreview .question-select-checkbox');
  
  checkboxes.forEach((checkbox, index) => {
    if (checkbox.checked) {
      const questionItem = checkbox.closest('.question-selection-item');
      const question = questionItem.getAttribute('data-question');
      const originalIndex = questionItem.getAttribute('data-index');
      selectedQuestions.push({
        index: parseInt(originalIndex),
        question: question
      });
    }
  });
  
  return selectedQuestions;
}

// è§£æAIç”Ÿæˆçš„é—®é¢˜
function parseAIQuestions(content) {
  const lines = content.split('\n');
  let questions = [];
  let music = '';
  
  for (const line of lines) {
    const trimmedLine = line.trim();
    if (trimmedLine === '') continue;
    
    if (trimmedLine.includes('ğŸµ éŸ³ä¹æ¨èï¼š')) {
      music = trimmedLine.replace('ğŸµ éŸ³ä¹æ¨èï¼š', '');
      continue;
    }
    
    // åŒ¹é…æ•°å­—ç¼–å·çš„ç–‘é—®å¥ (ä¾‹å¦‚ "1. ä½ çš„é—®é¢˜?")
    const questionMatch = trimmedLine.match(/^(\d+)\.\s*(.*)/);
    if (questionMatch) {
      questions.push(questionMatch[2]); // æå–é—®é¢˜å†…å®¹
    } else if (trimmedLine.startsWith('â€¢ ')) {
      questions.push(trimmedLine.substring(2));
    } else if (!trimmedLine.includes('ğŸµ')) {
      questions.push(trimmedLine);
    }
  }
  
  // ä¿å­˜éŸ³ä¹æ¨èä¿¡æ¯
  window.currentMusicRecommendation = music;
  
  return questions.filter(q => q.trim() !== '');
}

// æ˜¾ç¤ºé—®é¢˜é€‰æ‹©ç•Œé¢
function showQuestionSelectionInterface(questions) {
  // éšè—AIé¢„è§ˆï¼Œæ˜¾ç¤ºé—®é¢˜é€‰æ‹©ç•Œé¢
  document.getElementById('aiContentPreview').style.display = 'none';
  
  // åˆ›å»ºé—®é¢˜é€‰æ‹©ç•Œé¢
  const selectionContainer = document.createElement('div');
  selectionContainer.id = 'questionSelectionContainer';
  selectionContainer.className = 'question-selection-container';
  
  let html = `
    <div class="selection-header">
      <h3><i class="fas fa-check-circle"></i> é€‰æ‹©æ‚¨æƒ³å›ç­”çš„é—®é¢˜</h3>
      <p>è¯·é€‰æ‹©æ‚¨æƒ³è¦å›ç­”çš„é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å°†ä½œä¸ºæ‚¨ä»Šå¤©çš„ç”Ÿæ´»è®°å½•å†…å®¹</p>
    </div>
    <div class="questions-selection-list">
  `;
  
  questions.forEach((question, index) => {
    html += `
      <div class="question-selection-item" data-question="${question}" data-index="${index}">
        <div class="question-checkbox">
          <input type="checkbox" id="question${index}" class="question-select-checkbox">
          <label for="question${index}"></label>
        </div>
        <div class="question-content">
          <span class="question-number">${index + 1}.</span>
          <span class="question-text">${question}</span>
        </div>
      </div>
    `;
  });
  
  html += `
    </div>
    <div class="selection-actions">
      <button class="btn btn-secondary" onclick="selectAllQuestions()">
        <i class="fas fa-check-double"></i> å…¨é€‰
      </button>
      <button class="btn btn-secondary" onclick="deselectAllQuestions()">
        <i class="fas fa-times"></i> å–æ¶ˆå…¨é€‰
      </button>
      <button class="btn btn-primary" onclick="confirmSelectedQuestions()">
        <i class="fas fa-arrow-right"></i> ç¡®è®¤é€‰æ‹©å¹¶ç»§ç»­
      </button>
    </div>
  `;
  
  selectionContainer.innerHTML = html;
  
  // æ’å…¥åˆ°AIé¢„è§ˆçš„ä½ç½®
  const aiPreview = document.getElementById('aiContentPreview');
  aiPreview.parentNode.insertBefore(selectionContainer, aiPreview.nextSibling);
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  addQuestionSelectionListeners();
}

// æ·»åŠ é—®é¢˜é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
function addQuestionSelectionListeners() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  const questionItems = document.querySelectorAll('.question-selection-item');
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateSelectionStatus();
      updateQuestionItemStyle(this);
    });
  });
  
  // ä¸ºæ•´ä¸ªé—®é¢˜é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
  questionItems.forEach(item => {
    item.addEventListener('click', function(e) {
      // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†æœ¬èº«ï¼Œä¸é‡å¤å¤„ç†
      if (e.target.type === 'checkbox') return;
      
      const checkbox = this.querySelector('.question-select-checkbox');
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateSelectionStatus();
        updateQuestionItemStyle(checkbox);
      }
    });
  });
  
  // åˆå§‹åŒ–é€‰æ‹©çŠ¶æ€
  updateSelectionStatus();
}

// æ›´æ–°é€‰æ‹©çŠ¶æ€
function updateSelectionStatus() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  const totalCount = checkboxes.length;
  
  // æ›´æ–°"ä½¿ç”¨æ­¤å†…å®¹"æŒ‰é’®çŠ¶æ€
  const useContentBtn = document.getElementById('useGeneratedContent');
  if (useContentBtn) {
    if (selectedCount > 0) {
      useContentBtn.innerHTML = `<i class="fas fa-check"></i><span>ä½¿ç”¨æ­¤å†…å®¹ (${selectedCount}/${totalCount})</span>`;
      useContentBtn.disabled = false;
    } else {
      useContentBtn.innerHTML = `<i class="fas fa-check"></i><span>è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé—®é¢˜</span>`;
      useContentBtn.disabled = true;
    }
  }
}

// å…¨é€‰é—®é¢˜
function selectAllQuestions() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = true;
  });
  updateSelectionStatus();
}

// å–æ¶ˆå…¨é€‰
function deselectAllQuestions() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
  updateSelectionStatus();
}

// ç¡®è®¤é€‰æ‹©çš„é—®é¢˜
function confirmSelectedQuestions() {
  const selectedQuestions = [];
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  
  checkboxes.forEach((checkbox, index) => {
    if (checkbox.checked) {
      const questionItem = checkbox.closest('.question-selection-item');
      const question = questionItem.getAttribute('data-question');
      selectedQuestions.push({
        index: index,
        question: question
      });
    }
  });
  
  if (selectedQuestions.length === 0) {
    showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé—®é¢˜ï¼', 'error');
    return;
  }
  
  // ä¿å­˜é€‰ä¸­çš„é—®é¢˜åˆ°å…¨å±€å˜é‡
  window.selectedQuestions = selectedQuestions;
  
  // éšè—é€‰æ‹©ç•Œé¢ï¼Œæ˜¾ç¤ºæ—¥è®°ç¼–è¾‘è¡¨å•
  document.getElementById('questionSelectionContainer').style.display = 'none';
  document.getElementById('diaryFormContainer').style.display = 'block';
  
  // ç”Ÿæˆé€‰ä¸­é—®é¢˜çš„è¾“å…¥æ¡†
  generateSelectedQuestionInputs(selectedQuestions);
  
  // è®¾ç½®å¿ƒæƒ…é€‰æ‹©
  document.querySelectorAll('#diaryFormContainer .mood-option').forEach(option => {
    option.classList.remove('selected');
    if (option.dataset.mood === selectedMood) {
      option.classList.add('selected');
    }
  });
  
  // è§¦å‘éªŒè¯
  validateStep3();
  
  showNotification(`å·²é€‰æ‹© ${selectedQuestions.length} ä¸ªé—®é¢˜ï¼Œè¯·å¡«å†™æ‚¨çš„ç­”æ¡ˆï¼`, 'success');
}

// ç”Ÿæˆé€‰ä¸­é—®é¢˜çš„è¾“å…¥æ¡†
function generateSelectedQuestionInputs(selectedQuestions) {
  const container = document.getElementById('questionsContainer');
  container.innerHTML = '';
  
  // ä¸ºæ¯ä¸ªé€‰ä¸­çš„é—®é¢˜ç”Ÿæˆè¾“å…¥æ¡†
  selectedQuestions.forEach((questionData, index) => {
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-input-group';
    questionDiv.innerHTML = `
      <div class="question-label">
        <span class="question-number">${index + 1}.</span>
        <span class="question-text">${questionData.question}</span>
      </div>
      <textarea 
        id="question${index + 1}" 
        class="form-control question-answer" 
        rows="4" 
        placeholder="è¯·åˆ†äº«æ‚¨çš„æƒ³æ³•..."
        data-question="${questionData.question}"
        data-original-index="${questionData.index}"
      ></textarea>
      <div class="additional-input-section">
        <input 
          type="text" 
          id="additionalInput${index + 1}" 
          class="form-control additional-input" 
          placeholder="è¡¥å……è¯´æ˜..."
          data-question="${questionData.question}"
        >
      </div>
    `;
    container.appendChild(questionDiv);
  });
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  addQuestionInputListeners();
}

// æ·»åŠ é—®é¢˜è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨
function addQuestionInputListeners() {
  const questionAnswers = document.querySelectorAll('.question-answer');
  const additionalInputs = document.querySelectorAll('.additional-input');
  
  questionAnswers.forEach((textarea, index) => {
    if (textarea && !textarea.hasEventListener) {
      textarea.addEventListener('input', validateStep3);
      textarea.hasEventListener = true;
    }
  });
  
  additionalInputs.forEach((input, index) => {
    if (input && !input.hasEventListener) {
      input.addEventListener('input', validateStep3);
      input.hasEventListener = true;
    }
  });
}

// ç”Ÿæˆé—®é¢˜è¾“å…¥æ¡†ï¼ˆä¿ç•™åŸå‡½æ•°ä»¥å…¼å®¹ï¼‰
function generateQuestionInputs(content) {
  // è¿™ä¸ªå‡½æ•°ç°åœ¨è¢«generateSelectedQuestionInputsæ›¿ä»£
  console.warn('generateQuestionInputså·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨generateSelectedQuestionInputs');
}

// åˆ‡æ¢é—®é¢˜è¾“å…¥æ¡†æ˜¾ç¤º/éšè—
function toggleQuestionInput(questionNumber) {
  console.log('toggleQuestionInput è¢«è°ƒç”¨ï¼Œé—®é¢˜ç¼–å·:', questionNumber);
  
  const inputWrapper = document.getElementById(`inputWrapper${questionNumber}`);
  const icon = document.getElementById(`icon${questionNumber}`);
  
  console.log('æ‰¾åˆ°çš„å…ƒç´ :', { inputWrapper, icon });
  
  if (!inputWrapper || !icon) {
    console.error('æ‰¾ä¸åˆ°å…ƒç´ :', questionNumber);
    return;
  }
  
  const questionHeader = icon.closest('.question-header');
  console.log('å½“å‰æ˜¾ç¤ºçŠ¶æ€:', inputWrapper.style.display);
  
  if (inputWrapper.style.display === 'none') {
    // å±•å¼€è¾“å…¥æ¡†
    console.log('å±•å¼€è¾“å…¥æ¡†');
    inputWrapper.style.display = 'block';
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-up');
    if (questionHeader) {
      questionHeader.classList.add('active');
    }
    
    // èšç„¦åˆ°è¾“å…¥æ¡†
    setTimeout(() => {
      const textarea = document.getElementById(`question${questionNumber}`);
      if (textarea) {
        textarea.focus();
      }
    }, 100);
  } else {
    // æ”¶èµ·è¾“å…¥æ¡†
    console.log('æ”¶èµ·è¾“å…¥æ¡†');
    inputWrapper.style.display = 'none';
    icon.classList.remove('fa-chevron-up');
    icon.classList.add('fa-chevron-down');
    if (questionHeader) {
      questionHeader.classList.remove('active');
    }
  }
}

// æ ¼å¼åŒ–å†…å®¹ç”¨äºç¼–è¾‘
function formatContentForEditing(content) {
  // ç§»é™¤ã€10ä¸ªç–‘é—®å¥ã€‘å’Œã€æ¨èéŸ³ä¹ã€‘æ ‡è®°ï¼Œå¹¶æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
  let processedContent = content
    .replace(/ã€10ä¸ªç–‘é—®å¥ã€‘\n*/g, '') // ç§»é™¤æ ‡é¢˜å’Œå…¶åçš„æ¢è¡Œ
    .replace(/ã€æ¨èéŸ³ä¹ã€‘\n*/g, '') // ç§»é™¤æ ‡é¢˜å’Œå…¶åçš„æ¢è¡Œ
    .trim(); // æ¸…ç†æ•´ä½“å†…å®¹çš„ç©ºç™½

  const lines = processedContent.split('\n');
  let questions = [];
  let music = '';
  let inMusicSection = false; // æ ‡è®°æ˜¯å¦è¿›å…¥éŸ³ä¹ä¿¡æ¯éƒ¨åˆ†

  for (const line of lines) {
    const trimmedLine = line.trim();
    if (trimmedLine === '') {
      continue; // è·³è¿‡ç©ºè¡Œ
    }

    // å°è¯•åŒ¹é…éŸ³ä¹ä¿¡æ¯è¡Œ (ä¾‹å¦‚ "æ­Œæ›²å - è‰ºæœ¯å®¶")
    // å¹¶ä¸”ç¡®ä¿æˆ‘ä»¬è¿˜æ²¡æœ‰æ‰¾åˆ°éŸ³ä¹ä¿¡æ¯ï¼Œé¿å…é‡å¤æˆ–é”™è¯¯åŒ¹é…
    if (trimmedLine.includes(' - ') && !music && !inMusicSection) {
        music = trimmedLine;
        inMusicSection = true; // æ ‡è®°å·²æ‰¾åˆ°éŸ³ä¹ä¿¡æ¯
        continue;
    }

    // åŒ¹é…æ•°å­—ç¼–å·çš„ç–‘é—®å¥ (ä¾‹å¦‚ "1. ä½ çš„é—®é¢˜?")
    const questionMatch = trimmedLine.match(/^(\d+)\.\s*(.*)/);
    if (questionMatch) {
      questions.push(`â€¢ ${questionMatch[2]}`); // è½¬æ¢ä¸ºåœ†ç‚¹åˆ—è¡¨æ ¼å¼
    } else if (!inMusicSection) {
      // å¦‚æœä¸æ˜¯ç¼–å·é—®é¢˜ï¼Œä¹Ÿä¸æ˜¯éŸ³ä¹ä¿¡æ¯ï¼Œä¸”æœªè¿›å…¥éŸ³ä¹éƒ¨åˆ†ï¼Œåˆ™ä½œä¸ºæ™®é€šæ–‡æœ¬è¡Œå¤„ç†
      // è¿™å¯ä»¥æ•è·AIå¯èƒ½ç”Ÿæˆçš„éç¼–å·æ–‡æœ¬
      questions.push(trimmedLine);
    }
  }

  // å°†æ‰€æœ‰å¤„ç†è¿‡çš„ç–‘é—®å¥ç”¨åŒæ¢è¡Œç¬¦è¿æ¥ï¼Œç¡®ä¿æ¯å¥ç‹¬ç«‹
  let finalOutput = questions.join('\n\n');

  // æ·»åŠ éŸ³ä¹æ¨èä¿¡æ¯
  if (music) {
    if (finalOutput) {
      finalOutput += '\n\n'; // å¦‚æœå‰é¢æœ‰å†…å®¹ï¼Œåˆ™æ·»åŠ åŒæ¢è¡Œåˆ†éš”
    }
    finalOutput += `ğŸµ éŸ³ä¹æ¨èï¼š${music}`;
  }

  // ç¡®ä¿æœ€ç»ˆè¾“å‡ºæœ‰è‰¯å¥½çš„æ’ç‰ˆ
  finalOutput = finalOutput
    .replace(/\n{3,}/g, '\n\n') // å°†3ä¸ªæˆ–æ›´å¤šæ¢è¡Œç¬¦æ›¿æ¢ä¸º2ä¸ª
    .trim(); // æ¸…ç†é¦–å°¾ç©ºç™½

  return finalOutput;
}

// æ ¼å¼åŒ–å†…å®¹ç”¨äºæ˜¾ç¤º
function formatContentForDisplay(content) {
  let formatted = content;
  // ç¡®ä¿å†…å®¹å¼€å§‹å¹²å‡€
  formatted = formatted.trim();

  // æ›¿æ¢ã€10ä¸ªç–‘é—®å¥ã€‘ä¸ºç¾è§‚çš„æ ‡é¢˜
  formatted = formatted.replace(/ã€10ä¸ªç–‘é—®å¥ã€‘/, '<h3><span style="color: #ff8c00;">&#128161;</span> é€‰æ‹©æ‚¨æƒ³å›ç­”çš„é—®é¢˜</h3><p style="color: #666; margin-bottom: 20px;">è¯·é€‰æ‹©æ‚¨æƒ³è¦å›ç­”çš„é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å°†ä½œä¸ºæ‚¨ä»Šå¤©çš„ç”Ÿæ´»è®°å½•å†…å®¹</p>');
  // æ›¿æ¢ã€æ¨èéŸ³ä¹ã€‘ä¸ºç¾è§‚çš„æ ‡é¢˜
  formatted = formatted.replace(/ã€æ¨èéŸ³ä¹ã€‘/, '<h3><span style="color: #ff8c00;">&#127925;</span> éŸ³ä¹æ¨è</h3>');

  // å°†æ•°å­—ç¼–å·çš„ç–‘é—®å¥è½¬æ¢ä¸ºå¯é€‰æ‹©çš„å½¢å¼
  formatted = formatted.replace(/(\d+)\.\s*(.*?)(?=\n\n|\nã€|\Z)/gs, (match, number, text) => {
    // é¿å…å°†éŸ³ä¹ä¿¡æ¯è¯¯åˆ¤ä¸ºé—®é¢˜
    if (text.includes(' - ') && text.includes('ğŸµ éŸ³ä¹æ¨èï¼š')) {
        return match; // å¦‚æœçœ‹èµ·æ¥åƒéŸ³ä¹ä¿¡æ¯ï¼Œåˆ™ä¸å¤„ç†
    }
    const questionText = text.trim();
    return `
      <div class="question-selection-item" data-question="${questionText}" data-index="${parseInt(number) - 1}">
        <div class="question-checkbox">
          <input type="checkbox" id="question${parseInt(number) - 1}" class="question-select-checkbox">
          <label for="question${parseInt(number) - 1}"></label>
        </div>
        <div class="question-content">
          <span class="question-number">${number}.</span>
          <span class="question-text">${questionText}</span>
        </div>
      </div>
    `;
  });

  // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br> æ ‡ç­¾ï¼Œä»¥ä¾¿åœ¨HTMLä¸­æ­£ç¡®æ˜¾ç¤º
  formatted = formatted.replace(/\n\n+/g, '<br><br>'); // å°†å¤šä¸ªæ¢è¡Œç¬¦è½¬æ¢ä¸ºåŒ <br>
  formatted = formatted.replace(/\n/g, '<br>'); // å°†å•ä¸ªæ¢è¡Œç¬¦è½¬æ¢ä¸ºå• <br>

  return formatted;
}



// å®Œæˆæ—¥è®°
async function completeDiary() {
  console.log('completeDiary å‡½æ•°è¢«è§¦å‘ã€‚');
  console.log('å½“å‰ diaryData:', diaryData);

  // ç¡®ä¿å¿ƒæƒ…æ•°æ®å­˜åœ¨
  if (!diaryData.mood || diaryData.mood === '') {
    diaryData.mood = selectedMood || 'neutral';
  }
  
  // æ”¶é›†æ‰€æœ‰é—®é¢˜å›ç­”å’Œè¡¥å……è¯´æ˜
  const questionAnswers = document.querySelectorAll('.question-answer');
  let totalContent = '';
  let questionAnswersData = [];
  
  questionAnswers.forEach((textarea, index) => {
    if (textarea) {
      const answer = textarea.value.trim();
      const question = textarea.dataset.question;
      const originalIndex = textarea.dataset.originalIndex;
      const additionalInput = document.getElementById(`additionalInput${index + 1}`);
      const additionalAnswer = additionalInput ? additionalInput.value.trim() : '';
      
      if (answer) {
        // æ„å»ºé—®é¢˜+ç­”æ¡ˆçš„å†…å®¹
        let questionAnswerContent = `é—®é¢˜ï¼š${question}\nå›ç­”ï¼š${answer}`;
        if (additionalAnswer) {
          questionAnswerContent += `\nè¡¥å……ï¼š${additionalAnswer}`;
        }
        totalContent += questionAnswerContent + '\n\n';
        
        // æ”¶é›†é—®é¢˜ç­”æ¡ˆæ•°æ®ç”¨äºä¿å­˜
        questionAnswersData.push({
          question: question,
          answer: answer,
          additional_answer: additionalAnswer,
          order: parseInt(originalIndex) + 1
        });
      }
    }
  });
  
  // æ–°çš„éªŒè¯é€»è¾‘ï¼šåªè¦æœ‰æ ‡é¢˜å°±å¯ä»¥ä¿å­˜
  if (!diaryData.title) {
    showNotification('è¯·è‡³å°‘å¡«å†™æ ‡é¢˜ï¼', 'error');
    return;
  }
  
  // å¦‚æœæ²¡æœ‰å›ç­”ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
  if (!totalContent) {
    totalContent = 'ä»Šå¤©çš„å¿ƒæƒ…å’Œæ„Ÿæ‚Ÿ';
  }
  
  diaryData.content = totalContent;
  console.log('å°è¯•ä¿å­˜çš„æ•°æ®:', diaryData);
  console.log('é—®é¢˜ç­”æ¡ˆæ•°æ®:', questionAnswersData);
  
  const completeButton = document.getElementById('completeDiary');
  if (!completeButton) {
    showNotification('ä¿å­˜æŒ‰é’®æœªæ‰¾åˆ°ï¼', 'error');
    return;
  }
  
  const originalText = completeButton.innerHTML;
  completeButton.innerHTML = '<span class="loading"></span> ä¿å­˜ä¸­...';
  completeButton.disabled = true;
  
  try {
    const csrfToken = getCookie('csrftoken');
    
    // æ”¶é›†éŸ³ä¹æ¨èä¿¡æ¯
    const musicRecommendation = window.currentMusicRecommendation || '';
    
    const response = await fetch('/tools/api/life-diary/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        action: 'save_diary',
        title: diaryData.title,
        content: diaryData.content,
        mood: diaryData.mood,
        mood_note: '',
        tags: [],
        question_answers: questionAnswersData,
        music_recommendation: musicRecommendation
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification('ğŸ‰ ç”Ÿæ´»è®°å½•ä¿å­˜æˆåŠŸï¼', 'success');
      goToStep(4); // ä¿å­˜æˆåŠŸåè·³è½¬åˆ°ç»Ÿè®¡é¡µé¢
    } else {
      showNotification(data.error || 'ä¿å­˜å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('ä¿å­˜æ—¥è®°å¤±è´¥:', error);
    showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  } finally {
    completeButton.innerHTML = originalText;
    completeButton.disabled = false;
  }
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStatistics() {
  try {
    console.log('å¼€å§‹åŠ è½½ç»Ÿè®¡æ•°æ®...');
    
    // æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸ
    const statisticsSection = document.getElementById('statisticsSection');
    if (statisticsSection) {
      statisticsSection.style.display = 'block';
      console.log('æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸ');
    } else {
      console.error('æ‰¾ä¸åˆ°statisticsSectionå…ƒç´ ');
    }
    
    const response = await fetch('/tools/api/life-diary/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'get_statistics'
      })
    });
    
    const data = await response.json();
    console.log('ç»Ÿè®¡æ•°æ®å“åº”:', data);
    
    if (data.success) {
      console.log('ç»Ÿè®¡æ•°æ®:', data.data);
      
      // æ›´æ–°ç»Ÿè®¡æ•°å­—
      const totalDiaryDaysElement = document.getElementById('totalDiaryDays');
      const totalDiaryCountElement = document.getElementById('totalDiaryCount');
      const happyDaysElement = document.getElementById('happyDays');
      const totalWordsElement = document.getElementById('totalWords');
      
      if (totalDiaryDaysElement) {
        totalDiaryDaysElement.textContent = data.data.total_diary_days || 0;
        console.log('æ›´æ–°æ—¥è®°å¤©æ•°:', data.data.total_diary_days || 0);
      } else {
        console.error('æ‰¾ä¸åˆ°totalDiaryDayså…ƒç´ ');
      }
      
      if (totalDiaryCountElement) {
        totalDiaryCountElement.textContent = data.data.total_diary_count || 0;
        console.log('æ›´æ–°æ—¥è®°æ¬¡æ•°:', data.data.total_diary_count || 0);
      } else {
        console.error('æ‰¾ä¸åˆ°totalDiaryCountå…ƒç´ ');
      }
      
      if (happyDaysElement) {
        happyDaysElement.textContent = data.data.happy_days;
        console.log('æ›´æ–°å¼€å¿ƒå¤©æ•°:', data.data.happy_days);
      } else {
        console.error('æ‰¾ä¸åˆ°happyDayså…ƒç´ ');
      }
      
      if (totalWordsElement) {
        totalWordsElement.textContent = data.data.total_words || 0;
        console.log('æ›´æ–°æ€»å­—æ•°:', data.data.total_words || 0);
      } else {
        console.error('æ‰¾ä¸åˆ°totalWordså…ƒç´ ');
      }
      
      // æ¸²æŸ“å¿ƒæƒ…è¶‹åŠ¿
      renderMoodChart(data.data);
      
      // æ·»åŠ ç»Ÿè®¡å¡ç‰‡ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
      addStatCardListeners();
      
      // æ·»åŠ å¿ƒæƒ…é€‰æ‹©ç›‘å¬å™¨
      addMoodSelectionListener();
    } else {
      console.error('ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥:', data.error);
    }
  } catch (error) {
    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
  }
}

// æ¸²æŸ“å¿ƒæƒ…è¶‹åŠ¿å›¾è¡¨
function renderMoodChart(moodData) {
  const canvas = document.getElementById('moodChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const width = canvas.width = canvas.offsetWidth;
  const height = canvas.height = 300;
  
  // æ¸…ç©ºç”»å¸ƒ
  ctx.clearRect(0, 0, width, height);
  
  // æ£€æŸ¥æ˜¯å¦æœ‰åç«¯æ•°æ®
  if (!moodData || !moodData.mood_timeline || moodData.mood_timeline.length === 0) {
    // å°è¯•ä»é¡µé¢ä¸Šçš„å½“å‰æ•°æ®ç”Ÿæˆä¸´æ—¶å›¾è¡¨
    const currentMood = getCurrentPageMood();
    if (currentMood) {
      renderTemporaryMoodChart(ctx, width, height, currentMood);
      return;
    } else {
      // æ˜¾ç¤ºæ— æ•°æ®æç¤º
      ctx.fillStyle = '#666';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('æš‚æ— å¿ƒæƒ…æ•°æ®', width / 2, height / 2);
      return;
    }
  }
  
  // æ›´æ–°çš„å¿ƒæƒ…ç­‰çº§æ˜ å°„ï¼ˆä¸åç«¯æƒé‡å¯¹åº”ï¼‰
  const moodLevels = {
    'happy': 5,        // éå¸¸ç§¯æ
    'excited': 5,      // å…´å¥‹
    'grateful': 4,     // æ„Ÿæ©
    'inspired': 4,     // å—å¯å‘
    'confident': 4,    // è‡ªä¿¡
    'calm': 4,         // å¹³é™
    'content': 3,      // æ»¡è¶³
    'neutral': 3,      // ä¸­æ€§
    'worried': 2,      // æ‹…å¿ƒ
    'tired': 2,        // ç–²æƒ«
    'sad': 1,          // æ‚²ä¼¤
    'anxious': 1,      // ç„¦è™‘
    'stressed': 1,     // å‹åŠ›
    'frustrated': 1,   // æ²®ä¸§
    'angry': 0         // æ„¤æ€’
  };
  
  // å‡†å¤‡æ•°æ® - ä½¿ç”¨å®é™…çš„æ—¶é—´çº¿æ•°æ®
  const timeline = moodData.mood_timeline;
  const dates = [];
  const levels = [];
  
  // è·å–æœ€è¿‘14å¤©çš„æ•°æ®ï¼Œå¦‚æœæ•°æ®ä¸è¶³åˆ™ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ•°æ®
  const recentData = timeline.slice(-14);
  
  recentData.forEach(item => {
    const date = new Date(item.date);
    const dateStr = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    dates.push(dateStr);
    levels.push(moodLevels[item.mood] || 3);
  });
  
  // å¦‚æœæ•°æ®ç‚¹å¤ªå°‘ï¼Œæ·»åŠ ä¸€äº›ç©ºæ•°æ®ç‚¹ä»¥ä¿æŒå›¾è¡¨ç¾è§‚
  while (dates.length < 7) {
    const lastDate = dates.length > 0 ? new Date(timeline[timeline.length - 1].date) : new Date();
    const newDate = new Date(lastDate);
    newDate.setDate(newDate.getDate() - (7 - dates.length));
    const dateStr = newDate.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    dates.unshift(dateStr);
    levels.unshift(3); // ä¸­æ€§å¿ƒæƒ…
  }
  
  // ç»˜åˆ¶åæ ‡è½´
  ctx.strokeStyle = '#ddd';
  ctx.lineWidth = 1;
  
  // Yè½´
  ctx.beginPath();
  ctx.moveTo(50, 30);
  ctx.lineTo(50, height - 50);
  ctx.stroke();
  
  // Xè½´
  ctx.beginPath();
  ctx.moveTo(50, height - 50);
  ctx.lineTo(width - 30, height - 50);
  ctx.stroke();
  
  // Yè½´æ ‡ç­¾
  ctx.fillStyle = '#666';
  ctx.font = '12px Arial';
  ctx.textAlign = 'right';
  const yLabels = ['æ„¤æ€’', 'æ¶ˆæ', 'æ‹…å¿ƒ', 'ä¸­æ€§', 'ç§¯æ'];
  for (let i = 0; i < 5; i++) {
    const y = height - 50 - (i * (height - 80) / 4);
    ctx.fillText(yLabels[i], 45, y + 4);
  }
  
  // Xè½´æ ‡ç­¾
  ctx.textAlign = 'center';
  dates.forEach((date, index) => {
    const x = 50 + (index * (width - 80) / (dates.length - 1));
    ctx.fillText(date, x, height - 30);
  });
  
  // ç»˜åˆ¶å¿ƒæƒ…æ›²çº¿
  ctx.strokeStyle = '#4CAF50';
  ctx.lineWidth = 3;
  ctx.beginPath();
  
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / (levels.length - 1));
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    if (index === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  ctx.stroke();
  
  // ç»˜åˆ¶æ•°æ®ç‚¹
  ctx.fillStyle = '#4CAF50';
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / (levels.length - 1));
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, 2 * Math.PI);
    ctx.fill();
  });
  
  // æ·»åŠ è¶‹åŠ¿æŒ‡ç¤ºå™¨
  if (moodData.mood_trend) {
    const trendText = {
      'improving': 'ğŸ“ˆ å¿ƒæƒ…æ”¹å–„ä¸­',
      'declining': 'ğŸ“‰ å¿ƒæƒ…ä¸‹é™ä¸­',
      'stable': 'â¡ï¸ å¿ƒæƒ…ç¨³å®š'
    };
    
    ctx.fillStyle = '#333';
    ctx.font = '14px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(trendText[moodData.mood_trend] || 'æœªçŸ¥è¶‹åŠ¿', 60, 25);
    
    // æ·»åŠ ç½®ä¿¡åº¦ä¿¡æ¯
    if (moodData.trend_confidence) {
      const confidenceText = {
        'high': 'é«˜ç½®ä¿¡åº¦',
        'medium': 'ä¸­ç­‰ç½®ä¿¡åº¦',
        'low': 'ä½ç½®ä¿¡åº¦'
      };
      ctx.fillStyle = '#666';
      ctx.font = '12px Arial';
      ctx.fillText(`ç½®ä¿¡åº¦: ${confidenceText[moodData.trend_confidence]}`, 60, 45);
      }
}

// è·å–å½“å‰é¡µé¢ä¸Šçš„å¿ƒæƒ…æ•°æ®
function getCurrentPageMood() {
  // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„å¿ƒæƒ…
  const selectedMoodOption = document.querySelector('.mood-option.selected');
  if (selectedMoodOption) {
    const moodText = selectedMoodOption.querySelector('span').textContent;
    // å°†ä¸­æ–‡å¿ƒæƒ…è½¬æ¢ä¸ºè‹±æ–‡æ ‡è¯†ç¬¦
    const moodMapping = {
      'å¼€å¿ƒ': 'happy',
      'å…´å¥‹': 'excited',
      'å¹³é™': 'calm',
      'æ»¡è¶³': 'content',
      'ä¸€èˆ¬': 'neutral',
      'æ‹…å¿ƒ': 'worried',
      'ç–²æƒ«': 'tired',
      'éš¾è¿‡': 'sad',
      'ç„¦è™‘': 'anxious',
      'å‹åŠ›': 'stressed',
      'æ²®ä¸§': 'frustrated',
      'ç”Ÿæ°”': 'angry',
      'æ„Ÿæ©': 'grateful',
      'å—å¯å‘': 'inspired',
      'è‡ªä¿¡': 'confident'
    };
    return moodMapping[moodText] || 'neutral';
  }
  
  // æ£€æŸ¥å…¨å±€å˜é‡
  if (window.selectedMood) {
    return window.selectedMood;
  }
  
  return null;
}

// æ¸²æŸ“ä¸´æ—¶å¿ƒæƒ…å›¾è¡¨
function renderTemporaryMoodChart(ctx, width, height, currentMood) {
  // å¿ƒæƒ…ç­‰çº§æ˜ å°„
  const moodLevels = {
    'happy': 5,
    'excited': 5,
    'grateful': 4,
    'inspired': 4,
    'confident': 4,
    'calm': 4,
    'content': 3,
    'neutral': 3,
    'worried': 2,
    'tired': 2,
    'sad': 1,
    'anxious': 1,
    'stressed': 1,
    'frustrated': 1,
    'angry': 0
  };
  
  const currentLevel = moodLevels[currentMood] || 3;
  
  // ç»˜åˆ¶åæ ‡è½´
  ctx.strokeStyle = '#ddd';
  ctx.lineWidth = 1;
  
  // Yè½´
  ctx.beginPath();
  ctx.moveTo(50, 30);
  ctx.lineTo(50, height - 50);
  ctx.stroke();
  
  // Xè½´
  ctx.beginPath();
  ctx.moveTo(50, height - 50);
  ctx.lineTo(width - 30, height - 50);
  ctx.stroke();
  
  // Yè½´æ ‡ç­¾
  ctx.fillStyle = '#666';
  ctx.font = '12px Arial';
  ctx.textAlign = 'right';
  const yLabels = ['æ„¤æ€’', 'æ¶ˆæ', 'æ‹…å¿ƒ', 'ä¸­æ€§', 'ç§¯æ'];
  for (let i = 0; i < 5; i++) {
    const y = height - 50 - (i * (height - 80) / 4);
    ctx.fillText(yLabels[i], 45, y + 4);
  }
  
  // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼ˆåŸºäºå½“å‰å¿ƒæƒ…ï¼‰
  const dates = [];
  const levels = [];
  const today = new Date();
  
  // ç”Ÿæˆæœ€è¿‘7å¤©çš„æ¨¡æ‹Ÿæ•°æ®
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dateStr = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    dates.push(dateStr);
    
    if (i === 0) {
      // ä»Šå¤©æ˜¯å½“å‰é€‰æ‹©çš„å¿ƒæƒ…
      levels.push(currentLevel);
    } else {
      // å‰å‡ å¤©æ˜¯éšæœºä½†æ¥è¿‘å½“å‰å¿ƒæƒ…çš„æ•°æ®
      const variation = Math.random() * 2 - 1; // -1 åˆ° 1 çš„éšæœºæ•°
      const simulatedLevel = Math.max(0, Math.min(5, currentLevel + variation));
      levels.push(Math.round(simulatedLevel));
    }
  }
  
  // Xè½´æ ‡ç­¾
  ctx.textAlign = 'center';
  dates.forEach((date, index) => {
    const x = 50 + (index * (width - 80) / 6);
    ctx.fillText(date, x, height - 30);
  });
  
  // ç»˜åˆ¶å¿ƒæƒ…æ›²çº¿
  ctx.strokeStyle = '#4CAF50';
  ctx.lineWidth = 3;
  ctx.beginPath();
  
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / 6);
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    if (index === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  ctx.stroke();
  
  // ç»˜åˆ¶æ•°æ®ç‚¹
  ctx.fillStyle = '#4CAF50';
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / 6);
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, 2 * Math.PI);
    ctx.fill();
  });
  
  // æ·»åŠ æç¤ºä¿¡æ¯
  ctx.fillStyle = '#333';
  ctx.font = '14px Arial';
  ctx.textAlign = 'left';
  ctx.fillText('ğŸ“Š åŸºäºå½“å‰é€‰æ‹©çš„å¿ƒæƒ…ç”Ÿæˆçš„é¢„è§ˆ', 60, 25);
  
  ctx.fillStyle = '#666';
  ctx.font = '12px Arial';
  ctx.fillText('ä¿å­˜æ—¥è®°åå°†æ˜¾ç¤ºçœŸå®çš„å†å²è¶‹åŠ¿', 60, 45);
  
  // æ›´æ–°å¿ƒæƒ…ç»Ÿè®¡æ‘˜è¦
  updateTemporaryMoodStats(currentMood);
}

// æ›´æ–°ä¸´æ—¶å¿ƒæƒ…ç»Ÿè®¡æ‘˜è¦
function updateTemporaryMoodStats(currentMood) {
  const summaryElement = document.getElementById('moodStatsSummary');
  if (!summaryElement) return;
  
  const moodText = {
    'happy': 'å¼€å¿ƒ',
    'excited': 'å…´å¥‹',
    'calm': 'å¹³é™',
    'content': 'æ»¡è¶³',
    'neutral': 'ä¸€èˆ¬',
    'worried': 'æ‹…å¿ƒ',
    'tired': 'ç–²æƒ«',
    'sad': 'éš¾è¿‡',
    'anxious': 'ç„¦è™‘',
    'stressed': 'å‹åŠ›',
    'frustrated': 'æ²®ä¸§',
    'angry': 'ç”Ÿæ°”',
    'grateful': 'æ„Ÿæ©',
    'inspired': 'å—å¯å‘',
    'confident': 'è‡ªä¿¡'
  };
  
  summaryElement.innerHTML = `
    <div class="mood-stats-grid">
      <div class="mood-stat-item positive">
        <span class="stat-label">ğŸ˜Š å½“å‰å¿ƒæƒ…</span>
        <span class="stat-value">${moodText[currentMood] || 'æœªçŸ¥'}</span>
      </div>
      <div class="mood-stat-item neutral">
        <span class="stat-label">ğŸ“ æç¤º</span>
        <span class="stat-value">ä¿å­˜æ—¥è®°æŸ¥çœ‹è¶‹åŠ¿</span>
      </div>
      <div class="mood-stat-item negative">
        <span class="stat-label">ğŸ“Š æ•°æ®çŠ¶æ€</span>
        <span class="stat-value">é¢„è§ˆæ¨¡å¼</span>
      </div>
      <div class="mood-stat-item stability">
        <span class="stat-label">ğŸ’¡ å»ºè®®</span>
        <span class="stat-value">ç»§ç»­è®°å½•ç”Ÿæ´»</span>
      </div>
    </div>
  `;
}

// æ›´æ–°å¿ƒæƒ…ç»Ÿè®¡æ‘˜è¦
  updateMoodStatsSummary(moodData);
}

// æ›´æ–°å¿ƒæƒ…ç»Ÿè®¡æ‘˜è¦
function updateMoodStatsSummary(moodData) {
  const summaryElement = document.getElementById('moodStatsSummary');
  if (!summaryElement) return;
  
  const totalDays = moodData.total_entries || 0;
  const positiveDays = moodData.positive_days || 0;
  const negativeDays = moodData.negative_days || 0;
  const neutralDays = moodData.neutral_days || 0;
  
  const positivePercent = totalDays > 0 ? Math.round((positiveDays / totalDays) * 100) : 0;
  const negativePercent = totalDays > 0 ? Math.round((negativeDays / totalDays) * 100) : 0;
  const neutralPercent = totalDays > 0 ? Math.round((neutralDays / totalDays) * 100) : 0;
  
  const stabilityText = {
    'stable': 'ç¨³å®š',
    'moderate': 'ä¸€èˆ¬',
    'volatile': 'æ³¢åŠ¨',
    'insufficient_data': 'æ•°æ®ä¸è¶³'
  };
  
  summaryElement.innerHTML = `
    <div class="mood-stats-grid">
      <div class="mood-stat-item positive">
        <span class="stat-label">ğŸ˜Š ç§¯æå¤©æ•°</span>
        <span class="stat-value">${positiveDays}å¤© (${positivePercent}%)</span>
      </div>
      <div class="mood-stat-item neutral">
        <span class="stat-label">ğŸ˜ ä¸­æ€§å¤©æ•°</span>
        <span class="stat-value">${neutralDays}å¤© (${neutralPercent}%)</span>
      </div>
      <div class="mood-stat-item negative">
        <span class="stat-label">ğŸ˜” æ¶ˆæå¤©æ•°</span>
        <span class="stat-value">${negativeDays}å¤© (${negativePercent}%)</span>
      </div>
      <div class="mood-stat-item stability">
        <span class="stat-label">ğŸ“Š å¿ƒæƒ…ç¨³å®šæ€§</span>
        <span class="stat-value">${stabilityText[moodData.stability] || 'æœªçŸ¥'}</span>
      </div>
    </div>
  `;
}

// å®Œæˆæ•´ä¸ªæµç¨‹
function finishDiary() {
  goToStep(5);
}

// ç›‘å¬å¿ƒæƒ…é€‰æ‹©å˜åŒ–
function addMoodSelectionListener() {
  const moodOptions = document.querySelectorAll('.mood-option');
  moodOptions.forEach(option => {
    option.addEventListener('click', function() {
      // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿é€‰æ‹©çŠ¶æ€å·²æ›´æ–°
      setTimeout(() => {
        const currentMood = getCurrentPageMood();
        if (currentMood) {
          // é‡æ–°æ¸²æŸ“å¿ƒæƒ…å›¾è¡¨
          const canvas = document.getElementById('moodChart');
          if (canvas) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = 300;
            ctx.clearRect(0, 0, width, height);
            renderTemporaryMoodChart(ctx, width, height, currentMood);
          }
        }
      }, 100);
    });
  });
}

// ç»Ÿè®¡å¡ç‰‡ç‚¹å‡»åŠŸèƒ½
function addStatCardListeners() {
  const statCards = document.querySelectorAll('.stat-card');
  
  statCards.forEach(card => {
    card.addEventListener('click', function() {
      const cardId = this.id;
      showStatDetail(cardId);
    });
  });
}

// æ˜¾ç¤ºç»Ÿè®¡è¯¦ç»†æ•°æ®
function showStatDetail(cardId) {
  const modal = document.getElementById('statDetailModal');
  const icon = document.getElementById('statDetailIcon');
  const title = document.getElementById('statDetailTitle');
  const summaryNumber = document.getElementById('statDetailSummaryNumber');
  const summaryLabel = document.getElementById('statDetailSummaryLabel');
  const list = document.getElementById('statDetailList');
  
  // æ ¹æ®å¡ç‰‡IDè®¾ç½®ä¸åŒçš„å†…å®¹
  switch(cardId) {
    case 'totalDiaryDaysCard':
      icon.textContent = 'ğŸ“…';
      title.textContent = 'æ—¥è®°å¤©æ•°è¯¦æƒ…';
      summaryNumber.textContent = document.getElementById('totalDiaryDays').textContent;
      summaryLabel.textContent = 'æ€»å¤©æ•°';
      loadDiaryDaysDetail(list);
      break;
    case 'totalDiaryCountCard':
      icon.textContent = 'ğŸ“';
      title.textContent = 'æ—¥è®°æ¬¡æ•°è¯¦æƒ…';
      summaryNumber.textContent = document.getElementById('totalDiaryCount').textContent;
      summaryLabel.textContent = 'æ€»æ¬¡æ•°';
      loadDiaryCountDetail(list);
      break;
    case 'happyDaysCard':
      icon.textContent = 'ğŸ˜Š';
      title.textContent = 'å¼€å¿ƒå¤©æ•°è¯¦æƒ…';
      summaryNumber.textContent = document.getElementById('happyDays').textContent;
      summaryLabel.textContent = 'å¼€å¿ƒå¤©æ•°';
      loadHappyDaysDetail(list);
      break;
    case 'totalWordsCard':
      icon.textContent = 'ğŸ“–';
      title.textContent = 'æ€»å­—æ•°è¯¦æƒ…';
      summaryNumber.textContent = document.getElementById('totalWords').textContent;
      summaryLabel.textContent = 'æ€»å­—æ•°';
      loadTotalWordsDetail(list);
      break;
  }
  
  // æ˜¾ç¤ºå¼¹çª—
  modal.style.display = 'flex';
  
  // æ·»åŠ ç‚¹å‡»æ•ˆæœ
  const card = document.getElementById(cardId);
  card.classList.add('clicked');
  setTimeout(() => {
    card.classList.remove('clicked');
  }, 300);
}

// å…³é—­ç»Ÿè®¡è¯¦ç»†æ•°æ®
function closeStatDetail() {
  const modal = document.getElementById('statDetailModal');
  modal.style.display = 'none';
}

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('statDetailModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeStatDetail();
      }
    });
  }
});

// åŠ è½½æ—¥è®°å¤©æ•°è¯¦æƒ…
function loadDiaryDaysDetail(list) {
  fetch('/tools/api/life-diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_diary_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const uniqueDates = [...new Set(data.diaries.map(diary => diary.date))];
      displayDiaryDaysDetail(list, uniqueDates, data.diaries);
    } else {
      displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    }
  })
  .catch(error => {
    console.error('åŠ è½½æ—¥è®°å¤©æ•°è¯¦æƒ…å¤±è´¥:', error);
    displayEmptyDetail(list, 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}

// åŠ è½½æ—¥è®°æ¬¡æ•°è¯¦æƒ…
function loadDiaryCountDetail(list) {
  fetch('/tools/api/life-diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_diary_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      displayDiaryCountDetail(list, data.diaries);
    } else {
      displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    }
  })
  .catch(error => {
    console.error('åŠ è½½æ—¥è®°æ¬¡æ•°è¯¦æƒ…å¤±è´¥:', error);
    displayEmptyDetail(list, 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}

// åŠ è½½å¼€å¿ƒå¤©æ•°è¯¦æƒ…
function loadHappyDaysDetail(list) {
  fetch('/tools/api/life-diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_happy_days_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      displayHappyDaysDetail(list, data.data);
    } else {
      displayEmptyDetail(list, 'æš‚æ— å¼€å¿ƒæ•°æ®');
    }
  })
  .catch(error => {
    console.error('åŠ è½½å¼€å¿ƒå¤©æ•°è¯¦æƒ…å¤±è´¥:', error);
    displayEmptyDetail(list, 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}

// åŠ è½½æ€»å­—æ•°è¯¦æƒ…
function loadTotalWordsDetail(list) {
  fetch('/tools/api/life-diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_diary_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      displayTotalWordsDetail(list, data.diaries);
    } else {
      displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    }
  })
  .catch(error => {
    console.error('åŠ è½½æ€»å­—æ•°è¯¦æƒ…å¤±è´¥:', error);
    displayEmptyDetail(list, 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}

// æ˜¾ç¤ºæ—¥è®°å¤©æ•°è¯¦æƒ…
function displayDiaryDaysDetail(list, uniqueDates, diaries) {
  if (uniqueDates.length === 0) {
    displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    return;
  }
  
  let html = '';
  uniqueDates.forEach(date => {
    const dateDiaries = diaries.filter(diary => diary.date === date);
    const firstDiary = dateDiaries[0];
    
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${date}</div>
          <div class="stat-detail-item-mood">${getMoodEmoji(firstDiary.mood)}</div>
        </div>
        <div class="stat-detail-item-title">${firstDiary.title}</div>
        <div class="stat-detail-item-content">${firstDiary.content.substring(0, 100)}${firstDiary.content.length > 100 ? '...' : ''}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// æ˜¾ç¤ºæ—¥è®°æ¬¡æ•°è¯¦æƒ…
function displayDiaryCountDetail(list, diaries) {
  if (diaries.length === 0) {
    displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    return;
  }
  
  let html = '';
  diaries.forEach(diary => {
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${diary.created_at.split('T')[0]}</div>
          <div class="stat-detail-item-mood">${getMoodEmoji(diary.mood)}</div>
        </div>
        <div class="stat-detail-item-title">${diary.title}</div>
        <div class="stat-detail-item-content">${diary.content.substring(0, 100)}${diary.content.length > 100 ? '...' : ''}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// æ˜¾ç¤ºå¼€å¿ƒå¤©æ•°è¯¦æƒ…
function displayHappyDaysDetail(list, happyDays) {
  if (happyDays.length === 0) {
    displayEmptyDetail(list, 'æš‚æ— å¼€å¿ƒæ•°æ®');
    return;
  }
  
  let html = '';
  happyDays.forEach(day => {
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${day.date}</div>
          <div class="stat-detail-item-mood">ğŸ˜Š</div>
        </div>
        <div class="stat-detail-item-title">${day.title}</div>
        <div class="stat-detail-item-content">${day.content}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// æ˜¾ç¤ºæ€»å­—æ•°è¯¦æƒ…
function displayTotalWordsDetail(list, diaries) {
  if (diaries.length === 0) {
    displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    return;
  }
  
  let html = '';
  diaries.forEach(diary => {
    const wordCount = diary.content.length;
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${diary.created_at.split('T')[0]}</div>
          <div class="stat-detail-item-mood">${getMoodEmoji(diary.mood)}</div>
        </div>
        <div class="stat-detail-item-title">${diary.title} <span style="color: #4CAF50; font-size: 12px;">(${wordCount}å­—)</span></div>
        <div class="stat-detail-item-content">${diary.content.substring(0, 100)}${diary.content.length > 100 ? '...' : ''}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// æ˜¾ç¤ºç©ºæ•°æ®
function displayEmptyDetail(list, message) {
  list.innerHTML = `
    <div class="stat-detail-empty">
      <div class="stat-detail-empty-icon">ğŸ“</div>
      <div class="stat-detail-empty-text">${message}</div>
    </div>
  `;
}

// è·å–å¿ƒæƒ…è¡¨æƒ…
function getMoodEmoji(mood) {
  const moodEmojis = {
    'happy': 'ğŸ˜Š',
    'calm': 'ğŸ˜Œ',
    'excited': 'â­',
    'sad': 'ğŸ˜¢',
    'angry': 'ğŸ˜ ',
    'neutral': 'ğŸ˜'
  };
  return moodEmojis[mood] || 'ğŸ˜';
}

// é‡ç½®æ—¥è®°
function resetDiary() {
  // é‡ç½®æ‰€æœ‰æ•°æ®
  selectedMood = null;
  selectedGoalCategories = [];
  diaryData = {
    title: '',
    content: '',
    mood: '',
    goal_category: ''
  };
  
  // é‡ç½®UI
  document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
  document.querySelectorAll('.goal-icon-option').forEach(opt => opt.classList.remove('selected'));
  
  // å®‰å…¨åœ°é‡ç½®è¡¨å•å…ƒç´ 
  const diaryTitle = document.getElementById('diaryTitle');
  const diaryContent = document.getElementById('diaryContent');
  
  if (diaryTitle) {
    diaryTitle.value = '';
  }
  
  if (diaryContent) {
    diaryContent.value = '';
  }
  
  // é‡ç½®é—®é¢˜è¾“å…¥æ¡†
  document.querySelectorAll('.question-answer').forEach(textarea => {
    if (textarea) {
      textarea.value = '';
    }
  });
  
  document.querySelectorAll('.additional-input').forEach(input => {
    if (input) {
      input.value = '';
    }
  });
  
  // é‡ç½®è¿›åº¦æŒ‡ç¤ºå™¨
  updateProgressIndicator(1);
  
  // è¿”å›ç¬¬ä¸€æ­¥
  goToStep(1);
  
  showNotification('å¼€å§‹æ–°çš„ç”Ÿæ´»è®°å½•ï¼', 'success');
}

// é—®é¢˜ç¼–è¾‘ç›¸å…³å‡½æ•°
function editQuestion(number, originalText) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const displayDiv = questionItem.querySelector('.question-display');
  const editDiv = questionItem.querySelector('.question-edit');
  const textarea = editDiv.querySelector('.question-edit-input');
  
  // æ˜¾ç¤ºç¼–è¾‘æ¨¡å¼
  displayDiv.style.display = 'none';
  editDiv.style.display = 'block';
  
  // è®¾ç½®åŸå§‹æ–‡æœ¬å¹¶èšç„¦
  textarea.value = originalText;
  textarea.focus();
  textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

function saveQuestion(number) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const displayDiv = questionItem.querySelector('.question-display');
  const editDiv = questionItem.querySelector('.question-edit');
  const textarea = editDiv.querySelector('.question-edit-input');
  const questionTextSpan = displayDiv.querySelector('.question-text');
  
  const newText = textarea.value.trim();
  
  if (newText) {
    // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
    questionTextSpan.textContent = newText;
    
    // åˆ‡æ¢å›æ˜¾ç¤ºæ¨¡å¼
    displayDiv.style.display = 'flex';
    editDiv.style.display = 'none';
    
    showNotification(`é—®é¢˜ ${number} å·²æ›´æ–°ï¼`, 'success');
  } else {
    showNotification('é—®é¢˜å†…å®¹ä¸èƒ½ä¸ºç©ºï¼', 'error');
  }
}

function cancelEditQuestion(number) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const displayDiv = questionItem.querySelector('.question-display');
  const editDiv = questionItem.querySelector('.question-edit');
  const textarea = editDiv.querySelector('.question-edit-input');
  
  // æ¢å¤åŸå§‹æ–‡æœ¬
  const originalText = displayDiv.querySelector('.question-text').textContent;
  textarea.value = originalText;
  
  // åˆ‡æ¢å›æ˜¾ç¤ºæ¨¡å¼
  displayDiv.style.display = 'flex';
  editDiv.style.display = 'none';
  
  showNotification('å·²å–æ¶ˆç¼–è¾‘', 'info');
}

// é”®ç›˜å¿«æ·é”®æ”¯æŒ
document.addEventListener('keydown', function(e) {
  // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼
  const activeEditDiv = document.querySelector('.question-edit[style*="display: block"]');
  if (activeEditDiv) {
    const textarea = activeEditDiv.querySelector('.question-edit-input');
    const questionNumber = textarea.getAttribute('data-question-number');
    
    if (e.key === 'Enter' && e.ctrlKey) {
      e.preventDefault();
      saveQuestion(questionNumber);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      cancelEditQuestion(questionNumber);
    }
  }
});

// ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­é—®é¢˜é€‰æ‹©å™¨
document.addEventListener('click', function(e) {
  const selectors = document.querySelectorAll('.question-selector');
  selectors.forEach(selector => {
    if (selector.style.display === 'block') {
      const questionItem = selector.closest('.question-item');
      if (questionItem && !questionItem.contains(e.target)) {
        const questionNumber = questionItem.getAttribute('data-question-number');
        closeQuestionSelector(questionNumber);
      }
    }
  });
});

// åŠ è½½ä»Šæ—¥æ•°æ®
async function loadTodayData() {
  try {
    const response = await fetch('/tools/api/life-diary/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'get_diary'
      })
    });
    
    const data = await response.json();
    
    if (data.success && data.data) {
      // å¦‚æœä»Šå¤©å·²æœ‰æ—¥è®°ï¼Œç›´æ¥è·³è½¬åˆ°å®Œæˆé¡µé¢
      showNotification('ä»Šå¤©çš„ç”Ÿæ´»è®°å½•å·²å®Œæˆï¼', 'success');
      setTimeout(() => {
        goToStep(5);
      }, 2000);
    }
  } catch (error) {
    console.error('åŠ è½½ä»Šæ—¥æ•°æ®å¤±è´¥:', error);
  }
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// è·å–CSRF Token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// æ·»åŠ åŠ¨ç”»æ ·å¼
const style = document.createElement('style');
style.textContent = `
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  @keyframes slideInUp {
    from { 
      opacity: 0; 
      transform: translateY(30px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }
`;
document.head.appendChild(style);

// é—®é¢˜é€‰æ‹©å™¨ç›¸å…³å‡½æ•°
function showQuestionSelector(number, currentText) {
  // éšè—æ‰€æœ‰å…¶ä»–é€‰æ‹©å™¨
  document.querySelectorAll('.question-selector').forEach(selector => {
    selector.style.display = 'none';
  });
  
  const selector = document.querySelector(`[data-question-number="${number}"] .question-selector`);
  if (selector) {
    selector.style.display = 'block';
    
    // è®¾ç½®å½“å‰æ–‡æœ¬åˆ°è‡ªå®šä¹‰è¾“å…¥æ¡†
    const customInput = selector.querySelector('.custom-question-input');
    if (customInput) {
      customInput.value = currentText;
    }
  }
}

function closeQuestionSelector(number) {
  const selector = document.querySelector(`[data-question-number="${number}"] .question-selector`);
  if (selector) {
    selector.style.display = 'none';
  }
}

function selectQuestion(number, questionText) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const questionTextSpan = questionItem.querySelector('.question-text');
  
  // æ›´æ–°é—®é¢˜æ–‡æœ¬
  questionTextSpan.textContent = questionText;
  
  // å…³é—­é€‰æ‹©å™¨
  closeQuestionSelector(number);
  
  showNotification(`é—®é¢˜ ${number} å·²æ›´æ–°ï¼`, 'success');
}

function useCustomQuestion(number) {
  const selector = document.querySelector(`[data-question-number="${number}"] .question-selector`);
  const customInput = selector.querySelector('.custom-question-input');
  const customText = customInput.value.trim();
  
  if (customText) {
    selectQuestion(number, customText);
  } else {
    showNotification('è¯·è¾“å…¥è‡ªå®šä¹‰é—®é¢˜å†…å®¹ï¼', 'error');
  }
}

// é—®é¢˜ç¼–è¾‘ç›¸å…³å‡½æ•°ï¼ˆä¿ç•™åŸæœ‰å‡½æ•°ä»¥å…¼å®¹ï¼‰
function editQuestion(number, originalText) {
  showQuestionSelector(number, originalText);
}

function saveQuestion(number) {
  // è¿™ä¸ªå‡½æ•°ç°åœ¨é€šè¿‡selectQuestionæˆ–useCustomQuestionæ¥å¤„ç†
  closeQuestionSelector(number);
}

function cancelEditQuestion(number) {
  closeQuestionSelector(number);
  showNotification('å·²å–æ¶ˆç¼–è¾‘', 'info');
}

// æ›´æ–°é—®é¢˜é¡¹çš„æ ·å¼
function updateQuestionItemStyle(checkbox) {
  const questionItem = checkbox.closest('.question-selection-item');
  if (checkbox.checked) {
    questionItem.classList.add('selected');
  } else {
    questionItem.classList.remove('selected');
  }
}
</script>
{% endblock %}