{% extends 'base.html' %}
{% load static %}

{% block tool_title_inner %}ç”Ÿæ´»æ—¥è®° - å±‚å±‚é€’è¿›{% endblock %}
{% block tool_title_display %}ç”Ÿæ´»æ—¥è®° - å±‚å±‚é€’è¿›{% endblock %}

{% block extra_css %}

<!-- CDNå›é€€å¤„ç† -->
<script>
// ç®€å•çš„CDNå›é€€å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥Bootstrap CSSæ˜¯å¦åŠ è½½
    if (!document.querySelector('link[href*="bootstrap"]')) {
        const bootstrapLink = document.createElement('link');
        bootstrapLink.rel = 'stylesheet';
        bootstrapLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css';
        bootstrapLink.onerror = function() {
            this.href = 'https://unpkg.com/bootstrap@4.5.2/dist/css/bootstrap.min.css';
        };
        document.head.appendChild(bootstrapLink);
    }
    
    // æ£€æŸ¥Font Awesomeæ˜¯å¦åŠ è½½
    if (!document.querySelector('link[href*="font-awesome"]')) {
        const faLink = document.createElement('link');
        faLink.rel = 'stylesheet';
        faLink.href = 'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css';
        faLink.onerror = function() {
            this.href = 'https://unpkg.com/@fortawesome/fontawesome-free@5.15.4/css/all.min.css';
        };
        document.head.appendChild(faLink);
    }
    
    // æ£€æŸ¥å¹¶åŠ è½½JavaScriptä¾èµ– - ç¡®ä¿æ­£ç¡®çš„åŠ è½½é¡ºåº
    function loadScript(src, fallbackSrc, callback) {
        const script = document.createElement('script');
        script.src = src;
        script.onerror = function() {
            this.src = fallbackSrc;
        };
        script.onload = callback;
        document.head.appendChild(script);
    }
    
    // æŒ‰é¡ºåºåŠ è½½ä¾èµ–
    if (!window.jQuery) {
        loadScript(
            'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.slim.min.js',
            'https://unpkg.com/jquery@3.5.1/dist/jquery.slim.min.js',
            function() {
                // jQueryåŠ è½½å®ŒæˆååŠ è½½Popper
                if (!window.Popper) {
                    loadScript(
                        'https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js',
                        'https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js',
                        function() {
                            // PopperåŠ è½½å®ŒæˆååŠ è½½Bootstrap
                            if (!window.bootstrap) {
                                loadScript(
                                    'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                                    'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                                );
                            }
                        }
                    );
                } else if (!window.bootstrap) {
                    // å¦‚æœPopperå·²å­˜åœ¨ï¼Œç›´æ¥åŠ è½½Bootstrap
                    loadScript(
                        'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                        'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                    );
                }
            }
        );
    } else if (!window.Popper) {
        // å¦‚æœjQueryå·²å­˜åœ¨ï¼ŒåŠ è½½Popper
        loadScript(
            'https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js',
            'https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js',
            function() {
                if (!window.bootstrap) {
                    loadScript(
                        'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
                        'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
                    );
                }
            }
        );
    } else if (!window.bootstrap) {
        // å¦‚æœjQueryå’ŒPopperéƒ½å·²å­˜åœ¨ï¼ŒåªåŠ è½½Bootstrap
        loadScript(
            'https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js',
            'https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js'
        );
    }
});
</script>

<link rel="stylesheet" href="{% static 'progressive_diary.css' %}">
<style>
/* æ€è€ƒé—®é¢˜è¾“å…¥æ¡†æ ·å¼ */
.question-input-group {
  margin-bottom: 20px;
  padding: 15px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  background: #fafafa;
  transition: all 0.3s ease;
}

.question-input-group:hover {
  border-color: #007bff;
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
}

.question-label {
  margin-bottom: 10px;
  font-weight: 600;
  color: #333;
}

.question-number {
  color: #007bff;
  font-weight: bold;
  margin-right: 8px;
}

.question-text {
  color: #555;
  line-height: 1.4;
}

.question-answer {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  font-size: 16px;
  font-weight: 500;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: #2c3e50;
  resize: vertical;
  transition: border-color 0.3s ease;
}

.question-answer:focus {
  border-color: #007bff;
  outline: none;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

/* è¡¥å……è¾“å…¥æ¡†æ ·å¼ */
.additional-input-section {
  margin-top: 10px;
}

.additional-input {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 15px;
  font-weight: 500;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: #2c3e50;
  transition: border-color 0.3s ease;
  background-color: #f8f9fa;
}

.additional-input:focus {
  border-color: #28a745;
  outline: none;
  box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
  background-color: #fff;
}

.additional-input::placeholder {
  color: #6c757d;
  font-style: italic;
}

/* å¯ç¼–è¾‘é—®é¢˜æ ·å¼ */
.question-item {
  margin-bottom: 15px;
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.question-display {
  padding: 15px;
  background: #f8f9fa;
  border: 2px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  transition: all 0.3s ease;
  position: relative;
}

.question-display:hover {
  background: #e9ecef;
  border-color: #007bff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.question-number {
  color: #ff8c00;
  font-weight: bold;
  font-size: 16px;
  min-width: 25px;
}

.question-text {
  color: #333;
  line-height: 1.6;
  flex: 1;
  font-size: 14px;
}

.edit-icon {
  color: #6c757d;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.question-display:hover .edit-icon {
  opacity: 1;
}

.question-edit {
  padding: 15px;
  background: #fff;
  border: 2px solid #007bff;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.question-edit-input {
  width: 100%;
  min-height: 80px;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 15px;
  font-weight: 500;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: #2c3e50;
  resize: vertical;
  margin-bottom: 10px;
}

.question-edit-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.question-edit-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.save-question-btn, .cancel-question-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.save-question-btn {
  background: #28a745;
  color: white;
}

.save-question-btn:hover {
  background: #218838;
  transform: translateY(-1px);
}

.cancel-question-btn {
  background: #6c757d;
  color: white;
}

.cancel-question-btn:hover {
  background: #5a6268;
  transform: translateY(-1px);
}

/* éŸ³ä¹æ¨èåŒºåŸŸæ ·å¼ */
.music-recommendation {
  margin: 20px 0;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  color: white;
}

.music-header {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}

.music-header i {
  font-size: 20px;
  margin-right: 10px;
}

.music-header h4 {
  margin: 0;
  font-size: 18px;
}

.music-recommendation-content {
  margin-bottom: 15px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.music-recommendation-text {
  margin: 0;
}

.music-recommendation-text p {
  margin: 0;
  font-size: 14px;
  line-height: 1.5;
}

.music-search-section {
  background: rgba(255, 255, 255, 0.1);
  padding: 15px;
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.music-search-section h4 {
  margin: 0 0 10px 0;
  font-size: 16px;
}

.search-box {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.search-box input {
  flex: 1;
  border: none;
  border-radius: 6px;
  padding: 10px;
  background: rgba(255, 255, 255, 0.9);
  color: #333;
}

.search-box button {
  border: none;
  border-radius: 6px;
  padding: 10px 15px;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  cursor: pointer;
  transition: background 0.3s ease;
}

.search-box button:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* æœç´¢ç»“æœæ ·å¼ */
.search-results {
  margin-top: 15px;
  max-height: 300px;
  overflow-y: auto;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.songs-list {
  padding: 10px;
}

.song-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  margin-bottom: 8px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.song-item:hover {
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.song-info {
  flex: 1;
}

.song-title {
  font-weight: 600;
  color: #333;
  margin-bottom: 4px;
}

.song-artist {
  font-size: 12px;
  color: #666;
}

.song-duration {
  font-size: 11px;
  color: #999;
}

.song-play-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.song-play-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.no-results {
  padding: 20px;
  text-align: center;
  color: #666;
  font-style: italic;
}

/* ç¡®ä¿éŸ³ä¹æ¨èåŒºåŸŸåœ¨ä¿å­˜åä¹Ÿèƒ½æ˜¾ç¤º */
.music-recommendation[style*="display: none"] {
  display: block !important;
}

/* æ‰“å¡æ—¥å†æ ·å¼ */
.checkin-calendar-section {
  margin-top: 30px;
  padding: 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 15px;
  border: 1px solid #dee2e6;
}

.checkin-calendar-section h4 {
  margin: 0 0 20px 0;
  color: #2c3e50;
  font-size: 18px;
  font-weight: 600;
}

.checkin-calendar-container {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.calendar-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
}

.nav-btn {
  background: none;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  color: #6c757d;
}

.nav-btn:hover {
  background: #e9ecef;
  color: #495057;
}

.today-btn {
  background: #007bff;
  color: white;
}

.today-btn:hover {
  background: #0056b3;
}

.current-month {
  font-weight: 600;
  color: #2c3e50;
  font-size: 16px;
}

.streak-info {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin-bottom: 20px;
  padding: 15px;
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
  border-radius: 10px;
  color: white;
}

.streak-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
}

.streak-item i {
  color: #ffd700;
}

.calendar-grid {
  margin-bottom: 20px;
}

.calendar-header {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 10px;
}

.calendar-header > div {
  text-align: center;
  padding: 10px;
  font-weight: 600;
  color: #6c757d;
  background: #f8f9fa;
  border-radius: 6px;
}

.calendar-body {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  position: relative;
  background: white;
  border: 1px solid #e9ecef;
}

.calendar-day:hover {
  background: #e3f2fd;
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.calendar-day.other-month {
  color: #adb5bd;
  background: #f8f9fa;
}

.calendar-day.today {
  background: #007bff;
  color: white;
  font-weight: 600;
}

.calendar-day.has-checkin {
  background: #28a745;
  color: white;
}

.calendar-day.completed {
  background: #28a745;
  color: white;
}

.calendar-day.rest {
  background: #ffc107;
  color: #212529;
}

.monthly-stats {
  display: flex;
  justify-content: space-around;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}

.stat-item {
  text-align: center;
}

.stat-label {
  display: block;
  font-size: 12px;
  color: #6c757d;
  margin-bottom: 4px;
}

.stat-value {
  display: block;
  font-size: 18px;
  font-weight: 600;
  color: #2c3e50;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .question-input-group {
    padding: 12px;
  }
  
  .music-recommendation {
    padding: 15px;
  }
  
  .search-box {
    flex-direction: column;
  }
  
  .search-box button {
    width: 100%;
  }
  
  .streak-info {
    flex-direction: column;
    gap: 15px;
  }
  
  .monthly-stats {
    flex-direction: column;
    gap: 15px;
  }
}

/* æ‰“å¡æ¨¡æ€æ¡†æ ·å¼ */
.checkin-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(5px);
}

.checkin-modal-content {
  background: white;
  border-radius: 15px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.checkin-modal-content h3 {
  margin: 0 0 20px 0;
  color: #2c3e50;
  font-size: 20px;
  font-weight: 600;
}

.confirmation-message {
  text-align: center;
  margin-bottom: 25px;
}

.confirmation-message p {
  margin: 10px 0;
  color: #555;
  line-height: 1.6;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.form-actions {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  margin-top: 25px;
}

.btn-cancel,
.btn-confirm,
.btn-submit,
.btn-edit,
.btn-delete {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.btn-cancel {
  background: #6c757d;
  color: white;
}

.btn-cancel:hover {
  background: #5a6268;
}

.btn-confirm,
.btn-submit {
  background: #007bff;
  color: white;
}

.btn-confirm:hover,
.btn-submit:hover {
  background: #0056b3;
}

.btn-edit {
  background: #28a745;
  color: white;
}

.btn-edit:hover {
  background: #218838;
}

.btn-delete {
  background: #dc3545;
  color: white;
}

.btn-delete:hover {
  background: #c82333;
}

.checkin-detail {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.checkin-detail p {
  margin: 8px 0;
  color: #333;
}

@keyframes slideInUp {
  from { 
    opacity: 0; 
    transform: translateY(30px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

/* é—®é¢˜é€‰æ‹©å™¨æ ·å¼ */
.question-selector {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid #4CAF50;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 1000;
  max-height: 400px;
  overflow-y: auto;
}

/* é—®é¢˜é€‰æ‹©ç•Œé¢æ ·å¼ */
.question-selection-container {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin: 20px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  border: 1px solid #e9ecef;
}

.selection-header {
  text-align: center;
  margin-bottom: 24px;
}

.selection-header h3 {
  color: #333;
  margin-bottom: 8px;
  font-size: 20px;
}

.selection-header p {
  color: #666;
  font-size: 14px;
  margin: 0;
}

.questions-selection-list {
  max-height: 400px;
  overflow-y: auto;
  margin-bottom: 20px;
}

.question-selection-item {
  display: flex;
  align-items: center;
  padding: 16px;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  margin-bottom: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  position: relative;
  overflow: hidden;
}

.question-selection-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
  transition: left 0.5s ease;
}

.question-selection-item:hover::before {
  left: 100%;
}

.question-selection-item:hover {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(76, 175, 80, 0.15);
}

.question-selection-item.selected {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  box-shadow: 0 4px 20px rgba(76, 175, 80, 0.25);
  transform: translateY(-1px);
}

.question-selection-item.selected::after {
  content: 'âœ“';
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  animation: checkmarkAppear 0.3s ease;
}

.question-checkbox {
  margin-right: 16px;
  position: relative;
}

.question-select-checkbox {
  width: 20px;
  height: 20px;
  accent-color: #4CAF50;
  cursor: pointer;
  border-radius: 4px;
  border: 2px solid #ddd;
  transition: all 0.3s ease;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background: white;
  position: relative;
}

.question-select-checkbox:checked {
  border-color: #4CAF50;
  background-color: #4CAF50;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='white' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 9 4 4L15 3'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: center;
  background-size: 12px;
}

.question-content {
  flex: 1;
  display: flex;
  align-items: center;
}

.question-number {
  color: #4CAF50;
  font-weight: 600;
  margin-right: 12px;
  min-width: 24px;
  font-size: 15px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.question-text {
  color: #2c3e50;
  font-size: 15px;
  line-height: 1.6;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-weight: 400;
  letter-spacing: 0.2px;
}

.selection-actions {
  display: flex;
  justify-content: center;
  gap: 12px;
  padding-top: 16px;
  border-top: 1px solid #e9ecef;
}

.selection-actions .btn {
  padding: 10px 20px;
  font-size: 14px;
}

.selection-actions .btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* æŒ‰é’®çŠ¶æ€æ ·å¼ */
.btn-enabled {
  opacity: 1 !important;
  transform: scale(1);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
  cursor: pointer !important;
}

.btn-disabled {
  opacity: 0.6 !important;
  transform: scale(0.98);
  cursor: not-allowed !important;
  box-shadow: none;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: scale(0.98);
}

.question-custom {
  padding: 12px 16px;
  border-top: 1px solid #e9ecef;
  background: #f8f9fa;
}

.question-custom label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-size: 13px;
  font-weight: 500;
}

.custom-question-input {
  width: 100%;
  min-height: 60px;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 15px;
  font-weight: 500;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: #2c3e50;
  resize: vertical;
  margin-bottom: 8px;
}

.use-custom-btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.use-custom-btn:hover {
  background: #45a049;
}

/* é—®é¢˜é¡¹ç›¸å¯¹å®šä½ */
.question-item {
  position: relative;
}

/* ç¼–è¾‘å›¾æ ‡æ ·å¼ */
.edit-icon {
  color: #4CAF50;
  font-size: 14px;
  margin-left: 8px;
}

.question-display:hover .edit-icon {
  color: #45a049;
}

/* é—®é¢˜é€‰æ‹©å™¨æ ·å¼ï¼ˆç”¨äºç¼–è¾‘é—®é¢˜ï¼‰ */
.question-selector-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
  border-radius: 6px 6px 0 0;
}

.question-selector-header h4 {
  margin: 0;
  color: #333;
  font-size: 14px;
}

.close-selector-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: #666;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-selector-btn:hover {
  color: #333;
}

.question-options {
  padding: 8px 0;
}

.question-option {
  display: flex;
  align-items: flex-start;
  padding: 8px 16px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.question-option:hover {
  background-color: #f0f8ff;
}

.option-number {
  color: #4CAF50;
  font-weight: bold;
  margin-right: 8px;
  min-width: 20px;
}

.option-text {
  color: #333;
  font-size: 13px;
  line-height: 1.4;
}

.question-custom {
  padding: 12px 16px;
  border-top: 1px solid #e9ecef;
  background: #f8f9fa;
}

.question-custom label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-size: 13px;
  font-weight: 500;
}

.custom-question-input {
  width: 100%;
  min-height: 60px;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
  resize: vertical;
  margin-bottom: 8px;
}

.use-custom-btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.use-custom-btn:hover {
  background: #45a049;
}

/* AIé¢„è§ˆä¸­çš„é—®é¢˜é€‰æ‹©æ ·å¼ */
#aiContentPreview .question-selection-item {
  display: flex;
  align-items: center;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

#aiContentPreview .question-selection-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
  transition: left 0.5s ease;
}

#aiContentPreview .question-selection-item:hover::before {
  left: 100%;
}

#aiContentPreview .question-selection-item:hover {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(76, 175, 80, 0.15);
}

#aiContentPreview .question-selection-item.selected {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  box-shadow: 0 4px 20px rgba(76, 175, 80, 0.25);
  transform: translateY(-1px);
}

#aiContentPreview .question-selection-item.selected::after {
  content: 'âœ“';
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  animation: checkmarkAppear 0.3s ease;
}

@keyframes checkmarkAppear {
  from {
    opacity: 0;
    transform: scale(0);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

#aiContentPreview .question-checkbox {
  margin-right: 16px;
  position: relative;
}

#aiContentPreview .question-select-checkbox {
  width: 20px;
  height: 20px;
  accent-color: #4CAF50;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background: white;
  border: 2px solid #ddd;
  border-radius: 4px;
  transition: all 0.3s ease;
  position: relative;
}

#aiContentPreview .question-select-checkbox:checked {
  border-color: #4CAF50;
  background-color: #4CAF50;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='white' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 9 4 4L15 3'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: center;
  background-size: 12px;
}

#aiContentPreview .question-select-checkbox:checked + label {
  color: #4CAF50;
}

#aiContentPreview .question-select-checkbox:checked ~ .question-content .question-number {
  color: #45a049;
  font-weight: bold;
}

#aiContentPreview .question-select-checkbox:checked ~ .question-content .question-text {
  color: #2e7d32;
  font-weight: 600;
}

#aiContentPreview .question-content {
  flex: 1;
  display: flex;
  align-items: center;
}

#aiContentPreview .question-number {
  color: #4CAF50;
  font-weight: 600;
  margin-right: 12px;
  min-width: 24px;
  font-size: 15px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#aiContentPreview .question-text {
  color: #2c3e50;
  font-size: 15px;
  line-height: 1.6;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-weight: 400;
  letter-spacing: 0.2px;
}

/* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
.statistics-section {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin: 20px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border: 1px solid #e9ecef;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #e9ecef;
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
  transition: left 0.5s ease;
}

.stat-card:hover::before {
  left: 100%;
}

.stat-card:hover {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
}

.stat-card.clicked {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.25);
  transform: translateY(-2px);
}

.stat-icon {
  font-size: 32px;
  margin-bottom: 12px;
  display: block;
}

.stat-number {
  font-size: 28px;
  font-weight: 700;
  color: #2c3e50;
  margin-bottom: 8px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-label {
  font-size: 14px;
  color: #666;
  font-weight: 500;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* è¯¦ç»†æ•°æ®å¼¹çª—æ ·å¼ */
.stat-detail-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
}

.stat-detail-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  position: relative;
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.stat-detail-header {
  display: flex;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid #f0f0f0;
}

.stat-detail-icon {
  font-size: 40px;
  margin-right: 16px;
}

.stat-detail-title {
  font-size: 24px;
  font-weight: 700;
  color: #2c3e50;
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: none;
  border: none;
  font-size: 24px;
  color: #666;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.stat-detail-close:hover {
  background: #f0f0f0;
  color: #333;
}

.stat-detail-summary {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  text-align: center;
}

.stat-detail-summary-number {
  font-size: 36px;
  font-weight: 700;
  color: #4CAF50;
  margin-bottom: 8px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-summary-label {
  font-size: 16px;
  color: #666;
  font-weight: 500;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-list {
  max-height: 300px;
  overflow-y: auto;
}

.stat-detail-item {
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.stat-detail-item:hover {
  border-color: #4CAF50;
  background: #f8fff8;
  transform: translateX(4px);
}

.stat-detail-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.stat-detail-item-date {
  font-size: 14px;
  color: #4CAF50;
  font-weight: 600;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-item-mood {
  font-size: 20px;
}

.stat-detail-item-title {
  font-size: 16px;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 8px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-item-content {
  font-size: 14px;
  color: #666;
  line-height: 1.5;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.stat-detail-empty {
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.stat-detail-empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.stat-detail-empty-text {
  font-size: 16px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* å¿ƒæƒ…é€‰æ‹©å™¨æ ·å¼ */
.mood-selector {
  margin: 30px 0;
}

.mood-options {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  max-width: 600px;
  margin: 0 auto;
}

.mood-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px 15px;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #e9ecef;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  pointer-events: auto;
  user-select: none;
}

.mood-option::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
  transition: left 0.5s ease;
}

.mood-option:hover::before {
  left: 100%;
}

.mood-option:hover {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
}

.mood-option.selected {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.25);
  transform: translateY(-2px);
}

.mood-option.selected::after {
  content: 'âœ“';
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  animation: checkmarkAppear 0.3s ease;
}

.mood-option i {
  font-size: 32px;
  margin-bottom: 8px;
  color: #6c757d;
  transition: all 0.3s ease;
}

.mood-option:hover i {
  color: #4CAF50;
  transform: scale(1.1);
}

.mood-option.selected i {
  color: #4CAF50;
  transform: scale(1.1);
}

.mood-option span {
  font-size: 14px;
  font-weight: 600;
  color: #2c3e50;
  text-align: center;
  transition: color 0.3s ease;
}

.mood-option:hover span {
  color: #4CAF50;
}

.mood-option.selected span {
  color: #4CAF50;
}

@media (max-width: 768px) {
  .stat-detail-content {
    font-size: 1rem;
    order: -1;
    width: 100%;
    margin-bottom: 10px;
  }
  
  .mood-options {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  
  .mood-option {
    padding: 15px 10px;
  }
  
  .mood-option i {
    font-size: 24px;
  }
  
  .mood-option span {
    font-size: 12px;
  }
}
</style>
{% endblock %}

{% block content %}
  <!-- èƒŒæ™¯éŸ³ä¹æ§åˆ¶ -->
  <div class="background-music-control" id="backgroundMusicControl" style="display: none;">
    <button class="bg-music-btn" id="bgMusicToggle" title="èƒŒæ™¯éŸ³ä¹æ§åˆ¶">
      <i class="fas fa-music"></i>
    </button>
    <div class="bg-music-info" id="bgMusicInfo">
      <span id="bgMusicTitle">èƒŒæ™¯éŸ³ä¹</span>
    </div>
  </div>

  <!-- ç»Ÿè®¡è¯¦ç»†æ•°æ®å¼¹çª— -->
  <div class="stat-detail-modal" id="statDetailModal">
    <div class="stat-detail-content">
      <button class="stat-detail-close" onclick="closeStatDetail()">
        <i class="fas fa-times"></i>
      </button>
      <div class="stat-detail-header">
        <div class="stat-detail-icon" id="statDetailIcon">ğŸ“Š</div>
        <h3 class="stat-detail-title" id="statDetailTitle">è¯¦ç»†æ•°æ®</h3>
      </div>
      <div class="stat-detail-summary">
        <div class="stat-detail-summary-number" id="statDetailSummaryNumber">0</div>
        <div class="stat-detail-summary-label" id="statDetailSummaryLabel">æ€»è®¡</div>
      </div>
      <div class="stat-detail-list" id="statDetailList">
        <!-- è¯¦ç»†æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>



  <div class="progressive-diary-container">
    <div class="progressive-main">
      <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
      <div class="progress-indicator">
      <div class="progress-steps">
        <div class="progress-step active" data-step="1">
          <div class="progress-circle">
            <i class="fas fa-heart"></i>
          </div>
          <div class="progress-label">ä»Šæ—¥å¿ƒæƒ…</div>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" data-step="2">
          <div class="progress-circle">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="progress-label">ä»Šæ—¥å®Œæˆ</div>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" data-step="3">
          <div class="progress-circle">
            <i class="fas fa-pen-fancy"></i>
          </div>
          <div class="progress-label">ç”Ÿæ´»è®°å½•</div>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" data-step="4">
          <div class="progress-circle">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="progress-label">ç”Ÿæ´»ç»Ÿè®¡</div>
        </div>
      </div>
    </div>

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="progressive-content">
      <!-- æ­¥éª¤1: é€‰æ‹©å¿ƒæƒ… -->
      <div class="step-page active" id="step1">
        <div class="step-title">
          <h2>é€‰æ‹©ä»Šæ—¥å¿ƒæƒ…</h2>
          <p>é€‰æ‹©ä»Šå¤©çš„å¿ƒæƒ…çŠ¶æ€ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬ä¸ºæ‚¨ç”Ÿæˆæ›´è´´å¿ƒçš„å†…å®¹</p>
        </div>
        
        <!-- å¿ƒæƒ…é€‰æ‹©äº‹ä»¶å¤„ç† -->
        <script>
        // å¿ƒæƒ…é€‰æ‹©äº‹ä»¶å§”æ‰˜å¤„ç†å°†åœ¨ä¸»åˆå§‹åŒ–å‡½æ•°ä¸­å¤„ç†
        </script>
        
        <!-- å¿ƒæƒ…é€‰æ‹© -->
        <div class="mood-selector">
          <div class="mood-options">
            <div class="mood-option" data-mood="happy">
              <i class="fas fa-laugh"></i>
              <span>å¼€å¿ƒ</span>
            </div>
            <div class="mood-option" data-mood="calm">
              <i class="fas fa-smile"></i>
              <span>å¹³é™</span>
            </div>
            <div class="mood-option" data-mood="excited">
              <i class="fas fa-star"></i>
              <span>å…´å¥‹</span>
            </div>
            <div class="mood-option" data-mood="sad">
              <i class="fas fa-frown"></i>
              <span>éš¾è¿‡</span>
            </div>
            <div class="mood-option" data-mood="angry">
              <i class="fas fa-angry"></i>
              <span>ç”Ÿæ°”</span>
            </div>
            <div class="mood-option" data-mood="neutral">
              <i class="fas fa-meh"></i>
              <span>ä¸€èˆ¬</span>
            </div>
          </div>
        </div>
        
        <div class="progressive-buttons">
          <div></div>
          <button class="btn btn-primary" id="nextToStep2" disabled>
            <span>ä»Šæ—¥å®Œæˆ</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- æ­¥éª¤2: ä»Šæ—¥å®Œæˆ -->
      <div class="step-page" id="step2">
        <div class="step-title">
          <h2>ä»Šæ—¥å®Œæˆ</h2>
          <p>ä»Šå¤©åšäº†ç‚¹å•¥ï¼Œæˆ‘æ¥å¸®ä½ æ€»ç»“</p>
        </div>
        
        <!-- æ˜¾ç¤ºå·²é€‰æ‹©çš„å¿ƒæƒ… -->
        <div class="selected-mood-display" id="selectedMoodDisplay" style="display: none;">
          <div class="mood-indicator">
            <span class="mood-emoji" id="selectedMoodEmoji">ğŸ˜Š</span>
            <span class="mood-text" id="selectedMoodText">å¿ƒæƒ…ä¸é”™</span>
          </div>
        </div>
        
        <!-- ä»Šæ—¥å®Œæˆé€‰æ‹© -->
        <div class="goal-selector">
          <div class="goal-icons-grid">
            <div class="goal-icon-option" data-category="health">
              <i class="fas fa-dumbbell"></i>
              <span>å¥èº«</span>
            </div>
            <div class="goal-icon-option" data-category="learning">
              <i class="fas fa-book"></i>
              <span>å­¦ä¹ </span>
            </div>
            <div class="goal-icon-option" data-category="career">
              <i class="fas fa-briefcase"></i>
              <span>å·¥ä½œ</span>
            </div>
            <div class="goal-icon-option" data-category="relationship">
              <i class="fas fa-heart"></i>
              <span>æ„Ÿæƒ…</span>
            </div>
            <div class="goal-icon-option" data-category="finance">
              <i class="fas fa-coins"></i>
              <span>ç†è´¢</span>
            </div>
            <div class="goal-icon-option" data-category="hobby">
              <i class="fas fa-palette"></i>
              <span>å…´è¶£</span>
            </div>
            <div class="goal-icon-option" data-category="spiritual">
              <i class="fas fa-pray"></i>
              <span>å†¥æƒ³</span>
            </div>
            <div class="goal-icon-option" data-category="travel">
              <i class="fas fa-plane"></i>
              <span>æ—…è¡Œ</span>
            </div>
            <div class="goal-icon-option" data-category="social">
              <i class="fas fa-users"></i>
              <span>ç¤¾äº¤</span>
            </div>
            <div class="goal-icon-option" data-category="creativity">
              <i class="fas fa-lightbulb"></i>
              <span>åˆ›æ„</span>
            </div>
            <div class="goal-icon-option" data-category="organization">
              <i class="fas fa-tasks"></i>
              <span>æ•´ç†</span>
            </div>
            <div class="goal-icon-option" data-category="gratitude">
              <i class="fas fa-hands-helping"></i>
              <span>æ„Ÿæ©</span>
            </div>
          </div>
        </div>
        
        <div class="progressive-buttons">
          <button class="btn btn-secondary" id="backToStep1">
            <i class="fas fa-arrow-left"></i>
            <span>ä¸Šä¸€æ­¥</span>
          </button>
          <button class="btn btn-primary" id="nextToStep3" disabled>
            <span>ç”ŸæˆAIå†…å®¹</span>
            <i class="fas fa-magic"></i>
          </button>
        </div>
      </div>

      <!-- æ­¥éª¤3: ç”Ÿæ´»è®°å½• -->
      <div class="step-page" id="step3">
        <div class="step-title">
          <h2>ç”Ÿæ´»è®°å½•</h2>
          <p>å†™ä¸‹å½“ä¸‹æœ€çœŸå®çš„æ„Ÿå—</p>
        </div>
        
        <div class="ai-generation-container">
          <div class="ai-loading" id="aiLoading">
            <div class="loading-spinner">
              <i class="fas fa-magic"></i>
            </div>
            <div class="loading-text">
              <h3>AIæ­£åœ¨ä¸ºæ‚¨åˆ›ä½œ...</h3>
              <p>è®°ä¸‹å½“å‰çš„å¿ƒæƒ…ï¼ŒAIæ­£åœ¨ä¸ºæ‚¨å‡†å¤‡æœ‰è¶£çš„æ€è€ƒé—®é¢˜</p>
            </div>
          </div>
          
          <div class="ai-content-preview" id="aiContentPreview" style="display: none;">
            <div class="preview-header">
              <i class="fas fa-magic"></i>
              <span>AIä¸ºæ‚¨ç”Ÿæˆçš„å†…å®¹</span>
            </div>
            <div class="preview-content" id="previewContent">
              <!-- AIç”Ÿæˆçš„å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            
            <!-- éŸ³ä¹æ¨èåŒºåŸŸ -->
            <div class="music-recommendation" id="musicRecommendation" style="display: none;">
              <div class="music-header">
                <i class="fas fa-music"></i>
                <h4>ğŸµ éŸ³ä¹æ¨è</h4>
              </div>
              <div class="music-recommendation-content" id="musicRecommendationContent">
                <!-- éŸ³ä¹æ¨èå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
              </div>
              <!-- ç½‘æ˜“äº‘éŸ³ä¹æœç´¢åŒºåŸŸ -->
              <div class="music-search-section">
                <h4>ğŸ” æœç´¢ç½‘æ˜“äº‘éŸ³ä¹</h4>
                <div class="search-box">
                  <input 
                    type="text" 
                    id="musicSearchInput" 
                    class="form-control" 
                    placeholder="è¾“å…¥æ­Œæ›²åæˆ–æ­Œæ‰‹..."
                  >
                  <button id="searchMusicBtn" class="btn" onclick="searchNeteaseMusic()">
                    <i class="fas fa-search"></i> æœç´¢
                  </button>
                </div>
                <div id="searchResults" class="search-results" style="display: none;">
                  <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
              </div>
            </div>
            
            <div class="preview-actions">
              <button class="btn btn-secondary" id="regenerateContent">
                <i class="fas fa-sync-alt"></i>
                <span>é‡æ–°ç”Ÿæˆ</span>
              </button>
              <button class="btn btn-primary" id="useGeneratedContent">
                <i class="fas fa-check"></i>
                <span>ä½¿ç”¨æ­¤å†…å®¹</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- æ—¥è®°ç¼–è¾‘è¡¨å• -->
        <div class="diary-form-container" id="diaryFormContainer" style="display: none;">
          
          <div class="form-group">
            <label for="diaryTitle">æ—¥è®°æ ‡é¢˜</label>
            <input type="text" id="diaryTitle" class="form-control" placeholder="ä¸ºä»Šå¤©çš„ç”Ÿæ´»è®°å½•èµ·ä¸ªæ ‡é¢˜...">
          </div>
          
          <div class="form-group">
            <label>ç”Ÿæ´»è®°å½•å†…å®¹</label>
            <div class="questions-container" id="questionsContainer">
              <!-- 10ä¸ªé—®é¢˜è¾“å…¥æ¡†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          

        </div>
        
        <div class="progressive-buttons">
          <button class="btn btn-secondary" id="backToStep2">
            <i class="fas fa-arrow-left"></i>
            <span>ä¸Šä¸€æ­¥</span>
          </button>
          <button class="btn btn-primary" id="completeDiary" disabled style="display: none;">
            <i class="fas fa-check"></i>
            <span>ä¿å­˜è®°å½•</span>
          </button>
        </div>
      </div>

      <!-- æ­¥éª¤4: ç”Ÿæ´»ç»Ÿè®¡ -->
      <div class="step-page" id="step4">
        <div class="step-title">
          <h2>ç”Ÿæ´»ç»Ÿè®¡</h2>
          <p>æŸ¥çœ‹æ‚¨çš„ç”Ÿæ´»è®°å½•ç»Ÿè®¡å’Œæˆå°±</p>
        </div>
        
        <!-- ç”Ÿæ´»ç»Ÿè®¡ -->
        <div class="statistics-section" id="statisticsSection" style="display: none;">
            <h3>ğŸ“Š ç”Ÿæ´»ç»Ÿè®¡</h3>
            <div class="stats-grid">
                <div class="stat-card" id="totalDiaryDaysCard">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalDiaryDays">0</div>
                        <div class="stat-label">æ—¥è®°å¤©æ•°</div>
                    </div>
                </div>
                <div class="stat-card" id="totalDiaryCountCard">
                    <div class="stat-icon">ğŸ“</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalDiaryCount">0</div>
                        <div class="stat-label">æ—¥è®°æ¬¡æ•°</div>
                    </div>
                </div>
                <div class="stat-card" id="happyDaysCard">
                    <div class="stat-icon">ğŸ˜Š</div>
                    <div class="stat-content">
                        <div class="stat-number" id="happyDays">0</div>
                        <div class="stat-label">å¼€å¿ƒå¤©æ•°</div>
                    </div>
                </div>
                <div class="stat-card" id="totalWordsCard">
                    <div class="stat-icon">ğŸ“–</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalWords">0</div>
                        <div class="stat-label">æ€»å­—æ•°</div>
                    </div>
                </div>
            </div>
            
            <!-- å¿ƒæƒ…è¶‹åŠ¿å›¾ -->
            <div class="mood-trend-section">
                <h4>ğŸ“ˆ å¿ƒæƒ…è¶‹åŠ¿</h4>
                <div class="mood-chart-container">
                    <canvas id="moodChart"></canvas>
                </div>
                <div class="mood-stats-summary" id="moodStatsSummary">
                    <!-- å¿ƒæƒ…ç»Ÿè®¡æ‘˜è¦å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- æ‰“å¡æ—¥å† -->
            <div class="checkin-calendar-section">
                <h4>ğŸ“… æ—¥è®°æ‰“å¡</h4>
                <div class="checkin-calendar-container">
                    <!-- æ—¥å†å¯¼èˆª -->
                    <div class="calendar-nav">
                        <button class="nav-btn" id="diaryPrevMonth"><i class="fas fa-chevron-left"></i></button>
                        <div class="current-month" id="diaryCurrentMonth">2024å¹´1æœˆ</div>
                        <button class="nav-btn" id="diaryNextMonth"><i class="fas fa-chevron-right"></i></button>
                        <button class="nav-btn today-btn" id="diaryGoToday">ä»Šå¤©</button>
                    </div>
                    
                    <!-- è¿ç»­æ‰“å¡ä¿¡æ¯ -->
                    <div class="streak-info">
                        <div class="streak-item">
                            <i class="fas fa-fire"></i>
                            <span>è¿ç»­ <span id="diaryCurrentStreak">0</span> å¤©</span>
                        </div>
                        <div class="streak-item">
                            <i class="fas fa-trophy"></i>
                            <span>æœ€é•¿ <span id="diaryLongestStreak">0</span> å¤©</span>
                        </div>
                    </div>
                    
                    <!-- æ—¥å†ç½‘æ ¼ -->
                    <div class="calendar-grid">
                        <div class="calendar-header">
                            <div>æ—¥</div>
                            <div>ä¸€</div>
                            <div>äºŒ</div>
                            <div>ä¸‰</div>
                            <div>å››</div>
                            <div>äº”</div>
                            <div>å…­</div>
                        </div>
                        <div class="calendar-body" id="diaryCalendarBody">
                            <!-- æ—¥å†æ—¥æœŸå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- æœˆåº¦ç»Ÿè®¡ -->
                    <div class="monthly-stats">
                        <div class="stat-item">
                            <span class="stat-label">æœ¬æœˆå®Œæˆ</span>
                            <span class="stat-value" id="diaryMonthlyCompleted">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å®Œæˆç‡</span>
                            <span class="stat-value" id="diaryMonthlyRate">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progressive-buttons">
          <button class="btn btn-secondary" id="backToStep3">
            <i class="fas fa-arrow-left"></i>
            <span>ä¸Šä¸€æ­¥</span>
          </button>
          <button class="btn btn-primary" id="finishDiary">
            <i class="fas fa-home"></i>
            <span>å®Œæˆ</span>
          </button>
        </div>
      </div>

      <!-- å®Œæˆé¡µé¢ -->
      <div class="step-page" id="completion">
        <div class="completion-page">
          <div class="completion-icon">
            <i class="fas fa-star"></i>
          </div>
          <div class="completion-title">ğŸ‰ å¤ªæ£’äº†ï¼</div>
          <div class="completion-message">
            æ‚¨çš„ç”Ÿæ´»è®°å½•å·²å®Œç¾ä¿å­˜ï¼<br>
            æ¯ä¸€å¤©çš„è®°å½•éƒ½æ˜¯æ‚¨æˆé•¿çš„è§è¯ï¼Œ<br>
            ç»§ç»­ä¿æŒè¿™ä»½ç¾å¥½ï¼Œæ‚¨çš„äººç”Ÿå°†æ›´åŠ ç²¾å½©ï¼
          </div>
          
          <div class="completion-stats">
            <div class="completion-stat-item">
              <i class="fas fa-heart"></i>
              <span>å¿ƒæƒ…è®°å½•</span>
            </div>
            <div class="completion-stat-item">
              <i class="fas fa-pen"></i>
              <span>ç”Ÿæ´»æ„Ÿæ‚Ÿ</span>
            </div>
            <div class="completion-stat-item">
              <i class="fas fa-bullseye"></i>
              <span>ç›®æ ‡è®¾å®š</span>
            </div>
          </div>
          
          <div class="completion-quote">
            "ç”Ÿæ´»ä¸æ˜¯ç­‰å¾…æš´é£é›¨è¿‡å»ï¼Œè€Œæ˜¯å­¦ä¼šåœ¨é›¨ä¸­è·³èˆã€‚"
          </div>
          

          
          <div class="progressive-buttons">
            <button class="btn btn-primary" id="startNewDiary">
              <i class="fas fa-plus"></i>
              <span>ç»§ç»­è®°å½•ç¾å¥½</span>
            </button>

          </div>
        </div>
              </div>
      </div>
    </div>
  </div>

  <!-- æ—¥è®°è¯¦æƒ…å¼¹çª— -->
  <div class="diary-modal" id="diaryModal">
    <div class="diary-modal-content">
      <div class="diary-modal-header">
        <button class="diary-modal-close" id="closeDiaryModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="diary-modal-body" id="diaryModalBody">
        <!-- å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
      </div>
    </div>
  </div>

  <style>
.song-play-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.song-play-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.no-results {
  padding: 20px;
  text-align: center;
  color: #666;
  font-style: italic;
}

.song-item {
  display: flex;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #eee;
  transition: background-color 0.2s ease;
}

.song-item:hover {
  background-color: #f8f9fa;
}

.song-info {
  flex: 1;
  margin-left: 10px;
}

.song-title {
  font-weight: 500;
  color: #333;
  margin-bottom: 2px;
}

.song-artist {
  font-size: 12px;
  color: #666;
}

.song-duration {
  font-size: 11px;
  color: #999;
}

.checkin-calendar-section {
  margin-top: 30px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 15px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.checkin-calendar-section h4 {
  color: #2c3e50;
  margin-bottom: 20px;
  font-weight: 600;
}

.checkin-calendar-container {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.calendar-card {
  flex: 1;
  min-width: 300px;
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.calendar-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #2c3e50;
}

.calendar-controls {
  display: flex;
  gap: 10px;
}

.calendar-btn {
  background: none;
  border: none;
  color: #667eea;
  cursor: pointer;
  padding: 5px 10px;
  border-radius: 6px;
  transition: all 0.3s ease;
}

.calendar-btn:hover {
  background: rgba(102, 126, 234, 0.1);
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.3s ease;
  position: relative;
}

.calendar-day:hover {
  background: rgba(102, 126, 234, 0.1);
}

.calendar-day.other-month {
  color: #ccc;
}

.calendar-day.today {
  background: #667eea;
  color: white;
  font-weight: 600;
}

.calendar-day.has-checkin {
  background: rgba(76, 175, 80, 0.2);
  color: #4CAF50;
  font-weight: 500;
}

.calendar-day.has-checkin.completed {
  background: #4CAF50;
  color: white;
}

.calendar-day.has-checkin.rest {
  background: #FF9800;
  color: white;
}

.calendar-stats {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}

.stats-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.stats-label {
  color: #666;
  font-size: 0.9rem;
}

.stats-value {
  font-weight: 600;
  color: #2c3e50;
}

.streak-info {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px;
  border-radius: 10px;
  margin-top: 15px;
}

.streak-title {
  font-size: 0.9rem;
  margin-bottom: 5px;
  opacity: 0.9;
}

.streak-value {
  font-size: 1.5rem;
  font-weight: 700;
}

.streak-subtitle {
  font-size: 0.8rem;
  opacity: 0.8;
  margin-top: 5px;
}

/* å¿ƒæƒ…æ˜¾ç¤ºæ ·å¼ */
.selected-mood-display {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px 20px;
  border-radius: 12px;
  margin: 20px 0;
  text-align: center;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
  animation: slideInDown 0.5s ease-out;
}

.mood-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.mood-emoji {
  font-size: 1.5rem;
  animation: bounce 0.6s ease-out;
}

.mood-text {
  font-size: 1.1rem;
  font-weight: 500;
}

@keyframes slideInDown {
  from {
    transform: translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-10px);
  }
  60% {
    transform: translateY(-5px);
  }
}
  </style>

  <script type="module">
// å…¨å±€å˜é‡
let currentStep = 1;
let selectedMood = null;
let selectedGoalCategories = [];
let diaryData = {
  title: '',
  content: '',
  mood: '',
  goal_category: ''
};

// åˆå§‹åŒ–é¡µé¢
document.addEventListener('DOMContentLoaded', async function() {
  try {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    
    // åˆå§‹åŒ–å„ä¸ªç»„ä»¶
    initMoodSelector();
    initGoalSelector();
    initNavigation();
    
    // åˆå§‹åŒ–ç»Ÿè®¡åŠŸèƒ½
    addStatCardListeners();
    initStatDetailModal();
    initDiaryCheckInCalendar();
    
    console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
  } catch (error) {
    console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
  }
});

// å¿ƒæƒ…é€‰æ‹©å™¨åˆå§‹åŒ–
function initMoodSelector() {
  const moodOptions = document.querySelectorAll('.mood-option');
  
  moodOptions.forEach(option => {
    option.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const mood = this.dataset.mood;
      console.log('å¿ƒæƒ…é€‰æ‹©ç‚¹å‡»:', mood);
      
      // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
      moodOptions.forEach(opt => opt.classList.remove('selected'));
      
      // æ·»åŠ å½“å‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
      this.classList.add('selected');
      
      // æ›´æ–°å…¨å±€å˜é‡
      selectedMood = mood;
      diaryData.mood = mood;
      
      // æ£€æŸ¥æ­¥éª¤1å®ŒæˆçŠ¶æ€
      checkStep1Completion();
      
      // æ˜¾ç¤ºåé¦ˆ
      showMoodFeedback(mood);
    });
  });
}

// ç›®æ ‡é€‰æ‹©å™¨åˆå§‹åŒ–
function initGoalSelector() {
  const goalOptions = document.querySelectorAll('.goal-icon-option');
  const nextButton = document.getElementById('nextToStep3');
  
  goalOptions.forEach(option => {
    option.addEventListener('click', function() {
      const category = this.dataset.category;
      
      // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
      if (this.classList.contains('selected')) {
        this.classList.remove('selected');
        selectedGoalCategories = selectedGoalCategories.filter(cat => cat !== category);
      } else {
        this.classList.add('selected');
        selectedGoalCategories.push(category);
      }
      
      diaryData.goal_categories = selectedGoalCategories;
      
      // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ç›®æ ‡
      checkStep2Completion();
    });
  });
}

// å¯¼èˆªåˆå§‹åŒ–
function initNavigation() {
  const nextToStep2 = document.getElementById('nextToStep2');
  const nextToStep3 = document.getElementById('nextToStep3');
  const backToStep1 = document.getElementById('backToStep1');
  const backToStep2 = document.getElementById('backToStep2');
  const completeDiaryBtn = document.getElementById('completeDiary');
  const startNewDiaryBtn = document.getElementById('startNewDiary');
  const finishDiaryBtn = document.getElementById('finishDiary');
  
  if (nextToStep2) nextToStep2.addEventListener('click', () => goToStep(2));
  if (nextToStep3) nextToStep3.addEventListener('click', () => goToStep(3));
  if (backToStep1) backToStep1.addEventListener('click', () => goToStep(1));
  if (backToStep2) backToStep2.addEventListener('click', () => goToStep(2));
  if (completeDiaryBtn) completeDiaryBtn.addEventListener('click', completeDiary);
  if (startNewDiaryBtn) startNewDiaryBtn.addEventListener('click', resetDiary);
  if (finishDiaryBtn) finishDiaryBtn.addEventListener('click', finishDiary);
}

// æ£€æŸ¥æ­¥éª¤1å®ŒæˆçŠ¶æ€
function checkStep1Completion() {
  const nextButton = document.getElementById('nextToStep2');
  if (nextButton) {
    nextButton.disabled = !selectedMood;
  }
}

// æ£€æŸ¥æ­¥éª¤2å®ŒæˆçŠ¶æ€
function checkStep2Completion() {
  const nextButton = document.getElementById('nextToStep3');
  if (nextButton) {
    nextButton.disabled = selectedGoalCategories.length === 0;
  }
}

// æ­¥éª¤å¯¼èˆª
function goToStep(step) {
  if (step < 1 || step > 5) return;
  
  currentStep = step;
  
  document.querySelectorAll('.step-page').forEach(page => {
    page.classList.remove('active');
  });
  
  if (step === 5) {
    document.getElementById('completion').classList.add('active');
  } else {
    document.getElementById(`step${step}`).classList.add('active');
  }
  
  updateProgressIndicator(step);
  
  // å½“è¿›å…¥æ­¥éª¤2æ—¶ï¼Œæ›´æ–°å¿ƒæƒ…æ˜¾ç¤º
  if (step === 2) {
    updateMoodDisplay();
  }
  
  if (step === 3) {
    generateAIContent();
  }
  
  if (step === 4) {
    loadStatistics();
  }
}

// æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
function updateProgressIndicator(step) {
  const steps = document.querySelectorAll('.progress-step');
  
  steps.forEach((stepElement, index) => {
    const stepNumber = index + 1;
    stepElement.classList.remove('active', 'completed');
    
    if (stepNumber < step) {
      stepElement.classList.add('completed');
    } else if (stepNumber === step) {
      stepElement.classList.add('active');
    }
  });
}

// æ˜¾ç¤ºå¿ƒæƒ…åé¦ˆ
function showMoodFeedback(mood) {
  const moodTexts = {
    'happy': 'ğŸ˜Š å¤ªæ£’äº†ï¼ä»Šå¤©å¿ƒæƒ…ä¸é”™ï¼Œç»§ç»­ä¿æŒè¿™ä»½å¿«ä¹ï¼',
    'calm': 'ğŸ˜Œ å†…å¿ƒå¹³é™æ˜¯æœ€å¤§çš„æ™ºæ…§ï¼Œæ‚¨åšå¾—å¾ˆå¥½ï¼',
    'excited': 'â­ å……æ»¡æœŸå¾…çš„ä¸€å¤©ï¼æ‚¨çš„çƒ­æƒ…æ„ŸæŸ“ç€å‘¨å›´çš„äººï¼',
    'sad': 'ğŸ˜¢ æ²¡å…³ç³»ï¼Œæ¯ä¸ªé›¨å¤©éƒ½ä¼šè¿‡å»ï¼Œé˜³å…‰æ€»åœ¨é£é›¨åï¼',
    'angry': 'ğŸ˜  æ·±å‘¼å¸ï¼Œä¿æŒå†·é™ï¼Œæ‚¨æ¯”ä»»ä½•å›°éš¾éƒ½å¼ºå¤§ï¼',
    'neutral': 'ğŸ˜ å¹³æ·¡ä¹Ÿæ˜¯ä¸€ç§ç¾å¥½ï¼Œäº«å—è¿™ä»½å®é™å§ï¼'
  };
  
  showNotification(moodTexts[mood] || moodTexts.neutral, 'success');
}

// ç”ŸæˆAIå†…å®¹
async function generateAIContent() {
  if (selectedGoalCategories.length === 0) {
    showNotification('è¯·å…ˆé€‰æ‹©ä»Šæ—¥å®Œæˆçš„å†…å®¹ï¼', 'error');
    return;
  }
  
  const loadingDiv = document.getElementById('aiLoading');
  const previewDiv = document.getElementById('aiContentPreview');
  
  loadingDiv.style.display = 'block';
  previewDiv.style.display = 'none';
  
  try {
    // ä½¿ç”¨å¤‡ç”¨å†…å®¹
    const fallbackContent = generateFallbackContent(selectedMood, selectedGoalCategories);
    const formattedContent = formatContentForDisplay(fallbackContent);
    document.getElementById('previewContent').innerHTML = formattedContent;
    
    loadingDiv.style.display = 'none';
    previewDiv.style.display = 'block';
    
    showNotification('AIå†…å®¹ç”ŸæˆæˆåŠŸï¼', 'success');
  } catch (error) {
    console.error('ç”ŸæˆAIå†…å®¹å¤±è´¥:', error);
    showNotification('AIç”Ÿæˆå†…å®¹æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²ä¸ºä½ ç”Ÿæˆæ¸©æš–çš„å¤‡ç”¨å†…å®¹ï¼', 'warning');
    
    loadingDiv.style.display = 'none';
    previewDiv.style.display = 'block';
  }
}

// ç”Ÿæˆå¤‡ç”¨å†…å®¹
function generateFallbackContent(mood, goalCategories) {
  const moodTexts = {
    'happy': 'å¼€å¿ƒ',
    'calm': 'å¹³é™',
    'excited': 'å…´å¥‹',
    'sad': 'éš¾è¿‡',
    'angry': 'ç”Ÿæ°”',
    'neutral': 'ä¸€èˆ¬'
  };
  
  const goalTexts = {
    'health': 'å¥èº«',
    'learning': 'å­¦ä¹ ',
    'career': 'å·¥ä½œ',
    'relationship': 'æ„Ÿæƒ…',
    'finance': 'ç†è´¢',
    'hobby': 'å…´è¶£',
    'spiritual': 'å†¥æƒ³',
    'travel': 'æ—…è¡Œ',
    'social': 'ç¤¾äº¤',
    'creativity': 'åˆ›æ„',
    'organization': 'æ•´ç†',
    'gratitude': 'æ„Ÿæ©'
  };
  
  const selectedGoals = goalCategories.map(cat => goalTexts[cat]).join('ã€');
  const moodText = moodTexts[mood] || 'ä¸€èˆ¬';
  
  const questions = [
    `ä»Šå¤©å®Œæˆäº†${selectedGoals}ï¼Œæœ€è®©ä½ ç¬‘å‡ºå£°çš„ç¬é—´æ˜¯ä»€ä¹ˆï¼Ÿ`,
    `å¦‚æœä»Šå¤©æ˜¯ä¸€éƒ¨ç”µå½±ï¼Œä½ ä¼šç»™å®ƒèµ·ä»€ä¹ˆåå­—ï¼Ÿ`,
    `ä»Šå¤©é‡åˆ°çš„äººä¸­ï¼Œè°è®©ä½ å°è±¡æœ€æ·±åˆ»ï¼Ÿ`,
    `å¦‚æœå¯ä»¥å’Œä»Šå¤©çš„è‡ªå·±å¯¹è¯ï¼Œä½ ä¼šè¯´ä»€ä¹ˆï¼Ÿ`,
    `ä»Šå¤©æœ‰ä»€ä¹ˆäº‹æƒ…è®©ä½ æ„Ÿåˆ°æ„å¤–æƒŠå–œï¼Ÿ`,
    `å¦‚æœä»Šå¤©å¯ä»¥é‡æ¥ä¸€æ¬¡ï¼Œä½ ä¼šæ”¹å˜ä»€ä¹ˆï¼Ÿ`,
    `ä»Šå¤©æœ€æƒ³å’Œè°åˆ†äº«ä½ çš„${moodText}å¿ƒæƒ…ï¼Ÿ`,
    `ä»Šå¤©å­¦åˆ°äº†ä»€ä¹ˆæ–°ä¸œè¥¿ï¼Ÿ`,
    `æ˜å¤©æœ€æœŸå¾…çš„äº‹æƒ…æ˜¯ä»€ä¹ˆï¼Ÿ`,
    `ä»Šå¤©æœ‰ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°ç‰¹åˆ«æ„Ÿæ©çš„ï¼Ÿ`
  ];
  
  let content = 'ã€10ä¸ªç–‘é—®å¥ã€‘\n';
  questions.forEach((question, index) => {
    content += `${index + 1}. ${question}\n\n`;
  });
  content += 'ã€æ¨èéŸ³ä¹ã€‘\n';
  content += 'æ™´å¤© - å‘¨æ°ä¼¦';
  
  return content;
}

// æ ¼å¼åŒ–å†…å®¹ç”¨äºæ˜¾ç¤º
function formatContentForDisplay(content) {
  let formatted = content.trim();
  
  formatted = formatted.replace(/ã€10ä¸ªç–‘é—®å¥ã€‘/, '<h3><span style="color: #ff8c00;">&#128161;</span> é€‰æ‹©æ‚¨æƒ³å›ç­”çš„é—®é¢˜</h3>');
  formatted = formatted.replace(/ã€æ¨èéŸ³ä¹ã€‘/, '<h3><span style="color: #ff8c00;">&#127925;</span> éŸ³ä¹æ¨è</h3>');
  
  formatted = formatted.replace(/(\d+)\.\s*(.*?)(?=\n\n|\nã€|\Z)/gs, (match, number, text) => {
    const questionText = text.trim();
    return `
      <div class="question-selection-item" data-question="${questionText}" data-index="${parseInt(number) - 1}">
        <div class="question-checkbox">
          <input type="checkbox" id="question${parseInt(number) - 1}" class="question-select-checkbox">
          <label for="question${parseInt(number) - 1}"></label>
        </div>
        <div class="question-content">
          <span class="question-number">${number}.</span>
          <span class="question-text">${questionText}</span>
        </div>
      </div>
    `;
  });
  
  formatted = formatted.replace(/\n\n+/g, '<br><br>');
  formatted = formatted.replace(/\n/g, '<br>');
  
  return formatted;
}

// å®Œæˆæ—¥è®°
async function completeDiary() {
  const diaryTitle = document.getElementById('diaryTitle');
  const title = diaryTitle ? diaryTitle.value.trim() : '';
  
  if (!title) {
    showNotification('è¯·è‡³å°‘å¡«å†™æ ‡é¢˜ï¼', 'error');
    return;
  }
  
  diaryData.title = title;
  diaryData.content = 'ä»Šå¤©çš„å¿ƒæƒ…å’Œæ„Ÿæ‚Ÿ';
  
  showNotification('ğŸ‰ ç”Ÿæ´»è®°å½•ä¿å­˜æˆåŠŸï¼', 'success');
  goToStep(4);
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStatistics() {
  const statisticsSection = document.getElementById('statisticsSection');
  if (statisticsSection) {
    statisticsSection.style.display = 'block';
  }
  
  // æ›´æ–°ç»Ÿè®¡æ•°å­—
  const totalDiaryDaysElement = document.getElementById('totalDiaryDays');
  const totalDiaryCountElement = document.getElementById('totalDiaryCount');
  const happyDaysElement = document.getElementById('happyDays');
  const totalWordsElement = document.getElementById('totalWords');
  
  if (totalDiaryDaysElement) totalDiaryDaysElement.textContent = '1';
  if (totalDiaryCountElement) totalDiaryCountElement.textContent = '1';
  if (happyDaysElement) happyDaysElement.textContent = '1';
  if (totalWordsElement) totalWordsElement.textContent = '100';
}

// å®Œæˆæ—¥è®°æµç¨‹
function finishDiary() {
  goToStep(5);
}

// é‡ç½®æ—¥è®°
function resetDiary() {
  selectedMood = null;
  selectedGoalCategories = [];
  diaryData = {
    title: '',
    content: '',
    mood: '',
    goal_category: ''
  };
  
  document.querySelectorAll('.mood-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  document.querySelectorAll('.goal-icon-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  goToStep(1);
  showNotification('å·²é‡ç½®ï¼Œå¼€å§‹æ–°çš„è®°å½•å§ï¼', 'success');
}

// æ·»åŠ ç»Ÿè®¡å¡ç‰‡ç‚¹å‡»ç›‘å¬å™¨
function addStatCardListeners() {
  const statCards = document.querySelectorAll('.stat-card');
  statCards.forEach(card => {
    card.addEventListener('click', function() {
      showNotification('ç»Ÿè®¡è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    });
  });
}

// åˆå§‹åŒ–ç»Ÿè®¡è¯¦æƒ…å¼¹çª—
function initStatDetailModal() {
  // ç»Ÿè®¡è¯¦æƒ…å¼¹çª—åˆå§‹åŒ–
}

// åˆå§‹åŒ–æ—¥è®°æ‰“å¡æ—¥å†
function initDiaryCheckInCalendar() {
  // æ—¥è®°æ‰“å¡æ—¥å†åˆå§‹åŒ–
}

// è·å–CSRF Token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  
  Object.assign(notification.style, {
    position: 'fixed',
    top: '20px',
    right: '20px',
    padding: '12px 20px',
    borderRadius: '6px',
    color: 'white',
    fontSize: '14px',
    fontWeight: '500',
    zIndex: '10000',
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
    minWidth: '250px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
    backgroundColor: type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3',
    animation: 'slideInRight 0.3s ease-out'
  });
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// æ·»åŠ åŠ¨ç”»æ ·å¼
const slideInRight = document.createElement('style');
slideInRight.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(slideInRight);













// æ˜¾ç¤ºç›®æ ‡é€‰æ‹©åé¦ˆ
function showGoalFeedback(categories) {
  const goalTexts = {
    'health': 'å¥èº«',
    'learning': 'å­¦ä¹ ',
    'career': 'å·¥ä½œ',
    'relationship': 'æ„Ÿæƒ…',
    'finance': 'ç†è´¢',
    'hobby': 'å…´è¶£',
    'spiritual': 'å†¥æƒ³',
    'travel': 'æ—…è¡Œ',
    'social': 'ç¤¾äº¤',
    'creativity': 'åˆ›æ„',
    'organization': 'æ•´ç†',
    'gratitude': 'æ„Ÿæ©'
  };
  
  const selectedGoals = categories.map(cat => goalTexts[cat]).join('ã€');
  const message = `ğŸ¯ ä»Šå¤©å®Œæˆäº†ï¼š${selectedGoals}ï¼æ‚¨çœŸæ˜¯å¤šæ‰å¤šè‰ºï¼Œç”Ÿæ´»ä¸°å¯Œå¤šå½©ï¼`;
  
  showNotification(message, 'success');
}

// éšè—ç›®æ ‡åé¦ˆ
function hideGoalFeedback() {
  // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ éšè—åé¦ˆçš„é€»è¾‘
}







// æ›´æ–°å¿ƒæƒ…æ˜¾ç¤º
function updateMoodDisplay() {
  const moodDisplay = document.getElementById('selectedMoodDisplay');
  const moodEmoji = document.getElementById('selectedMoodEmoji');
  const moodText = document.getElementById('selectedMoodText');
  
  if (moodDisplay && moodEmoji && moodText && selectedMood) {
    const moodEmojis = {
      'happy': 'ğŸ˜Š',
      'calm': 'ğŸ˜Œ',
      'excited': 'â­',
      'sad': 'ğŸ˜¢',
      'angry': 'ğŸ˜ ',
      'neutral': 'ğŸ˜'
    };
    
    const moodTexts = {
      'happy': 'å¿ƒæƒ…ä¸é”™',
      'calm': 'å†…å¿ƒå¹³é™',
      'excited': 'å……æ»¡æœŸå¾…',
      'sad': 'æœ‰ç‚¹éš¾è¿‡',
      'angry': 'æœ‰äº›ç”Ÿæ°”',
      'neutral': 'ä¸€èˆ¬èˆ¬'
    };
    
    moodEmoji.textContent = moodEmojis[selectedMood] || moodEmojis.neutral;
    moodText.textContent = moodTexts[selectedMood] || moodTexts.neutral;
    moodDisplay.style.display = 'block';
    
    console.log('âœ… å¿ƒæƒ…æ˜¾ç¤ºå·²æ›´æ–°:', selectedMood);
  }
}

// éªŒè¯æ­¥éª¤3
function validateStep3() {
  const diaryTitle = document.getElementById('diaryTitle');
  const nextButton = document.getElementById('completeDiary');
  
  // å®‰å…¨åœ°è·å–æ ‡é¢˜
  const title = diaryTitle ? diaryTitle.value.trim() : '';
  
  console.log('validateStep3 è¢«è°ƒç”¨ã€‚');
  console.log('æ ‡é¢˜:', title);

  // ç¡®ä¿å¿ƒæƒ…æ•°æ®å­˜åœ¨ï¼ˆä»ç¬¬ä¸€æ­¥è·å–ï¼‰
  if (!selectedMood) {
    // å¦‚æœç¬¬ä¸€æ­¥æ²¡æœ‰é€‰æ‹©å¿ƒæƒ…ï¼Œé»˜è®¤è®¾ç½®ä¸ºä¸€èˆ¬
    selectedMood = 'neutral';
    diaryData.mood = selectedMood;
  }
  
  // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•é—®é¢˜å›ç­”å’Œè¡¥å……è¯´æ˜
  const questionAnswers = document.querySelectorAll('.question-answer');
  let totalContent = '';
  
  questionAnswers.forEach((textarea, index) => {
    if (textarea) {
      const answer = textarea.value.trim();
      const question = textarea.dataset.question;
      const additionalInput = document.getElementById(`additionalInput${index + 1}`);
      const additionalAnswer = additionalInput ? additionalInput.value.trim() : '';
      
      if (answer) {
        totalContent += `${question}\nå›ç­”: ${answer}`;
        if (additionalAnswer) {
          totalContent += `\nè¡¥å……: ${additionalAnswer}`;
        }
        totalContent += '\n\n';
      }
    }
  });
  
  // æ–°çš„éªŒè¯é€»è¾‘ï¼šåªè¦æœ‰æ ‡é¢˜å°±å¯ä»¥ä¿å­˜
  const hasAnyContent = title.length > 0;
  
  // å®‰å…¨åœ°è®¾ç½®æŒ‰é’®çŠ¶æ€
  if (nextButton) {
    nextButton.disabled = !hasAnyContent;
    console.log('æŒ‰é’®åº”è¯¥å¯ç”¨:', hasAnyContent);
    console.log('æŒ‰é’®å½“å‰ disabled çŠ¶æ€:', nextButton.disabled);
    
    // å¼ºåˆ¶ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®
    if (hasAnyContent) {
      nextButton.disabled = false;
      console.log('å¼ºåˆ¶å¯ç”¨æŒ‰é’®');
    }
  }
  
  diaryData.title = title;
  diaryData.content = totalContent;
  
  // æ·»åŠ é—®é¢˜è¾“å…¥æ¡†å’Œè¡¥å……è¾“å…¥æ¡†çš„å®æ—¶éªŒè¯ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ·»åŠ ï¼‰
  if (!questionAnswers[0] || !questionAnswers[0].hasEventListener) {
    questionAnswers.forEach((textarea, index) => {
      if (textarea && !textarea.hasEventListener) {
        textarea.addEventListener('input', validateStep3);
        textarea.hasEventListener = true;
      }
      
      // ä¸ºè¡¥å……è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      const additionalInput = document.getElementById(`additionalInput${index + 1}`);
      if (additionalInput && !additionalInput.hasEventListener) {
        additionalInput.addEventListener('input', validateStep3);
        additionalInput.hasEventListener = true;
      }
    });
  }






// æ˜¾ç¤ºæ—¥è®°è¯¦æƒ…
async function showDiaryDetails() {
  try {
    const response = await fetch('/tools/api/life_diary/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'get_diary_list'
      })
    });
    
    const data = await response.json();
    
    if (data.success && data.diaries) {
      const modalBody = document.getElementById('diaryModalBody');
      let html = '';
      
      if (data.diaries.length === 0) {
        html = `
          <div class="no-diary-message">
            <i class="fas fa-book-open"></i>
            <h3>è¿˜æ²¡æœ‰æ—¥è®°è®°å½•</h3>
            <p>å¼€å§‹è®°å½•æ‚¨çš„ç”Ÿæ´»ç‚¹æ»´å§ï¼</p>
          </div>
        `;
      } else {
        data.diaries.forEach(diary => {
          const moodEmojis = {
            'happy': 'ğŸ˜Š',
            'calm': 'ğŸ˜Œ',
            'excited': 'â­',
            'sad': 'ğŸ˜¢',
            'angry': 'ğŸ˜ ',
            'neutral': 'ğŸ˜'
          };
          
          const moodTexts = {
            'happy': 'å¼€å¿ƒ',
            'calm': 'å¹³é™',
            'excited': 'å…´å¥‹',
            'sad': 'éš¾è¿‡',
            'angry': 'ç”Ÿæ°”',
            'neutral': 'ä¸€èˆ¬'
          };
          
          const date = new Date(diary.created_at).toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
          });
          
          // å¤„ç†é—®é¢˜å›ç­”
          let questionAnswersHtml = '';
          if (diary.question_answers && diary.question_answers.length > 0) {
            questionAnswersHtml = `
              <div class="diary-questions">
                <h4><i class="fas fa-question-circle"></i> æ€è€ƒé—®é¢˜</h4>
                ${diary.question_answers.map(qa => `
                  <div class="question-item">
                    <div class="question-text">${qa.question}</div>
                    <div class="answer-text">${qa.answer}</div>
                    ${qa.additional_answer ? `<div class="additional-answer">è¡¥å……ï¼š${qa.additional_answer}</div>` : ''}
                  </div>
                `).join('')}
              </div>
            `;
          }
          
          // å¤„ç†éŸ³ä¹æ¨è
          let musicRecommendationHtml = '';
          if (diary.music_recommendation) {
            musicRecommendationHtml = `
              <div class="diary-music">
                <h4><i class="fas fa-music"></i> éŸ³ä¹æ¨è</h4>
                <div class="music-text">${diary.music_recommendation}</div>
              </div>
            `;
          }
          
          // å¤„ç†æ ‡ç­¾
          let tagsHtml = '';
          if (diary.tags && diary.tags.length > 0) {
            tagsHtml = `
              <div class="diary-tags">
                ${diary.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            `;
          }
          
          html += `
            <div class="diary-item">
              <div class="diary-header">
                <div class="diary-date">
                  <i class="fas fa-calendar"></i>
                  <span>${date}</span>
                </div>
                <div class="diary-mood ${diary.mood}">
                  <i class="fas fa-heart"></i>
                  <span>${moodEmojis[diary.mood]} ${moodTexts[diary.mood]}</span>
                </div>
              </div>
              <div class="diary-title">${diary.title}</div>
              <div class="diary-content">${diary.content}</div>
              ${diary.mood_note ? `<div class="diary-mood-note">${diary.mood_note}</div>` : ''}
              ${tagsHtml}
              ${questionAnswersHtml}
              ${musicRecommendationHtml}
            </div>
          `;
        });
      }
      
      modalBody.innerHTML = html;
      document.getElementById('diaryModal').style.display = 'block';
    } else {
      showNotification('è·å–æ—¥è®°åˆ—è¡¨å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('è·å–æ—¥è®°è¯¦æƒ…å¤±è´¥:', error);
    showNotification('è·å–æ—¥è®°è¯¦æƒ…å¤±è´¥', 'error');
  }
}



// å…³é—­æ—¥è®°è¯¦æƒ…å¼¹çª—
function closeDiaryModal() {
  document.getElementById('diaryModal').style.display = 'none';
}



// è·å–éŸ³ä¹æ¨è
async function getMusicRecommendation() {
  try {
    // æ ¹æ®å¿ƒæƒ…é€‰æ‹©éŸ³ä¹æ¨¡å¼
    const moodToMode = {
      'happy': 'life',
      'calm': 'life',
      'excited': 'training',
      'sad': 'emo',
      'angry': 'training',
      'neutral': 'work'
    };
    
    const musicMode = moodToMode[selectedMood] || 'life';
    
    const response = await fetch('/tools/api/music/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'get_random_song',
        mode: musicMode
      })
    });
    
    const data = await response.json();
    
    if (data.success && data.song) {
      // æ˜¾ç¤ºéŸ³ä¹æ¨èåŒºåŸŸ
      document.getElementById('musicRecommendation').style.display = 'block';
      showNotification('éŸ³ä¹æ¨èåŠ è½½æˆåŠŸï¼', 'success');
    } else {
      console.log('éŸ³ä¹æ¨èåŠ è½½å¤±è´¥');
      // æ˜¾ç¤ºéŸ³ä¹æ¨èåŒºåŸŸ
      document.getElementById('musicRecommendation').style.display = 'block';
    }
  } catch (error) {
    console.error('è·å–éŸ³ä¹æ¨èå¤±è´¥:', error);
    // æ˜¾ç¤ºéŸ³ä¹æ¨èåŒºåŸŸ
    document.getElementById('musicRecommendation').style.display = 'block';
  }
}

// æœç´¢ç½‘æ˜“äº‘éŸ³ä¹
async function searchNeteaseMusic() {
  // ç¡®å®šå½“å‰æ¿€æ´»çš„æœç´¢æ¡†
  let searchInput, searchBtn, searchResults;
  
  // æ£€æŸ¥å“ªä¸ªæœç´¢æ¡†æœ‰å†…å®¹
  const input1 = document.getElementById('musicSearchInput');
  const input2 = document.getElementById('musicSearchInputForm');
  
  if (input1 && input1.value.trim()) {
    searchInput = input1;
    searchBtn = document.getElementById('searchMusicBtn');
    searchResults = document.getElementById('searchResults');
  } else if (input2 && input2.value.trim()) {
    searchInput = input2;
    searchBtn = document.getElementById('searchMusicBtnForm');
    searchResults = document.getElementById('searchResultsForm');
  } else {
    // å¦‚æœéƒ½æ²¡æœ‰å†…å®¹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª
    searchInput = input1 || input2;
    searchBtn = document.getElementById('searchMusicBtn') || document.getElementById('searchMusicBtnForm');
    searchResults = document.getElementById('searchResults') || document.getElementById('searchResultsForm');
  }
  
  const keyword = searchInput.value.trim();
  if (!keyword) {
    showNotification('è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼', 'error');
    return;
  }
  
  const originalText = searchBtn.innerHTML;
  searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  searchBtn.disabled = true;
  
  try {
    const response = await fetch(`/tools/api/music/?action=netease_search&keyword=${encodeURIComponent(keyword)}`, {
      method: 'GET',
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    const data = await response.json();
    
    if (data.success && data.data && data.data.length > 0) {
      displaySearchResults(data.data, searchResults);
      showNotification(`æ‰¾åˆ° ${data.data.length} é¦–ç›¸å…³æ­Œæ›²ï¼`, 'success');
    } else {
      searchResults.innerHTML = '<div class="no-results">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</div>';
      searchResults.style.display = 'block';
      showNotification('æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²', 'warning');
    }
  } catch (error) {
    console.error('æœç´¢éŸ³ä¹å¤±è´¥:', error);
    showNotification('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  } finally {
    searchBtn.innerHTML = originalText;
    searchBtn.disabled = false;
  }
}

// æ˜¾ç¤ºæœç´¢ç»“æœ
function displaySearchResults(songs, resultsContainer) {
  if (!resultsContainer) {
    resultsContainer = document.getElementById('searchResults') || document.getElementById('searchResultsForm');
  }
  
  let html = '<div class="songs-list">';
  
  songs.forEach((song, index) => {
           html += `
         <div class="song-item" onclick="playSelectedSong('${song.play_url}', '${song.name}', '${song.artist}')">
           <div class="song-info">
             <div class="song-title">${song.name}</div>
             <div class="song-artist">${song.artist}</div>
             <div class="song-duration">${song.duration}</div>
           </div>
           <div class="song-play-btn" title="è®¾ä¸ºèƒŒæ™¯éŸ³ä¹">
             <i class="fas fa-music"></i>
           </div>
         </div>
       `;
  });
  
  html += '</div>';
  resultsContainer.innerHTML = html;
  resultsContainer.style.display = 'block';
}

// æ’­æ”¾é€‰ä¸­çš„æ­Œæ›²ï¼ˆèƒŒæ™¯éŸ³ä¹ï¼‰
function playSelectedSong(playUrl, songName, artistName) {
  // åˆ›å»ºæˆ–è·å–å…¨å±€èƒŒæ™¯éŸ³ä¹æ’­æ”¾å™¨
  let backgroundAudio = window.backgroundAudio;
  if (!backgroundAudio) {
    backgroundAudio = new Audio();
    backgroundAudio.loop = true; // å¾ªç¯æ’­æ”¾
    window.backgroundAudio = backgroundAudio;
  }
  
  backgroundAudio.src = playUrl;
  backgroundAudio.play().then(() => {
    // æ˜¾ç¤ºèƒŒæ™¯éŸ³ä¹æ§åˆ¶
    document.getElementById('backgroundMusicControl').style.display = 'flex';
    document.getElementById('bgMusicTitle').textContent = `${songName} - ${artistName}`;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const bgMusicBtn = document.getElementById('bgMusicToggle');
    bgMusicBtn.innerHTML = '<i class="fas fa-pause"></i>';
    bgMusicBtn.title = 'æš‚åœèƒŒæ™¯éŸ³ä¹';
    
    showNotification(`ğŸµ èƒŒæ™¯éŸ³ä¹å·²è®¾ç½®: ${songName} - ${artistName}`, 'success');
  }).catch(error => {
    console.error('æ’­æ”¾å¤±è´¥:', error);
    // æä¾›ç½‘æ˜“äº‘é“¾æ¥ï¼Œè®©ç”¨æˆ·å»ç½‘æ˜“äº‘æ’­æ”¾
    const neteaseUrl = `https://music.163.com/#/search/m/?s=${encodeURIComponent(songName + ' ' + artistName)}&type=1`;
    showNotification(`ğŸµ æ— æ³•ç›´æ¥æ’­æ”¾ï¼Œè¯·å‰å¾€ç½‘æ˜“äº‘éŸ³ä¹æœç´¢æ’­æ”¾: ${songName} - ${artistName}`, 'info');
    
    // å¯é€‰ï¼šè‡ªåŠ¨æ‰“å¼€ç½‘æ˜“äº‘æœç´¢é¡µé¢
    setTimeout(() => {
      if (confirm('æ˜¯å¦è¦æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹æœç´¢é¡µé¢ï¼Ÿ')) {
        window.open(neteaseUrl, '_blank');
      }
    }, 1000);
  });
  
  // éšè—æœç´¢ç»“æœ
  document.getElementById('searchResults').style.display = 'none';
}

// åˆ‡æ¢èƒŒæ™¯éŸ³ä¹æ’­æ”¾/æš‚åœ
function toggleBackgroundMusic() {
  const backgroundAudio = window.backgroundAudio;
  if (!backgroundAudio) return;
  
  const bgMusicBtn = document.getElementById('bgMusicToggle');
  
  if (backgroundAudio.paused) {
    backgroundAudio.play();
    bgMusicBtn.innerHTML = '<i class="fas fa-pause"></i>';
    bgMusicBtn.title = 'æš‚åœèƒŒæ™¯éŸ³ä¹';
  } else {
    backgroundAudio.pause();
    bgMusicBtn.innerHTML = '<i class="fas fa-play"></i>';
    bgMusicBtn.title = 'æ’­æ”¾èƒŒæ™¯éŸ³ä¹';
  }
}





// ä½¿ç”¨AIç”Ÿæˆçš„å†…å®¹
function useGeneratedContent() {
  // è·å–é€‰ä¸­çš„é—®é¢˜
  const selectedQuestions = getSelectedQuestionsFromPreview();
  
  if (selectedQuestions.length === 0) {
    showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé—®é¢˜ï¼', 'error');
    return;
  }
  
  // ä¿å­˜é€‰ä¸­çš„é—®é¢˜åˆ°å…¨å±€å˜é‡
  window.selectedQuestions = selectedQuestions;
  
  // éšè—AIé¢„è§ˆï¼Œæ˜¾ç¤ºæ—¥è®°ç¼–è¾‘è¡¨å•
  document.getElementById('aiContentPreview').style.display = 'none';
  document.getElementById('diaryFormContainer').style.display = 'block';
  
  // æ˜¾ç¤º"ä¿å­˜è®°å½•"æŒ‰é’®
  document.getElementById('completeDiary').style.display = 'inline-flex';
  
  // ç”Ÿæˆé€‰ä¸­é—®é¢˜çš„è¾“å…¥æ¡†
  generateSelectedQuestionInputs(selectedQuestions);
  
  // è®¾ç½®å¿ƒæƒ…é€‰æ‹©
  document.querySelectorAll('#diaryFormContainer .mood-option').forEach(option => {
    option.classList.remove('selected');
    if (option.dataset.mood === selectedMood) {
      option.classList.add('selected');
    }
  });
  
  // è§¦å‘éªŒè¯
  validateStep3();
  
  showNotification(`å·²é€‰æ‹© ${selectedQuestions.length} ä¸ªé—®é¢˜ï¼Œè¯·å¡«å†™æ‚¨çš„ç­”æ¡ˆï¼`, 'success');
}

// ä»AIé¢„è§ˆä¸­è·å–é€‰ä¸­çš„é—®é¢˜
function getSelectedQuestionsFromPreview() {
  const selectedQuestions = [];
  const checkboxes = document.querySelectorAll('#aiContentPreview .question-select-checkbox');
  
  checkboxes.forEach((checkbox, index) => {
    if (checkbox.checked) {
      const questionItem = checkbox.closest('.question-selection-item');
      const question = questionItem.getAttribute('data-question');
      const originalIndex = questionItem.getAttribute('data-index');
      selectedQuestions.push({
        index: parseInt(originalIndex),
        question: question
      });
    }
  });
  
  return selectedQuestions;
}

// è§£æAIç”Ÿæˆçš„é—®é¢˜
function parseAIQuestions(content) {
  const lines = content.split('\n');
  let questions = [];
  let music = '';
  
  for (const line of lines) {
    const trimmedLine = line.trim();
    if (trimmedLine === '') continue;
    
    if (trimmedLine.includes('ğŸµ éŸ³ä¹æ¨èï¼š')) {
      music = trimmedLine.replace('ğŸµ éŸ³ä¹æ¨èï¼š', '');
      continue;
    }
    
    // åŒ¹é…æ•°å­—ç¼–å·çš„ç–‘é—®å¥ (ä¾‹å¦‚ "1. ä½ çš„é—®é¢˜?")
    const questionMatch = trimmedLine.match(/^(\d+)\.\s*(.*)/);
    if (questionMatch) {
      questions.push(questionMatch[2]); // æå–é—®é¢˜å†…å®¹
    } else if (trimmedLine.startsWith('â€¢ ')) {
      questions.push(trimmedLine.substring(2));
    } else if (!trimmedLine.includes('ğŸµ')) {
      questions.push(trimmedLine);
    }
  }
  
  // ä¿å­˜éŸ³ä¹æ¨èä¿¡æ¯
  window.currentMusicRecommendation = music;
  
  return questions.filter(q => q.trim() !== '');
}

// æ˜¾ç¤ºé—®é¢˜é€‰æ‹©ç•Œé¢
function showQuestionSelectionInterface(questions) {
  // éšè—AIé¢„è§ˆï¼Œæ˜¾ç¤ºé—®é¢˜é€‰æ‹©ç•Œé¢
  document.getElementById('aiContentPreview').style.display = 'none';
  
  // åˆ›å»ºé—®é¢˜é€‰æ‹©ç•Œé¢
  const selectionContainer = document.createElement('div');
  selectionContainer.id = 'questionSelectionContainer';
  selectionContainer.className = 'question-selection-container';
  
  let html = `
    <div class="selection-header">
      <h3><i class="fas fa-check-circle"></i> é€‰æ‹©æ‚¨æƒ³å›ç­”çš„é—®é¢˜</h3>
      <p>è¯·é€‰æ‹©æ‚¨æƒ³è¦å›ç­”çš„é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å°†ä½œä¸ºæ‚¨ä»Šå¤©çš„ç”Ÿæ´»è®°å½•å†…å®¹</p>
    </div>
    <div class="questions-selection-list">
  `;
  
  questions.forEach((question, index) => {
    html += `
      <div class="question-selection-item" data-question="${question}" data-index="${index}">
        <div class="question-checkbox">
          <input type="checkbox" id="question${index}" class="question-select-checkbox">
          <label for="question${index}"></label>
        </div>
        <div class="question-content">
          <span class="question-number">${index + 1}.</span>
          <span class="question-text">${question}</span>
        </div>
      </div>
    `;
  });
  
  html += `
    </div>
    <div class="selection-actions">
      <button class="btn btn-secondary" onclick="selectAllQuestions()">
        <i class="fas fa-check-double"></i> å…¨é€‰
      </button>
      <button class="btn btn-secondary" onclick="deselectAllQuestions()">
        <i class="fas fa-times"></i> å–æ¶ˆå…¨é€‰
      </button>
      <button class="btn btn-primary" onclick="confirmSelectedQuestions()">
        <i class="fas fa-arrow-right"></i> ç¡®è®¤é€‰æ‹©å¹¶ç»§ç»­
      </button>
    </div>
  `;
  
  selectionContainer.innerHTML = html;
  
  // æ’å…¥åˆ°AIé¢„è§ˆçš„ä½ç½®
  const aiPreview = document.getElementById('aiContentPreview');
  aiPreview.parentNode.insertBefore(selectionContainer, aiPreview.nextSibling);
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  addQuestionSelectionListeners();
}

// æ·»åŠ é—®é¢˜é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
function addQuestionSelectionListeners() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  const questionItems = document.querySelectorAll('.question-selection-item');
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateSelectionStatus();
      updateQuestionItemStyle(this);
    });
  });
  
  // ä¸ºæ•´ä¸ªé—®é¢˜é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
  questionItems.forEach(item => {
    item.addEventListener('click', function(e) {
      // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†æœ¬èº«ï¼Œä¸é‡å¤å¤„ç†
      if (e.target.type === 'checkbox') return;
      
      const checkbox = this.querySelector('.question-select-checkbox');
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateSelectionStatus();
        updateQuestionItemStyle(checkbox);
      }
    });
  });
  
  // åˆå§‹åŒ–é€‰æ‹©çŠ¶æ€
  updateSelectionStatus();
}

// æ›´æ–°é€‰æ‹©çŠ¶æ€
function updateSelectionStatus() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  const totalCount = checkboxes.length;
  
  // æ›´æ–°"ä½¿ç”¨æ­¤å†…å®¹"æŒ‰é’®çŠ¶æ€
  const useContentBtn = document.getElementById('useGeneratedContent');
  if (useContentBtn) {
    if (selectedCount > 0) {
      useContentBtn.innerHTML = `<i class="fas fa-check"></i><span>ä½¿ç”¨æ­¤å†…å®¹ (${selectedCount}/${totalCount})</span>`;
      useContentBtn.disabled = false;
    } else {
      useContentBtn.innerHTML = `<i class="fas fa-check"></i><span>è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé—®é¢˜</span>`;
      useContentBtn.disabled = true;
    }
  }
}

// å…¨é€‰é—®é¢˜
function selectAllQuestions() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = true;
  });
  updateSelectionStatus();
}

// å–æ¶ˆå…¨é€‰
function deselectAllQuestions() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
  updateSelectionStatus();
}

// ç¡®è®¤é€‰æ‹©çš„é—®é¢˜
function confirmSelectedQuestions() {
  const selectedQuestions = [];
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  
  checkboxes.forEach((checkbox, index) => {
    if (checkbox.checked) {
      const questionItem = checkbox.closest('.question-selection-item');
      const question = questionItem.getAttribute('data-question');
      selectedQuestions.push({
        index: index,
        question: question
      });
    }
  });
  
  if (selectedQuestions.length === 0) {
    showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé—®é¢˜ï¼', 'error');
    return;
  }
  
  // ä¿å­˜é€‰ä¸­çš„é—®é¢˜åˆ°å…¨å±€å˜é‡
  window.selectedQuestions = selectedQuestions;
  
  // éšè—é€‰æ‹©ç•Œé¢ï¼Œæ˜¾ç¤ºæ—¥è®°ç¼–è¾‘è¡¨å•
  document.getElementById('questionSelectionContainer').style.display = 'none';
  document.getElementById('diaryFormContainer').style.display = 'block';
  
  // ç”Ÿæˆé€‰ä¸­é—®é¢˜çš„è¾“å…¥æ¡†
  generateSelectedQuestionInputs(selectedQuestions);
  
  // è®¾ç½®å¿ƒæƒ…é€‰æ‹©
  document.querySelectorAll('#diaryFormContainer .mood-option').forEach(option => {
    option.classList.remove('selected');
    if (option.dataset.mood === selectedMood) {
      option.classList.add('selected');
    }
  });
  
  // è§¦å‘éªŒè¯
  validateStep3();
  
  showNotification(`å·²é€‰æ‹© ${selectedQuestions.length} ä¸ªé—®é¢˜ï¼Œè¯·å¡«å†™æ‚¨çš„ç­”æ¡ˆï¼`, 'success');
}

// ç”Ÿæˆé€‰ä¸­é—®é¢˜çš„è¾“å…¥æ¡†
function generateSelectedQuestionInputs(selectedQuestions) {
  const container = document.getElementById('questionsContainer');
  container.innerHTML = '';
  
  // ä¸ºæ¯ä¸ªé€‰ä¸­çš„é—®é¢˜ç”Ÿæˆè¾“å…¥æ¡†
  selectedQuestions.forEach((questionData, index) => {
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-input-group';
    questionDiv.innerHTML = `
      <div class="question-label">
        <span class="question-number">${index + 1}.</span>
        <span class="question-text">${questionData.question}</span>
      </div>
      <textarea 
        id="question${index + 1}" 
        class="form-control question-answer" 
        rows="4" 
        placeholder="è¯·åˆ†äº«æ‚¨çš„æƒ³æ³•..."
        data-question="${questionData.question}"
        data-original-index="${questionData.index}"
      ></textarea>
      <div class="additional-input-section">
        <input 
          type="text" 
          id="additionalInput${index + 1}" 
          class="form-control additional-input" 
          placeholder="è¡¥å……è¯´æ˜..."
          data-question="${questionData.question}"
        >
      </div>
    `;
    container.appendChild(questionDiv);
  });
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  addQuestionInputListeners();
}

// æ·»åŠ é—®é¢˜è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨
function addQuestionInputListeners() {
  const questionAnswers = document.querySelectorAll('.question-answer');
  const additionalInputs = document.querySelectorAll('.additional-input');
  
  questionAnswers.forEach((textarea, index) => {
    if (textarea && !textarea.hasEventListener) {
      textarea.addEventListener('input', validateStep3);
      textarea.hasEventListener = true;
    }
  });
  
  additionalInputs.forEach((input, index) => {
    if (input && !input.hasEventListener) {
      input.addEventListener('input', validateStep3);
      input.hasEventListener = true;
    }
  });
}

// ç”Ÿæˆé—®é¢˜è¾“å…¥æ¡†ï¼ˆä¿ç•™åŸå‡½æ•°ä»¥å…¼å®¹ï¼‰
function generateQuestionInputs(content) {
  // è¿™ä¸ªå‡½æ•°ç°åœ¨è¢«generateSelectedQuestionInputsæ›¿ä»£
  console.warn('generateQuestionInputså·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨generateSelectedQuestionInputs');
}

// åˆ‡æ¢é—®é¢˜è¾“å…¥æ¡†æ˜¾ç¤º/éšè—
function toggleQuestionInput(questionNumber) {
  console.log('toggleQuestionInput è¢«è°ƒç”¨ï¼Œé—®é¢˜ç¼–å·:', questionNumber);
  
  const inputWrapper = document.getElementById(`inputWrapper${questionNumber}`);
  const icon = document.getElementById(`icon${questionNumber}`);
  
  console.log('æ‰¾åˆ°çš„å…ƒç´ :', { inputWrapper, icon });
  
  if (!inputWrapper || !icon) {
    console.error('æ‰¾ä¸åˆ°å…ƒç´ :', questionNumber);
    return;
  }
  
  const questionHeader = icon.closest('.question-header');
  console.log('å½“å‰æ˜¾ç¤ºçŠ¶æ€:', inputWrapper.style.display);
  
  if (inputWrapper.style.display === 'none') {
    // å±•å¼€è¾“å…¥æ¡†
    console.log('å±•å¼€è¾“å…¥æ¡†');
    inputWrapper.style.display = 'block';
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-up');
    if (questionHeader) {
      questionHeader.classList.add('active');
    }
    
    // èšç„¦åˆ°è¾“å…¥æ¡†
    setTimeout(() => {
      const textarea = document.getElementById(`question${questionNumber}`);
      if (textarea) {
        textarea.focus();
      }
    }, 100);
  } else {
    // æ”¶èµ·è¾“å…¥æ¡†
    console.log('æ”¶èµ·è¾“å…¥æ¡†');
    inputWrapper.style.display = 'none';
    icon.classList.remove('fa-chevron-up');
    icon.classList.add('fa-chevron-down');
    if (questionHeader) {
      questionHeader.classList.remove('active');
    }
  }
}

// æ ¼å¼åŒ–å†…å®¹ç”¨äºç¼–è¾‘
function formatContentForEditing(content) {
  // ç§»é™¤ã€10ä¸ªç–‘é—®å¥ã€‘å’Œã€æ¨èéŸ³ä¹ã€‘æ ‡è®°ï¼Œå¹¶æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
  let processedContent = content
    .replace(/ã€10ä¸ªç–‘é—®å¥ã€‘\n*/g, '') // ç§»é™¤æ ‡é¢˜å’Œå…¶åçš„æ¢è¡Œ
    .replace(/ã€æ¨èéŸ³ä¹ã€‘\n*/g, '') // ç§»é™¤æ ‡é¢˜å’Œå…¶åçš„æ¢è¡Œ
    .trim(); // æ¸…ç†æ•´ä½“å†…å®¹çš„ç©ºç™½

  const lines = processedContent.split('\n');
  let questions = [];
  let music = '';
  let inMusicSection = false; // æ ‡è®°æ˜¯å¦è¿›å…¥éŸ³ä¹ä¿¡æ¯éƒ¨åˆ†

  for (const line of lines) {
    const trimmedLine = line.trim();
    if (trimmedLine === '') {
      continue; // è·³è¿‡ç©ºè¡Œ
    }

    // å°è¯•åŒ¹é…éŸ³ä¹ä¿¡æ¯è¡Œ (ä¾‹å¦‚ "æ­Œæ›²å - è‰ºæœ¯å®¶")
    // å¹¶ä¸”ç¡®ä¿æˆ‘ä»¬è¿˜æ²¡æœ‰æ‰¾åˆ°éŸ³ä¹ä¿¡æ¯ï¼Œé¿å…é‡å¤æˆ–é”™è¯¯åŒ¹é…
    if (trimmedLine.includes(' - ') && !music && !inMusicSection) {
        music = trimmedLine;
        inMusicSection = true; // æ ‡è®°å·²æ‰¾åˆ°éŸ³ä¹ä¿¡æ¯
        continue;
    }

    // åŒ¹é…æ•°å­—ç¼–å·çš„ç–‘é—®å¥ (ä¾‹å¦‚ "1. ä½ çš„é—®é¢˜?")
    const questionMatch = trimmedLine.match(/^(\d+)\.\s*(.*)/);
    if (questionMatch) {
      questions.push(`â€¢ ${questionMatch[2]}`); // è½¬æ¢ä¸ºåœ†ç‚¹åˆ—è¡¨æ ¼å¼
    } else if (!inMusicSection) {
      // å¦‚æœä¸æ˜¯ç¼–å·é—®é¢˜ï¼Œä¹Ÿä¸æ˜¯éŸ³ä¹ä¿¡æ¯ï¼Œä¸”æœªè¿›å…¥éŸ³ä¹éƒ¨åˆ†ï¼Œåˆ™ä½œä¸ºæ™®é€šæ–‡æœ¬è¡Œå¤„ç†
      // è¿™å¯ä»¥æ•è·AIå¯èƒ½ç”Ÿæˆçš„éç¼–å·æ–‡æœ¬
      questions.push(trimmedLine);
    }
  }

  // å°†æ‰€æœ‰å¤„ç†è¿‡çš„ç–‘é—®å¥ç”¨åŒæ¢è¡Œç¬¦è¿æ¥ï¼Œç¡®ä¿æ¯å¥ç‹¬ç«‹
  let finalOutput = questions.join('\n\n');

  // æ·»åŠ éŸ³ä¹æ¨èä¿¡æ¯
  if (music) {
    if (finalOutput) {
      finalOutput += '\n\n'; // å¦‚æœå‰é¢æœ‰å†…å®¹ï¼Œåˆ™æ·»åŠ åŒæ¢è¡Œåˆ†éš”
    }
    finalOutput += `ğŸµ éŸ³ä¹æ¨èï¼š${music}`;
  }

  // ç¡®ä¿æœ€ç»ˆè¾“å‡ºæœ‰è‰¯å¥½çš„æ’ç‰ˆ
  finalOutput = finalOutput
    .replace(/\n{3,}/g, '\n\n') // å°†3ä¸ªæˆ–æ›´å¤šæ¢è¡Œç¬¦æ›¿æ¢ä¸º2ä¸ª
    .trim(); // æ¸…ç†é¦–å°¾ç©ºç™½

  return finalOutput;
}


    
    const data = await response.json();
    
    if (data.success) {
      showNotification('ğŸ‰ ç”Ÿæ´»è®°å½•ä¿å­˜æˆåŠŸï¼', 'success');
      goToStep(4); // ä¿å­˜æˆåŠŸåè·³è½¬åˆ°ç»Ÿè®¡é¡µé¢
    } else {
      showNotification(data.error || 'ä¿å­˜å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('ä¿å­˜æ—¥è®°å¤±è´¥:', error);
    showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  } finally {
    completeButton.innerHTML = originalText;
    completeButton.disabled = false;
  }
}



// æ›´æ–°å¿ƒæƒ…ç»Ÿè®¡æ‘˜è¦
function updateMoodStatsSummary(moodStats) {
  const summaryElement = document.getElementById('moodStatsSummary');
  if (!summaryElement) return;
  
  const totalEntries = Object.values(moodStats).reduce((sum, count) => sum + count, 0);
  if (totalEntries === 0) {
    summaryElement.innerHTML = '<p>æš‚æ— å¿ƒæƒ…æ•°æ®</p>';
    return;
  }
  
  const moodNames = {
    'happy': 'å¼€å¿ƒ',
    'calm': 'å¹³é™',
    'excited': 'å…´å¥‹',
    'sad': 'éš¾è¿‡',
    'angry': 'ç”Ÿæ°”',
    'neutral': 'ä¸€èˆ¬'
  };
  
  let summaryHtml = '<div class="mood-stats-grid">';
  Object.entries(moodStats).forEach(([mood, count]) => {
    const percentage = ((count / totalEntries) * 100).toFixed(1);
    const moodName = moodNames[mood] || mood;
    summaryHtml += `
      <div class="mood-stat-item">
        <span class="mood-stat-label">${moodName}</span>
        <span class="mood-stat-value">${count} (${percentage}%)</span>
      </div>
    `;
  });
  summaryHtml += '</div>';
  
  summaryElement.innerHTML = summaryHtml;
}

// æ¸²æŸ“å¿ƒæƒ…å›¾è¡¨
function renderMoodChart(moodStats) {
  const canvas = document.getElementById('moodChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const width = canvas.width = canvas.offsetWidth;
  const height = canvas.height = 300;
  
  ctx.clearRect(0, 0, width, height);
  
  const totalEntries = Object.values(moodStats).reduce((sum, count) => sum + count, 0);
  if (totalEntries === 0) {
    ctx.fillStyle = '#666';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('æš‚æ— å¿ƒæƒ…æ•°æ®', width / 2, height / 2);
    return;
  }
  
  const colors = {
    'happy': '#4CAF50',
    'calm': '#2196F3',
    'excited': '#FF9800',
    'sad': '#9C27B0',
    'angry': '#F44336',
    'neutral': '#9E9E9E'
  };
  
  let currentAngle = 0;
  Object.entries(moodStats).forEach(([mood, count]) => {
    const sliceAngle = (count / totalEntries) * 2 * Math.PI;
    const color = colors[mood] || '#9E9E9E';
    
    ctx.beginPath();
    ctx.moveTo(width / 2, height / 2);
    ctx.arc(width / 2, height / 2, Math.min(width, height) / 3, currentAngle, currentAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    
    currentAngle += sliceAngle;
  });
}

// æ›´æ–°æ—¥è®°æ‰“å¡æ—¥å†
function updateDiaryCheckInCalendar(checkinData) {
  if (!diaryCheckInCalendar) {
    diaryCheckInCalendar = new DiaryCheckInCalendar();
  }
  diaryCheckInCalendar.updateData(checkinData);
}

// è·å–å½“å‰é¡µé¢å¿ƒæƒ…
function getCurrentPageMood() {
  return selectedMood;
}

// æ¸²æŸ“ä¸´æ—¶å¿ƒæƒ…å›¾è¡¨
function renderTemporaryMoodChart(ctx, width, height, mood) {
  const colors = {
    'happy': '#4CAF50',
    'calm': '#2196F3',
    'excited': '#FF9800',
    'sad': '#9C27B0',
    'angry': '#F44336',
    'neutral': '#9E9E9E'
  };
  
  const color = colors[mood] || '#9E9E9E';
  const centerX = width / 2;
  const centerY = height / 2;
  const radius = Math.min(width, height) / 4;
  
  // ç»˜åˆ¶åœ†å½¢
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
  ctx.fillStyle = color;
  ctx.fill();
  
  // ç»˜åˆ¶æ–‡å­—
  ctx.fillStyle = 'white';
  ctx.font = 'bold 16px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('ä»Šæ—¥å¿ƒæƒ…', centerX, centerY);
}



// æ˜¾ç¤ºç»Ÿè®¡è¯¦æƒ…
function showStatDetail(cardType) {
  const modal = document.getElementById('statDetailModal');
  const title = document.getElementById('statDetailTitle');
  const icon = document.getElementById('statDetailIcon');
  const summaryNumber = document.getElementById('statDetailSummaryNumber');
  const summaryLabel = document.getElementById('statDetailSummaryLabel');
  const list = document.getElementById('statDetailList');
  
  const cardInfo = {
    'totalDiaryDaysCard': {
      title: 'æ—¥è®°å¤©æ•°ç»Ÿè®¡',
      icon: 'ğŸ“…',
      label: 'æ€»å¤©æ•°'
    },
    'totalDiaryCountCard': {
      title: 'æ—¥è®°æ¬¡æ•°ç»Ÿè®¡',
      icon: 'ğŸ“',
      label: 'æ€»æ¬¡æ•°'
    },
    'happyDaysCard': {
      title: 'å¼€å¿ƒå¤©æ•°ç»Ÿè®¡',
      icon: 'ğŸ˜Š',
      label: 'å¼€å¿ƒå¤©æ•°'
    },
    'totalWordsCard': {
      title: 'æ€»å­—æ•°ç»Ÿè®¡',
      icon: 'ğŸ“–',
      label: 'æ€»å­—æ•°'
    }
  };
  
  const info = cardInfo[cardType];
  if (!info) return;
  
  title.textContent = info.title;
  icon.textContent = info.icon;
  summaryLabel.textContent = info.label;
  
  // è¿™é‡Œå¯ä»¥æ·»åŠ è·å–è¯¦ç»†æ•°æ®çš„é€»è¾‘
  // æš‚æ—¶æ˜¾ç¤ºç¤ºä¾‹æ•°æ®
  summaryNumber.textContent = '0';
  list.innerHTML = '<div class="stat-detail-empty"><div class="stat-detail-empty-icon">ğŸ“Š</div><div class="stat-detail-empty-text">æš‚æ— è¯¦ç»†æ•°æ®</div></div>';
  
  modal.style.display = 'flex';
}

// å…³é—­ç»Ÿè®¡è¯¦æƒ…å¼¹çª—
function closeStatDetail() {
  document.getElementById('statDetailModal').style.display = 'none';
}

// åˆå§‹åŒ–ç»Ÿè®¡è¯¦æƒ…å¼¹çª—
function initStatDetailModal() {
  const modal = document.getElementById('statDetailModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeStatDetail();
      }
    });
  }
}

// å®Œæˆæ—¥è®°æµç¨‹
function finishDiary() {
  goToStep(5);
}

// é‡ç½®æ—¥è®°
function resetDiary() {
  // é‡ç½®æ‰€æœ‰æ•°æ®
  selectedMood = null;
  selectedGoalCategories = [];
  diaryData = {
    title: '',
    content: '',
    mood: '',
    goal_category: ''
  };
  
  // é‡ç½®UIçŠ¶æ€
  document.querySelectorAll('.mood-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  document.querySelectorAll('.goal-icon-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  // é‡ç½®è¡¨å•
  const diaryTitle = document.getElementById('diaryTitle');
  if (diaryTitle) diaryTitle.value = '';
  
  document.querySelectorAll('.question-answer').forEach(textarea => {
    textarea.value = '';
  });
  
  document.querySelectorAll('.additional-input').forEach(input => {
    input.value = '';
  });
  
  // éšè—AIé¢„è§ˆå’Œè¡¨å•
  document.getElementById('aiContentPreview').style.display = 'none';
  document.getElementById('diaryFormContainer').style.display = 'none';
  document.getElementById('completeDiary').style.display = 'none';
  
  // å›åˆ°ç¬¬ä¸€æ­¥
  goToStep(1);
  
  showNotification('å·²é‡ç½®ï¼Œå¼€å§‹æ–°çš„è®°å½•å§ï¼', 'success');
}

// åŠ è½½ä»Šæ—¥æ•°æ®
function loadTodayData() {
  // è¿™é‡Œå¯ä»¥æ·»åŠ åŠ è½½ä»Šæ—¥å·²æœ‰æ•°æ®çš„é€»è¾‘
  console.log('åŠ è½½ä»Šæ—¥æ•°æ®');
}

// å¿ƒæƒ…é€‰æ‹©ç›‘å¬å™¨
function addMoodSelectionListener() {
  const moodOptions = document.querySelectorAll('.mood-option');
  
  moodOptions.forEach(option => {
    option.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const mood = this.dataset.mood;
      console.log('å¿ƒæƒ…é€‰æ‹©ç‚¹å‡»:', mood);
      
      // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
      moodOptions.forEach(opt => opt.classList.remove('selected'));
      
      // æ·»åŠ å½“å‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
      this.classList.add('selected');
      
      // æ›´æ–°å…¨å±€å˜é‡
      selectedMood = mood;
      diaryData.mood = mood;
      
      // æ£€æŸ¥æ­¥éª¤1å®ŒæˆçŠ¶æ€
      checkStep1Completion();
      
      // æ˜¾ç¤ºåé¦ˆ
      showMoodFeedback(mood);
      
      console.log('å¿ƒæƒ…é€‰æ‹©å®Œæˆ:', { selectedMood, diaryData });
    });
  });
  
  console.log('å¿ƒæƒ…é€‰æ‹©ç›‘å¬å™¨å·²æ·»åŠ ï¼Œé€‰é¡¹æ•°é‡:', moodOptions.length);
}
    
    // æ›´æ–°æœˆä»½æ˜¾ç¤º
    const monthDisplay = document.getElementById('diaryCurrentMonth');
    if (monthDisplay) {
      monthDisplay.textContent = `${year}å¹´${month + 1}æœˆ`;
    }
    
    // ç”Ÿæˆæ—¥å†ç½‘æ ¼
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    let html = '';
    for (let i = 0; i < 42; i++) {
      const date = new Date(startDate);
      date.setDate(startDate.getDate() + i);
      
      const isCurrentMonth = date.getMonth() === month;
      const isToday = this.isToday(date);
      const hasCheckin = this.hasCheckin(date);
      
      let className = 'calendar-day';
      if (!isCurrentMonth) className += ' other-month';
      if (isToday) className += ' today';
      if (hasCheckin) className += ' has-checkin completed';
      
      html += `<div class="${className}" data-date="${date.toISOString().split('T')[0]}">${date.getDate()}</div>`;
    }
    
    calendarBody.innerHTML = html;
  }
  
  addEventListeners() {
    // æœˆä»½å¯¼èˆª
    const prevBtn = document.getElementById('diaryPrevMonth');
    const nextBtn = document.getElementById('diaryNextMonth');
    const todayBtn = document.getElementById('diaryGoToday');
    
    if (prevBtn) prevBtn.addEventListener('click', () => this.previousMonth());
    if (nextBtn) nextBtn.addEventListener('click', () => this.nextMonth());
    if (todayBtn) todayBtn.addEventListener('click', () => this.goToToday());
  }
  
  previousMonth() {
    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
    this.renderCalendar();
  }
  
  nextMonth() {
    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
    this.renderCalendar();
  }
  
  goToToday() {
    this.currentDate = new Date();
    this.renderCalendar();
  }
  
  isToday(date) {
    const today = new Date();
    return date.toDateString() === today.toDateString();
  }
  
  hasCheckin(date) {
    const dateStr = date.toISOString().split('T')[0];
    return this.checkinData[dateStr] || false;
  }
  
  updateData(data) {
    this.checkinData = data;
    this.renderCalendar();
  }
}

    ctx.fillText(yLabels[i], 45, y + 4);
  }
  
  // Xè½´æ ‡ç­¾
  ctx.textAlign = 'center';
  dates.forEach((date, index) => {
    const x = 50 + (index * (width - 80) / (dates.length - 1));
    ctx.fillText(date, x, height - 30);
  });
  
  // ç»˜åˆ¶å¿ƒæƒ…æ›²çº¿
  ctx.strokeStyle = '#4CAF50';
  ctx.lineWidth = 3;
  ctx.beginPath();
  
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / (levels.length - 1));
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    if (index === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  ctx.stroke();
  
  // ç»˜åˆ¶æ•°æ®ç‚¹
  ctx.fillStyle = '#4CAF50';
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / (levels.length - 1));
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, 2 * Math.PI);
    ctx.fill();
  });
  
  // æ·»åŠ è¶‹åŠ¿æŒ‡ç¤ºå™¨
  if (moodData.mood_trend) {
    const trendText = {
      'improving': 'ğŸ“ˆ å¿ƒæƒ…æ”¹å–„ä¸­',
      'declining': 'ğŸ“‰ å¿ƒæƒ…ä¸‹é™ä¸­',
      'stable': 'â¡ï¸ å¿ƒæƒ…ç¨³å®š'
    };
    
    ctx.fillStyle = '#333';
    ctx.font = '14px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(trendText[moodData.mood_trend] || 'æœªçŸ¥è¶‹åŠ¿', 60, 25);
    
    // æ·»åŠ ç½®ä¿¡åº¦ä¿¡æ¯
    if (moodData.trend_confidence) {
      const confidenceText = {
        'high': 'é«˜ç½®ä¿¡åº¦',
        'medium': 'ä¸­ç­‰ç½®ä¿¡åº¦',
        'low': 'ä½ç½®ä¿¡åº¦'
      };
      ctx.fillStyle = '#666';
      ctx.font = '12px Arial';
      ctx.fillText(`ç½®ä¿¡åº¦: ${confidenceText[moodData.trend_confidence]}`, 60, 45);
      }
}




  ctx.stroke();
  
  // ç»˜åˆ¶æ•°æ®ç‚¹
  ctx.fillStyle = '#4CAF50';
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / 6);
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, 2 * Math.PI);
    ctx.fill();
  });
  
  // æ·»åŠ æç¤ºä¿¡æ¯
  ctx.fillStyle = '#333';
  ctx.font = '14px Arial';
  ctx.textAlign = 'left';
  ctx.fillText('ğŸ“Š åŸºäºå½“å‰é€‰æ‹©çš„å¿ƒæƒ…ç”Ÿæˆçš„é¢„è§ˆ', 60, 25);
  
  ctx.fillStyle = '#666';
  ctx.font = '12px Arial';
  ctx.fillText('ä¿å­˜æ—¥è®°åå°†æ˜¾ç¤ºçœŸå®çš„å†å²è¶‹åŠ¿', 60, 45);
  
  // æ›´æ–°å¿ƒæƒ…ç»Ÿè®¡æ‘˜è¦
  updateTemporaryMoodStats(currentMood);
}

// æ›´æ–°ä¸´æ—¶å¿ƒæƒ…ç»Ÿè®¡æ‘˜è¦
function updateTemporaryMoodStats(currentMood) {
  const summaryElement = document.getElementById('moodStatsSummary');
  if (!summaryElement) return;
  
  const moodText = {
    'happy': 'å¼€å¿ƒ',
    'excited': 'å…´å¥‹',
    'calm': 'å¹³é™',
    'content': 'æ»¡è¶³',
    'neutral': 'ä¸€èˆ¬',
    'worried': 'æ‹…å¿ƒ',
    'tired': 'ç–²æƒ«',
    'sad': 'éš¾è¿‡',
    'anxious': 'ç„¦è™‘',
    'stressed': 'å‹åŠ›',
    'frustrated': 'æ²®ä¸§',
    'angry': 'ç”Ÿæ°”',
    'grateful': 'æ„Ÿæ©',
    'inspired': 'å—å¯å‘',
    'confident': 'è‡ªä¿¡'
  };
  
  summaryElement.innerHTML = `
    <div class="mood-stats-grid">
      <div class="mood-stat-item positive">
        <span class="stat-label">ğŸ˜Š å½“å‰å¿ƒæƒ…</span>
        <span class="stat-value">${moodText[currentMood] || 'æœªçŸ¥'}</span>
      </div>
      <div class="mood-stat-item neutral">
        <span class="stat-label">ğŸ“ æç¤º</span>
        <span class="stat-value">ä¿å­˜æ—¥è®°æŸ¥çœ‹è¶‹åŠ¿</span>
      </div>
      <div class="mood-stat-item negative">
        <span class="stat-label">ğŸ“Š æ•°æ®çŠ¶æ€</span>
        <span class="stat-value">é¢„è§ˆæ¨¡å¼</span>
      </div>
      <div class="mood-stat-item stability">
        <span class="stat-label">ğŸ’¡ å»ºè®®</span>
        <span class="stat-value">ç»§ç»­è®°å½•ç”Ÿæ´»</span>
      </div>
    </div>
  `;
}

















// åŠ è½½æ—¥è®°å¤©æ•°è¯¦æƒ…
function loadDiaryDaysDetail(list) {
  fetch('/tools/api/life_diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_diary_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const uniqueDates = [...new Set(data.diaries.map(diary => diary.date))];
      displayDiaryDaysDetail(list, uniqueDates, data.diaries);
    } else {
      displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    }
  })
  .catch(error => {
    console.error('åŠ è½½æ—¥è®°å¤©æ•°è¯¦æƒ…å¤±è´¥:', error);
    displayEmptyDetail(list, 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}

// åŠ è½½æ—¥è®°æ¬¡æ•°è¯¦æƒ…
function loadDiaryCountDetail(list) {
  fetch('/tools/api/life_diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_diary_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      displayDiaryCountDetail(list, data.diaries);
    } else {
      displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    }
  })
  .catch(error => {
    console.error('åŠ è½½æ—¥è®°æ¬¡æ•°è¯¦æƒ…å¤±è´¥:', error);
    displayEmptyDetail(list, 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}

// åŠ è½½å¼€å¿ƒå¤©æ•°è¯¦æƒ…
function loadHappyDaysDetail(list) {
  fetch('/tools/api/life_diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_happy_days_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      displayHappyDaysDetail(list, data.data);
    } else {
      displayEmptyDetail(list, 'æš‚æ— å¼€å¿ƒæ•°æ®');
    }
  })
  .catch(error => {
    console.error('åŠ è½½å¼€å¿ƒå¤©æ•°è¯¦æƒ…å¤±è´¥:', error);
    displayEmptyDetail(list, 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}

// åŠ è½½æ€»å­—æ•°è¯¦æƒ…
function loadTotalWordsDetail(list) {
  fetch('/tools/api/life_diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_diary_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      displayTotalWordsDetail(list, data.diaries);
    } else {
      displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    }
  })
  .catch(error => {
    console.error('åŠ è½½æ€»å­—æ•°è¯¦æƒ…å¤±è´¥:', error);
    displayEmptyDetail(list, 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  });
}

// æ˜¾ç¤ºæ—¥è®°å¤©æ•°è¯¦æƒ…
function displayDiaryDaysDetail(list, uniqueDates, diaries) {
  if (uniqueDates.length === 0) {
    displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    return;
  }
  
  let html = '';
  uniqueDates.forEach(date => {
    const dateDiaries = diaries.filter(diary => diary.date === date);
    const firstDiary = dateDiaries[0];
    
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${date}</div>
          <div class="stat-detail-item-mood">${getMoodEmoji(firstDiary.mood)}</div>
        </div>
        <div class="stat-detail-item-title">${firstDiary.title}</div>
        <div class="stat-detail-item-content">${firstDiary.content.substring(0, 100)}${firstDiary.content.length > 100 ? '...' : ''}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// æ˜¾ç¤ºæ—¥è®°æ¬¡æ•°è¯¦æƒ…
function displayDiaryCountDetail(list, diaries) {
  if (diaries.length === 0) {
    displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    return;
  }
  
  let html = '';
  diaries.forEach(diary => {
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${diary.created_at.split('T')[0]}</div>
          <div class="stat-detail-item-mood">${getMoodEmoji(diary.mood)}</div>
        </div>
        <div class="stat-detail-item-title">${diary.title}</div>
        <div class="stat-detail-item-content">${diary.content.substring(0, 100)}${diary.content.length > 100 ? '...' : ''}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// æ˜¾ç¤ºå¼€å¿ƒå¤©æ•°è¯¦æƒ…
function displayHappyDaysDetail(list, happyDays) {
  if (happyDays.length === 0) {
    displayEmptyDetail(list, 'æš‚æ— å¼€å¿ƒæ•°æ®');
    return;
  }
  
  let html = '';
  happyDays.forEach(day => {
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${day.date}</div>
          <div class="stat-detail-item-mood">ğŸ˜Š</div>
        </div>
        <div class="stat-detail-item-title">${day.title}</div>
        <div class="stat-detail-item-content">${day.content}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// æ˜¾ç¤ºæ€»å­—æ•°è¯¦æƒ…
function displayTotalWordsDetail(list, diaries) {
  if (diaries.length === 0) {
    displayEmptyDetail(list, 'æš‚æ— æ—¥è®°æ•°æ®');
    return;
  }
  
  let html = '';
  diaries.forEach(diary => {
    const wordCount = diary.content.length;
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${diary.created_at.split('T')[0]}</div>
          <div class="stat-detail-item-mood">${getMoodEmoji(diary.mood)}</div>
        </div>
        <div class="stat-detail-item-title">${diary.title} <span style="color: #4CAF50; font-size: 12px;">(${wordCount}å­—)</span></div>
        <div class="stat-detail-item-content">${diary.content.substring(0, 100)}${diary.content.length > 100 ? '...' : ''}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// æ˜¾ç¤ºç©ºæ•°æ®
function displayEmptyDetail(list, message) {
  list.innerHTML = `
    <div class="stat-detail-empty">
      <div class="stat-detail-empty-icon">ğŸ“</div>
      <div class="stat-detail-empty-text">${message}</div>
    </div>
  `;
}

// è·å–å¿ƒæƒ…è¡¨æƒ…
function getMoodEmoji(mood) {
  const moodEmojis = {
    'happy': 'ğŸ˜Š',
    'calm': 'ğŸ˜Œ',
    'excited': 'â­',
    'sad': 'ğŸ˜¢',
    'angry': 'ğŸ˜ ',
    'neutral': 'ğŸ˜'
  };
  return moodEmojis[mood] || 'ğŸ˜';
}



// é—®é¢˜ç¼–è¾‘ç›¸å…³å‡½æ•°
function editQuestion(number, originalText) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const displayDiv = questionItem.querySelector('.question-display');
  const editDiv = questionItem.querySelector('.question-edit');
  const textarea = editDiv.querySelector('.question-edit-input');
  
  // æ˜¾ç¤ºç¼–è¾‘æ¨¡å¼
  displayDiv.style.display = 'none';
  editDiv.style.display = 'block';
  
  // è®¾ç½®åŸå§‹æ–‡æœ¬å¹¶èšç„¦
  textarea.value = originalText;
  textarea.focus();
  textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

function saveQuestion(number) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const displayDiv = questionItem.querySelector('.question-display');
  const editDiv = questionItem.querySelector('.question-edit');
  const textarea = editDiv.querySelector('.question-edit-input');
  const questionTextSpan = displayDiv.querySelector('.question-text');
  
  const newText = textarea.value.trim();
  
  if (newText) {
    // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
    questionTextSpan.textContent = newText;
    
    // åˆ‡æ¢å›æ˜¾ç¤ºæ¨¡å¼
    displayDiv.style.display = 'flex';
    editDiv.style.display = 'none';
    
    showNotification(`é—®é¢˜ ${number} å·²æ›´æ–°ï¼`, 'success');
  } else {
    showNotification('é—®é¢˜å†…å®¹ä¸èƒ½ä¸ºç©ºï¼', 'error');
  }
}

function cancelEditQuestion(number) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const displayDiv = questionItem.querySelector('.question-display');
  const editDiv = questionItem.querySelector('.question-edit');
  const textarea = editDiv.querySelector('.question-edit-input');
  
  // æ¢å¤åŸå§‹æ–‡æœ¬
  const originalText = displayDiv.querySelector('.question-text').textContent;
  textarea.value = originalText;
  
  // åˆ‡æ¢å›æ˜¾ç¤ºæ¨¡å¼
  displayDiv.style.display = 'flex';
  editDiv.style.display = 'none';
  
  showNotification('å·²å–æ¶ˆç¼–è¾‘', 'info');
}

// é”®ç›˜å¿«æ·é”®æ”¯æŒ
document.addEventListener('keydown', function(e) {
  // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼
  const activeEditDiv = document.querySelector('.question-edit[style*="display: block"]');
  if (activeEditDiv) {
    const textarea = activeEditDiv.querySelector('.question-edit-input');
    const questionNumber = textarea.getAttribute('data-question-number');
    
    if (e.key === 'Enter' && e.ctrlKey) {
      e.preventDefault();
      saveQuestion(questionNumber);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      cancelEditQuestion(questionNumber);
    }
  }
});

// ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­é—®é¢˜é€‰æ‹©å™¨
document.addEventListener('click', function(e) {
  const selectors = document.querySelectorAll('.question-selector');
  selectors.forEach(selector => {
    if (selector.style.display === 'block') {
      const questionItem = selector.closest('.question-item');
      if (questionItem && !questionItem.contains(e.target)) {
        const questionNumber = questionItem.getAttribute('data-question-number');
        closeQuestionSelector(questionNumber);
      }
    }
  });
});





// æ·»åŠ åŠ¨ç”»æ ·å¼
const style = document.createElement('style');
style.textContent = `
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  @keyframes slideInUp {
    from { 
      opacity: 0; 
      transform: translateY(30px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }
`;
document.head.appendChild(style);

// é—®é¢˜é€‰æ‹©å™¨ç›¸å…³å‡½æ•°
function showQuestionSelector(number, currentText) {
  // éšè—æ‰€æœ‰å…¶ä»–é€‰æ‹©å™¨
  document.querySelectorAll('.question-selector').forEach(selector => {
    selector.style.display = 'none';
  });
  
  const selector = document.querySelector(`[data-question-number="${number}"] .question-selector`);
  if (selector) {
    selector.style.display = 'block';
    
    // è®¾ç½®å½“å‰æ–‡æœ¬åˆ°è‡ªå®šä¹‰è¾“å…¥æ¡†
    const customInput = selector.querySelector('.custom-question-input');
    if (customInput) {
      customInput.value = currentText;
    }
  }
}

function closeQuestionSelector(number) {
  const selector = document.querySelector(`[data-question-number="${number}"] .question-selector`);
  if (selector) {
    selector.style.display = 'none';
  }
}

function selectQuestion(number, questionText) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const questionTextSpan = questionItem.querySelector('.question-text');
  
  // æ›´æ–°é—®é¢˜æ–‡æœ¬
  questionTextSpan.textContent = questionText;
  
  // å…³é—­é€‰æ‹©å™¨
  closeQuestionSelector(number);
  
  showNotification(`é—®é¢˜ ${number} å·²æ›´æ–°ï¼`, 'success');
}

function useCustomQuestion(number) {
  const selector = document.querySelector(`[data-question-number="${number}"] .question-selector`);
  const customInput = selector.querySelector('.custom-question-input');
  const customText = customInput.value.trim();
  
  if (customText) {
    selectQuestion(number, customText);
  } else {
    showNotification('è¯·è¾“å…¥è‡ªå®šä¹‰é—®é¢˜å†…å®¹ï¼', 'error');
  }
}





// æ—¥è®°æ‰“å¡æ—¥å†ç±»
class DiaryCheckInCalendar {
  constructor() {
    this.currentDate = new Date();
    this.currentYear = this.currentDate.getFullYear();
    this.currentMonth = this.currentDate.getMonth();
    this.calendarData = {};
    this.streak = { current: 0, longest: 0 };
    this.monthlyStats = {};
    
    this.init();
  }
  
  async init() {
    try {
      await this.loadCalendarData();
      this.renderCalendar();
      this.bindEvents();
      this.updateStats();
    } catch (error) {
      console.error('åˆå§‹åŒ–æ—¥è®°æ‰“å¡æ—¥å†å¤±è´¥:', error);
    }
  }
  
  async loadCalendarData() {
    try {
      const response = await fetch(`/tools/api/checkin/calendar/?type=diary&year=${this.currentYear}&month=${this.currentMonth + 1}`);
      const data = await response.json();
      
      if (data.success) {
        this.calendarData = data.calendar_data;
        this.streak = data.streak;
        this.monthlyStats = data.monthly_stats;
      }
    } catch (error) {
      console.error('åŠ è½½æ—¥è®°æ—¥å†æ•°æ®å¤±è´¥:', error);
    }
  }
  
  renderCalendar() {
    const firstDay = new Date(this.currentYear, this.currentMonth, 1);
    const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarBody = document.getElementById('diaryCalendarBody');
    if (!calendarBody) return;
    
    calendarBody.innerHTML = '';
    
    // æ›´æ–°æœˆä»½æ˜¾ç¤º
    const currentMonthElement = document.getElementById('diaryCurrentMonth');
    if (currentMonthElement) {
      currentMonthElement.textContent = `${this.currentYear}å¹´${this.currentMonth + 1}æœˆ`;
    }
    
    // æ›´æ–°è¿ç»­æ‰“å¡ä¿¡æ¯
    const currentStreakElement = document.getElementById('diaryCurrentStreak');
    const longestStreakElement = document.getElementById('diaryLongestStreak');
    if (currentStreakElement) currentStreakElement.textContent = this.streak.current;
    if (longestStreakElement) longestStreakElement.textContent = this.streak.longest;
    
    // ç”Ÿæˆæ—¥å†ç½‘æ ¼
    for (let i = 0; i < 42; i++) {
      const date = new Date(startDate);
      date.setDate(startDate.getDate() + i);
      
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
      
      const dateStr = date.toISOString().split('T')[0];
      const isCurrentMonth = date.getMonth() === this.currentMonth;
      const isToday = date.toDateString() === new Date().toDateString();
      const checkinData = this.calendarData[dateStr];
      
      if (!isCurrentMonth) {
        dayElement.classList.add('other-month');
      }
      
      if (isToday) {
        dayElement.classList.add('today');
      }
      
      if (checkinData) {
        dayElement.classList.add('has-checkin');
        if (checkinData.status === 'completed') {
          dayElement.classList.add('completed');
        } else if (checkinData.status === 'rest') {
          dayElement.classList.add('rest');
        }
      }
      
      dayElement.textContent = date.getDate();
      dayElement.setAttribute('data-date', dateStr);
      
      dayElement.addEventListener('click', () => this.handleDayClick(dateStr, checkinData));
      
      calendarBody.appendChild(dayElement);
    }
  }
  
  async handleDayClick(dateStr, checkinData) {
    const clickedDate = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºæœªæ¥æ—¥æœŸ
    if (clickedDate > today) {
      this.showNotification('ä¸èƒ½ä¸ºæœªæ¥æ—¥æœŸæ‰“å¡', 'error');
      return;
    }
    
    if (checkinData) {
      // æ˜¾ç¤ºæ‰“å¡è¯¦æƒ…
      this.showCheckinDetail(dateStr, checkinData);
    } else {
      // æ£€æŸ¥æ˜¯å¦ä¸ºè¿‡å»çš„æ—¥æœŸ
      if (clickedDate < today) {
        // æ˜¾ç¤ºäºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†
        this.showPastDateConfirmation(dateStr);
      } else {
        // ä»Šå¤©çš„æ—¥æœŸï¼Œç›´æ¥æ˜¾ç¤ºæ‰“å¡è¡¨å•
        this.showCheckinForm(dateStr);
      }
    }
  }

  showPastDateConfirmation(dateStr) {
    const confirmation = `
      <div class="checkin-modal">
        <div class="checkin-modal-content">
          <h3>ç¡®è®¤è¡¥æ‰“å¡</h3>
          <div class="confirmation-message">
            <i class="fas fa-exclamation-triangle" style="color: #ff6b35; font-size: 2rem; margin-bottom: 15px;"></i>
            <p>æ‚¨æ­£åœ¨ä¸º <strong>${dateStr}</strong> è¡¥æ‰“å¡ï¼Œè¿™æ˜¯ä¸€ä¸ªè¿‡å»çš„æ—¥æœŸã€‚</p>
            <p>è¯·ç¡®è®¤æ‚¨ç¡®å®åœ¨è¿™ä¸€å¤©å†™äº†æ—¥è®°ã€‚</p>
          </div>
          <div class="form-actions">
            <button class="btn-cancel">å–æ¶ˆ</button>
            <button class="btn-confirm">ç¡®è®¤è¡¥æ‰“å¡</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', confirmation);
    
    const modal = document.querySelector('.checkin-modal');
    
    modal.querySelector('.btn-cancel').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.querySelector('.btn-confirm').addEventListener('click', () => {
      modal.remove();
      this.showCheckinForm(dateStr);
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  showCheckinForm(dateStr) {
    const form = `
      <div class="checkin-modal">
        <div class="checkin-modal-content">
          <h3>æ·»åŠ æ—¥è®°æ‰“å¡ - ${dateStr}</h3>
          <form id="diaryCheckinForm">
            <div class="form-group">
              <label>å¿ƒæƒ…çŠ¶æ€</label>
              <select name="mood" required>
                <option value="happy">å¼€å¿ƒ</option>
                <option value="sad">éš¾è¿‡</option>
                <option value="angry">æ„¤æ€’</option>
                <option value="calm">å¹³é™</option>
                <option value="excited">å…´å¥‹</option>
                <option value="tired">ç–²æƒ«</option>
                <option value="other">å…¶ä»–</option>
              </select>
            </div>
            <div class="form-group">
              <label>å¤©æ°”</label>
              <input type="text" name="weather" placeholder="å¦‚ï¼šæ™´å¤©ã€é›¨å¤©ç­‰">
            </div>
            <div class="form-group">
              <label>å¤‡æ³¨</label>
              <textarea name="notes" rows="3" placeholder="è®°å½•ä»Šå¤©çš„å¿ƒæƒ…å’Œæ„Ÿå—..."></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-cancel">å–æ¶ˆ</button>
              <button type="submit" class="btn-submit">ä¿å­˜</button>
            </div>
          </form>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', form);
    
    const modal = document.querySelector('.checkin-modal');
    const formElement = document.getElementById('diaryCheckinForm');
    
    formElement.addEventListener('submit', (e) => {
      e.preventDefault();
      this.submitCheckin(dateStr, formElement);
    });
    
    modal.querySelector('.btn-cancel').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }
  
  showCheckinDetail(dateStr, checkinData) {
    const detail = `
      <div class="checkin-modal">
        <div class="checkin-modal-content">
          <h3>æ—¥è®°æ‰“å¡è¯¦æƒ… - ${dateStr}</h3>
          <div class="checkin-detail">
            <p><strong>çŠ¶æ€:</strong> ${checkinData.status === 'completed' ? 'å·²å®Œæˆ' : 'ä¼‘æ¯æ—¥'}</p>
            ${checkinData.detail ? `
              <p><strong>å¿ƒæƒ…:</strong> ${this.getMoodName(checkinData.detail.mood)}</p>
              <p><strong>å¤©æ°”:</strong> ${checkinData.detail.weather || 'æ— '}</p>
              <p><strong>å¤‡æ³¨:</strong> ${checkinData.detail.notes || 'æ— '}</p>
            ` : ''}
          </div>
          <div class="form-actions">
            <button class="btn-edit">ç¼–è¾‘</button>
            <button class="btn-delete">åˆ é™¤</button>
            <button class="btn-cancel">å…³é—­</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', detail);
    
    const modal = document.querySelector('.checkin-modal');
    
    modal.querySelector('.btn-cancel').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.querySelector('.btn-edit').addEventListener('click', () => {
      modal.remove();
      this.showCheckinForm(dateStr);
    });
    
    modal.querySelector('.btn-delete').addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿ')) {
        this.deleteCheckin(dateStr);
        modal.remove();
      }
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }
  
  async submitCheckin(dateStr, formElement) {
    const formData = new FormData(formElement);
    const detailData = {
      mood: formData.get('mood'),
      weather: formData.get('weather'),
      notes: formData.get('notes')
    };
    
    try {
      const response = await fetch('/tools/api/checkin/add/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          type: 'diary',
          date: dateStr,
          status: 'completed',
          detail: detailData
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        this.showNotification('æ‰“å¡æˆåŠŸï¼', 'success');
        document.querySelector('.checkin-modal').remove();
        await this.loadCalendarData();
        this.renderCalendar();
        this.updateStats();
      } else {
        this.showNotification(data.error || 'æ‰“å¡å¤±è´¥', 'error');
      }
    } catch (error) {
      console.error('æäº¤æ‰“å¡å¤±è´¥:', error);
      this.showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
  }
  
  async deleteCheckin(dateStr) {
    try {
      const response = await fetch('/tools/api/checkin/delete/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          type: 'diary',
          date: dateStr
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        this.showNotification('åˆ é™¤æˆåŠŸï¼', 'success');
        await this.loadCalendarData();
        this.renderCalendar();
        this.updateStats();
      } else {
        this.showNotification(data.error || 'åˆ é™¤å¤±è´¥', 'error');
      }
    } catch (error) {
      console.error('åˆ é™¤æ‰“å¡å¤±è´¥:', error);
      this.showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
  }
  
  updateStats() {
    if (this.monthlyStats) {
      const completedElement = document.getElementById('diaryMonthlyCompleted');
      const rateElement = document.getElementById('diaryMonthlyRate');
      
      if (completedElement) {
        completedElement.textContent = this.monthlyStats.completed_days || 0;
      }
      if (rateElement) {
        rateElement.textContent = `${this.monthlyStats.completion_rate || 0}%`;
      }
    }
  }
  
  bindEvents() {
    const prevBtn = document.getElementById('diaryPrevMonth');
    const nextBtn = document.getElementById('diaryNextMonth');
    const todayBtn = document.getElementById('diaryGoToday');
    
    if (prevBtn) {
      prevBtn.addEventListener('click', async () => {
        this.currentMonth--;
        if (this.currentMonth < 0) {
          this.currentMonth = 11;
          this.currentYear--;
        }
        await this.loadCalendarData();
        this.renderCalendar();
      });
    }
    
    if (nextBtn) {
      nextBtn.addEventListener('click', async () => {
        this.currentMonth++;
        if (this.currentMonth > 11) {
          this.currentMonth = 0;
          this.currentYear++;
        }
        await this.loadCalendarData();
        this.renderCalendar();
      });
    }
    
    if (todayBtn) {
      todayBtn.addEventListener('click', async () => {
        this.currentYear = new Date().getFullYear();
        this.currentMonth = new Date().getMonth();
        await this.loadCalendarData();
        this.renderCalendar();
      });
    }
  }
}

// åˆå§‹åŒ–æ—¥è®°æ‰“å¡æ—¥å†
let diaryCheckInCalendar = null;

// åˆå§‹åŒ–æ—¥è®°æ‰“å¡æ—¥å†
function initDiaryCheckInCalendar() {
  // å½“è¿›å…¥ç¬¬4æ­¥ï¼ˆç»Ÿè®¡é¡µé¢ï¼‰æ—¶åˆå§‹åŒ–æ‰“å¡æ—¥å†
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const statisticsSection = document.getElementById('statisticsSection');
        if (statisticsSection && statisticsSection.style.display !== 'none' && !diaryCheckInCalendar) {
          try {
            diaryCheckInCalendar = new DiaryCheckInCalendar();
          } catch (error) {
            console.error('åˆå§‹åŒ–æ—¥è®°æ‰“å¡æ—¥å†å¤±è´¥:', error);
          }
        }
      }
    });
  });
  
  // è§‚å¯Ÿç»Ÿè®¡éƒ¨åˆ†çš„å˜åŒ–
  const statisticsSection = document.getElementById('statisticsSection');
  if (statisticsSection) {
    observer.observe(statisticsSection, { attributes: true });
  }
}

// æ·»åŠ åŠ¨ç”»æ ·å¼
const slideInRight = document.createElement('style');
slideInRight.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(slideInRight);

</script>

{% endblock %}
