{% extends 'base.html' %}
{% load static %}

{% block tool_title_inner %}生活日记 - 层层递进{% endblock %}
{% block tool_title_display %}生活日记 - 层层递进{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'progressive_diary.css' %}">
<style>
/* 思考问题输入框样式 */
.question-input-group {
  margin-bottom: 20px;
  padding: 15px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  background: #fafafa;
  transition: all 0.3s ease;
}

.question-input-group:hover {
  border-color: #007bff;
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
}

.question-label {
  margin-bottom: 10px;
  font-weight: 600;
  color: #333;
}

.question-number {
  color: #007bff;
  font-weight: bold;
  margin-right: 8px;
}

.question-text {
  color: #555;
  line-height: 1.4;
}

.question-answer {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  font-size: 14px;
  line-height: 1.5;
  resize: vertical;
  transition: border-color 0.3s ease;
}

.question-answer:focus {
  border-color: #007bff;
  outline: none;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

/* 补充输入框样式 */
.additional-input-section {
  margin-top: 10px;
}

.additional-input {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 14px;
  line-height: 1.5;
  transition: border-color 0.3s ease;
  background-color: #f8f9fa;
}

.additional-input:focus {
  border-color: #28a745;
  outline: none;
  box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
  background-color: #fff;
}

.additional-input::placeholder {
  color: #6c757d;
  font-style: italic;
}

/* 可编辑问题样式 */
.question-item {
  margin-bottom: 15px;
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.question-display {
  padding: 15px;
  background: #f8f9fa;
  border: 2px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  transition: all 0.3s ease;
  position: relative;
}

.question-display:hover {
  background: #e9ecef;
  border-color: #007bff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.question-number {
  color: #ff8c00;
  font-weight: bold;
  font-size: 16px;
  min-width: 25px;
}

.question-text {
  color: #333;
  line-height: 1.6;
  flex: 1;
  font-size: 14px;
}

.edit-icon {
  color: #6c757d;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.question-display:hover .edit-icon {
  opacity: 1;
}

.question-edit {
  padding: 15px;
  background: #fff;
  border: 2px solid #007bff;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.question-edit-input {
  width: 100%;
  min-height: 80px;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.5;
  resize: vertical;
  margin-bottom: 10px;
  font-family: inherit;
}

.question-edit-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.question-edit-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.save-question-btn, .cancel-question-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.save-question-btn {
  background: #28a745;
  color: white;
}

.save-question-btn:hover {
  background: #218838;
  transform: translateY(-1px);
}

.cancel-question-btn {
  background: #6c757d;
  color: white;
}

.cancel-question-btn:hover {
  background: #5a6268;
  transform: translateY(-1px);
}

/* 音乐推荐区域样式 */
.music-recommendation {
  margin: 20px 0;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  color: white;
}

.music-header {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}

.music-header i {
  font-size: 20px;
  margin-right: 10px;
}

.music-header h4 {
  margin: 0;
  font-size: 18px;
}

.music-recommendation-content {
  margin-bottom: 15px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.music-recommendation-text {
  margin: 0;
}

.music-recommendation-text p {
  margin: 0;
  font-size: 14px;
  line-height: 1.5;
}

.music-search-section {
  background: rgba(255, 255, 255, 0.1);
  padding: 15px;
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.music-search-section h4 {
  margin: 0 0 10px 0;
  font-size: 16px;
}

.search-box {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.search-box input {
  flex: 1;
  border: none;
  border-radius: 6px;
  padding: 10px;
  background: rgba(255, 255, 255, 0.9);
  color: #333;
}

.search-box button {
  border: none;
  border-radius: 6px;
  padding: 10px 15px;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  cursor: pointer;
  transition: background 0.3s ease;
}

.search-box button:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* 搜索结果样式 */
.search-results {
  margin-top: 15px;
  max-height: 300px;
  overflow-y: auto;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.songs-list {
  padding: 10px;
}

.song-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  margin-bottom: 8px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.song-item:hover {
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.song-info {
  flex: 1;
}

.song-title {
  font-weight: 600;
  color: #333;
  margin-bottom: 4px;
}

.song-artist {
  font-size: 12px;
  color: #666;
}

.song-duration {
  font-size: 11px;
  color: #999;
}

.song-play-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.song-play-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.no-results {
  padding: 20px;
  text-align: center;
  color: #666;
  font-style: italic;
}

/* 确保音乐推荐区域在保存后也能显示 */
.music-recommendation[style*="display: none"] {
  display: block !important;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .question-input-group {
    padding: 12px;
  }
  
  .music-recommendation {
    padding: 15px;
  }
  
  .search-box {
    flex-direction: column;
  }
  
  .search-box button {
    width: 100%;
  }
}

@keyframes slideInUp {
  from { 
    opacity: 0; 
    transform: translateY(30px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

/* 问题选择器样式 */
.question-selector {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid #4CAF50;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 1000;
  max-height: 400px;
  overflow-y: auto;
}

/* 问题选择界面样式 */
.question-selection-container {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin: 20px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  border: 1px solid #e9ecef;
}

.selection-header {
  text-align: center;
  margin-bottom: 24px;
}

.selection-header h3 {
  color: #333;
  margin-bottom: 8px;
  font-size: 20px;
}

.selection-header p {
  color: #666;
  font-size: 14px;
  margin: 0;
}

.questions-selection-list {
  max-height: 400px;
  overflow-y: auto;
  margin-bottom: 20px;
}

.question-selection-item {
  display: flex;
  align-items: center;
  padding: 16px;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  margin-bottom: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  position: relative;
  overflow: hidden;
}

.question-selection-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
  transition: left 0.5s ease;
}

.question-selection-item:hover::before {
  left: 100%;
}

.question-selection-item:hover {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(76, 175, 80, 0.15);
}

.question-selection-item.selected {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  box-shadow: 0 4px 20px rgba(76, 175, 80, 0.25);
  transform: translateY(-1px);
}

.question-selection-item.selected::after {
  content: '✓';
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  animation: checkmarkAppear 0.3s ease;
}

.question-checkbox {
  margin-right: 16px;
  position: relative;
}

.question-select-checkbox {
  width: 20px;
  height: 20px;
  accent-color: #4CAF50;
  cursor: pointer;
  border-radius: 4px;
  border: 2px solid #ddd;
  transition: all 0.3s ease;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background: white;
  position: relative;
}

.question-select-checkbox:checked {
  border-color: #4CAF50;
  background-color: #4CAF50;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='white' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 9 4 4L15 3'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: center;
  background-size: 12px;
}

.question-content {
  flex: 1;
  display: flex;
  align-items: center;
}

.question-number {
  color: #4CAF50;
  font-weight: 600;
  margin-right: 12px;
  min-width: 24px;
  font-size: 15px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.question-text {
  color: #2c3e50;
  font-size: 15px;
  line-height: 1.6;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-weight: 400;
  letter-spacing: 0.2px;
}

.selection-actions {
  display: flex;
  justify-content: center;
  gap: 12px;
  padding-top: 16px;
  border-top: 1px solid #e9ecef;
}

.selection-actions .btn {
  padding: 10px 20px;
  font-size: 14px;
}

.selection-actions .btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.question-custom {
  padding: 12px 16px;
  border-top: 1px solid #e9ecef;
  background: #f8f9fa;
}

.question-custom label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-size: 13px;
  font-weight: 500;
}

.custom-question-input {
  width: 100%;
  min-height: 60px;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
  resize: vertical;
  margin-bottom: 8px;
}

.use-custom-btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.use-custom-btn:hover {
  background: #45a049;
}

/* 问题项相对定位 */
.question-item {
  position: relative;
}

/* 编辑图标样式 */
.edit-icon {
  color: #4CAF50;
  font-size: 14px;
  margin-left: 8px;
}

.question-display:hover .edit-icon {
  color: #45a049;
}

/* 问题选择器样式（用于编辑问题） */
.question-selector-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
  border-radius: 6px 6px 0 0;
}

.question-selector-header h4 {
  margin: 0;
  color: #333;
  font-size: 14px;
}

.close-selector-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: #666;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-selector-btn:hover {
  color: #333;
}

.question-options {
  padding: 8px 0;
}

.question-option {
  display: flex;
  align-items: flex-start;
  padding: 8px 16px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.question-option:hover {
  background-color: #f0f8ff;
}

.option-number {
  color: #4CAF50;
  font-weight: bold;
  margin-right: 8px;
  min-width: 20px;
}

.option-text {
  color: #333;
  font-size: 13px;
  line-height: 1.4;
}

.question-custom {
  padding: 12px 16px;
  border-top: 1px solid #e9ecef;
  background: #f8f9fa;
}

.question-custom label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-size: 13px;
  font-weight: 500;
}

.custom-question-input {
  width: 100%;
  min-height: 60px;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
  resize: vertical;
  margin-bottom: 8px;
}

.use-custom-btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.use-custom-btn:hover {
  background: #45a049;
}

/* AI预览中的问题选择样式 */
#aiContentPreview .question-selection-item {
  display: flex;
  align-items: center;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

#aiContentPreview .question-selection-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
  transition: left 0.5s ease;
}

#aiContentPreview .question-selection-item:hover::before {
  left: 100%;
}

#aiContentPreview .question-selection-item:hover {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(76, 175, 80, 0.15);
}

#aiContentPreview .question-selection-item.selected {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  box-shadow: 0 4px 20px rgba(76, 175, 80, 0.25);
  transform: translateY(-1px);
}

#aiContentPreview .question-selection-item.selected::after {
  content: '✓';
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  background: #4CAF50;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  animation: checkmarkAppear 0.3s ease;
}

@keyframes checkmarkAppear {
  from {
    opacity: 0;
    transform: scale(0);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

#aiContentPreview .question-checkbox {
  margin-right: 16px;
  position: relative;
}

#aiContentPreview .question-select-checkbox {
  width: 20px;
  height: 20px;
  accent-color: #4CAF50;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background: white;
  border: 2px solid #ddd;
  border-radius: 4px;
  transition: all 0.3s ease;
  position: relative;
}

#aiContentPreview .question-select-checkbox:checked {
  border-color: #4CAF50;
  background-color: #4CAF50;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='white' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 9 4 4L15 3'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: center;
  background-size: 12px;
}

#aiContentPreview .question-select-checkbox:checked + label {
  color: #4CAF50;
}

#aiContentPreview .question-select-checkbox:checked ~ .question-content .question-number {
  color: #45a049;
  font-weight: bold;
}

#aiContentPreview .question-select-checkbox:checked ~ .question-content .question-text {
  color: #2e7d32;
  font-weight: 600;
}

#aiContentPreview .question-content {
  flex: 1;
  display: flex;
  align-items: center;
}

#aiContentPreview .question-number {
  color: #4CAF50;
  font-weight: 600;
  margin-right: 12px;
  min-width: 24px;
  font-size: 15px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#aiContentPreview .question-text {
  color: #2c3e50;
  font-size: 15px;
  line-height: 1.6;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-weight: 400;
  letter-spacing: 0.2px;
}

/* 统计卡片样式 */
.statistics-section {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin: 20px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border: 1px solid #e9ecef;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #e9ecef;
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
  transition: left 0.5s ease;
}

.stat-card:hover::before {
  left: 100%;
}

.stat-card:hover {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
}

.stat-card.clicked {
  border-color: #4CAF50;
  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.25);
  transform: translateY(-2px);
}

.stat-icon {
  font-size: 32px;
  margin-bottom: 12px;
  display: block;
}

.stat-number {
  font-size: 28px;
  font-weight: 700;
  color: #2c3e50;
  margin-bottom: 8px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-label {
  font-size: 14px;
  color: #666;
  font-weight: 500;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* 详细数据弹窗样式 */
.stat-detail-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
}

.stat-detail-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  position: relative;
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.stat-detail-header {
  display: flex;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid #f0f0f0;
}

.stat-detail-icon {
  font-size: 40px;
  margin-right: 16px;
}

.stat-detail-title {
  font-size: 24px;
  font-weight: 700;
  color: #2c3e50;
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: none;
  border: none;
  font-size: 24px;
  color: #666;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.stat-detail-close:hover {
  background: #f0f0f0;
  color: #333;
}

.stat-detail-summary {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  text-align: center;
}

.stat-detail-summary-number {
  font-size: 36px;
  font-weight: 700;
  color: #4CAF50;
  margin-bottom: 8px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-summary-label {
  font-size: 16px;
  color: #666;
  font-weight: 500;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-list {
  max-height: 300px;
  overflow-y: auto;
}

.stat-detail-item {
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.stat-detail-item:hover {
  border-color: #4CAF50;
  background: #f8fff8;
  transform: translateX(4px);
}

.stat-detail-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.stat-detail-item-date {
  font-size: 14px;
  color: #4CAF50;
  font-weight: 600;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-item-mood {
  font-size: 20px;
}

.stat-detail-item-title {
  font-size: 16px;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 8px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.stat-detail-item-content {
  font-size: 14px;
  color: #666;
  line-height: 1.5;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.stat-detail-empty {
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.stat-detail-empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.stat-detail-empty-text {
  font-size: 16px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
</style>
{% endblock %}

{% block content %}
  <!-- 背景音乐控制 -->
  <div class="background-music-control" id="backgroundMusicControl" style="display: none;">
    <button class="bg-music-btn" id="bgMusicToggle" title="背景音乐控制">
      <i class="fas fa-music"></i>
    </button>
    <div class="bg-music-info" id="bgMusicInfo">
      <span id="bgMusicTitle">背景音乐</span>
    </div>
  </div>

  <!-- 统计详细数据弹窗 -->
  <div class="stat-detail-modal" id="statDetailModal">
    <div class="stat-detail-content">
      <button class="stat-detail-close" onclick="closeStatDetail()">
        <i class="fas fa-times"></i>
      </button>
      <div class="stat-detail-header">
        <div class="stat-detail-icon" id="statDetailIcon">📊</div>
        <h3 class="stat-detail-title" id="statDetailTitle">详细数据</h3>
      </div>
      <div class="stat-detail-summary">
        <div class="stat-detail-summary-number" id="statDetailSummaryNumber">0</div>
        <div class="stat-detail-summary-label" id="statDetailSummaryLabel">总计</div>
      </div>
      <div class="stat-detail-list" id="statDetailList">
        <!-- 详细数据将在这里动态生成 -->
      </div>
    </div>
  </div>

  <div class="progressive-diary-container">
    <div class="progressive-main">
      <!-- 进度指示器 -->
      <div class="progress-indicator">
      <div class="progress-steps">
        <div class="progress-step active" data-step="1">
          <div class="progress-circle">
            <i class="fas fa-heart"></i>
          </div>
          <div class="progress-label">今日心情</div>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" data-step="2">
          <div class="progress-circle">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="progress-label">今日完成</div>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" data-step="3">
          <div class="progress-circle">
            <i class="fas fa-pen-fancy"></i>
          </div>
          <div class="progress-label">生活记录</div>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" data-step="4">
          <div class="progress-circle">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="progress-label">生活统计</div>
        </div>
      </div>
    </div>

    <!-- 内容区域 -->
    <div class="progressive-content">
      <!-- 步骤1: 选择心情 -->
      <div class="step-page active" id="step1">
        <div class="step-title">
          <h2>选择今日心情</h2>
          <p>选择今天的心情状态，这将帮助我们为您生成更贴心的内容</p>
        </div>
        
        <!-- 心情选择 -->
        <div class="mood-selector">
          <div class="mood-options">
            <div class="mood-option" data-mood="happy">
              <i class="fas fa-laugh"></i>
              <span>开心</span>
            </div>
            <div class="mood-option" data-mood="calm">
              <i class="fas fa-smile"></i>
              <span>平静</span>
            </div>
            <div class="mood-option" data-mood="excited">
              <i class="fas fa-star"></i>
              <span>兴奋</span>
            </div>
            <div class="mood-option" data-mood="sad">
              <i class="fas fa-frown"></i>
              <span>难过</span>
            </div>
            <div class="mood-option" data-mood="angry">
              <i class="fas fa-angry"></i>
              <span>生气</span>
            </div>
            <div class="mood-option" data-mood="neutral">
              <i class="fas fa-meh"></i>
              <span>一般</span>
            </div>
          </div>
        </div>
        
        <div class="progressive-buttons">
          <div></div>
          <button class="btn btn-primary" id="nextToStep2" disabled>
            <span>今日完成</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- 步骤2: 今日完成 -->
      <div class="step-page" id="step2">
        <div class="step-title">
          <h2>今日完成</h2>
          <p>今天做了点啥，我来帮你总结</p>
        </div>
        
        <!-- 今日完成选择 -->
        <div class="goal-selector">
          <div class="goal-icons-grid">
            <div class="goal-icon-option" data-category="health">
              <i class="fas fa-dumbbell"></i>
              <span>健身</span>
            </div>
            <div class="goal-icon-option" data-category="learning">
              <i class="fas fa-book"></i>
              <span>学习</span>
            </div>
            <div class="goal-icon-option" data-category="career">
              <i class="fas fa-briefcase"></i>
              <span>工作</span>
            </div>
            <div class="goal-icon-option" data-category="relationship">
              <i class="fas fa-heart"></i>
              <span>感情</span>
            </div>
            <div class="goal-icon-option" data-category="finance">
              <i class="fas fa-coins"></i>
              <span>理财</span>
            </div>
            <div class="goal-icon-option" data-category="hobby">
              <i class="fas fa-palette"></i>
              <span>兴趣</span>
            </div>
            <div class="goal-icon-option" data-category="spiritual">
              <i class="fas fa-pray"></i>
              <span>冥想</span>
            </div>
            <div class="goal-icon-option" data-category="travel">
              <i class="fas fa-plane"></i>
              <span>旅行</span>
            </div>
            <div class="goal-icon-option" data-category="social">
              <i class="fas fa-users"></i>
              <span>社交</span>
            </div>
            <div class="goal-icon-option" data-category="creativity">
              <i class="fas fa-lightbulb"></i>
              <span>创意</span>
            </div>
            <div class="goal-icon-option" data-category="organization">
              <i class="fas fa-tasks"></i>
              <span>整理</span>
            </div>
            <div class="goal-icon-option" data-category="gratitude">
              <i class="fas fa-hands-helping"></i>
              <span>感恩</span>
            </div>
          </div>
        </div>
        
        <div class="progressive-buttons">
          <button class="btn btn-secondary" id="backToStep1">
            <i class="fas fa-arrow-left"></i>
            <span>上一步</span>
          </button>
          <button class="btn btn-primary" id="nextToStep3" disabled>
            <span>生成AI内容</span>
            <i class="fas fa-magic"></i>
          </button>
        </div>
      </div>

      <!-- 步骤3: 生活记录 -->
      <div class="step-page" id="step3">
        <div class="step-title">
          <h2>生活记录</h2>
          <p>写下当下最真实的感受</p>
        </div>
        
        <div class="ai-generation-container">
          <div class="ai-loading" id="aiLoading">
            <div class="loading-spinner">
              <i class="fas fa-magic"></i>
            </div>
            <div class="loading-text">
              <h3>AI正在为您创作...</h3>
              <p>记下当前的心情，AI正在为您准备有趣的思考问题</p>
            </div>
          </div>
          
          <div class="ai-content-preview" id="aiContentPreview" style="display: none;">
            <div class="preview-header">
              <i class="fas fa-magic"></i>
              <span>AI为您生成的内容</span>
            </div>
            <div class="preview-content" id="previewContent">
              <!-- AI生成的内容将在这里显示 -->
            </div>
            
            <!-- 音乐推荐区域 -->
            <div class="music-recommendation" id="musicRecommendation" style="display: none;">
              <div class="music-header">
                <i class="fas fa-music"></i>
                <h4>🎵 音乐推荐</h4>
              </div>
              <div class="music-recommendation-content" id="musicRecommendationContent">
                <!-- 音乐推荐内容将在这里显示 -->
              </div>
              <!-- 网易云音乐搜索区域 -->
              <div class="music-search-section">
                <h4>🔍 搜索网易云音乐</h4>
                <div class="search-box">
                  <input 
                    type="text" 
                    id="musicSearchInput" 
                    class="form-control" 
                    placeholder="输入歌曲名或歌手..."
                  >
                  <button id="searchMusicBtn" class="btn" onclick="searchNeteaseMusic()">
                    <i class="fas fa-search"></i> 搜索
                  </button>
                </div>
                <div id="searchResults" class="search-results" style="display: none;">
                  <!-- 搜索结果将在这里显示 -->
                </div>
              </div>
            </div>
            
            <div class="preview-actions">
              <button class="btn btn-secondary" id="regenerateContent">
                <i class="fas fa-sync-alt"></i>
                <span>重新生成</span>
              </button>
              <button class="btn btn-primary" id="useGeneratedContent">
                <i class="fas fa-check"></i>
                <span>使用此内容</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- 日记编辑表单 -->
        <div class="diary-form-container" id="diaryFormContainer" style="display: none;">
          
          <div class="form-group">
            <label for="diaryTitle">日记标题</label>
            <input type="text" id="diaryTitle" class="form-control" placeholder="为今天的生活记录起个标题...">
          </div>
          
          <div class="form-group">
            <label>生活记录内容</label>
            <div class="questions-container" id="questionsContainer">
              <!-- 10个问题输入框将在这里动态生成 -->
            </div>
          </div>
          

        </div>
        
        <div class="progressive-buttons">
          <button class="btn btn-secondary" id="backToStep2">
            <i class="fas fa-arrow-left"></i>
            <span>上一步</span>
          </button>
          <button class="btn btn-primary" id="completeDiary" disabled style="display: none;">
            <i class="fas fa-check"></i>
            <span>保存记录</span>
          </button>
        </div>
      </div>

      <!-- 步骤4: 生活统计 -->
      <div class="step-page" id="step4">
        <div class="step-title">
          <h2>生活统计</h2>
          <p>查看您的生活记录统计和成就</p>
        </div>
        
        <!-- 生活统计 -->
        <div class="statistics-section" id="statisticsSection" style="display: none;">
            <h3>📊 生活统计</h3>
            <div class="stats-grid">
                <div class="stat-card" id="totalDiaryDaysCard">
                    <div class="stat-icon">📅</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalDiaryDays">0</div>
                        <div class="stat-label">日记天数</div>
                    </div>
                </div>
                <div class="stat-card" id="totalDiaryCountCard">
                    <div class="stat-icon">📝</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalDiaryCount">0</div>
                        <div class="stat-label">日记次数</div>
                    </div>
                </div>
                <div class="stat-card" id="happyDaysCard">
                    <div class="stat-icon">😊</div>
                    <div class="stat-content">
                        <div class="stat-number" id="happyDays">0</div>
                        <div class="stat-label">开心天数</div>
                    </div>
                </div>
                <div class="stat-card" id="totalWordsCard">
                    <div class="stat-icon">📖</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalWords">0</div>
                        <div class="stat-label">总字数</div>
                    </div>
                </div>
            </div>
            
            <!-- 心情趋势图 -->
            <div class="mood-trend-section">
                <h4>📈 心情趋势</h4>
                <div class="mood-chart-container">
                    <canvas id="moodChart"></canvas>
                </div>
                <div class="mood-stats-summary" id="moodStatsSummary">
                    <!-- 心情统计摘要将在这里显示 -->
                </div>
            </div>
        </div>
        
        <div class="progressive-buttons">
          <button class="btn btn-secondary" id="backToStep3">
            <i class="fas fa-arrow-left"></i>
            <span>上一步</span>
          </button>
          <button class="btn btn-primary" id="finishDiary">
            <i class="fas fa-home"></i>
            <span>完成</span>
          </button>
        </div>
      </div>

      <!-- 完成页面 -->
      <div class="step-page" id="completion">
        <div class="completion-page">
          <div class="completion-icon">
            <i class="fas fa-star"></i>
          </div>
          <div class="completion-title">🎉 太棒了！</div>
          <div class="completion-message">
            您的生活记录已完美保存！<br>
            每一天的记录都是您成长的见证，<br>
            继续保持这份美好，您的人生将更加精彩！
          </div>
          
          <div class="completion-stats">
            <div class="completion-stat-item">
              <i class="fas fa-heart"></i>
              <span>心情记录</span>
            </div>
            <div class="completion-stat-item">
              <i class="fas fa-pen"></i>
              <span>生活感悟</span>
            </div>
            <div class="completion-stat-item">
              <i class="fas fa-bullseye"></i>
              <span>目标设定</span>
            </div>
          </div>
          
          <div class="completion-quote">
            "生活不是等待暴风雨过去，而是学会在雨中跳舞。"
          </div>
          

          
          <div class="progressive-buttons">
            <button class="btn btn-primary" id="startNewDiary">
              <i class="fas fa-plus"></i>
              <span>继续记录美好</span>
            </button>
            <a href="/tools/life-mode/" class="btn btn-secondary">
              <i class="fas fa-home"></i>
              <span>返回主页</span>
            </a>
          </div>
        </div>
              </div>
      </div>
    </div>
  </div>

  <!-- 日记详情弹窗 -->
  <div class="diary-modal" id="diaryModal">
    <div class="diary-modal-content">
      <div class="diary-modal-header">
        <button class="diary-modal-close" id="closeDiaryModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="diary-modal-body" id="diaryModalBody">
        <!-- 内容将在这里显示 -->
      </div>
    </div>
  </div>

  <script>
// 全局变量
let currentStep = 1;
let selectedMood = null;
let selectedGoalCategories = [];
let diaryData = {
  title: '',
  content: '',
  mood: '',
  goal_category: ''
};

// 初始化页面
document.addEventListener('DOMContentLoaded', function() {
  initGoalSelector();
  initMoodSelector();
  initNavigation();
  loadTodayData();
  
  // 背景音乐控制
  document.getElementById('bgMusicToggle').addEventListener('click', toggleBackgroundMusic);
  
  // 音乐搜索功能已恢复
  
  // 临时调试：强制启用保存按钮
  setTimeout(() => {
    const saveButton = document.getElementById('completeDiary');
    if (saveButton) {
      console.log('强制启用保存按钮');
      saveButton.disabled = false;
    }
  }, 2000);
  
  // 初始化心情图表
  setTimeout(() => {
    const canvas = document.getElementById('moodChart');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width = canvas.offsetWidth;
      const height = canvas.height = 300;
      ctx.clearRect(0, 0, width, height);
      
      // 检查是否有选中的心情
      const currentMood = getCurrentPageMood();
      if (currentMood) {
        renderTemporaryMoodChart(ctx, width, height, currentMood);
      } else {
        // 显示引导信息
        ctx.fillStyle = '#666';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('请先选择今日心情', width / 2, height / 2);
        ctx.fillStyle = '#999';
        ctx.font = '14px Arial';
        ctx.fillText('选择心情后将显示预览图表', width / 2, height / 2 + 30);
      }
    }
  }, 1000);

});

// 目标选择器
function initGoalSelector() {
  const goalOptions = document.querySelectorAll('.goal-icon-option');
  const nextButton = document.getElementById('nextToStep3');
  
  goalOptions.forEach(option => {
    option.addEventListener('click', function() {
      const category = this.dataset.category;
      
      // 切换选中状态
      if (this.classList.contains('selected')) {
        this.classList.remove('selected');
        selectedGoalCategories = selectedGoalCategories.filter(cat => cat !== category);
      } else {
        this.classList.add('selected');
        selectedGoalCategories.push(category);
      }
      
      diaryData.goal_categories = selectedGoalCategories;
      
      // 检查是否选择了目标
      checkStep2Completion();
      if (selectedGoalCategories.length > 0) {
        showGoalFeedback(selectedGoalCategories);
      } else {
        hideGoalFeedback();
      }
    });
  });
}

// 检查步骤2是否完成
function checkStep2Completion() {
  const nextButton = document.getElementById('nextToStep3');
  nextButton.disabled = selectedGoalCategories.length === 0;
}

// 检查步骤1是否完成
function checkStep1Completion() {
  const nextButton = document.getElementById('nextToStep2');
  nextButton.disabled = !selectedMood;
}

// 显示心情选择反馈
function showMoodFeedback(mood) {
  const moodTexts = {
    'happy': '😊 太棒了！今天心情不错，继续保持这份快乐！',
    'calm': '😌 内心平静是最大的智慧，您做得很好！',
    'excited': '⭐ 充满期待的一天！您的热情感染着周围的人！',
    'sad': '😢 没关系，每个雨天都会过去，阳光总在风雨后！',
    'angry': '😠 深呼吸，保持冷静，您比任何困难都强大！',
    'neutral': '😐 平淡也是一种美好，享受这份宁静吧！'
  };
  
  showNotification(moodTexts[mood] || moodTexts.neutral, 'success');
}

// 显示目标选择反馈
function showGoalFeedback(categories) {
  const goalTexts = {
    'health': '健身',
    'learning': '学习',
    'career': '工作',
    'relationship': '感情',
    'finance': '理财',
    'hobby': '兴趣',
    'spiritual': '冥想',
    'travel': '旅行',
    'social': '社交',
    'creativity': '创意',
    'organization': '整理',
    'gratitude': '感恩'
  };
  
  const selectedGoals = categories.map(cat => goalTexts[cat]).join('、');
  const message = `🎯 今天完成了：${selectedGoals}！您真是多才多艺，生活丰富多彩！`;
  
  showNotification(message, 'success');
}

// 隐藏目标反馈
function hideGoalFeedback() {
  // 可以在这里添加隐藏反馈的逻辑
}

// 心情选择器
function initMoodSelector() {
  const moodOptions = document.querySelectorAll('.mood-option');
  
  moodOptions.forEach(option => {
    option.addEventListener('click', function() {
      moodOptions.forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      
      selectedMood = this.dataset.mood;
      diaryData.mood = selectedMood;
      
      // 检查是否同时选择了心情和目标
      checkStep1Completion();
      showMoodFeedback(selectedMood);
    });
  });
}

// 导航控制
function initNavigation() {
  // 安全地添加事件监听器
  const nextToStep2 = document.getElementById('nextToStep2');
  const nextToStep3 = document.getElementById('nextToStep3');
  const backToStep1 = document.getElementById('backToStep1');
  const backToStep2 = document.getElementById('backToStep2');
  const backToStep3 = document.getElementById('backToStep3');
  const completeDiaryBtn = document.getElementById('completeDiary');
  const startNewDiaryBtn = document.getElementById('startNewDiary');
  const finishDiaryBtn = document.getElementById('finishDiary');
  const regenerateContentBtn = document.getElementById('regenerateContent');
  const useGeneratedContentBtn = document.getElementById('useGeneratedContent');
  const diaryDaysCard = document.getElementById('totalDiaryCard');
  const closeDiaryModalBtn = document.getElementById('closeDiaryModal');
  const diaryModal = document.getElementById('diaryModal');
  const diaryTitle = document.getElementById('diaryTitle');
  const diaryContent = document.getElementById('diaryContent');
  
  if (nextToStep2) nextToStep2.addEventListener('click', () => goToStep(2));
  if (nextToStep3) nextToStep3.addEventListener('click', () => goToStep(3));
  if (backToStep1) backToStep1.addEventListener('click', () => goToStep(1));
  if (backToStep2) backToStep2.addEventListener('click', () => goToStep(2));
  if (backToStep3) backToStep3.addEventListener('click', () => goToStep(3));
  if (completeDiaryBtn) completeDiaryBtn.addEventListener('click', completeDiary);
  if (startNewDiaryBtn) startNewDiaryBtn.addEventListener('click', resetDiary);
  if (finishDiaryBtn) finishDiaryBtn.addEventListener('click', finishDiary);
  
  // AI内容生成相关
  if (regenerateContentBtn) regenerateContentBtn.addEventListener('click', generateAIContent);
  if (useGeneratedContentBtn) useGeneratedContentBtn.addEventListener('click', useGeneratedContent);
  
  // 监听日记天数卡片点击事件
  if (diaryDaysCard) diaryDaysCard.addEventListener('click', showDiaryDetails);
  
  // 监听弹窗关闭事件
  if (closeDiaryModalBtn) closeDiaryModalBtn.addEventListener('click', closeDiaryModal);
  if (diaryModal) {
    diaryModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeDiaryModal();
      }
    });
  }
  
  // 表单验证
  if (diaryTitle) diaryTitle.addEventListener('input', validateStep3);
  if (diaryContent) diaryContent.addEventListener('input', validateStep3);
}

// 步骤导航
function goToStep(step) {
  if (step < 1 || step > 5) return;
  
  currentStep = step;
  
  document.querySelectorAll('.step-page').forEach(page => {
    page.classList.remove('active');
  });
  
  if (step === 5) {
    document.getElementById('completion').classList.add('active');
  } else {
    document.getElementById(`step${step}`).classList.add('active');
  }
  
  updateProgressIndicator(step);
  
  if (step === 3) {
    // 确保心情数据存在
    if (!selectedMood) {
      selectedMood = 'neutral';
      diaryData.mood = selectedMood;
    }
    generateAIContent();
  }
  
  if (step === 4) {
    loadStatistics();
  }
}

// 更新进度指示器
function updateProgressIndicator(step) {
  const steps = document.querySelectorAll('.progress-step');
  
  steps.forEach((stepElement, index) => {
    const stepNumber = index + 1;
    stepElement.classList.remove('active', 'completed');
    
    if (stepNumber < step) {
      stepElement.classList.add('completed');
    } else if (stepNumber === step) {
      stepElement.classList.add('active');
    }
  });
}

// 验证步骤3
function validateStep3() {
  const diaryTitle = document.getElementById('diaryTitle');
  const nextButton = document.getElementById('completeDiary');
  
  // 安全地获取标题
  const title = diaryTitle ? diaryTitle.value.trim() : '';
  
  console.log('validateStep3 被调用。');
  console.log('标题:', title);

  // 确保心情数据存在（从第一步获取）
  if (!selectedMood) {
    // 如果第一步没有选择心情，默认设置为一般
    selectedMood = 'neutral';
    diaryData.mood = selectedMood;
  }
  
  // 检查是否有任何问题回答和补充说明
  const questionAnswers = document.querySelectorAll('.question-answer');
  let totalContent = '';
  
  questionAnswers.forEach((textarea, index) => {
    if (textarea) {
      const answer = textarea.value.trim();
      const question = textarea.dataset.question;
      const additionalInput = document.getElementById(`additionalInput${index + 1}`);
      const additionalAnswer = additionalInput ? additionalInput.value.trim() : '';
      
      if (answer) {
        totalContent += `${question}\n回答: ${answer}`;
        if (additionalAnswer) {
          totalContent += `\n补充: ${additionalAnswer}`;
        }
        totalContent += '\n\n';
      }
    }
  });
  
  // 新的验证逻辑：只要有标题就可以保存
  const hasAnyContent = title.length > 0;
  
  // 安全地设置按钮状态
  if (nextButton) {
    nextButton.disabled = !hasAnyContent;
    console.log('按钮应该启用:', hasAnyContent);
    console.log('按钮当前 disabled 状态:', nextButton.disabled);
    
    // 强制确保按钮状态正确
    if (hasAnyContent) {
      nextButton.disabled = false;
      console.log('强制启用按钮');
    }
  }
  
  diaryData.title = title;
  diaryData.content = totalContent;
  
  // 添加问题输入框和补充输入框的实时验证（只在第一次调用时添加）
  if (!questionAnswers[0] || !questionAnswers[0].hasEventListener) {
    questionAnswers.forEach((textarea, index) => {
      if (textarea && !textarea.hasEventListener) {
        textarea.addEventListener('input', validateStep3);
        textarea.hasEventListener = true;
      }
      
      // 为补充输入框添加事件监听器
      const additionalInput = document.getElementById(`additionalInput${index + 1}`);
      if (additionalInput && !additionalInput.hasEventListener) {
        additionalInput.addEventListener('input', validateStep3);
        additionalInput.hasEventListener = true;
      }
    });
  }
}

// 生成AI内容和音乐推荐
async function generateAIContent() {
  // 确保心情数据存在
  if (!selectedMood) {
    selectedMood = 'neutral';
    diaryData.mood = selectedMood;
  }
  
  if (selectedGoalCategories.length === 0) {
    showNotification('请先选择今日完成的内容！', 'error');
    return;
  }
  
  const loadingDiv = document.getElementById('aiLoading');
  const previewDiv = document.getElementById('aiContentPreview');
  const musicDiv = document.getElementById('musicRecommendation');
  
  loadingDiv.style.display = 'block';
  previewDiv.style.display = 'none';
  musicDiv.style.display = 'none';
  
  try {
    // 构建提示词
    const goalTexts = {
      'health': '健身',
      'learning': '学习',
      'career': '工作',
      'relationship': '感情',
      'finance': '理财',
      'hobby': '兴趣',
      'spiritual': '冥想',
      'travel': '旅行',
      'social': '社交',
      'creativity': '创意',
      'organization': '整理',
      'gratitude': '感恩'
    };
    
    const moodTexts = {
      'happy': '开心',
      'calm': '平静',
      'excited': '兴奋',
      'sad': '难过',
      'angry': '生气',
      'neutral': '一般'
    };
    
    const selectedGoals = selectedGoalCategories.map(cat => goalTexts[cat]).join('、');
    
         const prompt = `请根据以下信息为我生成10个有趣且引人深思的问题和1首推荐的音乐：
     
     心情状态：${moodTexts[selectedMood]}
     今日完成：${selectedGoals}
     
     要求：
     1. 生成10个问题，涵盖以下方面：
        - 今天最让你笑出声的瞬间是什么？
        - 如果今天是一部电影，你会给它起什么名字？
        - 今天遇到的人中，谁让你印象最深刻？
        - 如果可以和今天的自己对话，你会说什么？
        - 今天有什么事情让你感到意外惊喜？
        - 如果今天可以重来一次，你会改变什么？
        - 今天最想和谁分享你的心情？
        - 今天学到了什么新东西？
        - 明天最期待的事情是什么？
        - 今天有什么让你感到特别感恩的？
     
     2. 问题要：
        - 有趣且富有想象力
        - 语言生动活泼，有故事感
        - 结合具体的心情和完成的事情
        - 让人想要深入思考和回答
        - 用中文写作，语气轻松愉快
     
     3. 推荐1首音乐：
        - 根据心情状态推荐
        - 音乐风格要多样化，不要太固定
        - 可以是流行、古典、轻音乐、民谣等不同风格
        - 音乐要能配合当前的心情和状态
     
     请按照以下格式输出，每个问题后留空行，音乐信息单独列出：
     【10个疑问句】
     1. [第一个问题]\n\n
     2. [第二个问题]\n\n
     3. [第三个问题]\n\n
     4. [第四个问题]\n\n
     5. [第五个问题]\n\n
     6. [第六个问题]\n\n
     7. [第七个问题]\n\n
     8. [第八个问题]\n\n
     9. [第九个问题]\n\n
     10. [第十个问题]\n\n
     【推荐音乐】\n
     [音乐名称] - [艺术家]`;
    
    const response = await fetch('/tools/api/deepseek/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        prompt: prompt,
        max_tokens: 500,
        temperature: 0.8
      })
    });
    
    const data = await response.json();
    
        if (data.success) {
      // 显示AI生成的内容，格式化显示
      const formattedContent = formatContentForDisplay(data.content);
      document.getElementById('previewContent').innerHTML = formattedContent;
      showNotification('AI内容生成成功！', 'success');
    } else {
      // DeepSeek API调用失败，使用备用内容
      console.warn('DeepSeek API调用失败:', data.error);
      const fallbackContent = generateFallbackContent(selectedMood, selectedGoalCategories);
      const formattedContent = formatContentForDisplay(fallbackContent);
      document.getElementById('previewContent').innerHTML = formattedContent;
      showNotification('AI生成内容暂时不可用，已为你生成温暖的备用内容！', 'warning');
    }
    
    loadingDiv.style.display = 'none';
    previewDiv.style.display = 'block';
    document.getElementById('nextToStep3').style.display = 'inline-flex';
    
    // 添加问题选择事件监听器
    addQuestionSelectionListeners();
    
    // 获取音乐推荐
    await getMusicRecommendation();
  } catch (error) {
    console.error('生成AI内容失败:', error);
    // 使用备用内容
    const fallbackContent = generateFallbackContent(selectedMood, selectedGoalCategories);
    const formattedContent = formatContentForDisplay(fallbackContent);
    document.getElementById('previewContent').innerHTML = formattedContent;
    showNotification('AI生成内容暂时不可用，已为你生成温暖的备用内容！', 'warning');
    
    loadingDiv.style.display = 'none';
    previewDiv.style.display = 'block';
    document.getElementById('nextToStep3').style.display = 'inline-flex';
    
    // 添加问题选择事件监听器
    addQuestionSelectionListeners();
    
    // 获取音乐推荐
    await getMusicRecommendation();
  }
}

// 生成备用内容
function generateFallbackContent(mood, goalCategories) {
  const moodTexts = {
    'happy': '开心',
    'calm': '平静',
    'excited': '兴奋',
    'sad': '难过',
    'angry': '生气',
    'neutral': '一般'
  };
  
  const goalTexts = {
    'health': '健身',
    'learning': '学习',
    'career': '工作',
    'relationship': '感情',
    'finance': '理财',
    'hobby': '兴趣',
    'spiritual': '冥想',
    'travel': '旅行',
    'social': '社交',
    'creativity': '创意',
    'organization': '整理',
    'gratitude': '感恩'
  };
  
  const selectedGoals = goalCategories.map(cat => goalTexts[cat]).join('、');
  const moodText = moodTexts[mood] || '一般';
  
  const musicRecommendations = {
    'happy': ['晴天 - 周杰伦', '稻香 - 周杰伦', '小幸运 - 田馥甄', '告白气球 - 周杰伦', '夜空中最亮的星 - 逃跑计划'],
    'calm': ['月光 - 王心凌', '安静 - 周杰伦', '天空之城 - 久石让', 'River Flows In You - Yiruma', 'Kiss The Rain - Yiruma'],
    'excited': ['追梦赤子心 - GALA', '海阔天空 - Beyond', '光辉岁月 - Beyond', '真心英雄 - 成龙', '奔跑 - 羽泉'],
    'sad': ['后来 - 刘若英', '童话 - 光良', '可惜没如果 - 林俊杰', '演员 - 薛之谦', '泡沫 - 邓紫棋'],
    'angry': ['怒放的生命 - 汪峰', '存在 - 汪峰', '勇敢的心 - 汪峰', '飞得更高 - 汪峰', '春天里 - 汪峰'],
    'neutral': ['平凡之路 - 朴树', '那些花儿 - 朴树', '白桦林 - 朴树', '生如夏花 - 朴树', '且听风吟 - 朴树']
  };
  
  const questions = [
    `今天完成了${selectedGoals}，最让你笑出声的瞬间是什么？`,
    `如果今天是一部电影，你会给它起什么名字？`,
    `今天遇到的人中，谁让你印象最深刻？`,
    `如果可以和今天的自己对话，你会说什么？`,
    `今天有什么事情让你感到意外惊喜？`,
    `如果今天可以重来一次，你会改变什么？`,
    `今天最想和谁分享你的${moodText}心情？`,
    `今天学到了什么新东西？`,
    `明天最期待的事情是什么？`,
    `今天有什么让你感到特别感恩的？`
  ];
  
  const selectedMusic = musicRecommendations[mood][Math.floor(Math.random() * musicRecommendations[mood].length)];
  
  let content = '【10个疑问句】\n';
  questions.forEach((question, index) => {
    content += `${index + 1}. ${question}\n\n`;
  });
  content += '【推荐音乐】\n';
  content += selectedMusic;
  
  return content;
}



// 显示日记详情
async function showDiaryDetails() {
  try {
    const response = await fetch('/tools/api/life-diary/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'get_diary_list'
      })
    });
    
    const data = await response.json();
    
    if (data.success && data.diaries) {
      const modalBody = document.getElementById('diaryModalBody');
      let html = '';
      
      if (data.diaries.length === 0) {
        html = `
          <div class="no-diary-message">
            <i class="fas fa-book-open"></i>
            <h3>还没有日记记录</h3>
            <p>开始记录您的生活点滴吧！</p>
          </div>
        `;
      } else {
        data.diaries.forEach(diary => {
          const moodEmojis = {
            'happy': '😊',
            'calm': '😌',
            'excited': '⭐',
            'sad': '😢',
            'angry': '😠',
            'neutral': '😐'
          };
          
          const moodTexts = {
            'happy': '开心',
            'calm': '平静',
            'excited': '兴奋',
            'sad': '难过',
            'angry': '生气',
            'neutral': '一般'
          };
          
          const date = new Date(diary.created_at).toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
          });
          
          // 处理问题回答
          let questionAnswersHtml = '';
          if (diary.question_answers && diary.question_answers.length > 0) {
            questionAnswersHtml = `
              <div class="diary-questions">
                <h4><i class="fas fa-question-circle"></i> 思考问题</h4>
                ${diary.question_answers.map(qa => `
                  <div class="question-item">
                    <div class="question-text">${qa.question}</div>
                    <div class="answer-text">${qa.answer}</div>
                    ${qa.additional_answer ? `<div class="additional-answer">补充：${qa.additional_answer}</div>` : ''}
                  </div>
                `).join('')}
              </div>
            `;
          }
          
          // 处理音乐推荐
          let musicRecommendationHtml = '';
          if (diary.music_recommendation) {
            musicRecommendationHtml = `
              <div class="diary-music">
                <h4><i class="fas fa-music"></i> 音乐推荐</h4>
                <div class="music-text">${diary.music_recommendation}</div>
              </div>
            `;
          }
          
          // 处理标签
          let tagsHtml = '';
          if (diary.tags && diary.tags.length > 0) {
            tagsHtml = `
              <div class="diary-tags">
                ${diary.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            `;
          }
          
          html += `
            <div class="diary-item">
              <div class="diary-header">
                <div class="diary-date">
                  <i class="fas fa-calendar"></i>
                  <span>${date}</span>
                </div>
                <div class="diary-mood ${diary.mood}">
                  <i class="fas fa-heart"></i>
                  <span>${moodEmojis[diary.mood]} ${moodTexts[diary.mood]}</span>
                </div>
              </div>
              <div class="diary-title">${diary.title}</div>
              <div class="diary-content">${diary.content}</div>
              ${diary.mood_note ? `<div class="diary-mood-note">${diary.mood_note}</div>` : ''}
              ${tagsHtml}
              ${questionAnswersHtml}
              ${musicRecommendationHtml}
            </div>
          `;
        });
      }
      
      modalBody.innerHTML = html;
      document.getElementById('diaryModal').style.display = 'block';
    } else {
      showNotification('获取日记列表失败', 'error');
    }
  } catch (error) {
    console.error('获取日记详情失败:', error);
    showNotification('获取日记详情失败', 'error');
  }
}



// 关闭日记详情弹窗
function closeDiaryModal() {
  document.getElementById('diaryModal').style.display = 'none';
}



// 获取音乐推荐
async function getMusicRecommendation() {
  try {
    // 根据心情选择音乐模式
    const moodToMode = {
      'happy': 'life',
      'calm': 'life',
      'excited': 'training',
      'sad': 'emo',
      'angry': 'training',
      'neutral': 'work'
    };
    
    const musicMode = moodToMode[selectedMood] || 'life';
    
    const response = await fetch('/tools/api/music/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'get_random_song',
        mode: musicMode
      })
    });
    
    const data = await response.json();
    
    if (data.success && data.song) {
      // 显示音乐推荐区域
      document.getElementById('musicRecommendation').style.display = 'block';
      showNotification('音乐推荐加载成功！', 'success');
    } else {
      console.log('音乐推荐加载失败');
      // 显示音乐推荐区域
      document.getElementById('musicRecommendation').style.display = 'block';
    }
  } catch (error) {
    console.error('获取音乐推荐失败:', error);
    // 显示音乐推荐区域
    document.getElementById('musicRecommendation').style.display = 'block';
  }
}

// 搜索网易云音乐
async function searchNeteaseMusic() {
  // 确定当前激活的搜索框
  let searchInput, searchBtn, searchResults;
  
  // 检查哪个搜索框有内容
  const input1 = document.getElementById('musicSearchInput');
  const input2 = document.getElementById('musicSearchInputForm');
  
  if (input1 && input1.value.trim()) {
    searchInput = input1;
    searchBtn = document.getElementById('searchMusicBtn');
    searchResults = document.getElementById('searchResults');
  } else if (input2 && input2.value.trim()) {
    searchInput = input2;
    searchBtn = document.getElementById('searchMusicBtnForm');
    searchResults = document.getElementById('searchResultsForm');
  } else {
    // 如果都没有内容，使用第一个
    searchInput = input1 || input2;
    searchBtn = document.getElementById('searchMusicBtn') || document.getElementById('searchMusicBtnForm');
    searchResults = document.getElementById('searchResults') || document.getElementById('searchResultsForm');
  }
  
  const keyword = searchInput.value.trim();
  if (!keyword) {
    showNotification('请输入搜索关键词！', 'error');
    return;
  }
  
  const originalText = searchBtn.innerHTML;
  searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  searchBtn.disabled = true;
  
  try {
    const response = await fetch(`/tools/api/music/?action=netease_search&keyword=${encodeURIComponent(keyword)}`, {
      method: 'GET',
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    const data = await response.json();
    
    if (data.success && data.data && data.data.length > 0) {
      displaySearchResults(data.data, searchResults);
      showNotification(`找到 ${data.data.length} 首相关歌曲！`, 'success');
    } else {
      searchResults.innerHTML = '<div class="no-results">未找到相关歌曲，请尝试其他关键词</div>';
      searchResults.style.display = 'block';
      showNotification('未找到相关歌曲', 'warning');
    }
  } catch (error) {
    console.error('搜索音乐失败:', error);
    showNotification('搜索失败，请重试', 'error');
  } finally {
    searchBtn.innerHTML = originalText;
    searchBtn.disabled = false;
  }
}

// 显示搜索结果
function displaySearchResults(songs, resultsContainer) {
  if (!resultsContainer) {
    resultsContainer = document.getElementById('searchResults') || document.getElementById('searchResultsForm');
  }
  
  let html = '<div class="songs-list">';
  
  songs.forEach((song, index) => {
           html += `
         <div class="song-item" onclick="playSelectedSong('${song.play_url}', '${song.name}', '${song.artist}')">
           <div class="song-info">
             <div class="song-title">${song.name}</div>
             <div class="song-artist">${song.artist}</div>
             <div class="song-duration">${song.duration}</div>
           </div>
           <div class="song-play-btn" title="设为背景音乐">
             <i class="fas fa-music"></i>
           </div>
         </div>
       `;
  });
  
  html += '</div>';
  resultsContainer.innerHTML = html;
  resultsContainer.style.display = 'block';
}

// 播放选中的歌曲（背景音乐）
function playSelectedSong(playUrl, songName, artistName) {
  // 创建或获取全局背景音乐播放器
  let backgroundAudio = window.backgroundAudio;
  if (!backgroundAudio) {
    backgroundAudio = new Audio();
    backgroundAudio.loop = true; // 循环播放
    window.backgroundAudio = backgroundAudio;
  }
  
  backgroundAudio.src = playUrl;
  backgroundAudio.play().then(() => {
    // 显示背景音乐控制
    document.getElementById('backgroundMusicControl').style.display = 'flex';
    document.getElementById('bgMusicTitle').textContent = `${songName} - ${artistName}`;
    
    // 更新按钮状态
    const bgMusicBtn = document.getElementById('bgMusicToggle');
    bgMusicBtn.innerHTML = '<i class="fas fa-pause"></i>';
    bgMusicBtn.title = '暂停背景音乐';
    
    showNotification(`🎵 背景音乐已设置: ${songName} - ${artistName}`, 'success');
  }).catch(error => {
    console.error('播放失败:', error);
    // 提供网易云链接，让用户去网易云播放
    const neteaseUrl = `https://music.163.com/#/search/m/?s=${encodeURIComponent(songName + ' ' + artistName)}&type=1`;
    showNotification(`🎵 无法直接播放，请前往网易云音乐搜索播放: ${songName} - ${artistName}`, 'info');
    
    // 可选：自动打开网易云搜索页面
    setTimeout(() => {
      if (confirm('是否要打开网易云音乐搜索页面？')) {
        window.open(neteaseUrl, '_blank');
      }
    }, 1000);
  });
  
  // 隐藏搜索结果
  document.getElementById('searchResults').style.display = 'none';
}

// 切换背景音乐播放/暂停
function toggleBackgroundMusic() {
  const backgroundAudio = window.backgroundAudio;
  if (!backgroundAudio) return;
  
  const bgMusicBtn = document.getElementById('bgMusicToggle');
  
  if (backgroundAudio.paused) {
    backgroundAudio.play();
    bgMusicBtn.innerHTML = '<i class="fas fa-pause"></i>';
    bgMusicBtn.title = '暂停背景音乐';
  } else {
    backgroundAudio.pause();
    bgMusicBtn.innerHTML = '<i class="fas fa-play"></i>';
    bgMusicBtn.title = '播放背景音乐';
  }
}





// 使用AI生成的内容
function useGeneratedContent() {
  // 获取选中的问题
  const selectedQuestions = getSelectedQuestionsFromPreview();
  
  if (selectedQuestions.length === 0) {
    showNotification('请至少选择一个问题！', 'error');
    return;
  }
  
  // 保存选中的问题到全局变量
  window.selectedQuestions = selectedQuestions;
  
  // 隐藏AI预览，显示日记编辑表单
  document.getElementById('aiContentPreview').style.display = 'none';
  document.getElementById('diaryFormContainer').style.display = 'block';
  
  // 显示"保存记录"按钮
  document.getElementById('completeDiary').style.display = 'inline-flex';
  
  // 生成选中问题的输入框
  generateSelectedQuestionInputs(selectedQuestions);
  
  // 设置心情选择
  document.querySelectorAll('#diaryFormContainer .mood-option').forEach(option => {
    option.classList.remove('selected');
    if (option.dataset.mood === selectedMood) {
      option.classList.add('selected');
    }
  });
  
  // 触发验证
  validateStep3();
  
  showNotification(`已选择 ${selectedQuestions.length} 个问题，请填写您的答案！`, 'success');
}

// 从AI预览中获取选中的问题
function getSelectedQuestionsFromPreview() {
  const selectedQuestions = [];
  const checkboxes = document.querySelectorAll('#aiContentPreview .question-select-checkbox');
  
  checkboxes.forEach((checkbox, index) => {
    if (checkbox.checked) {
      const questionItem = checkbox.closest('.question-selection-item');
      const question = questionItem.getAttribute('data-question');
      const originalIndex = questionItem.getAttribute('data-index');
      selectedQuestions.push({
        index: parseInt(originalIndex),
        question: question
      });
    }
  });
  
  return selectedQuestions;
}

// 解析AI生成的问题
function parseAIQuestions(content) {
  const lines = content.split('\n');
  let questions = [];
  let music = '';
  
  for (const line of lines) {
    const trimmedLine = line.trim();
    if (trimmedLine === '') continue;
    
    if (trimmedLine.includes('🎵 音乐推荐：')) {
      music = trimmedLine.replace('🎵 音乐推荐：', '');
      continue;
    }
    
    // 匹配数字编号的疑问句 (例如 "1. 你的问题?")
    const questionMatch = trimmedLine.match(/^(\d+)\.\s*(.*)/);
    if (questionMatch) {
      questions.push(questionMatch[2]); // 提取问题内容
    } else if (trimmedLine.startsWith('• ')) {
      questions.push(trimmedLine.substring(2));
    } else if (!trimmedLine.includes('🎵')) {
      questions.push(trimmedLine);
    }
  }
  
  // 保存音乐推荐信息
  window.currentMusicRecommendation = music;
  
  return questions.filter(q => q.trim() !== '');
}

// 显示问题选择界面
function showQuestionSelectionInterface(questions) {
  // 隐藏AI预览，显示问题选择界面
  document.getElementById('aiContentPreview').style.display = 'none';
  
  // 创建问题选择界面
  const selectionContainer = document.createElement('div');
  selectionContainer.id = 'questionSelectionContainer';
  selectionContainer.className = 'question-selection-container';
  
  let html = `
    <div class="selection-header">
      <h3><i class="fas fa-check-circle"></i> 选择您想回答的问题</h3>
      <p>请选择您想要回答的问题，这些问题将作为您今天的生活记录内容</p>
    </div>
    <div class="questions-selection-list">
  `;
  
  questions.forEach((question, index) => {
    html += `
      <div class="question-selection-item" data-question="${question}" data-index="${index}">
        <div class="question-checkbox">
          <input type="checkbox" id="question${index}" class="question-select-checkbox">
          <label for="question${index}"></label>
        </div>
        <div class="question-content">
          <span class="question-number">${index + 1}.</span>
          <span class="question-text">${question}</span>
        </div>
      </div>
    `;
  });
  
  html += `
    </div>
    <div class="selection-actions">
      <button class="btn btn-secondary" onclick="selectAllQuestions()">
        <i class="fas fa-check-double"></i> 全选
      </button>
      <button class="btn btn-secondary" onclick="deselectAllQuestions()">
        <i class="fas fa-times"></i> 取消全选
      </button>
      <button class="btn btn-primary" onclick="confirmSelectedQuestions()">
        <i class="fas fa-arrow-right"></i> 确认选择并继续
      </button>
    </div>
  `;
  
  selectionContainer.innerHTML = html;
  
  // 插入到AI预览的位置
  const aiPreview = document.getElementById('aiContentPreview');
  aiPreview.parentNode.insertBefore(selectionContainer, aiPreview.nextSibling);
  
  // 添加事件监听器
  addQuestionSelectionListeners();
}

// 添加问题选择事件监听器
function addQuestionSelectionListeners() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  const questionItems = document.querySelectorAll('.question-selection-item');
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateSelectionStatus();
      updateQuestionItemStyle(this);
    });
  });
  
  // 为整个问题项添加点击事件
  questionItems.forEach(item => {
    item.addEventListener('click', function(e) {
      // 如果点击的是复选框本身，不重复处理
      if (e.target.type === 'checkbox') return;
      
      const checkbox = this.querySelector('.question-select-checkbox');
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateSelectionStatus();
        updateQuestionItemStyle(checkbox);
      }
    });
  });
  
  // 初始化选择状态
  updateSelectionStatus();
}

// 更新选择状态
function updateSelectionStatus() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  const totalCount = checkboxes.length;
  
  // 更新"使用此内容"按钮状态
  const useContentBtn = document.getElementById('useGeneratedContent');
  if (useContentBtn) {
    if (selectedCount > 0) {
      useContentBtn.innerHTML = `<i class="fas fa-check"></i><span>使用此内容 (${selectedCount}/${totalCount})</span>`;
      useContentBtn.disabled = false;
    } else {
      useContentBtn.innerHTML = `<i class="fas fa-check"></i><span>请至少选择一个问题</span>`;
      useContentBtn.disabled = true;
    }
  }
}

// 全选问题
function selectAllQuestions() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = true;
  });
  updateSelectionStatus();
}

// 取消全选
function deselectAllQuestions() {
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
  updateSelectionStatus();
}

// 确认选择的问题
function confirmSelectedQuestions() {
  const selectedQuestions = [];
  const checkboxes = document.querySelectorAll('.question-select-checkbox');
  
  checkboxes.forEach((checkbox, index) => {
    if (checkbox.checked) {
      const questionItem = checkbox.closest('.question-selection-item');
      const question = questionItem.getAttribute('data-question');
      selectedQuestions.push({
        index: index,
        question: question
      });
    }
  });
  
  if (selectedQuestions.length === 0) {
    showNotification('请至少选择一个问题！', 'error');
    return;
  }
  
  // 保存选中的问题到全局变量
  window.selectedQuestions = selectedQuestions;
  
  // 隐藏选择界面，显示日记编辑表单
  document.getElementById('questionSelectionContainer').style.display = 'none';
  document.getElementById('diaryFormContainer').style.display = 'block';
  
  // 生成选中问题的输入框
  generateSelectedQuestionInputs(selectedQuestions);
  
  // 设置心情选择
  document.querySelectorAll('#diaryFormContainer .mood-option').forEach(option => {
    option.classList.remove('selected');
    if (option.dataset.mood === selectedMood) {
      option.classList.add('selected');
    }
  });
  
  // 触发验证
  validateStep3();
  
  showNotification(`已选择 ${selectedQuestions.length} 个问题，请填写您的答案！`, 'success');
}

// 生成选中问题的输入框
function generateSelectedQuestionInputs(selectedQuestions) {
  const container = document.getElementById('questionsContainer');
  container.innerHTML = '';
  
  // 为每个选中的问题生成输入框
  selectedQuestions.forEach((questionData, index) => {
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-input-group';
    questionDiv.innerHTML = `
      <div class="question-label">
        <span class="question-number">${index + 1}.</span>
        <span class="question-text">${questionData.question}</span>
      </div>
      <textarea 
        id="question${index + 1}" 
        class="form-control question-answer" 
        rows="4" 
        placeholder="请分享您的想法..."
        data-question="${questionData.question}"
        data-original-index="${questionData.index}"
      ></textarea>
      <div class="additional-input-section">
        <input 
          type="text" 
          id="additionalInput${index + 1}" 
          class="form-control additional-input" 
          placeholder="补充说明..."
          data-question="${questionData.question}"
        >
      </div>
    `;
    container.appendChild(questionDiv);
  });
  
  // 添加事件监听器
  addQuestionInputListeners();
}

// 添加问题输入框事件监听器
function addQuestionInputListeners() {
  const questionAnswers = document.querySelectorAll('.question-answer');
  const additionalInputs = document.querySelectorAll('.additional-input');
  
  questionAnswers.forEach((textarea, index) => {
    if (textarea && !textarea.hasEventListener) {
      textarea.addEventListener('input', validateStep3);
      textarea.hasEventListener = true;
    }
  });
  
  additionalInputs.forEach((input, index) => {
    if (input && !input.hasEventListener) {
      input.addEventListener('input', validateStep3);
      input.hasEventListener = true;
    }
  });
}

// 生成问题输入框（保留原函数以兼容）
function generateQuestionInputs(content) {
  // 这个函数现在被generateSelectedQuestionInputs替代
  console.warn('generateQuestionInputs已废弃，请使用generateSelectedQuestionInputs');
}

// 切换问题输入框显示/隐藏
function toggleQuestionInput(questionNumber) {
  console.log('toggleQuestionInput 被调用，问题编号:', questionNumber);
  
  const inputWrapper = document.getElementById(`inputWrapper${questionNumber}`);
  const icon = document.getElementById(`icon${questionNumber}`);
  
  console.log('找到的元素:', { inputWrapper, icon });
  
  if (!inputWrapper || !icon) {
    console.error('找不到元素:', questionNumber);
    return;
  }
  
  const questionHeader = icon.closest('.question-header');
  console.log('当前显示状态:', inputWrapper.style.display);
  
  if (inputWrapper.style.display === 'none') {
    // 展开输入框
    console.log('展开输入框');
    inputWrapper.style.display = 'block';
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-up');
    if (questionHeader) {
      questionHeader.classList.add('active');
    }
    
    // 聚焦到输入框
    setTimeout(() => {
      const textarea = document.getElementById(`question${questionNumber}`);
      if (textarea) {
        textarea.focus();
      }
    }, 100);
  } else {
    // 收起输入框
    console.log('收起输入框');
    inputWrapper.style.display = 'none';
    icon.classList.remove('fa-chevron-up');
    icon.classList.add('fa-chevron-down');
    if (questionHeader) {
      questionHeader.classList.remove('active');
    }
  }
}

// 格式化内容用于编辑
function formatContentForEditing(content) {
  // 移除【10个疑问句】和【推荐音乐】标记，并清理多余的空行
  let processedContent = content
    .replace(/【10个疑问句】\n*/g, '') // 移除标题和其后的换行
    .replace(/【推荐音乐】\n*/g, '') // 移除标题和其后的换行
    .trim(); // 清理整体内容的空白

  const lines = processedContent.split('\n');
  let questions = [];
  let music = '';
  let inMusicSection = false; // 标记是否进入音乐信息部分

  for (const line of lines) {
    const trimmedLine = line.trim();
    if (trimmedLine === '') {
      continue; // 跳过空行
    }

    // 尝试匹配音乐信息行 (例如 "歌曲名 - 艺术家")
    // 并且确保我们还没有找到音乐信息，避免重复或错误匹配
    if (trimmedLine.includes(' - ') && !music && !inMusicSection) {
        music = trimmedLine;
        inMusicSection = true; // 标记已找到音乐信息
        continue;
    }

    // 匹配数字编号的疑问句 (例如 "1. 你的问题?")
    const questionMatch = trimmedLine.match(/^(\d+)\.\s*(.*)/);
    if (questionMatch) {
      questions.push(`• ${questionMatch[2]}`); // 转换为圆点列表格式
    } else if (!inMusicSection) {
      // 如果不是编号问题，也不是音乐信息，且未进入音乐部分，则作为普通文本行处理
      // 这可以捕获AI可能生成的非编号文本
      questions.push(trimmedLine);
    }
  }

  // 将所有处理过的疑问句用双换行符连接，确保每句独立
  let finalOutput = questions.join('\n\n');

  // 添加音乐推荐信息
  if (music) {
    if (finalOutput) {
      finalOutput += '\n\n'; // 如果前面有内容，则添加双换行分隔
    }
    finalOutput += `🎵 音乐推荐：${music}`;
  }

  // 确保最终输出有良好的排版
  finalOutput = finalOutput
    .replace(/\n{3,}/g, '\n\n') // 将3个或更多换行符替换为2个
    .trim(); // 清理首尾空白

  return finalOutput;
}

// 格式化内容用于显示
function formatContentForDisplay(content) {
  let formatted = content;
  // 确保内容开始干净
  formatted = formatted.trim();

  // 替换【10个疑问句】为美观的标题
  formatted = formatted.replace(/【10个疑问句】/, '<h3><span style="color: #ff8c00;">&#128161;</span> 选择您想回答的问题</h3><p style="color: #666; margin-bottom: 20px;">请选择您想要回答的问题，这些问题将作为您今天的生活记录内容</p>');
  // 替换【推荐音乐】为美观的标题
  formatted = formatted.replace(/【推荐音乐】/, '<h3><span style="color: #ff8c00;">&#127925;</span> 音乐推荐</h3>');

  // 将数字编号的疑问句转换为可选择的形式
  formatted = formatted.replace(/(\d+)\.\s*(.*?)(?=\n\n|\n【|\Z)/gs, (match, number, text) => {
    // 避免将音乐信息误判为问题
    if (text.includes(' - ') && text.includes('🎵 音乐推荐：')) {
        return match; // 如果看起来像音乐信息，则不处理
    }
    const questionText = text.trim();
    return `
      <div class="question-selection-item" data-question="${questionText}" data-index="${parseInt(number) - 1}">
        <div class="question-checkbox">
          <input type="checkbox" id="question${parseInt(number) - 1}" class="question-select-checkbox">
          <label for="question${parseInt(number) - 1}"></label>
        </div>
        <div class="question-content">
          <span class="question-number">${number}.</span>
          <span class="question-text">${questionText}</span>
        </div>
      </div>
    `;
  });

  // 将换行符转换为 <br> 标签，以便在HTML中正确显示
  formatted = formatted.replace(/\n\n+/g, '<br><br>'); // 将多个换行符转换为双 <br>
  formatted = formatted.replace(/\n/g, '<br>'); // 将单个换行符转换为单 <br>

  return formatted;
}



// 完成日记
async function completeDiary() {
  console.log('completeDiary 函数被触发。');
  console.log('当前 diaryData:', diaryData);

  // 确保心情数据存在
  if (!diaryData.mood || diaryData.mood === '') {
    diaryData.mood = selectedMood || 'neutral';
  }
  
  // 收集所有问题回答和补充说明
  const questionAnswers = document.querySelectorAll('.question-answer');
  let totalContent = '';
  let questionAnswersData = [];
  
  questionAnswers.forEach((textarea, index) => {
    if (textarea) {
      const answer = textarea.value.trim();
      const question = textarea.dataset.question;
      const originalIndex = textarea.dataset.originalIndex;
      const additionalInput = document.getElementById(`additionalInput${index + 1}`);
      const additionalAnswer = additionalInput ? additionalInput.value.trim() : '';
      
      if (answer) {
        // 构建问题+答案的内容
        let questionAnswerContent = `问题：${question}\n回答：${answer}`;
        if (additionalAnswer) {
          questionAnswerContent += `\n补充：${additionalAnswer}`;
        }
        totalContent += questionAnswerContent + '\n\n';
        
        // 收集问题答案数据用于保存
        questionAnswersData.push({
          question: question,
          answer: answer,
          additional_answer: additionalAnswer,
          order: parseInt(originalIndex) + 1
        });
      }
    }
  });
  
  // 新的验证逻辑：只要有标题就可以保存
  if (!diaryData.title) {
    showNotification('请至少填写标题！', 'error');
    return;
  }
  
  // 如果没有回答，使用默认内容
  if (!totalContent) {
    totalContent = '今天的心情和感悟';
  }
  
  diaryData.content = totalContent;
  console.log('尝试保存的数据:', diaryData);
  console.log('问题答案数据:', questionAnswersData);
  
  const completeButton = document.getElementById('completeDiary');
  if (!completeButton) {
    showNotification('保存按钮未找到！', 'error');
    return;
  }
  
  const originalText = completeButton.innerHTML;
  completeButton.innerHTML = '<span class="loading"></span> 保存中...';
  completeButton.disabled = true;
  
  try {
    const csrfToken = getCookie('csrftoken');
    
    // 收集音乐推荐信息
    const musicRecommendation = window.currentMusicRecommendation || '';
    
    const response = await fetch('/tools/api/life-diary/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        action: 'save_diary',
        title: diaryData.title,
        content: diaryData.content,
        mood: diaryData.mood,
        mood_note: '',
        tags: [],
        question_answers: questionAnswersData,
        music_recommendation: musicRecommendation
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification('🎉 生活记录保存成功！', 'success');
      goToStep(4); // 保存成功后跳转到统计页面
    } else {
      showNotification(data.error || '保存失败', 'error');
    }
  } catch (error) {
    console.error('保存日记失败:', error);
    showNotification('保存失败，请重试', 'error');
  } finally {
    completeButton.innerHTML = originalText;
    completeButton.disabled = false;
  }
}

// 加载统计数据
async function loadStatistics() {
  try {
    console.log('开始加载统计数据...');
    
    // 显示统计区域
    const statisticsSection = document.getElementById('statisticsSection');
    if (statisticsSection) {
      statisticsSection.style.display = 'block';
      console.log('显示统计区域');
    } else {
      console.error('找不到statisticsSection元素');
    }
    
    const response = await fetch('/tools/api/life-diary/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'get_statistics'
      })
    });
    
    const data = await response.json();
    console.log('统计数据响应:', data);
    
    if (data.success) {
      console.log('统计数据:', data.data);
      
      // 更新统计数字
      const totalDiaryDaysElement = document.getElementById('totalDiaryDays');
      const totalDiaryCountElement = document.getElementById('totalDiaryCount');
      const happyDaysElement = document.getElementById('happyDays');
      const totalWordsElement = document.getElementById('totalWords');
      
      if (totalDiaryDaysElement) {
        totalDiaryDaysElement.textContent = data.data.total_diary_days || 0;
        console.log('更新日记天数:', data.data.total_diary_days || 0);
      } else {
        console.error('找不到totalDiaryDays元素');
      }
      
      if (totalDiaryCountElement) {
        totalDiaryCountElement.textContent = data.data.total_diary_count || 0;
        console.log('更新日记次数:', data.data.total_diary_count || 0);
      } else {
        console.error('找不到totalDiaryCount元素');
      }
      
      if (happyDaysElement) {
        happyDaysElement.textContent = data.data.happy_days;
        console.log('更新开心天数:', data.data.happy_days);
      } else {
        console.error('找不到happyDays元素');
      }
      
      if (totalWordsElement) {
        totalWordsElement.textContent = data.data.total_words || 0;
        console.log('更新总字数:', data.data.total_words || 0);
      } else {
        console.error('找不到totalWords元素');
      }
      
      // 渲染心情趋势
      renderMoodChart(data.data);
      
      // 添加统计卡片点击事件监听器
      addStatCardListeners();
      
      // 添加心情选择监听器
      addMoodSelectionListener();
    } else {
      console.error('统计数据加载失败:', data.error);
    }
  } catch (error) {
    console.error('加载统计数据失败:', error);
  }
}

// 渲染心情趋势图表
function renderMoodChart(moodData) {
  const canvas = document.getElementById('moodChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const width = canvas.width = canvas.offsetWidth;
  const height = canvas.height = 300;
  
  // 清空画布
  ctx.clearRect(0, 0, width, height);
  
  // 检查是否有后端数据
  if (!moodData || !moodData.mood_timeline || moodData.mood_timeline.length === 0) {
    // 尝试从页面上的当前数据生成临时图表
    const currentMood = getCurrentPageMood();
    if (currentMood) {
      renderTemporaryMoodChart(ctx, width, height, currentMood);
      return;
    } else {
      // 显示无数据提示
      ctx.fillStyle = '#666';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('暂无心情数据', width / 2, height / 2);
      return;
    }
  }
  
  // 更新的心情等级映射（与后端权重对应）
  const moodLevels = {
    'happy': 5,        // 非常积极
    'excited': 5,      // 兴奋
    'grateful': 4,     // 感恩
    'inspired': 4,     // 受启发
    'confident': 4,    // 自信
    'calm': 4,         // 平静
    'content': 3,      // 满足
    'neutral': 3,      // 中性
    'worried': 2,      // 担心
    'tired': 2,        // 疲惫
    'sad': 1,          // 悲伤
    'anxious': 1,      // 焦虑
    'stressed': 1,     // 压力
    'frustrated': 1,   // 沮丧
    'angry': 0         // 愤怒
  };
  
  // 准备数据 - 使用实际的时间线数据
  const timeline = moodData.mood_timeline;
  const dates = [];
  const levels = [];
  
  // 获取最近14天的数据，如果数据不足则使用所有可用数据
  const recentData = timeline.slice(-14);
  
  recentData.forEach(item => {
    const date = new Date(item.date);
    const dateStr = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    dates.push(dateStr);
    levels.push(moodLevels[item.mood] || 3);
  });
  
  // 如果数据点太少，添加一些空数据点以保持图表美观
  while (dates.length < 7) {
    const lastDate = dates.length > 0 ? new Date(timeline[timeline.length - 1].date) : new Date();
    const newDate = new Date(lastDate);
    newDate.setDate(newDate.getDate() - (7 - dates.length));
    const dateStr = newDate.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    dates.unshift(dateStr);
    levels.unshift(3); // 中性心情
  }
  
  // 绘制坐标轴
  ctx.strokeStyle = '#ddd';
  ctx.lineWidth = 1;
  
  // Y轴
  ctx.beginPath();
  ctx.moveTo(50, 30);
  ctx.lineTo(50, height - 50);
  ctx.stroke();
  
  // X轴
  ctx.beginPath();
  ctx.moveTo(50, height - 50);
  ctx.lineTo(width - 30, height - 50);
  ctx.stroke();
  
  // Y轴标签
  ctx.fillStyle = '#666';
  ctx.font = '12px Arial';
  ctx.textAlign = 'right';
  const yLabels = ['愤怒', '消极', '担心', '中性', '积极'];
  for (let i = 0; i < 5; i++) {
    const y = height - 50 - (i * (height - 80) / 4);
    ctx.fillText(yLabels[i], 45, y + 4);
  }
  
  // X轴标签
  ctx.textAlign = 'center';
  dates.forEach((date, index) => {
    const x = 50 + (index * (width - 80) / (dates.length - 1));
    ctx.fillText(date, x, height - 30);
  });
  
  // 绘制心情曲线
  ctx.strokeStyle = '#4CAF50';
  ctx.lineWidth = 3;
  ctx.beginPath();
  
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / (levels.length - 1));
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    if (index === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  ctx.stroke();
  
  // 绘制数据点
  ctx.fillStyle = '#4CAF50';
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / (levels.length - 1));
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, 2 * Math.PI);
    ctx.fill();
  });
  
  // 添加趋势指示器
  if (moodData.mood_trend) {
    const trendText = {
      'improving': '📈 心情改善中',
      'declining': '📉 心情下降中',
      'stable': '➡️ 心情稳定'
    };
    
    ctx.fillStyle = '#333';
    ctx.font = '14px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(trendText[moodData.mood_trend] || '未知趋势', 60, 25);
    
    // 添加置信度信息
    if (moodData.trend_confidence) {
      const confidenceText = {
        'high': '高置信度',
        'medium': '中等置信度',
        'low': '低置信度'
      };
      ctx.fillStyle = '#666';
      ctx.font = '12px Arial';
      ctx.fillText(`置信度: ${confidenceText[moodData.trend_confidence]}`, 60, 45);
      }
}

// 获取当前页面上的心情数据
function getCurrentPageMood() {
  // 检查是否有选中的心情
  const selectedMoodOption = document.querySelector('.mood-option.selected');
  if (selectedMoodOption) {
    const moodText = selectedMoodOption.querySelector('span').textContent;
    // 将中文心情转换为英文标识符
    const moodMapping = {
      '开心': 'happy',
      '兴奋': 'excited',
      '平静': 'calm',
      '满足': 'content',
      '一般': 'neutral',
      '担心': 'worried',
      '疲惫': 'tired',
      '难过': 'sad',
      '焦虑': 'anxious',
      '压力': 'stressed',
      '沮丧': 'frustrated',
      '生气': 'angry',
      '感恩': 'grateful',
      '受启发': 'inspired',
      '自信': 'confident'
    };
    return moodMapping[moodText] || 'neutral';
  }
  
  // 检查全局变量
  if (window.selectedMood) {
    return window.selectedMood;
  }
  
  return null;
}

// 渲染临时心情图表
function renderTemporaryMoodChart(ctx, width, height, currentMood) {
  // 心情等级映射
  const moodLevels = {
    'happy': 5,
    'excited': 5,
    'grateful': 4,
    'inspired': 4,
    'confident': 4,
    'calm': 4,
    'content': 3,
    'neutral': 3,
    'worried': 2,
    'tired': 2,
    'sad': 1,
    'anxious': 1,
    'stressed': 1,
    'frustrated': 1,
    'angry': 0
  };
  
  const currentLevel = moodLevels[currentMood] || 3;
  
  // 绘制坐标轴
  ctx.strokeStyle = '#ddd';
  ctx.lineWidth = 1;
  
  // Y轴
  ctx.beginPath();
  ctx.moveTo(50, 30);
  ctx.lineTo(50, height - 50);
  ctx.stroke();
  
  // X轴
  ctx.beginPath();
  ctx.moveTo(50, height - 50);
  ctx.lineTo(width - 30, height - 50);
  ctx.stroke();
  
  // Y轴标签
  ctx.fillStyle = '#666';
  ctx.font = '12px Arial';
  ctx.textAlign = 'right';
  const yLabels = ['愤怒', '消极', '担心', '中性', '积极'];
  for (let i = 0; i < 5; i++) {
    const y = height - 50 - (i * (height - 80) / 4);
    ctx.fillText(yLabels[i], 45, y + 4);
  }
  
  // 生成模拟数据（基于当前心情）
  const dates = [];
  const levels = [];
  const today = new Date();
  
  // 生成最近7天的模拟数据
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dateStr = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    dates.push(dateStr);
    
    if (i === 0) {
      // 今天是当前选择的心情
      levels.push(currentLevel);
    } else {
      // 前几天是随机但接近当前心情的数据
      const variation = Math.random() * 2 - 1; // -1 到 1 的随机数
      const simulatedLevel = Math.max(0, Math.min(5, currentLevel + variation));
      levels.push(Math.round(simulatedLevel));
    }
  }
  
  // X轴标签
  ctx.textAlign = 'center';
  dates.forEach((date, index) => {
    const x = 50 + (index * (width - 80) / 6);
    ctx.fillText(date, x, height - 30);
  });
  
  // 绘制心情曲线
  ctx.strokeStyle = '#4CAF50';
  ctx.lineWidth = 3;
  ctx.beginPath();
  
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / 6);
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    if (index === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  ctx.stroke();
  
  // 绘制数据点
  ctx.fillStyle = '#4CAF50';
  levels.forEach((level, index) => {
    const x = 50 + (index * (width - 80) / 6);
    const y = height - 50 - ((level - 1) * (height - 80) / 4);
    
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, 2 * Math.PI);
    ctx.fill();
  });
  
  // 添加提示信息
  ctx.fillStyle = '#333';
  ctx.font = '14px Arial';
  ctx.textAlign = 'left';
  ctx.fillText('📊 基于当前选择的心情生成的预览', 60, 25);
  
  ctx.fillStyle = '#666';
  ctx.font = '12px Arial';
  ctx.fillText('保存日记后将显示真实的历史趋势', 60, 45);
  
  // 更新心情统计摘要
  updateTemporaryMoodStats(currentMood);
}

// 更新临时心情统计摘要
function updateTemporaryMoodStats(currentMood) {
  const summaryElement = document.getElementById('moodStatsSummary');
  if (!summaryElement) return;
  
  const moodText = {
    'happy': '开心',
    'excited': '兴奋',
    'calm': '平静',
    'content': '满足',
    'neutral': '一般',
    'worried': '担心',
    'tired': '疲惫',
    'sad': '难过',
    'anxious': '焦虑',
    'stressed': '压力',
    'frustrated': '沮丧',
    'angry': '生气',
    'grateful': '感恩',
    'inspired': '受启发',
    'confident': '自信'
  };
  
  summaryElement.innerHTML = `
    <div class="mood-stats-grid">
      <div class="mood-stat-item positive">
        <span class="stat-label">😊 当前心情</span>
        <span class="stat-value">${moodText[currentMood] || '未知'}</span>
      </div>
      <div class="mood-stat-item neutral">
        <span class="stat-label">📝 提示</span>
        <span class="stat-value">保存日记查看趋势</span>
      </div>
      <div class="mood-stat-item negative">
        <span class="stat-label">📊 数据状态</span>
        <span class="stat-value">预览模式</span>
      </div>
      <div class="mood-stat-item stability">
        <span class="stat-label">💡 建议</span>
        <span class="stat-value">继续记录生活</span>
      </div>
    </div>
  `;
}

// 更新心情统计摘要
  updateMoodStatsSummary(moodData);
}

// 更新心情统计摘要
function updateMoodStatsSummary(moodData) {
  const summaryElement = document.getElementById('moodStatsSummary');
  if (!summaryElement) return;
  
  const totalDays = moodData.total_entries || 0;
  const positiveDays = moodData.positive_days || 0;
  const negativeDays = moodData.negative_days || 0;
  const neutralDays = moodData.neutral_days || 0;
  
  const positivePercent = totalDays > 0 ? Math.round((positiveDays / totalDays) * 100) : 0;
  const negativePercent = totalDays > 0 ? Math.round((negativeDays / totalDays) * 100) : 0;
  const neutralPercent = totalDays > 0 ? Math.round((neutralDays / totalDays) * 100) : 0;
  
  const stabilityText = {
    'stable': '稳定',
    'moderate': '一般',
    'volatile': '波动',
    'insufficient_data': '数据不足'
  };
  
  summaryElement.innerHTML = `
    <div class="mood-stats-grid">
      <div class="mood-stat-item positive">
        <span class="stat-label">😊 积极天数</span>
        <span class="stat-value">${positiveDays}天 (${positivePercent}%)</span>
      </div>
      <div class="mood-stat-item neutral">
        <span class="stat-label">😐 中性天数</span>
        <span class="stat-value">${neutralDays}天 (${neutralPercent}%)</span>
      </div>
      <div class="mood-stat-item negative">
        <span class="stat-label">😔 消极天数</span>
        <span class="stat-value">${negativeDays}天 (${negativePercent}%)</span>
      </div>
      <div class="mood-stat-item stability">
        <span class="stat-label">📊 心情稳定性</span>
        <span class="stat-value">${stabilityText[moodData.stability] || '未知'}</span>
      </div>
    </div>
  `;
}

// 完成整个流程
function finishDiary() {
  goToStep(5);
}

// 监听心情选择变化
function addMoodSelectionListener() {
  const moodOptions = document.querySelectorAll('.mood-option');
  moodOptions.forEach(option => {
    option.addEventListener('click', function() {
      // 延迟一下，确保选择状态已更新
      setTimeout(() => {
        const currentMood = getCurrentPageMood();
        if (currentMood) {
          // 重新渲染心情图表
          const canvas = document.getElementById('moodChart');
          if (canvas) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = 300;
            ctx.clearRect(0, 0, width, height);
            renderTemporaryMoodChart(ctx, width, height, currentMood);
          }
        }
      }, 100);
    });
  });
}

// 统计卡片点击功能
function addStatCardListeners() {
  const statCards = document.querySelectorAll('.stat-card');
  
  statCards.forEach(card => {
    card.addEventListener('click', function() {
      const cardId = this.id;
      showStatDetail(cardId);
    });
  });
}

// 显示统计详细数据
function showStatDetail(cardId) {
  const modal = document.getElementById('statDetailModal');
  const icon = document.getElementById('statDetailIcon');
  const title = document.getElementById('statDetailTitle');
  const summaryNumber = document.getElementById('statDetailSummaryNumber');
  const summaryLabel = document.getElementById('statDetailSummaryLabel');
  const list = document.getElementById('statDetailList');
  
  // 根据卡片ID设置不同的内容
  switch(cardId) {
    case 'totalDiaryDaysCard':
      icon.textContent = '📅';
      title.textContent = '日记天数详情';
      summaryNumber.textContent = document.getElementById('totalDiaryDays').textContent;
      summaryLabel.textContent = '总天数';
      loadDiaryDaysDetail(list);
      break;
    case 'totalDiaryCountCard':
      icon.textContent = '📝';
      title.textContent = '日记次数详情';
      summaryNumber.textContent = document.getElementById('totalDiaryCount').textContent;
      summaryLabel.textContent = '总次数';
      loadDiaryCountDetail(list);
      break;
    case 'happyDaysCard':
      icon.textContent = '😊';
      title.textContent = '开心天数详情';
      summaryNumber.textContent = document.getElementById('happyDays').textContent;
      summaryLabel.textContent = '开心天数';
      loadHappyDaysDetail(list);
      break;
    case 'totalWordsCard':
      icon.textContent = '📖';
      title.textContent = '总字数详情';
      summaryNumber.textContent = document.getElementById('totalWords').textContent;
      summaryLabel.textContent = '总字数';
      loadTotalWordsDetail(list);
      break;
  }
  
  // 显示弹窗
  modal.style.display = 'flex';
  
  // 添加点击效果
  const card = document.getElementById(cardId);
  card.classList.add('clicked');
  setTimeout(() => {
    card.classList.remove('clicked');
  }, 300);
}

// 关闭统计详细数据
function closeStatDetail() {
  const modal = document.getElementById('statDetailModal');
  modal.style.display = 'none';
}

// 点击弹窗外部关闭
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('statDetailModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeStatDetail();
      }
    });
  }
});

// 加载日记天数详情
function loadDiaryDaysDetail(list) {
  fetch('/tools/api/life-diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_diary_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const uniqueDates = [...new Set(data.diaries.map(diary => diary.date))];
      displayDiaryDaysDetail(list, uniqueDates, data.diaries);
    } else {
      displayEmptyDetail(list, '暂无日记数据');
    }
  })
  .catch(error => {
    console.error('加载日记天数详情失败:', error);
    displayEmptyDetail(list, '加载失败，请重试');
  });
}

// 加载日记次数详情
function loadDiaryCountDetail(list) {
  fetch('/tools/api/life-diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_diary_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      displayDiaryCountDetail(list, data.diaries);
    } else {
      displayEmptyDetail(list, '暂无日记数据');
    }
  })
  .catch(error => {
    console.error('加载日记次数详情失败:', error);
    displayEmptyDetail(list, '加载失败，请重试');
  });
}

// 加载开心天数详情
function loadHappyDaysDetail(list) {
  fetch('/tools/api/life-diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_happy_days_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      displayHappyDaysDetail(list, data.data);
    } else {
      displayEmptyDetail(list, '暂无开心数据');
    }
  })
  .catch(error => {
    console.error('加载开心天数详情失败:', error);
    displayEmptyDetail(list, '加载失败，请重试');
  });
}

// 加载总字数详情
function loadTotalWordsDetail(list) {
  fetch('/tools/api/life-diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      action: 'get_diary_list'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      displayTotalWordsDetail(list, data.diaries);
    } else {
      displayEmptyDetail(list, '暂无日记数据');
    }
  })
  .catch(error => {
    console.error('加载总字数详情失败:', error);
    displayEmptyDetail(list, '加载失败，请重试');
  });
}

// 显示日记天数详情
function displayDiaryDaysDetail(list, uniqueDates, diaries) {
  if (uniqueDates.length === 0) {
    displayEmptyDetail(list, '暂无日记数据');
    return;
  }
  
  let html = '';
  uniqueDates.forEach(date => {
    const dateDiaries = diaries.filter(diary => diary.date === date);
    const firstDiary = dateDiaries[0];
    
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${date}</div>
          <div class="stat-detail-item-mood">${getMoodEmoji(firstDiary.mood)}</div>
        </div>
        <div class="stat-detail-item-title">${firstDiary.title}</div>
        <div class="stat-detail-item-content">${firstDiary.content.substring(0, 100)}${firstDiary.content.length > 100 ? '...' : ''}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// 显示日记次数详情
function displayDiaryCountDetail(list, diaries) {
  if (diaries.length === 0) {
    displayEmptyDetail(list, '暂无日记数据');
    return;
  }
  
  let html = '';
  diaries.forEach(diary => {
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${diary.created_at.split('T')[0]}</div>
          <div class="stat-detail-item-mood">${getMoodEmoji(diary.mood)}</div>
        </div>
        <div class="stat-detail-item-title">${diary.title}</div>
        <div class="stat-detail-item-content">${diary.content.substring(0, 100)}${diary.content.length > 100 ? '...' : ''}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// 显示开心天数详情
function displayHappyDaysDetail(list, happyDays) {
  if (happyDays.length === 0) {
    displayEmptyDetail(list, '暂无开心数据');
    return;
  }
  
  let html = '';
  happyDays.forEach(day => {
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${day.date}</div>
          <div class="stat-detail-item-mood">😊</div>
        </div>
        <div class="stat-detail-item-title">${day.title}</div>
        <div class="stat-detail-item-content">${day.content}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// 显示总字数详情
function displayTotalWordsDetail(list, diaries) {
  if (diaries.length === 0) {
    displayEmptyDetail(list, '暂无日记数据');
    return;
  }
  
  let html = '';
  diaries.forEach(diary => {
    const wordCount = diary.content.length;
    html += `
      <div class="stat-detail-item">
        <div class="stat-detail-item-header">
          <div class="stat-detail-item-date">${diary.created_at.split('T')[0]}</div>
          <div class="stat-detail-item-mood">${getMoodEmoji(diary.mood)}</div>
        </div>
        <div class="stat-detail-item-title">${diary.title} <span style="color: #4CAF50; font-size: 12px;">(${wordCount}字)</span></div>
        <div class="stat-detail-item-content">${diary.content.substring(0, 100)}${diary.content.length > 100 ? '...' : ''}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// 显示空数据
function displayEmptyDetail(list, message) {
  list.innerHTML = `
    <div class="stat-detail-empty">
      <div class="stat-detail-empty-icon">📝</div>
      <div class="stat-detail-empty-text">${message}</div>
    </div>
  `;
}

// 获取心情表情
function getMoodEmoji(mood) {
  const moodEmojis = {
    'happy': '😊',
    'calm': '😌',
    'excited': '⭐',
    'sad': '😢',
    'angry': '😠',
    'neutral': '😐'
  };
  return moodEmojis[mood] || '😐';
}

// 重置日记
function resetDiary() {
  // 重置所有数据
  selectedMood = null;
  selectedGoalCategories = [];
  diaryData = {
    title: '',
    content: '',
    mood: '',
    goal_category: ''
  };
  
  // 重置UI
  document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
  document.querySelectorAll('.goal-icon-option').forEach(opt => opt.classList.remove('selected'));
  
  // 安全地重置表单元素
  const diaryTitle = document.getElementById('diaryTitle');
  const diaryContent = document.getElementById('diaryContent');
  
  if (diaryTitle) {
    diaryTitle.value = '';
  }
  
  if (diaryContent) {
    diaryContent.value = '';
  }
  
  // 重置问题输入框
  document.querySelectorAll('.question-answer').forEach(textarea => {
    if (textarea) {
      textarea.value = '';
    }
  });
  
  document.querySelectorAll('.additional-input').forEach(input => {
    if (input) {
      input.value = '';
    }
  });
  
  // 重置进度指示器
  updateProgressIndicator(1);
  
  // 返回第一步
  goToStep(1);
  
  showNotification('开始新的生活记录！', 'success');
}

// 问题编辑相关函数
function editQuestion(number, originalText) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const displayDiv = questionItem.querySelector('.question-display');
  const editDiv = questionItem.querySelector('.question-edit');
  const textarea = editDiv.querySelector('.question-edit-input');
  
  // 显示编辑模式
  displayDiv.style.display = 'none';
  editDiv.style.display = 'block';
  
  // 设置原始文本并聚焦
  textarea.value = originalText;
  textarea.focus();
  textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

function saveQuestion(number) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const displayDiv = questionItem.querySelector('.question-display');
  const editDiv = questionItem.querySelector('.question-edit');
  const textarea = editDiv.querySelector('.question-edit-input');
  const questionTextSpan = displayDiv.querySelector('.question-text');
  
  const newText = textarea.value.trim();
  
  if (newText) {
    // 更新显示文本
    questionTextSpan.textContent = newText;
    
    // 切换回显示模式
    displayDiv.style.display = 'flex';
    editDiv.style.display = 'none';
    
    showNotification(`问题 ${number} 已更新！`, 'success');
  } else {
    showNotification('问题内容不能为空！', 'error');
  }
}

function cancelEditQuestion(number) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const displayDiv = questionItem.querySelector('.question-display');
  const editDiv = questionItem.querySelector('.question-edit');
  const textarea = editDiv.querySelector('.question-edit-input');
  
  // 恢复原始文本
  const originalText = displayDiv.querySelector('.question-text').textContent;
  textarea.value = originalText;
  
  // 切换回显示模式
  displayDiv.style.display = 'flex';
  editDiv.style.display = 'none';
  
  showNotification('已取消编辑', 'info');
}

// 键盘快捷键支持
document.addEventListener('keydown', function(e) {
  // 检查是否在编辑模式
  const activeEditDiv = document.querySelector('.question-edit[style*="display: block"]');
  if (activeEditDiv) {
    const textarea = activeEditDiv.querySelector('.question-edit-input');
    const questionNumber = textarea.getAttribute('data-question-number');
    
    if (e.key === 'Enter' && e.ctrlKey) {
      e.preventDefault();
      saveQuestion(questionNumber);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      cancelEditQuestion(questionNumber);
    }
  }
});

// 点击外部区域关闭问题选择器
document.addEventListener('click', function(e) {
  const selectors = document.querySelectorAll('.question-selector');
  selectors.forEach(selector => {
    if (selector.style.display === 'block') {
      const questionItem = selector.closest('.question-item');
      if (questionItem && !questionItem.contains(e.target)) {
        const questionNumber = questionItem.getAttribute('data-question-number');
        closeQuestionSelector(questionNumber);
      }
    }
  });
});

// 加载今日数据
async function loadTodayData() {
  try {
    const response = await fetch('/tools/api/life-diary/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        action: 'get_diary'
      })
    });
    
    const data = await response.json();
    
    if (data.success && data.data) {
      // 如果今天已有日记，直接跳转到完成页面
      showNotification('今天的生活记录已完成！', 'success');
      setTimeout(() => {
        goToStep(5);
      }, 2000);
    }
  } catch (error) {
    console.error('加载今日数据失败:', error);
  }
}

// 显示通知
function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// 获取CSRF Token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// 添加动画样式
const style = document.createElement('style');
style.textContent = `
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  @keyframes slideInUp {
    from { 
      opacity: 0; 
      transform: translateY(30px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }
`;
document.head.appendChild(style);

// 问题选择器相关函数
function showQuestionSelector(number, currentText) {
  // 隐藏所有其他选择器
  document.querySelectorAll('.question-selector').forEach(selector => {
    selector.style.display = 'none';
  });
  
  const selector = document.querySelector(`[data-question-number="${number}"] .question-selector`);
  if (selector) {
    selector.style.display = 'block';
    
    // 设置当前文本到自定义输入框
    const customInput = selector.querySelector('.custom-question-input');
    if (customInput) {
      customInput.value = currentText;
    }
  }
}

function closeQuestionSelector(number) {
  const selector = document.querySelector(`[data-question-number="${number}"] .question-selector`);
  if (selector) {
    selector.style.display = 'none';
  }
}

function selectQuestion(number, questionText) {
  const questionItem = document.querySelector(`[data-question-number="${number}"]`);
  const questionTextSpan = questionItem.querySelector('.question-text');
  
  // 更新问题文本
  questionTextSpan.textContent = questionText;
  
  // 关闭选择器
  closeQuestionSelector(number);
  
  showNotification(`问题 ${number} 已更新！`, 'success');
}

function useCustomQuestion(number) {
  const selector = document.querySelector(`[data-question-number="${number}"] .question-selector`);
  const customInput = selector.querySelector('.custom-question-input');
  const customText = customInput.value.trim();
  
  if (customText) {
    selectQuestion(number, customText);
  } else {
    showNotification('请输入自定义问题内容！', 'error');
  }
}

// 问题编辑相关函数（保留原有函数以兼容）
function editQuestion(number, originalText) {
  showQuestionSelector(number, originalText);
}

function saveQuestion(number) {
  // 这个函数现在通过selectQuestion或useCustomQuestion来处理
  closeQuestionSelector(number);
}

function cancelEditQuestion(number) {
  closeQuestionSelector(number);
  showNotification('已取消编辑', 'info');
}

// 更新问题项的样式
function updateQuestionItemStyle(checkbox) {
  const questionItem = checkbox.closest('.question-selection-item');
  if (checkbox.checked) {
    questionItem.classList.add('selected');
  } else {
    questionItem.classList.remove('selected');
  }
}
</script>
{% endblock %}