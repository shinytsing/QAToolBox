{% extends 'base.html' %}
{% load static %}

{% block title %}ä»£ç†ç³»ç»Ÿ - æå®¢æ¨¡å¼{% endblock %}

{% block extra_css %}
<style>
/* ä»£ç†ç¿»å¢™åŠŸèƒ½æ ·å¼ */
.proxy-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #0a0e17 0%, #1a1f2e 100%);
    color: #e6e6e6;
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    padding: 2rem;
    position: relative;
    overflow: hidden;
}

.proxy-container::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 80%, rgba(0, 255, 231, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0, 191, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 107, 157, 0.05) 0%, transparent 50%);
    z-index: -1;
    animation: geekMatrix 25s ease-in-out infinite;
}

@keyframes geekMatrix {
    0%, 100% { 
        transform: translateY(0px) rotate(0deg);
        opacity: 0.8;
    }
    33% { 
        transform: translateY(-10px) rotate(0.5deg);
        opacity: 1;
    }
    66% { 
        transform: translateY(5px) rotate(-0.5deg);
        opacity: 0.9;
    }
}

.proxy-header {
    text-align: center;
    margin-bottom: 3rem;
}

.proxy-title {
    color: #00ffe7;
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(0, 255, 231, 0.5);
    animation: geekGlow 2s ease-in-out infinite alternate;
}

@keyframes geekGlow {
    from { text-shadow: 0 0 20px rgba(0, 255, 231, 0.5); }
    to { text-shadow: 0 0 30px rgba(0, 255, 231, 0.8), 0 0 40px rgba(0, 255, 231, 0.3); }
}

.proxy-subtitle {
    color: #8a9ba8;
    font-size: 1.2rem;
    margin-bottom: 2rem;
}

.proxy-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.proxy-card {
    background: linear-gradient(135deg, rgba(26,31,46,0.9) 0%, rgba(0,255,231,0.1) 100%);
    border: 1px solid rgba(0, 255, 231, 0.1);
    border-radius: 16px;
    padding: 2rem;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.proxy-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(135deg, #00ffe7 0%, #00bfff 50%, #ff6b9d 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.proxy-card:hover::after {
    transform: scaleX(1);
}

.proxy-card:hover {
    transform: translateY(-4px) scale(1.02);
    border-color: #00ffe7;
    box-shadow: 0 8px 32px rgba(0, 255, 231, 0.2);
}

.proxy-card-title {
    color: #00ffe7;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.proxy-card-title i {
    font-size: 1.2rem;
}

.proxy-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ff4444;
    animation: pulse 2s infinite;
}

.status-indicator.working {
    background: #00ff41;
}

.status-indicator.testing {
    background: #ffaa00;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.proxy-btn {
    background: linear-gradient(135deg, #00ffe7 0%, #00bfff 50%, #ff6b9d 100%);
    color: #0a0e17;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
    margin: 0.5rem;
}

.proxy-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 255, 231, 0.3);
}

.proxy-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.proxy-btn.secondary {
    background: transparent;
    color: #00ffe7;
    border: 2px solid #00ffe7;
}

.proxy-btn.secondary:hover {
    background: #00ffe7;
    color: #0a0e17;
}

.proxy-results {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.2);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.proxy-result-item {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    border-left: 3px solid #00ffe7;
}

.proxy-result-item.success {
    background: rgba(0, 255, 65, 0.1);
    border-left-color: #00ff41;
}

.proxy-result-item.error {
    background: rgba(255, 68, 68, 0.1);
    border-left-color: #ff4444;
}

.proxy-result-item.warning {
    background: rgba(255, 170, 0, 0.1);
    border-left-color: #ffaa00;
}

.proxy-input {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 8px;
    padding: 0.8rem;
    color: #e6e6e6;
    font-family: inherit;
    width: 100%;
    margin-bottom: 1rem;
}

.proxy-input:focus {
    outline: none;
    border-color: #00ffe7;
    box-shadow: 0 0 0 2px rgba(0, 255, 231, 0.2);
}

.proxy-select {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 8px;
    padding: 0.8rem;
    color: #e6e6e6;
    font-family: inherit;
    width: 100%;
    margin-bottom: 1rem;
}

.proxy-select:focus {
    outline: none;
    border-color: #00ffe7;
}

.proxy-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
}

.stat-number {
    color: #00ffe7;
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #8a9ba8;
    font-size: 0.9rem;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 255, 231, 0.3);
    border-radius: 50%;
    border-top-color: #00ffe7;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.proxy-terminal {
    background: #111417;
    color: #00ffe7;
    font-family: 'Courier New', monospace;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    border: 1px solid rgba(0, 255, 231, 0.3);
    max-height: 400px;
    overflow-y: auto;
}

.proxy-terminal::before {
    content: '$ ';
    color: #00bfff;
    font-weight: bold;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .proxy-container {
        padding: 1rem;
    }
    
    .proxy-title {
        font-size: 2rem;
    }
    
    .proxy-grid {
        grid-template-columns: 1fr;
    }
    
    .proxy-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="proxy-container">
    <div class="proxy-header">
        <h1 class="proxy-title">
            <i class="fas fa-shield-alt"></i>
            ä»£ç†ç¿»å¢™ç³»ç»Ÿ
        </h1>
        <p class="proxy-subtitle">ğŸ”§ æå®¢æ¨¡å¼ - çªç ´ç½‘ç»œé™åˆ¶ï¼Œè‡ªç”±è®¿é—®å…¨çƒèµ„æº</p>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="proxy-stats" id="proxyStats">
        <div class="stat-card">
            <div class="stat-number" id="totalProxies">-</div>
            <div class="stat-label">æ€»ä»£ç†æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="workingProxies">-</div>
            <div class="stat-label">å¯ç”¨ä»£ç†</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="successRate">-</div>
            <div class="stat-label">æˆåŠŸç‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="currentIP">-</div>
            <div class="stat-label">å½“å‰IP</div>
        </div>
    </div>

    <!-- åŠŸèƒ½å¡ç‰‡ -->
    <div class="proxy-grid">
        <!-- ä»£ç†çŠ¶æ€æ£€æµ‹ -->
        <div class="proxy-card">
            <h3 class="proxy-card-title">
                <i class="fas fa-network-wired"></i>
                ä»£ç†çŠ¶æ€æ£€æµ‹
            </h3>
            <div class="proxy-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">å‡†å¤‡æ£€æµ‹</span>
            </div>
            <button class="proxy-btn" onclick="testAllProxies()">
                <i class="fas fa-play"></i>
                å¼€å§‹æ£€æµ‹
            </button>
            <button class="proxy-btn secondary" onclick="refreshStatus()">
                <i class="fas fa-sync-alt"></i>
                åˆ·æ–°çŠ¶æ€
            </button>
            <div class="proxy-results" id="proxyResults"></div>
        </div>

        <!-- ç½‘ç«™è®¿é—®æµ‹è¯• -->
        <div class="proxy-card">
            <h3 class="proxy-card-title">
                <i class="fas fa-globe"></i>
                ç½‘ç«™è®¿é—®æµ‹è¯•
            </h3>
            <input type="text" class="proxy-input" id="testUrl" 
                   placeholder="è¾“å…¥è¦æµ‹è¯•çš„ç½‘ç«™URL (å¦‚: https://www.google.com)">
            <select class="proxy-select" id="proxySelect">
                <option value="">ç›´è¿è®¿é—®</option>
            </select>
            <button class="proxy-btn" onclick="testWebsite()">
                <i class="fas fa-search"></i>
                æµ‹è¯•è®¿é—®
            </button>
            <div class="proxy-results" id="websiteResults"></div>
        </div>

        <!-- IPå¯¹æ¯”åŠŸèƒ½ -->
        <div class="proxy-card">
            <h3 class="proxy-card-title">
                <i class="fas fa-exchange-alt"></i>
                IPå¯¹æ¯”åŠŸèƒ½
            </h3>
            <p class="proxy-description">å¯¹æ¯”ç›´è¿å’Œä»£ç†çš„IPåœ°å€</p>
            <button class="proxy-btn" onclick="getIPComparison()">
                <i class="fas fa-balance-scale"></i>
                è·å–IPå¯¹æ¯”
            </button>
            <div class="proxy-results" id="ipComparisonResults"></div>
        </div>

        <!-- çœŸå®ä»£ç†æµ‹è¯• -->
        <div class="proxy-card">
            <h3 class="proxy-card-title">
                <i class="fas fa-rocket"></i>
                çœŸå®ä»£ç†æµ‹è¯•
            </h3>
            <p class="proxy-description">æµ‹è¯•ä»£ç†æ˜¯å¦èƒ½çœŸå®è®¿é—®ç›®æ ‡ç½‘ç«™</p>
            <input type="text" class="proxy-input" id="realTestUrl" 
                   placeholder="ç›®æ ‡ç½‘ç«™ (é»˜è®¤: https://www.google.com)" value="https://www.google.com">
            <select class="proxy-select" id="realProxySelect">
                <option value="">é€‰æ‹©ä»£ç†</option>
            </select>
            <button class="proxy-btn" onclick="testRealProxy()">
                <i class="fas fa-play"></i>
                æµ‹è¯•çœŸå®ä»£ç†
            </button>
            <div class="proxy-results" id="realProxyResults"></div>
        </div>

        <!-- IPä¿¡æ¯æŸ¥è¯¢ -->
        <div class="proxy-card">
            <h3 class="proxy-card-title">
                <i class="fas fa-map-marker-alt"></i>
                IPä¿¡æ¯æŸ¥è¯¢
            </h3>
            <select class="proxy-select" id="ipProxySelect">
                <option value="">å½“å‰IP (ç›´è¿)</option>
            </select>
            <button class="proxy-btn" onclick="getIPInfo()">
                <i class="fas fa-info-circle"></i>
                æŸ¥è¯¢IPä¿¡æ¯
            </button>
            <div class="proxy-results" id="ipResults"></div>
        </div>

        <!-- ä»£ç†åˆ—è¡¨ -->
        <div class="proxy-card">
            <h3 class="proxy-card-title">
                <i class="fas fa-list"></i>
                ä»£ç†æœåŠ¡å™¨åˆ—è¡¨
            </h3>
            <button class="proxy-btn" onclick="loadProxyList()">
                <i class="fas fa-download"></i>
                åŠ è½½ä»£ç†åˆ—è¡¨
            </button>
            <button class="proxy-btn secondary" onclick="exportProxyConfig()">
                <i class="fas fa-file-export"></i>
                å¯¼å‡ºé…ç½®
            </button>
            <div class="proxy-results" id="proxyList"></div>
        </div>
    </div>

    <!-- ç»ˆç«¯è¾“å‡º -->
    <div class="proxy-terminal" id="proxyTerminal">
        ä»£ç†ç³»ç»Ÿå·²å¯åŠ¨...
        è¾“å…¥ 'help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let proxyList = [];
let currentStatus = 'idle';

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”§ ä»£ç†ç³»ç»Ÿåˆå§‹åŒ–...');
    loadProxyList();
    updateStatus('å‡†å¤‡å°±ç»ª', 'working');
    log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
});

// æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
function updateStatus(text, status) {
    const indicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    
    indicator.className = `status-indicator ${status}`;
    statusText.textContent = text;
    currentStatus = status;
}

// æ—¥å¿—è¾“å‡º
function log(message, type = 'info') {
    const terminal = document.getElementById('proxyTerminal');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'error' ? '#ff4444' : type === 'success' ? '#00ff41' : '#00ffe7';
    
    terminal.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
    terminal.scrollTop = terminal.scrollHeight;
    console.log(`[${timestamp}] ${message}`);
}

// åŠ è½½ä»£ç†åˆ—è¡¨
async function loadProxyList() {
    try {
        log('æ­£åœ¨åŠ è½½ä»£ç†åˆ—è¡¨...');
        updateStatus('åŠ è½½ä¸­...', 'testing');
        
        const response = await fetch('/tools/api/proxy/list/');
        const data = await response.json();
        
        if (data.success) {
            proxyList = data.data.proxies_by_country;
            updateProxySelects();
            updateStats(data.data);
            log(`âœ… æˆåŠŸåŠ è½½ ${data.data.total_proxies} ä¸ªä»£ç†æœåŠ¡å™¨`);
            updateStatus('ä»£ç†åˆ—è¡¨å·²åŠ è½½', 'working');
        } else {
            log(`âŒ åŠ è½½ä»£ç†åˆ—è¡¨å¤±è´¥: ${data.error}`, 'error');
            updateStatus('åŠ è½½å¤±è´¥', 'error');
        }
    } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
        updateStatus('ç½‘ç»œé”™è¯¯', 'error');
    }
}

// æ›´æ–°ä»£ç†é€‰æ‹©å™¨
function updateProxySelects() {
    const selects = ['proxySelect', 'ipProxySelect', 'realProxySelect'];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (selectId === 'realProxySelect') {
            select.innerHTML = '<option value="">é€‰æ‹©ä»£ç†</option>';
        } else {
            select.innerHTML = '<option value="">ç›´è¿è®¿é—®</option>';
        }
        
        for (const [country, proxies] of Object.entries(proxyList)) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = country;
            
            proxies.forEach(proxy => {
                const option = document.createElement('option');
                option.value = proxy.name;
                option.textContent = `${proxy.name} (${proxy.category})`;
                optgroup.appendChild(option);
            });
            
            select.appendChild(optgroup);
        }
    });
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats(data) {
    document.getElementById('totalProxies').textContent = data.total_proxies || '-';
}

// æµ‹è¯•æ‰€æœ‰ä»£ç†
async function testAllProxies() {
    try {
        log('å¼€å§‹æµ‹è¯•æ‰€æœ‰ä»£ç†æœåŠ¡å™¨...');
        updateStatus('æµ‹è¯•ä¸­...', 'testing');
        
        const resultsDiv = document.getElementById('proxyResults');
        resultsDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨æµ‹è¯•ä»£ç†...';
        
        const response = await fetch('/tools/api/proxy/status/');
        const data = await response.json();
        
        if (data.success) {
            displayProxyResults(data.data.proxy_results);
            updateStats(data.data.statistics);
            log(`âœ… ä»£ç†æµ‹è¯•å®Œæˆï¼Œ${data.data.statistics.working_proxies}/${data.data.statistics.total_proxies} å¯ç”¨`);
            updateStatus('æµ‹è¯•å®Œæˆ', 'working');
        } else {
            log(`âŒ ä»£ç†æµ‹è¯•å¤±è´¥: ${data.error}`, 'error');
            updateStatus('æµ‹è¯•å¤±è´¥', 'error');
        }
    } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
        updateStatus('ç½‘ç»œé”™è¯¯', 'error');
    }
}

// æ˜¾ç¤ºä»£ç†æµ‹è¯•ç»“æœ
function displayProxyResults(results) {
    const resultsDiv = document.getElementById('proxyResults');
    resultsDiv.innerHTML = '';
    
    results.forEach(result => {
        const item = document.createElement('div');
        item.className = `proxy-result-item ${result.success ? 'success' : 'error'}`;
        
        if (result.success) {
            item.innerHTML = `
                <strong>${result.proxy}</strong> âœ… 
                <br>å“åº”æ—¶é—´: ${result.response_time}s | IP: ${result.ip}
            `;
        } else {
            item.innerHTML = `
                <strong>${result.proxy}</strong> âŒ 
                <br>é”™è¯¯: ${result.error}
            `;
        }
        
        resultsDiv.appendChild(item);
    });
}

// æµ‹è¯•ç½‘ç«™è®¿é—®
async function testWebsite() {
    const url = document.getElementById('testUrl').value.trim();
    const proxy = document.getElementById('proxySelect').value;
    
    if (!url) {
        log('âŒ è¯·è¾“å…¥è¦æµ‹è¯•çš„ç½‘ç«™URL', 'error');
        return;
    }
    
    try {
        log(`æ­£åœ¨æµ‹è¯•ç½‘ç«™: ${url} ${proxy ? `(ä½¿ç”¨ä»£ç†: ${proxy})` : '(ç›´è¿)'}`);
        
        const response = await fetch('/tools/api/proxy/test-website/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ url, proxy })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayWebsiteResult(data.data);
            log(`âœ… ç½‘ç«™æµ‹è¯•å®Œæˆ: ${data.data.accessible ? 'å¯è®¿é—®' : 'ä¸å¯è®¿é—®'}`, 'success');
        } else {
            log(`âŒ ç½‘ç«™æµ‹è¯•å¤±è´¥: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
    }
}

// è·å–IPå¯¹æ¯”
async function getIPComparison() {
    try {
        log('æ­£åœ¨è·å–IPå¯¹æ¯”ä¿¡æ¯...');
        
        const response = await fetch('/tools/api/proxy/ip-comparison/');
        const data = await response.json();
        
        if (data.success) {
            displayIPComparison(data.data);
            log(`âœ… IPå¯¹æ¯”è·å–å®Œæˆ`, 'success');
        } else {
            log(`âŒ IPå¯¹æ¯”è·å–å¤±è´¥: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
    }
}

// æ˜¾ç¤ºIPå¯¹æ¯”ç»“æœ
function displayIPComparison(data) {
    const resultsDiv = document.getElementById('ipComparisonResults');
    let html = '<div class="proxy-result-item">';
    
    // ç›´è¿IP
    if (data.direct_ip.success) {
        html += `
            <div style="margin-bottom: 15px;">
                <strong>ğŸŒ ç›´è¿IP:</strong> ${data.direct_ip.ip}
                <br><small>çŠ¶æ€: âœ… æ­£å¸¸</small>
            </div>
        `;
    } else {
        html += `
            <div style="margin-bottom: 15px;">
                <strong>ğŸŒ ç›´è¿IP:</strong> è·å–å¤±è´¥
                <br><small>é”™è¯¯: ${data.direct_ip.error}</small>
            </div>
        `;
    }
    
    // ä»£ç†IP
    if (data.proxy_ip && data.proxy_ip.success) {
        html += `
            <div style="margin-bottom: 15px;">
                <strong>ğŸ”— ä»£ç†IP:</strong> ${data.proxy_ip.ip}
                <br><small>ä»£ç†: ${data.proxy_ip.proxy_used} | çŠ¶æ€: âœ… æ­£å¸¸</small>
            </div>
        `;
    } else {
        html += `
            <div style="margin-bottom: 15px;">
                <strong>ğŸ”— ä»£ç†IP:</strong> è·å–å¤±è´¥
                <br><small>é”™è¯¯: ${data.proxy_ip ? data.proxy_ip.error : 'æ— å¯ç”¨ä»£ç†'}</small>
            </div>
        `;
    }
    
    html += '</div>';
    resultsDiv.innerHTML = html;
}

// æµ‹è¯•çœŸå®ä»£ç†
async function testRealProxy() {
    const url = document.getElementById('realTestUrl').value.trim();
    const proxy = document.getElementById('realProxySelect').value;
    
    if (!proxy) {
        log('âŒ è¯·é€‰æ‹©è¦æµ‹è¯•çš„ä»£ç†', 'error');
        return;
    }
    
    if (!url) {
        log('âŒ è¯·è¾“å…¥è¦æµ‹è¯•çš„ç½‘ç«™URL', 'error');
        return;
    }
    
    try {
        log(`æ­£åœ¨æµ‹è¯•çœŸå®ä»£ç†: ${proxy} -> ${url}`);
        
        const response = await fetch('/tools/api/proxy/test-real/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ proxy, url })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayRealProxyResult(data.data);
            log(`âœ… çœŸå®ä»£ç†æµ‹è¯•å®Œæˆ: ${data.data.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, data.data.success ? 'success' : 'error');
        } else {
            log(`âŒ çœŸå®ä»£ç†æµ‹è¯•å¤±è´¥: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
    }
}

// æ˜¾ç¤ºçœŸå®ä»£ç†æµ‹è¯•ç»“æœ
function displayRealProxyResult(result) {
    const resultsDiv = document.getElementById('realProxyResults');
    const item = document.createElement('div');
    item.className = `proxy-result-item ${result.success ? 'success' : 'error'}`;
    
    if (result.success) {
        item.innerHTML = `
            <strong>${result.proxy}</strong> âœ… 
            <br>ç›®æ ‡: ${result.target_url}
            <br>çŠ¶æ€ç : ${result.status_code} | å“åº”æ—¶é—´: ${result.response_time}s
        `;
    } else {
        item.innerHTML = `
            <strong>${result.proxy}</strong> âŒ 
            <br>ç›®æ ‡: ${result.target_url}
            <br>é”™è¯¯: ${result.error}
            ${result.solution ? `<br>ğŸ’¡ è§£å†³æ–¹æ¡ˆ: ${result.solution}` : ''}
        `;
    }
    
    resultsDiv.innerHTML = '';
    resultsDiv.appendChild(item);
}

// æ˜¾ç¤ºç½‘ç«™æµ‹è¯•ç»“æœ
function displayWebsiteResult(result) {
    const resultsDiv = document.getElementById('websiteResults');
    const item = document.createElement('div');
    item.className = `proxy-result-item ${result.accessible ? 'success' : 'error'}`;
    
    if (result.accessible) {
        item.innerHTML = `
            <strong>${result.url}</strong> âœ… 
            <br>çŠ¶æ€ç : ${result.status_code} | å“åº”æ—¶é—´: ${result.response_time}s
            <br>ä»£ç†: ${result.proxy_used}
        `;
    } else {
        item.innerHTML = `
            <strong>${result.url}</strong> âŒ 
            <br>é”™è¯¯: ${result.error}
            <br>ä»£ç†: ${result.proxy_used}
        `;
    }
    
    resultsDiv.innerHTML = '';
    resultsDiv.appendChild(item);
}

// è·å–IPä¿¡æ¯
async function getIPInfo() {
    const proxy = document.getElementById('ipProxySelect').value;
    
    try {
        log(`æ­£åœ¨æŸ¥è¯¢IPä¿¡æ¯ ${proxy ? `(ä½¿ç”¨ä»£ç†: ${proxy})` : '(ç›´è¿)'}`);
        
        const url = proxy ? `/tools/api/proxy/ip-info/?proxy=${encodeURIComponent(proxy)}` : '/tools/api/proxy/ip-info/';
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            displayIPInfo(data.data);
            log(`âœ… IPä¿¡æ¯æŸ¥è¯¢å®Œæˆ`, 'success');
        } else {
            log(`âŒ IPä¿¡æ¯æŸ¥è¯¢å¤±è´¥: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
    }
}

// æ˜¾ç¤ºIPä¿¡æ¯
function displayIPInfo(info) {
    const resultsDiv = document.getElementById('ipResults');
    const item = document.createElement('div');
    item.className = 'proxy-result-item success';
    
    if (info.error) {
        item.className = 'proxy-result-item error';
        item.innerHTML = `
            <strong>IPä¿¡æ¯æŸ¥è¯¢å¤±è´¥</strong> âŒ 
            <br>é”™è¯¯: ${info.error}
            <br>ä»£ç†: ${info.proxy_used}
        `;
    } else {
        item.innerHTML = `
            <strong>IPä¿¡æ¯</strong> âœ… 
            <br>IPåœ°å€: ${info.ip}
            <br>å›½å®¶/åœ°åŒº: ${info.country} ${info.region} ${info.city}
            <br>ISP: ${info.isp}
            <br>ä»£ç†: ${info.proxy_used}
        `;
    }
    
    resultsDiv.innerHTML = '';
    resultsDiv.appendChild(item);
}

// åˆ·æ–°çŠ¶æ€
function refreshStatus() {
    log('åˆ·æ–°ç³»ç»ŸçŠ¶æ€...');
    loadProxyList();
}

// å¯¼å‡ºä»£ç†é…ç½®
function exportProxyConfig() {
    log('å¯¼å‡ºä»£ç†é…ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'warning');
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        refreshStatus();
    }
    if (e.ctrlKey && e.key === 't') {
        e.preventDefault();
        testAllProxies();
    }
});

log('ä»£ç†ç¿»å¢™ç³»ç»Ÿå·²å¯åŠ¨ï¼ŒæŒ‰ Ctrl+R åˆ·æ–°çŠ¶æ€ï¼ŒCtrl+T æµ‹è¯•ä»£ç†');
</script>
{% endblock %}
