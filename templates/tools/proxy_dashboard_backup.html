{% extends 'base.html' %}
{% load static %}

{% block title %}ä»£ç†ç³»ç»Ÿ - æå®¢æ¨¡å¼{% endblock %}

{% block extra_css %}
<style>
/* ä»£ç†ç¿»å¢™åŠŸèƒ½æ ·å¼ */
.proxy-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #0a0e17 0%, #1a1f2e 100%);
    color: #e6e6e6;
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    padding: 2rem;
    position: relative;
    overflow: hidden;
}

.proxy-container::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 80%, rgba(0, 255, 231, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0, 191, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 107, 157, 0.05) 0%, transparent 50%);
    z-index: -1;
    animation: geekMatrix 25s ease-in-out infinite;
}

@keyframes geekMatrix {
    0%, 100% { 
        transform: translateY(0px) rotate(0deg);
        opacity: 0.8;
    }
    33% { 
        transform: translateY(-10px) rotate(0.5deg);
        opacity: 1;
    }
    66% { 
        transform: translateY(5px) rotate(-0.5deg);
        opacity: 0.9;
    }
}

.proxy-header {
    text-align: center;
    margin-bottom: 3rem;
}

.proxy-title {
    color: #00ffe7;
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(0, 255, 231, 0.5);
    animation: geekGlow 2s ease-in-out infinite alternate;
}

@keyframes geekGlow {
    from { text-shadow: 0 0 20px rgba(0, 255, 231, 0.5); }
    to { text-shadow: 0 0 30px rgba(0, 255, 231, 0.8), 0 0 40px rgba(0, 255, 231, 0.3); }
}

.proxy-subtitle {
    color: #8a9ba8;
    font-size: 1.2rem;
    margin-bottom: 2rem;
}

.proxy-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.proxy-card {
    background: linear-gradient(135deg, rgba(26,31,46,0.9) 0%, rgba(0,255,231,0.1) 100%);
    border: 1px solid rgba(0, 255, 231, 0.1);
    border-radius: 16px;
    padding: 2rem;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.proxy-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(135deg, #00ffe7 0%, #00bfff 50%, #ff6b9d 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.proxy-card:hover::after {
    transform: scaleX(1);
}

.proxy-card:hover {
    transform: translateY(-4px) scale(1.02);
    border-color: #00ffe7;
    box-shadow: 0 8px 32px rgba(0, 255, 231, 0.2);
}

.proxy-card-title {
    color: #00ffe7;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.proxy-card-title i {
    font-size: 1.2rem;
}

.proxy-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ff4444;
    animation: pulse 2s infinite;
}

.status-indicator.working {
    background: #00ff41;
}

.status-indicator.testing {
    background: #ffaa00;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.proxy-btn {
    background: linear-gradient(135deg, #00ffe7 0%, #00bfff 50%, #ff6b9d 100%);
    color: #0a0e17;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
    margin: 0.5rem;
}

.proxy-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 255, 231, 0.3);
}

.proxy-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.proxy-btn.secondary {
    background: transparent;
    color: #00ffe7;
    border: 2px solid #00ffe7;
}

.proxy-btn.secondary:hover {
    background: #00ffe7;
    color: #0a0e17;
}

.proxy-results {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.2);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.proxy-result-item {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    border-left: 3px solid #00ffe7;
}

.proxy-result-item.success {
    background: rgba(0, 255, 65, 0.1);
    border-left-color: #00ff41;
}

.proxy-result-item.error {
    background: rgba(255, 68, 68, 0.1);
    border-left-color: #ff4444;
}

.proxy-result-item.warning {
    background: rgba(255, 170, 0, 0.1);
    border-left-color: #ffaa00;
}

.proxy-input {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 8px;
    padding: 0.8rem;
    color: #e6e6e6;
    font-family: inherit;
    width: 100%;
    margin-bottom: 1rem;
}

.proxy-input:focus {
    outline: none;
    border-color: #00ffe7;
    box-shadow: 0 0 0 2px rgba(0, 255, 231, 0.2);
}

.proxy-select {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 8px;
    padding: 0.8rem;
    color: #e6e6e6;
    font-family: inherit;
    width: 100%;
    margin-bottom: 1rem;
}

.proxy-select:focus {
    outline: none;
    border-color: #00ffe7;
}

.proxy-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
}

.stat-number {
    color: #00ffe7;
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #8a9ba8;
    font-size: 0.9rem;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 255, 231, 0.3);
    border-radius: 50%;
    border-top-color: #00ffe7;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.proxy-terminal {
    background: #111417;
    color: #00ffe7;
    font-family: 'Courier New', monospace;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    border: 1px solid rgba(0, 255, 231, 0.3);
    max-height: 400px;
    overflow-y: auto;
}

.proxy-terminal::before {
    content: '$ ';
    color: #00bfff;
    font-weight: bold;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.proxy-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.proxy-modal-content {
    background: linear-gradient(135deg, rgba(26,31,46,0.95) 0%, rgba(0,255,231,0.1) 100%);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    color: #e6e6e6;
    backdrop-filter: blur(15px);
    box-shadow: 0 0 30px rgba(0, 255, 231, 0.3);
}

.proxy-modal-content h3 {
    color: #00ffe7;
    margin-bottom: 1rem;
    text-align: center;
}

.config-info {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    border-left: 3px solid #00ffe7;
}

.config-info p {
    margin: 0.5rem 0;
    font-family: 'JetBrains Mono', monospace;
}

.config-note {
    background: rgba(255, 107, 157, 0.1);
    border: 1px solid rgba(255, 107, 157, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    color: #ff6b9d;
    font-style: italic;
}

/* æˆåŠŸæŒ‰é’®æ ·å¼ */
.proxy-btn.success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border-color: #28a745;
}

.proxy-btn.success:hover {
    background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
}

/* å¿«æ·è®¿é—®æŒ‰é’®ç½‘æ ¼ */
.quick-access-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin: 15px 0;
}

.quick-btn {
    background: linear-gradient(135deg, rgba(26,31,46,0.8) 0%, rgba(0,255,231,0.1) 100%);
    border: 1px solid rgba(0, 255, 231, 0.2);
    border-radius: 12px;
    padding: 15px 10px;
    color: #e6e6e6;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-family: inherit;
    text-decoration: none;
    position: relative;
    overflow: hidden;
}

.quick-btn:hover {
    transform: translateY(-3px);
    border-color: #00ffe7;
    box-shadow: 0 8px 25px rgba(0, 255, 231, 0.3);
}

.quick-btn i {
    font-size: 1.8rem;
    transition: transform 0.3s ease;
}

.quick-btn:hover i {
    transform: scale(1.1);
}

.quick-btn span {
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* ç‰¹å®šç½‘ç«™å“ç‰Œè‰²å½© */
.quick-btn.youtube:hover {
    border-color: #ff0000;
    box-shadow: 0 8px 25px rgba(255, 0, 0, 0.3);
}

.quick-btn.youtube:hover i {
    color: #ff0000;
}

.quick-btn.google:hover {
    border-color: #4285f4;
    box-shadow: 0 8px 25px rgba(66, 133, 244, 0.3);
}

.quick-btn.google:hover i {
    color: #4285f4;
}

.quick-btn.facebook:hover {
    border-color: #1877f2;
    box-shadow: 0 8px 25px rgba(24, 119, 242, 0.3);
}

.quick-btn.facebook:hover i {
    color: #1877f2;
}

.quick-btn.twitter:hover {
    border-color: #1da1f2;
    box-shadow: 0 8px 25px rgba(29, 161, 242, 0.3);
}

.quick-btn.twitter:hover i {
    color: #1da1f2;
}

.quick-btn.instagram:hover {
    border-color: #e4405f;
    box-shadow: 0 8px 25px rgba(228, 64, 95, 0.3);
}

.quick-btn.instagram:hover i {
    color: #e4405f;
}

.quick-btn.github:hover {
    border-color: #333;
    box-shadow: 0 8px 25px rgba(51, 51, 51, 0.3);
}

.quick-btn.github:hover i {
    color: #333;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .proxy-container {
        padding: 1rem;
    }
    
    .proxy-title {
        font-size: 2rem;
    }
    
    .proxy-grid {
        grid-template-columns: 1fr;
    }
    
    .proxy-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .quick-access-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="proxy-container">
    <div class="proxy-header">
        <h1 class="proxy-title">
            <i class="fas fa-shield-alt"></i>
            ä»£ç†ç¿»å¢™ç³»ç»Ÿ
        </h1>
        <p class="proxy-subtitle">ğŸŒ ä¸“ä¸šç¿»å¢™æœåŠ¡ - å®‰å…¨ç¨³å®šè®¿é—®å…¨çƒç½‘ç»œ</p>
    </div>

    <!-- ç³»ç»ŸçŠ¶æ€ -->
    <div class="proxy-stats" id="proxyStats">
        <div class="stat-card">
            <div class="stat-number" id="localIP">æ£€æµ‹ä¸­...</div>
            <div class="stat-label">æœ¬åœ°IP</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="proxyIP">æ£€æµ‹ä¸­...</div>
            <div class="stat-label">ä»£ç†IP</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="proxyStatus">æ£€æµ‹ä¸­...</div>
            <div class="stat-label">ä»£ç†çŠ¶æ€</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="systemStatus">å°±ç»ª</div>
            <div class="stat-label">ç³»ç»ŸçŠ¶æ€</div>
        </div>
    </div>

    <!-- å•†ä¸šåŒ–ç¿»å¢™æœåŠ¡ -->
    <div class="proxy-grid">
        <!-- æœåŠ¡çŠ¶æ€æ£€æµ‹ -->
        <div class="proxy-card">
            <h3 class="proxy-card-title">
                <i class="fas fa-shield-check"></i>
                æœåŠ¡çŠ¶æ€æ£€æµ‹
            </h3>
            <p class="proxy-description">æ£€æµ‹æ‚¨å½“å‰ç½‘ç»œçŠ¶æ€å’Œæˆ‘ä»¬ä»£ç†æœåŠ¡çš„è¿æ¥æƒ…å†µ</p>
            <button class="proxy-btn" onclick="getIPComparison()">
                <i class="fas fa-sync-alt"></i>
                æ£€æµ‹ç½‘ç»œçŠ¶æ€
            </button>
            <div class="proxy-results" id="ipComparisonResults"></div>
        </div>

        <!-- Webç¿»å¢™æµè§ˆå™¨ - ä¸»è¦æœåŠ¡ -->
        <div class="proxy-card" style="grid-column: span 2;">
            <h3 class="proxy-card-title">
                <i class="fas fa-globe-americas"></i>
                åœ¨çº¿ç¿»å¢™æµè§ˆå™¨
            </h3>
            <p class="proxy-description">æ— éœ€ä¸‹è½½è½¯ä»¶ï¼Œç›´æ¥åœ¨ç½‘é¡µå†…å®‰å…¨è®¿é—®YouTubeã€Googleç­‰å…¨çƒç½‘ç«™</p>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <input type="text" class="proxy-input" id="webBrowserUrl" 
                       placeholder="è¾“å…¥ç½‘å€æˆ–ç›´æ¥ç‚¹å‡»ä¸‹æ–¹å¿«æ·æŒ‰é’®" style="flex: 1;">
                <button class="proxy-btn" onclick="openWebBrowser()">
                    <i class="fas fa-rocket"></i>
                    ç«‹å³è®¿é—®
                </button>
            </div>

            <!-- çƒ­é—¨ç½‘ç«™å¿«æ·è®¿é—® -->
            <div class="quick-access-grid">
                <button class="quick-btn youtube" onclick="quickAccess('youtube.com')">
                    <i class="fab fa-youtube"></i>
                    <span>YouTube</span>
                </button>
                <button class="quick-btn google" onclick="quickAccess('google.com')">
                    <i class="fab fa-google"></i>
                    <span>Google</span>
                </button>
                <button class="quick-btn facebook" onclick="quickAccess('facebook.com')">
                    <i class="fab fa-facebook"></i>
                    <span>Facebook</span>
                </button>
                <button class="quick-btn twitter" onclick="quickAccess('twitter.com')">
                    <i class="fab fa-twitter"></i>
                    <span>Twitter</span>
                </button>
                <button class="quick-btn instagram" onclick="quickAccess('instagram.com')">
                    <i class="fab fa-instagram"></i>
                    <span>Instagram</span>
                </button>
                <button class="quick-btn github" onclick="quickAccess('github.com')">
                    <i class="fab fa-github"></i>
                    <span>GitHub</span>
                </button>
            </div>
            <div class="proxy-results" id="webBrowserResults"></div>
        </div>
    </div>

    <!-- ç»ˆç«¯è¾“å‡º -->
    <div class="proxy-terminal" id="proxyTerminal">
        ä»£ç†ç³»ç»Ÿå·²å¯åŠ¨...
        è¾“å…¥ 'help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤
    </div>
</div>

<!-- ç”»ä¸­ç”»Webæµè§ˆå™¨æ¨¡æ€æ¡† -->
<div class="web-browser-modal" id="webBrowserModal" style="display: none;">
    <div class="web-browser-content">
        <div class="web-browser-header">
            <div class="web-browser-controls">
                <button class="browser-btn" onclick="browserBack()">
                    <i class="fas fa-arrow-left"></i>
            </button>
                <button class="browser-btn" onclick="browserForward()">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <button class="browser-btn" onclick="browserRefresh()">
                    <i class="fas fa-sync-alt"></i>
                </button>
        </div>
            <div class="web-browser-address">
                <input type="text" id="browserAddressBar" placeholder="è¾“å…¥ç½‘å€...">
                <button class="browser-btn primary" onclick="browserNavigate()">
                    <i class="fas fa-arrow-right"></i>
            </button>
        </div>
                        <div class="web-browser-actions">
                <button class="browser-btn" onclick="openInNewWindow()" title="åœ¨æ–°çª—å£æ‰“å¼€">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button class="browser-btn" onclick="refreshCurrentPage()" title="åˆ·æ–°é¡µé¢">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="browser-btn" onclick="toggleFullscreen()" title="å…¨å±æ¨¡å¼">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="browser-btn" onclick="togglePictureInPicture()" title="ç”»ä¸­ç”»æ¨¡å¼">
                    <i class="fas fa-compress"></i>
                </button>
                <button class="browser-btn" onclick="closeBrowser()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
    </div>
        <div class="web-browser-loading" id="browserLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <span>æ­£åœ¨åŠ è½½...</span>
        </div>
        <div class="web-browser-iframe-container" id="browserContainer">
            <div class="browser-placeholder">
                <i class="fas fa-globe" style="font-size: 3rem; color: #00ffe7; margin-bottom: 1rem;"></i>
                <p>Webä»£ç†æµè§ˆå™¨å·²å‡†å¤‡å°±ç»ª</p>
                <p>è¾“å…¥ç½‘å€å¼€å§‹æµè§ˆå¤–ç½‘å†…å®¹</p>
            </div>
        </div>
    </div>
</div>

<style>
/* Webæµè§ˆå™¨æ¨¡æ€æ¡†æ ·å¼ */
.web-browser-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.web-browser-content {
    background: linear-gradient(135deg, rgba(26,31,46,0.95) 0%, rgba(0,255,231,0.1) 100%);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 12px;
    width: 95%;
    height: 90%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    backdrop-filter: blur(15px);
}

.web-browser-header {
    background: rgba(26, 31, 46, 0.8);
    padding: 10px;
    border-bottom: 1px solid rgba(0, 255, 231, 0.2);
    display: flex;
    align-items: center;
    gap: 15px;
}

.web-browser-controls {
    display: flex;
    gap: 5px;
}

.browser-btn {
    background: rgba(0, 255, 231, 0.1);
    color: #00ffe7;
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.browser-btn:hover {
    background: rgba(0, 255, 231, 0.2);
    box-shadow: 0 2px 8px rgba(0, 255, 231, 0.3);
}

.browser-btn.primary {
    background: linear-gradient(135deg, #00ffe7 0%, #00bfff 100%);
    color: #0a0e17;
    border-color: #00ffe7;
}

.web-browser-address {
    flex: 1;
    display: flex;
    gap: 8px;
    align-items: center;
}

.web-browser-address input {
    flex: 1;
    background: rgba(26, 31, 46, 0.8);
    border: 1px solid rgba(0, 255, 231, 0.3);
    border-radius: 6px;
    padding: 8px 12px;
    color: #e6e6e6;
    font-family: inherit;
}

.web-browser-address input:focus {
    outline: none;
    border-color: #00ffe7;
    box-shadow: 0 0 0 2px rgba(0, 255, 231, 0.2);
}

.web-browser-actions {
    display: flex;
    gap: 5px;
}

.web-browser-loading {
    background: rgba(26, 31, 46, 0.9);
    padding: 20px;
    text-align: center;
    color: #00ffe7;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(0, 255, 231, 0.3);
    border-top: 2px solid #00ffe7;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.web-browser-iframe-container {
    flex: 1;
    background: #0a0e17;
    position: relative;
    overflow: hidden;
}

.browser-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #8a9ba8;
    text-align: center;
}

.web-browser-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
}

/* ç”»ä¸­ç”»æ¨¡å¼æ ·å¼ */
.picture-in-picture {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 400px;
    height: 300px;
    z-index: 3000;
    resize: both;
    overflow: auto;
    min-width: 300px;
    min-height: 200px;
}

.picture-in-picture .web-browser-content {
    width: 100%;
    height: 100%;
}

@media (max-width: 768px) {
    .web-browser-content {
        width: 98%;
        height: 95%;
    }
    
    .web-browser-header {
        flex-wrap: wrap;
        padding: 8px;
    }
    
    .web-browser-controls, .web-browser-actions {
        order: 3;
        margin-top: 8px;
    }
    
    .web-browser-address {
        order: 1;
        width: 100%;
    }
}
</style>

<script>
// ç®€åŒ–çš„ä»£ç†ç³»ç»Ÿ - ä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½
let systemReady = false;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”§ ä»£ç†ç³»ç»Ÿåˆå§‹åŒ–...');
    initializeSystem();
    log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
});

// åˆå§‹åŒ–å•†ä¸šåŒ–ç¿»å¢™æœåŠ¡
async function initializeSystem() {
    try {
        log('æ­£åœ¨åˆå§‹åŒ–ä¸“ä¸šç¿»å¢™æœåŠ¡...');
        document.getElementById('systemStatus').textContent = 'åˆå§‹åŒ–ä¸­...';
        
        // æ£€æµ‹ä»£ç†æœåŠ¡çŠ¶æ€
        await checkProxyStatus();
        
        // è‡ªåŠ¨è·å–IPå¯¹æ¯”ä»¥æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
        await getIPComparison();
        
        // æµ‹è¯•YouTubeè®¿é—®ï¼ˆéœ€è¦ç¿»å¢™ï¼‰
        await testYouTubeAccess();
        
        systemReady = true;
        document.getElementById('systemStatus').textContent = 'å°±ç»ª';
        log('âœ… ç¿»å¢™æœåŠ¡å·²å°±ç»ª');
        log('ğŸŒ å¯ç›´æ¥è®¿é—®YouTubeã€Googleç­‰å…¨çƒç½‘ç«™');
        
    } catch (error) {
        log(`âŒ æœåŠ¡åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('systemStatus').textContent = 'é”™è¯¯';
    }
}

// æ£€æµ‹ä»£ç†æœåŠ¡çŠ¶æ€
async function checkProxyStatus() {
    try {
        log('ğŸ” æ£€æµ‹ä»£ç†æœåŠ¡çŠ¶æ€...');
        
        // æ£€æµ‹æœ¬åœ°ä»£ç†æœåŠ¡å™¨
        const localProxyStatus = await testLocalProxy();
        if (localProxyStatus) {
            document.getElementById('proxyStatus').textContent = 'æœ¬åœ°ä»£ç†å¯ç”¨';
            document.getElementById('proxyStatus').style.color = '#00ff88';
            log('âœ… æœ¬åœ°ä»£ç†æœåŠ¡å™¨è¿è¡Œæ­£å¸¸');
        } else {
            document.getElementById('proxyStatus').textContent = 'æœ¬åœ°ä»£ç†ä¸å¯ç”¨';
            document.getElementById('proxyStatus').style.color = '#ff6b6b';
            log('âš ï¸  æœ¬åœ°ä»£ç†æœåŠ¡å™¨æœªè¿è¡Œï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
        }
        
    } catch (error) {
        log(`âŒ ä»£ç†çŠ¶æ€æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('proxyStatus').textContent = 'æ£€æµ‹å¤±è´¥';
        document.getElementById('proxyStatus').style.color = '#ff6b6b';
    }
}

// æµ‹è¯•æœ¬åœ°ä»£ç†æœåŠ¡å™¨
async function testLocalProxy() {
    try {
        const response = await fetch('http://127.0.0.1:8080', {
            method: 'GET',
            mode: 'no-cors',
            timeout: 3000
        });
        return true;
    } catch (error) {
        return false;
    }
}

// æµ‹è¯•YouTubeè®¿é—®ï¼ˆéœ€è¦ç¿»å¢™ï¼‰
async function testYouTubeAccess() {
    try {
        log('ğŸ” æµ‹è¯•YouTubeè®¿é—®...');
        
        // ä½¿ç”¨æœ¬åœ°ä»£ç†æµ‹è¯•YouTubeè®¿é—®
        const response = await fetch('/tools/api/proxy/web-browse/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ url: 'https://www.youtube.com' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            log('âœ… YouTubeè®¿é—®æ­£å¸¸ï¼Œä»£ç†æœåŠ¡å·¥ä½œè‰¯å¥½', 'success');
            document.getElementById('systemStatus').textContent = 'ä»£ç†æ­£å¸¸';
            document.getElementById('systemStatus').style.color = '#00ff88';
        } else {
            log(`âš ï¸  YouTubeè®¿é—®å¼‚å¸¸: ${data.error}`, 'warning');
            document.getElementById('systemStatus').textContent = 'ä»£ç†å¼‚å¸¸';
            document.getElementById('systemStatus').style.color = '#ffaa00';
        }
    } catch (error) {
        log(`âŒ YouTubeè®¿é—®å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('systemStatus').textContent = 'ç½‘ç»œé”™è¯¯';
        document.getElementById('systemStatus').style.color = '#ff6b6b';
    }
}

// æ—¥å¿—è¾“å‡º
function log(message, type = 'info') {
    const terminal = document.getElementById('proxyTerminal');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'error' ? '#ff4444' : type === 'success' ? '#00ff41' : '#00ffe7';
    
    terminal.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
    terminal.scrollTop = terminal.scrollHeight;
    console.log(`[${timestamp}] ${message}`);
}

// ===== æ ¸å¿ƒåŠŸèƒ½1: IPå¯¹æ¯”åŠŸèƒ½ =====
async function getIPComparison() {
    try {
        log('æ­£åœ¨è·å–IPå¯¹æ¯”ä¿¡æ¯...');
        document.getElementById('localIP').textContent = 'æ£€æµ‹ä¸­...';
        document.getElementById('proxyIP').textContent = 'æ£€æµ‹ä¸­...';
        
        const response = await fetch('/tools/api/proxy/ip-comparison/');
        const data = await response.json();
        
        if (data.success) {
            displayIPComparison(data.data);
            log('âœ… IPå¯¹æ¯”è·å–å®Œæˆ', 'success');
        } else {
            log(`âŒ IPå¯¹æ¯”è·å–å¤±è´¥: ${data.error}`, 'error');
            document.getElementById('localIP').textContent = 'è·å–å¤±è´¥';
            document.getElementById('proxyIP').textContent = 'è·å–å¤±è´¥';
        }
    } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
        document.getElementById('localIP').textContent = 'ç½‘ç»œé”™è¯¯';
        document.getElementById('proxyIP').textContent = 'ç½‘ç»œé”™è¯¯';
    }
}



// æ˜¾ç¤ºIPå¯¹æ¯”ç»“æœ
function displayIPComparison(data) {
    const resultsDiv = document.getElementById('ipComparisonResults');
    let html = '<div class="proxy-result-item">';
    
    // æ›´æ–°çŠ¶æ€æ 
    if (data.direct_ip.success) {
        document.getElementById('localIP').textContent = data.direct_ip.ip;
        html += `
            <div style="margin-bottom: 15px;">
                <strong>ğŸŒ æœ¬åœ°IP:</strong> ${data.direct_ip.ip}
                <br><small>ä½ç½®: ${data.direct_ip.country} ${data.direct_ip.region} ${data.direct_ip.city}</small>
                <br><small>ISP: ${data.direct_ip.isp}</small>
            </div>
        `;
    } else {
        document.getElementById('localIP').textContent = 'è·å–å¤±è´¥';
        html += `
            <div style="margin-bottom: 15px;">
                <strong>ğŸŒ æœ¬åœ°IP:</strong> è·å–å¤±è´¥
                <br><small>é”™è¯¯: ${data.direct_ip.error}</small>
            </div>
        `;
    }
    
    // ä»£ç†IP
    if (data.proxy_ip && data.proxy_ip.success) {
        document.getElementById('proxyIP').textContent = data.proxy_ip.ip;
        html += `
            <div style="margin-bottom: 15px;">
                <strong>ğŸ”— ä»£ç†IP:</strong> ${data.proxy_ip.ip}
                <br><small>ä½ç½®: ${data.proxy_ip.country} ${data.proxy_ip.region} ${data.proxy_ip.city}</small>
                <br><small>ä»£ç†: ${data.proxy_ip.proxy_used}</small>
            </div>
        `;
    } else {
        document.getElementById('proxyIP').textContent = 'N/A';
        html += `
            <div style="margin-bottom: 15px;">
                <strong>ğŸ”— ä»£ç†IP:</strong> æ— æ³•è·å–
                <br><small>è¯´æ˜: éœ€è¦ä½¿ç”¨Trojanå®¢æˆ·ç«¯é…ç½®</small>
            </div>
        `;
    }
    
    html += '</div>';
    resultsDiv.innerHTML = html;
}

// ===== æ ¸å¿ƒåŠŸèƒ½2: ä¸€é”®ä»£ç†è®¾ç½®åŠŸèƒ½ =====
// æ³¨æ„: æ­¤åŠŸèƒ½éœ€è¦ç›¸åº”çš„HTMLå…ƒç´ æ”¯æŒï¼Œå½“å‰ç‰ˆæœ¬å·²æ³¨é‡Š
/*
async function setupProxy() {
    const targetUrl = document.getElementById('targetWebsite').value.trim();
    if (!targetUrl) {
        log('âŒ è¯·è¾“å…¥è¦è®¿é—®çš„å¤–ç½‘åœ°å€', 'error');
        return;
    }
    
    try {
        log(`æ­£åœ¨ä¸º ${targetUrl} è®¾ç½®æœ€ä½³ä»£ç†...`);
        document.getElementById('proxySetupResults').innerHTML = '<div class="loading"></div> æ­£åœ¨åˆ†ææœ€ä½³ä»£ç†...';
        
        const response = await fetch('/tools/api/proxy/setup/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ url: targetUrl })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayProxySetup(data.data, targetUrl);
            log(`âœ… ä»£ç†è®¾ç½®å®Œæˆ`, 'success');
        } else {
            log(`âŒ ä»£ç†è®¾ç½®å¤±è´¥: ${data.error}`, 'error');
            document.getElementById('proxySetupResults').innerHTML = `<div class="proxy-result-item error">è®¾ç½®å¤±è´¥: ${data.error}</div>`;
        }
    } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
        document.getElementById('proxySetupResults').innerHTML = `<div class="proxy-result-item error">ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
    }
}

// æ˜¾ç¤ºä»£ç†è®¾ç½®ç»“æœ
function displayProxySetup(data, targetUrl) {
    const resultsDiv = document.getElementById('proxySetupResults');
    
    if (data.success) {
        const proxy = data.recommended_proxy;
        const item = document.createElement('div');
        item.className = 'proxy-result-item success';
        item.innerHTML = `
            <div style="margin-bottom: 15px;">
                <strong>ğŸ¯ æ¨èä»£ç†èŠ‚ç‚¹:</strong> ${proxy.name}
                <br><small>æœåŠ¡å™¨: ${proxy.server}:${proxy.port}</small>
                <br><small>ä½ç½®: ${proxy.country} | ç±»å‹: ${proxy.type}</small>
                <br><small>æ¨èç†ç”±: ${data.reason}</small>
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>ğŸŒ ç›®æ ‡ç½‘ç«™:</strong> ${targetUrl}
            </div>
            
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 10px 0;">
                ${proxy.type === 'trojan' ? `
                    <h4 style="color: #00ffe7; margin-bottom: 10px;">ğŸ” Trojané…ç½®ä¿¡æ¯</h4>
                    <p><strong>æœåŠ¡å™¨:</strong> ${proxy.server}</p>
                    <p><strong>ç«¯å£:</strong> ${proxy.port}</p>
                    <p><strong>å¯†ç :</strong> ${proxy.password}</p>
                    <p><strong>åè®®:</strong> Trojan</p>
                    
                    <div style="background: rgba(255,107,157,0.1); padding: 10px; border-radius: 5px; margin: 10px 0; color: #ff6b9d;">
                        ğŸ’¡ <strong>ä½¿ç”¨æ–¹æ³•:</strong><br>
                        1. ä¸‹è½½Clashã€V2Rayç­‰å®¢æˆ·ç«¯<br>
                        2. å°†ä»¥ä¸Šé…ç½®ä¿¡æ¯æ·»åŠ åˆ°å®¢æˆ·ç«¯<br>
                        3. å¯ç”¨ä»£ç†åå³å¯è®¿é—® ${targetUrl}
                    </div>
                    
                    <button class="proxy-btn" onclick="copyTrojanConfig('${proxy.server}', '${proxy.port}', '${proxy.password}')">
                        ğŸ“‹ å¤åˆ¶é…ç½®ä¿¡æ¯
                    </button>
                ` : `
                    <h4 style="color: #00ffe7; margin-bottom: 10px;">ğŸ”— HTTPä»£ç†è®¾ç½®</h4>
                    <p><strong>ä»£ç†åœ°å€:</strong> ${proxy.server}</p>
                    <p><strong>ä»£ç†ç«¯å£:</strong> ${proxy.port}</p>
                    <p><strong>åè®®:</strong> HTTP</p>
                    
                    <div style="background: rgba(255,107,157,0.1); padding: 10px; border-radius: 5px; margin: 10px 0; color: #ff6b9d;">
                        ğŸ’¡ <strong>ä½¿ç”¨æ–¹æ³•:</strong><br>
                        åœ¨æµè§ˆå™¨æˆ–ç³»ç»Ÿç½‘ç»œè®¾ç½®ä¸­é…ç½®HTTPä»£ç†å³å¯è®¿é—®å¤–ç½‘
                    </div>
                `}
            </div>
            
            <button class="proxy-btn success" onclick="testProxyAccess('${proxy.name}', '${targetUrl}')">
                ğŸš€ æµ‹è¯•ä»£ç†è®¿é—®
            </button>
        `;
        resultsDiv.innerHTML = '';
        resultsDiv.appendChild(item);
    } else {
        const item = document.createElement('div');
        item.className = 'proxy-result-item error';
        item.innerHTML = `
            <strong>âŒ ä»£ç†è®¾ç½®å¤±è´¥</strong>
            <br>é”™è¯¯: ${data.error}
            <br>ç›®æ ‡ç½‘ç«™: ${targetUrl}
        `;
        resultsDiv.innerHTML = '';
        resultsDiv.appendChild(item);
    }
}
*/

// ===== æ ¸å¿ƒåŠŸèƒ½: Webç¿»å¢™æµè§ˆå™¨ =====

let currentBrowserUrl = '';
let browserHistory = [];
let currentHistoryIndex = -1;
let isPictureInPicture = false;

// æ‰“å¼€Webä»£ç†æµè§ˆå™¨
async function openWebBrowser() {
    const url = document.getElementById('webBrowserUrl').value.trim();
    if (!url) {
        log('âŒ è¯·è¾“å…¥è¦è®¿é—®çš„ç½‘å€', 'error');
        return;
    }
    
    // æ˜¾ç¤ºæµè§ˆå™¨æ¨¡æ€æ¡†
    document.getElementById('webBrowserModal').style.display = 'flex';
    document.getElementById('browserAddressBar').value = url;
    
    // åŠ è½½ç½‘é¡µ
    await loadWebPage(url);
}

// å¿«é€Ÿè®¿é—®é¢„è®¾ç½‘ç«™
async function quickAccess(url) {
    document.getElementById('webBrowserUrl').value = url;
    await openWebBrowser();
}

// åŠ è½½ç½‘é¡µå†…å®¹
async function loadWebPage(url) {
    try {
        // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'https://' + url;
        }
        
        log(`æ­£åœ¨åŠ è½½: ${url}`);
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('browserLoading').style.display = 'flex';
        document.getElementById('browserContainer').innerHTML = '';
        
        const response = await fetch('/tools/api/proxy/web-browse/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ url: url })
        });
        
        const data = await response.json();
        
        // éšè—åŠ è½½çŠ¶æ€
        document.getElementById('browserLoading').style.display = 'none';
        
        if (data.success) {
            // å¤„ç†å†…å®¹ç¼–ç å’Œæ˜¾ç¤º
            let content = data.data.content;
            
            // ç¡®ä¿å†…å®¹åŒ…å«æ­£ç¡®çš„ç¼–ç å£°æ˜
            if (!content.includes('charset') && !content.includes('encoding')) {
                if (content.includes('<head>')) {
                    content = content.replace('<head>', '<head><meta charset="UTF-8">');
                } else if (content.includes('<html>')) {
                    content = content.replace('<html>', '<html><head><meta charset="UTF-8"></head>');
                } else {
                    content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>ä»£ç†æµè§ˆå™¨</title></head><body>${content}</body></html>`;
                }
            }
            
            // æ·»åŠ åŸºç¡€æ ·å¼æ¥æ”¹å–„æ˜¾ç¤ºæ•ˆæœ
            const baseStyles = `
                <style>
                    body { 
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
                        line-height: 1.6;
                        color: #333;
                        margin: 20px;
                        background-color: #fff;
                    }
                    img { max-width: 100%; height: auto; }
                    a { color: #1976d2; text-decoration: none; }
                    a:hover { text-decoration: underline; }
                </style>
            `;
            
            if (content.includes('</head>')) {
                content = content.replace('</head>', baseStyles + '</head>');
            } else {
                content = baseStyles + content;
            }
            
            // åˆ›å»ºiframeæ˜¾ç¤ºå†…å®¹
            const iframe = document.createElement('iframe');
            iframe.className = 'web-browser-iframe';
            // æ›´å®½æ¾çš„sandboxè®¾ç½®ä»¥æ”¯æŒæ›´å¤šäº¤äº’
            iframe.sandbox = 'allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation allow-pointer-lock allow-orientation-lock allow-presentation allow-downloads';
            
            // ä½¿ç”¨blob URLæ¥é¿å…ç¼–ç é—®é¢˜
            const blob = new Blob([content], { type: 'text/html; charset=utf-8' });
            const blobUrl = URL.createObjectURL(blob);
            
            iframe.onload = function() {
                URL.revokeObjectURL(blobUrl);
                log(`âœ… ç½‘é¡µå†…å®¹åŠ è½½å®Œæˆ: ${data.data.final_url}`, 'success');
                log(`ğŸ“Š å†…å®¹é•¿åº¦: ${data.data.content_length} å­—ç¬¦`, 'info');
                log(`ğŸ”¤ ä½¿ç”¨ç¼–ç : ${data.data.charset_used || 'unknown'}`, 'info');
                
                // æ”¹è¿›iframeäº¤äº’å¤„ç†
                setTimeout(() => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc && iframeDoc.body) {
                            const bodyText = iframeDoc.body.innerText || iframeDoc.body.textContent;
                            if (!bodyText || bodyText.trim().length < 10) {
                                log(`âš ï¸  iframeå†…å®¹å¯èƒ½ä¸ºç©ºï¼Œå»ºè®®åœ¨æ–°çª—å£æ‰“å¼€`, 'warning');
                                // å°è¯•ä½¿ç”¨srcdocæ–¹å¼
                                iframe.srcdoc = content;
                            } else if (bodyText.includes('ï¿½') || bodyText.match(/[^\x00-\x7F\u4e00-\u9fff\u3400-\u4dbf]/g)) {
                                log(`âš ï¸  æ£€æµ‹åˆ°å¯èƒ½çš„ä¹±ç å­—ç¬¦ï¼Œå»ºè®®åœ¨æ–°çª—å£æ‰“å¼€è·å¾—æ›´å¥½ä½“éªŒ`, 'warning');
                            } else {
                                log(`âœ… iframeå†…å®¹éªŒè¯é€šè¿‡`, 'success');
                            }
                            
                            // æ·»åŠ ç‚¹å‡»æç¤º
                            const interactionHint = document.createElement('div');
                            interactionHint.style.cssText = `
                                position: absolute;
                                top: 10px;
                                right: 10px;
                                background: rgba(0, 0, 0, 0.8);
                                color: white;
                                padding: 8px 12px;
                                border-radius: 5px;
                                font-size: 12px;
                                z-index: 1000;
                                cursor: pointer;
                                transition: opacity 0.3s;
                            `;
                            interactionHint.innerHTML = 'ğŸ’¡ äº¤äº’å—é™ï¼Ÿç‚¹å‡»"æ–°çª—å£æ‰“å¼€"è·å¾—å®Œæ•´ä½“éªŒ';
                            interactionHint.onclick = () => openInNewWindow();
                            
                            const browserContainer = document.getElementById('browserContainer');
                            browserContainer.style.position = 'relative';
                            browserContainer.appendChild(interactionHint);
                            
                            // 5ç§’åè‡ªåŠ¨éšè—æç¤º
                            setTimeout(() => {
                                if (interactionHint && interactionHint.parentNode) {
                                    interactionHint.style.opacity = '0';
                                    setTimeout(() => {
                                        if (interactionHint.parentNode) {
                                            interactionHint.parentNode.removeChild(interactionHint);
                                        }
                                    }, 300);
                                }
                            }, 5000);
                        }
                    } catch (e) {
                        log(`â„¹ï¸  iframeäº¤äº’å—é™ï¼ˆè·¨åŸŸä¿æŠ¤ï¼‰ï¼Œå»ºè®®ä½¿ç”¨"æ–°çª—å£æ‰“å¼€"åŠŸèƒ½`, 'info');
                    }
                }, 1000);
            };
            
            iframe.onerror = function() {
                URL.revokeObjectURL(blobUrl);
                log(`âŒ iframeåŠ è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨srcdocæ–¹å¼`, 'error');
                
                // å°è¯•ä½¿ç”¨srcdocä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                iframe.src = '';
                iframe.srcdoc = content;
            };
            
            iframe.src = blobUrl;
            
            document.getElementById('browserContainer').innerHTML = '';
            document.getElementById('browserContainer').appendChild(iframe);
            
            // æ›´æ–°æµè§ˆå†å²
            currentBrowserUrl = url;
            if (currentHistoryIndex === -1 || browserHistory[currentHistoryIndex] !== url) {
                browserHistory = browserHistory.slice(0, currentHistoryIndex + 1);
                browserHistory.push(url);
                currentHistoryIndex = browserHistory.length - 1;
            }
            
            log(`âœ… ç½‘é¡µåŠ è½½æˆåŠŸ: ${url}`, 'success');
            
        } else {
            document.getElementById('browserContainer').innerHTML = 
                `<div class="browser-placeholder">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff4444; margin-bottom: 1rem;"></i>
                    <p>ç½‘é¡µåŠ è½½å¤±è´¥</p>
                    <p>${data.error}</p>
                </div>`;
            log(`âŒ ç½‘é¡µåŠ è½½å¤±è´¥: ${data.error}`, 'error');
        }
        
    } catch (error) {
        document.getElementById('browserLoading').style.display = 'none';
        document.getElementById('browserContainer').innerHTML = 
            `<div class="browser-placeholder">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff4444; margin-bottom: 1rem;"></i>
                <p>ç½‘ç»œé”™è¯¯</p>
                <p>${error.message}</p>
            </div>`;
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
    }
}

// æµè§ˆå™¨å¯¼èˆª
async function browserNavigate() {
    const url = document.getElementById('browserAddressBar').value.trim();
    if (url) {
        await loadWebPage(url);
    }
}

// æµè§ˆå™¨åé€€
function browserBack() {
    if (currentHistoryIndex > 0) {
        currentHistoryIndex--;
        const url = browserHistory[currentHistoryIndex];
        document.getElementById('browserAddressBar').value = url;
        loadWebPage(url);
    }
}

// æµè§ˆå™¨å‰è¿›
function browserForward() {
    if (currentHistoryIndex < browserHistory.length - 1) {
        currentHistoryIndex++;
        const url = browserHistory[currentHistoryIndex];
        document.getElementById('browserAddressBar').value = url;
        loadWebPage(url);
    }
}

// æµè§ˆå™¨åˆ·æ–°
function browserRefresh() {
    if (currentBrowserUrl) {
        loadWebPage(currentBrowserUrl);
    }
}

// åˆ‡æ¢ç”»ä¸­ç”»æ¨¡å¼
function togglePictureInPicture() {
    const modal = document.getElementById('webBrowserModal');
    
    if (!isPictureInPicture) {
        // åˆ‡æ¢åˆ°ç”»ä¸­ç”»æ¨¡å¼
        modal.classList.add('picture-in-picture');
        document.querySelector('.web-browser-modal .fas.fa-compress').className = 'fas fa-expand';
        isPictureInPicture = true;
        log('âœ… å·²åˆ‡æ¢åˆ°ç”»ä¸­ç”»æ¨¡å¼', 'success');
    } else {
        // åˆ‡æ¢åˆ°å…¨å±æ¨¡å¼
        modal.classList.remove('picture-in-picture');
        document.querySelector('.web-browser-modal .fas.fa-expand').className = 'fas fa-compress';
        isPictureInPicture = false;
        log('âœ… å·²åˆ‡æ¢åˆ°å…¨å±æ¨¡å¼', 'success');
    }
}

// å…³é—­æµè§ˆå™¨
function closeBrowser() {
    document.getElementById('webBrowserModal').style.display = 'none';
    isPictureInPicture = false;
    currentBrowserUrl = '';
    log('ğŸ”§ Webä»£ç†æµè§ˆå™¨å·²å…³é—­');
}

// åœ¨æ–°çª—å£æ‰“å¼€å½“å‰é¡µé¢
function openInNewWindow() {
    if (!currentBrowserUrl) {
        log('âŒ æ²¡æœ‰å¯æ‰“å¼€çš„é¡µé¢', 'error');
        return;
    }
    
    // åˆ›å»ºä¸€ä¸ªä»£ç†è®¿é—®é“¾æ¥
    const proxyUrl = `/tools/api/proxy/web-browse/?url=${encodeURIComponent(currentBrowserUrl)}`;
    
    // æ‰“å¼€æ–°çª—å£å¹¶æ˜¾ç¤ºä»£ç†å†…å®¹
    const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
    if (newWindow) {
        newWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>ä»£ç†æµè§ˆå™¨ - ${currentBrowserUrl}</title>
                <meta charset="UTF-8">
                <style>
                    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                    .header { background: #f5f5f5; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
                    .url { color: #666; font-size: 14px; }
                    iframe { width: 100%; height: 80vh; border: 1px solid #ddd; border-radius: 5px; }
                    .loading { text-align: center; padding: 50px; color: #666; }
                </style>
            </head>
            <body>
                <div class="header">
                    <strong>ä»£ç†æµè§ˆå™¨</strong>
                    <div class="url">è®¿é—®: ${currentBrowserUrl}</div>
                </div>
                <div id="content" class="loading">æ­£åœ¨åŠ è½½é¡µé¢å†…å®¹...</div>
                <script>
                    // è·å–é¡µé¢å†…å®¹å¹¶æ˜¾ç¤º
                    const csrfToken = document.cookie.split(';').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
                    fetch('${proxyUrl}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ url: '${currentBrowserUrl}' })
                    })
                    .then(response => response.json())
                    .then(data => {
                        const contentDiv = document.getElementById('content');
                        if (data.success) {
                            const iframe = document.createElement('iframe');
                            iframe.srcdoc = data.data.content;
                            iframe.style.width = '100%';
                            iframe.style.height = '80vh';
                            iframe.style.border = '1px solid #ddd';
                            iframe.style.borderRadius = '5px';
                            contentDiv.innerHTML = '';
                            contentDiv.appendChild(iframe);
                        } else {
                            contentDiv.innerHTML = '<div style="color: red;">åŠ è½½å¤±è´¥: ' + data.error + '</div>';
                        }
                    })
                    .catch(error => {
                        document.getElementById('content').innerHTML = '<div style="color: red;">ç½‘ç»œé”™è¯¯: ' + error.message + '</div>';
                    });
                </script>
            </body>
            </html>
        `);
        log('ğŸ”— é¡µé¢å·²åœ¨æ–°çª—å£æ‰“å¼€ï¼Œå¯ä»¥æ­£å¸¸äº¤äº’', 'success');
    } else {
        log('âŒ æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®', 'error');
    }
}

// åˆ·æ–°å½“å‰é¡µé¢
function refreshCurrentPage() {
    if (!currentBrowserUrl) {
        log('âŒ æ²¡æœ‰å¯åˆ·æ–°çš„é¡µé¢', 'error');
        return;
    }
    
    log('ğŸ”„ åˆ·æ–°é¡µé¢: ' + currentBrowserUrl);
    loadWebPage(currentBrowserUrl);
}

// å…¨å±æ¨¡å¼åˆ‡æ¢
function toggleFullscreen() {
    const modal = document.getElementById('webBrowserModal');
    
    if (!document.fullscreenElement) {
        // è¿›å…¥å…¨å±
        if (modal.requestFullscreen) {
            modal.requestFullscreen();
        } else if (modal.webkitRequestFullscreen) {
            modal.webkitRequestFullscreen();
        } else if (modal.mozRequestFullScreen) {
            modal.mozRequestFullScreen();
        }
        log('ğŸ“º è¿›å…¥å…¨å±æ¨¡å¼', 'success');
    } else {
        // é€€å‡ºå…¨å±
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        }
        log('ğŸªŸ é€€å‡ºå…¨å±æ¨¡å¼', 'success');
    }
}

// ===== è¾…åŠ©å‡½æ•° =====

// å¤åˆ¶Trojané…ç½®ä¿¡æ¯åˆ°å‰ªè´´æ¿
async function copyTrojanConfig(server, port, password) {
    const configText = `
æœåŠ¡å™¨: ${server}
ç«¯å£: ${port}
å¯†ç : ${password}
åè®®: Trojan
    `.trim();
    
    try {
        await navigator.clipboard.writeText(configText);
        log('âœ… é…ç½®ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    } catch (error) {
        log('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é…ç½®ä¿¡æ¯', 'error');
        // åˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸè¿›è¡Œå¤åˆ¶ï¼ˆå…¼å®¹æ€§æ–¹æ¡ˆï¼‰
        const textArea = document.createElement('textarea');
        textArea.value = configText;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            log('âœ… é…ç½®ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        } catch (e) {
            log('âŒ å¤åˆ¶å¤±è´¥', 'error');
        }
        document.body.removeChild(textArea);
    }
}

// æµ‹è¯•ä»£ç†è®¿é—®
async function testProxyAccess(proxyName, targetUrl) {
    try {
        log(`æ­£åœ¨æµ‹è¯•ä»£ç†è®¿é—®: ${proxyName} -> ${targetUrl}`);
        
        const response = await fetch('/tools/api/proxy/create-url/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                proxy: proxyName, 
                url: targetUrl 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.data.proxy_config.type === 'trojan') {
                log('âœ… Trojanä»£ç†é…ç½®å·²ç”Ÿæˆï¼Œè¯·ä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥', 'success');
            } else {
                log('âœ… HTTPä»£ç†è®¿é—®é“¾æ¥å·²åˆ›å»º', 'success');
                // å¯¹äºHTTPä»£ç†ï¼Œå¯ä»¥å°è¯•åœ¨æ–°çª—å£æ‰“å¼€
                window.open(data.data.proxy_url, '_blank');
            }
        } else {
            log(`âŒ åˆ›å»ºä»£ç†è®¿é—®é“¾æ¥å¤±è´¥: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
    }
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', function(e) {
    // å…¨å±€å¿«æ·é”®
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        getIPComparison();
        log('ğŸ”„ åˆ·æ–°ç½‘ç»œçŠ¶æ€');
    }
    if (e.ctrlKey && e.key === 'w') {
        e.preventDefault();
        const url = document.getElementById('webBrowserUrl').value.trim();
        if (url) {
            openWebBrowser();
        } else {
            log('âŒ è¯·å…ˆè¾“å…¥ç½‘å€ï¼Œç„¶åæŒ‰Ctrl+Wæ‰“å¼€ç¿»å¢™æµè§ˆå™¨');
        }
    }
    
    // æµè§ˆå™¨å†…å¿«æ·é”®
    if (document.getElementById('webBrowserModal').style.display === 'flex') {
        if (e.key === 'Escape') {
            closeBrowser();
        }
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            togglePictureInPicture();
        }
    }
});

// æµè§ˆå™¨åœ°å€æ å›è½¦äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    const browserAddressBar = document.getElementById('browserAddressBar');
    if (browserAddressBar) {
        browserAddressBar.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                browserNavigate();
            }
        });
    }
});

log('ğŸš€ ä¸“ä¸šç¿»å¢™æœåŠ¡å·²å¯åŠ¨');
log('ğŸ’¡ å¿«æ·é”®: Ctrl+R æ£€æµ‹ç½‘ç»œçŠ¶æ€, Ctrl+W æ‰“å¼€ç¿»å¢™æµè§ˆå™¨');
log('ğŸŒ æµè§ˆå™¨å¿«æ·é”®: Esc å…³é—­æµè§ˆå™¨, Ctrl+P åˆ‡æ¢ç”»ä¸­ç”»æ¨¡å¼');
</script>
{% endblock %}
