{% extends 'base.html' %}
{% load static %}

{% block tool_title_inner %}æ—¶å…‰èƒ¶å›Šæ—¥è®°{% endblock %}
{% block tool_title_display %}æ—¶å…‰èƒ¶å›Šæ—¥è®°{% endblock %}

{% block extra_css %}
<!-- æ—¶å…‰èƒ¶å›Šæ—¥è®°ä¸“ç”¨æ ·å¼ -->
<style>
:root {
  --primary-color: #6366f1;
  --secondary-color: #8b5cf6;
  --accent-color: #f59e0b;
  --success-color: #10b981;
  --warning-color: #f97316;
  --error-color: #ef4444;
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --bg-primary: #ffffff;
  --bg-secondary: #f9fafb;
  --bg-accent: #f3f4f6;
  --border-color: #e5e7eb;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
  --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%);
  min-height: 100vh;
  color: var(--text-primary);
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 20%;
  left: 10%;
  width: 8px;
  height: 8px;
  background: #06b6d4;
  border-radius: 50%;
  opacity: 0.3;
  z-index: 0;
}

body::after {
  content: '';
  position: fixed;
  top: 60%;
  right: 20%;
  width: 6px;
  height: 6px;
  background: #06b6d4;
  border-radius: 50%;
  opacity: 0.2;
  z-index: 0;
}

.time-capsule-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* å¤´éƒ¨åŒºåŸŸ */
.capsule-header {
  text-align: center;
  margin-bottom: 40px;
  color: white;
}

.capsule-header h1 {
  font-size: 3rem;
  font-weight: 800;
  margin-bottom: 20px;
  color: #1f2937;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
  letter-spacing: -0.02em;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-actions {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin-top: 30px;
  position: relative;
  z-index: 1;
}

.connection-status {
  margin-top: 0;
}

.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  border-radius: 25px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
  backdrop-filter: blur(10px);
  font-size: 0.9rem;
  color: #374151;
  border: 2px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1);
  font-weight: 600;
  transition: all 0.3s ease;
}

.status-indicator:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.15);
  border-color: var(--primary-color);
}

.status-indicator i {
  font-size: 0.8rem;
  transition: color 0.3s ease;
}

.status-indicator.connected i {
  color: #10b981;
}

.status-indicator.disconnected i {
  color: #f59e0b;
}

.status-indicator.error i {
  color: #ef4444;
}

.status-text {
  font-weight: 500;
}

/* ä¸»åŠŸèƒ½åŒºåŸŸ */
.capsule-main {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  margin-bottom: 40px;
}

/* è®°å½•åŒºåŸŸ */
.record-section {
  background: var(--bg-primary);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow-xl);
  position: relative;
  overflow: hidden;
}

.record-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
}

.record-header {
  display: flex;
  align-items: center;
  margin-bottom: 25px;
}

.record-header h2 {
  font-size: 2rem;
  font-weight: 700;
  color: #1f2937;
  margin-left: 15px;
}

.record-header .icon {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5rem;
}

/* æƒ…ç»ªé­”æ–¹ */
.emotion-cube {
  margin-bottom: 25px;
}

.emotion-cube h3 {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 15px;
  color: var(--text-primary);
}

.cube-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 15px;
}

.emotion-item {
  aspect-ratio: 1;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  background: linear-gradient(135deg, var(--bg-secondary), #f8fafc);
  position: relative;
  overflow: hidden;
}

.emotion-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 1;
}

.emotion-item span {
  position: relative;
  z-index: 2;
  transition: transform 0.3s ease;
}

.emotion-item:hover {
  transform: translateY(-4px) scale(1.05);
  box-shadow: var(--shadow-lg);
  border-color: var(--primary-color);
}

.emotion-item:hover::before {
  opacity: 0.1;
}

.emotion-item:hover span {
  transform: scale(1.2);
}

.emotion-item.selected {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  transform: scale(1.1);
  box-shadow: var(--shadow-xl);
}

.emotion-item.selected::before {
  opacity: 0;
}

.emotion-item.selected span {
  transform: scale(1.1);
}

.emotion-item.combined {
  background: linear-gradient(135deg, var(--accent-color), var(--warning-color));
  color: white;
}

/* æƒ…ç»ªç»„åˆæ˜¾ç¤º */
.emotion-combination-display {
  margin-top: 15px;
  padding: 10px 15px;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  border-radius: 12px;
  color: white;
  font-size: 0.9rem;
  font-weight: 500;
  text-align: center;
  min-height: 20px;
  transition: all 0.3s ease;
  opacity: 0;
  transform: translateY(-10px);
}

.emotion-combination-display:not(:empty) {
  opacity: 1;
  transform: translateY(0);
}

/* å¤šæ¨¡æ€è®°å½• */
.multimodal-record {
  margin-bottom: 25px;
}

.multimodal-record h3 {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 15px;
  color: var(--text-primary);
}

.record-inputs {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.text-input {
  position: relative;
}

.text-input textarea {
  width: 100%;
  min-height: 120px;
  padding: 15px;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  font-size: 1rem;
  resize: vertical;
  transition: border-color 0.3s ease;
  font-family: inherit;
}

.text-input textarea:focus {
  outline: none;
  border-color: var(--primary-color);
}

.media-upload {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.upload-btn {
  aspect-ratio: 1;
  border: 2px dashed var(--border-color);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: var(--bg-secondary);
}

.upload-btn:hover {
  border-color: var(--primary-color);
  background: var(--bg-accent);
}

.upload-btn i {
  font-size: 1.5rem;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.upload-btn span {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* èƒ¶å›Šè®¾ç½® */
.capsule-settings {
  margin-bottom: 25px;
}

.capsule-settings h3 {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 15px;
  color: var(--text-primary);
}

.settings-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.setting-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.setting-item label {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-secondary);
}

.setting-item select,
.setting-item input {
  padding: 10px;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 0.9rem;
  transition: border-color 0.3s ease;
}

.setting-item select:focus,
.setting-item input:focus {
  outline: none;
  border-color: var(--primary-color);
}

/* å‘ç°åŒºåŸŸ */
.discover-section {
  background: var(--bg-primary);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow-xl);
  position: relative;
  overflow: hidden;
}

.discover-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-color), var(--warning-color), var(--success-color));
}

.discover-header {
  display: flex;
  align-items: center;
  margin-bottom: 25px;
}

.discover-header h2 {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-left: 15px;
}

.discover-header .icon {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, var(--accent-color), var(--warning-color));
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5rem;
}

/* åœ°å›¾åŒºåŸŸ */
.map-container {
  height: 300px;
  background: var(--bg-secondary);
  border-radius: 12px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.map-placeholder {
  text-align: center;
  color: var(--text-secondary);
}

.map-placeholder i {
  font-size: 3rem;
  margin-bottom: 15px;
  opacity: 0.5;
}

.map-placeholder p {
  font-size: 1rem;
}

/* èƒ¶å›Šåˆ—è¡¨ */
.capsule-list {
  max-height: 400px;
  overflow-y: auto;
}

.capsule-item {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-left: 4px solid transparent;
}

.capsule-item:hover {
  transform: translateX(5px);
  box-shadow: var(--shadow-md);
  border-left-color: var(--primary-color);
}

.capsule-item.unlocked {
  border-left-color: var(--success-color);
  background: linear-gradient(135deg, var(--bg-secondary), #ecfdf5);
}

.capsule-item .capsule-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.capsule-item .distance {
  font-size: 0.8rem;
  color: var(--text-secondary);
  background: var(--bg-accent);
  padding: 4px 8px;
  border-radius: 6px;
}

.capsule-item .content {
  font-size: 0.9rem;
  color: var(--text-primary);
  line-height: 1.5;
}

.capsule-item .meta {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-top: 10px;
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* åº•éƒ¨æ“ä½œåŒºåŸŸ */
.capsule-actions {
  display: flex;
  gap: 15px;
  margin-top: 20px;
}

.btn {
  padding: 14px 28px;
  border: none;
  border-radius: 16px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
  overflow: hidden;
  letter-spacing: -0.01em;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.6s ease;
}

.btn:hover::before {
  left: 100%;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  box-shadow: 0 8px 25px -5px rgba(99, 102, 241, 0.4);
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px -8px rgba(99, 102, 241, 0.5);
}

.btn-secondary {
  background: linear-gradient(135deg, var(--bg-secondary), #f1f5f9);
  color: var(--text-primary);
  border: 2px solid var(--border-color);
  box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1);
}

.btn-secondary:hover {
  background: linear-gradient(135deg, var(--bg-accent), #e2e8f0);
  border-color: var(--primary-color);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.15);
}

.btn-success {
  background: linear-gradient(135deg, var(--success-color), #059669);
  color: white;
  box-shadow: 0 8px 25px -5px rgba(16, 185, 129, 0.4);
}

.btn-success:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px -8px rgba(16, 185, 129, 0.5);
}

/* æˆå°±ç³»ç»Ÿ */
.achievements {
  background: var(--bg-primary);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow-xl);
  margin-top: 30px;
}

.achievements h2 {
  font-size: 1.8rem;
  font-weight: 700;
  margin-bottom: 20px;
  text-align: center;
  color: var(--text-primary);
}

.achievement-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.achievement-item {
  background: var(--bg-primary);
  border-radius: 20px;
  padding: 25px;
  text-align: center;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-md);
}

.achievement-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
  opacity: 0;
  transition: opacity 0.3s ease;
}

.achievement-item:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-xl);
  border-color: var(--primary-color);
}

.achievement-item:hover::before {
  opacity: 1;
}

.achievement-item.unlocked {
  border-color: var(--accent-color);
  background: linear-gradient(135deg, var(--bg-secondary), #fef3c7);
}

.achievement-item .icon {
  font-size: 3rem;
  margin-bottom: 15px;
  display: block;
  transition: transform 0.3s ease;
}

.achievement-item:hover .icon {
  transform: scale(1.1);
}

.achievement-item.unlocked .icon {
  animation: sparkle 2s infinite;
}

.achievement-item h3 {
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text-primary);
  letter-spacing: -0.01em;
}

.achievement-item p {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.achievement-item .progress {
  font-size: 0.9rem;
  font-weight: 600;
  padding: 8px 16px;
  border-radius: 25px;
  background: linear-gradient(135deg, var(--bg-accent), #f1f5f9);
  color: var(--text-secondary);
  display: inline-block;
  min-width: 100px;
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

.achievement-item:hover .progress {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  transform: scale(1.05);
}

.achievement-item.unlocked .progress {
  background: linear-gradient(135deg, var(--success-color), #059669);
  color: white;
  border-color: var(--success-color);
}

.achievement-points {
  font-size: 0.85rem;
  color: var(--accent-color);
  font-weight: 700;
  margin-top: 8px;
  text-align: center;
  padding: 6px 12px;
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border-radius: 15px;
  border: 1px solid #f59e0b;
  display: inline-block;
  transition: all 0.3s ease;
}

.achievement-item:hover .achievement-points {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.achievement-item.unlocked .achievement-points {
  background: linear-gradient(135deg, #d1fae5, #a7f3d0);
  color: #065f46;
  border-color: #10b981;
}

/* ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
.stats-section {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  padding: 25px;
  color: white;
  margin-top: 20px;
}

.stats-section h3 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 1.3rem;
  font-weight: 600;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
}

.stat-item {
  text-align: center;
  padding: 15px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-label {
  display: block;
  font-size: 0.9rem;
  opacity: 0.9;
  margin-bottom: 5px;
}

.stat-value {
  display: block;
  font-size: 1.5rem;
  font-weight: 700;
  color: #fff;
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes sparkle {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

.floating {
  animation: float 3s ease-in-out infinite;
}

/* åœ°å›¾æ ·å¼ */
.map-container {
  background: var(--bg-primary);
  border-radius: 15px;
  overflow: hidden;
  box-shadow: var(--shadow-lg);
  margin-bottom: 20px;
}

.map-placeholder {
  padding: 60px 20px;
  text-align: center;
  color: var(--text-secondary);
  background: var(--bg-secondary);
}

.map-placeholder i {
  font-size: 3rem;
  margin-bottom: 15px;
  opacity: 0.5;
}

.map-placeholder p {
  font-size: 1.1rem;
  margin: 0;
}

.map-content {
  height: 400px;
  display: flex;
  flex-direction: column;
}

.map-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: var(--primary-color);
  color: white;
}

.map-header h3 {
  margin: 0;
  font-size: 1.2rem;
  font-weight: 600;
}

.close-map-btn {
  background: none;
  border: none;
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 5px;
  border-radius: 5px;
  transition: background-color 0.3s;
}

.close-map-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.map-area {
  flex: 1;
  background: #f8f9fa;
  position: relative;
  overflow: hidden;
}

.map-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-secondary);
}

.map-loading i {
  font-size: 2rem;
  margin-bottom: 10px;
  color: var(--primary-color);
}

.map-loading p {
  margin: 0;
  font-size: 1rem;
}

.map-grid {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  grid-template-rows: repeat(10, 1fr);
  height: 100%;
  gap: 1px;
  background: #e9ecef;
}

.map-cell {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  position: relative;
  cursor: pointer;
  transition: all 0.3s ease;
}

.map-cell:hover {
  background: #e3f2fd;
  transform: scale(1.05);
}

.map-cell.has-capsule {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
}

.map-cell.user-location {
  background: linear-gradient(135deg, #4ecdc4, #44a08d);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
}

.map-cell.unlockable {
  background: linear-gradient(135deg, #feca57, #ff9ff3);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

@keyframes sparkle {
  0%, 100% { 
    transform: scale(1) rotate(0deg);
    filter: brightness(1);
  }
  25% { 
    transform: scale(1.1) rotate(5deg);
    filter: brightness(1.2);
  }
  50% { 
    transform: scale(1.05) rotate(-3deg);
    filter: brightness(1.1);
  }
  75% { 
    transform: scale(1.15) rotate(3deg);
    filter: brightness(1.3);
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.record-section,
.discover-section,
.achievements {
  animation: fadeInUp 0.8s ease-out;
}

.achievement-item {
  animation: slideInLeft 0.6s ease-out;
}

.achievement-item:nth-child(1) { animation-delay: 0.1s; }
.achievement-item:nth-child(2) { animation-delay: 0.2s; }
.achievement-item:nth-child(3) { animation-delay: 0.3s; }
.achievement-item:nth-child(4) { animation-delay: 0.4s; }
.achievement-item:nth-child(5) { animation-delay: 0.5s; }
.achievement-item:nth-child(6) { animation-delay: 0.6s; }

.map-controls {
  display: flex;
  gap: 10px;
  padding: 15px 20px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-color);
}

.map-controls .btn {
  flex: 1;
  padding: 8px 15px;
  font-size: 0.9rem;
}

.map-legend {
  display: flex;
  gap: 15px;
  padding: 10px 20px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-color);
  font-size: 0.8rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

.legend-color.user {
  background: linear-gradient(135deg, #4ecdc4, #44a08d);
}

.legend-color.capsule {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
}

.legend-color.unlockable {
  background: linear-gradient(135deg, #feca57, #ff9ff3);
}

/* ç°ä»£åŒ–è¾“å…¥æ¡†æ ·å¼ */
.modern-textarea {
  width: 100%;
  min-height: 200px;
  padding: 25px;
  border: 2px solid #e5e7eb;
  border-radius: 20px;
  font-size: 18px;
  line-height: 1.8;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
  background: linear-gradient(135deg, #ffffff, #fafafa);
  color: #1f2937;
  font-weight: 500;
  box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  resize: vertical;
  position: relative;
}

.modern-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 12px 35px -8px rgba(0, 0, 0, 0.15);
  background: #ffffff;
  color: #1f2937;
  font-weight: 500;
  transform: translateY(-2px);
}

.modern-textarea::placeholder {
  color: #6b7280;
  font-style: normal;
  font-weight: 400;
  opacity: 0.9;
}

.input-container {
  position: relative;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.input-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border-top: 1px solid #e5e7eb;
}

.char-count {
  font-size: 14px;
  color: #6b7280;
  font-weight: 500;
}

.input-actions {
  display: flex;
  gap: 8px;
}

.action-btn {
  background: none;
  border: none;
  padding: 8px;
  border-radius: 8px;
  color: #6b7280;
  cursor: pointer;
  transition: all 0.2s ease;
}

.action-btn:hover {
  background: #e5e7eb;
  color: #374151;
}

/* æ”¹è¿›çš„åª’ä½“ä¸Šä¼ æ ·å¼ */
.media-upload {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.upload-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border: 2px dashed #d1d5db;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.upload-btn:hover {
  border-color: #6366f1;
  background: linear-gradient(135deg, #eef2ff, #e0e7ff);
  transform: translateY(-2px);
}

.upload-btn i {
  font-size: 24px;
  color: #6b7280;
  margin-bottom: 8px;
  transition: color 0.3s ease;
}

.upload-btn:hover i {
  color: #6366f1;
}

.upload-btn span {
  font-size: 14px;
  color: #374151;
  font-weight: 500;
}

.upload-btn.uploading {
  border-color: #f59e0b;
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
}

.upload-btn.uploading i {
  color: #f59e0b;
  animation: pulse 1s infinite;
}

.upload-btn.success {
  border-color: #10b981;
  background: linear-gradient(135deg, #ecfdf5, #d1fae5);
}

.upload-btn.success i {
  color: #10b981;
}

.upload-btn.error {
  border-color: #ef4444;
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
}

.upload-btn.error i {
  color: #ef4444;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .capsule-main {
    grid-template-columns: 1fr;
  }
  
  .settings-grid {
    grid-template-columns: 1fr;
  }
  
  .media-upload {
    grid-template-columns: 1fr;
  }
  
  .capsule-header h1 {
    font-size: 2rem;
  }
  
  .map-content {
    height: 300px;
  }
  
  .map-grid {
    grid-template-columns: repeat(8, 1fr);
    grid-template-rows: repeat(8, 1fr);
  }
}

/* åŠ è½½åŠ¨ç”» */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* é€šçŸ¥æ ·å¼ */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 10px;
  color: white;
  font-weight: 500;
  z-index: 1000;
  transform: translateX(100%);
  transition: transform 0.3s ease;
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  background: var(--success-color);
}

.notification.error {
  background: var(--error-color);
}

.notification.warning {
  background: var(--warning-color);
}

.notification.info {
  background: var(--primary-color);
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 16px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  max-width: 90vw;
  max-height: 90vh;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}

.modal-header h3 {
  font-size: 20px;
  font-weight: 600;
  color: #1f2937;
  margin: 0;
}

.close-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: #6b7280;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.close-btn:hover {
  background: #e5e7eb;
  color: #374151;
}

.modal-body {
  padding: 24px;
  overflow-y: auto;
}

.loading {
  text-align: center;
  padding: 40px;
  color: #6b7280;
  font-size: 16px;
}
</style>
{% endblock %}

{% block content %}
<div class="time-capsule-container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <div class="capsule-header">
    <h1>æ—¶å…‰èƒ¶å›Šæ—¥è®°</h1>
    <div class="header-actions">
      <a href="{% url 'tools:time_capsule_history' %}" class="btn btn-secondary" style="margin-right: 10px; text-decoration: none; color: white;">
        <i class="fas fa-history"></i>
        å†å²èƒ¶å›Š
      </a>
      <div class="connection-status">
        <span id="websocket-status" class="status-indicator">
          <i class="fas fa-circle"></i>
          <span class="status-text">è¿æ¥ä¸­...</span>
        </span>
      </div>
    </div>
  </div>

  <!-- ä¸»åŠŸèƒ½åŒºåŸŸ -->
  <div class="capsule-main">
    <!-- è®°å½•åŒºåŸŸ -->
    <div class="record-section">
      <div class="record-header">
        <div class="icon">
          <i class="fas fa-pen-fancy"></i>
        </div>
        <h2>è®°å½•ä»Šæ—¥</h2>
      </div>

      <!-- æƒ…ç»ªé­”æ–¹ -->
      <div class="emotion-cube">
        <h3>ğŸ¯ æƒ…ç»ªé­”æ–¹</h3>
        <div class="cube-container">
          <div class="emotion-item" data-emotion="excited">
            <span>ğŸ’¡</span>
          </div>
          <div class="emotion-item" data-emotion="happy">
            <span>ğŸ˜Š</span>
          </div>
          <div class="emotion-item" data-emotion="calm">
            <span>ğŸ˜Œ</span>
          </div>
          <div class="emotion-item" data-emotion="sad">
            <span>ğŸ˜¢</span>
          </div>
          <div class="emotion-item" data-emotion="angry">
            <span>ğŸ˜ </span>
          </div>
          <div class="emotion-item" data-emotion="surprised">
            <span>ğŸ˜²</span>
          </div>
          <div class="emotion-item" data-emotion="anxious">
            <span>ğŸ˜°</span>
          </div>
          <div class="emotion-item" data-emotion="grateful">
            <span>ğŸ™</span>
          </div>
          <div class="emotion-item" data-emotion="inspired">
            <span>âœ¨</span>
          </div>
        </div>
        <div id="emotion-combination" class="emotion-combination-display"></div>
      </div>

      <!-- å¤šæ¨¡æ€è®°å½• -->
      <div class="multimodal-record">
        <h3>å¤šæ¨¡æ€è®°å½•</h3>
        <div class="record-inputs">
          <div class="text-input">
            <div class="input-container">
              <textarea id="diary-content" placeholder="å†™ä¸‹ä»Šå¤©çš„æ•…äº‹..." class="modern-textarea"></textarea>
              <div class="input-footer">
                <span class="char-count">0/5000</span>
                <div class="input-actions">
                  <button class="action-btn" onclick="clearContent()" title="æ¸…ç©ºå†…å®¹">
                    <i class="fas fa-trash"></i>
                  </button>
                  <button class="action-btn" onclick="autoSave()" title="è‡ªåŠ¨ä¿å­˜">
                    <i class="fas fa-save"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
                      <div class="media-upload">
              <div class="upload-btn" onclick="uploadImage()" id="image-upload-btn">
                <i class="fas fa-image"></i>
                <span>å›¾ç‰‡</span>
                <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
              </div>
              <div class="upload-btn" onclick="uploadAudio()" id="audio-upload-btn">
                <i class="fas fa-microphone"></i>
                <span>éŸ³é¢‘</span>
                <input type="file" id="audio-upload" accept="audio/*" style="display: none;" onchange="handleAudioUpload(event)">
              </div>
              <div class="upload-btn" onclick="getLocation()" id="location-upload-btn">
                <i class="fas fa-map-marker-alt"></i>
                <span>ä½ç½®</span>
              </div>
            </div>
        </div>
      </div>

      <!-- èƒ¶å›Šè®¾ç½® -->
      <div class="capsule-settings">
        <h3>èƒ¶å›Šè®¾ç½®</h3>
        <div class="settings-grid">
          <div class="setting-item">
            <label>è§£é”æ—¶é—´</label>
            <input type="datetime-local" id="unlock-time">
          </div>
          <div class="setting-item">
            <label>è§£é”æ¡ä»¶</label>
            <select id="unlock-condition">
              <option value="time">æ—¶é—´è§£é”</option>
              <option value="location">ä½ç½®è§£é”</option>
              <option value="event">äº‹ä»¶è§£é”</option>
            </select>
          </div>
          <div class="setting-item">
            <label>å¯è§æ€§</label>
            <select id="visibility">
              <option value="private">ä»…è‡ªå·±</option>
              <option value="public">å…¬å¼€åˆ†äº«</option>
              <option value="anonymous">åŒ¿ååˆ†äº«</option>
            </select>
          </div>
          <div class="setting-item">
            <label>èƒ¶å›Šç±»å‹</label>
            <select id="capsule-type">
              <option value="memory">è®°å¿†èƒ¶å›Š</option>
              <option value="wish">æ„¿æœ›èƒ¶å›Š</option>
              <option value="secret">ç§˜å¯†èƒ¶å›Š</option>
            </select>
          </div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="capsule-actions">
        <button class="btn btn-primary" onclick="saveCapsule()">
          <i class="fas fa-save"></i>
          ä¿å­˜èƒ¶å›Š
        </button>
        <button class="btn btn-secondary" onclick="previewCapsule()">
          <i class="fas fa-eye"></i>
          é¢„è§ˆ
        </button>
      </div>
    </div>

    <!-- å‘ç°åŒºåŸŸ -->
    <div class="discover-section">
      <div class="discover-header">
        <div class="icon">
          <i class="fas fa-search"></i>
        </div>
        <h2>å‘ç°èƒ¶å›Š</h2>
      </div>

      <!-- åœ°å›¾åŒºåŸŸ -->
      <div class="map-container" id="map-container">
        <div class="map-placeholder" id="map-placeholder">
          <i class="fas fa-map"></i>
          <p>ç‚¹å‡»"æ‰“å¼€åœ°å›¾"å¼€å§‹æ¢ç´¢</p>
        </div>
        <div class="map-content" id="map-content" style="display: none;">
          <div class="map-header">
            <h3>é™„è¿‘èƒ¶å›Šåœ°å›¾</h3>
            <button class="close-map-btn" onclick="closeMap()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="map-area" id="map-area">
            <!-- åœ°å›¾å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
          </div>
          <div class="map-controls">
            <button class="btn btn-sm btn-primary" onclick="getCurrentLocation()">
              <i class="fas fa-crosshairs"></i>
              å®šä½
            </button>
            <button class="btn btn-sm btn-secondary" onclick="refreshMap()">
              <i class="fas fa-sync-alt"></i>
              åˆ·æ–°
            </button>
          </div>
          <div class="map-legend">
            <div class="legend-item">
              <div class="legend-color user"></div>
              <span>æˆ‘çš„ä½ç½®</span>
            </div>
            <div class="legend-item">
              <div class="legend-color capsule"></div>
              <span>æ—¶å…‰èƒ¶å›Š</span>
            </div>
            <div class="legend-item">
              <div class="legend-color unlockable"></div>
              <span>å¯è§£é”</span>
            </div>
          </div>
        </div>
      </div>

      <!-- èƒ¶å›Šåˆ—è¡¨ -->
      <div class="capsule-list" id="capsule-list">
        <!-- èƒ¶å›Šé¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>

      <!-- å‘ç°æ“ä½œ -->
      <div class="capsule-actions">
        <button class="btn btn-success" onclick="refreshCapsules()">
          <i class="fas fa-sync-alt"></i>
          åˆ·æ–°
        </button>
        <button class="btn btn-secondary" onclick="openMap()">
          <i class="fas fa-map-marked-alt"></i>
          æ‰“å¼€åœ°å›¾
        </button>
      </div>
    </div>
  </div>

  <!-- æˆå°±ç³»ç»Ÿ -->
  <div class="achievements">
    <h2>æˆå°±å¾½ç« </h2>
    <div class="achievement-grid">
      <div class="achievement-item" id="achievement-traveler">
        <div class="icon">ğŸŒŸ</div>
        <h3>æ—¶å…‰æ—…äºº</h3>
        <div class="progress">0/7 å¤©</div>
        <div class="achievement-points">+50 ç§¯åˆ†</div>
      </div>
      <div class="achievement-item" id="achievement-explorer">
        <div class="icon">ğŸš€</div>
        <h3>åŸå¸‚æ¢é™©å®¶</h3>
        <div class="progress">0/5 ä¸ª</div>
        <div class="achievement-points">+100 ç§¯åˆ†</div>
      </div>
      <div class="achievement-item" id="achievement-prophet">
        <div class="icon">ğŸ”®</div>
        <h3>é¢„è¨€å®¶</h3>
        <div class="progress">0/3 æ¬¡</div>
        <div class="achievement-points">+75 ç§¯åˆ†</div>
      </div>
      <div class="achievement-item" id="achievement-collector">
        <div class="icon">ğŸ</div>
        <h3>è®°å¿†æ”¶è—å®¶</h3>
        <div class="progress">0/10 ä¸ª</div>
        <div class="achievement-points">+200 ç§¯åˆ†</div>
      </div>
      <div class="achievement-item" id="achievement-emotion-master">
        <div class="icon">ğŸ­</div>
        <h3>æƒ…ç»ªå¤§å¸ˆ</h3>
        <div class="progress">0/9 ç§</div>
        <div class="achievement-points">+150 ç§¯åˆ†</div>
      </div>
      <div class="achievement-item" id="achievement-social-butterfly">
        <div class="icon">ğŸ¦‹</div>
        <h3>ç¤¾äº¤è´è¶</h3>
        <div class="progress">0/20 ä¸ª</div>
        <div class="achievement-points">+125 ç§¯åˆ†</div>
      </div>
    </div>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º -->
    <div class="stats-section">
      <h3>ä¸ªäººç»Ÿè®¡</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-label">è¿ç»­è®°å½•å¤©æ•°:</span>
          <span class="stat-value" id="consecutive-days">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">è§£é”èƒ¶å›Šæ•°:</span>
          <span class="stat-value" id="unlock-count">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">è®°å¿†ç¢ç‰‡æ•°:</span>
          <span class="stat-value" id="fragment-count">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">é¢„æµ‹æˆçœŸæ•°:</span>
          <span class="stat-value" id="prophecy-count">0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
<input type="file" id="image-upload" accept="image/*" style="display: none;">
<input type="file" id="audio-upload" accept="audio/*" style="display: none;">

<!-- èƒ¶å›Šé¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal" id="capsule-preview-modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>èƒ¶å›Šé¢„è§ˆ</h3>
      <button class="close-btn" onclick="closePreview()">&times;</button>
    </div>
    <div class="modal-body" id="preview-content">
      <!-- é¢„è§ˆå†…å®¹ -->
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€é…ç½®
window.TIME_CAPSULE_CONFIG = {
  websocket_available: {{ websocket_available|yesno:"true,false" }},
  api_timeout: {{ api_timeout|default:10000 }},
  retry_attempts: {{ retry_attempts|default:3 }},
  base_url: '{{ request.build_absolute_uri }}'
};

// APIå·¥å…·ç±»
class ApiClient {
  constructor() {
    this.baseUrl = window.TIME_CAPSULE_CONFIG.base_url;
    this.timeout = window.TIME_CAPSULE_CONFIG.api_timeout;
    this.maxRetries = window.TIME_CAPSULE_CONFIG.retry_attempts;
  }

  async request(url, options = {}) {
    const config = {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': this.getCsrfToken(),
        ...options.headers
      },
      timeout: this.timeout,
      ...options
    };

    let lastError;
    
    for (let attempt = 1; attempt <= this.maxRetries; attempt++) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.timeout);
        
        const response = await fetch(url, {
          ...config,
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        return await response.json();
        
      } catch (error) {
        lastError = error;
        
        if (error.name === 'AbortError') {
          console.warn(`APIè¯·æ±‚è¶…æ—¶ (å°è¯• ${attempt}/${this.maxRetries}): ${url}`);
        } else {
          console.error(`APIè¯·æ±‚å¤±è´¥ (å°è¯• ${attempt}/${this.maxRetries}): ${url}`, error);
        }
        
        if (attempt === this.maxRetries) {
          throw new Error(`è¯·æ±‚å¤±è´¥ï¼Œå·²é‡è¯•${this.maxRetries}æ¬¡: ${error.message}`);
        }
        
        // ç­‰å¾…åé‡è¯•
        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
      }
    }
    
    throw lastError;
  }

  getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  }

  // æ—¶å…‰èƒ¶å›Šç›¸å…³API
  async createCapsule(data) {
    return this.request('/tools/api/save-capsule/', {
      method: 'POST',
      body: JSON.stringify(data)
    });
  }

  async getUserCapsules() {
    return this.request('/tools/api/get-capsules/');
  }

  async getNearbyCapsules(lat, lng) {
    // è°ƒç”¨çœŸå®çš„é™„è¿‘èƒ¶å›ŠAPI
    const params = new URLSearchParams({
      lat: lat || 39.9042,
      lng: lng || 116.4074,
      radius: 5000
    });
    
    return this.request(`/tools/api/nearby-capsules/?${params}`);
  }

  async unlockCapsule(capsuleId, location = null) {
    const data = location ? { location } : {};
    return this.request(`/tools/api/unlock-capsule/${capsuleId}/`, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  }

  async getAchievements() {
    return this.request('/tools/api/get-achievements/');
  }

  async getMemoryFragments() {
    // æš‚æ—¶è¿”å›ç©ºæ•°æ®ï¼Œå› ä¸ºåç«¯æ²¡æœ‰fragments API
    return Promise.resolve({
      success: true,
      fragments: []
    });
  }

  async getParallelMatch() {
    // æš‚æ—¶è¿”å›ç©ºæ•°æ®ï¼Œå› ä¸ºåç«¯æ²¡æœ‰parallel_match API
    return Promise.resolve({
      success: true,
      matches: []
    });
  }

  async getStats() {
    // æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®ï¼Œå› ä¸ºåç«¯æ²¡æœ‰stats API
    return Promise.resolve({
      success: true,
      user_stats: {
        total_capsules: 0,
        public_capsules: 0,
        unlocked_by_others: 0,
        total_fragments: 0,
        achievements_count: 0
      },
      global_stats: {
        total_capsules: 0,
        total_unlocks: 0,
        total_fragments: 0,
        active_users_today: 0
      }
    });
  }
}

// æ—¶å…‰èƒ¶å›Šæ—¥è®°æ ¸å¿ƒåŠŸèƒ½
class TimeCapsuleDiary {
  constructor() {
    this.selectedEmotions = [];
    this.currentLocation = null;
    this.weatherData = null;
    this.capsules = [];
    this.achievements = {};
    this.apiClient = new ApiClient();
    this.websocketAvailable = window.TIME_CAPSULE_CONFIG.websocket_available;
    this.isLoading = false;
    
    this.init();
  }

  async init() {
    console.log('ğŸš€ æ—¶å…‰èƒ¶å›Šæ—¥è®°åˆå§‹åŒ–...');
    
    try {
      this.initEventListeners();
      this.loadUserData();
      await this.getCurrentLocation();
      await this.getWeatherData();
      this.loadNearbyCapsules();
      this.updateAchievements();
      this.loadStats();
      
      // æ˜¾ç¤ºWebSocketçŠ¶æ€
      console.log('ğŸ” WebSocketçŠ¶æ€æ£€æŸ¥:');
      console.log('  - this.websocketAvailable:', this.websocketAvailable);
      console.log('  - typeof this.websocketAvailable:', typeof this.websocketAvailable);
      console.log('  - window.TIME_CAPSULE_CONFIG.websocket_available:', window.TIME_CAPSULE_CONFIG.websocket_available);
      
      if (this.websocketAvailable) {
        console.log('âœ… WebSocketå¯ç”¨ï¼Œè®¾ç½®è¿æ¥çŠ¶æ€ä¸ºconnected');
        this.updateConnectionStatus('connected');
      } else {
        console.log('âŒ WebSocketä¸å¯ç”¨ï¼Œè®¾ç½®è¿æ¥çŠ¶æ€ä¸ºdisconnected');
        this.updateConnectionStatus('disconnected');
        console.warn('âš ï¸ WebSocketä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨è½®è¯¢æ¨¡å¼');
        this.showNotification('å®æ—¶åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨è½®è¯¢æ¨¡å¼', 'warning');
      }
      
      console.log('âœ… æ—¶å…‰èƒ¶å›Šæ—¥è®°åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('âŒ æ—¶å…‰èƒ¶å›Šæ—¥è®°åˆå§‹åŒ–å¤±è´¥:', error);
      this.showNotification('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    }
  }

  initEventListeners() {
    try {
      // æƒ…ç»ªé­”æ–¹äº‹ä»¶
      const emotionItems = document.querySelectorAll('.emotion-item');
      emotionItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          this.toggleEmotion(item);
        });
      });

      // å†…å®¹å˜åŒ–ç›‘å¬
      const diaryContent = document.getElementById('diary-content');
      if (diaryContent) {
        diaryContent.addEventListener('input', (e) => {
          this.generateKeywords(e.target.value);
        });
      }

      // èƒ¶å›Šè®¾ç½®å˜åŒ–
      const unlockCondition = document.getElementById('unlock-condition');
      if (unlockCondition) {
        unlockCondition.addEventListener('change', (e) => {
          this.updateUnlockSettings(e.target.value);
        });
      }
    } catch (error) {
      console.error('åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', error);
    }
  }

  toggleEmotion(emotionItem) {
    const emotion = emotionItem.dataset.emotion;
    
    if (emotionItem.classList.contains('selected')) {
      emotionItem.classList.remove('selected');
      this.selectedEmotions = this.selectedEmotions.filter(e => e !== emotion);
    } else {
      if (this.selectedEmotions.length < 3) {
        emotionItem.classList.add('selected');
        this.selectedEmotions.push(emotion);
      } else {
        this.showNotification('æœ€å¤šåªèƒ½é€‰æ‹©3ç§æƒ…ç»ªç»„åˆ', 'warning');
        return;
      }
    }

    this.updateEmotionCombination();
  }

  updateEmotionCombination() {
    const combinationEl = document.getElementById('emotion-combination');
    if (!combinationEl) {
      console.warn('emotion-combinationå…ƒç´ ä¸å­˜åœ¨');
      return;
    }
    
    if (this.selectedEmotions.length > 0) {
      const emotionTexts = {
        'excited': 'å…´å¥‹',
        'happy': 'å¼€å¿ƒ',
        'calm': 'å¹³é™',
        'sad': 'éš¾è¿‡',
        'angry': 'ç”Ÿæ°”',
        'surprised': 'æƒŠè®¶',
        'anxious': 'ç„¦è™‘',
        'grateful': 'æ„Ÿæ©',
        'inspired': 'å—å¯å‘'
      };
      
      const combination = this.selectedEmotions.map(e => emotionTexts[e]).join(' + ');
      combinationEl.textContent = `æƒ…ç»ªç»„åˆ: ${combination}`;
    } else {
      combinationEl.textContent = '';
    }
  }

  async getCurrentLocation() {
    try {
      if (navigator.geolocation) {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        
        this.currentLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        
        console.log('ğŸ“ ä½ç½®è·å–æˆåŠŸ:', this.currentLocation);
      }
    } catch (error) {
      console.error('âŒ ä½ç½®è·å–å¤±è´¥:', error);
      this.showNotification('æ— æ³•è·å–ä½ç½®ä¿¡æ¯', 'warning');
    }
  }

  async getWeatherData() {
    if (!this.currentLocation) return;
    
    try {
      // è¿™é‡Œåº”è¯¥è°ƒç”¨å¤©æ°”APIï¼Œæš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      this.weatherData = {
        temperature: 22,
        condition: 'æ™´å¤©',
        icon: 'â˜€ï¸'
      };
      
      console.log('ğŸŒ¤ï¸ å¤©æ°”æ•°æ®è·å–æˆåŠŸ:', this.weatherData);
    } catch (error) {
      console.error('âŒ å¤©æ°”æ•°æ®è·å–å¤±è´¥:', error);
    }
  }

  async generateKeywords(content) {
    if (content.length < 10) return;
    
    try {
      // è¿™é‡Œåº”è¯¥è°ƒç”¨AI APIç”Ÿæˆå…³é”®è¯ï¼Œæš‚æ—¶ä½¿ç”¨ç®€å•ç®—æ³•
      const keywords = this.extractKeywords(content);
      console.log('ğŸ”‘ ç”Ÿæˆå…³é”®è¯:', keywords);
    } catch (error) {
      console.error('âŒ å…³é”®è¯ç”Ÿæˆå¤±è´¥:', error);
    }
  }

  extractKeywords(text) {
    // ç®€å•çš„å…³é”®è¯æå–ç®—æ³•
    const words = text.toLowerCase().match(/\b\w+\b/g) || [];
    const wordCount = {};
    
    words.forEach(word => {
      if (word.length > 2) {
        wordCount[word] = (wordCount[word] || 0) + 1;
      }
    });
    
    return Object.entries(wordCount)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 5)
      .map(([word]) => word);
  }

  async saveCapsule() {
    if (this.isLoading) {
      this.showNotification('æ­£åœ¨ä¿å­˜ä¸­ï¼Œè¯·ç¨å€™...', 'info');
      return;
    }

    const content = document.getElementById('diary-content').value.trim();
    if (!content) {
      this.showNotification('è¯·å…ˆå†™ä¸‹ä»Šå¤©çš„æ•…äº‹', 'warning');
      return;
    }

    if (this.selectedEmotions.length === 0) {
      this.showNotification('è¯·é€‰æ‹©è‡³å°‘ä¸€ç§æƒ…ç»ª', 'warning');
      return;
    }

    this.isLoading = true;
    this.showNotification('æ­£åœ¨ä¿å­˜æ—¶å…‰èƒ¶å›Š...', 'info');

    try {
      const capsuleData = {
        content: content,
        emotions: this.selectedEmotions,
        unlock_time: document.getElementById('unlock-time').value || null,
        unlock_condition: document.getElementById('unlock-condition').value || 'time',
        visibility: document.getElementById('visibility').value || 'private'
      };

      const response = await fetch('/tools/api/save-capsule/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(capsuleData)
      });

      const data = await response.json();
      
      if (data.success) {
        this.showNotification('æ—¶å…‰èƒ¶å›Šä¿å­˜æˆåŠŸï¼', 'success');
        this.resetForm();
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶æç¤ºæŸ¥çœ‹å†å²
        setTimeout(() => {
          this.showNotification('ç‚¹å‡»å³ä¸Šè§’"å†å²"æŸ¥çœ‹ä½ çš„èƒ¶å›Š', 'info');
        }, 2000);
      } else {
        throw new Error(data.message || 'ä¿å­˜å¤±è´¥');
      }
    } catch (error) {
      console.error('âŒ èƒ¶å›Šä¿å­˜å¤±è´¥:', error);
      this.showNotification(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
    } finally {
      this.isLoading = false;
    }
  }

  resetForm() {
    document.getElementById('diary-content').value = '';
    document.querySelectorAll('.emotion-item').forEach(item => {
      item.classList.remove('selected');
    });
    this.selectedEmotions = [];
    this.updateEmotionCombination();
  }

  async loadNearbyCapsules() {
    if (!this.currentLocation) {
      this.showNotification('æ— æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œè¯·å…è®¸ä½ç½®æƒé™', 'warning');
      return;
    }

    try {
      this.showNotification('æ­£åœ¨åŠ è½½é™„è¿‘çš„èƒ¶å›Š...', 'info');
      const response = await this.apiClient.getNearbyCapsules(
        this.currentLocation.lat, 
        this.currentLocation.lng
      );
      
      if (response.success) {
        this.renderCapsuleList(response.capsules);
        this.showNotification(`æ‰¾åˆ° ${response.total_nearby || 0} ä¸ªé™„è¿‘èƒ¶å›Š`, 'success');
        
        // æ£€æŸ¥WebSocketçŠ¶æ€
        if (response.websocket_available !== undefined) {
          this.websocketAvailable = response.websocket_available;
        }
      } else {
        throw new Error(response.message || 'è·å–é™„è¿‘èƒ¶å›Šå¤±è´¥');
      }
    } catch (error) {
      console.error('âŒ åŠ è½½é™„è¿‘èƒ¶å›Šå¤±è´¥:', error);
      this.showNotification(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
    }
  }

  renderCapsuleList(capsules) {
    const listEl = document.getElementById('capsule-list');
    listEl.innerHTML = '';

    capsules.forEach(capsule => {
      const capsuleEl = document.createElement('div');
      capsuleEl.className = `capsule-item ${capsule.isUnlocked ? 'unlocked' : ''}`;
      capsuleEl.innerHTML = `
        <div class="capsule-header">
          <span class="distance">${capsule.distance}</span>
          <span>${capsule.emotion}</span>
        </div>
        <div class="content">${capsule.content}</div>
        <div class="meta">
          <span>è§£é”æ—¶é—´: ${capsule.unlockTime}</span>
          <span>${capsule.isUnlocked ? 'å·²è§£é”' : 'æœªè§£é”'}</span>
        </div>
      `;
      
      capsuleEl.addEventListener('click', () => this.unlockCapsule(capsule));
      listEl.appendChild(capsuleEl);
    });
  }

  async unlockCapsule(capsule) {
    if (capsule.isUnlocked) {
      this.showNotification('è¿™ä¸ªèƒ¶å›Šå·²ç»è¢«è§£é”äº†', 'info');
      return;
    }

    if (this.isLoading) {
      this.showNotification('æ­£åœ¨è§£é”ä¸­ï¼Œè¯·ç¨å€™...', 'info');
      return;
    }

    this.isLoading = true;
    this.showNotification('æ­£åœ¨è§£é”èƒ¶å›Š...', 'info');

    try {
      const response = await this.apiClient.unlockCapsule(capsule.id, this.currentLocation);
      
      if (response.success) {
        capsule.isUnlocked = true;
        this.renderCapsuleList(this.capsules);
        this.showNotification('èƒ¶å›Šè§£é”æˆåŠŸï¼è·å¾—è®°å¿†ç¢ç‰‡', 'success');
        
        // æ˜¾ç¤ºè®°å¿†ç¢ç‰‡å†…å®¹
        if (response.fragment_content) {
          this.showNotification(`è®°å¿†ç¢ç‰‡: ${response.fragment_content}`, 'info');
        }
        
        // æ›´æ–°æˆå°±
        this.updateAchievements();
        
        // æ£€æŸ¥WebSocketçŠ¶æ€
        if (response.websocket_available !== undefined) {
          this.websocketAvailable = response.websocket_available;
        }
      } else {
        throw new Error(response.message || 'è§£é”å¤±è´¥');
      }
    } catch (error) {
      console.error('âŒ èƒ¶å›Šè§£é”å¤±è´¥:', error);
      this.showNotification(`è§£é”å¤±è´¥: ${error.message}`, 'error');
    } finally {
      this.isLoading = false;
    }
  }

  async updateAchievements() {
    try {
      const response = await this.apiClient.getAchievements();
      
      if (response.success) {
        this.displayAchievements(response.achievements, response.stats);
        
        // æ£€æŸ¥WebSocketçŠ¶æ€
        if (response.websocket_available !== undefined) {
          this.websocketAvailable = response.websocket_available;
        }
      } else {
        console.warn('APIè¿”å›é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', response.message);
        // å³ä½¿APIè¿”å›é”™è¯¯ï¼Œä¹Ÿå°è¯•ä½¿ç”¨è¿”å›çš„æ•°æ®
        this.displayAchievements(
          response.achievements || [], 
          response.stats || {
            consecutive_days: 0,
            unlock_count: 0,
            fragment_count: 0,
            prophecy_count: 0,
            total_points: 0
          }
        );
      }
    } catch (error) {
      console.error('è·å–æˆå°±æ•°æ®å¤±è´¥:', error);
      // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      this.displayMockAchievements();
    }
  }

  displayMockAchievements() {
    // æ¨¡æ‹Ÿæˆå°±æ•°æ®
    const mockAchievements = [
      {
        type: 'traveler',
        unlocked: false,
        progress: 3,
        target: 7,
        points: 50
      },
      {
        type: 'explorer',
        unlocked: false,
        progress: 1,
        target: 5,
        points: 100
      },
      {
        type: 'prophet',
        unlocked: false,
        progress: 0,
        target: 3,
        points: 75
      },
      {
        type: 'collector',
        unlocked: false,
        progress: 2,
        target: 10,
        points: 200
      },
      {
        type: 'emotion-master',
        unlocked: false,
        progress: 4,
        target: 9,
        points: 150
      },
      {
        type: 'social-butterfly',
        unlocked: false,
        progress: 0,
        target: 20,
        points: 125
      }
    ];

    this.displayAchievements(mockAchievements, {
      consecutive_days: 3,
      unlock_count: 1,
      fragment_count: 2,
      prophecy_count: 0,
      total_points: 0
    });
  }

  displayAchievements(achievements, stats) {
    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿å‚æ•°å­˜åœ¨
    if (!achievements || !Array.isArray(achievements)) {
      console.warn('æˆå°±æ•°æ®ä¸å®Œæ•´ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
      this.displayMockAchievements();
      return;
    }
    
    // ç¡®ä¿statsæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å¯¹è±¡ï¼Œå¹¶æä¾›é»˜è®¤å€¼
    if (!stats || typeof stats !== 'object') {
      console.warn('ç»Ÿè®¡æ•°æ®ä¸å®Œæ•´ï¼Œä½¿ç”¨é»˜è®¤å€¼');
      stats = {
        consecutive_days: 0,
        unlock_count: 0,
        fragment_count: 0,
        prophecy_count: 0,
        total_points: 0
      };
    } else {
      // ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„ç»Ÿè®¡å­—æ®µéƒ½å­˜åœ¨
      stats = {
        consecutive_days: stats.consecutive_days || 0,
        unlock_count: stats.unlock_count || 0,
        fragment_count: stats.fragment_count || 0,
        prophecy_count: stats.prophecy_count || 0,
        total_points: stats.total_points || 0
      };
    }
    
    // æ›´æ–°æˆå°±æ˜¾ç¤º
    achievements.forEach(achievement => {
      const el = document.getElementById(`achievement-${achievement.type}`);
      if (el) {
        if (achievement.unlocked) {
          el.classList.add('unlocked');
          el.querySelector('.progress').textContent = 'âœ… å·²è§£é”';
        } else {
          el.classList.remove('unlocked');
          // æ˜¾ç¤ºè¿›åº¦
          let progressText = '';
          let target = 0;
          
          switch (achievement.type) {
            case 'traveler':
              target = 7;
              progressText = `${achievement.progress}/${target} å¤©`;
              break;
            case 'explorer':
              target = 5;
              progressText = `${achievement.progress}/${target} ä¸ª`;
              break;
            case 'prophet':
              target = 3;
              progressText = `${achievement.progress}/${target} æ¬¡`;
              break;
            case 'collector':
              target = 10;
              progressText = `${achievement.progress}/${target} ä¸ª`;
              break;
            case 'emotion-master':
              target = 9;
              progressText = `${achievement.progress}/${target} ç§`;
              break;
            case 'social-butterfly':
              target = 20;
              progressText = `${achievement.progress}/${target} ä¸ª`;
              break;
          }
          
          el.querySelector('.progress').textContent = progressText;
        }
      }
    });
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    this.updateStatsDisplay(stats);
  }

  updateStatsDisplay(stats) {
    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿statså‚æ•°å­˜åœ¨
    if (!stats || typeof stats !== 'object') {
      console.warn('ç»Ÿè®¡æ•°æ®ä¸å®Œæ•´ï¼Œä½¿ç”¨é»˜è®¤å€¼');
      stats = {
        consecutive_days: 0,
        unlock_count: 0,
        fragment_count: 0,
        prophecy_count: 0
      };
    }
    
    // æ›´æ–°é¡µé¢ä¸Šçš„ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
    const statsElements = {
      'consecutive-days': stats.consecutive_days || 0,
      'unlock-count': stats.unlock_count || 0,
      'fragment-count': stats.fragment_count || 0,
      'prophecy-count': stats.prophecy_count || 0
    };
    
    Object.entries(statsElements).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = value;
      }
    });
  }

  async loadStats() {
    try {
      const response = await this.apiClient.getStats();
      
      if (response.success) {
        this.displayStats(response.user_stats, response.global_stats);
        
        // æ£€æŸ¥WebSocketçŠ¶æ€
        if (response.websocket_available !== undefined) {
          this.websocketAvailable = response.websocket_available;
        }
      } else {
        throw new Error(response.message || 'è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥');
      }
    } catch (error) {
      console.error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
      this.showNotification(`è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
    }
  }

  displayStats(userStats, globalStats) {
    // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
    const userStatsElements = {
      'user-total-capsules': userStats.total_capsules,
      'user-public-capsules': userStats.public_capsules,
      'user-unlocked-by-others': userStats.unlocked_by_others,
      'user-total-fragments': userStats.total_fragments,
      'user-achievements-count': userStats.achievements_count
    };
    
    Object.entries(userStatsElements).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = value || 0;
      }
    });
    
    // æ›´æ–°å…¨å±€ç»Ÿè®¡ä¿¡æ¯
    const globalStatsElements = {
      'global-total-capsules': globalStats.total_capsules,
      'global-total-unlocks': globalStats.total_unlocks,
      'global-total-fragments': globalStats.total_fragments,
      'global-active-users-today': globalStats.active_users_today
    };
    
    Object.entries(globalStatsElements).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = value || 0;
      }
    });
  }

  updateConnectionStatus(status = 'checking') {
    const statusEl = document.getElementById('websocket-status');
    if (!statusEl) return;
    
    const statusTextEl = statusEl.querySelector('.status-text');
    
    switch (status) {
      case 'connected':
        statusEl.className = 'status-indicator connected';
        statusTextEl.textContent = 'å®æ—¶è¿æ¥';
        break;
      case 'disconnected':
        statusEl.className = 'status-indicator disconnected';
        statusTextEl.textContent = 'è½®è¯¢æ¨¡å¼';
        break;
      case 'error':
        statusEl.className = 'status-indicator error';
        statusTextEl.textContent = 'è¿æ¥é”™è¯¯';
        break;
      default:
        statusEl.className = 'status-indicator';
        statusTextEl.textContent = 'è¿æ¥ä¸­...';
    }
  }

  getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  }

  showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
  }

  loadUserData() {
    const savedCapsules = localStorage.getItem('timeCapsules');
    if (savedCapsules) {
      this.capsules = JSON.parse(savedCapsules);
    }
  }

  // åœ°å›¾ç›¸å…³æ–¹æ³•
  openMap() {
    const placeholder = document.getElementById('map-placeholder');
    const content = document.getElementById('map-content');
    
    if (placeholder && content) {
      placeholder.style.display = 'none';
      content.style.display = 'flex';
      this.renderMap();
    }
  }

  closeMap() {
    const placeholder = document.getElementById('map-placeholder');
    const content = document.getElementById('map-content');
    
    if (placeholder && content) {
      placeholder.style.display = 'block';
      content.style.display = 'none';
    }
  }

  async renderMap() {
    const mapArea = document.getElementById('map-area');
    if (!mapArea) return;

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    mapArea.innerHTML = '<div class="map-loading"><i class="fas fa-spinner fa-spin"></i><p>æ­£åœ¨åŠ è½½åœ°å›¾...</p></div>';

    // åˆ›å»ºç½‘æ ¼åœ°å›¾
    const grid = document.createElement('div');
    grid.className = 'map-grid';
    
    // åˆ›å»º10x10çš„ç½‘æ ¼
    for (let i = 0; i < 100; i++) {
      const cell = document.createElement('div');
      cell.className = 'map-cell';
      cell.dataset.index = i;
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      cell.addEventListener('click', () => this.handleMapCellClick(i));
      
      grid.appendChild(cell);
    }
    
    mapArea.innerHTML = '';
    mapArea.appendChild(grid);
    
    // æ¸²æŸ“ç”¨æˆ·ä½ç½®å’Œèƒ¶å›Š
    await this.renderMapElements();
  }

  async renderMapElements() {
    // æ¸²æŸ“ç”¨æˆ·ä½ç½®ï¼ˆä¸­å¿ƒä½ç½®ï¼‰
    const centerIndex = 45; // 5x5çš„ä½ç½®
    const centerCell = document.querySelector(`[data-index="${centerIndex}"]`);
    if (centerCell) {
      centerCell.classList.add('user-location');
      centerCell.textContent = 'æˆ‘';
      centerCell.title = 'æˆ‘çš„ä½ç½®';
    }

    // æ¸²æŸ“é™„è¿‘çš„èƒ¶å›Š
    await this.renderNearbyCapsules();
  }

  async renderNearbyCapsules() {
    try {
      // è·å–ç”¨æˆ·å½“å‰ä½ç½®
      if (!this.currentLocation) {
        await this.getCurrentLocation();
      }
      
      if (!this.currentLocation) {
        this.showNotification('æ— æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œè¯·å…è®¸ä½ç½®æƒé™', 'warning');
        // ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆåŒ—äº¬ï¼‰
        this.currentLocation = { lat: 39.9042, lng: 116.4074 };
        this.showNotification('ä½¿ç”¨é»˜è®¤ä½ç½®è¿›è¡Œæ¼”ç¤º', 'info');
      }
      
      // ä»åç«¯APIè·å–é™„è¿‘çš„èƒ¶å›Šï¼ˆæš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
      const response = await fetch(`/tools/api/get-capsules/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': this.getCsrfToken(),
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          this.displayNearbyCapsules(data.capsules);
          this.showNotification(`å‘ç° ${data.total || 0} ä¸ªé™„è¿‘èƒ¶å›Š`, 'success');
        } else {
          this.showNotification('è·å–é™„è¿‘èƒ¶å›Šå¤±è´¥: ' + data.message, 'error');
          this.displaySimulatedCapsules();
        }
      } else {
        this.showNotification('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œæ˜¾ç¤ºæ¼”ç¤ºæ•°æ®', 'warning');
        this.displaySimulatedCapsules();
      }
    } catch (error) {
      console.error('è·å–é™„è¿‘èƒ¶å›Šå¤±è´¥:', error);
      this.showNotification('è·å–é™„è¿‘èƒ¶å›Šå¤±è´¥ï¼Œæ˜¾ç¤ºæ¼”ç¤ºæ•°æ®', 'warning');
      // å¦‚æœAPIå¤±è´¥ï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
      this.displaySimulatedCapsules();
    }
  }

  displayNearbyCapsules(capsules) {
    if (!capsules || capsules.length === 0) {
      this.showNotification('é™„è¿‘æ²¡æœ‰å‘ç°æ—¶å…‰èƒ¶å›Šï¼Œæ˜¾ç¤ºæ¼”ç¤ºæ•°æ®', 'info');
      this.displaySimulatedCapsules();
      return;
    }

    // å°†èƒ¶å›Šæ˜ å°„åˆ°åœ°å›¾ç½‘æ ¼ä¸Š
    capsules.forEach((capsule, i) => {
      // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿distanceå±æ€§å­˜åœ¨ä¸”ä¸ºå­—ç¬¦ä¸²
      if (!capsule.distance || typeof capsule.distance !== 'string') {
        console.warn('èƒ¶å›Šæ•°æ®ç¼ºå°‘distanceå±æ€§:', capsule);
        return;
      }
      
      // æ ¹æ®è·ç¦»è®¡ç®—åœ°å›¾ä½ç½®ï¼ˆç®€åŒ–ç®—æ³•ï¼‰
      const distance = parseInt(capsule.distance.replace('m', ''));
      const maxDistance = 200; // æœ€å¤§æ˜¾ç¤ºè·ç¦»
      const gridSize = 10; // ç½‘æ ¼å¤§å°
      
      // è®¡ç®—ç›¸å¯¹ä½ç½®ï¼ˆç®€åŒ–ï¼‰
      const relativeDistance = Math.min(distance / maxDistance, 1);
      const angle = (i * 72) % 360; // å‡åŒ€åˆ†å¸ƒè§’åº¦
      const radius = Math.floor(relativeDistance * 4); // æœ€å¤§åŠå¾„4æ ¼
      
      const centerX = 5;
      const centerY = 5;
      const x = centerX + Math.floor(radius * Math.cos(angle * Math.PI / 180));
      const y = centerY + Math.floor(radius * Math.sin(angle * Math.PI / 180));
      
      const index = Math.max(0, Math.min(99, y * gridSize + x));
      
      const cell = document.querySelector(`[data-index="${index}"]`);
      if (cell && !cell.classList.contains('user-location')) {
        cell.classList.add('has-capsule');
        
        if (distance <= 200) {
          cell.classList.add('unlockable');
          cell.textContent = 'ğŸ”“';
        } else {
          cell.textContent = 'ğŸ”’';
        }
        
        cell.title = `æ—¶å…‰èƒ¶å›Š - ${capsule.distance} - ${capsule.author}`;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        cell.addEventListener('click', () => this.handleCapsuleClick(capsule));
      }
    });
  }

  displaySimulatedCapsules() {
    // æ¨¡æ‹Ÿé™„è¿‘çš„èƒ¶å›Šä½ç½®ï¼ˆå½“APIå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
    const capsulePositions = [
      { 
        id: 'demo_1',
        index: 43, 
        distance: '50m', 
        unlockable: true, 
        author: 'å¥èº«è¾¾äºº',
        title: 'æˆ‘çš„å¥èº«æ—¥è®°',
        content: 'ä»Šå¤©å®Œæˆäº†100ä¸ªä¿¯å§æ’‘ï¼Œæ„Ÿè§‰è¶…æ£’ï¼ğŸ’ª'
      },
      { 
        id: 'demo_2',
        index: 47, 
        distance: '120m', 
        unlockable: true, 
        author: 'éŸ³ä¹çˆ±å¥½è€…',
        title: 'å‰ä»–ç»ƒä¹ è®°å½•',
        content: 'å­¦ä¼šäº†æ–°çš„å’Œå¼¦è¿›è¡Œï¼ŒéŸ³ä¹çœŸçš„èƒ½æ²»æ„ˆå¿ƒçµ ğŸ¸'
      },
      { 
        id: 'demo_3',
        index: 53, 
        distance: '180m', 
        unlockable: true, 
        author: 'ç¨‹åºå‘˜å°ç‹',
        title: 'ä»£ç çªç ´',
        content: 'ç»ˆäºè§£å†³äº†é‚£ä¸ªå›°æ‰°æˆ‘ä¸€å‘¨çš„bugï¼Œæˆå°±æ„Ÿæ»¡æ»¡ï¼ğŸ’»'
      },
      { 
        id: 'demo_4',
        index: 37, 
        distance: '90m', 
        unlockable: true, 
        author: 'æ—…è¡Œè€…',
        title: 'æ—…è¡Œå›å¿†',
        content: 'åœ¨ç¾ä¸½çš„å±±é—´å°è·¯ä¸Šæ¼«æ­¥ï¼Œæ„Ÿå—å¤§è‡ªç„¶çš„å®é™ ğŸŒ²'
      },
      { 
        id: 'demo_5',
        index: 55, 
        distance: '250m', 
        unlockable: false, 
        author: 'ç¥ç§˜ç”¨æˆ·',
        title: 'æœªæ¥è®¡åˆ’',
        content: 'è·ç¦»å¤ªè¿œï¼Œæš‚æ—¶æ— æ³•è§£é”...'
      }
    ];

    capsulePositions.forEach((capsule, i) => {
      const cell = document.querySelector(`[data-index="${capsule.index}"]`);
      if (cell && !cell.classList.contains('user-location')) {
        cell.classList.add('has-capsule');
        if (capsule.unlockable) {
          cell.classList.add('unlockable');
          cell.textContent = 'ğŸ”“';
        } else {
          cell.textContent = 'ğŸ”’';
        }
        cell.title = `æ—¶å…‰èƒ¶å›Š ${i + 1} - ${capsule.distance} - ${capsule.author}`;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        cell.addEventListener('click', () => this.handleCapsuleClick(capsule));
      }
    });
  }

  handleMapCellClick(index) {
    const cell = document.querySelector(`[data-index="${index}"]`);
    if (cell && !cell.classList.contains('user-location') && !cell.classList.contains('has-capsule')) {
      this.showNotification(`ä½ç½® ${index}: è¿™é‡Œè¿˜æ²¡æœ‰æ—¶å…‰èƒ¶å›Š`, 'info');
    }
  }

  handleDemoCapsuleClick(capsule) {
    const distance = parseInt(capsule.distance.replace('m', ''));
    
    if (distance <= 200) {
      // æ¼”ç¤ºèƒ¶å›Šè§£é”
      this.showNotification(`ğŸ‰ è§£é”æ¼”ç¤ºæ—¶å…‰èƒ¶å›Šï¼`, 'success');
      
      // æ˜¾ç¤ºèƒ¶å›Šå†…å®¹
      const content = `
        <div class="capsule-content">
          <h3>${capsule.title}</h3>
          <p class="author">ä½œè€…: ${capsule.author}</p>
          <p class="distance">è·ç¦»: ${capsule.distance}</p>
          <div class="content-text">${capsule.content}</div>
          <div class="demo-notice">
            <small>ğŸ’¡ è¿™æ˜¯æ¼”ç¤ºæ•°æ®ï¼Œå®é™…åŠŸèƒ½éœ€è¦çœŸå®çš„æ—¶å…‰èƒ¶å›Š</small>
          </div>
        </div>
      `;
      
      // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºå†…å®¹
      this.showCapsuleModal('æ—¶å…‰èƒ¶å›Šå†…å®¹', content);
      
      // æ›´æ–°æˆå°±ï¼ˆæ¼”ç¤ºï¼‰
      this.updateAchievements();
      
      // æ ‡è®°èƒ¶å›Šä¸ºå·²è§£é”
      const cell = document.querySelector(`[data-index="${capsule.index}"]`);
      if (cell) {
        cell.classList.remove('unlockable');
        cell.classList.add('unlocked');
        cell.textContent = 'âœ¨';
        cell.title = `${capsule.title} - å·²è§£é”`;
      }
    } else {
      this.showNotification(`è·ç¦»å¤ªè¿œ (${capsule.distance})ï¼Œæ— æ³•è§£é”`, 'warning');
    }
  }

  showCapsuleModal(title, content) {
    // åˆ›å»ºæ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.className = 'capsule-modal';
    modal.innerHTML = `
      <div class="capsule-modal-content">
        <div class="capsule-modal-header">
          <h3>${title}</h3>
          <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
        </div>
        <div class="capsule-modal-body">
          ${content}
        </div>
      </div>
    `;
    
    // æ·»åŠ æ ·å¼
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;
    
    const modalContent = modal.querySelector('.capsule-modal-content');
    modalContent.style.cssText = `
      background: white;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    `;
    
    const modalHeader = modal.querySelector('.capsule-modal-header');
    modalHeader.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    `;
    
    const modalBody = modal.querySelector('.capsule-modal-body');
    modalBody.style.cssText = `
      padding: 20px;
    `;
    
    const closeBtn = modal.querySelector('.close-btn');
    closeBtn.style.cssText = `
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(modal);
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  async handleCapsuleClick(capsule) {
    // æ£€æŸ¥æ˜¯å¦ä¸ºæ¼”ç¤ºæ•°æ®
    if (capsule.id && capsule.id.startsWith('demo_')) {
      this.handleDemoCapsuleClick(capsule);
      return;
    }
    
    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿distanceå±æ€§å­˜åœ¨
    if (!capsule.distance || typeof capsule.distance !== 'string') {
      this.showNotification('èƒ¶å›Šæ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•è§£é”', 'error');
      return;
    }
    
    const distance = parseInt(capsule.distance.replace('m', ''));
    
    if (distance <= 200) {
      // å¯ä»¥è§£é”çš„èƒ¶å›Š
      this.showNotification(`å‘ç°æ—¶å…‰èƒ¶å›Šï¼è·ç¦»${capsule.distance}ï¼Œæ­£åœ¨å°è¯•è§£é”...`, 'info');
      
      try {
        // è°ƒç”¨è§£é”API
        const response = await fetch(`/tools/api/unlock-capsule/${capsule.id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': this.getCsrfToken(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            location: this.currentLocation
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            this.showNotification('èƒ¶å›Šè§£é”æˆåŠŸï¼è·å¾—è®°å¿†ç¢ç‰‡', 'success');
            // æ›´æ–°æˆå°±
            this.updateAchievements();
            // åˆ·æ–°åœ°å›¾
            this.refreshMap();
          } else {
            this.showNotification('è§£é”å¤±è´¥: ' + data.message, 'error');
          }
        } else {
          this.showNotification('è§£é”è¯·æ±‚å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('è§£é”èƒ¶å›Šå¤±è´¥:', error);
        this.showNotification('è§£é”å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    } else {
      // è·ç¦»å¤ªè¿œçš„èƒ¶å›Š
      this.showNotification(`æ—¶å…‰èƒ¶å›Šè·ç¦»${capsule.distance}ï¼Œéœ€è¦èµ°è¿‘ä¸€äº›æ‰èƒ½è§£é”`, 'warning');
    }
  }

  async refreshMap() {
    this.showNotification('æ­£åœ¨åˆ·æ–°åœ°å›¾...', 'info');
    try {
      await this.renderMap();
      this.showNotification('åœ°å›¾å·²åˆ·æ–°', 'success');
    } catch (error) {
      console.error('åˆ·æ–°åœ°å›¾å¤±è´¥:', error);
      this.showNotification('åˆ·æ–°åœ°å›¾å¤±è´¥', 'error');
    }
  }
}

// å…¨å±€å‡½æ•°
window.uploadImage = function() {
  document.getElementById('image-upload').click();
};

window.uploadAudio = function() {
  document.getElementById('audio-upload').click();
};

window.getLocation = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.getCurrentLocation();
  } else {
    console.error('timeCapsuleDiary not initialized');
  }
};

window.getCurrentLocation = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.getCurrentLocation();
  } else {
    console.error('timeCapsuleDiary not initialized');
  }
};

window.clearContent = function() {
  if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
    document.getElementById('diary-content').value = '';
    updateCharCount();
    if (window.timeCapsuleDiary) {
      timeCapsuleDiary.showNotification('å†…å®¹å·²æ¸…ç©º', 'info');
    }
  }
};

window.autoSave = function() {
  const content = document.getElementById('diary-content').value;
  if (content.trim()) {
    localStorage.setItem('timeCapsuleDraft', content);
    if (window.timeCapsuleDiary) {
      timeCapsuleDiary.showNotification('è‰ç¨¿å·²è‡ªåŠ¨ä¿å­˜', 'success');
    }
  }
};

window.handleImageUpload = function(event) {
  const file = event.target.files[0];
  if (file) {
    const btn = document.getElementById('image-upload-btn');
    btn.classList.add('uploading');
    btn.querySelector('span').textContent = 'ä¸Šä¼ ä¸­...';
    
    // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹
    setTimeout(() => {
      btn.classList.remove('uploading');
      btn.classList.add('success');
      btn.querySelector('span').textContent = 'å›¾ç‰‡å·²ä¸Šä¼ ';
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.showNotification(`å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: ${file.name}`, 'success');
      }
      
      // 3ç§’åæ¢å¤åŸçŠ¶æ€
      setTimeout(() => {
        btn.classList.remove('success');
        btn.querySelector('span').textContent = 'å›¾ç‰‡';
      }, 3000);
    }, 2000);
  }
};

window.handleAudioUpload = function(event) {
  const file = event.target.files[0];
  if (file) {
    const btn = document.getElementById('audio-upload-btn');
    btn.classList.add('uploading');
    btn.querySelector('span').textContent = 'ä¸Šä¼ ä¸­...';
    
    // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹
    setTimeout(() => {
      btn.classList.remove('uploading');
      btn.classList.add('success');
      btn.querySelector('span').textContent = 'éŸ³é¢‘å·²ä¸Šä¼ ';
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.showNotification(`éŸ³é¢‘ä¸Šä¼ æˆåŠŸ: ${file.name}`, 'success');
      }
      
      // 3ç§’åæ¢å¤åŸçŠ¶æ€
      setTimeout(() => {
        btn.classList.remove('success');
        btn.querySelector('span').textContent = 'éŸ³é¢‘';
      }, 3000);
    }, 2000);
  }
};

window.updateCharCount = function() {
  const content = document.getElementById('diary-content').value;
  const charCount = document.querySelector('.char-count');
  charCount.textContent = `${content.length}/5000`;
  
  // æ ¹æ®å­—ç¬¦æ•°æ”¹å˜é¢œè‰²
  if (content.length > 4500) {
    charCount.style.color = '#ef4444';
  } else if (content.length > 4000) {
    charCount.style.color = '#f59e0b';
  } else {
    charCount.style.color = '#6b7280';
  }
};

window.saveCapsule = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.saveCapsule();
  } else {
    console.warn('timeCapsuleDiary not initialized, retrying in 1 second...');
    setTimeout(() => {
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.saveCapsule();
      } else {
        console.error('timeCapsuleDiary still not initialized');
        alert('ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•');
      }
    }, 1000);
  }
};

window.previewCapsule = function() {
  const content = document.getElementById('diary-content').value;
  if (!content) {
    if (window.timeCapsuleDiary) {
      timeCapsuleDiary.showNotification('è¯·å…ˆå†™ä¸‹å†…å®¹', 'warning');
    }
    return;
  }
  
  // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
  const modal = document.getElementById('capsule-preview-modal');
  const previewContent = document.getElementById('preview-content');
  
  const emotions = window.timeCapsuleDiary ? timeCapsuleDiary.selectedEmotions : [];
  
  previewContent.innerHTML = `
    <div class="preview-capsule">
      <h4>èƒ¶å›Šé¢„è§ˆ</h4>
      <p>${content}</p>
      <div class="preview-emotions">
        æƒ…ç»ª: ${emotions.join(', ')}
      </div>
    </div>
  `;
  
  modal.style.display = 'block';
};

window.closePreview = function() {
  document.getElementById('capsule-preview-modal').style.display = 'none';
};

window.refreshCapsules = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.loadNearbyCapsules();
  } else {
    console.warn('timeCapsuleDiary not initialized, retrying in 1 second...');
    setTimeout(() => {
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.loadNearbyCapsules();
      } else {
        console.error('timeCapsuleDiary still not initialized');
        alert('ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•');
      }
    }, 1000);
  }
};

window.openMap = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.openMap();
  } else {
    console.warn('timeCapsuleDiary not initialized, retrying in 1 second...');
    setTimeout(() => {
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.openMap();
      } else {
        console.error('timeCapsuleDiary still not initialized');
        alert('ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•');
      }
    }, 1000);
  }
};

window.closeMap = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.closeMap();
  } else {
    console.warn('timeCapsuleDiary not initialized, retrying in 1 second...');
    setTimeout(() => {
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.closeMap();
      } else {
        console.error('timeCapsuleDiary still not initialized');
        alert('ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•');
      }
    }, 1000);
  }
};

window.showHistoryCapsules = function() {
  // åˆ›å»ºå†å²èƒ¶å›Šæ¨¡æ€æ¡†
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.id = 'history-capsules-modal';
  modal.style.display = 'block';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>æˆ‘çš„å†å²èƒ¶å›Š</h3>
        <button class="close-btn" onclick="closeHistoryCapsules()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="history-capsules-list">
          <div class="loading">æ­£åœ¨åŠ è½½å†å²èƒ¶å›Š...</div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // åŠ è½½å†å²èƒ¶å›Šæ•°æ®
  loadHistoryCapsules();
};

window.closeHistoryCapsules = function() {
  const modal = document.getElementById('history-capsules-modal');
  if (modal) {
    modal.remove();
  }
};

window.loadHistoryCapsules = function() {
  const listContainer = document.getElementById('history-capsules-list');
  if (!listContainer) return;
  
  // æ¨¡æ‹Ÿå†å²èƒ¶å›Šæ•°æ®
  const historyCapsules = [
    {
      id: 1,
      title: 'ç¾å¥½çš„ä¸€å¤©',
      content: 'ä»Šå¤©å’Œæœ‹å‹ä¸€èµ·å»äº†å…¬å›­ï¼Œå¤©æ°”å¾ˆå¥½ï¼Œå¿ƒæƒ…æ„‰å¿«...',
      emotions: ['happy', 'grateful'],
      created_at: '2024-01-15 14:30',
      unlock_time: '2024-02-15 14:30',
      status: 'locked'
    },
    {
      id: 2,
      title: 'å·¥ä½œæ„Ÿæ‚Ÿ',
      content: 'ä»Šå¤©å®Œæˆäº†ä¸€ä¸ªé‡è¦çš„é¡¹ç›®ï¼Œè™½ç„¶å¾ˆç´¯ä½†å¾ˆæœ‰æˆå°±æ„Ÿ...',
      emotions: ['excited', 'inspired'],
      created_at: '2024-01-14 18:20',
      unlock_time: '2024-01-21 18:20',
      status: 'unlocked'
    },
    {
      id: 3,
      title: 'æ·±å¤œæ€è€ƒ',
      content: 'å¤œæ·±äººé™çš„æ—¶å€™ï¼Œæ€»æ˜¯ä¼šæƒ³èµ·å¾ˆå¤šå¾€äº‹...',
      emotions: ['calm', 'inspired'],
      created_at: '2024-01-13 23:45',
      unlock_time: '2024-01-20 23:45',
      status: 'unlocked'
    }
  ];
  
  // æ¸²æŸ“å†å²èƒ¶å›Šåˆ—è¡¨
  listContainer.innerHTML = historyCapsules.map(capsule => `
    <div class="history-capsule-item" style="
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    ">
      <div class="capsule-header" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      ">
        <h4 style="
          font-size: 18px;
          font-weight: 600;
          color: #1f2937;
          margin: 0;
        ">${capsule.title}</h4>
        <span class="status-badge" style="
          padding: 4px 8px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 500;
          ${capsule.status === 'unlocked' ? 
            'background: #d1fae5; color: #065f46;' : 
            'background: #fef3c7; color: #92400e;'
          }
        ">
          ${capsule.status === 'unlocked' ? 'å·²è§£é”' : 'é”å®šä¸­'}
        </span>
      </div>
      <div class="capsule-content" style="
        color: #4b5563;
        line-height: 1.6;
        margin-bottom: 10px;
        font-size: 16px;
      ">
        ${capsule.content.length > 100 ? 
          capsule.content.substring(0, 100) + '...' : 
          capsule.content
        }
      </div>
      <div class="capsule-meta" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: #6b7280;
      ">
        <div class="emotions">
          æƒ…ç»ª: ${capsule.emotions.map(emo => {
            const emotionMap = {
              'happy': 'ğŸ˜Š', 'excited': 'ğŸ’¡', 'calm': 'ğŸ˜Œ',
              'sad': 'ğŸ˜¢', 'angry': 'ğŸ˜ ', 'surprised': 'ğŸ˜²',
              'anxious': 'ğŸ˜°', 'grateful': 'ğŸ™', 'inspired': 'âœ¨'
            };
            return emotionMap[emo] || emo;
          }).join(' ')}
        </div>
        <div class="dates">
          åˆ›å»º: ${capsule.created_at} | è§£é”: ${capsule.unlock_time}
        </div>
      </div>
      <div class="capsule-actions" style="
        margin-top: 15px;
        display: flex;
        gap: 10px;
      ">
        <button class="btn btn-sm btn-primary" onclick="viewCapsuleDetail(${capsule.id})" style="
          padding: 8px 16px;
          background: #3b82f6;
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
        ">
          æŸ¥çœ‹è¯¦æƒ…
        </button>
        ${capsule.status === 'locked' ? `
          <button class="btn btn-sm btn-secondary" onclick="unlockCapsule(${capsule.id})" style="
            padding: 8px 16px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
          ">
            è§£é”èƒ¶å›Š
          </button>
        ` : ''}
      </div>
    </div>
  `).join('');
};

window.viewCapsuleDetail = function(capsuleId) {
  alert(`æŸ¥çœ‹èƒ¶å›Šè¯¦æƒ…: ${capsuleId}`);
  // è¿™é‡Œå¯ä»¥æ·»åŠ æŸ¥çœ‹è¯¦æƒ…çš„é€»è¾‘
};

window.unlockCapsule = function(capsuleId) {
  if (confirm('ç¡®å®šè¦è§£é”è¿™ä¸ªèƒ¶å›Šå—ï¼Ÿ')) {
    alert(`è§£é”èƒ¶å›Š: ${capsuleId}`);
    // è¿™é‡Œå¯ä»¥æ·»åŠ è§£é”èƒ¶å›Šçš„é€»è¾‘
    loadHistoryCapsules(); // é‡æ–°åŠ è½½åˆ—è¡¨
  }
};

window.refreshMap = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.refreshMap();
  } else {
    console.warn('timeCapsuleDiary not initialized, retrying in 1 second...');
    setTimeout(() => {
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.refreshMap();
      } else {
        console.error('timeCapsuleDiary still not initialized');
        alert('ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•');
      }
    }, 1000);
  }
};

// åˆå§‹åŒ–åº”ç”¨
let timeCapsuleDiary;

// ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–
function initializeTimeCapsuleDiary() {
  try {
    timeCapsuleDiary = new TimeCapsuleDiary();
    window.timeCapsuleDiary = timeCapsuleDiary; // ç¡®ä¿å…¨å±€å¯è®¿é—®
    
    // é¡µé¢åŠ è½½æ—¶æ¢å¤è‰ç¨¿
    const draft = localStorage.getItem('timeCapsuleDraft');
    if (draft) {
      const diaryContent = document.getElementById('diary-content');
      if (diaryContent) {
        diaryContent.value = draft;
        updateCharCount();
        if (timeCapsuleDiary) {
          timeCapsuleDiary.showNotification('å·²æ¢å¤ä¸Šæ¬¡çš„è‰ç¨¿', 'info');
        }
      }
    }
    
    console.log('âœ… timeCapsuleDiary åˆå§‹åŒ–å®Œæˆ');
  } catch (error) {
    console.error('âŒ timeCapsuleDiary åˆå§‹åŒ–å¤±è´¥:', error);
  }
}

// ä½¿ç”¨å¤šç§æ–¹å¼ç¡®ä¿åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  // å»¶è¿Ÿä¸€ç‚¹åˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
  setTimeout(initializeTimeCapsuleDiary, 100);
});

// å¦‚æœDOMContentLoadedå·²ç»è§¦å‘ï¼Œç«‹å³åˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeTimeCapsuleDiary);
} else {
  // DOMå·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³åˆå§‹åŒ–
  setTimeout(initializeTimeCapsuleDiary, 100);
}

// æ–‡ä»¶ä¸Šä¼ å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
  const imageUpload = document.getElementById('image-upload');
  if (imageUpload) {
    imageUpload.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && window.timeCapsuleDiary) {
        timeCapsuleDiary.showNotification(`å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: ${file.name}`, 'success');
      }
    });
  }
  
  const audioUpload = document.getElementById('audio-upload');
  if (audioUpload) {
    audioUpload.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && window.timeCapsuleDiary) {
        timeCapsuleDiary.showNotification(`éŸ³é¢‘ä¸Šä¼ æˆåŠŸ: ${file.name}`, 'success');
      }
    });
  }
  
  // å­—ç¬¦è®¡æ•°å’Œè‡ªåŠ¨ä¿å­˜
  const diaryContent = document.getElementById('diary-content');
  if (diaryContent) {
    diaryContent.addEventListener('input', function(e) {
      updateCharCount();
      
      // è‡ªåŠ¨ä¿å­˜è‰ç¨¿ï¼ˆé˜²æŠ–ï¼‰
      clearTimeout(window.autoSaveTimer);
      window.autoSaveTimer = setTimeout(() => {
        if (e.target.value.trim()) {
          localStorage.setItem('timeCapsuleDraft', e.target.value);
        }
      }, 1000);
    });
  }
});

// æ·»åŠ getCookieå‡½æ•°
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
