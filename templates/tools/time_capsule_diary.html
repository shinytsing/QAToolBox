{% extends 'base.html' %}
{% load static %}

{% block tool_title_inner %}时光胶囊日记{% endblock %}
{% block tool_title_display %}时光胶囊日记{% endblock %}

{% block extra_css %}
<!-- 时光胶囊日记专用样式 -->
<style>
:root {
  --primary-color: #6366f1;
  --secondary-color: #8b5cf6;
  --accent-color: #f59e0b;
  --success-color: #10b981;
  --warning-color: #f97316;
  --error-color: #ef4444;
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --bg-primary: #ffffff;
  --bg-secondary: #f9fafb;
  --bg-accent: #f3f4f6;
  --border-color: #e5e7eb;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
  --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%);
  min-height: 100vh;
  color: var(--text-primary);
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 20%;
  left: 10%;
  width: 8px;
  height: 8px;
  background: #06b6d4;
  border-radius: 50%;
  opacity: 0.3;
  z-index: 0;
}

body::after {
  content: '';
  position: fixed;
  top: 60%;
  right: 20%;
  width: 6px;
  height: 6px;
  background: #06b6d4;
  border-radius: 50%;
  opacity: 0.2;
  z-index: 0;
}

.time-capsule-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* 头部区域 */
.capsule-header {
  text-align: center;
  margin-bottom: 40px;
  color: white;
}

.capsule-header h1 {
  font-size: 3rem;
  font-weight: 800;
  margin-bottom: 20px;
  color: #1f2937;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
  letter-spacing: -0.02em;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-actions {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin-top: 30px;
  position: relative;
  z-index: 1;
}

.connection-status {
  margin-top: 0;
}

.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  border-radius: 25px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
  backdrop-filter: blur(10px);
  font-size: 0.9rem;
  color: #374151;
  border: 2px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1);
  font-weight: 600;
  transition: all 0.3s ease;
}

.status-indicator:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.15);
  border-color: var(--primary-color);
}

.status-indicator i {
  font-size: 0.8rem;
  transition: color 0.3s ease;
}

.status-indicator.connected i {
  color: #10b981;
}

.status-indicator.disconnected i {
  color: #f59e0b;
}

.status-indicator.error i {
  color: #ef4444;
}

.status-text {
  font-weight: 500;
}

/* 主功能区域 */
.capsule-main {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  margin-bottom: 40px;
}

/* 记录区域 */
.record-section {
  background: var(--bg-primary);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow-xl);
  position: relative;
  overflow: hidden;
}

.record-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
}

.record-header {
  display: flex;
  align-items: center;
  margin-bottom: 25px;
}

.record-header h2 {
  font-size: 2rem;
  font-weight: 700;
  color: #1f2937;
  margin-left: 15px;
}

.record-header .icon {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5rem;
}

/* 情绪魔方 */
.emotion-cube {
  margin-bottom: 25px;
}

.emotion-cube h3 {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 15px;
  color: var(--text-primary);
}

.cube-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 15px;
}

.emotion-item {
  aspect-ratio: 1;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  background: linear-gradient(135deg, var(--bg-secondary), #f8fafc);
  position: relative;
  overflow: hidden;
}

.emotion-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 1;
}

.emotion-item span {
  position: relative;
  z-index: 2;
  transition: transform 0.3s ease;
}

.emotion-item:hover {
  transform: translateY(-4px) scale(1.05);
  box-shadow: var(--shadow-lg);
  border-color: var(--primary-color);
}

.emotion-item:hover::before {
  opacity: 0.1;
}

.emotion-item:hover span {
  transform: scale(1.2);
}

.emotion-item.selected {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  transform: scale(1.1);
  box-shadow: var(--shadow-xl);
}

.emotion-item.selected::before {
  opacity: 0;
}

.emotion-item.selected span {
  transform: scale(1.1);
}

.emotion-item.combined {
  background: linear-gradient(135deg, var(--accent-color), var(--warning-color));
  color: white;
}

/* 情绪组合显示 */
.emotion-combination-display {
  margin-top: 15px;
  padding: 10px 15px;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  border-radius: 12px;
  color: white;
  font-size: 0.9rem;
  font-weight: 500;
  text-align: center;
  min-height: 20px;
  transition: all 0.3s ease;
  opacity: 0;
  transform: translateY(-10px);
}

.emotion-combination-display:not(:empty) {
  opacity: 1;
  transform: translateY(0);
}

/* 多模态记录 */
.multimodal-record {
  margin-bottom: 25px;
}

.multimodal-record h3 {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 15px;
  color: var(--text-primary);
}

.record-inputs {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.text-input {
  position: relative;
}

.text-input textarea {
  width: 100%;
  min-height: 120px;
  padding: 15px;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  font-size: 1rem;
  resize: vertical;
  transition: border-color 0.3s ease;
  font-family: inherit;
}

.text-input textarea:focus {
  outline: none;
  border-color: var(--primary-color);
}

.media-upload {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.upload-btn {
  aspect-ratio: 1;
  border: 2px dashed var(--border-color);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: var(--bg-secondary);
}

.upload-btn:hover {
  border-color: var(--primary-color);
  background: var(--bg-accent);
}

.upload-btn i {
  font-size: 1.5rem;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.upload-btn span {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* 胶囊设置 */
.capsule-settings {
  margin-bottom: 25px;
}

.capsule-settings h3 {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 15px;
  color: var(--text-primary);
}

.settings-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.setting-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.setting-item label {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-secondary);
}

.setting-item select,
.setting-item input {
  padding: 10px;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 0.9rem;
  transition: border-color 0.3s ease;
}

.setting-item select:focus,
.setting-item input:focus {
  outline: none;
  border-color: var(--primary-color);
}

/* 发现区域 */
.discover-section {
  background: var(--bg-primary);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow-xl);
  position: relative;
  overflow: hidden;
}

.discover-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-color), var(--warning-color), var(--success-color));
}

.discover-header {
  display: flex;
  align-items: center;
  margin-bottom: 25px;
}

.discover-header h2 {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-left: 15px;
}

.discover-header .icon {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, var(--accent-color), var(--warning-color));
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5rem;
}

/* 地图区域 */
.map-container {
  height: 300px;
  background: var(--bg-secondary);
  border-radius: 12px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.map-placeholder {
  text-align: center;
  color: var(--text-secondary);
}

.map-placeholder i {
  font-size: 3rem;
  margin-bottom: 15px;
  opacity: 0.5;
}

.map-placeholder p {
  font-size: 1rem;
}

/* 胶囊列表 */
.capsule-list {
  max-height: 400px;
  overflow-y: auto;
}

.capsule-item {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-left: 4px solid transparent;
}

.capsule-item:hover {
  transform: translateX(5px);
  box-shadow: var(--shadow-md);
  border-left-color: var(--primary-color);
}

.capsule-item.unlocked {
  border-left-color: var(--success-color);
  background: linear-gradient(135deg, var(--bg-secondary), #ecfdf5);
}

.capsule-item .capsule-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.capsule-item .distance {
  font-size: 0.8rem;
  color: var(--text-secondary);
  background: var(--bg-accent);
  padding: 4px 8px;
  border-radius: 6px;
}

.capsule-item .content {
  font-size: 0.9rem;
  color: var(--text-primary);
  line-height: 1.5;
}

.capsule-item .meta {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-top: 10px;
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* 底部操作区域 */
.capsule-actions {
  display: flex;
  gap: 15px;
  margin-top: 20px;
}

.btn {
  padding: 14px 28px;
  border: none;
  border-radius: 16px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
  overflow: hidden;
  letter-spacing: -0.01em;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.6s ease;
}

.btn:hover::before {
  left: 100%;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  box-shadow: 0 8px 25px -5px rgba(99, 102, 241, 0.4);
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px -8px rgba(99, 102, 241, 0.5);
}

.btn-secondary {
  background: linear-gradient(135deg, var(--bg-secondary), #f1f5f9);
  color: var(--text-primary);
  border: 2px solid var(--border-color);
  box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1);
}

.btn-secondary:hover {
  background: linear-gradient(135deg, var(--bg-accent), #e2e8f0);
  border-color: var(--primary-color);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.15);
}

.btn-success {
  background: linear-gradient(135deg, var(--success-color), #059669);
  color: white;
  box-shadow: 0 8px 25px -5px rgba(16, 185, 129, 0.4);
}

.btn-success:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px -8px rgba(16, 185, 129, 0.5);
}

/* 成就系统 */
.achievements {
  background: var(--bg-primary);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow-xl);
  margin-top: 30px;
}

.achievements h2 {
  font-size: 1.8rem;
  font-weight: 700;
  margin-bottom: 20px;
  text-align: center;
  color: var(--text-primary);
}

.achievement-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.achievement-item {
  background: var(--bg-primary);
  border-radius: 20px;
  padding: 25px;
  text-align: center;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-md);
}

.achievement-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
  opacity: 0;
  transition: opacity 0.3s ease;
}

.achievement-item:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-xl);
  border-color: var(--primary-color);
}

.achievement-item:hover::before {
  opacity: 1;
}

.achievement-item.unlocked {
  border-color: var(--accent-color);
  background: linear-gradient(135deg, var(--bg-secondary), #fef3c7);
}

.achievement-item .icon {
  font-size: 3rem;
  margin-bottom: 15px;
  display: block;
  transition: transform 0.3s ease;
}

.achievement-item:hover .icon {
  transform: scale(1.1);
}

.achievement-item.unlocked .icon {
  animation: sparkle 2s infinite;
}

.achievement-item h3 {
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text-primary);
  letter-spacing: -0.01em;
}

.achievement-item p {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.achievement-item .progress {
  font-size: 0.9rem;
  font-weight: 600;
  padding: 8px 16px;
  border-radius: 25px;
  background: linear-gradient(135deg, var(--bg-accent), #f1f5f9);
  color: var(--text-secondary);
  display: inline-block;
  min-width: 100px;
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

.achievement-item:hover .progress {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  transform: scale(1.05);
}

.achievement-item.unlocked .progress {
  background: linear-gradient(135deg, var(--success-color), #059669);
  color: white;
  border-color: var(--success-color);
}

.achievement-points {
  font-size: 0.85rem;
  color: var(--accent-color);
  font-weight: 700;
  margin-top: 8px;
  text-align: center;
  padding: 6px 12px;
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border-radius: 15px;
  border: 1px solid #f59e0b;
  display: inline-block;
  transition: all 0.3s ease;
}

.achievement-item:hover .achievement-points {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.achievement-item.unlocked .achievement-points {
  background: linear-gradient(135deg, #d1fae5, #a7f3d0);
  color: #065f46;
  border-color: #10b981;
}

/* 统计信息样式 */
.stats-section {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  padding: 25px;
  color: white;
  margin-top: 20px;
}

.stats-section h3 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 1.3rem;
  font-weight: 600;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
}

.stat-item {
  text-align: center;
  padding: 15px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-label {
  display: block;
  font-size: 0.9rem;
  opacity: 0.9;
  margin-bottom: 5px;
}

.stat-value {
  display: block;
  font-size: 1.5rem;
  font-weight: 700;
  color: #fff;
}

/* 动画效果 */
@keyframes sparkle {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

.floating {
  animation: float 3s ease-in-out infinite;
}

/* 地图样式 */
.map-container {
  background: var(--bg-primary);
  border-radius: 15px;
  overflow: hidden;
  box-shadow: var(--shadow-lg);
  margin-bottom: 20px;
}

.map-placeholder {
  padding: 60px 20px;
  text-align: center;
  color: var(--text-secondary);
  background: var(--bg-secondary);
}

.map-placeholder i {
  font-size: 3rem;
  margin-bottom: 15px;
  opacity: 0.5;
}

.map-placeholder p {
  font-size: 1.1rem;
  margin: 0;
}

.map-content {
  height: 400px;
  display: flex;
  flex-direction: column;
}

.map-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: var(--primary-color);
  color: white;
}

.map-header h3 {
  margin: 0;
  font-size: 1.2rem;
  font-weight: 600;
}

.close-map-btn {
  background: none;
  border: none;
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 5px;
  border-radius: 5px;
  transition: background-color 0.3s;
}

.close-map-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.map-area {
  flex: 1;
  background: #f8f9fa;
  position: relative;
  overflow: hidden;
}

.map-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-secondary);
}

.map-loading i {
  font-size: 2rem;
  margin-bottom: 10px;
  color: var(--primary-color);
}

.map-loading p {
  margin: 0;
  font-size: 1rem;
}

.map-grid {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  grid-template-rows: repeat(10, 1fr);
  height: 100%;
  gap: 1px;
  background: #e9ecef;
}

.map-cell {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  position: relative;
  cursor: pointer;
  transition: all 0.3s ease;
}

.map-cell:hover {
  background: #e3f2fd;
  transform: scale(1.05);
}

.map-cell.has-capsule {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
}

.map-cell.user-location {
  background: linear-gradient(135deg, #4ecdc4, #44a08d);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
}

.map-cell.unlockable {
  background: linear-gradient(135deg, #feca57, #ff9ff3);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

@keyframes sparkle {
  0%, 100% { 
    transform: scale(1) rotate(0deg);
    filter: brightness(1);
  }
  25% { 
    transform: scale(1.1) rotate(5deg);
    filter: brightness(1.2);
  }
  50% { 
    transform: scale(1.05) rotate(-3deg);
    filter: brightness(1.1);
  }
  75% { 
    transform: scale(1.15) rotate(3deg);
    filter: brightness(1.3);
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.record-section,
.discover-section,
.achievements {
  animation: fadeInUp 0.8s ease-out;
}

.achievement-item {
  animation: slideInLeft 0.6s ease-out;
}

.achievement-item:nth-child(1) { animation-delay: 0.1s; }
.achievement-item:nth-child(2) { animation-delay: 0.2s; }
.achievement-item:nth-child(3) { animation-delay: 0.3s; }
.achievement-item:nth-child(4) { animation-delay: 0.4s; }
.achievement-item:nth-child(5) { animation-delay: 0.5s; }
.achievement-item:nth-child(6) { animation-delay: 0.6s; }

.map-controls {
  display: flex;
  gap: 10px;
  padding: 15px 20px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-color);
}

.map-controls .btn {
  flex: 1;
  padding: 8px 15px;
  font-size: 0.9rem;
}

.map-legend {
  display: flex;
  gap: 15px;
  padding: 10px 20px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-color);
  font-size: 0.8rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

.legend-color.user {
  background: linear-gradient(135deg, #4ecdc4, #44a08d);
}

.legend-color.capsule {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
}

.legend-color.unlockable {
  background: linear-gradient(135deg, #feca57, #ff9ff3);
}

/* 现代化输入框样式 */
.modern-textarea {
  width: 100%;
  min-height: 200px;
  padding: 25px;
  border: 2px solid #e5e7eb;
  border-radius: 20px;
  font-size: 18px;
  line-height: 1.8;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
  background: linear-gradient(135deg, #ffffff, #fafafa);
  color: #1f2937;
  font-weight: 500;
  box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  resize: vertical;
  position: relative;
}

.modern-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 12px 35px -8px rgba(0, 0, 0, 0.15);
  background: #ffffff;
  color: #1f2937;
  font-weight: 500;
  transform: translateY(-2px);
}

.modern-textarea::placeholder {
  color: #6b7280;
  font-style: normal;
  font-weight: 400;
  opacity: 0.9;
}

.input-container {
  position: relative;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.input-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border-top: 1px solid #e5e7eb;
}

.char-count {
  font-size: 14px;
  color: #6b7280;
  font-weight: 500;
}

.input-actions {
  display: flex;
  gap: 8px;
}

.action-btn {
  background: none;
  border: none;
  padding: 8px;
  border-radius: 8px;
  color: #6b7280;
  cursor: pointer;
  transition: all 0.2s ease;
}

.action-btn:hover {
  background: #e5e7eb;
  color: #374151;
}

/* 改进的媒体上传样式 */
.media-upload {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.upload-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border: 2px dashed #d1d5db;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.upload-btn:hover {
  border-color: #6366f1;
  background: linear-gradient(135deg, #eef2ff, #e0e7ff);
  transform: translateY(-2px);
}

.upload-btn i {
  font-size: 24px;
  color: #6b7280;
  margin-bottom: 8px;
  transition: color 0.3s ease;
}

.upload-btn:hover i {
  color: #6366f1;
}

.upload-btn span {
  font-size: 14px;
  color: #374151;
  font-weight: 500;
}

.upload-btn.uploading {
  border-color: #f59e0b;
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
}

.upload-btn.uploading i {
  color: #f59e0b;
  animation: pulse 1s infinite;
}

.upload-btn.success {
  border-color: #10b981;
  background: linear-gradient(135deg, #ecfdf5, #d1fae5);
}

.upload-btn.success i {
  color: #10b981;
}

.upload-btn.error {
  border-color: #ef4444;
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
}

.upload-btn.error i {
  color: #ef4444;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .capsule-main {
    grid-template-columns: 1fr;
  }
  
  .settings-grid {
    grid-template-columns: 1fr;
  }
  
  .media-upload {
    grid-template-columns: 1fr;
  }
  
  .capsule-header h1 {
    font-size: 2rem;
  }
  
  .map-content {
    height: 300px;
  }
  
  .map-grid {
    grid-template-columns: repeat(8, 1fr);
    grid-template-rows: repeat(8, 1fr);
  }
}

/* 加载动画 */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* 通知样式 */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 10px;
  color: white;
  font-weight: 500;
  z-index: 1000;
  transform: translateX(100%);
  transition: transform 0.3s ease;
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  background: var(--success-color);
}

.notification.error {
  background: var(--error-color);
}

.notification.warning {
  background: var(--warning-color);
}

.notification.info {
  background: var(--primary-color);
}

/* 模态框样式 */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 16px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  max-width: 90vw;
  max-height: 90vh;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}

.modal-header h3 {
  font-size: 20px;
  font-weight: 600;
  color: #1f2937;
  margin: 0;
}

.close-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: #6b7280;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.close-btn:hover {
  background: #e5e7eb;
  color: #374151;
}

.modal-body {
  padding: 24px;
  overflow-y: auto;
}

.loading {
  text-align: center;
  padding: 40px;
  color: #6b7280;
  font-size: 16px;
}
</style>
{% endblock %}

{% block content %}
<div class="time-capsule-container">
  <!-- 头部区域 -->
  <div class="capsule-header">
    <h1>时光胶囊日记</h1>
    <div class="header-actions">
      <a href="{% url 'tools:time_capsule_history' %}" class="btn btn-secondary" style="margin-right: 10px; text-decoration: none; color: white;">
        <i class="fas fa-history"></i>
        历史胶囊
      </a>
      <div class="connection-status">
        <span id="websocket-status" class="status-indicator">
          <i class="fas fa-circle"></i>
          <span class="status-text">连接中...</span>
        </span>
      </div>
    </div>
  </div>

  <!-- 主功能区域 -->
  <div class="capsule-main">
    <!-- 记录区域 -->
    <div class="record-section">
      <div class="record-header">
        <div class="icon">
          <i class="fas fa-pen-fancy"></i>
        </div>
        <h2>记录今日</h2>
      </div>

      <!-- 情绪魔方 -->
      <div class="emotion-cube">
        <h3>🎯 情绪魔方</h3>
        <div class="cube-container">
          <div class="emotion-item" data-emotion="excited">
            <span>💡</span>
          </div>
          <div class="emotion-item" data-emotion="happy">
            <span>😊</span>
          </div>
          <div class="emotion-item" data-emotion="calm">
            <span>😌</span>
          </div>
          <div class="emotion-item" data-emotion="sad">
            <span>😢</span>
          </div>
          <div class="emotion-item" data-emotion="angry">
            <span>😠</span>
          </div>
          <div class="emotion-item" data-emotion="surprised">
            <span>😲</span>
          </div>
          <div class="emotion-item" data-emotion="anxious">
            <span>😰</span>
          </div>
          <div class="emotion-item" data-emotion="grateful">
            <span>🙏</span>
          </div>
          <div class="emotion-item" data-emotion="inspired">
            <span>✨</span>
          </div>
        </div>
        <div id="emotion-combination" class="emotion-combination-display"></div>
      </div>

      <!-- 多模态记录 -->
      <div class="multimodal-record">
        <h3>多模态记录</h3>
        <div class="record-inputs">
          <div class="text-input">
            <div class="input-container">
              <textarea id="diary-content" placeholder="写下今天的故事..." class="modern-textarea"></textarea>
              <div class="input-footer">
                <span class="char-count">0/5000</span>
                <div class="input-actions">
                  <button class="action-btn" onclick="clearContent()" title="清空内容">
                    <i class="fas fa-trash"></i>
                  </button>
                  <button class="action-btn" onclick="autoSave()" title="自动保存">
                    <i class="fas fa-save"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
                      <div class="media-upload">
              <div class="upload-btn" onclick="uploadImage()" id="image-upload-btn">
                <i class="fas fa-image"></i>
                <span>图片</span>
                <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
              </div>
              <div class="upload-btn" onclick="uploadAudio()" id="audio-upload-btn">
                <i class="fas fa-microphone"></i>
                <span>音频</span>
                <input type="file" id="audio-upload" accept="audio/*" style="display: none;" onchange="handleAudioUpload(event)">
              </div>
              <div class="upload-btn" onclick="getLocation()" id="location-upload-btn">
                <i class="fas fa-map-marker-alt"></i>
                <span>位置</span>
              </div>
            </div>
        </div>
      </div>

      <!-- 胶囊设置 -->
      <div class="capsule-settings">
        <h3>胶囊设置</h3>
        <div class="settings-grid">
          <div class="setting-item">
            <label>解锁时间</label>
            <input type="datetime-local" id="unlock-time">
          </div>
          <div class="setting-item">
            <label>解锁条件</label>
            <select id="unlock-condition">
              <option value="time">时间解锁</option>
              <option value="location">位置解锁</option>
              <option value="event">事件解锁</option>
            </select>
          </div>
          <div class="setting-item">
            <label>可见性</label>
            <select id="visibility">
              <option value="private">仅自己</option>
              <option value="public">公开分享</option>
              <option value="anonymous">匿名分享</option>
            </select>
          </div>
          <div class="setting-item">
            <label>胶囊类型</label>
            <select id="capsule-type">
              <option value="memory">记忆胶囊</option>
              <option value="wish">愿望胶囊</option>
              <option value="secret">秘密胶囊</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 操作按钮 -->
      <div class="capsule-actions">
        <button class="btn btn-primary" onclick="saveCapsule()">
          <i class="fas fa-save"></i>
          保存胶囊
        </button>
        <button class="btn btn-secondary" onclick="previewCapsule()">
          <i class="fas fa-eye"></i>
          预览
        </button>
      </div>
    </div>

    <!-- 发现区域 -->
    <div class="discover-section">
      <div class="discover-header">
        <div class="icon">
          <i class="fas fa-search"></i>
        </div>
        <h2>发现胶囊</h2>
      </div>

      <!-- 地图区域 -->
      <div class="map-container" id="map-container">
        <div class="map-placeholder" id="map-placeholder">
          <i class="fas fa-map"></i>
          <p>点击"打开地图"开始探索</p>
        </div>
        <div class="map-content" id="map-content" style="display: none;">
          <div class="map-header">
            <h3>附近胶囊地图</h3>
            <button class="close-map-btn" onclick="closeMap()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="map-area" id="map-area">
            <!-- 地图将在这里渲染 -->
          </div>
          <div class="map-controls">
            <button class="btn btn-sm btn-primary" onclick="getCurrentLocation()">
              <i class="fas fa-crosshairs"></i>
              定位
            </button>
            <button class="btn btn-sm btn-secondary" onclick="refreshMap()">
              <i class="fas fa-sync-alt"></i>
              刷新
            </button>
          </div>
          <div class="map-legend">
            <div class="legend-item">
              <div class="legend-color user"></div>
              <span>我的位置</span>
            </div>
            <div class="legend-item">
              <div class="legend-color capsule"></div>
              <span>时光胶囊</span>
            </div>
            <div class="legend-item">
              <div class="legend-color unlockable"></div>
              <span>可解锁</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 胶囊列表 -->
      <div class="capsule-list" id="capsule-list">
        <!-- 胶囊项目将通过JavaScript动态生成 -->
      </div>

      <!-- 发现操作 -->
      <div class="capsule-actions">
        <button class="btn btn-success" onclick="refreshCapsules()">
          <i class="fas fa-sync-alt"></i>
          刷新
        </button>
        <button class="btn btn-secondary" onclick="openMap()">
          <i class="fas fa-map-marked-alt"></i>
          打开地图
        </button>
      </div>
    </div>
  </div>

  <!-- 成就系统 -->
  <div class="achievements">
    <h2>成就徽章</h2>
    <div class="achievement-grid">
      <div class="achievement-item" id="achievement-traveler">
        <div class="icon">🌟</div>
        <h3>时光旅人</h3>
        <div class="progress">0/7 天</div>
        <div class="achievement-points">+50 积分</div>
      </div>
      <div class="achievement-item" id="achievement-explorer">
        <div class="icon">🚀</div>
        <h3>城市探险家</h3>
        <div class="progress">0/5 个</div>
        <div class="achievement-points">+100 积分</div>
      </div>
      <div class="achievement-item" id="achievement-prophet">
        <div class="icon">🔮</div>
        <h3>预言家</h3>
        <div class="progress">0/3 次</div>
        <div class="achievement-points">+75 积分</div>
      </div>
      <div class="achievement-item" id="achievement-collector">
        <div class="icon">🎁</div>
        <h3>记忆收藏家</h3>
        <div class="progress">0/10 个</div>
        <div class="achievement-points">+200 积分</div>
      </div>
      <div class="achievement-item" id="achievement-emotion-master">
        <div class="icon">🎭</div>
        <h3>情绪大师</h3>
        <div class="progress">0/9 种</div>
        <div class="achievement-points">+150 积分</div>
      </div>
      <div class="achievement-item" id="achievement-social-butterfly">
        <div class="icon">🦋</div>
        <h3>社交蝴蝶</h3>
        <div class="progress">0/20 个</div>
        <div class="achievement-points">+125 积分</div>
      </div>
    </div>
    
    <!-- 统计信息显示 -->
    <div class="stats-section">
      <h3>个人统计</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-label">连续记录天数:</span>
          <span class="stat-value" id="consecutive-days">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">解锁胶囊数:</span>
          <span class="stat-value" id="unlock-count">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">记忆碎片数:</span>
          <span class="stat-value" id="fragment-count">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">预测成真数:</span>
          <span class="stat-value" id="prophecy-count">0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 隐藏的文件输入 -->
<input type="file" id="image-upload" accept="image/*" style="display: none;">
<input type="file" id="audio-upload" accept="audio/*" style="display: none;">

<!-- 胶囊预览模态框 -->
<div class="modal" id="capsule-preview-modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>胶囊预览</h3>
      <button class="close-btn" onclick="closePreview()">&times;</button>
    </div>
    <div class="modal-body" id="preview-content">
      <!-- 预览内容 -->
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局配置
window.TIME_CAPSULE_CONFIG = {
  websocket_available: {{ websocket_available|yesno:"true,false" }},
  api_timeout: {{ api_timeout|default:10000 }},
  retry_attempts: {{ retry_attempts|default:3 }},
  base_url: '{{ request.build_absolute_uri }}'
};

// API工具类
class ApiClient {
  constructor() {
    this.baseUrl = window.TIME_CAPSULE_CONFIG.base_url;
    this.timeout = window.TIME_CAPSULE_CONFIG.api_timeout;
    this.maxRetries = window.TIME_CAPSULE_CONFIG.retry_attempts;
  }

  async request(url, options = {}) {
    const config = {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': this.getCsrfToken(),
        ...options.headers
      },
      timeout: this.timeout,
      ...options
    };

    let lastError;
    
    for (let attempt = 1; attempt <= this.maxRetries; attempt++) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.timeout);
        
        const response = await fetch(url, {
          ...config,
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        return await response.json();
        
      } catch (error) {
        lastError = error;
        
        if (error.name === 'AbortError') {
          console.warn(`API请求超时 (尝试 ${attempt}/${this.maxRetries}): ${url}`);
        } else {
          console.error(`API请求失败 (尝试 ${attempt}/${this.maxRetries}): ${url}`, error);
        }
        
        if (attempt === this.maxRetries) {
          throw new Error(`请求失败，已重试${this.maxRetries}次: ${error.message}`);
        }
        
        // 等待后重试
        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
      }
    }
    
    throw lastError;
  }

  getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  }

  // 时光胶囊相关API
  async createCapsule(data) {
    return this.request('/tools/api/save-capsule/', {
      method: 'POST',
      body: JSON.stringify(data)
    });
  }

  async getUserCapsules() {
    return this.request('/tools/api/get-capsules/');
  }

  async getNearbyCapsules(lat, lng) {
    // 调用真实的附近胶囊API
    const params = new URLSearchParams({
      lat: lat || 39.9042,
      lng: lng || 116.4074,
      radius: 5000
    });
    
    return this.request(`/tools/api/nearby-capsules/?${params}`);
  }

  async unlockCapsule(capsuleId, location = null) {
    const data = location ? { location } : {};
    return this.request(`/tools/api/unlock-capsule/${capsuleId}/`, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  }

  async getAchievements() {
    return this.request('/tools/api/get-achievements/');
  }

  async getMemoryFragments() {
    // 暂时返回空数据，因为后端没有fragments API
    return Promise.resolve({
      success: true,
      fragments: []
    });
  }

  async getParallelMatch() {
    // 暂时返回空数据，因为后端没有parallel_match API
    return Promise.resolve({
      success: true,
      matches: []
    });
  }

  async getStats() {
    // 暂时返回模拟数据，因为后端没有stats API
    return Promise.resolve({
      success: true,
      user_stats: {
        total_capsules: 0,
        public_capsules: 0,
        unlocked_by_others: 0,
        total_fragments: 0,
        achievements_count: 0
      },
      global_stats: {
        total_capsules: 0,
        total_unlocks: 0,
        total_fragments: 0,
        active_users_today: 0
      }
    });
  }
}

// 时光胶囊日记核心功能
class TimeCapsuleDiary {
  constructor() {
    this.selectedEmotions = [];
    this.currentLocation = null;
    this.weatherData = null;
    this.capsules = [];
    this.achievements = {};
    this.apiClient = new ApiClient();
    this.websocketAvailable = window.TIME_CAPSULE_CONFIG.websocket_available;
    this.isLoading = false;
    
    this.init();
  }

  async init() {
    console.log('🚀 时光胶囊日记初始化...');
    
    try {
      this.initEventListeners();
      this.loadUserData();
      await this.getCurrentLocation();
      await this.getWeatherData();
      this.loadNearbyCapsules();
      this.updateAchievements();
      this.loadStats();
      
      // 显示WebSocket状态
      console.log('🔍 WebSocket状态检查:');
      console.log('  - this.websocketAvailable:', this.websocketAvailable);
      console.log('  - typeof this.websocketAvailable:', typeof this.websocketAvailable);
      console.log('  - window.TIME_CAPSULE_CONFIG.websocket_available:', window.TIME_CAPSULE_CONFIG.websocket_available);
      
      if (this.websocketAvailable) {
        console.log('✅ WebSocket可用，设置连接状态为connected');
        this.updateConnectionStatus('connected');
      } else {
        console.log('❌ WebSocket不可用，设置连接状态为disconnected');
        this.updateConnectionStatus('disconnected');
        console.warn('⚠️ WebSocket不可用，将使用轮询模式');
        this.showNotification('实时功能暂时不可用，将使用轮询模式', 'warning');
      }
      
      console.log('✅ 时光胶囊日记初始化完成');
    } catch (error) {
      console.error('❌ 时光胶囊日记初始化失败:', error);
      this.showNotification('初始化失败，请刷新页面重试', 'error');
    }
  }

  initEventListeners() {
    try {
      // 情绪魔方事件
      const emotionItems = document.querySelectorAll('.emotion-item');
      emotionItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          this.toggleEmotion(item);
        });
      });

      // 内容变化监听
      const diaryContent = document.getElementById('diary-content');
      if (diaryContent) {
        diaryContent.addEventListener('input', (e) => {
          this.generateKeywords(e.target.value);
        });
      }

      // 胶囊设置变化
      const unlockCondition = document.getElementById('unlock-condition');
      if (unlockCondition) {
        unlockCondition.addEventListener('change', (e) => {
          this.updateUnlockSettings(e.target.value);
        });
      }
    } catch (error) {
      console.error('初始化事件监听器失败:', error);
    }
  }

  toggleEmotion(emotionItem) {
    const emotion = emotionItem.dataset.emotion;
    
    if (emotionItem.classList.contains('selected')) {
      emotionItem.classList.remove('selected');
      this.selectedEmotions = this.selectedEmotions.filter(e => e !== emotion);
    } else {
      if (this.selectedEmotions.length < 3) {
        emotionItem.classList.add('selected');
        this.selectedEmotions.push(emotion);
      } else {
        this.showNotification('最多只能选择3种情绪组合', 'warning');
        return;
      }
    }

    this.updateEmotionCombination();
  }

  updateEmotionCombination() {
    const combinationEl = document.getElementById('emotion-combination');
    if (!combinationEl) {
      console.warn('emotion-combination元素不存在');
      return;
    }
    
    if (this.selectedEmotions.length > 0) {
      const emotionTexts = {
        'excited': '兴奋',
        'happy': '开心',
        'calm': '平静',
        'sad': '难过',
        'angry': '生气',
        'surprised': '惊讶',
        'anxious': '焦虑',
        'grateful': '感恩',
        'inspired': '受启发'
      };
      
      const combination = this.selectedEmotions.map(e => emotionTexts[e]).join(' + ');
      combinationEl.textContent = `情绪组合: ${combination}`;
    } else {
      combinationEl.textContent = '';
    }
  }

  async getCurrentLocation() {
    try {
      if (navigator.geolocation) {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        
        this.currentLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        
        console.log('📍 位置获取成功:', this.currentLocation);
      }
    } catch (error) {
      console.error('❌ 位置获取失败:', error);
      this.showNotification('无法获取位置信息', 'warning');
    }
  }

  async getWeatherData() {
    if (!this.currentLocation) return;
    
    try {
      // 这里应该调用天气API，暂时使用模拟数据
      this.weatherData = {
        temperature: 22,
        condition: '晴天',
        icon: '☀️'
      };
      
      console.log('🌤️ 天气数据获取成功:', this.weatherData);
    } catch (error) {
      console.error('❌ 天气数据获取失败:', error);
    }
  }

  async generateKeywords(content) {
    if (content.length < 10) return;
    
    try {
      // 这里应该调用AI API生成关键词，暂时使用简单算法
      const keywords = this.extractKeywords(content);
      console.log('🔑 生成关键词:', keywords);
    } catch (error) {
      console.error('❌ 关键词生成失败:', error);
    }
  }

  extractKeywords(text) {
    // 简单的关键词提取算法
    const words = text.toLowerCase().match(/\b\w+\b/g) || [];
    const wordCount = {};
    
    words.forEach(word => {
      if (word.length > 2) {
        wordCount[word] = (wordCount[word] || 0) + 1;
      }
    });
    
    return Object.entries(wordCount)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 5)
      .map(([word]) => word);
  }

  async saveCapsule() {
    if (this.isLoading) {
      this.showNotification('正在保存中，请稍候...', 'info');
      return;
    }

    const content = document.getElementById('diary-content').value.trim();
    if (!content) {
      this.showNotification('请先写下今天的故事', 'warning');
      return;
    }

    if (this.selectedEmotions.length === 0) {
      this.showNotification('请选择至少一种情绪', 'warning');
      return;
    }

    this.isLoading = true;
    this.showNotification('正在保存时光胶囊...', 'info');

    try {
      const capsuleData = {
        content: content,
        emotions: this.selectedEmotions,
        unlock_time: document.getElementById('unlock-time').value || null,
        unlock_condition: document.getElementById('unlock-condition').value || 'time',
        visibility: document.getElementById('visibility').value || 'private'
      };

      const response = await fetch('/tools/api/save-capsule/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(capsuleData)
      });

      const data = await response.json();
      
      if (data.success) {
        this.showNotification('时光胶囊保存成功！', 'success');
        this.resetForm();
        
        // 显示成功消息并提示查看历史
        setTimeout(() => {
          this.showNotification('点击右上角"历史"查看你的胶囊', 'info');
        }, 2000);
      } else {
        throw new Error(data.message || '保存失败');
      }
    } catch (error) {
      console.error('❌ 胶囊保存失败:', error);
      this.showNotification(`保存失败: ${error.message}`, 'error');
    } finally {
      this.isLoading = false;
    }
  }

  resetForm() {
    document.getElementById('diary-content').value = '';
    document.querySelectorAll('.emotion-item').forEach(item => {
      item.classList.remove('selected');
    });
    this.selectedEmotions = [];
    this.updateEmotionCombination();
  }

  async loadNearbyCapsules() {
    if (!this.currentLocation) {
      this.showNotification('无法获取位置信息，请允许位置权限', 'warning');
      return;
    }

    try {
      this.showNotification('正在加载附近的胶囊...', 'info');
      const response = await this.apiClient.getNearbyCapsules(
        this.currentLocation.lat, 
        this.currentLocation.lng
      );
      
      if (response.success) {
        this.renderCapsuleList(response.capsules);
        this.showNotification(`找到 ${response.total_nearby || 0} 个附近胶囊`, 'success');
        
        // 检查WebSocket状态
        if (response.websocket_available !== undefined) {
          this.websocketAvailable = response.websocket_available;
        }
      } else {
        throw new Error(response.message || '获取附近胶囊失败');
      }
    } catch (error) {
      console.error('❌ 加载附近胶囊失败:', error);
      this.showNotification(`加载失败: ${error.message}`, 'error');
    }
  }

  renderCapsuleList(capsules) {
    const listEl = document.getElementById('capsule-list');
    listEl.innerHTML = '';

    capsules.forEach(capsule => {
      const capsuleEl = document.createElement('div');
      capsuleEl.className = `capsule-item ${capsule.isUnlocked ? 'unlocked' : ''}`;
      capsuleEl.innerHTML = `
        <div class="capsule-header">
          <span class="distance">${capsule.distance}</span>
          <span>${capsule.emotion}</span>
        </div>
        <div class="content">${capsule.content}</div>
        <div class="meta">
          <span>解锁时间: ${capsule.unlockTime}</span>
          <span>${capsule.isUnlocked ? '已解锁' : '未解锁'}</span>
        </div>
      `;
      
      capsuleEl.addEventListener('click', () => this.unlockCapsule(capsule));
      listEl.appendChild(capsuleEl);
    });
  }

  async unlockCapsule(capsule) {
    if (capsule.isUnlocked) {
      this.showNotification('这个胶囊已经被解锁了', 'info');
      return;
    }

    if (this.isLoading) {
      this.showNotification('正在解锁中，请稍候...', 'info');
      return;
    }

    this.isLoading = true;
    this.showNotification('正在解锁胶囊...', 'info');

    try {
      const response = await this.apiClient.unlockCapsule(capsule.id, this.currentLocation);
      
      if (response.success) {
        capsule.isUnlocked = true;
        this.renderCapsuleList(this.capsules);
        this.showNotification('胶囊解锁成功！获得记忆碎片', 'success');
        
        // 显示记忆碎片内容
        if (response.fragment_content) {
          this.showNotification(`记忆碎片: ${response.fragment_content}`, 'info');
        }
        
        // 更新成就
        this.updateAchievements();
        
        // 检查WebSocket状态
        if (response.websocket_available !== undefined) {
          this.websocketAvailable = response.websocket_available;
        }
      } else {
        throw new Error(response.message || '解锁失败');
      }
    } catch (error) {
      console.error('❌ 胶囊解锁失败:', error);
      this.showNotification(`解锁失败: ${error.message}`, 'error');
    } finally {
      this.isLoading = false;
    }
  }

  async updateAchievements() {
    try {
      const response = await this.apiClient.getAchievements();
      
      if (response.success) {
        this.displayAchievements(response.achievements, response.stats);
        
        // 检查WebSocket状态
        if (response.websocket_available !== undefined) {
          this.websocketAvailable = response.websocket_available;
        }
      } else {
        console.warn('API返回错误，使用默认数据:', response.message);
        // 即使API返回错误，也尝试使用返回的数据
        this.displayAchievements(
          response.achievements || [], 
          response.stats || {
            consecutive_days: 0,
            unlock_count: 0,
            fragment_count: 0,
            prophecy_count: 0,
            total_points: 0
          }
        );
      }
    } catch (error) {
      console.error('获取成就数据失败:', error);
      // 使用模拟数据
      this.displayMockAchievements();
    }
  }

  displayMockAchievements() {
    // 模拟成就数据
    const mockAchievements = [
      {
        type: 'traveler',
        unlocked: false,
        progress: 3,
        target: 7,
        points: 50
      },
      {
        type: 'explorer',
        unlocked: false,
        progress: 1,
        target: 5,
        points: 100
      },
      {
        type: 'prophet',
        unlocked: false,
        progress: 0,
        target: 3,
        points: 75
      },
      {
        type: 'collector',
        unlocked: false,
        progress: 2,
        target: 10,
        points: 200
      },
      {
        type: 'emotion-master',
        unlocked: false,
        progress: 4,
        target: 9,
        points: 150
      },
      {
        type: 'social-butterfly',
        unlocked: false,
        progress: 0,
        target: 20,
        points: 125
      }
    ];

    this.displayAchievements(mockAchievements, {
      consecutive_days: 3,
      unlock_count: 1,
      fragment_count: 2,
      prophecy_count: 0,
      total_points: 0
    });
  }

  displayAchievements(achievements, stats) {
    // 安全检查：确保参数存在
    if (!achievements || !Array.isArray(achievements)) {
      console.warn('成就数据不完整，使用模拟数据');
      this.displayMockAchievements();
      return;
    }
    
    // 确保stats是一个有效的对象，并提供默认值
    if (!stats || typeof stats !== 'object') {
      console.warn('统计数据不完整，使用默认值');
      stats = {
        consecutive_days: 0,
        unlock_count: 0,
        fragment_count: 0,
        prophecy_count: 0,
        total_points: 0
      };
    } else {
      // 确保所有必需的统计字段都存在
      stats = {
        consecutive_days: stats.consecutive_days || 0,
        unlock_count: stats.unlock_count || 0,
        fragment_count: stats.fragment_count || 0,
        prophecy_count: stats.prophecy_count || 0,
        total_points: stats.total_points || 0
      };
    }
    
    // 更新成就显示
    achievements.forEach(achievement => {
      const el = document.getElementById(`achievement-${achievement.type}`);
      if (el) {
        if (achievement.unlocked) {
          el.classList.add('unlocked');
          el.querySelector('.progress').textContent = '✅ 已解锁';
        } else {
          el.classList.remove('unlocked');
          // 显示进度
          let progressText = '';
          let target = 0;
          
          switch (achievement.type) {
            case 'traveler':
              target = 7;
              progressText = `${achievement.progress}/${target} 天`;
              break;
            case 'explorer':
              target = 5;
              progressText = `${achievement.progress}/${target} 个`;
              break;
            case 'prophet':
              target = 3;
              progressText = `${achievement.progress}/${target} 次`;
              break;
            case 'collector':
              target = 10;
              progressText = `${achievement.progress}/${target} 个`;
              break;
            case 'emotion-master':
              target = 9;
              progressText = `${achievement.progress}/${target} 种`;
              break;
            case 'social-butterfly':
              target = 20;
              progressText = `${achievement.progress}/${target} 个`;
              break;
          }
          
          el.querySelector('.progress').textContent = progressText;
        }
      }
    });
    
    // 更新统计信息
    this.updateStatsDisplay(stats);
  }

  updateStatsDisplay(stats) {
    // 安全检查：确保stats参数存在
    if (!stats || typeof stats !== 'object') {
      console.warn('统计数据不完整，使用默认值');
      stats = {
        consecutive_days: 0,
        unlock_count: 0,
        fragment_count: 0,
        prophecy_count: 0
      };
    }
    
    // 更新页面上的统计信息显示
    const statsElements = {
      'consecutive-days': stats.consecutive_days || 0,
      'unlock-count': stats.unlock_count || 0,
      'fragment-count': stats.fragment_count || 0,
      'prophecy-count': stats.prophecy_count || 0
    };
    
    Object.entries(statsElements).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = value;
      }
    });
  }

  async loadStats() {
    try {
      const response = await this.apiClient.getStats();
      
      if (response.success) {
        this.displayStats(response.user_stats, response.global_stats);
        
        // 检查WebSocket状态
        if (response.websocket_available !== undefined) {
          this.websocketAvailable = response.websocket_available;
        }
      } else {
        throw new Error(response.message || '获取统计信息失败');
      }
    } catch (error) {
      console.error('获取统计信息失败:', error);
      this.showNotification(`获取统计信息失败: ${error.message}`, 'error');
    }
  }

  displayStats(userStats, globalStats) {
    // 更新用户统计信息
    const userStatsElements = {
      'user-total-capsules': userStats.total_capsules,
      'user-public-capsules': userStats.public_capsules,
      'user-unlocked-by-others': userStats.unlocked_by_others,
      'user-total-fragments': userStats.total_fragments,
      'user-achievements-count': userStats.achievements_count
    };
    
    Object.entries(userStatsElements).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = value || 0;
      }
    });
    
    // 更新全局统计信息
    const globalStatsElements = {
      'global-total-capsules': globalStats.total_capsules,
      'global-total-unlocks': globalStats.total_unlocks,
      'global-total-fragments': globalStats.total_fragments,
      'global-active-users-today': globalStats.active_users_today
    };
    
    Object.entries(globalStatsElements).forEach(([id, value]) => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = value || 0;
      }
    });
  }

  updateConnectionStatus(status = 'checking') {
    const statusEl = document.getElementById('websocket-status');
    if (!statusEl) return;
    
    const statusTextEl = statusEl.querySelector('.status-text');
    
    switch (status) {
      case 'connected':
        statusEl.className = 'status-indicator connected';
        statusTextEl.textContent = '实时连接';
        break;
      case 'disconnected':
        statusEl.className = 'status-indicator disconnected';
        statusTextEl.textContent = '轮询模式';
        break;
      case 'error':
        statusEl.className = 'status-indicator error';
        statusTextEl.textContent = '连接错误';
        break;
      default:
        statusEl.className = 'status-indicator';
        statusTextEl.textContent = '连接中...';
    }
  }

  getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  }

  showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
  }

  loadUserData() {
    const savedCapsules = localStorage.getItem('timeCapsules');
    if (savedCapsules) {
      this.capsules = JSON.parse(savedCapsules);
    }
  }

  // 地图相关方法
  openMap() {
    const placeholder = document.getElementById('map-placeholder');
    const content = document.getElementById('map-content');
    
    if (placeholder && content) {
      placeholder.style.display = 'none';
      content.style.display = 'flex';
      this.renderMap();
    }
  }

  closeMap() {
    const placeholder = document.getElementById('map-placeholder');
    const content = document.getElementById('map-content');
    
    if (placeholder && content) {
      placeholder.style.display = 'block';
      content.style.display = 'none';
    }
  }

  async renderMap() {
    const mapArea = document.getElementById('map-area');
    if (!mapArea) return;

    // 显示加载状态
    mapArea.innerHTML = '<div class="map-loading"><i class="fas fa-spinner fa-spin"></i><p>正在加载地图...</p></div>';

    // 创建网格地图
    const grid = document.createElement('div');
    grid.className = 'map-grid';
    
    // 创建10x10的网格
    for (let i = 0; i < 100; i++) {
      const cell = document.createElement('div');
      cell.className = 'map-cell';
      cell.dataset.index = i;
      
      // 添加点击事件
      cell.addEventListener('click', () => this.handleMapCellClick(i));
      
      grid.appendChild(cell);
    }
    
    mapArea.innerHTML = '';
    mapArea.appendChild(grid);
    
    // 渲染用户位置和胶囊
    await this.renderMapElements();
  }

  async renderMapElements() {
    // 渲染用户位置（中心位置）
    const centerIndex = 45; // 5x5的位置
    const centerCell = document.querySelector(`[data-index="${centerIndex}"]`);
    if (centerCell) {
      centerCell.classList.add('user-location');
      centerCell.textContent = '我';
      centerCell.title = '我的位置';
    }

    // 渲染附近的胶囊
    await this.renderNearbyCapsules();
  }

  async renderNearbyCapsules() {
    try {
      // 获取用户当前位置
      if (!this.currentLocation) {
        await this.getCurrentLocation();
      }
      
      if (!this.currentLocation) {
        this.showNotification('无法获取位置信息，请允许位置权限', 'warning');
        // 使用默认位置（北京）
        this.currentLocation = { lat: 39.9042, lng: 116.4074 };
        this.showNotification('使用默认位置进行演示', 'info');
      }
      
      // 从后端API获取附近的胶囊（暂时使用模拟数据）
      const response = await fetch(`/tools/api/get-capsules/`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': this.getCsrfToken(),
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          this.displayNearbyCapsules(data.capsules);
          this.showNotification(`发现 ${data.total || 0} 个附近胶囊`, 'success');
        } else {
          this.showNotification('获取附近胶囊失败: ' + data.message, 'error');
          this.displaySimulatedCapsules();
        }
      } else {
        this.showNotification('网络请求失败，显示演示数据', 'warning');
        this.displaySimulatedCapsules();
      }
    } catch (error) {
      console.error('获取附近胶囊失败:', error);
      this.showNotification('获取附近胶囊失败，显示演示数据', 'warning');
      // 如果API失败，显示模拟数据
      this.displaySimulatedCapsules();
    }
  }

  displayNearbyCapsules(capsules) {
    if (!capsules || capsules.length === 0) {
      this.showNotification('附近没有发现时光胶囊，显示演示数据', 'info');
      this.displaySimulatedCapsules();
      return;
    }

    // 将胶囊映射到地图网格上
    capsules.forEach((capsule, i) => {
      // 安全检查：确保distance属性存在且为字符串
      if (!capsule.distance || typeof capsule.distance !== 'string') {
        console.warn('胶囊数据缺少distance属性:', capsule);
        return;
      }
      
      // 根据距离计算地图位置（简化算法）
      const distance = parseInt(capsule.distance.replace('m', ''));
      const maxDistance = 200; // 最大显示距离
      const gridSize = 10; // 网格大小
      
      // 计算相对位置（简化）
      const relativeDistance = Math.min(distance / maxDistance, 1);
      const angle = (i * 72) % 360; // 均匀分布角度
      const radius = Math.floor(relativeDistance * 4); // 最大半径4格
      
      const centerX = 5;
      const centerY = 5;
      const x = centerX + Math.floor(radius * Math.cos(angle * Math.PI / 180));
      const y = centerY + Math.floor(radius * Math.sin(angle * Math.PI / 180));
      
      const index = Math.max(0, Math.min(99, y * gridSize + x));
      
      const cell = document.querySelector(`[data-index="${index}"]`);
      if (cell && !cell.classList.contains('user-location')) {
        cell.classList.add('has-capsule');
        
        if (distance <= 200) {
          cell.classList.add('unlockable');
          cell.textContent = '🔓';
        } else {
          cell.textContent = '🔒';
        }
        
        cell.title = `时光胶囊 - ${capsule.distance} - ${capsule.author}`;
        
        // 添加点击事件
        cell.addEventListener('click', () => this.handleCapsuleClick(capsule));
      }
    });
  }

  displaySimulatedCapsules() {
    // 模拟附近的胶囊位置（当API失败时使用）
    const capsulePositions = [
      { 
        id: 'demo_1',
        index: 43, 
        distance: '50m', 
        unlockable: true, 
        author: '健身达人',
        title: '我的健身日记',
        content: '今天完成了100个俯卧撑，感觉超棒！💪'
      },
      { 
        id: 'demo_2',
        index: 47, 
        distance: '120m', 
        unlockable: true, 
        author: '音乐爱好者',
        title: '吉他练习记录',
        content: '学会了新的和弦进行，音乐真的能治愈心灵 🎸'
      },
      { 
        id: 'demo_3',
        index: 53, 
        distance: '180m', 
        unlockable: true, 
        author: '程序员小王',
        title: '代码突破',
        content: '终于解决了那个困扰我一周的bug，成就感满满！💻'
      },
      { 
        id: 'demo_4',
        index: 37, 
        distance: '90m', 
        unlockable: true, 
        author: '旅行者',
        title: '旅行回忆',
        content: '在美丽的山间小路上漫步，感受大自然的宁静 🌲'
      },
      { 
        id: 'demo_5',
        index: 55, 
        distance: '250m', 
        unlockable: false, 
        author: '神秘用户',
        title: '未来计划',
        content: '距离太远，暂时无法解锁...'
      }
    ];

    capsulePositions.forEach((capsule, i) => {
      const cell = document.querySelector(`[data-index="${capsule.index}"]`);
      if (cell && !cell.classList.contains('user-location')) {
        cell.classList.add('has-capsule');
        if (capsule.unlockable) {
          cell.classList.add('unlockable');
          cell.textContent = '🔓';
        } else {
          cell.textContent = '🔒';
        }
        cell.title = `时光胶囊 ${i + 1} - ${capsule.distance} - ${capsule.author}`;
        
        // 添加点击事件
        cell.addEventListener('click', () => this.handleCapsuleClick(capsule));
      }
    });
  }

  handleMapCellClick(index) {
    const cell = document.querySelector(`[data-index="${index}"]`);
    if (cell && !cell.classList.contains('user-location') && !cell.classList.contains('has-capsule')) {
      this.showNotification(`位置 ${index}: 这里还没有时光胶囊`, 'info');
    }
  }

  handleDemoCapsuleClick(capsule) {
    const distance = parseInt(capsule.distance.replace('m', ''));
    
    if (distance <= 200) {
      // 演示胶囊解锁
      this.showNotification(`🎉 解锁演示时光胶囊！`, 'success');
      
      // 显示胶囊内容
      const content = `
        <div class="capsule-content">
          <h3>${capsule.title}</h3>
          <p class="author">作者: ${capsule.author}</p>
          <p class="distance">距离: ${capsule.distance}</p>
          <div class="content-text">${capsule.content}</div>
          <div class="demo-notice">
            <small>💡 这是演示数据，实际功能需要真实的时光胶囊</small>
          </div>
        </div>
      `;
      
      // 创建模态框显示内容
      this.showCapsuleModal('时光胶囊内容', content);
      
      // 更新成就（演示）
      this.updateAchievements();
      
      // 标记胶囊为已解锁
      const cell = document.querySelector(`[data-index="${capsule.index}"]`);
      if (cell) {
        cell.classList.remove('unlockable');
        cell.classList.add('unlocked');
        cell.textContent = '✨';
        cell.title = `${capsule.title} - 已解锁`;
      }
    } else {
      this.showNotification(`距离太远 (${capsule.distance})，无法解锁`, 'warning');
    }
  }

  showCapsuleModal(title, content) {
    // 创建模态框
    const modal = document.createElement('div');
    modal.className = 'capsule-modal';
    modal.innerHTML = `
      <div class="capsule-modal-content">
        <div class="capsule-modal-header">
          <h3>${title}</h3>
          <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
        </div>
        <div class="capsule-modal-body">
          ${content}
        </div>
      </div>
    `;
    
    // 添加样式
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;
    
    const modalContent = modal.querySelector('.capsule-modal-content');
    modalContent.style.cssText = `
      background: white;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    `;
    
    const modalHeader = modal.querySelector('.capsule-modal-header');
    modalHeader.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    `;
    
    const modalBody = modal.querySelector('.capsule-modal-body');
    modalBody.style.cssText = `
      padding: 20px;
    `;
    
    const closeBtn = modal.querySelector('.close-btn');
    closeBtn.style.cssText = `
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    `;
    
    // 添加到页面
    document.body.appendChild(modal);
    
    // 点击背景关闭
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  async handleCapsuleClick(capsule) {
    // 检查是否为演示数据
    if (capsule.id && capsule.id.startsWith('demo_')) {
      this.handleDemoCapsuleClick(capsule);
      return;
    }
    
    // 安全检查：确保distance属性存在
    if (!capsule.distance || typeof capsule.distance !== 'string') {
      this.showNotification('胶囊数据不完整，无法解锁', 'error');
      return;
    }
    
    const distance = parseInt(capsule.distance.replace('m', ''));
    
    if (distance <= 200) {
      // 可以解锁的胶囊
      this.showNotification(`发现时光胶囊！距离${capsule.distance}，正在尝试解锁...`, 'info');
      
      try {
        // 调用解锁API
        const response = await fetch(`/tools/api/unlock-capsule/${capsule.id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': this.getCsrfToken(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            location: this.currentLocation
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            this.showNotification('胶囊解锁成功！获得记忆碎片', 'success');
            // 更新成就
            this.updateAchievements();
            // 刷新地图
            this.refreshMap();
          } else {
            this.showNotification('解锁失败: ' + data.message, 'error');
          }
        } else {
          this.showNotification('解锁请求失败', 'error');
        }
      } catch (error) {
        console.error('解锁胶囊失败:', error);
        this.showNotification('解锁失败，请稍后重试', 'error');
      }
    } else {
      // 距离太远的胶囊
      this.showNotification(`时光胶囊距离${capsule.distance}，需要走近一些才能解锁`, 'warning');
    }
  }

  async refreshMap() {
    this.showNotification('正在刷新地图...', 'info');
    try {
      await this.renderMap();
      this.showNotification('地图已刷新', 'success');
    } catch (error) {
      console.error('刷新地图失败:', error);
      this.showNotification('刷新地图失败', 'error');
    }
  }
}

// 全局函数
window.uploadImage = function() {
  document.getElementById('image-upload').click();
};

window.uploadAudio = function() {
  document.getElementById('audio-upload').click();
};

window.getLocation = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.getCurrentLocation();
  } else {
    console.error('timeCapsuleDiary not initialized');
  }
};

window.getCurrentLocation = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.getCurrentLocation();
  } else {
    console.error('timeCapsuleDiary not initialized');
  }
};

window.clearContent = function() {
  if (confirm('确定要清空所有内容吗？')) {
    document.getElementById('diary-content').value = '';
    updateCharCount();
    if (window.timeCapsuleDiary) {
      timeCapsuleDiary.showNotification('内容已清空', 'info');
    }
  }
};

window.autoSave = function() {
  const content = document.getElementById('diary-content').value;
  if (content.trim()) {
    localStorage.setItem('timeCapsuleDraft', content);
    if (window.timeCapsuleDiary) {
      timeCapsuleDiary.showNotification('草稿已自动保存', 'success');
    }
  }
};

window.handleImageUpload = function(event) {
  const file = event.target.files[0];
  if (file) {
    const btn = document.getElementById('image-upload-btn');
    btn.classList.add('uploading');
    btn.querySelector('span').textContent = '上传中...';
    
    // 模拟上传过程
    setTimeout(() => {
      btn.classList.remove('uploading');
      btn.classList.add('success');
      btn.querySelector('span').textContent = '图片已上传';
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.showNotification(`图片上传成功: ${file.name}`, 'success');
      }
      
      // 3秒后恢复原状态
      setTimeout(() => {
        btn.classList.remove('success');
        btn.querySelector('span').textContent = '图片';
      }, 3000);
    }, 2000);
  }
};

window.handleAudioUpload = function(event) {
  const file = event.target.files[0];
  if (file) {
    const btn = document.getElementById('audio-upload-btn');
    btn.classList.add('uploading');
    btn.querySelector('span').textContent = '上传中...';
    
    // 模拟上传过程
    setTimeout(() => {
      btn.classList.remove('uploading');
      btn.classList.add('success');
      btn.querySelector('span').textContent = '音频已上传';
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.showNotification(`音频上传成功: ${file.name}`, 'success');
      }
      
      // 3秒后恢复原状态
      setTimeout(() => {
        btn.classList.remove('success');
        btn.querySelector('span').textContent = '音频';
      }, 3000);
    }, 2000);
  }
};

window.updateCharCount = function() {
  const content = document.getElementById('diary-content').value;
  const charCount = document.querySelector('.char-count');
  charCount.textContent = `${content.length}/5000`;
  
  // 根据字符数改变颜色
  if (content.length > 4500) {
    charCount.style.color = '#ef4444';
  } else if (content.length > 4000) {
    charCount.style.color = '#f59e0b';
  } else {
    charCount.style.color = '#6b7280';
  }
};

window.saveCapsule = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.saveCapsule();
  } else {
    console.warn('timeCapsuleDiary not initialized, retrying in 1 second...');
    setTimeout(() => {
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.saveCapsule();
      } else {
        console.error('timeCapsuleDiary still not initialized');
        alert('系统正在初始化，请稍后再试');
      }
    }, 1000);
  }
};

window.previewCapsule = function() {
  const content = document.getElementById('diary-content').value;
  if (!content) {
    if (window.timeCapsuleDiary) {
      timeCapsuleDiary.showNotification('请先写下内容', 'warning');
    }
    return;
  }
  
  // 显示预览模态框
  const modal = document.getElementById('capsule-preview-modal');
  const previewContent = document.getElementById('preview-content');
  
  const emotions = window.timeCapsuleDiary ? timeCapsuleDiary.selectedEmotions : [];
  
  previewContent.innerHTML = `
    <div class="preview-capsule">
      <h4>胶囊预览</h4>
      <p>${content}</p>
      <div class="preview-emotions">
        情绪: ${emotions.join(', ')}
      </div>
    </div>
  `;
  
  modal.style.display = 'block';
};

window.closePreview = function() {
  document.getElementById('capsule-preview-modal').style.display = 'none';
};

window.refreshCapsules = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.loadNearbyCapsules();
  } else {
    console.warn('timeCapsuleDiary not initialized, retrying in 1 second...');
    setTimeout(() => {
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.loadNearbyCapsules();
      } else {
        console.error('timeCapsuleDiary still not initialized');
        alert('系统正在初始化，请稍后再试');
      }
    }, 1000);
  }
};

window.openMap = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.openMap();
  } else {
    console.warn('timeCapsuleDiary not initialized, retrying in 1 second...');
    setTimeout(() => {
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.openMap();
      } else {
        console.error('timeCapsuleDiary still not initialized');
        alert('系统正在初始化，请稍后再试');
      }
    }, 1000);
  }
};

window.closeMap = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.closeMap();
  } else {
    console.warn('timeCapsuleDiary not initialized, retrying in 1 second...');
    setTimeout(() => {
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.closeMap();
      } else {
        console.error('timeCapsuleDiary still not initialized');
        alert('系统正在初始化，请稍后再试');
      }
    }, 1000);
  }
};

window.showHistoryCapsules = function() {
  // 创建历史胶囊模态框
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.id = 'history-capsules-modal';
  modal.style.display = 'block';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>我的历史胶囊</h3>
        <button class="close-btn" onclick="closeHistoryCapsules()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="history-capsules-list">
          <div class="loading">正在加载历史胶囊...</div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // 加载历史胶囊数据
  loadHistoryCapsules();
};

window.closeHistoryCapsules = function() {
  const modal = document.getElementById('history-capsules-modal');
  if (modal) {
    modal.remove();
  }
};

window.loadHistoryCapsules = function() {
  const listContainer = document.getElementById('history-capsules-list');
  if (!listContainer) return;
  
  // 模拟历史胶囊数据
  const historyCapsules = [
    {
      id: 1,
      title: '美好的一天',
      content: '今天和朋友一起去了公园，天气很好，心情愉快...',
      emotions: ['happy', 'grateful'],
      created_at: '2024-01-15 14:30',
      unlock_time: '2024-02-15 14:30',
      status: 'locked'
    },
    {
      id: 2,
      title: '工作感悟',
      content: '今天完成了一个重要的项目，虽然很累但很有成就感...',
      emotions: ['excited', 'inspired'],
      created_at: '2024-01-14 18:20',
      unlock_time: '2024-01-21 18:20',
      status: 'unlocked'
    },
    {
      id: 3,
      title: '深夜思考',
      content: '夜深人静的时候，总是会想起很多往事...',
      emotions: ['calm', 'inspired'],
      created_at: '2024-01-13 23:45',
      unlock_time: '2024-01-20 23:45',
      status: 'unlocked'
    }
  ];
  
  // 渲染历史胶囊列表
  listContainer.innerHTML = historyCapsules.map(capsule => `
    <div class="history-capsule-item" style="
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    ">
      <div class="capsule-header" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      ">
        <h4 style="
          font-size: 18px;
          font-weight: 600;
          color: #1f2937;
          margin: 0;
        ">${capsule.title}</h4>
        <span class="status-badge" style="
          padding: 4px 8px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 500;
          ${capsule.status === 'unlocked' ? 
            'background: #d1fae5; color: #065f46;' : 
            'background: #fef3c7; color: #92400e;'
          }
        ">
          ${capsule.status === 'unlocked' ? '已解锁' : '锁定中'}
        </span>
      </div>
      <div class="capsule-content" style="
        color: #4b5563;
        line-height: 1.6;
        margin-bottom: 10px;
        font-size: 16px;
      ">
        ${capsule.content.length > 100 ? 
          capsule.content.substring(0, 100) + '...' : 
          capsule.content
        }
      </div>
      <div class="capsule-meta" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: #6b7280;
      ">
        <div class="emotions">
          情绪: ${capsule.emotions.map(emo => {
            const emotionMap = {
              'happy': '😊', 'excited': '💡', 'calm': '😌',
              'sad': '😢', 'angry': '😠', 'surprised': '😲',
              'anxious': '😰', 'grateful': '🙏', 'inspired': '✨'
            };
            return emotionMap[emo] || emo;
          }).join(' ')}
        </div>
        <div class="dates">
          创建: ${capsule.created_at} | 解锁: ${capsule.unlock_time}
        </div>
      </div>
      <div class="capsule-actions" style="
        margin-top: 15px;
        display: flex;
        gap: 10px;
      ">
        <button class="btn btn-sm btn-primary" onclick="viewCapsuleDetail(${capsule.id})" style="
          padding: 8px 16px;
          background: #3b82f6;
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
        ">
          查看详情
        </button>
        ${capsule.status === 'locked' ? `
          <button class="btn btn-sm btn-secondary" onclick="unlockCapsule(${capsule.id})" style="
            padding: 8px 16px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
          ">
            解锁胶囊
          </button>
        ` : ''}
      </div>
    </div>
  `).join('');
};

window.viewCapsuleDetail = function(capsuleId) {
  alert(`查看胶囊详情: ${capsuleId}`);
  // 这里可以添加查看详情的逻辑
};

window.unlockCapsule = function(capsuleId) {
  if (confirm('确定要解锁这个胶囊吗？')) {
    alert(`解锁胶囊: ${capsuleId}`);
    // 这里可以添加解锁胶囊的逻辑
    loadHistoryCapsules(); // 重新加载列表
  }
};

window.refreshMap = function() {
  if (window.timeCapsuleDiary) {
    timeCapsuleDiary.refreshMap();
  } else {
    console.warn('timeCapsuleDiary not initialized, retrying in 1 second...');
    setTimeout(() => {
      if (window.timeCapsuleDiary) {
        timeCapsuleDiary.refreshMap();
      } else {
        console.error('timeCapsuleDiary still not initialized');
        alert('系统正在初始化，请稍后再试');
      }
    }, 1000);
  }
};

// 初始化应用
let timeCapsuleDiary;

// 等待页面完全加载后再初始化
function initializeTimeCapsuleDiary() {
  try {
    timeCapsuleDiary = new TimeCapsuleDiary();
    window.timeCapsuleDiary = timeCapsuleDiary; // 确保全局可访问
    
    // 页面加载时恢复草稿
    const draft = localStorage.getItem('timeCapsuleDraft');
    if (draft) {
      const diaryContent = document.getElementById('diary-content');
      if (diaryContent) {
        diaryContent.value = draft;
        updateCharCount();
        if (timeCapsuleDiary) {
          timeCapsuleDiary.showNotification('已恢复上次的草稿', 'info');
        }
      }
    }
    
    console.log('✅ timeCapsuleDiary 初始化完成');
  } catch (error) {
    console.error('❌ timeCapsuleDiary 初始化失败:', error);
  }
}

// 使用多种方式确保初始化
document.addEventListener('DOMContentLoaded', function() {
  // 延迟一点初始化，确保DOM完全准备好
  setTimeout(initializeTimeCapsuleDiary, 100);
});

// 如果DOMContentLoaded已经触发，立即初始化
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeTimeCapsuleDiary);
} else {
  // DOM已经加载完成，立即初始化
  setTimeout(initializeTimeCapsuleDiary, 100);
}

// 文件上传处理
document.addEventListener('DOMContentLoaded', function() {
  const imageUpload = document.getElementById('image-upload');
  if (imageUpload) {
    imageUpload.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && window.timeCapsuleDiary) {
        timeCapsuleDiary.showNotification(`图片上传成功: ${file.name}`, 'success');
      }
    });
  }
  
  const audioUpload = document.getElementById('audio-upload');
  if (audioUpload) {
    audioUpload.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && window.timeCapsuleDiary) {
        timeCapsuleDiary.showNotification(`音频上传成功: ${file.name}`, 'success');
      }
    });
  }
  
  // 字符计数和自动保存
  const diaryContent = document.getElementById('diary-content');
  if (diaryContent) {
    diaryContent.addEventListener('input', function(e) {
      updateCharCount();
      
      // 自动保存草稿（防抖）
      clearTimeout(window.autoSaveTimer);
      window.autoSaveTimer = setTimeout(() => {
        if (e.target.value.trim()) {
          localStorage.setItem('timeCapsuleDraft', e.target.value);
        }
      }, 1000);
    });
  }
});

// 添加getCookie函数
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
