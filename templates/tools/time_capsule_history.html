{% extends 'base.html' %}
{% load static %}

{% block tool_title_inner %}æ—¶å…‰èƒ¶å›Šå†å²{% endblock %}
{% block tool_title_display %}æ—¶å…‰èƒ¶å›Šå†å²{% endblock %}

{% block extra_css %}
<style>
:root {
  --primary-color: #6366f1;
  --secondary-color: #8b5cf6;
  --accent-color: #f59e0b;
  --success-color: #10b981;
  --warning-color: #f97316;
  --error-color: #ef4444;
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --bg-primary: #ffffff;
  --bg-secondary: #f9fafb;
  --bg-accent: #f3f4f6;
  --border-color: #e5e7eb;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
  --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  color: var(--text-primary);
}

.history-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* å¤´éƒ¨åŒºåŸŸ */
.history-header {
  text-align: center;
  margin-bottom: 40px;
  color: white;
}

.history-header h1 {
  font-size: 3rem;
  font-weight: 800;
  margin-bottom: 10px;
  color: #ffffff;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  background: linear-gradient(45deg, #ffffff, #f8f9fa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.history-header .subtitle {
  font-size: 1.2rem;
  color: #ffffff;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
  font-style: italic;
  font-weight: 500;
}

/* ç»Ÿè®¡å¡ç‰‡ */
.stats-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: var(--bg-primary);
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow-lg);
  text-align: center;
  transition: transform 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
}

.stat-number {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--primary-color);
  margin-bottom: 8px;
}

.stat-label {
  font-size: 1rem;
  color: var(--text-secondary);
  font-weight: 500;
}

/* åª’ä½“å†…å®¹é¢„è§ˆæ ·å¼ */
.capsule-media-preview {
  margin: 15px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}

.media-images {
  display: flex;
  gap: 8px;
  align-items: center;
}

.media-item {
  position: relative;
  width: 60px;
  height: 60px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid var(--border-color);
}

.media-thumbnail {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.media-thumbnail:hover {
  transform: scale(1.1);
}

.media-more {
  width: 60px;
  height: 60px;
  background: var(--bg-accent);
  border: 2px dashed var(--border-color);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 600;
}

.media-audio,
.media-location {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: var(--bg-accent);
  border-radius: 20px;
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 500;
}

.media-audio i {
  color: #e74c3c;
}

.media-location i {
  color: #3498db;
}

/* è¯¦æƒ…æ¨¡æ€æ¡†æ ·å¼ */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background-color: var(--bg-primary);
  margin: 5%;
  padding: 0;
  border-radius: 16px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-xl);
}

.modal-header {
  padding: 20px 30px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  color: var(--text-primary);
  font-size: 1.5rem;
  font-weight: 600;
}

.close {
  color: var(--text-secondary);
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s ease;
}

.close:hover {
  color: var(--text-primary);
}

.modal-body {
  padding: 30px;
}

.capsule-detail {
  color: var(--text-primary);
}

.detail-date {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 15px;
}

.detail-content {
  font-size: 1.1rem;
  line-height: 1.6;
  margin-bottom: 20px;
  white-space: pre-wrap;
}

.detail-emotions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
}

.detail-media-section {
  margin-bottom: 25px;
  padding: 20px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border: 1px solid var(--border-color);
}

.detail-media-section h4 {
  margin: 0 0 15px 0;
  color: var(--text-primary);
  font-size: 1.1rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.detail-images {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 15px;
}

.detail-image-item {
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid var(--border-color);
  cursor: pointer;
  transition: transform 0.3s ease;
}

.detail-image-item:hover {
  transform: scale(1.05);
}

.detail-image-item img {
  width: 100%;
  height: 150px;
  object-fit: cover;
}

.detail-audio {
  display: flex;
  justify-content: center;
}

.detail-audio audio {
  width: 100%;
  max-width: 400px;
}

.detail-location,
.detail-weather {
  color: var(--text-secondary);
}

.detail-location p,
.detail-weather p {
  margin: 8px 0;
  font-size: 0.95rem;
}

.detail-meta {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border-color);
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.detail-meta div {
  margin: 5px 0;
}

/* å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†æ ·å¼ */
.image-modal-content {
  max-width: 90vw;
  max-height: 90vh;
  width: auto;
  height: auto;
}

.image-modal-content .modal-body {
  padding: 20px;
  text-align: center;
}

.image-modal-content img {
  border-radius: 8px;
  box-shadow: var(--shadow-lg);
}

/* èƒ¶å›Šåˆ—è¡¨ */
.capsules-section {
  background: var(--bg-primary);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow-xl);
  margin-bottom: 30px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
}

.capsule-filters {
  display: flex;
  gap: 12px;
}

.filter-btn {
  padding: 8px 16px;
  border: 2px solid var(--border-color);
  border-radius: 20px;
  background: var(--bg-primary);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.filter-btn.active {
  border-color: var(--primary-color);
  background: var(--primary-color);
  color: white;
}

.capsule-list {
  display: grid;
  gap: 20px;
}

.capsule-item {
  border: 2px solid var(--border-color);
  border-radius: 16px;
  padding: 24px;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.capsule-item:hover {
  border-color: var(--primary-color);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.capsule-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
}

.capsule-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
}

.capsule-date {
  font-size: 0.9rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.capsule-status {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
}

.capsule-status.locked {
  background: var(--warning-color);
  color: white;
}

.capsule-status.unlocked {
  background: var(--success-color);
  color: white;
}

.capsule-content {
  font-size: 1rem;
  line-height: 1.6;
  color: var(--text-primary);
  margin-bottom: 16px;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.capsule-emotions {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.emotion-tag {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 500;
  background: var(--bg-accent);
  color: var(--text-secondary);
}

.capsule-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.unlock-time {
  display: flex;
  align-items: center;
  gap: 6px;
}

.unlock-time i {
  font-size: 0.8rem;
}

/* æˆå°±åŒºåŸŸ */
.achievements-section {
  background: var(--bg-primary);
  border-radius: 20px;
  padding: 30px;
  box-shadow: var(--shadow-xl);
}

.achievement-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.achievement-item {
  text-align: center;
  padding: 20px;
  border: 2px solid var(--border-color);
  border-radius: 16px;
  transition: all 0.3s ease;
}

.achievement-item:hover {
  border-color: var(--accent-color);
  transform: translateY(-2px);
}

.achievement-icon {
  font-size: 2.5rem;
  margin-bottom: 12px;
}

.achievement-name {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.achievement-date {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state i {
  font-size: 4rem;
  margin-bottom: 20px;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 1.5rem;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.empty-state p {
  font-size: 1rem;
  margin-bottom: 24px;
}

.create-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.3s ease;
}

.create-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
  color: white;
  text-decoration: none;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .history-container {
    padding: 15px;
  }
  
  .history-header h1 {
    font-size: 2rem;
  }
  
  .stats-section {
    grid-template-columns: 1fr;
  }
  
  .section-header {
    flex-direction: column;
    gap: 16px;
    align-items: stretch;
  }
  
  .capsule-filters {
    justify-content: center;
  }
  
  .achievement-list {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="history-container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <div class="history-header">
    <h1>æ—¶å…‰èƒ¶å›Šå†å²</h1>
    <p class="subtitle">å›é¡¾ä½ çš„è®°å¿†ç¢ç‰‡ï¼Œé‡æ¸©ç¾å¥½æ—¶å…‰</p>
  </div>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <div class="stats-section">
    <div class="stat-card">
      <div class="stat-number">{{ total_capsules|default:0 }}</div>
      <div class="stat-label">æ€»èƒ¶å›Šæ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ achievements.count|default:0 }}</div>
      <div class="stat-label">è·å¾—æˆå°±</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ capsules.count|default:0 }}</div>
      <div class="stat-label">å·²è§£é”</div>
    </div>
  </div>

  <!-- èƒ¶å›Šåˆ—è¡¨ -->
  <div class="capsules-section">
    <div class="section-header">
      <h2 class="section-title">æˆ‘çš„èƒ¶å›Š</h2>
      <div class="capsule-filters">
        <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
        <button class="filter-btn" data-filter="locked">æœªè§£é”</button>
        <button class="filter-btn" data-filter="unlocked">å·²è§£é”</button>
      </div>
    </div>

    <div class="capsule-list" id="capsuleList">
      {% if capsules %}
        {% for capsule in capsules %}
        <div class="capsule-item" data-status="{% if capsule.is_unlocked %}unlocked{% else %}locked{% endif %}">
          <div class="capsule-header">
            <div class="capsule-date">{{ capsule.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</div>
            <div class="capsule-status {% if capsule.is_unlocked %}unlocked{% else %}locked{% endif %}">
              {% if capsule.is_unlocked %}å·²è§£é”{% else %}æœªè§£é”{% endif %}
            </div>
          </div>
          
          <div class="capsule-content">{{ capsule.content|truncatechars:150 }}</div>
          
          <!-- åª’ä½“å†…å®¹é¢„è§ˆ -->
          <div class="capsule-media-preview">
            {% if capsule.images %}
              <div class="media-images">
                {% for image in capsule.images|slice:":3" %}
                  <div class="media-item">
                    <img src="{{ image }}" alt="èƒ¶å›Šå›¾ç‰‡" class="media-thumbnail">
                  </div>
                {% endfor %}
                {% if capsule.images|length > 3 %}
                  <div class="media-more">
                    <span>+{{ capsule.images|length|add:"-3" }}</span>
                  </div>
                {% endif %}
              </div>
            {% endif %}
            
            {% if capsule.audio %}
              <div class="media-audio">
                <i class="fas fa-music"></i>
                <span>éŸ³é¢‘æ–‡ä»¶</span>
              </div>
            {% endif %}
            
            {% if capsule.location %}
              <div class="media-location">
                <i class="fas fa-map-marker-alt"></i>
                <span>ä½ç½®ä¿¡æ¯</span>
              </div>
            {% endif %}
          </div>
          
          <div class="capsule-emotions">
            {% for emotion in capsule.emotions %}
            <span class="emotion-tag">{{ emotion }}</span>
            {% endfor %}
          </div>
          
          <div class="capsule-meta">
            <div class="unlock-time">
              <i class="fas fa-clock"></i>
              <span>è§£é”æ—¶é—´: {{ capsule.unlock_time|date:"Yå¹´mæœˆdæ—¥ H:i"|default:"æœªè®¾ç½®" }}</span>
            </div>
            <div class="capsule-actions">
              {% if not capsule.is_unlocked %}
                <button class="unlock-btn" data-capsule-id="{{ capsule.id }}">è§£é”</button>
              {% else %}
                <button class="view-btn" data-capsule-id="{{ capsule.id }}">æŸ¥çœ‹</button>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="fas fa-box-open"></i>
          <h3>è¿˜æ²¡æœ‰æ—¶å…‰èƒ¶å›Š</h3>
          <p>å¼€å§‹è®°å½•ä½ çš„ç¬¬ä¸€ä¸ªæ—¶å…‰èƒ¶å›Šå§ï¼</p>
          <a href="{% url 'tools:time_capsule_diary' %}" class="create-btn">
            <i class="fas fa-plus"></i>
            åˆ›å»ºèƒ¶å›Š
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- æˆå°±åŒºåŸŸ -->
  <div class="achievements-section">
    <h2 class="section-title">æˆ‘çš„æˆå°±</h2>
    <div class="achievement-list">
      {% if achievements %}
        {% for achievement in achievements %}
        <div class="achievement-item">
          <div class="achievement-icon">
            {% if achievement.achievement_type == 'traveler' %}ğŸš€
            {% elif achievement.achievement_type == 'collector' %}ğŸ’
            {% elif achievement.achievement_type == 'explorer' %}ğŸ—ºï¸
            {% elif achievement.achievement_type == 'prophet' %}ğŸ”®
            {% else %}ğŸ†{% endif %}
          </div>
          <div class="achievement-name">{{ achievement.get_achievement_type_display }}</div>
          <div class="achievement-date">{{ achievement.unlocked_at|date:"Yå¹´mæœˆdæ—¥" }}</div>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="fas fa-trophy"></i>
          <h3>è¿˜æ²¡æœ‰è·å¾—æˆå°±</h3>
          <p>ç»§ç»­è®°å½•æ—¶å…‰èƒ¶å›Šï¼Œè§£é”æ›´å¤šæˆå°±ï¼</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- èƒ¶å›Šè¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="capsuleModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>èƒ¶å›Šè¯¦æƒ…</h3>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
    </div>
  </div>
</div>

<!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div id="imageModal" class="modal" style="display: none;">
  <div class="modal-content image-modal-content">
    <div class="modal-header">
      <h3>å›¾ç‰‡æŸ¥çœ‹</h3>
      <span class="close" onclick="closeImageModal()">&times;</span>
    </div>
    <div class="modal-body">
      <img id="fullImage" src="" alt="å®Œæ•´å›¾ç‰‡" style="width: 100%; height: auto; max-height: 70vh; object-fit: contain;">
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class TimeCapsuleHistory {
  constructor() {
    this.initEventListeners();
  }

  initEventListeners() {
    // è¿‡æ»¤å™¨äº‹ä»¶
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => this.filterCapsules(e.target.dataset.filter));
    });

    // èƒ¶å›Šæ“ä½œäº‹ä»¶
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('unlock-btn')) {
        this.unlockCapsule(e.target.dataset.capsuleId);
      } else if (e.target.classList.contains('view-btn')) {
        this.viewCapsule(e.target.dataset.capsuleId);
      }
    });

    // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
    const modal = document.getElementById('capsuleModal');
    const closeBtn = modal.querySelector('.close');
    closeBtn.addEventListener('click', () => this.closeModal());
    window.addEventListener('click', (e) => {
      if (e.target === modal) this.closeModal();
    });
  }

  filterCapsules(filter) {
    // æ›´æ–°è¿‡æ»¤å™¨æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // è¿‡æ»¤èƒ¶å›Š
    const capsules = document.querySelectorAll('.capsule-item');
    capsules.forEach(capsule => {
      const status = capsule.dataset.status;
      if (filter === 'all' || status === filter) {
        capsule.style.display = 'block';
      } else {
        capsule.style.display = 'none';
      }
    });
  }

  async unlockCapsule(capsuleId) {
    try {
      const response = await fetch(`/tools/api/unlock-capsule/${capsuleId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });

      const data = await response.json();
      
      if (data.success) {
        this.showNotification(data.message, 'success');
        // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°çŠ¶æ€
        setTimeout(() => location.reload(), 1500);
      } else {
        this.showNotification(data.message, 'error');
      }
    } catch (error) {
      this.showNotification('è§£é”å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
  }

  async viewCapsule(capsuleId) {
    try {
      const response = await fetch(`/tools/api/capsule-detail/${capsuleId}/`);
      const data = await response.json();
      
      if (data.success) {
        this.showCapsuleModal(data.capsule);
      } else {
        this.showNotification(data.message, 'error');
      }
    } catch (error) {
      this.showNotification('è·å–è¯¦æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
  }

  showCapsuleModal(capsule) {
    const modal = document.getElementById('capsuleModal');
    const modalBody = document.getElementById('modalBody');
    
    // æ„å»ºåª’ä½“å†…å®¹HTML
    let mediaHtml = '';
    
    // å›¾ç‰‡å†…å®¹
    if (capsule.images && capsule.images.length > 0) {
      mediaHtml += `
        <div class="detail-media-section">
          <h4><i class="fas fa-images"></i> å›¾ç‰‡</h4>
          <div class="detail-images">
            ${capsule.images.map(image => `
              <div class="detail-image-item">
                <img src="${image}" alt="èƒ¶å›Šå›¾ç‰‡" onclick="openImageModal('${image}')">
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    // éŸ³é¢‘å†…å®¹
    if (capsule.audio) {
      mediaHtml += `
        <div class="detail-media-section">
          <h4><i class="fas fa-music"></i> éŸ³é¢‘</h4>
          <div class="detail-audio">
            <audio controls>
              <source src="${capsule.audio}" type="audio/mpeg">
              æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
            </audio>
          </div>
        </div>
      `;
    }
    
    // ä½ç½®ä¿¡æ¯
    if (capsule.location && Object.keys(capsule.location).length > 0) {
      mediaHtml += `
        <div class="detail-media-section">
          <h4><i class="fas fa-map-marker-alt"></i> ä½ç½®ä¿¡æ¯</h4>
          <div class="detail-location">
            <p><strong>åœ°å€:</strong> ${capsule.location.address || 'æœªçŸ¥'}</p>
            <p><strong>åæ ‡:</strong> ${capsule.location.lat || 'æœªçŸ¥'}, ${capsule.location.lng || 'æœªçŸ¥'}</p>
          </div>
        </div>
      `;
    }
    
    // å¤©æ°”ä¿¡æ¯
    if (capsule.weather && Object.keys(capsule.weather).length > 0) {
      mediaHtml += `
        <div class="detail-media-section">
          <h4><i class="fas fa-cloud-sun"></i> å¤©æ°”ä¿¡æ¯</h4>
          <div class="detail-weather">
            <p><strong>æ¸©åº¦:</strong> ${capsule.weather.temperature || 'æœªçŸ¥'}Â°C</p>
            <p><strong>å¤©æ°”:</strong> ${capsule.weather.condition || 'æœªçŸ¥'}</p>
          </div>
        </div>
      `;
    }
    
    modalBody.innerHTML = `
      <div class="capsule-detail">
        <div class="detail-date">åˆ›å»ºæ—¶é—´: ${capsule.created_at}</div>
        <div class="detail-content">${capsule.content}</div>
        <div class="detail-emotions">
          ${capsule.emotions.map(emotion => `<span class="emotion-tag">${emotion}</span>`).join('')}
        </div>
        ${mediaHtml}
        <div class="detail-meta">
          <div>è§£é”æ¡ä»¶: ${capsule.unlock_condition}</div>
          <div>å¯è§æ€§: ${capsule.visibility}</div>
        </div>
      </div>
    `;
    
    modal.style.display = 'block';
  }

  closeModal() {
    document.getElementById('capsuleModal').style.display = 'none';
  }
}

// å…¨å±€å‡½æ•° - å›¾ç‰‡æŸ¥çœ‹
function openImageModal(imageSrc) {
  const imageModal = document.getElementById('imageModal');
  const fullImage = document.getElementById('fullImage');
  
  fullImage.src = imageSrc;
  imageModal.style.display = 'block';
  
  // ç‚¹å‡»èƒŒæ™¯å…³é—­
  imageModal.onclick = function(e) {
    if (e.target === imageModal) {
      closeImageModal();
    }
  };
}

function closeImageModal() {
  const imageModal = document.getElementById('imageModal');
  imageModal.style.display = 'none';
}

// å…¨å±€å‡½æ•°
function showNotification(message, type = 'info') {
  // åˆ›å»ºé€šçŸ¥å…ƒç´ 
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed; top: 20px; right: 20px; padding: 15px 20px; 
    border-radius: 8px; color: white; z-index: 10000; 
    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6366f1'};
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      document.body.removeChild(notification);
    }
  }, 3000);
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  new TimeCapsuleHistory();
});
</script>
{% endblock %}
