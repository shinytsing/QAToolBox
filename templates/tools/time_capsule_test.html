{% extends 'base.html' %}
{% load static %}

{% block title %}时光胶囊功能测试{% endblock %}

{% block extra_css %}
<style>
.test-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  font-family: 'Inter', sans-serif;
}

.test-section {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.test-section h2 {
  color: #374151;
  margin-bottom: 15px;
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: 10px;
}

.test-button {
  background: #6366f1;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  margin: 5px;
  font-size: 14px;
  transition: background 0.3s;
}

.test-button:hover {
  background: #5855eb;
}

.test-button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}

.test-result {
  background: #f3f4f6;
  border-radius: 8px;
  padding: 15px;
  margin-top: 10px;
  font-family: monospace;
  font-size: 12px;
  white-space: pre-wrap;
  max-height: 300px;
  overflow-y: auto;
}

.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 20px;
  background: #f3f4f6;
  font-size: 14px;
  margin: 5px;
}

.status-indicator.connected {
  background: #d1fae5;
  color: #065f46;
}

.status-indicator.disconnected {
  background: #fef3c7;
  color: #92400e;
}

.status-indicator.error {
  background: #fee2e2;
  color: #991b1b;
}

.loading {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #f3f4f6;
  border-top: 2px solid #6366f1;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="test-container">
  <h1>时光胶囊功能测试</h1>
  
  <!-- 连接状态测试 -->
  <div class="test-section">
    <h2>连接状态测试</h2>
    <div>
      <span id="websocket-status" class="status-indicator">
        <i class="fas fa-circle"></i>
        <span class="status-text">检查中...</span>
      </span>
    </div>
    <button class="test-button" onclick="testConnection()">测试连接</button>
    <div id="connection-result" class="test-result" style="display: none;"></div>
  </div>

  <!-- API测试 -->
  <div class="test-section">
    <h2>API功能测试</h2>
    <div>
      <button class="test-button" onclick="testCreateCapsule()">测试创建胶囊</button>
      <button class="test-button" onclick="testGetUserCapsules()">测试获取用户胶囊</button>
      <button class="test-button" onclick="testGetNearbyCapsules()">测试获取附近胶囊</button>
      <button class="test-button" onclick="testGetAchievements()">测试获取成就</button>
      <button class="test-button" onclick="testGetStats()">测试获取统计</button>
    </div>
    <div id="api-result" class="test-result" style="display: none;"></div>
  </div>

  <!-- 错误处理测试 -->
  <div class="test-section">
    <h2>错误处理测试</h2>
    <div>
      <button class="test-button" onclick="testTimeout()">测试超时处理</button>
      <button class="test-button" onclick="testInvalidData()">测试无效数据</button>
      <button class="test-button" onclick="testNetworkError()">测试网络错误</button>
    </div>
    <div id="error-result" class="test-result" style="display: none;"></div>
  </div>

  <!-- 性能测试 -->
  <div class="test-section">
    <h2>性能测试</h2>
    <div>
      <button class="test-button" onclick="testConcurrentRequests()">测试并发请求</button>
      <button class="test-button" onclick="testCachePerformance()">测试缓存性能</button>
    </div>
    <div id="performance-result" class="test-result" style="display: none;"></div>
  </div>
</div>

<script>
// 全局配置
window.TIME_CAPSULE_CONFIG = {
  websocket_available: {{ websocket_available|yesno:"true,false" }},
  api_timeout: {{ api_timeout|default:10000 }},
  retry_attempts: {{ retry_attempts|default:3 }},
  base_url: '{{ request.build_absolute_uri }}'
};

// API客户端类
class TestApiClient {
  constructor() {
    this.baseUrl = window.TIME_CAPSULE_CONFIG.base_url;
    this.timeout = window.TIME_CAPSULE_CONFIG.api_timeout;
    this.maxRetries = window.TIME_CAPSULE_CONFIG.retry_attempts;
  }

  async request(url, options = {}) {
    const config = {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': this.getCsrfToken(),
        ...options.headers
      },
      timeout: this.timeout,
      ...options
    };

    let lastError;
    
    for (let attempt = 1; attempt <= this.maxRetries; attempt++) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.timeout);
        
        const response = await fetch(url, {
          ...config,
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        return await response.json();
        
      } catch (error) {
        lastError = error;
        
        if (error.name === 'AbortError') {
          console.warn(`API请求超时 (尝试 ${attempt}/${this.maxRetries}): ${url}`);
        } else {
          console.error(`API请求失败 (尝试 ${attempt}/${this.maxRetries}): ${url}`, error);
        }
        
        if (attempt === this.maxRetries) {
          throw new Error(`请求失败，已重试${this.maxRetries}次: ${error.message}`);
        }
        
        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
      }
    }
    
    throw lastError;
  }

  getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  }

  async createCapsule(data) {
    return this.request('/tools/api/save-capsule/', {
      method: 'POST',
      body: JSON.stringify(data)
    });
  }

  async getUserCapsules() {
    return this.request('/tools/api/get-capsules/');
  }

  async getNearbyCapsules(lat = 39.9042, lng = 116.4074) {
    // 暂时返回模拟数据
    return Promise.resolve({
      success: true,
      capsules: [],
      total: 0,
      total_nearby: 0
    });
  }

  async getAchievements() {
    return this.request('/tools/api/get-achievements/');
  }

  async getStats() {
    // 暂时返回模拟数据
    return Promise.resolve({
      success: true,
      websocket_available: false,
      user_stats: {
        total_capsules: 0,
        public_capsules: 0,
        unlocked_by_others: 0,
        total_fragments: 0,
        achievements_count: 0
      },
      global_stats: {
        total_capsules: 0,
        total_unlocks: 0,
        total_fragments: 0,
        active_users_today: 0
      }
    });
  }
}

// 测试客户端实例
const testClient = new TestApiClient();

// 更新连接状态显示
function updateConnectionStatus(status) {
  const statusEl = document.getElementById('websocket-status');
  const statusTextEl = statusEl.querySelector('.status-text');
  
  switch (status) {
    case 'connected':
      statusEl.className = 'status-indicator connected';
      statusTextEl.textContent = '实时连接';
      break;
    case 'disconnected':
      statusEl.className = 'status-indicator disconnected';
      statusTextEl.textContent = '轮询模式';
      break;
    case 'error':
      statusEl.className = 'status-indicator error';
      statusTextEl.textContent = '连接错误';
      break;
    default:
      statusEl.className = 'status-indicator';
      statusTextEl.textContent = '检查中...';
  }
}

// 显示测试结果
function showResult(elementId, result) {
  const element = document.getElementById(elementId);
  element.style.display = 'block';
  element.textContent = JSON.stringify(result, null, 2);
}

// 测试连接
async function testConnection() {
  updateConnectionStatus('checking');
  
  try {
    const response = await testClient.getStats();
    if (response.websocket_available) {
      updateConnectionStatus('connected');
    } else {
      updateConnectionStatus('disconnected');
    }
    showResult('connection-result', { success: true, websocket_available: response.websocket_available });
  } catch (error) {
    updateConnectionStatus('error');
    showResult('connection-result', { success: false, error: error.message });
  }
}

// 测试创建胶囊
async function testCreateCapsule() {
  try {
    const testData = {
      title: '测试胶囊',
      content: '这是一个测试胶囊的内容',
      emotions: ['happy', 'excited'],
      capsule_type: 'memory',
      unlock_condition: 'time',
      visibility: 'private',
      keywords: ['测试', '功能']
    };
    
    const response = await testClient.createCapsule(testData);
    showResult('api-result', response);
  } catch (error) {
    showResult('api-result', { success: false, error: error.message });
  }
}

// 测试获取用户胶囊
async function testGetUserCapsules() {
  try {
    const response = await testClient.getUserCapsules();
    showResult('api-result', response);
  } catch (error) {
    showResult('api-result', { success: false, error: error.message });
  }
}

// 测试获取附近胶囊
async function testGetNearbyCapsules() {
  try {
    const response = await testClient.getNearbyCapsules();
    showResult('api-result', response);
  } catch (error) {
    showResult('api-result', { success: false, error: error.message });
  }
}

// 测试获取成就
async function testGetAchievements() {
  try {
    const response = await testClient.getAchievements();
    showResult('api-result', response);
  } catch (error) {
    showResult('api-result', { success: false, error: error.message });
  }
}

// 测试获取统计
async function testGetStats() {
  try {
    const response = await testClient.getStats();
    showResult('api-result', response);
  } catch (error) {
    showResult('api-result', { success: false, error: error.message });
  }
}

// 测试超时处理
async function testTimeout() {
  try {
    // 模拟超时请求
    const response = await fetch('/tools/api/time_capsule/stats/', {
      signal: AbortSignal.timeout(100) // 100ms超时
    });
    showResult('error-result', { success: true, response: 'Should timeout' });
  } catch (error) {
    showResult('error-result', { success: false, error: error.message, type: 'timeout' });
  }
}

// 测试无效数据
async function testInvalidData() {
  try {
    const response = await testClient.createCapsule({}); // 空数据
    showResult('error-result', response);
  } catch (error) {
    showResult('error-result', { success: false, error: error.message, type: 'invalid_data' });
  }
}

// 测试网络错误
async function testNetworkError() {
  try {
    const response = await fetch('/tools/api/nonexistent/');
    showResult('error-result', { success: true, response: 'Should 404' });
  } catch (error) {
    showResult('error-result', { success: false, error: error.message, type: 'network_error' });
  }
}

// 测试并发请求
async function testConcurrentRequests() {
  const startTime = Date.now();
  
  try {
    const promises = [
      testClient.getStats(),
      testClient.getAchievements(),
      testClient.getUserCapsules()
    ];
    
    const results = await Promise.all(promises);
    const endTime = Date.now();
    
    showResult('performance-result', {
      success: true,
      concurrent_requests: 3,
      total_time: `${endTime - startTime}ms`,
      results: results.map(r => r.success)
    });
  } catch (error) {
    showResult('performance-result', { success: false, error: error.message });
  }
}

// 测试缓存性能
async function testCachePerformance() {
  const startTime = Date.now();
  
  try {
    // 第一次请求
    await testClient.getStats();
    const firstRequestTime = Date.now() - startTime;
    
    // 第二次请求（应该使用缓存）
    const cacheStartTime = Date.now();
    await testClient.getStats();
    const secondRequestTime = Date.now() - cacheStartTime;
    
    showResult('performance-result', {
      success: true,
      first_request_time: `${firstRequestTime}ms`,
      second_request_time: `${secondRequestTime}ms`,
      cache_improvement: `${((firstRequestTime - secondRequestTime) / firstRequestTime * 100).toFixed(1)}%`
    });
  } catch (error) {
    showResult('performance-result', { success: false, error: error.message });
  }
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
  // 设置初始连接状态
  if (window.TIME_CAPSULE_CONFIG.websocket_available) {
    updateConnectionStatus('connected');
  } else {
    updateConnectionStatus('disconnected');
  }
});
</script>
{% endblock %}
