{% extends 'base.html' %}
{% load static %}

{% block tool_title_inner %}WanderAI æ™ºèƒ½æ—…æ¸¸æ”»ç•¥{% endblock %}
{% block tool_title_display %}WanderAI æ™ºèƒ½æ—…æ¸¸æ”»ç•¥{% endblock %}

{% block extra_css %}
<style>
/* æ—…æ¸¸æ”»ç•¥é¡µé¢æ ·å¼ */
.travel-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
  color: #ffffff;
  font-family: 'Inter', 'Segoe UI', 'Roboto', sans-serif;
  padding: 2rem;
  position: relative;
  overflow: hidden;
}

.travel-container::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 60%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
  z-index: -1;
  animation: travelFloat 20s ease-in-out infinite;
}

@keyframes travelFloat {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  33% { transform: translateY(-20px) rotate(1deg); }
  66% { transform: translateY(10px) rotate(-1deg); }
}

.travel-header {
  text-align: center;
  margin-bottom: 3rem;
  position: relative;
  z-index: 2;
}

.travel-title {
  font-size: 3.5rem;
  font-weight: 800;
  margin-bottom: 1rem;
  background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
}

.travel-subtitle {
  font-size: 1.2rem;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 2rem;
}

.travel-form {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 2rem;
  margin-bottom: 2rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: #ffffff;
}

.form-input {
  width: 100%;
  padding: 1rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  border-color: rgba(255, 255, 255, 0.8);
  background: rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
}

.form-input::placeholder {
  color: rgba(255, 255, 255, 0.6);
}

.form-select {
  width: 100%;
  padding: 1rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.form-select:focus {
  outline: none;
  border-color: rgba(255, 255, 255, 0.8);
  background: rgba(255, 255, 255, 0.2);
}

.form-select option {
  background: #2c3e50;
  color: #ffffff;
}

.interests-container {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.interest-tag {
  padding: 0.5rem 1rem;
  background: rgba(255, 255, 255, 0.2);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 25px;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.interest-tag:hover {
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.5);
}

.interest-tag.selected {
  background: rgba(255, 255, 255, 0.4);
  border-color: rgba(255, 255, 255, 0.8);
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
}

.generate-btn {
  width: 100%;
  padding: 1.2rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: 12px;
  color: #ffffff;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.generate-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.generate-btn:active {
  transform: translateY(0);
}

.loading {
  text-align: center;
  padding: 3rem;
  display: none;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid #ffffff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.guide-result {
  display: none;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 2rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.guide-title {
  font-size: 2.5rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 2rem;
  color: #ffffff;
}

.guide-sections {
  display: grid;
  gap: 2rem;
}

.guide-section {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 15px;
  padding: 1.5rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-title {
  font-size: 1.3rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: #ffffff;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.section-icon {
  font-size: 1.5rem;
}

.section-content {
  color: rgba(255, 255, 255, 0.9);
  line-height: 1.6;
}

/* æ™¯ç‚¹æ ·å¼ */
.attraction-item {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 1rem;
  margin-bottom: 1rem;
  border-left: 4px solid #4facfe;
}

.attraction-name {
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 0.5rem;
}

.attraction-details {
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.8);
}

.attraction-price {
  color: #4facfe;
  font-weight: 500;
}

.attraction-time {
  color: #f093fb;
  font-weight: 500;
}

.attraction-rating {
  color: #ffd700;
  font-weight: 500;
}

.attraction-tips {
  color: #f5576c;
  font-style: italic;
  margin-top: 0.5rem;
}

/* ç¾é£Ÿæ ·å¼ */
.food-item {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 1rem;
  margin-bottom: 1rem;
  border-left: 4px solid #f093fb;
}

.food-name {
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 0.5rem;
}

.food-specialty {
  color: #f093fb;
  font-weight: 500;
}

.food-price {
  color: #4facfe;
  font-weight: 500;
}

.food-rating {
  color: #ffd700;
  font-weight: 500;
}

.food-tips {
  color: #f5576c;
  font-style: italic;
  margin-top: 0.5rem;
}

/* äº¤é€šæ ·å¼ */
.transport-item {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 1rem;
  margin-bottom: 1rem;
  border-left: 4px solid #667eea;
}

.transport-title {
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 0.5rem;
}

.transport-desc {
  color: rgba(255, 255, 255, 0.8);
  font-size: 0.9rem;
}

/* å¤©æ°”æ ·å¼ */
.weather-item {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 1rem;
  margin-bottom: 1rem;
  border-left: 4px solid #764ba2;
}

.weather-season {
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 0.5rem;
}

.weather-desc {
  color: rgba(255, 255, 255, 0.8);
}

/* é¢„ç®—æ ·å¼ */
.budget-item {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 1rem;
  margin-bottom: 1rem;
  border-left: 4px solid #f5576c;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.budget-type {
  font-weight: 600;
  color: #ffffff;
}

.budget-amount {
  color: #4facfe;
  font-weight: 500;
}

/* è´´å£«æ ·å¼ */
.tip-item {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 1rem;
  margin-bottom: 1rem;
  border-left: 4px solid #4facfe;
  color: rgba(255, 255, 255, 0.9);
}

/* è¯¦ç»†æ”»ç•¥æ ·å¼ */
.detailed-guide {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 15px;
  padding: 1.5rem;
  margin-top: 2rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.detailed-guide h3 {
  color: #ffffff;
  margin-bottom: 1rem;
  font-size: 1.2rem;
}

.detailed-guide h4 {
  color: #ffffff;
  margin: 1.5rem 0 1rem 0;
  font-size: 1.1rem;
  border-left: 3px solid #4facfe;
  padding-left: 1rem;
}

.detailed-guide p {
  color: rgba(255, 255, 255, 0.9);
  line-height: 1.8;
  margin-bottom: 1rem;
}

.detailed-guide ul {
  color: rgba(255, 255, 255, 0.9);
  line-height: 1.8;
  margin-bottom: 1rem;
}

.detailed-guide li {
  margin-bottom: 0.5rem;
}

/* æ¯æ—¥è¡Œç¨‹æ ·å¼ */
.daily-schedule-section {
  margin-bottom: 2rem;
}

.day-card {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.day-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.day-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: #ffffff;
}

.day-date {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.9rem;
}

.time-slots {
  display: grid;
  gap: 1rem;
}

.time-slot {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  padding: 1rem;
  border-left: 3px solid #4facfe;
}

.time-slot-title {
  font-weight: 600;
  color: #4facfe;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.activity-item {
  margin-bottom: 0.8rem;
}

.activity-name {
  font-weight: 500;
  color: #ffffff;
  margin-bottom: 0.3rem;
}

.activity-location {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  margin-bottom: 0.3rem;
}

.activity-cost {
  color: #f093fb;
  font-weight: 500;
  font-size: 0.85rem;
  margin-bottom: 0.3rem;
}

.activity-tips {
  color: #f5576c;
  font-style: italic;
  font-size: 0.85rem;
}

.accommodation-info {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  padding: 1rem;
  margin-top: 1rem;
  border-left: 3px solid #f093fb;
}

.accommodation-title {
  font-weight: 600;
  color: #f093fb;
  margin-bottom: 0.5rem;
}

/* æ—¶é—´çº¿æ ·å¼ */
.timeline-section {
  margin-bottom: 2rem;
}

.timeline-day {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.timeline-day-header {
  font-size: 1.1rem;
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 1rem;
  text-align: center;
}

.timeline-activities {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.timeline-activity {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 0.8rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border-left: 3px solid #667eea;
}

.activity-time {
  min-width: 80px;
  font-weight: 600;
  color: #667eea;
  font-size: 0.9rem;
}

.activity-details {
  flex: 1;
}

.activity-name {
  font-weight: 500;
  color: #ffffff;
  margin-bottom: 0.3rem;
}

.activity-location {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  margin-bottom: 0.3rem;
}

.activity-cost {
  color: #f093fb;
  font-weight: 500;
  font-size: 0.85rem;
  margin-bottom: 0.3rem;
}

.activity-tips {
  color: #f5576c;
  font-style: italic;
  font-size: 0.85rem;
}

/* è´¹ç”¨æ˜ç»†æ ·å¼ */
.cost-section {
  margin-bottom: 2rem;
}

.cost-summary {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.total-cost {
  font-size: 2rem;
  font-weight: 700;
  color: #4facfe;
  margin-bottom: 0.5rem;
}

.cost-details {
  color: rgba(255, 255, 255, 0.8);
  font-size: 0.9rem;
}

.cost-breakdown {
  display: grid;
  gap: 1rem;
}

.cost-item {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-left: 3px solid #f093fb;
}

.cost-info {
  flex: 1;
}

.cost-type {
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 0.3rem;
}

.cost-description {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
}

.cost-amount {
  text-align: right;
}

.cost-value {
  font-weight: 600;
  color: #4facfe;
  font-size: 1.1rem;
}

.cost-daily {
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.8rem;
}

/* æ“ä½œæŒ‰é’® */
.guide-actions {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
  justify-content: center;
}

.action-btn {
  padding: 0.8rem 1.5rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

.action-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.5);
}

.action-btn.primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: transparent;
}

.action-btn.primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* å¯¼èˆªæŒ‰é’® */
.nav-buttons {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  justify-content: center;
}

.nav-btn {
  padding: 1rem 2rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 600;
  backdrop-filter: blur(10px);
}

.nav-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.nav-btn.active {
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.8);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .travel-container {
    padding: 1rem;
  }
  
  .travel-title {
    font-size: 2.5rem;
  }
  
  .guide-actions {
    flex-direction: column;
  }
  
  .nav-buttons {
    flex-direction: column;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="travel-container">
  <div class="travel-header">
    <h1 class="travel-title">WanderAI æ™ºèƒ½æ—…æ¸¸æ”»ç•¥</h1>
    <p class="travel-subtitle">åŸºäºçœŸå®æ•°æ®çš„ä¸ªæ€§åŒ–æ—…æ¸¸æ”»ç•¥ç”Ÿæˆå™¨</p>
  </div>

  <!-- å¯¼èˆªæŒ‰é’® -->
  <div class="nav-buttons">
    <button class="nav-btn active" onclick="showTravelForm()">æ–°å»ºæ”»ç•¥</button>
    <button class="nav-btn" onclick="showGuidesList()">æˆ‘çš„æ”»ç•¥</button>
  </div>

  <!-- æ—…æ¸¸æ”»ç•¥è¡¨å• -->
  <div id="travelForm" class="travel-form">
    <div class="form-group">
      <label class="form-label">ç›®çš„åœ°</label>
      <input type="text" id="destination" class="form-input" placeholder="è¯·è¾“å…¥ç›®çš„åœ°ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€é‡åº†..." required>
    </div>

    <div class="form-group">
      <label class="form-label">æ—…è¡Œé£æ ¼</label>
      <select id="travelStyle" class="form-select">
        <option value="general">é€šç”¨å‹</option>
        <option value="adventure">å†’é™©å‹</option>
        <option value="leisure">ä¼‘é—²å‹</option>
        <option value="cultural">æ–‡åŒ–å‹</option>
        <option value="foodie">ç¾é£Ÿå‹</option>
        <option value="shopping">è´­ç‰©å‹</option>
        <option value="photography">æ‘„å½±å‹</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">é¢„ç®—èŒƒå›´</label>
      <select id="budgetRange" class="form-select">
        <option value="budget">ç»æµå‹ (2000-3000å…ƒ)</option>
        <option value="medium" selected>èˆ’é€‚å‹ (4000-6000å…ƒ)</option>
        <option value="luxury">è±ªåå‹ (8000-12000å…ƒ)</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">æ—…è¡Œæ—¶é•¿</label>
      <select id="travelDuration" class="form-select">
        <option value="1-2å¤©">1-2å¤©</option>
        <option value="3-5å¤©" selected>3-5å¤©</option>
        <option value="1å‘¨">1å‘¨</option>
        <option value="2å‘¨">2å‘¨</option>
        <option value="1ä¸ªæœˆ">1ä¸ªæœˆ</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">å…´è¶£åå¥½ (å¯å¤šé€‰)</label>
      <div class="interests-container">
        <div class="interest-tag" data-interest="ç¾é£Ÿ">ç¾é£Ÿ</div>
        <div class="interest-tag" data-interest="æ–‡åŒ–">æ–‡åŒ–</div>
        <div class="interest-tag" data-interest="è‡ªç„¶">è‡ªç„¶</div>
        <div class="interest-tag" data-interest="è´­ç‰©">è´­ç‰©</div>
        <div class="interest-tag" data-interest="å†å²">å†å²</div>
        <div class="interest-tag" data-interest="è‰ºæœ¯">è‰ºæœ¯</div>
        <div class="interest-tag" data-interest="è¿åŠ¨">è¿åŠ¨</div>
        <div class="interest-tag" data-interest="æ‘„å½±">æ‘„å½±</div>
        <div class="interest-tag" data-interest="å¤œç”Ÿæ´»">å¤œç”Ÿæ´»</div>
        <div class="interest-tag" data-interest="æ¸©æ³‰">æ¸©æ³‰</div>
        <div class="interest-tag" data-interest="æµ·æ»©">æµ·æ»©</div>
        <div class="interest-tag" data-interest="ç™»å±±">ç™»å±±</div>
      </div>
    </div>

    <button class="generate-btn" onclick="generateTravelGuide()">
      <i class="fas fa-magic"></i> ç”Ÿæˆæ™ºèƒ½æ”»ç•¥
    </button>
  </div>

  <!-- åŠ è½½ä¸­ -->
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <p>æ­£åœ¨ç”Ÿæˆæ‚¨çš„ä¸“å±æ—…æ¸¸æ”»ç•¥...</p>
  </div>

  <!-- æ”»ç•¥ç»“æœ -->
  <div id="guideResult" class="guide-result">
    <h2 id="guideTitle" class="guide-title"></h2>
    <div id="guideSections" class="guide-sections"></div>
    
    <!-- è¯¦ç»†æ”»ç•¥ -->
    <div id="detailedGuide" class="detailed-guide" style="display: none;">
      <h3>ğŸ“‹ è¯¦ç»†æ”»ç•¥</h3>
      
      <!-- æ¯æ—¥è¡Œç¨‹ -->
      <div id="dailySchedule" class="daily-schedule-section" style="display: none;">
        <h4>ğŸ—“ï¸ æ¯æ—¥è¡Œç¨‹å®‰æ’</h4>
        <div id="dailyScheduleContent"></div>
      </div>
      
      <!-- æ´»åŠ¨æ—¶é—´çº¿ -->
      <div id="activityTimeline" class="timeline-section" style="display: none;">
        <h4>â° æ´»åŠ¨æ—¶é—´çº¿</h4>
        <div id="timelineContent"></div>
      </div>
      
      <!-- è´¹ç”¨æ˜ç»† -->
      <div id="costBreakdown" class="cost-section" style="display: none;">
        <h4>ğŸ’° è´¹ç”¨æ˜ç»†</h4>
        <div id="costContent"></div>
      </div>
      
      <!-- åŸå§‹è¯¦ç»†æ”»ç•¥ -->
      <div id="detailedContent"></div>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="guide-actions">
      <button class="action-btn" onclick="showDetailedGuide()">
        <i class="fas fa-file-alt"></i> æŸ¥çœ‹è¯¦ç»†æ”»ç•¥
      </button>
      <button class="action-btn" onclick="exportGuide()">
        <i class="fas fa-download"></i> å¯¼å‡ºTXT
      </button>
      <button class="action-btn primary" onclick="exportPDF()">
        <i class="fas fa-file-pdf"></i> å¯¼å‡ºPDF
      </button>
      <button class="action-btn" onclick="showTravelForm()">
        <i class="fas fa-plus"></i> æ–°å»ºæ”»ç•¥
      </button>
    </div>
  </div>

  <!-- æ”»ç•¥åˆ—è¡¨ -->
  <div id="guidesList" class="guide-result" style="display: none;">
    <h2 class="guide-title">æˆ‘çš„æ—…æ¸¸æ”»ç•¥</h2>
    <div id="guidesContainer"></div>
  </div>
</div>

<script>
let currentGuide = null;
let selectedInterests = [];

// å…´è¶£æ ‡ç­¾é€‰æ‹©
document.querySelectorAll('.interest-tag').forEach(tag => {
  tag.addEventListener('click', function() {
    const interest = this.dataset.interest;
    if (this.classList.contains('selected')) {
      this.classList.remove('selected');
      selectedInterests = selectedInterests.filter(i => i !== interest);
    } else {
      this.classList.add('selected');
      selectedInterests.push(interest);
    }
  });
});

// ç”Ÿæˆæ—…æ¸¸æ”»ç•¥
async function generateTravelGuide() {
  const destination = document.getElementById('destination').value.trim();
  const travelStyle = document.getElementById('travelStyle').value;
  const budgetRange = document.getElementById('budgetRange').value;
  const travelDuration = document.getElementById('travelDuration').value;

  if (!destination) {
    alert('è¯·è¾“å…¥ç›®çš„åœ°');
    return;
  }

  document.getElementById('travelForm').style.display = 'none';
  document.getElementById('guideResult').style.display = 'none';
  document.getElementById('guidesList').style.display = 'none';
  document.getElementById('loading').style.display = 'block';
  
  try {
    const response = await fetch('/tools/api/travel-guide/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        destination: destination,
        travel_style: travelStyle,
        budget_range: budgetRange,
        travel_duration: travelDuration,
        interests: selectedInterests
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      currentGuide = data.guide;
      displayTravelGuide(data.guide);
    } else {
      alert('ç”Ÿæˆæ”»ç•¥å¤±è´¥: ' + data.error);
      showTravelForm();
    }
  } catch (error) {
    console.error('ç”Ÿæˆæ”»ç•¥å¤±è´¥:', error);
    alert('ç”Ÿæˆæ”»ç•¥å¤±è´¥ï¼Œè¯·é‡è¯•');
    showTravelForm();
  }
}

// æ˜¾ç¤ºæ—…æ¸¸æ”»ç•¥
function displayTravelGuide(guide) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('guideResult').style.display = 'block';
  
  document.getElementById('guideTitle').textContent = guide.destination + ' æ—…æ¸¸æ”»ç•¥';
  
  // ä¿å­˜æ”»ç•¥IDç”¨äºPDFå¯¼å‡º
  currentGuide.id = guide.id;
  
  const sectionsContainer = document.getElementById('guideSections');
  sectionsContainer.innerHTML = '';
  
  // å¿…å»æ™¯ç‚¹
  if (guide.must_visit_attractions && guide.must_visit_attractions.length > 0) {
    const attractionsSection = createAttractionsSection(guide.must_visit_attractions);
    sectionsContainer.appendChild(attractionsSection);
  }
  
  // ç¾é£Ÿæ¨è
  if (guide.food_recommendations && guide.food_recommendations.length > 0) {
    const foodSection = createFoodSection(guide.food_recommendations);
    sectionsContainer.appendChild(foodSection);
  }
  
  // äº¤é€šæŒ‡å—
  if (guide.transportation_guide) {
    const transportSection = createTransportSection(guide.transportation_guide);
    sectionsContainer.appendChild(transportSection);
  }
  
  // å¤©æ°”ä¿¡æ¯
  if (guide.weather_info) {
    const weatherSection = createWeatherSection(guide.weather_info);
    sectionsContainer.appendChild(weatherSection);
  }
  
  // æœ€ä½³æ—…è¡Œæ—¶é—´
  if (guide.best_time_to_visit) {
    const timeSection = createSection('ğŸ“… æœ€ä½³æ—…è¡Œæ—¶é—´', 
      `<p>${guide.best_time_to_visit}</p>`
    );
    sectionsContainer.appendChild(timeSection);
  }
  
  // é¢„ç®—ä¼°ç®—
  if (guide.budget_estimate) {
    const budgetSection = createBudgetSection(guide.budget_estimate);
    sectionsContainer.appendChild(budgetSection);
  }
  
  // æ—…è¡Œè´´å£«
  if (guide.travel_tips && guide.travel_tips.length > 0) {
    const tipsSection = createTipsSection(guide.travel_tips);
    sectionsContainer.appendChild(tipsSection);
  }
  
  // ä¿å­˜è¯¦ç»†æ”»ç•¥å†…å®¹
  if (guide.detailed_guide) {
    document.getElementById('detailedContent').innerHTML = formatDetailedGuide(guide.detailed_guide);
  }
  
  // æ˜¾ç¤ºæ¯æ—¥è¡Œç¨‹
  if (guide.daily_schedule && guide.daily_schedule.length > 0) {
    displayDailySchedule(guide.daily_schedule);
  }
  
  // æ˜¾ç¤ºæ´»åŠ¨æ—¶é—´çº¿
  if (guide.activity_timeline && guide.activity_timeline.length > 0) {
    displayActivityTimeline(guide.activity_timeline);
  }
  
  // æ˜¾ç¤ºè´¹ç”¨æ˜ç»†
  if (guide.cost_breakdown) {
    displayCostBreakdown(guide.cost_breakdown);
  }
}

// åˆ›å»ºæ™¯ç‚¹åŒºå—
function createAttractionsSection(attractions) {
  const section = document.createElement('div');
  section.className = 'guide-section';
  
  let content = '<div class="section-title"><span class="section-icon">ğŸ›ï¸</span>å¿…å»æ™¯ç‚¹</div><div class="section-content">';
  
  attractions.forEach(attraction => {
    // è§£ææ™¯ç‚¹ä¿¡æ¯
    const parts = attraction.split(' - ');
    const name = parts[0];
    const description = parts[1] || '';
    
    // æå–ä»·æ ¼ã€æ—¶é—´ã€è¯„åˆ†ç­‰ä¿¡æ¯
    const priceMatch = description.match(/é—¨ç¥¨:([^,]+)/);
    const timeMatch = description.match(/å¼€æ”¾æ—¶é—´:([^,]+)/);
    const ratingMatch = description.match(/è¯„åˆ†:([^,]+)/);
    const tipsMatch = description.match(/å»ºè®®:([^,]+)/);
    
    content += `
      <div class="attraction-item">
        <div class="attraction-name">${name}</div>
        <div class="attraction-details">
          ${description}
          ${priceMatch ? `<div class="attraction-price">é—¨ç¥¨: ${priceMatch[1]}</div>` : ''}
          ${timeMatch ? `<div class="attraction-time">å¼€æ”¾æ—¶é—´: ${timeMatch[1]}</div>` : ''}
          ${ratingMatch ? `<div class="attraction-rating">è¯„åˆ†: ${ratingMatch[1]}</div>` : ''}
          ${tipsMatch ? `<div class="attraction-tips">ğŸ’¡ ${tipsMatch[1]}</div>` : ''}
        </div>
      </div>
    `;
  });
  
  content += '</div>';
  section.innerHTML = content;
  return section;
}

// åˆ›å»ºç¾é£ŸåŒºå—
function createFoodSection(restaurants) {
  const section = document.createElement('div');
  section.className = 'guide-section';
  
  let content = '<div class="section-title"><span class="section-icon">ğŸœ</span>ç¾é£Ÿæ¨è</div><div class="section-content">';
  
  restaurants.forEach(restaurant => {
    // è§£æé¤å…ä¿¡æ¯
    const parts = restaurant.split(' - ');
    const name = parts[0];
    const specialty = parts[1] || '';
    const priceRange = parts[2] || '';
    
    content += `
      <div class="food-item">
        <div class="food-name">${name}</div>
        <div class="food-details">
          ${specialty ? `<div class="food-specialty">ç‰¹è‰²: ${specialty}</div>` : ''}
          ${priceRange ? `<div class="food-price">ä»·æ ¼: ${priceRange}</div>` : ''}
        </div>
      </div>
    `;
  });
  
  content += '</div>';
  section.innerHTML = content;
  return section;
}

// åˆ›å»ºäº¤é€šåŒºå—
function createTransportSection(transportation) {
  const section = document.createElement('div');
  section.className = 'guide-section';
  
  let content = '<div class="section-title"><span class="section-icon">ğŸš—</span>äº¤é€šæŒ‡å—</div><div class="section-content">';
  
  Object.entries(transportation).forEach(([key, value]) => {
    content += `
      <div class="transport-item">
        <div class="transport-title">${key}</div>
        <div class="transport-desc">${value}</div>
      </div>
    `;
  });
  
  content += '</div>';
  section.innerHTML = content;
  return section;
}

// åˆ›å»ºå¤©æ°”åŒºå—
function createWeatherSection(weather) {
  const section = document.createElement('div');
  section.className = 'guide-section';
  
  let content = '<div class="section-title"><span class="section-icon">ğŸŒ¤ï¸</span>å¤©æ°”ä¿¡æ¯</div><div class="section-content">';
  
  if (weather.current) {
    content += `
      <div class="weather-item">
        <div class="weather-season">å½“å‰å¤©æ°”</div>
        <div class="weather-desc">
          æ¸©åº¦: ${weather.current.temperature} | 
          å¤©æ°”: ${weather.current.condition} | 
          æ¹¿åº¦: ${weather.current.humidity} | 
          é£åŠ›: ${weather.current.wind}
        </div>
      </div>
    `;
  }
  
  if (weather.forecast) {
    Object.entries(weather.forecast).forEach(([day, desc]) => {
      content += `
        <div class="weather-item">
          <div class="weather-season">${day}</div>
          <div class="weather-desc">${desc}</div>
        </div>
      `;
    });
  }
  
  if (weather.best_season) {
    content += `
      <div class="weather-item">
        <div class="weather-season">æœ€ä½³å­£èŠ‚</div>
        <div class="weather-desc">${weather.best_season}</div>
      </div>
    `;
  }
  
  content += '</div>';
  section.innerHTML = content;
  return section;
}

// åˆ›å»ºé¢„ç®—åŒºå—
function createBudgetSection(budget) {
  const section = document.createElement('div');
  section.className = 'guide-section';
  
  let content = '<div class="section-title"><span class="section-icon">ğŸ’°</span>é¢„ç®—ä¼°ç®—</div><div class="section-content">';
  
  Object.entries(budget).forEach(([type, amount]) => {
    content += `
      <div class="budget-item">
        <div class="budget-type">${type}</div>
        <div class="budget-amount">${amount}</div>
      </div>
    `;
  });
  
  content += '</div>';
  section.innerHTML = content;
  return section;
}

// åˆ›å»ºè´´å£«åŒºå—
function createTipsSection(tips) {
  const section = document.createElement('div');
  section.className = 'guide-section';
  
  let content = '<div class="section-title"><span class="section-icon">ğŸ’¡</span>æ—…è¡Œè´´å£«</div><div class="section-content">';
  
  tips.forEach(tip => {
    content += `<div class="tip-item">${tip}</div>`;
  });
  
  content += '</div>';
  section.innerHTML = content;
  return section;
}

// åˆ›å»ºé€šç”¨åŒºå—
function createSection(title, content) {
  const section = document.createElement('div');
  section.className = 'guide-section';
  section.innerHTML = `
    <div class="section-title">
      <span class="section-icon">${title.split(' ')[0]}</span>
      ${title.split(' ').slice(1).join(' ')}
    </div>
    <div class="section-content">
      ${content}
    </div>
  `;
  return section;
}

// æ ¼å¼åŒ–è¯¦ç»†æ”»ç•¥
function formatDetailedGuide(content) {
  // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ®µè½
  return content.split('\n\n').map(paragraph => {
    if (paragraph.trim()) {
      return `<p>${paragraph.trim()}</p>`;
    }
    return '';
  }).join('');
}

// æ˜¾ç¤ºæ¯æ—¥è¡Œç¨‹
function displayDailySchedule(dailySchedule) {
  const container = document.getElementById('dailyScheduleContent');
  const section = document.getElementById('dailySchedule');
  
  let html = '';
  
  dailySchedule.forEach(day => {
    html += `
      <div class="day-card">
        <div class="day-header">
          <div class="day-title">ç¬¬${day.day}å¤©</div>
          <div class="day-date">${day.date}</div>
        </div>
        
        <div class="time-slots">
          ${renderTimeSlot('ğŸŒ… ä¸Šåˆ', day.morning)}
          ${renderTimeSlot('â˜€ï¸ ä¸‹åˆ', day.afternoon)}
          ${renderTimeSlot('ğŸŒ† å‚æ™š', day.evening)}
          ${renderTimeSlot('ğŸŒ™ å¤œæ™š', day.night)}
        </div>
        
        ${day.accommodation ? `
          <div class="accommodation-info">
            <div class="accommodation-title">ğŸ¨ ä½å®¿å®‰æ’</div>
            <div>${day.accommodation}</div>
          </div>
        ` : ''}
      </div>
    `;
  });
  
  container.innerHTML = html;
  section.style.display = 'block';
}

// æ¸²æŸ“æ—¶é—´æ®µ
function renderTimeSlot(title, activities) {
  if (!activities || activities.length === 0) {
    return '';
  }
  
  let html = `
    <div class="time-slot">
      <div class="time-slot-title">${title}</div>
  `;
  
  activities.forEach(activity => {
    html += `
      <div class="activity-item">
        <div class="activity-name">${activity.activity}</div>
        ${activity.location ? `<div class="activity-location">ğŸ“ ${activity.location}</div>` : ''}
        ${activity.cost ? `<div class="activity-cost">ğŸ’° ${activity.cost}</div>` : ''}
        ${activity.tips ? `<div class="activity-tips">ğŸ’¡ ${activity.tips}</div>` : ''}
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

// æ˜¾ç¤ºæ´»åŠ¨æ—¶é—´çº¿
function displayActivityTimeline(timeline) {
  const container = document.getElementById('timelineContent');
  const section = document.getElementById('activityTimeline');
  
  let html = '';
  
  timeline.forEach(day => {
    html += `
      <div class="timeline-day">
        <div class="timeline-day-header">${day.date}</div>
        <div class="timeline-activities">
    `;
    
    day.activities.forEach(activity => {
      html += `
        <div class="timeline-activity">
          <div class="activity-time">${activity.time}</div>
          <div class="activity-details">
            <div class="activity-name">${activity.activity}</div>
            ${activity.location ? `<div class="activity-location">ğŸ“ ${activity.location}</div>` : ''}
            ${activity.cost ? `<div class="activity-cost">ğŸ’° ${activity.cost}</div>` : ''}
            ${activity.tips ? `<div class="activity-tips">ğŸ’¡ ${activity.tips}</div>` : ''}
          </div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  section.style.display = 'block';
}

// æ˜¾ç¤ºè´¹ç”¨æ˜ç»†
function displayCostBreakdown(costBreakdown) {
  const container = document.getElementById('costContent');
  const section = document.getElementById('costBreakdown');
  
  let html = `
    <div class="cost-summary">
      <div class="total-cost">Â¥${costBreakdown.total_cost}</div>
      <div class="cost-details">
        ${costBreakdown.travel_days}å¤©è¡Œç¨‹ Â· ${getBudgetRangeText(costBreakdown.budget_range)}
      </div>
    </div>
    
    <div class="cost-breakdown">
  `;
  
  // ä½å®¿è´¹ç”¨
  if (costBreakdown.accommodation) {
    html += `
      <div class="cost-item">
        <div class="cost-info">
          <div class="cost-type">ğŸ¨ ä½å®¿è´¹ç”¨</div>
          <div class="cost-description">${costBreakdown.accommodation.description}</div>
        </div>
        <div class="cost-amount">
          <div class="cost-value">Â¥${costBreakdown.accommodation.total_cost}</div>
          <div class="cost-daily">Â¥${costBreakdown.accommodation.daily_cost}/å¤©</div>
        </div>
      </div>
    `;
  }
  
  // é¤é¥®è´¹ç”¨
  if (costBreakdown.food) {
    html += `
      <div class="cost-item">
        <div class="cost-info">
          <div class="cost-type">ğŸ½ï¸ é¤é¥®è´¹ç”¨</div>
          <div class="cost-description">${costBreakdown.food.description}</div>
        </div>
        <div class="cost-amount">
          <div class="cost-value">Â¥${costBreakdown.food.total_cost}</div>
          <div class="cost-daily">Â¥${costBreakdown.food.daily_cost}/å¤©</div>
        </div>
      </div>
    `;
  }
  
  // äº¤é€šè´¹ç”¨
  if (costBreakdown.transport) {
    html += `
      <div class="cost-item">
        <div class="cost-info">
          <div class="cost-type">ğŸš— å¸‚å†…äº¤é€š</div>
          <div class="cost-description">${costBreakdown.transport.description}</div>
        </div>
        <div class="cost-amount">
          <div class="cost-value">Â¥${costBreakdown.transport.total_cost}</div>
          <div class="cost-daily">Â¥${costBreakdown.transport.daily_cost}/å¤©</div>
        </div>
      </div>
    `;
  }
  
  // æ™¯ç‚¹é—¨ç¥¨
  if (costBreakdown.attractions) {
    html += `
      <div class="cost-item">
        <div class="cost-info">
          <div class="cost-type">ğŸ« æ™¯ç‚¹é—¨ç¥¨</div>
          <div class="cost-description">${costBreakdown.attractions.description}</div>
        </div>
        <div class="cost-amount">
          <div class="cost-value">Â¥${costBreakdown.attractions.total_cost}</div>
          <div class="cost-daily">Â¥${costBreakdown.attractions.daily_cost}/å¤©</div>
        </div>
      </div>
    `;
  }
  
  // å¾€è¿”äº¤é€š
  if (costBreakdown.round_trip) {
    html += `
      <div class="cost-item">
        <div class="cost-info">
          <div class="cost-type">âœˆï¸ å¾€è¿”äº¤é€š</div>
          <div class="cost-description">${costBreakdown.round_trip.description}</div>
        </div>
        <div class="cost-amount">
          <div class="cost-value">Â¥${costBreakdown.round_trip.cost}</div>
        </div>
      </div>
    `;
  }
  
  html += '</div>';
  
  container.innerHTML = html;
  section.style.display = 'block';
}

// è·å–é¢„ç®—èŒƒå›´æ–‡æœ¬
function getBudgetRangeText(budgetRange) {
  const budgetTexts = {
    'budget': 'ç»æµå‹',
    'medium': 'èˆ’é€‚å‹',
    'luxury': 'è±ªåå‹'
  };
  return budgetTexts[budgetRange] || 'èˆ’é€‚å‹';
}

// æ˜¾ç¤ºè¯¦ç»†æ”»ç•¥
function showDetailedGuide() {
  const detailedGuide = document.getElementById('detailedGuide');
  if (detailedGuide.style.display === 'none') {
    detailedGuide.style.display = 'block';
    
    // æ»šåŠ¨åˆ°è¯¦ç»†æ”»ç•¥ä½ç½®
    detailedGuide.scrollIntoView({ 
      behavior: 'smooth', 
      block: 'start' 
    });
  } else {
    detailedGuide.style.display = 'none';
  }
}

// å¯¼å‡ºæ”»ç•¥ä¸ºTXT
function exportGuide() {
  if (!currentGuide) return;
  
  // åˆ›å»ºå¯¼å‡ºå†…å®¹
  let exportContent = `${currentGuide.destination} æ—…æ¸¸æ”»ç•¥\n\n`;
  
  // æ·»åŠ å„ä¸ªéƒ¨åˆ†
  if (currentGuide.must_visit_attractions) {
    exportContent += 'ğŸ›ï¸ å¿…å»æ™¯ç‚¹:\n';
    currentGuide.must_visit_attractions.forEach(attraction => {
      exportContent += `â€¢ ${attraction}\n`;
    });
    exportContent += '\n';
  }
  
  if (currentGuide.food_recommendations) {
    exportContent += 'ğŸœ ç¾é£Ÿæ¨è:\n';
    currentGuide.food_recommendations.forEach(food => {
      exportContent += `â€¢ ${food}\n`;
    });
    exportContent += '\n';
  }
  
  if (currentGuide.transportation_guide) {
    exportContent += 'ğŸš— äº¤é€šæŒ‡å—:\n';
    Object.entries(currentGuide.transportation_guide).forEach(([key, value]) => {
      exportContent += `â€¢ ${key}: ${value}\n`;
    });
    exportContent += '\n';
  }
  
  // æ·»åŠ è¯¦ç»†æ”»ç•¥
  if (currentGuide.daily_schedule && currentGuide.daily_schedule.length > 0) {
    exportContent += 'ğŸ—“ï¸ æ¯æ—¥è¡Œç¨‹å®‰æ’:\n\n';
    currentGuide.daily_schedule.forEach(day => {
      exportContent += `ç¬¬${day.day}å¤© (${day.date}):\n`;
      
      if (day.morning && day.morning.length > 0) {
        exportContent += '  ä¸Šåˆ:\n';
        day.morning.forEach(activity => {
          exportContent += `    ${activity.time} - ${activity.activity}\n`;
          if (activity.location) exportContent += `      åœ°ç‚¹: ${activity.location}\n`;
          if (activity.cost) exportContent += `      è´¹ç”¨: ${activity.cost}\n`;
          if (activity.tips) exportContent += `      æç¤º: ${activity.tips}\n`;
        });
      }
      
      if (day.afternoon && day.afternoon.length > 0) {
        exportContent += '  ä¸‹åˆ:\n';
        day.afternoon.forEach(activity => {
          exportContent += `    ${activity.time} - ${activity.activity}\n`;
          if (activity.location) exportContent += `      åœ°ç‚¹: ${activity.location}\n`;
          if (activity.cost) exportContent += `      è´¹ç”¨: ${activity.cost}\n`;
          if (activity.tips) exportContent += `      æç¤º: ${activity.tips}\n`;
        });
      }
      
      if (day.evening && day.evening.length > 0) {
        exportContent += '  å‚æ™š:\n';
        day.evening.forEach(activity => {
          exportContent += `    ${activity.time} - ${activity.activity}\n`;
          if (activity.location) exportContent += `      åœ°ç‚¹: ${activity.location}\n`;
          if (activity.cost) exportContent += `      è´¹ç”¨: ${activity.cost}\n`;
          if (activity.tips) exportContent += `      æç¤º: ${activity.tips}\n`;
        });
      }
      
      if (day.accommodation) {
        exportContent += `  ä½å®¿: ${day.accommodation}\n`;
      }
      
      exportContent += '\n';
    });
  }
  
  // æ·»åŠ è´¹ç”¨æ˜ç»†
  if (currentGuide.cost_breakdown) {
    exportContent += 'ğŸ’° è´¹ç”¨æ˜ç»†:\n';
    exportContent += `æ€»è´¹ç”¨: Â¥${currentGuide.cost_breakdown.total_cost}\n`;
    exportContent += `è¡Œç¨‹å¤©æ•°: ${currentGuide.cost_breakdown.travel_days}å¤©\n`;
    exportContent += `é¢„ç®—ç±»å‹: ${getBudgetRangeText(currentGuide.cost_breakdown.budget_range)}\n\n`;
    
    if (currentGuide.cost_breakdown.accommodation) {
      exportContent += `ä½å®¿è´¹ç”¨: Â¥${currentGuide.cost_breakdown.accommodation.total_cost} (Â¥${currentGuide.cost_breakdown.accommodation.daily_cost}/å¤©)\n`;
    }
    if (currentGuide.cost_breakdown.food) {
      exportContent += `é¤é¥®è´¹ç”¨: Â¥${currentGuide.cost_breakdown.food.total_cost} (Â¥${currentGuide.cost_breakdown.food.daily_cost}/å¤©)\n`;
    }
    if (currentGuide.cost_breakdown.transport) {
      exportContent += `å¸‚å†…äº¤é€š: Â¥${currentGuide.cost_breakdown.transport.total_cost} (Â¥${currentGuide.cost_breakdown.transport.daily_cost}/å¤©)\n`;
    }
    if (currentGuide.cost_breakdown.attractions) {
      exportContent += `æ™¯ç‚¹é—¨ç¥¨: Â¥${currentGuide.cost_breakdown.attractions.total_cost} (Â¥${currentGuide.cost_breakdown.attractions.daily_cost}/å¤©)\n`;
    }
    if (currentGuide.cost_breakdown.round_trip) {
      exportContent += `å¾€è¿”äº¤é€š: Â¥${currentGuide.cost_breakdown.round_trip.cost}\n`;
    }
    exportContent += '\n';
  }
  
  if (currentGuide.travel_tips) {
    exportContent += 'ğŸ’¡ æ—…è¡Œè´´å£«:\n';
    currentGuide.travel_tips.forEach(tip => {
      exportContent += `â€¢ ${tip}\n`;
    });
    exportContent += '\n';
  }
  
  // åˆ›å»ºä¸‹è½½é“¾æ¥
  const blob = new Blob([exportContent], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentGuide.destination}æ—…æ¸¸æ”»ç•¥.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// å¯¼å‡ºæ”»ç•¥ä¸ºPDF
async function exportPDF() {
  if (!currentGuide) return;
  
  try {
    // æ˜¾ç¤ºåŠ è½½æç¤º
    const exportBtn = document.querySelector('.action-btn.primary');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”ŸæˆPDFä¸­...';
    exportBtn.disabled = true;
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ”»ç•¥ID
    if (!currentGuide || !currentGuide.id) {
      alert('è¯·å…ˆç”Ÿæˆæ—…æ¸¸æ”»ç•¥');
      return;
    }
    
    // è°ƒç”¨PDFå¯¼å‡ºAPI
    const response = await fetch(`/tools/api/travel-guide/${currentGuide.id}/export/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    if (response.ok) {
      const contentType = response.headers.get('content-type');
      
      if (contentType && contentType.includes('application/pdf')) {
        // å¤„ç†PDFå“åº”
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentGuide.destination}_æ—…æ¸¸æ”»ç•¥.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        alert('PDFå¯¼å‡ºæˆåŠŸï¼');
      } else {
        // å¤„ç†JSONå“åº”ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
        const data = await response.json();
        if (data.success) {
          // åˆ›å»ºæ–‡æœ¬æ–‡ä»¶ä¸‹è½½
          const blob = new Blob([data.formatted_content], { type: 'text/plain;charset=utf-8' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${currentGuide.destination}_æ—…æ¸¸æ”»ç•¥.txt`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          alert('æ–‡æœ¬æ ¼å¼å¯¼å‡ºæˆåŠŸï¼');
        } else {
          alert('å¯¼å‡ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      }
    } else {
      const errorData = await response.json();
      alert('å¯¼å‡ºå¤±è´¥: ' + (errorData.error || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (error) {
    console.error('PDFå¯¼å‡ºå¤±è´¥:', error);
    alert('PDFå¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    const exportBtn = document.querySelector('.action-btn.primary');
    exportBtn.innerHTML = '<i class="fas fa-file-pdf"></i> å¯¼å‡ºPDF';
    exportBtn.disabled = false;
  }
}

// æ˜¾ç¤ºæ”»ç•¥è¡¨å•
function showTravelForm() {
  document.getElementById('travelForm').style.display = 'block';
  document.getElementById('guideResult').style.display = 'none';
  document.getElementById('guidesList').style.display = 'none';
  document.getElementById('loading').style.display = 'none';
  
  // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector('.nav-btn').classList.add('active');
}

// æ˜¾ç¤ºæ”»ç•¥åˆ—è¡¨
function showGuidesList() {
  document.getElementById('travelForm').style.display = 'none';
  document.getElementById('guideResult').style.display = 'none';
  document.getElementById('guidesList').style.display = 'block';
  document.getElementById('loading').style.display = 'none';
  
  // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.nav-btn')[1].classList.add('active');
  
  loadTravelGuides();
}

// åŠ è½½æ—…æ¸¸æ”»ç•¥åˆ—è¡¨
async function loadTravelGuides() {
  try {
    const response = await fetch('/tools/api/travel-guide/list/');
    const data = await response.json();
    
    if (data.success) {
      displayGuidesList(data.guides);
    } else {
      console.error('åŠ è½½æ”»ç•¥åˆ—è¡¨å¤±è´¥:', data.error);
    }
  } catch (error) {
    console.error('åŠ è½½æ”»ç•¥åˆ—è¡¨å¤±è´¥:', error);
  }
}

// æ˜¾ç¤ºæ”»ç•¥åˆ—è¡¨
function displayGuidesList(guides) {
  const container = document.getElementById('guidesContainer');
  
  if (guides.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">âœˆï¸</div>
        <div class="empty-text">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•æ—…æ¸¸æ”»ç•¥</div>
        <div class="empty-subtext">ç‚¹å‡»ä¸Šæ–¹"æ–°å»ºæ”»ç•¥"å¼€å§‹æ‚¨çš„æ—…è¡Œè§„åˆ’</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = guides.map(guide => `
    <div class="guide-card" onclick="loadGuideDetail(${guide.id})">
      <div class="guide-card-header">
        <div class="guide-destination">${guide.destination}</div>
        <div class="guide-favorite" onclick="event.stopPropagation(); toggleFavoriteGuide(${guide.id})">
          <i class="fas fa-heart ${guide.is_favorite ? 'text-danger' : ''}"></i>
        </div>
      </div>
      <div class="guide-stats">
        <div class="guide-stat">
          <i class="fas fa-map-marker-alt"></i>
          ${guide.attractions_count} ä¸ªæ™¯ç‚¹
        </div>
        <div class="guide-stat">
          <i class="fas fa-utensils"></i>
          ${guide.food_count} ä¸ªé¤å…
        </div>
        <div class="guide-stat">
          <i class="fas fa-calendar"></i>
          ${guide.created_at}
        </div>
      </div>
    </div>
  `).join('');
}

// åŠ è½½æ”»ç•¥è¯¦æƒ…
async function loadGuideDetail(guideId) {
  try {
    const response = await fetch(`/tools/api/travel-guide/${guideId}/`);
    const data = await response.json();
    
    if (data.success) {
      currentGuide = data.guide;
      displayTravelGuide(data.guide);
      showTravelForm(); // åˆ‡æ¢åˆ°æ”»ç•¥æ˜¾ç¤ºé¡µé¢
    } else {
      console.error('åŠ è½½æ”»ç•¥è¯¦æƒ…å¤±è´¥:', data.error);
    }
  } catch (error) {
    console.error('åŠ è½½æ”»ç•¥è¯¦æƒ…å¤±è´¥:', error);
  }
}

// åˆ‡æ¢æ”¶è—çŠ¶æ€
async function toggleFavoriteGuide(guideId) {
  try {
    const response = await fetch(`/tools/api/travel-guide/${guideId}/toggle-favorite/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      // é‡æ–°åŠ è½½æ”»ç•¥åˆ—è¡¨
      loadTravelGuides();
    } else {
      console.error('åˆ‡æ¢æ”¶è—çŠ¶æ€å¤±è´¥:', data.error);
    }
  } catch (error) {
    console.error('åˆ‡æ¢æ”¶è—çŠ¶æ€å¤±è´¥:', error);
  }
}

// è·å–CSRF Token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %} 