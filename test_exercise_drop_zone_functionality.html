<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>训练计划模板默认填充测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .mode-selector {
            margin-bottom: 20px;
            text-align: center;
        }
        .mode-option {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 20px;
            background: #e9ecef;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-option:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .mode-option.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        .test-results {
            margin-top: 30px;
        }
        .module-section {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .module-header {
            background: #f8f9fa;
            padding: 15px;
            font-weight: bold;
            color: #495057;
        }
        .exercise-drop-zone {
            min-height: 100px;
            padding: 20px;
            border: 2px dashed #ddd;
            text-align: center;
            color: #6c757d;
            background: #f8f9fa;
        }
        .exercise-drop-zone.filled {
            border-color: #28a745;
            background: #d4edda;
        }
        .exercise-card {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .exercise-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .exercise-params {
            font-size: 14px;
            color: #666;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-error { background: #dc3545; }
        .test-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>训练计划模板 Exercise-Drop-Zone 默认填充测试</h1>
            <p>测试当选择训练模板时，预设动作是否正确填充到各个exercise-drop-zone区域</p>
        </div>

        <div class="mode-selector">
            <div class="mode-option" data-mode="五分化">五分化训练</div>
            <div class="mode-option" data-mode="三分化">三分化训练</div>
            <div class="mode-option" data-mode="推拉腿">推拉腿训练</div>
        </div>

        <div class="test-results">
            <h3>模板加载结果测试</h3>
            
            <!-- 热身模块 -->
            <div class="module-section" data-module="warmup">
                <div class="module-header">
                    <span class="status-indicator status-warning"></span>
                    热身模块
                </div>
                <div class="exercise-drop-zone" data-module="warmup">
                    <i class="fas fa-plus"></i>
                    <p>拖拽热身动作至此</p>
                </div>
            </div>

            <!-- 主训模块 -->
            <div class="module-section" data-module="main">
                <div class="module-header">
                    <span class="status-indicator status-warning"></span>
                    主训模块
                </div>
                <div class="exercise-drop-zone" data-module="main">
                    <i class="fas fa-plus"></i>
                    <p>拖拽主训动作至此</p>
                </div>
            </div>

            <!-- 辅助模块 -->
            <div class="module-section" data-module="accessory">
                <div class="module-header">
                    <span class="status-indicator status-warning"></span>
                    辅助模块
                </div>
                <div class="exercise-drop-zone" data-module="accessory">
                    <i class="fas fa-plus"></i>
                    <p>拖拽辅助动作至此</p>
                </div>
            </div>

            <!-- 拉伸模块 -->
            <div class="module-section" data-module="cooldown">
                <div class="module-header">
                    <span class="status-indicator status-warning"></span>
                    拉伸模块
                </div>
                <div class="exercise-drop-zone" data-module="cooldown">
                    <i class="fas fa-plus"></i>
                    <p>拖拽拉伸动作至此</p>
                </div>
            </div>

            <div class="test-log" id="testLog">
                <strong>测试日志：</strong><br>
                等待模板选择...
            </div>
        </div>
    </div>

    <script>
        class DropZoneTest {
            constructor() {
                this.currentMode = null;
                this.testLog = document.getElementById('testLog');
                this.setupEventListeners();
                this.log('测试初始化完成');
            }

            setupEventListeners() {
                document.querySelectorAll('.mode-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const mode = e.target.dataset.mode;
                        this.selectMode(mode);
                    });
                });
            }

            async selectMode(mode) {
                this.log(`选择模式: ${mode}`);
                
                // 更新UI状态
                document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('active'));
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
                
                this.currentMode = mode;
                
                // 重置所有drop zone
                this.resetAllDropZones();
                
                // 加载模板数据
                await this.loadTemplateData(mode);
            }

            async loadTemplateData(mode) {
                try {
                    this.log(`正在加载${mode}模板数据...`);
                    
                    const response = await fetch('/tools/api/training_plans/templates/', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    this.log(`API响应: ${JSON.stringify(data, null, 2)}`);
                    
                    if (data.success && data.templates) {
                        this.processTemplateData(mode, data.templates);
                    } else {
                        this.log('API返回数据格式错误', 'error');
                    }

                } catch (error) {
                    this.log(`加载模板失败: ${error.message}`, 'error');
                }
            }

            processTemplateData(mode, templates) {
                const templateMap = {
                    '五分化': 'template_5day_split',
                    '三分化': 'template_3day_split',
                    '推拉腿': 'template_push_pull_legs'
                };

                const templateKey = templateMap[mode];
                if (!templateKey || !templates[templateKey]) {
                    this.log(`未找到${mode}对应的模板数据`, 'error');
                    return;
                }

                const template = templates[templateKey];
                this.log(`找到模板: ${template.name}`);
                
                // 获取第一天的数据进行测试
                const firstDay = template.schedule && template.schedule[0];
                if (!firstDay) {
                    this.log('模板中没有找到训练日数据', 'error');
                    return;
                }

                this.log(`测试第一天数据: ${firstDay.weekday} - ${firstDay.body_parts.join(', ')}`);
                
                // 填充各个模块
                this.fillDropZones(firstDay.modules);
            }

            fillDropZones(modules) {
                const moduleNames = {
                    warmup: '热身',
                    main: '主训', 
                    accessory: '辅助',
                    cooldown: '拉伸'
                };

                Object.keys(moduleNames).forEach(moduleKey => {
                    const exercises = modules[moduleKey] || [];
                    const dropZone = document.querySelector(`[data-module="${moduleKey}"] .exercise-drop-zone`);
                    const statusIndicator = document.querySelector(`[data-module="${moduleKey}"] .status-indicator`);
                    
                    if (exercises.length > 0) {
                        this.renderExercises(dropZone, exercises);
                        statusIndicator.className = 'status-indicator status-success';
                        dropZone.classList.add('filled');
                        this.log(`${moduleNames[moduleKey]}模块填充成功: ${exercises.length}个动作`);
                    } else {
                        this.renderEmptyDropZone(dropZone, moduleNames[moduleKey]);
                        statusIndicator.className = 'status-indicator status-warning';
                        dropZone.classList.remove('filled');
                        this.log(`${moduleNames[moduleKey]}模块为空`);
                    }
                });
            }

            renderExercises(dropZone, exercises) {
                dropZone.innerHTML = exercises.map(exercise => `
                    <div class="exercise-card">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="exercise-params">
                            ${exercise.sets ? `${exercise.sets}组` : ''} 
                            ${exercise.reps ? `x ${exercise.reps}次` : ''} 
                            ${exercise.weight ? `@ ${exercise.weight}` : ''}
                            ${exercise.rest ? `休息${exercise.rest}` : ''}
                        </div>
                    </div>
                `).join('');
            }

            renderEmptyDropZone(dropZone, moduleName) {
                dropZone.innerHTML = `
                    <i class="fas fa-plus"></i>
                    <p>拖拽${moduleName}动作至此</p>
                `;
            }

            resetAllDropZones() {
                document.querySelectorAll('.exercise-drop-zone').forEach(zone => {
                    zone.classList.remove('filled');
                    const module = zone.dataset.module;
                    const moduleNames = {
                        warmup: '热身',
                        main: '主训',
                        accessory: '辅助', 
                        cooldown: '拉伸'
                    };
                    this.renderEmptyDropZone(zone, moduleNames[module]);
                });

                document.querySelectorAll('.status-indicator').forEach(indicator => {
                    indicator.className = 'status-indicator status-warning';
                });
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = type === 'error' ? 'color: red;' : type === 'success' ? 'color: green;' : '';
                this.testLog.innerHTML += `<br><span style="${colorClass}">[${timestamp}] ${message}</span>`;
                this.testLog.scrollTop = this.testLog.scrollHeight;
                console.log(`[DropZoneTest] ${message}`);
            }
        }

        // 初始化测试
        document.addEventListener('DOMContentLoaded', () => {
            new DropZoneTest();
        });
    </script>
</body>
</html>
